<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ElasticSearch指南 | wen chao</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3129839_xft6cqs5gc.css">
    <meta name="description" content="架构进阶之路...">
    <meta name="keywords" content="全栈博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,js,ES6,TypeScript,vue">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.237ce36e.css" as="style"><link rel="preload" href="/assets/js/app.b2807c2b.js" as="script"><link rel="preload" href="/assets/js/2.eeaab5de.js" as="script"><link rel="preload" href="/assets/js/76.3a946a81.js" as="script"><link rel="prefetch" href="/assets/js/10.30d760c8.js"><link rel="prefetch" href="/assets/js/100.d2a91f05.js"><link rel="prefetch" href="/assets/js/101.aa15113f.js"><link rel="prefetch" href="/assets/js/102.303aae62.js"><link rel="prefetch" href="/assets/js/103.39dbd83e.js"><link rel="prefetch" href="/assets/js/104.30434bc2.js"><link rel="prefetch" href="/assets/js/105.68d90558.js"><link rel="prefetch" href="/assets/js/106.2a47de1c.js"><link rel="prefetch" href="/assets/js/107.6c92802c.js"><link rel="prefetch" href="/assets/js/108.1a019470.js"><link rel="prefetch" href="/assets/js/109.f2cc4655.js"><link rel="prefetch" href="/assets/js/11.8c97a85c.js"><link rel="prefetch" href="/assets/js/110.8630d06d.js"><link rel="prefetch" href="/assets/js/111.fdf10f1a.js"><link rel="prefetch" href="/assets/js/112.ea841a58.js"><link rel="prefetch" href="/assets/js/113.bd8e761d.js"><link rel="prefetch" href="/assets/js/114.63ed667a.js"><link rel="prefetch" href="/assets/js/115.909a8353.js"><link rel="prefetch" href="/assets/js/116.62dab6c0.js"><link rel="prefetch" href="/assets/js/117.d0ef1d76.js"><link rel="prefetch" href="/assets/js/118.39e6e925.js"><link rel="prefetch" href="/assets/js/119.e0265f93.js"><link rel="prefetch" href="/assets/js/12.156b3963.js"><link rel="prefetch" href="/assets/js/120.4be98e6e.js"><link rel="prefetch" href="/assets/js/121.518d8dd5.js"><link rel="prefetch" href="/assets/js/122.477dd94b.js"><link rel="prefetch" href="/assets/js/123.d6065aca.js"><link rel="prefetch" href="/assets/js/124.c6f965c7.js"><link rel="prefetch" href="/assets/js/125.3ee79c35.js"><link rel="prefetch" href="/assets/js/126.bcc69ad9.js"><link rel="prefetch" href="/assets/js/127.8f3ce1ac.js"><link rel="prefetch" href="/assets/js/128.03c90841.js"><link rel="prefetch" href="/assets/js/129.ab248cd9.js"><link rel="prefetch" href="/assets/js/13.c67aac42.js"><link rel="prefetch" href="/assets/js/130.dd64983e.js"><link rel="prefetch" href="/assets/js/131.6ffe6940.js"><link rel="prefetch" href="/assets/js/132.2a8fed26.js"><link rel="prefetch" href="/assets/js/133.6a7673eb.js"><link rel="prefetch" href="/assets/js/134.c00b7bf2.js"><link rel="prefetch" href="/assets/js/135.59d75ce6.js"><link rel="prefetch" href="/assets/js/136.bcd27d57.js"><link rel="prefetch" href="/assets/js/137.75dd3384.js"><link rel="prefetch" href="/assets/js/138.a2ababbf.js"><link rel="prefetch" href="/assets/js/139.6aa75eaa.js"><link rel="prefetch" href="/assets/js/14.8ab9a27a.js"><link rel="prefetch" href="/assets/js/140.58295019.js"><link rel="prefetch" href="/assets/js/141.8d05c3a5.js"><link rel="prefetch" href="/assets/js/142.18498abf.js"><link rel="prefetch" href="/assets/js/143.20c6bdde.js"><link rel="prefetch" href="/assets/js/144.ac94f8ff.js"><link rel="prefetch" href="/assets/js/145.e135dd8a.js"><link rel="prefetch" href="/assets/js/146.13a537e3.js"><link rel="prefetch" href="/assets/js/147.016b19e9.js"><link rel="prefetch" href="/assets/js/148.d3a909f2.js"><link rel="prefetch" href="/assets/js/149.90d05716.js"><link rel="prefetch" href="/assets/js/15.2b8ce9c5.js"><link rel="prefetch" href="/assets/js/150.e61c5f29.js"><link rel="prefetch" href="/assets/js/151.c81aa646.js"><link rel="prefetch" href="/assets/js/152.82944cc0.js"><link rel="prefetch" href="/assets/js/153.410a3789.js"><link rel="prefetch" href="/assets/js/154.cc1235ef.js"><link rel="prefetch" href="/assets/js/155.1e7fae81.js"><link rel="prefetch" href="/assets/js/156.cfaa0244.js"><link rel="prefetch" href="/assets/js/157.47981f53.js"><link rel="prefetch" href="/assets/js/158.e9c295a1.js"><link rel="prefetch" href="/assets/js/159.50ba3574.js"><link rel="prefetch" href="/assets/js/16.a8b0b084.js"><link rel="prefetch" href="/assets/js/160.5845ca9d.js"><link rel="prefetch" href="/assets/js/161.0e97694f.js"><link rel="prefetch" href="/assets/js/162.3c77226a.js"><link rel="prefetch" href="/assets/js/163.17c9ec79.js"><link rel="prefetch" href="/assets/js/164.7736f87d.js"><link rel="prefetch" href="/assets/js/165.ff7b4f9e.js"><link rel="prefetch" href="/assets/js/166.6956307c.js"><link rel="prefetch" href="/assets/js/167.366611f7.js"><link rel="prefetch" href="/assets/js/168.57345d6b.js"><link rel="prefetch" href="/assets/js/169.25420ee7.js"><link rel="prefetch" href="/assets/js/17.68e41786.js"><link rel="prefetch" href="/assets/js/170.bedd4eac.js"><link rel="prefetch" href="/assets/js/171.374570cf.js"><link rel="prefetch" href="/assets/js/172.2f8bf4a8.js"><link rel="prefetch" href="/assets/js/173.42ea0d36.js"><link rel="prefetch" href="/assets/js/174.0ccfd7c6.js"><link rel="prefetch" href="/assets/js/175.7ab333d2.js"><link rel="prefetch" href="/assets/js/176.c7266816.js"><link rel="prefetch" href="/assets/js/177.d0a95fb6.js"><link rel="prefetch" href="/assets/js/178.2bb652ad.js"><link rel="prefetch" href="/assets/js/179.a8eab386.js"><link rel="prefetch" href="/assets/js/18.8e0d47a1.js"><link rel="prefetch" href="/assets/js/180.9fd22be7.js"><link rel="prefetch" href="/assets/js/181.5d5358d4.js"><link rel="prefetch" href="/assets/js/182.af7d36e2.js"><link rel="prefetch" href="/assets/js/183.dddc555d.js"><link rel="prefetch" href="/assets/js/184.a3396baf.js"><link rel="prefetch" href="/assets/js/185.2f7da675.js"><link rel="prefetch" href="/assets/js/186.92639766.js"><link rel="prefetch" href="/assets/js/187.711debd8.js"><link rel="prefetch" href="/assets/js/188.149256e6.js"><link rel="prefetch" href="/assets/js/189.c118aa93.js"><link rel="prefetch" href="/assets/js/19.770d847c.js"><link rel="prefetch" href="/assets/js/190.4d85ee4e.js"><link rel="prefetch" href="/assets/js/191.ff095a9a.js"><link rel="prefetch" href="/assets/js/192.4b5fe55c.js"><link rel="prefetch" href="/assets/js/193.415828fe.js"><link rel="prefetch" href="/assets/js/194.ce801921.js"><link rel="prefetch" href="/assets/js/195.c668b288.js"><link rel="prefetch" href="/assets/js/196.8825af00.js"><link rel="prefetch" href="/assets/js/197.d09dcd8b.js"><link rel="prefetch" href="/assets/js/198.396382cf.js"><link rel="prefetch" href="/assets/js/199.facc6630.js"><link rel="prefetch" href="/assets/js/20.97979961.js"><link rel="prefetch" href="/assets/js/200.db1ff45e.js"><link rel="prefetch" href="/assets/js/201.ab79fbd5.js"><link rel="prefetch" href="/assets/js/202.46e8525c.js"><link rel="prefetch" href="/assets/js/203.2cc13ae9.js"><link rel="prefetch" href="/assets/js/204.3c8a5bcd.js"><link rel="prefetch" href="/assets/js/205.3d0d8394.js"><link rel="prefetch" href="/assets/js/206.261623f6.js"><link rel="prefetch" href="/assets/js/207.6260c0aa.js"><link rel="prefetch" href="/assets/js/208.0fd63045.js"><link rel="prefetch" href="/assets/js/209.e5eaeeca.js"><link rel="prefetch" href="/assets/js/21.e6565c56.js"><link rel="prefetch" href="/assets/js/210.bccc650e.js"><link rel="prefetch" href="/assets/js/211.c238d796.js"><link rel="prefetch" href="/assets/js/212.dd4703ab.js"><link rel="prefetch" href="/assets/js/213.110becf0.js"><link rel="prefetch" href="/assets/js/214.a90d9da2.js"><link rel="prefetch" href="/assets/js/215.81872845.js"><link rel="prefetch" href="/assets/js/216.2ae9609f.js"><link rel="prefetch" href="/assets/js/217.567657f9.js"><link rel="prefetch" href="/assets/js/218.bc570e81.js"><link rel="prefetch" href="/assets/js/219.32a64945.js"><link rel="prefetch" href="/assets/js/22.92562bc3.js"><link rel="prefetch" href="/assets/js/220.d1605ea9.js"><link rel="prefetch" href="/assets/js/221.c1483dee.js"><link rel="prefetch" href="/assets/js/222.188d3bb6.js"><link rel="prefetch" href="/assets/js/223.b4d7fc4a.js"><link rel="prefetch" href="/assets/js/224.5495522d.js"><link rel="prefetch" href="/assets/js/225.ea320f20.js"><link rel="prefetch" href="/assets/js/226.1f245007.js"><link rel="prefetch" href="/assets/js/227.280e3176.js"><link rel="prefetch" href="/assets/js/228.7ea12e2e.js"><link rel="prefetch" href="/assets/js/229.0697746f.js"><link rel="prefetch" href="/assets/js/23.4b595789.js"><link rel="prefetch" href="/assets/js/230.8efdd773.js"><link rel="prefetch" href="/assets/js/231.44bfbfb5.js"><link rel="prefetch" href="/assets/js/232.24dc2667.js"><link rel="prefetch" href="/assets/js/233.6c77b12b.js"><link rel="prefetch" href="/assets/js/234.1ea57e5c.js"><link rel="prefetch" href="/assets/js/235.efb990b9.js"><link rel="prefetch" href="/assets/js/236.2e8820ed.js"><link rel="prefetch" href="/assets/js/237.b108feed.js"><link rel="prefetch" href="/assets/js/238.22baaff8.js"><link rel="prefetch" href="/assets/js/239.ac2c0eba.js"><link rel="prefetch" href="/assets/js/24.b1f29ab1.js"><link rel="prefetch" href="/assets/js/240.1f419e38.js"><link rel="prefetch" href="/assets/js/241.e23fbc50.js"><link rel="prefetch" href="/assets/js/242.83b3226c.js"><link rel="prefetch" href="/assets/js/243.1ce8a9be.js"><link rel="prefetch" href="/assets/js/244.d7c93bdb.js"><link rel="prefetch" href="/assets/js/245.a1b402c0.js"><link rel="prefetch" href="/assets/js/246.7eeb5e18.js"><link rel="prefetch" href="/assets/js/247.b2c0ab4a.js"><link rel="prefetch" href="/assets/js/248.5b2dd7ed.js"><link rel="prefetch" href="/assets/js/249.6278d6f1.js"><link rel="prefetch" href="/assets/js/25.748022ff.js"><link rel="prefetch" href="/assets/js/250.e3114578.js"><link rel="prefetch" href="/assets/js/251.1f576677.js"><link rel="prefetch" href="/assets/js/252.7e83dd55.js"><link rel="prefetch" href="/assets/js/253.ab219365.js"><link rel="prefetch" href="/assets/js/254.31655221.js"><link rel="prefetch" href="/assets/js/255.402ba0fd.js"><link rel="prefetch" href="/assets/js/256.2f1f131a.js"><link rel="prefetch" href="/assets/js/257.cd0dac87.js"><link rel="prefetch" href="/assets/js/258.5e84f5d0.js"><link rel="prefetch" href="/assets/js/259.72cf210e.js"><link rel="prefetch" href="/assets/js/26.d566b8b1.js"><link rel="prefetch" href="/assets/js/260.ddfd8bc7.js"><link rel="prefetch" href="/assets/js/261.b074e8b6.js"><link rel="prefetch" href="/assets/js/262.e0b94776.js"><link rel="prefetch" href="/assets/js/263.2e66950f.js"><link rel="prefetch" href="/assets/js/264.f3ac339f.js"><link rel="prefetch" href="/assets/js/265.384c189b.js"><link rel="prefetch" href="/assets/js/266.635a72af.js"><link rel="prefetch" href="/assets/js/267.c9ede946.js"><link rel="prefetch" href="/assets/js/268.9ec888f5.js"><link rel="prefetch" href="/assets/js/269.2a81258c.js"><link rel="prefetch" href="/assets/js/27.3085f660.js"><link rel="prefetch" href="/assets/js/270.973f0998.js"><link rel="prefetch" href="/assets/js/271.de24bbf3.js"><link rel="prefetch" href="/assets/js/272.68e83c3c.js"><link rel="prefetch" href="/assets/js/273.d740150b.js"><link rel="prefetch" href="/assets/js/274.dc1b1f0c.js"><link rel="prefetch" href="/assets/js/275.cf028a33.js"><link rel="prefetch" href="/assets/js/276.351dbc96.js"><link rel="prefetch" href="/assets/js/277.6a9f5699.js"><link rel="prefetch" href="/assets/js/278.0c28ac6f.js"><link rel="prefetch" href="/assets/js/279.b14576ac.js"><link rel="prefetch" href="/assets/js/28.47957820.js"><link rel="prefetch" href="/assets/js/280.906a73b1.js"><link rel="prefetch" href="/assets/js/281.4173499d.js"><link rel="prefetch" href="/assets/js/282.43873aa6.js"><link rel="prefetch" href="/assets/js/283.2a3d0552.js"><link rel="prefetch" href="/assets/js/284.2c7aa3fb.js"><link rel="prefetch" href="/assets/js/285.a62f9799.js"><link rel="prefetch" href="/assets/js/286.2f0b6532.js"><link rel="prefetch" href="/assets/js/287.d770d01f.js"><link rel="prefetch" href="/assets/js/288.97207297.js"><link rel="prefetch" href="/assets/js/289.ddf5a46c.js"><link rel="prefetch" href="/assets/js/29.716c8a52.js"><link rel="prefetch" href="/assets/js/290.9f1b4436.js"><link rel="prefetch" href="/assets/js/291.885ac485.js"><link rel="prefetch" href="/assets/js/292.b1fe886b.js"><link rel="prefetch" href="/assets/js/293.f597359f.js"><link rel="prefetch" href="/assets/js/294.f559040e.js"><link rel="prefetch" href="/assets/js/295.ef66e1a4.js"><link rel="prefetch" href="/assets/js/296.47009685.js"><link rel="prefetch" href="/assets/js/297.fb7d20ba.js"><link rel="prefetch" href="/assets/js/298.cb1631f8.js"><link rel="prefetch" href="/assets/js/299.25f28097.js"><link rel="prefetch" href="/assets/js/3.9c10c990.js"><link rel="prefetch" href="/assets/js/30.b35b7ad0.js"><link rel="prefetch" href="/assets/js/300.ab5c587e.js"><link rel="prefetch" href="/assets/js/301.544c6982.js"><link rel="prefetch" href="/assets/js/302.70396486.js"><link rel="prefetch" href="/assets/js/303.fa1f3a02.js"><link rel="prefetch" href="/assets/js/304.c344682e.js"><link rel="prefetch" href="/assets/js/305.a0620b1d.js"><link rel="prefetch" href="/assets/js/306.8cb43e28.js"><link rel="prefetch" href="/assets/js/307.ee4d9e2d.js"><link rel="prefetch" href="/assets/js/308.bb04656d.js"><link rel="prefetch" href="/assets/js/309.b3e3c0be.js"><link rel="prefetch" href="/assets/js/31.af0fa05e.js"><link rel="prefetch" href="/assets/js/310.162df0c7.js"><link rel="prefetch" href="/assets/js/311.1a5e341e.js"><link rel="prefetch" href="/assets/js/312.9fe4ed85.js"><link rel="prefetch" href="/assets/js/313.e187b781.js"><link rel="prefetch" href="/assets/js/314.c832b372.js"><link rel="prefetch" href="/assets/js/315.66b7260d.js"><link rel="prefetch" href="/assets/js/316.074c1e65.js"><link rel="prefetch" href="/assets/js/317.9210b762.js"><link rel="prefetch" href="/assets/js/318.50ac3392.js"><link rel="prefetch" href="/assets/js/319.996a4c1b.js"><link rel="prefetch" href="/assets/js/32.81b4ee4b.js"><link rel="prefetch" href="/assets/js/320.661c3aa7.js"><link rel="prefetch" href="/assets/js/321.91d065c2.js"><link rel="prefetch" href="/assets/js/322.21d177e9.js"><link rel="prefetch" href="/assets/js/323.c240199c.js"><link rel="prefetch" href="/assets/js/324.fc71e18c.js"><link rel="prefetch" href="/assets/js/325.d441ab5e.js"><link rel="prefetch" href="/assets/js/326.6065a9e1.js"><link rel="prefetch" href="/assets/js/327.b68a9e0f.js"><link rel="prefetch" href="/assets/js/328.082fa547.js"><link rel="prefetch" href="/assets/js/329.17abf0b7.js"><link rel="prefetch" href="/assets/js/33.c41edd68.js"><link rel="prefetch" href="/assets/js/330.076712a3.js"><link rel="prefetch" href="/assets/js/331.b883690e.js"><link rel="prefetch" href="/assets/js/332.a942e6bd.js"><link rel="prefetch" href="/assets/js/333.e193acf6.js"><link rel="prefetch" href="/assets/js/334.5721c074.js"><link rel="prefetch" href="/assets/js/335.b759f5ec.js"><link rel="prefetch" href="/assets/js/336.8f786a4b.js"><link rel="prefetch" href="/assets/js/337.8ef80b90.js"><link rel="prefetch" href="/assets/js/338.8c63fda7.js"><link rel="prefetch" href="/assets/js/339.3df2ba0b.js"><link rel="prefetch" href="/assets/js/34.e166f3d5.js"><link rel="prefetch" href="/assets/js/340.e54bd836.js"><link rel="prefetch" href="/assets/js/341.1de3160e.js"><link rel="prefetch" href="/assets/js/342.52f64508.js"><link rel="prefetch" href="/assets/js/343.f56c914e.js"><link rel="prefetch" href="/assets/js/344.63033532.js"><link rel="prefetch" href="/assets/js/345.b23610d1.js"><link rel="prefetch" href="/assets/js/346.2c817177.js"><link rel="prefetch" href="/assets/js/347.bb20d78f.js"><link rel="prefetch" href="/assets/js/348.bba2b968.js"><link rel="prefetch" href="/assets/js/349.620d4fde.js"><link rel="prefetch" href="/assets/js/35.827d2ea3.js"><link rel="prefetch" href="/assets/js/350.a24a894c.js"><link rel="prefetch" href="/assets/js/351.9fc8ae8f.js"><link rel="prefetch" href="/assets/js/352.9229b958.js"><link rel="prefetch" href="/assets/js/353.ffe6628c.js"><link rel="prefetch" href="/assets/js/354.4f883a51.js"><link rel="prefetch" href="/assets/js/355.3232e481.js"><link rel="prefetch" href="/assets/js/356.52bb9172.js"><link rel="prefetch" href="/assets/js/357.4ee29887.js"><link rel="prefetch" href="/assets/js/358.22886190.js"><link rel="prefetch" href="/assets/js/359.1f40fcc5.js"><link rel="prefetch" href="/assets/js/36.7c80731a.js"><link rel="prefetch" href="/assets/js/360.630b9c12.js"><link rel="prefetch" href="/assets/js/37.6608ea0a.js"><link rel="prefetch" href="/assets/js/38.4c69b602.js"><link rel="prefetch" href="/assets/js/39.19f940a6.js"><link rel="prefetch" href="/assets/js/4.55a001d1.js"><link rel="prefetch" href="/assets/js/40.d3257c4f.js"><link rel="prefetch" href="/assets/js/41.89db1eaf.js"><link rel="prefetch" href="/assets/js/42.4a12d693.js"><link rel="prefetch" href="/assets/js/43.cbe3ed47.js"><link rel="prefetch" href="/assets/js/44.61c79193.js"><link rel="prefetch" href="/assets/js/45.ce5ed428.js"><link rel="prefetch" href="/assets/js/46.eea0f2fa.js"><link rel="prefetch" href="/assets/js/47.f3bd04d8.js"><link rel="prefetch" href="/assets/js/48.ed81abeb.js"><link rel="prefetch" href="/assets/js/49.978d3cae.js"><link rel="prefetch" href="/assets/js/5.fe551af2.js"><link rel="prefetch" href="/assets/js/50.e21176fc.js"><link rel="prefetch" href="/assets/js/51.2f5a0327.js"><link rel="prefetch" href="/assets/js/52.125f820a.js"><link rel="prefetch" href="/assets/js/53.4a1c114d.js"><link rel="prefetch" href="/assets/js/54.dfe3253b.js"><link rel="prefetch" href="/assets/js/55.5959dcbb.js"><link rel="prefetch" href="/assets/js/56.9d18670e.js"><link rel="prefetch" href="/assets/js/57.c238fb54.js"><link rel="prefetch" href="/assets/js/58.e221eedb.js"><link rel="prefetch" href="/assets/js/59.f628533d.js"><link rel="prefetch" href="/assets/js/6.4670d323.js"><link rel="prefetch" href="/assets/js/60.919ac5be.js"><link rel="prefetch" href="/assets/js/61.3a63b17e.js"><link rel="prefetch" href="/assets/js/62.e61011ad.js"><link rel="prefetch" href="/assets/js/63.55200ef4.js"><link rel="prefetch" href="/assets/js/64.7c19f83d.js"><link rel="prefetch" href="/assets/js/65.833da817.js"><link rel="prefetch" href="/assets/js/66.13f4f83f.js"><link rel="prefetch" href="/assets/js/67.0c77e799.js"><link rel="prefetch" href="/assets/js/68.cc0e543d.js"><link rel="prefetch" href="/assets/js/69.555bef08.js"><link rel="prefetch" href="/assets/js/7.90cda232.js"><link rel="prefetch" href="/assets/js/70.5d2ec40f.js"><link rel="prefetch" href="/assets/js/71.81f1af4b.js"><link rel="prefetch" href="/assets/js/72.8a66936f.js"><link rel="prefetch" href="/assets/js/73.2655fba2.js"><link rel="prefetch" href="/assets/js/74.ba0b3153.js"><link rel="prefetch" href="/assets/js/75.536955ba.js"><link rel="prefetch" href="/assets/js/77.9b243f6c.js"><link rel="prefetch" href="/assets/js/78.f580a907.js"><link rel="prefetch" href="/assets/js/79.38cbcc11.js"><link rel="prefetch" href="/assets/js/8.9cebf18a.js"><link rel="prefetch" href="/assets/js/80.e82012e8.js"><link rel="prefetch" href="/assets/js/81.73c65f97.js"><link rel="prefetch" href="/assets/js/82.ddfa06dd.js"><link rel="prefetch" href="/assets/js/83.b75fcea2.js"><link rel="prefetch" href="/assets/js/84.5e0efc6d.js"><link rel="prefetch" href="/assets/js/85.3a495ae2.js"><link rel="prefetch" href="/assets/js/86.1ebe8967.js"><link rel="prefetch" href="/assets/js/87.cd673062.js"><link rel="prefetch" href="/assets/js/88.f50e4960.js"><link rel="prefetch" href="/assets/js/89.06660ffb.js"><link rel="prefetch" href="/assets/js/9.04fce59d.js"><link rel="prefetch" href="/assets/js/90.aa61aeaf.js"><link rel="prefetch" href="/assets/js/91.865e8535.js"><link rel="prefetch" href="/assets/js/92.fd2d2a62.js"><link rel="prefetch" href="/assets/js/93.b185de83.js"><link rel="prefetch" href="/assets/js/94.f5290c38.js"><link rel="prefetch" href="/assets/js/95.be5b7fed.js"><link rel="prefetch" href="/assets/js/96.d442acd0.js"><link rel="prefetch" href="/assets/js/97.2f9b0746.js"><link rel="prefetch" href="/assets/js/98.3bba4945.js"><link rel="prefetch" href="/assets/js/99.cd82a6ed.js">
    <link rel="stylesheet" href="/assets/css/0.styles.237ce36e.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="wen chao" class="logo"> <span class="site-name can-hide">wen chao</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Algorithm" class="dropdown-title"><a href="/Algorithm/" class="link-title">Algorithm</a> <span class="title" style="display:none;">Algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d8e764/" class="nav-link">Theory</a></li><li class="dropdown-item"><!----> <a href="/pages/81a4bd/" class="nav-link">LeetCode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/Spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/373439/" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technology" class="dropdown-title"><a href="/Technology/" class="link-title">Technology</a> <span class="title" style="display:none;">Technology</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3b6841/" class="nav-link">DB</a></li><li class="dropdown-item"><!----> <a href="/pages/d7857e/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b89362/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/ec8b81/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/pages/4e3ff1/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/a75fef/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/pages/b194d7/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/pages/371f2f/" aria-current="page" class="nav-link router-link-exact-active router-link-active">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/027aa3/" class="nav-link">Workflow</a></li><li class="dropdown-item"><!----> <a href="/pages/73ab4b/" class="nav-link">OAuth2</a></li><li class="dropdown-item"><!----> <a href="/pages/d7a38a/" class="nav-link">JPA</a></li><li class="dropdown-item"><!----> <a href="/pages/eb5dc1/" class="nav-link">Liquibase</a></li><li class="dropdown-item"><!----> <a href="/pages/e54277/" class="nav-link">Lombok</a></li><li class="dropdown-item"><!----> <a href="/pages/62e4f6/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/13c836/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/b50b3d/" class="nav-link">Mini Program</a></li><li class="dropdown-item"><!----> <a href="/pages/09d3b8/" class="nav-link">JVM</a></li><li class="dropdown-item"><!----> <a href="/pages/a526c7/" class="nav-link">Log</a></li><li class="dropdown-item"><!----> <a href="/pages/59cf4f/" class="nav-link">JDK</a></li><li class="dropdown-item"><!----> <a href="/pages/d50dab/" class="nav-link">Thymeleaf</a></li><li class="dropdown-item"><!----> <a href="/pages/97abaa/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/7879f1/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/745b7c/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/pages/274dac/" class="nav-link">Raspberrypi</a></li><li class="dropdown-item"><!----> <a href="/pages/87c097/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/pages/927664/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/2c3f19/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><a href="/Other/" class="link-title">Other</a> <span class="title" style="display:none;">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fea344/" class="nav-link">Book</a></li><li class="dropdown-item"><!----> <a href="/pages/d62f72/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/f3d338/" class="nav-link">问题</a></li><li class="dropdown-item"><!----> <a href="/pages/ff202b/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/pages/2b746e/" class="nav-link">证券</a></li></ul></div></div><div class="nav-item"><a href="/About/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Index" class="dropdown-title"><a href="/archives/" class="link-title">Index</a> <span class="title" style="display:none;">Index</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/touxiang-lanse.png"> <div class="blogger-info"><h3>wen chao</h3> <span>持之以恒做正确有价值的事!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Algorithm" class="dropdown-title"><a href="/Algorithm/" class="link-title">Algorithm</a> <span class="title" style="display:none;">Algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d8e764/" class="nav-link">Theory</a></li><li class="dropdown-item"><!----> <a href="/pages/81a4bd/" class="nav-link">LeetCode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/Spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/373439/" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technology" class="dropdown-title"><a href="/Technology/" class="link-title">Technology</a> <span class="title" style="display:none;">Technology</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3b6841/" class="nav-link">DB</a></li><li class="dropdown-item"><!----> <a href="/pages/d7857e/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b89362/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/ec8b81/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/pages/4e3ff1/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/a75fef/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/pages/b194d7/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/pages/371f2f/" aria-current="page" class="nav-link router-link-exact-active router-link-active">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/027aa3/" class="nav-link">Workflow</a></li><li class="dropdown-item"><!----> <a href="/pages/73ab4b/" class="nav-link">OAuth2</a></li><li class="dropdown-item"><!----> <a href="/pages/d7a38a/" class="nav-link">JPA</a></li><li class="dropdown-item"><!----> <a href="/pages/eb5dc1/" class="nav-link">Liquibase</a></li><li class="dropdown-item"><!----> <a href="/pages/e54277/" class="nav-link">Lombok</a></li><li class="dropdown-item"><!----> <a href="/pages/62e4f6/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/13c836/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/b50b3d/" class="nav-link">Mini Program</a></li><li class="dropdown-item"><!----> <a href="/pages/09d3b8/" class="nav-link">JVM</a></li><li class="dropdown-item"><!----> <a href="/pages/a526c7/" class="nav-link">Log</a></li><li class="dropdown-item"><!----> <a href="/pages/59cf4f/" class="nav-link">JDK</a></li><li class="dropdown-item"><!----> <a href="/pages/d50dab/" class="nav-link">Thymeleaf</a></li><li class="dropdown-item"><!----> <a href="/pages/97abaa/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/7879f1/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/745b7c/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/pages/274dac/" class="nav-link">Raspberrypi</a></li><li class="dropdown-item"><!----> <a href="/pages/87c097/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/pages/927664/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/2c3f19/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><a href="/Other/" class="link-title">Other</a> <span class="title" style="display:none;">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fea344/" class="nav-link">Book</a></li><li class="dropdown-item"><!----> <a href="/pages/d62f72/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/f3d338/" class="nav-link">问题</a></li><li class="dropdown-item"><!----> <a href="/pages/ff202b/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/pages/2b746e/" class="nav-link">证券</a></li></ul></div></div><div class="nav-item"><a href="/About/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Index" class="dropdown-title"><a href="/archives/" class="link-title">Index</a> <span class="title" style="display:none;">Index</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Zookeeper</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Dubbo</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ElasticSearch</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/371f2f/" aria-current="page" class="active sidebar-link">ElasticSearch指南</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/371f2f/#思维脑图" class="sidebar-link">思维脑图</a></li><li class="sidebar-sub-header level2"><a href="/pages/371f2f/#_1-elasticsearch简介" class="sidebar-link">1.ElasticSearch简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#应用场景" class="sidebar-link">应用场景</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#目录结构" class="sidebar-link">目录结构</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#es-与-lucene的关系" class="sidebar-link">ES 与 Lucene的关系</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#es-vs-solr比较" class="sidebar-link">ES vs Solr比较</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#es-vs-关系型数据库" class="sidebar-link">ES vs 关系型数据库</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/371f2f/#_2-elasticsearch安装" class="sidebar-link">2.Elasticsearch安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#es单机搭建" class="sidebar-link">ES单机搭建</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#es集群搭建" class="sidebar-link">ES集群搭建</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#kibana安装" class="sidebar-link">Kibana安装</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#ik分词器安装" class="sidebar-link">IK分词器安装</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#elasticsearch-head安装" class="sidebar-link">Elasticsearch-head安装</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#beats" class="sidebar-link">Beats</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#logstash" class="sidebar-link">Logstash</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/371f2f/#_3-什么是全文检索" class="sidebar-link">3.什么是全文检索</a></li><li class="sidebar-sub-header level2"><a href="/pages/371f2f/#_4-倒排索引" class="sidebar-link">4.倒排索引</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#原理" class="sidebar-link">原理</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#核心算法" class="sidebar-link">核心算法</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#倒排检索-vs-mysql-索引" class="sidebar-link">倒排检索 VS MySQL 索引</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/371f2f/#_5-elasticsearch中的核心概念" class="sidebar-link">5.Elasticsearch中的核心概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#数据类型" class="sidebar-link">数据类型</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#index-索引" class="sidebar-link">index 索引</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#mapping-映射" class="sidebar-link">mapping 映射</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#dynamic-field-mapping-动态映射或自动映射" class="sidebar-link">Dynamic field mapping：（动态映射或自动映射）</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#整数-long" class="sidebar-link">整数				     =&gt;	long</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#浮点数-float" class="sidebar-link">浮点数			     =&gt;	float</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#true-false-boolean" class="sidebar-link">true || false	 =&gt;	boolean</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#日期-date" class="sidebar-link">日期		             =&gt;	date</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#数组-取决于数组中的第一个有效值" class="sidebar-link">数组                     =&gt;    取决于数组中的第一个有效值</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#对象-object" class="sidebar-link">对象                     =&gt;    object</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#字符串-如果不是数字和日期类型-那会被映射为text和keyword两个类型" class="sidebar-link">字符串                 =&gt;    如果不是数字和日期类型，那会被映射为text和keyword两个类型</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#expllcit-field-mapping-手动映射-静态映射或手工映射或显示映射" class="sidebar-link">Expllcit field mapping：手动映射/（静态映射或手工映射或显示映射）</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#映射参数" class="sidebar-link">映射参数</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#对已存在的mapping映射进行修改" class="sidebar-link">对已存在的mapping映射进行修改</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#field-字段" class="sidebar-link">Field 字段</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#type-字段类型" class="sidebar-link">Type 字段类型</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#document-文档" class="sidebar-link">document 文档</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#集群-cluster" class="sidebar-link">集群 cluster</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#节点-node" class="sidebar-link">节点 node</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#分片和副本-shards-replicas" class="sidebar-link">分片和副本 shards&amp;replicas</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/371f2f/#_6-query-dsl-domain-specific-language" class="sidebar-link">6.Query DSL(Domain Specific Language)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-1-查询上下文" class="sidebar-link">6.1 查询上下文</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-2-相关度评分-score" class="sidebar-link">6.2 相关度评分：_score</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-3-元数据-source" class="sidebar-link">6.3 元数据：_source</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-4-query-string" class="sidebar-link">6.4 Query String</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-5-全文检索-full-text-query" class="sidebar-link">6.5 全文检索-Full text query</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-6-精准查询-term-query" class="sidebar-link">6.6 精准查询-Term query</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#term-匹配和搜索词项完全相等的结果" class="sidebar-link">term：匹配和搜索词项完全相等的结果</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#terms-匹配和搜索词项列表中任意项匹配的结果" class="sidebar-link">terms：匹配和搜索词项列表中任意项匹配的结果</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#range-范围查找" class="sidebar-link">range：范围查找</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-7-过滤器-filter" class="sidebar-link">6.7 过滤器-Filter</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-8-组合查询-bool-query" class="sidebar-link">6.8 组合查询-Bool query</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-9-聚合查询" class="sidebar-link">6.9 聚合查询</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#桶聚合" class="sidebar-link">桶聚合</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#指标聚合" class="sidebar-link">指标聚合</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#管道聚合" class="sidebar-link">管道聚合</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#嵌套聚合" class="sidebar-link">嵌套聚合</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#聚合和查询的相互关系" class="sidebar-link">聚合和查询的相互关系</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#聚合排序" class="sidebar-link">聚合排序</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-10-脚本查询" class="sidebar-link">6.10 脚本查询</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-11-1-批量查询-mget" class="sidebar-link">6.11.1 批量查询 _mget</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-11-2-批量增删改-bulk" class="sidebar-link">6.11.2 批量增删改 _bulk</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-12-模糊查询-智能搜索推荐" class="sidebar-link">6.12 模糊查询，智能搜索推荐</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#前缀搜索-prefix" class="sidebar-link">前缀搜索：prefix</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#通配符-wildcard" class="sidebar-link">通配符：wildcard</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#正则-regexp" class="sidebar-link">正则：regexp</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#match-phrase-prefix短语前缀" class="sidebar-link">matchphraseprefix短语前缀</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#n-gram和edge-ngram" class="sidebar-link">N-gram和edge ngram</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-13-搜索推荐-suggest" class="sidebar-link">6.13 搜索推荐 Suggest</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-14-数据建模" class="sidebar-link">6.14 数据建模</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#_6-14-1-嵌套类型-nested" class="sidebar-link">6.14.1 嵌套类型：Nested</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#_6-14-2-父子级关系-join" class="sidebar-link">6.14.2 父子级关系：Join</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#_6-14-3-数据建模" class="sidebar-link">6.14.3 数据建模</a></li><li class="sidebar-sub-header level5"><a href="/pages/371f2f/#_6-14-3-1-概念" class="sidebar-link">6.14.3.1 概念</a></li><li class="sidebar-sub-header level5"><a href="/pages/371f2f/#_6-14-3-2-对象和实体" class="sidebar-link">6.14.3.2 对象和实体</a></li><li class="sidebar-sub-header level5"><a href="/pages/371f2f/#_6-14-3-3-数据建模的过程" class="sidebar-link">6.14.3.3 数据建模的过程</a></li><li class="sidebar-sub-header level5"><a href="/pages/371f2f/#_6-14-3-4-意义" class="sidebar-link">6.14.3.4 意义</a></li><li class="sidebar-sub-header level5"><a href="/pages/371f2f/#_6-14-3-5-数据建模的包含的内容" class="sidebar-link">6.14.3.5 数据建模的包含的内容</a></li><li class="sidebar-sub-header level5"><a href="/pages/371f2f/#关联关系处理-index-relations" class="sidebar-link">关联关系处理（index relations）：</a></li><li class="sidebar-sub-header level5"><a href="/pages/371f2f/#数据模型的关联-我们通过在我们的应用程序中实现联接可以-部分-模拟关系数据库。应用层联接的主要优点是可以对数据进行标准化处理。只能在-user-文档中修改用户的名称。缺点是-为了在搜索时联接文档-必须运行额外的查询" class="sidebar-link">数据模型的关联：我们通过在我们的应用程序中实现联接可以（部分）模拟关系数据库。应用层联接的主要优点是可以对数据进行标准化处理。只能在 user 文档中修改用户的名称。缺点是，为了在搜索时联接文档，必须运行额外的查询</a></li><li class="sidebar-sub-header level5"><a href="/pages/371f2f/#非规范化数据-使用-elasticsearch-得到最好的搜索性能的方法是有目的的通过在索引时进行非规范化-denormalizing。对每个文档保持一定数量的冗余副本可以在需要访问时避免进行关联" class="sidebar-link">非规范化数据：使用 Elasticsearch 得到最好的搜索性能的方法是有目的的通过在索引时进行非规范化 denormalizing。对每个文档保持一定数量的冗余副本可以在需要访问时避免进行关联</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-15-多字段检索-multi-match" class="sidebar-link">6.15 多字段检索 multi_match</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#_6-15-1-best-fields" class="sidebar-link">6.15.1 best_fields</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#_6-15-2-tie-breaker参数" class="sidebar-link">6.15.2 tie_breaker参数</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#_6-15-3-most-fields" class="sidebar-link">6.15.3 most_fields</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#_6-15-4-cross-fields" class="sidebar-link">6.15.4 cross_fields</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-16-地理位置搜索" class="sidebar-link">6.16 地理位置搜索</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#_6-16-1-两种数据类型" class="sidebar-link">6.16.1 两种数据类型</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#_6-16-2-四种查询" class="sidebar-link">6.16.2 四种查询</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#_6-16-3-地理几何分类-geo-shape-type" class="sidebar-link">6.16.3 地理几何分类（geo_shape type）</a></li><li class="sidebar-sub-header level4"><a href="/pages/371f2f/#_6-16-4-圆形处理精度解释" class="sidebar-link">6.16.4 圆形处理精度解释</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#_6-17-dsl语言高级查询" class="sidebar-link">6.17 DSL语言高级查询</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/371f2f/#_7-分词器" class="sidebar-link">7 分词器</a></li><li class="sidebar-sub-header level2"><a href="/pages/371f2f/#_8-es客户端-elasticsearch-clients" class="sidebar-link">8 ES客户端：Elasticsearch Clients</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#语言无关性" class="sidebar-link">语言无关性</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#java-api" class="sidebar-link">Java API</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#java-low-level-rest-client" class="sidebar-link">Java Low-level REST client</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#java-high-level-rest-client" class="sidebar-link">Java High Level REST Client</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#java-api-rest-api-优缺" class="sidebar-link">Java API / Rest API 优缺</a></li><li class="sidebar-sub-header level5"><a href="/pages/371f2f/#low-level-client" class="sidebar-link">Low level Client</a></li><li class="sidebar-sub-header level5"><a href="/pages/371f2f/#high-level-client" class="sidebar-link">High level Client</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/371f2f/#_9-spring-data-elasticsearch" class="sidebar-link">9 Spring Data Elasticsearch</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#概念" class="sidebar-link">概念</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#特点" class="sidebar-link">特点</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#官网" class="sidebar-link">官网</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#兼容性-必看" class="sidebar-link">兼容性(必看)</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#文档地址" class="sidebar-link">文档地址</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#优缺点" class="sidebar-link">优缺点</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#maven-repository" class="sidebar-link">Maven Repository</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#注解" class="sidebar-link">注解</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#操作类型" class="sidebar-link">操作类型</a></li><li class="sidebar-sub-header level3"><a href="/pages/371f2f/#high-level-rest-client" class="sidebar-link">High Level REST Client</a></li></ul></li></ul></li><li><a href="/pages/0f5882/" class="sidebar-link">ElasticSearch原理</a></li><li><a href="/pages/036417/" class="sidebar-link">ElasticSearch查询</a></li><li><a href="/pages/f2c921/" class="sidebar-link">ElasticSearch文档分值_score计算底层原理</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Workflow</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OAuth2</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JPA</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Liquibase</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Lombok</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Log</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JDK</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Thymeleaf</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Maven</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mybatis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Raspberrypi</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/Technology/#Technology" data-v-06225672>Technology</a></li><li data-v-06225672><a href="/Technology/#ElasticSearch" data-v-06225672>ElasticSearch</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/nylg" target="_blank" title="作者" class="beLink" data-v-06225672>wenchao</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2021-09-08</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">ElasticSearch指南<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="思维脑图"><a href="#思维脑图" class="header-anchor">#</a> 思维脑图</h2> <p>https://www.processon.com/view/link/619227e21e0853689b11178b</p> <h2 id="_1-elasticsearch简介"><a href="#_1-elasticsearch简介" class="header-anchor">#</a> 1.ElasticSearch简介</h2> <p>Elasticsearch是用Java开发并且是当前最流行的开源的企业级搜索引擎。</p> <p>能够达到实时搜索，稳定，可靠，快速，安装使用方便。</p> <p>客户端支持Java、.NET（C#）、PHP、Python、Ruby等多种语言。</p> <p><strong>官方网站:</strong> https://www.elastic.co/</p> <p><strong>下载地址</strong>：https://www.elastic.co/cn/start</p> <p>**创始人:**Shay Banon（谢巴农）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Elastic Stack：
1.Elasticsearch 基于Json的分布式搜索和分析引擎
2.Logstash 动态数据收集管道，生态丰富
3.Kibana 提供数据的可视化界面
4.Beats 轻量级的数据采集器
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h3> <ol><li><p>浏览器搜索</p></li> <li><p>商城页面商品搜索</p> <p>....</p></li></ol> <h3 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h3> <table><thead><tr><th><strong>目录名称</strong></th> <th><strong>描述</strong></th></tr></thead> <tbody><tr><td>bin</td> <td>可执行脚本文件，包括启动elasticsearch服务、插件管理、函数命令等。</td></tr> <tr><td>config</td> <td>配置文件目录，如elasticsearch配置、角色配置、jvm配置等。</td></tr> <tr><td>lib</td> <td>elasticsearch所依赖的java库。</td></tr> <tr><td>data</td> <td>默认的数据存放目录，包含节点、分片、索引、文档的所有数据，生产环境要求必须修改。</td></tr> <tr><td>logs</td> <td>默认的日志文件存储路径，生产环境务必修改。</td></tr> <tr><td>modules</td> <td>包含所有的Elasticsearch模块，如Cluster、Discovery、Indices等。</td></tr> <tr><td>plugins</td> <td>已经安装的插件的目录。</td></tr> <tr><td>jdk/jdk.app</td> <td>7.0以后才有，自带的java环境。</td></tr></tbody></table> <h3 id="es-与-lucene的关系"><a href="#es-与-lucene的关系" class="header-anchor">#</a> ES 与 Lucene的关系</h3> <p>Lucene可以被认为是迄今为止最先进、性能最好的、功能最全的搜索引擎库（框架）</p> <p>但是想要使用Lucene，必须使用Java来作为开发语言并将其直接集成到你的应用中，并且Lucene的配置及使用非常复杂，你需要深入了解检索的相关知识来理解它是如何工作的。</p> <p><strong>Lucene缺点：</strong></p> <div class="language- extra-class"><pre><code>1. 只能在Java项目中使用,并且要以jar包的方式直接集成项目中.

2. 使用非常复杂-创建索引和搜索索引代码繁杂

3. 不支持集群环境-索引数据不同步（不支持大型项目.   

4. 索引数据如果太多就不行，索引库和应用所在同一个服务器,共同占用硬盘.共用空间少.
</code></pre></div><p>上述Lucene框架中的缺点,ES全部都能解决.</p> <p>哪些公司在使用Elasticsearch</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1. 京东
2. 携程
3. 去哪儿
4. 58同城
5. 滴滴
6. 今日头条
7. 小米
8. 哔哩哔哩
9. 联想
10. GitHup
11. 微软
12. Facebook
等等...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="es-vs-solr比较"><a href="#es-vs-solr比较" class="header-anchor">#</a> ES vs Solr比较</h3> <p><strong>ES vs Solr 检索速度</strong></p> <p>当单纯的对已有数据进行搜索时，Solr更快。</p> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/4.png" alt=""></p> <p>当实时建立索引时, Solr会产生io阻塞，查询性能较差, Elasticsearch具有明显的优势。</p> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/5.png" alt=""></p> <p>大型互联网公司，实际生产环境测试，将搜索引擎从Solr转到 Elasticsearch以后的平均查询速度有了50倍的提升。</p> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/6.png" alt=""></p> <p><strong>总结：</strong></p> <p>二者安装都很简单。</p> <ol><li><p>Solr 利用 Zookeeper 进行分布式管理，而Elasticsearch 自身带有分布式协调管理功能。</p></li> <li><p>Solr 支持更多格式的数据，比如JSON、XML、CSV，而 Elasticsearch 仅支持json文件格式。</p></li> <li><p>Solr 在传统的搜索应用中表现好于 Elasticsearch，但在处理实时搜索应用时效率明显低于 Elasticsearch。</p></li> <li><p>Solr 是传统搜索应用的有力解决方案，但 Elasticsearch更适用于新兴的实时搜索应用。</p></li></ol> <h3 id="es-vs-关系型数据库"><a href="#es-vs-关系型数据库" class="header-anchor">#</a> ES vs 关系型数据库</h3> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/7.png" alt=""></p> <h2 id="_2-elasticsearch安装"><a href="#_2-elasticsearch安装" class="header-anchor">#</a> 2.Elasticsearch安装</h2> <h3 id="es单机搭建"><a href="#es单机搭建" class="header-anchor">#</a> ES单机搭建</h3> <p><strong>创建普通用户</strong></p> <p><strong>ES不能使用root用户来启动，必须使用普通用户来安装启动</strong>。这里我们创建一个普通用户以及定义一些常规目录用于存放我们的数据文件以及安装包等。</p> <p>创建一个es专门的用户（<strong>必须</strong>）</p> <p><strong>使用root用户在服务器执行以下命令</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>先创建组, 再创建用户:
1）创建 elasticsearch 用户组
[root@localhost ~]# groupadd elasticsearch
		
2）创建用户 tlbaiqi 并设置密码
[root@localhost ~]# useradd tlbaiqi
[root@localhost ~]# passwd tlbaiqi

3）# 创建es文件夹，
并修改owner为baiqi用户
mkdir -p /usr/local/es

4）用户es 添加到 elasticsearch 用户组
[root@localhost ~]# usermod -G elasticsearch tlbaiqi
[root@localhost ~]# chown -R tlbaiqi /usr/local/es/elasticsearch-7.6.1

5）设置sudo权限
#为了让普通用户有更大的操作权限，我们一般都会给普通用户设置sudo权限，方便普通用户的操作
#三台机器使用root用户执行visudo命令然后为es用户添加权限
[root@localhost ~]# visudo

#在root ALL=(ALL) ALL 一行下面
#添加tlbaiqi用户 如下:
tlbaiqi ALL=(ALL) ALL
			 
#添加成功保存后切换到tlbaiqi用户操作

[root@localhost ~]# su tlbaiqi
[tlbaiqi@localhost root]$

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>注意！</p> <blockquote><p>如果su tlbaiqi后进入用户命令行后，界面不正确，如图：</p> <p><img src="https://gitee.com/nylg/picture/raw/master/es/111.PNG" alt=""></p> <p>可能是因为没有home下的文件夹，以及shell无法自动补全的显现。出现此问题只要修改/etc/passwd下的/bin/sh为/bin/bash即可。解决方法：</p> <p><img src="https://gitee.com/nylg/picture/raw/master/es/222.png" alt=""></p></blockquote> <p><strong>上传压缩包并解压</strong></p> <p>将es的安装包下载并上传到服务器的/user/local/es路径下，然后进行解压</p> <p>使用tlbaiqi用户来执行以下操作，将es安装包上传到指定服务器，并使用es用户执行以下命令解压。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 解压Elasticsearch
su tlbaiqi
cd /user/local/
tar -zvxf elasticsearch-7.6.1-linux-x86_64.tar.gz -C /usr/local/es/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>修改elasticsearch.yml</strong></p> <p>进入服务器使用<strong>baiqi</strong>用户来修改配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/es/elasticsearch-7.6.1/config
mkdir -p /usr/local/es/elasticsearch-7.6.1/log
mkdir -p /usr/local/es/elasticsearch-7.6.1/data
rm -rf elasticsearch.yml

vim elasticsearch.yml
cluster.name: baiqi-es
node.name: node1
path.data: /usr/local/es/elasticsearch-7.6.1/data
path.logs: /usr/local/es/elasticsearch-7.6.1/log
network.host: 0.0.0.0
http.port: 9200
discovery.seed_hosts: [&quot;192.168.12.12&quot;] #你的[&quot;服务器IP&quot;]
cluster.initial_master_nodes: [&quot;node1&quot;] #你的node.name值
bootstrap.system_call_filter: false
bootstrap.memory_lock: false
http.cors.enabled: true
http.cors.allow-origin: &quot;*&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><blockquote><p>discovery.seed_hosts：当这个节点启动的时候，会读取该配置项，这个配置项里是一个IP地址的字符串数组，用于发现其它节点</p> <p>cluster.initial_master_nodes：这个配置项是初始化集群时候，用作初始化为master的节点。配置项的值为节点名称<strong>node.name</strong>属性的字符串数组</p></blockquote> <p><strong>修改jvm.option</strong></p> <p>修改jvm.option配置文件，调整jvm堆内存大小</p> <p><strong>node1.baiqi.cn使用baiqi用户</strong>执行以下命令调整jvm堆内存大小，每个人根据自己服务器的内存大小来进行调整。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/es/elasticsearch-7.6.1/config
vim jvm.options
-Xms2g
-Xmx2g
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>修改系统配置，解决启动时候的问题</strong></p> <p>由于现在使用普通用户来安装es服务，且es服务对服务器的资源要求比较多，包括内存大小，线程数等。所以我们需要给普通用户解开资源的束缚</p> <p><strong>4.2.1  普通用户打开文件的最大数限制</strong></p> <p>问题错误信息描述：</p> <p>max file descriptors [4096] for elasticsearch process likely too low, increase to at least [65536]</p> <p>ES因为需要大量的创建索引文件，需要大量的打开系统的文件，所以我们需要解除linux系统当中打开文件最大数目的限制，不然ES启动就会抛错</p> <p>三台机器使用baiqi用户执行以下命令解除打开文件数据的限制</p> <p>sudo vi /etc/security/limits.conf</p> <p>添加如下内容: 注意*不要去掉了</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>* soft nofile 65536
* hard nofile 131072
* soft nproc 4096
* hard nproc 4096
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>4.2.2</strong> <strong>此文件修改后需要重新登录用户，才会生效</strong></p> <p><strong>普通用户启动线程数限制</strong></p> <p>问题错误信息描述</p> <p>max number of threads [1024] for user [es] likely too low, increase to at least [4096]</p> <p>修改普通用户可以创建的最大线程数</p> <p>*max number of threads [1024] for user [es] likely too low, increase to at least [4096]*原因：无法创建本地线程问题,用户最大可创建线程数太小解决方案：修改90-nproc.conf 配置文件。</p> <p>三台机器使用baiqi用户执行以下命令修改配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Centos6
sudo vi /etc/security/limits.d/90-nproc.conf
Centos7
sudo vi /etc/security/limits.d/20-nproc.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>找到如下内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>* soft nproc 1024#修改为
* soft nproc 4096
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>4.2.3 普通用户调大虚拟内存</strong></p> <p>错误信息描述：</p> <p>max virtual memory areas vm.max_map_count [65530] likely too low, increase to at least [262144]</p> <p>调大系统的虚拟内存</p> <p>原因：最大虚拟内存太小</p> <p>每次启动机器都手动执行下。</p> <p>三台机器执行以下命令</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>编辑 /etc/sysctl.conf，追加以下内容：vm.max_map_count=262144 保存后，执行：sysctl -p 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>备注：以上三个问题解决完成之后，重新连接secureCRT或者重新连接xshell生效</p> <p><strong>4.3  启动ES服务</strong></p> <p>三台机器使用baiqi用户执行以下命令启动es服务</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup /usr/local/es/elasticsearch-7.6.1/bin/elasticsearch 2&gt;&amp;1 &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>后台启动ES 进入bin目录  ./elasticsearch  -d</p> <p>启动成功之后jsp即可看到es的服务进程，并且访问页面</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://192.168.21.130:9200/?pretty
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>能够看到es启动之后的一些信息</p> <p>注意：如果哪一台机器服务启动失败，那么就到哪一台机器的</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/usr/local/es/elasticsearch-7.6.1/log
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这个路径下面去查看错误日志</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>关闭Linux防火墙
永久性生效，重启后不会复原
开启： chkconfig iptables on
关闭： chkconfig iptables off
即时生效，重启后复原
开启： service iptables start
关闭： service iptables stop
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>注意:启动ES的时候出现 Permission denied</p> <p>原因：当前的用户没有对XX文件或目录的操作权限</p> <h3 id="es集群搭建"><a href="#es集群搭建" class="header-anchor">#</a> ES集群搭建</h3> <p><strong>1.将安装包分发到其他服务器上面</strong></p> <p><strong>2.修改elasticsearch.yml</strong></p> <p>node1.baiqi.cn 服务器使用<strong>baiqi</strong>用户来修改配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir -p /usr/local/es/elasticsearch-7.6.1/log
mkdir -p /usr/local/es/elasticsearch-7.6.1/data

cd /usr/local/es/elasticsearch-7.6.1/config

rm -rf elasticsearch.yml

vim elasticsearch.yml
cluster.name: baiqi-es
node.name: node1.baiqi.cn
path.data: /usr/local/es/elasticsearch-7.6.1/data
path.logs: /usr/local/es/elasticsearch-7.6.1/log
network.host: node1.baiqi.cn
http.port: 9200
discovery.seed_hosts: [&quot;IP1&quot;, &quot;IP2&quot;, &quot;IP3&quot;]
cluster.initial_master_nodes: [&quot;节点1名称&quot;, &quot;节点2名称&quot;, &quot;节点3名称&quot;]
bootstrap.system_call_filter: false
bootstrap.memory_lock: false
http.cors.enabled: true
http.cors.allow-origin: &quot;*&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>3.修改jvm.option</strong></p> <p>修改jvm.option配置文件，调整jvm堆内存大小</p> <p><strong>node1.baiqi.cn使用baiqi用户</strong>执行以下命令调整jvm堆内存大小，每个人根据自己服务器的内存大小来进行调整。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/es/elasticsearch-7.6.1/config
vim jvm.options
-Xms2g
-Xmx2g
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>4.node2与node3修改es配置文件</strong></p> <p>node2.baiqi.cn与node3.baiqi.cn也需要修改es配置文件</p> <p>node2.baiqi.cn使用baiqi用户执行以下命令修改es配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir -p /usr/local/es/elasticsearch-7.6.1/log
mkdir -p /usr/local/es/elasticsearch-7.6.1/data

cd /usr/local/es/elasticsearch-7.6.1/config


vim elasticsearch.yml
cluster.name: baiqi-es
node.name: node2.baiqi.cn
path.data: /usr/local/es/elasticsearch-7.6.1/data
path.logs: /usr/local/es/elasticsearch-7.6.1/log
network.host: node2.baiqi.cn
http.port: 9200
discovery.seed_hosts: [&quot;IP1&quot;, &quot;IP2&quot;, &quot;IP3&quot;]
cluster.initial_master_nodes: [&quot;节点1名称&quot;, &quot;节点2名称&quot;, &quot;节点3名称&quot;]
bootstrap.system_call_filter: false
bootstrap.memory_lock: false
http.cors.enabled: true
http.cors.allow-origin: &quot;*&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>node3.baiqi.cn使用baiqi用户执行以下命令修改配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir -p /usr/local/es/elasticsearch-7.6.1/log
mkdir -p /usr/local/es/elasticsearch-7.6.1/data

cd /usr/local/es/elasticsearch-7.6.1/config


vim elasticsearch.yml
cluster.name: baiqi-es
node.name: node3.baiqi.cn
path.data: /usr/local/es/elasticsearch-7.6.1/data
path.logs: /usr/local/es/elasticsearch-7.6.1/log
network.host: node3.baiqi.cn
http.port: 9200
discovery.seed_hosts: [&quot;IP1&quot;, &quot;IP2&quot;, &quot;IP3&quot;]
cluster.initial_master_nodes: [&quot;节点1名称&quot;, &quot;节点2名称&quot;, &quot;节点3名称&quot;]
bootstrap.system_call_filter: false
bootstrap.memory_lock: false
http.cors.enabled: true
http.cors.allow-origin: &quot;*&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>​</p> <p>查看集群状态：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET   _cat/nodes?v
GET   _cat/health?v
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>客户端Kibana安装</p> <p><strong>5.1客户端可以分为图形界面客户端,和代码客户端.</strong></p> <p>5.2 ES主流客户端Kibana，开放9200端口与图形界面客户端交互</p> <p>1)下载Kibana放之/usr/local/es目录中</p> <p>2)解压文件：tar -zxvf kibana-X.X.X-linux-x86_64.tar.gz</p> <p>3)进入/usr/local/es/kibana-X.X.X-linux-x86_64/config目录</p> <p>4）使用vi编辑器：vi kibana.yml</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>   server.port: 5601
   server.host: &quot;服务器IP&quot;
   elasticsearch.hosts: [&quot;http://192.156.12.12:9200&quot;]  #这里是elasticsearch的访问地址,支持多配置，所以是数组方式
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>5）启动Kibana</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/usr/local/es/kibana-7.6.1-linux-x86_64/bin/kibana
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>如果启动显示没有操作kibana.yml</p> <p>则切换到root用户给普通用户赋予文件夹权限：chown -R tibaiqi /usr/local/es</p></blockquote> <p>后台启动kibana</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup  ./kibana &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>6）访问Kibana</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://ip:5601/app/kibana
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="kibana安装"><a href="#kibana安装" class="header-anchor">#</a> Kibana安装</h3> <p><strong>5.1客户端可以分为图形界面客户端,和代码客户端.</strong></p> <p>5.2 ES主流客户端Kibana，开放9200端口与图形界面客户端交互</p> <p>1)下载Kibana放之/usr/local/es目录中</p> <p>2)解压文件：tar -zxvf kibana-X.X.X-linux-x86_64.tar.gz</p> <p>3)进入/usr/local/es/kibana-X.X.X-linux-x86_64/config目录</p> <p>4）使用vi编辑器：vi kibana.yml</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>   server.port: 5601
   server.host: &quot;服务器IP&quot;
   elasticsearch.hosts: [&quot;http://192.156.12.12:9200&quot;]  #这里是elasticsearch的访问地址,支持多配置，所以是数组方式
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>5）启动Kibana</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/usr/local/es/kibana-7.6.1-linux-x86_64/bin/kibana
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>如果启动显示没有操作kibana.yml</p> <p>则切换到root用户给普通用户赋予文件夹权限：chown -R tibaiqi /usr/local/es</p></blockquote> <p>后台启动kibana</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup  ./kibana &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>6）访问Kibana</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://ip:5601/app/kibana
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="ik分词器安装"><a href="#ik分词器安装" class="header-anchor">#</a> IK分词器安装</h3> <p>我们后续也需要使用Elasticsearch来进行中文分词，所以需要单独给Elasticsearch安装IK分词器插件。以下为具体安装步骤：</p> <p>6.1 下载Elasticsearch IK分词器</p> <p>https://github.com/medcl/elasticsearch-analysis-ik/releases</p> <p>6.2 切换到baiqi用户，并在es的安装目录下/plugins创建ik</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir -p /usr/local/es/elasticsearch-7.6.1/plugins/ik
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>6.3 将下载的ik分词器上传并解压到该目录</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/es/elasticsearch-7.6.1/plugins/ik
unzip  elasticsearch-analysis-ik-7.6.1.zip 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>6.4 重启Elasticsearch</p> <p>6.5 测试分词效果</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST _analyze
{
&quot;analyzer&quot;:&quot;standard&quot;,
&quot;text&quot;:&quot;我爱你中国&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>POST _analyze
{
&quot;analyzer&quot;: &quot;ik_smart&quot;,
&quot;text&quot;: &quot;中华人民共和国&quot;
 }
#ik_smart:会做最粗粒度的拆分
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>POST _analyze
{
&quot;analyzer&quot;:&quot;ik_max_word&quot;,
&quot;text&quot;:&quot;我爱你中国&quot;
}
#ik_max_word:会将文本做最细粒度的拆分
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>7、指定IK分词器作为默认分词器</strong></p> <p>ES的默认分词设置是standard，这个在中文分词时就比较尴尬了，会单字拆分，比如我搜索关键词“清华大学”，这时候会按“清”，“华”，“大”，“学”去分词，然后搜出来的都是些“清清的河水”，“中华儿女”，“地大物博”，“学而不思则罔”之类的莫名其妙的结果，这里我们就想把这个分词方式修改一下，于是呢，就想到了ik分词器，有两种ik_smart和ik_max_word。</p> <p>ik_smart会将“清华大学”整个分为一个词，而ik_max_word会将“清华大学”分为“清华大学”，“清华”和“大学”，按需选其中之一就可以了。</p> <p>修改默认分词方法(这里修改school_index索引的默认分词为：ik_max_word)：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /school_index
{
&quot;settings&quot; : {
&quot;index&quot; : {
&quot;analysis.analyzer.default.type&quot;: &quot;ik_max_word&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="elasticsearch-head安装"><a href="#elasticsearch-head安装" class="header-anchor">#</a> Elasticsearch-head安装</h3> <p>由于es服务启动之后，访问界面比较丑陋，为了更好的查看索引库当中的信息，我们可以通过安装elasticsearch-head这个插件来实现，这个插件可以更方便快捷的看到es的管理界面</p> <p>elasticsearch-head这个插件是es提供的一个用于图形化界面查看的一个插件工具，可以安装上这个插件之后，通过这个插件来实现我们通过浏览器查看es当中的数据</p> <p>安装elasticsearch-head这个插件这里提供两种方式进行安装，第一种方式就是自己下载源码包进行编译，耗时比较长，网络较差的情况下，基本上不可能安装成功。</p> <p>第二种方式就是直接使用我已经编译好的安装包，进行修改配置即可</p> <p>要安装elasticsearch-head插件，需要先安装Node.js</p> <p><strong>1  安装nodejs</strong></p> <p>Node.js是一个基于 Chrome V8 引擎的 JavaScript 运行环境。</p> <p>Node.js是一个Javascript运行环境(runtime environment)，发布于2009年5月，由Ryan Dahl开发，实质是对Chrome V8引擎进行了封装。Node.js 不是一个 JavaScript 框架，不同于CakePHP、Django、Rails。Node.js 更不是浏览器端的库，不能与 jQuery、ExtJS 相提并论。Node.js 是一个让 JavaScript 运行在服务端的开发平台，它让 JavaScript 成为与PHP、Python、Perl、Ruby 等服务端语言平起平坐的脚本语言。</p> <p><strong>1.1  下载安装包</strong></p> <p>node1.baiqi.cn机器执行以下命令下载安装包，然后进行解压</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/es
wget https://npm.taobao.org/mirrors/node/v8.1.0/node-v8.1.0-linux-x64.tar.gz
tar -zxvf node-v8.1.0-linux-x64.tar.gz -C /usr/local/es/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>1.2  创建软连接</strong></p> <p>node1.baiqi.cn执行以下命令创建软连接</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>sudo ln -s /usr/local/es/node-v8.1.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js /usr/local/bin/npm
sudo ln -s /usr/local/es/node-v8.1.0-linux-x64/bin/node /usr/local/bin/node
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>​</p> <p><strong>1.3  修改环境变量</strong></p> <p>node1.baiqi.cn服务器添加环境变量</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>vi /etc/profile
export NODE_HOME=/usr/local/es/node-v8.1.0-linux-x64
export PATH=:$PATH:$NODE_HOME/bin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>​</p> <p>修改完环境变量使用source生效</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>source /etc/profile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>1.4  验证安装成功</strong></p> <p>node1.baiqi.cn执行以下命令验证安装生效</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>node -v
npm -v
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>2</strong> <strong>本地安装</strong></p> <p><strong>2</strong>**.1  上传压缩包到/usr/local/es路径下去**</p> <p>将我们的压缩包 elasticsearch-head-compile-after.tar.gz  上传到服务器的/usr/local/es 路径下面去</p> <p><strong>2</strong>**.2  解压安装包**</p> <p>在服务器中执行以下命令解压安装包</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/es/
tar -zxvf elasticsearch-head-compile-after.tar.gz -C /usr/local/es/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>2</strong>**.3**  node1.baiqi.cn<strong>机器修改Gruntfile.js</strong></p> <p>修改Gruntfile.js这个文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/es/elasticsearch-head
vim Gruntfile.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>找到代码中的93行：hostname: '192.168.100.100', 修改为：node1.baiqi.cn</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>connect: {                       
 server: {                             
 options: {                                    
 hostname: 'node1.baiqi.cn',                                    
 port: 9100,                                    
 base: '.',                                    
 keepalive: true                              
  }                       
 }               
 }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>2.4</strong> <strong>node1机器修改app.js</strong></p> <p>第一台机器修改app.js</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/es/elasticsearch-head/_site
vim app.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>在Vim中输入「:4354」，定位到第4354行，修改 http://localhost:9200为http://node1.baiqi.cn:9200
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>2.5</strong> <strong>启动head服务</strong></p> <p>node1.baiqi.cn启动elasticsearch-head插件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/es/elasticsearch-head/node_modules/grunt/bin/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>进程前台启动命令</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>./grunt server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>进程后台启动命令</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup ./grunt server &gt;/dev/null 2&gt;&amp;1 &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>Running &quot;connect:server&quot; (connect) taskWaiting forever...Started connect web server on http://192.168.52.100:9100
如何停止：elasticsearch-head进程
执行以下命令找到elasticsearch-head的插件进程，然后使用kill  -9  杀死进程即可
netstat -nltp | grep 9100
kill -9 8328
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/22.jpg" alt=""></p> <p><strong>2.6</strong> <strong>访问elasticsearch-head界面</strong></p> <p>打开Google Chrome访问</p> <p><a href="http://node1.baiqi.cn:9100/" target="_blank" rel="noopener noreferrer"><em>http://ip:9100/</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>注意：搭建es集群，启动三个es节点，访问elasticsearch-head时只显示一个master</p> <p>解决方案：进到节点2、3的/elasticsearch-7.6.1/data/目录下删除nodes文件，之后重启节点2、3的es进程即可</p> <blockquote><p>PS：也可以浏览器插件方式安装，从Chrome网上应用商店安装 Elasticsearch Head</p></blockquote> <blockquote><p>Green：所有Primary和Replica均为active，集群健康</p> <p>Yellow：至少一个Replica不可用，但是所有Primary均为active，数据仍然是可以保证完整性的。</p> <p>Red：至少有一个Primary为不可用状态，数据不完整，集群不可用。</p></blockquote> <h3 id="beats"><a href="#beats" class="header-anchor">#</a> Beats</h3> <p>Beats是一个开放源代码的数据发送器。我们可以把Beats作为一种代理安装在我们的服务器上，这样就可以比较方便地将数据发送到Elasticsearch或者Logstash中。Elastic Stack提供了多种类型的Beats组件。</p> <table><thead><tr><th>审计数据</th> <th>AuditBeat</th></tr></thead> <tbody><tr><td>日志文件</td> <td>FileBeat</td></tr> <tr><td>云数据</td> <td>FunctionBeat</td></tr> <tr><td>可用性数据</td> <td>HeartBeat</td></tr> <tr><td>系统日志</td> <td>JournalBeat</td></tr> <tr><td>指标数据</td> <td>MetricBeat</td></tr> <tr><td>网络流量数据</td> <td>PacketBeat</td></tr> <tr><td>Windows事件日志</td> <td>Winlogbeat</td></tr></tbody></table> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/80.png" alt=""></p> <p>Beats可以直接将数据发送到Elasticsearch或者发送到Logstash，基于Logstash可以进一步地对数据进行处理，然后将处理后的数据存入到Elasticsearch，最后使用Kibana进行数据可视化。</p> <p><strong>1、FileBeat简介</strong></p> <p>FileBeat专门用于转发和收集日志数据的轻量级采集工具。它可以为作为代理安装在服务器上，FileBeat监视指定路径的日志文件，收集日志数据，并将收集到的日志转发到Elasticsearch或者Logstash。</p> <p><strong>2、FileBeat的工作原理</strong></p> <p>启动FileBeat时，会启动一个或者多个输入（Input），这些Input监控指定的日志数据位置。FileBeat会针对每一个文件启动一个Harvester（收割机）。Harvester读取每一个文件的日志，将新的日志发送到libbeat，libbeat将数据收集到一起，并将数据发送给输出（Output）。</p> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/81.png" alt=""></p> <p><strong>3、安装FileBeat</strong></p> <p>安装FileBeat只需要将FileBeat Linux安装包上传到Linux系统，并将压缩包解压到系统就可以了。</p> <p>FileBeat官方下载地址：</p> <p>https://www.elastic.co/cn/downloads/past-releases/filebeat-7-6-1</p> <p>上传FileBeat安装到Linux，并解压。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>tar -xvzf filebeat-7.6.1-linux-x86_64.tar.gz -C /usr/local/es/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>4、使用FileBeat采集MQ日志到Elasticsearch</strong></p> <p><strong>4.1、需求分析</strong></p> <p>在资料中有一个mq_server.log.tar.gz压缩包，里面包含了很多的MQ服务器日志，现在我们为了通过在Elasticsearch中快速查询这些日志，定位问题。我们需要用FileBeats将日志数据上传到Elasticsearch中。</p> <p>问题：</p> <p>首先，我们要指定FileBeat采集哪些MQ日志，因为FileBeats中必须知道采集存放在哪儿的日志，才能进行采集。</p> <p>其次，采集到这些数据后，还需要指定FileBeats将采集到的日志输出到Elasticsearch，那么Elasticsearch的地址也必须指定。</p> <p><strong>4.2、配置FileBeats</strong></p> <p>FileBeats配置文件主要分为两个部分。</p> <ol><li><p>inputs</p></li> <li><p>output</p></li></ol> <p>从名字就能看出来，一个是用来输入数据的，一个是用来输出数据的。</p> <p><strong>4.2.1、input配置</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/*.log
    #- c:\programdata\elasticsearch\logs\*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在FileBeats中，可以读取一个或多个数据源。</p> <p><strong>FileBeats配置文件 - input</strong></p> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/82.png" alt=""></p> <p><strong>4.2.2、output配置</strong></p> <p><strong>FileBeat配置文件 - output</strong></p> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/83.png" alt=""></p> <p>默认FileBeat会将日志数据放入到名称为：filebeat-%filebeat版本号%-yyyy.MM.dd 的索引中。</p> <p>PS：</p> <p>FileBeats中的filebeat.reference.yml包含了FileBeats所有支持的配置选项。</p> <p><strong>4.3、配置文件</strong></p> <ol><li>创建配置文件</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/es/filebeat-7.6.1-linux-x86_64
touch filebeat_mq_log.yml
vim filebeat_mq_log.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li>复制以下到配置文件中</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/mq/log/server.log.*

output.elasticsearch:
    hosts: [&quot;192.168.21.130:9200&quot;, &quot;192.168.21.131:9200&quot;, &quot;192.168.21.132:9200&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>4.4、运行FileBeat</strong></p> <ol><li>启动Elasticsearch</li></ol> <p>在每个节点上执行以下命令，启动Elasticsearch集群：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup /usr/local/es/elasticsearch-7.6.1/bin/elasticsearch 2&gt;&amp;1 &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>运行FileBeat</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>./filebeat -c filebeat_mq_log.yml -e
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>将日志数据上传到/var/mq/log，并解压</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir -p /var/mq/log
cd /var/mq/log
tar -zxvf mq_server.log.tar.gz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>4.5、查询数据</strong></p> <p>通过head插件，我们可以看到filebeat采集了日志消息，并写入到Elasticsearch集群中。</p> <p><strong>五、FileBeat是如何工作的</strong></p> <p>FileBeat主要由input和harvesters（收割机）组成。这两个组件协同工作，并将数据发送到指定的输出。</p> <p><strong>1、input和harvester</strong></p> <p><strong>1.1、inputs（输入）</strong></p> <p>input是负责管理Harvesters和查找所有要读取的文件的组件</p> <p>如果输入类型是 log，input组件会查找磁盘上与路径描述的所有文件，并为每个文件启动一个Harvester，每个输入都独立地运行</p> <p><strong>1.2、Harvesters（收割机）</strong></p> <p>Harvesters负责读取单个文件的内容，它负责打开/关闭文件，并逐行读取每个文件的内容，将读取到的内容发送给输出</p> <p>每个文件都会启动一个Harvester</p> <p>Harvester运行时，文件将处于打开状态。如果文件在读取时，被移除或者重命名，FileBeat将继续读取该文件</p> <p><strong>2、FileBeats如何保持文件状态</strong></p> <p>FileBeat保存每个文件的状态，并定时将状态信息保存在磁盘的「注册表」文件中</p> <p>该状态记录Harvester读取的最后一次偏移量，并确保发送所有的日志数据</p> <p>如果输出（Elasticsearch或者Logstash）无法访问，FileBeat会记录成功发送的最后一行，并在输出（Elasticsearch或者Logstash）可用时，继续读取文件发送数据</p> <p>在运行FileBeat时，每个input的状态信息也会保存在内存中，重新启动FileBeat时，会从「注册表」文件中读取数据来重新构建状态。</p> <p>'</p> <p>在/usr/local/es/filebeat-7.6.1-linux-x86_64/data目录中有一个Registry文件夹，里面有一个data.json，该文件中记录了Harvester读取日志的offset。</p> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/85.png" alt=""></p> <h3 id="logstash"><a href="#logstash" class="header-anchor">#</a> Logstash</h3> <p><strong>1、简介</strong></p> <p>Logstash是一个开源的数据采集引擎。它可以动态地将不同来源的数据统一采集，并按照指定的数据格式进行处理后，将数据加载到其他的目的地。最开始，Logstash主要是针对日志采集，但后来Logstash开发了大量丰富的插件，所以，它可以做更多的海量数据的采集。</p> <p>它可以处理各种类型的日志数据，例如：Apache的web log、Java的log4j日志数据，或者是系统、网络、防火墙的日志等等。它也可以很容易的和Elastic Stack的Beats组件整合，也可以很方便的和关系型数据库、NoSQL数据库、MQ等整合。</p> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/86.jpeg" alt=""></p> <p><strong>1.1  经典架构</strong></p> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/88.png" alt=""></p> <p><strong>1.2  对比FileBeat</strong></p> <p>logstash是jvm跑的，资源消耗比较大</p> <p>而FileBeat是基于golang编写的，功能较少但资源消耗也比较小，更轻量级</p> <p>logstash 和filebeat都具有日志收集功能，Filebeat更轻量，占用资源更少</p> <p>logstash 具有filter功能，能过滤分析日志</p> <p>一般结构都是filebeat采集日志，然后发送到消息队列，redis，MQ中然后logstash去获取，利用filter功能过滤分析，然后存储到elasticsearch中</p> <p>FileBeat和Logstash配合，实现背压机制</p> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/89.jpeg" alt=""></p> <p><strong>2  安装Logstash和Kibana</strong></p> <p><strong>2.1  安装Logstash</strong></p> <p>\1. 下载Logstash</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>https://www.elastic.co/cn/downloads/past-releases/logstash-7-6-1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此处：我们可以选择资料中的logstash-7.6.1.zip安装包。</p> <p>\2. 解压Logstash到指定目录</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>unzip logstash-7.6.1 -d /usr/local/es/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>\3. 运行测试</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /usr/local/es/logstash-7.6.1/
bin/logstash -e 'input { stdin { } } output { stdout {} }'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>等待一会，让Logstash启动完毕。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Sending Logstash logs to /usr/local/es/logstash-7.6.1/logs which is now configured via log4j2.properties
[2021-02-28T16:31:44,159][WARN ][logstash.config.source.multilocal] Ignoring the 'pipelines.yml' file because modules or command line options are specified
[2021-02-28T16:31:44,264][INFO ][logstash.runner          ] Starting Logstash {&quot;logstash.version&quot;=&gt;&quot;7.6.1&quot;}
[2021-02-28T16:31:45,631][INFO ][org.reflections.Reflections] Reflections took 37 ms to scan 1 urls, producing 20 keys and 40 values 
[2021-02-28T16:31:46,532][WARN ][org.logstash.instrument.metrics.gauge.LazyDelegatingGauge][main] A gauge metric of an unknown type (org.jruby.RubyArray) has been create for key: cluster_uuids. This may result in invalid serialization.  It is recommended to log an issue to the responsible developer/development team.
[2021-02-28T16:31:46,560][INFO ][logstash.javapipeline    ][main] Starting pipeline {:pipeline_id=&gt;&quot;main&quot;, &quot;pipeline.workers&quot;=&gt;2, &quot;pipeline.batch.size&quot;=&gt;125, &quot;pipeline.batch.delay&quot;=&gt;50, &quot;pipeline.max_inflight&quot;=&gt;250, &quot;pipeline.sources&quot;=&gt;[&quot;config string&quot;], :thread=&gt;&quot;#&lt;Thread:0x3ccbc15b run&gt;&quot;}
[2021-02-28T16:31:47,268][INFO ][logstash.javapipeline    ][main] Pipeline started {&quot;pipeline.id&quot;=&gt;&quot;main&quot;}
The stdin plugin is now waiting for input:
[2021-02-28T16:31:47,348][INFO ][logstash.agent           ] Pipelines running {:count=&gt;1, :running_pipelines=&gt;[:main], :non_running_pipelines=&gt;[]}
[2021-02-28T16:31:47,550][INFO ][logstash.agent           ] Successfully started Logstash API endpoint {:port=&gt;9600}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>然后，随便在控制台中输入内容，等待Logstash的输出。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
&quot;host&quot; =&gt; &quot;127.0.0.1&quot;,
&quot;message&quot; =&gt; &quot;hello logstash&quot;,
&quot;@version&quot; =&gt; &quot;1&quot;,
&quot;@timestamp&quot; =&gt; 2021-02-28:01:01.007Z
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>-e选项表示，直接把配置放在命令中，这样可以有效快速进行测试</p></blockquote> <h2 id="_3-什么是全文检索"><a href="#_3-什么是全文检索" class="header-anchor">#</a> 3.什么是全文检索</h2> <p>全文检索是指：</p> <ul><li>通过一个程序扫描文本中的每一个单词，针对单词建立索引，并保存该单词在文本中的位置、以及出现的次数</li> <li>用户查询时，通过之前建立好的索引来查询，将索引中单词对应的文本位置、出现的次数返回给用户，因为有了具体文本的位置，所以就可以将具体内容读取出来了</li></ul> <h2 id="_4-倒排索引"><a href="#_4-倒排索引" class="header-anchor">#</a> 4.倒排索引</h2> <h3 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h3> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/image-20211025144456493.png" alt=""></p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/index.jpg" alt=""></p> <ul><li><strong>term</strong>：在 ES 中，关键词被称为term。</li> <li><strong>postings list</strong>: 文档列表，作为文档的唯一标识的，ES 会对这些存入的文档进行处理，转化成一个唯一的整型 id，每个文档被分配一个唯一的 id，从0到(2^31)-1。</li> <li><strong>term dictionary</strong>：如何快速的在海量 term 中查询到需要的 term 呢？遍历显然是不够的，于是乎就有了term dictionary，ES 为了能快速查找到 term，将所有的 term 排了一个序，<strong>二分法查找</strong>。是不是感觉有点眼熟，这不就是 MySQL 的索引方式的，直接用 B+树建立索引词典指向被索引的数据。</li> <li><strong>term index</strong>： 那问题又来了，Term Dictionary 应该放在哪里？肯定是放在内存里面吧？磁盘 io 那么慢。就像 MySQL 索引就是存在内存里面了。重点是 ES 默认可是会对全部 字段进行索引，必然会消耗巨大的内存，此时还能放内存吗？内存会爆。于是乎就有了term index 从数据结构上分类算是一个“Trie 树”，也就是我们常说的字典树（这是一种专门处理字符串匹配的数据结构，用来解决在一组字符串集合中快速查找某个字符串的问题）。这棵树不会包含所有的 term，它包含的是 term 的一些前缀（这也是字典树的使用场景，公共前缀）。通过 term index 可以快速地定位到 term  dictionary 的某个 offset，然后从这个位置再往后顺序查找。是不是想查字典，先查偏旁，在到这个偏旁的所有字，再到具体的字。</li></ul> <blockquote><p>ElasticSearch 的倒排排索，增加了最左边的一层「字典树」term index，它不存储所有的单词，只存储单词前缀，通过字典树找到单词所在的块，也就是单词的大概位置，再在块里二分查找，找到对应的单词，再找到单词对应的文档列表。</p></blockquote> <h3 id="核心算法"><a href="#核心算法" class="header-anchor">#</a> 核心算法</h3> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/image-20211025144514776.png" alt=""></p> <p>倒排表【postings list】的压缩算法</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FOR：Frame Of Reference
RBM：RoaringBitmap
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>词项索引【term index】的检索原理</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FST：Finit state Transducers
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>FOR算法</strong></p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/20211025154200.png" alt=""></p> <p><strong>RBM算法</strong></p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/20211025161443.png" alt=""></p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/fst1.jpg" alt=""></p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/fst2.jpg" alt=""></p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/fst3.jpg" alt=""></p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/fst4.jpg" alt=""></p> <p>倒排索引总结：</p> <p>索引就类似于目录，平时我们使用的都是索引，都是通过主键定位到某条数据，那么倒排索引呢，刚好相反，数据对应到主键。</p> <p>假如，我们有一个站内搜索的功能，通过某个关键词来搜索相关的文章，那么这个关键词可能出现在标题中，也可能出现在文章内容中，那我们将会在创建或修改文章的时候，建立一个关键词与文章的对应关系表，这种，我们可以称之为倒排索引,因此倒排索引，也可称之为反向索引．</p> <h3 id="倒排检索-vs-mysql-索引"><a href="#倒排检索-vs-mysql-索引" class="header-anchor">#</a> 倒排检索 VS MySQL 索引</h3> <p>Mysql只有term  dictionary这一层，是以b-tree排序的方式存储在磁盘上的。检索一个term需要若干次的random  access的磁盘操作。而Lucene在term dictionary的基础上添加了term index来加速检索，term  index以树的形式缓存在内存中。从term index查到对应的term  dictionary的block位置之后，再去磁盘上找term，大大减少了磁盘的random access次数。</p> <p>额外值得一提的两点是：term index在内存中是以FST（finite state transducers）的形式保存的，其特点是非常节省内存。Term  dictionary在磁盘上是以分block的方式保存的，一个block内部利用公共前缀压缩，比如都是Ab开头的单词就可以把Ab省去。这样term dictionary可以比b-tree更节约磁盘空间。</p> <h2 id="_5-elasticsearch中的核心概念"><a href="#_5-elasticsearch中的核心概念" class="header-anchor">#</a> 5.Elasticsearch中的核心概念</h2> <h3 id="数据类型"><a href="#数据类型" class="header-anchor">#</a> 数据类型</h3> <ul><li><p>1.常见类型:</p> <ul><li><p>数字类型：long	integer	short	byte	double	float	half_float	scaled_float   unsigned_long</p></li> <li><p><strong>Keywords</strong>：适用于索引结构化的字段，可以用于过滤、排序、聚合。keyword类型的字段只能通过精确值（exact value）搜索到。Id应该用keyword</p></li> <li><p>constant_keyword：始终包含相同值的关键字字段</p></li> <li><p>wildcard：可针对类似grep的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.10/query-dsl-wildcard-query.html" target="_blank" rel="noopener noreferrer">通配符查询<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>优化日志行和类似的关键字值。关键字字段通常用于排序，汇总和Term查询，例如<code>term</code>。</p></li> <li><p>Dates（时间类型）：包括<code>date</code>和 <code>date_nanos</code></p></li> <li><p>alias：为现有字段定义别名。</p></li> <li><p>binary（二进制）：binary</p></li> <li><p>range（区间类型）：integer_range、float_range、long_range、double_range、date_range</p></li> <li><p><strong>text</strong>：当一个字段是要被全文搜索的，比如Email内容、产品描述，这些字段应该使用text类型。设置text类型以后，字段内容会被分析，在生成倒排索		引以前，字符串会被分析器分成一个一个词项。text类型的字段不用于排序，很少用于聚合。（解释一下为啥不会为text创建正排索引：大量堆空间，尤其是在加载高基数text字段时。字段数据一旦加载到堆中，就在该段的生命周期内保持在那里。同样，加载字段数据是一个昂贵的过程，可能导致用户遇到延迟问题。这就是默认情况下禁用字段数据的原因）</p></li></ul></li> <li><p>2.对象关系类型：</p> <ul><li>object：用于单个JSON对象</li> <li>nested：用于JSON对象数组</li> <li>flattened：允许将整个JSON对象索引为单个字段。</li></ul></li> <li><p>3.结构化类型:</p> <ul><li>geo-point：纬度/经度积分</li> <li>geo-shape：用于多边形等复杂形状</li> <li>point：笛卡尔坐标点</li> <li>shape：笛卡尔任意几何图形</li></ul></li> <li><p>4.特殊类型：</p> <ul><li>IP地址：ip 用于IPv4和IPv6地址</li> <li>completion：提供自动完成建议</li> <li>tocken_count：计算字符串中令牌的数量</li> <li>murmur3：在索引时计算值的哈希并将其存储在索引中</li> <li>annotated-text：索引包含特殊标记的文本（通常用于标识命名实体）</li> <li>percolator：接受来自query-dsl的查询</li> <li>join：为同一索引内的文档定义父/子关系</li> <li>rank features：记录数字功能以提高查询时的点击率。</li> <li>dense vector：记录浮点值的密集向量。</li> <li>sparse vector：记录浮点值的稀疏向量。</li> <li>search-as-you-type：针对查询优化的文本字段，以实现按需输入的完成</li> <li>histogram：histogram 用于百分位数聚合的预聚合数值。</li> <li>constant keyword：keyword当所有文档都具有相同值时的情况的专业化。</li></ul></li> <li><p>5.array（数组）：在Elasticsearch中，数组不需要专用的字段数据类型。默认情况下，任何字段都可以包含零个或多个值，但是，数组中的所有值都必须具有相同的数据类型。</p></li> <li><p>6.新增：</p> <ul><li>date_nanos：date plus 纳秒</li> <li>features：</li></ul></li></ul> <h3 id="index-索引"><a href="#index-索引" class="header-anchor">#</a> index 索引</h3> <blockquote><p>类似于mysql数据库中的database</p></blockquote> <p>一个索引就是一个拥有几分相似特征的文档的集合。比如说，可以有一个客户数据的索引，另一个产品目录的索引，还有一个订单数据的索引</p> <p>一个索引由一个名字来标识（必须全部是小写字母的），并且当我们要对对应于这个索引中的文档进行索引、搜索、更新和删除的时候，都要使用到这个名字</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>- 创建索引：PUT /index?pretty
- 查询索引：GET _cat/indices?v
- 删除索引：DELETE /index?pretty
- 插入数据：
    PUT /index/_doc/id
    {
        Json数据
    }
- 修改数据
	- 全量替换 PUT 
	- 指定字段更新 POST
- 删除数据 DELETE /index/type/id
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="mapping-映射"><a href="#mapping-映射" class="header-anchor">#</a> mapping 映射</h3> <p><strong>ElasticSearch中的映射（Mapping）是定义文档及其包含的字段的存储和索引方式的过程</strong></p> <p>mapping是处理数据的方式和规则方面做一些限制，如某个字段的数据类型、默认值、分词器、是否被索引等等，这些都是映射里面可以设置的。</p> <p>ES中的mapping有点类似与RDB中“表结构”的概念，在MySQL中，表结构里包含了字段名称，字段的类型还有索引信息等。在Mapping里也包含了一些属性，比如字段名称、类型、字段使用的分词器、是否评分、是否创建索引等属性，并且在ES中一个字段可以有对个类型。分词器、评分等概念在后面的课程讲解。</p> <p>在关系数据库中，需要事先创建数据库，然后在该数据库下创建数据表，并创建表字段、类型、长度、主键等，最后才能基于表插入数据。</p> <p>而Elasticsearch中不需要定义Mapping映射（即关系型数据库的表、字段等），在文档写入Elasticsearch时，会根据文档字段自动识别类型，这种机制称之为<strong>动态映射</strong>。</p> <p><strong>静态映射</strong>是在Elasticsearch中也可以事先定义好映射，包含文档的各字段类型、分词器等，这种方式称之为静态映射。</p> <p>ES中映射可以分为动态映射和静态映射。</p> <h4 id="dynamic-field-mapping-动态映射或自动映射"><a href="#dynamic-field-mapping-动态映射或自动映射" class="header-anchor">#</a> Dynamic field mapping：（动态映射或自动映射）</h4> <ul><li><h4 id="整数-long"><a href="#整数-long" class="header-anchor">#</a> 整数				     =&gt;	long</h4></li> <li><h4 id="浮点数-float"><a href="#浮点数-float" class="header-anchor">#</a> 浮点数			     =&gt;	float</h4></li> <li><h4 id="true-false-boolean"><a href="#true-false-boolean" class="header-anchor">#</a> true || false	 =&gt;	boolean</h4></li> <li><h4 id="日期-date"><a href="#日期-date" class="header-anchor">#</a> 日期		             =&gt;	date</h4></li> <li><h4 id="数组-取决于数组中的第一个有效值"><a href="#数组-取决于数组中的第一个有效值" class="header-anchor">#</a> 数组                     =&gt;    取决于数组中的第一个有效值</h4></li> <li><h4 id="对象-object"><a href="#对象-object" class="header-anchor">#</a> 对象                     =&gt;    object</h4></li> <li><h4 id="字符串-如果不是数字和日期类型-那会被映射为text和keyword两个类型"><a href="#字符串-如果不是数字和日期类型-那会被映射为text和keyword两个类型" class="header-anchor">#</a> 字符串                 =&gt;    如果不是数字和日期类型，那会被映射为text和keyword两个类型</h4> <p>除了上述字段类型之外，其他类型都必须显示映射，也就是必须手工指定，因为其他类型ES无法自动识别。</p></li></ul> <p>动态映射 代码演示</p> <blockquote><p>删除原创建的索引</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DELETE /es_db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>创建索引</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /es_db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>创建文档(ES根据数据类型, 会自动创建映射)</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /es_db/_doc/1
{
&quot;name&quot;: &quot;Jack&quot;,
&quot;sex&quot;: 1,
&quot;age&quot;: 25,
&quot;book&quot;: &quot;java入门至精通&quot;,
&quot;address&quot;: &quot;广州小蛮腰&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>获取文档映射</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_mapping			
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></blockquote> <h4 id="expllcit-field-mapping-手动映射-静态映射或手工映射或显示映射"><a href="#expllcit-field-mapping-手动映射-静态映射或手工映射或显示映射" class="header-anchor">#</a> Expllcit field mapping：手动映射/（静态映射或手工映射或显示映射）</h4> <blockquote><p>格式：
PUT /product
{
&quot;mappings&quot;: {
&quot;properties&quot;: {
&quot;field&quot;: {
&quot;mapping_parameter&quot;: &quot;parameter_value&quot;
}
}
}
}</p></blockquote> <p>静态映射 代码演示：</p> <blockquote><p>删除原创建的索引</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DELETE /es_db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>创建索引</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /es_db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>设置文档映射</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /es_db
{
&quot;mappings&quot;:{
&quot;properties&quot;:{
&quot;name&quot;:{&quot;type&quot;:&quot;keyword&quot;,&quot;index&quot;:true,&quot;store&quot;:true},
&quot;sex&quot;:{&quot;type&quot;:&quot;integer&quot;,&quot;index&quot;:true,&quot;store&quot;:true},
&quot;age&quot;:{&quot;type&quot;:&quot;integer&quot;,&quot;index&quot;:true,&quot;store&quot;:true},
&quot;book&quot;:{&quot;type&quot;:&quot;text&quot;,&quot;index&quot;:true,&quot;store&quot;:true},
&quot;address&quot;:{&quot;type&quot;:&quot;text&quot;,&quot;index&quot;:true,&quot;store&quot;:true}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>根据静态映射创建文档</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /es_db/_doc/1
{
&quot;name&quot;: &quot;Jack&quot;,
&quot;sex&quot;: 1,
&quot;age&quot;: 25,
&quot;book&quot;: &quot;elasticSearch入门至精通&quot;,
&quot;address&quot;: &quot;广州车陂&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>获取文档映射</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_mapping				
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></blockquote> <h4 id="映射参数"><a href="#映射参数" class="header-anchor">#</a> 映射参数</h4> <p>​	<strong>①</strong> <strong>index：是否对创建对当前字段创建倒排索引，默认true，如果不创建索引，该字段不会通过索引被搜索到,但是仍然会在source元数据中展示</strong></p> <p>​	② <strong>analyzer：指定分析器（character filter、tokenizer、Token filters）。</strong></p> <p>​	③ boost：对当前字段相关度的评分权重，默认1</p> <p>​	④ coerce：是否允许强制类型转换  true “1”=&gt; 1  false “1”=&lt; 1</p> <p>​	⑤ copy_to：该参数允许将多个字段的值复制到组字段中，然后可以将其作为单个字段进行查询</p> <p>​	<strong>⑥</strong> <strong>doc_values：为了提升排序和聚合效率，默认true，如果确定不需要对字段进行排序或聚合，也不需要通过脚本访问字段值，则可以禁用doc值以节省磁盘		空间（不支持text和annotated_text）</strong></p> <p>​	⑦ dynamic：控制是否可以动态添加新字段</p> <p>​		1) true 新检测到的字段将添加到映射中。（默认）</p> <p>​		2) false 新检测到的字段将被忽略。这些字段将不会被索引，因此将无法搜索，但仍会出现在_source返回的匹配项中。这些字段不会添加到映射中，必须显式			添加新字段。</p> <p>​		3) strict 如果检测到新字段，则会引发异常并拒绝文档。必须将新字段显式添加到映射中</p> <p>​	<strong>⑧</strong> <strong>eager_global_ordinals：用于聚合的字段上，优化聚合性能。</strong></p> <p>​		1) Frozen indices（冻结索引）：有些索引使用率很高，会被保存在内存中，有些使用率特别低，宁愿在使用的时候重新创建，在使用完毕后丢弃数据，			Frozen indices的数据命中频率小，不适用于高搜索负载，数据不会被保存在内存中，堆空间占用比普通索引少得多，Frozen indices是只读的，请求可能			是秒级或者分钟级。****eager_global_ordinals不适用于Frozen indices****</p> <p>​	⑨ <strong>enable：是否创建倒排索引，可以对字段操作，也可以对索引操作，如果不创建索引，让然可以检索并在_source元数据中展示，谨慎使用，该状态无法		修改。</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>    PUT my_index
    {
      &quot;mappings&quot;: {
        &quot;enabled&quot;: false
      }
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>​	<strong>⑩</strong> <strong>fielddata：查询时内存数据结构，在首次用当前字段聚合、排序或者在脚本中使用时，需要字段为fielddata数据结构，并且创建倒排索引保存到堆中</strong></p> <p>​	<strong>⑪</strong> <strong>fields：给field创建多字段，用于不同目的（全文检索或者聚合分析排序）</strong></p> <p>​	⑫ format：格式化</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  &quot;date&quot;: {
     &quot;type&quot;:  &quot;date&quot;,
     &quot;format&quot;: &quot;yyyy-MM-dd&quot;
   }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>​	⑬ ignore_above：超过长度将被忽略</p> <p>​	⑭ ignore_malformed：忽略类型错误</p> <p>​	⑮ index_options：控制将哪些信息添加到反向索引中以进行搜索和突出显示。仅用于text字段</p> <p>​	⑯ Index_phrases：提升exact_value查询速度，但是要消耗更多磁盘空间</p> <p>​	⑰ Index_prefixes：前缀搜索</p> <p>​		1) min_chars：前缀最小长度，&gt;0，默认2（包含）</p> <p>​		2) max_chars：前缀最大长度，&lt;20，默认5（包含）</p> <p>​	⑱ meta：附加元数据</p> <p>​	⑲ normalizer：</p> <p>​	<strong>⑳ norms：是否禁用评分（在filter和聚合字段上应该禁用）。</strong></p> <p>​	<strong>21 null_value：为null值设置默认值</strong></p> <p>​	22 position_increment_gap：</p> <p>​	23 proterties：除了mapping还可用于object的属性设置</p> <p>​	<strong>24 search_analyzer：设置单独的查询时分析器：</strong></p> <p>​	25 similarity：为字段设置相关度算法，支持BM25、claassic（TF-IDF）、boolean</p> <p>​	<strong>26 store：设置字段是否仅查询</strong></p> <p>​	**27 term_vector：**运维参数</p> <h4 id="对已存在的mapping映射进行修改"><a href="#对已存在的mapping映射进行修改" class="header-anchor">#</a> 对已存在的mapping映射进行修改</h4> <p>具体方法：</p> <ol><li>如果要推倒现有的映射, 你得重新建立一个静态索引</li> <li>然后把之前索引里的数据导入到新的索引里</li> <li>删除原创建的索引</li> <li>为新索引起个别名, 为原索引名</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST _reindex
{
&quot;source&quot;: {
&quot;index&quot;: &quot;db_index&quot;
},
&quot;dest&quot;: {
&quot;index&quot;: &quot;db_index_2&quot;
}
}

DELETE /db_index

PUT /db_index_2/_alias/db_index
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>注意: 通过这几个步骤就实现了索引的平滑过渡,并且是零停机</strong></p> <h3 id="field-字段"><a href="#field-字段" class="header-anchor">#</a> Field 字段</h3> <p>相当于是数据表的字段|列</p> <h3 id="type-字段类型"><a href="#type-字段类型" class="header-anchor">#</a> Type 字段类型</h3> <blockquote><p>类似于mysql数据库中的table表，es中可以在Index中建立type（table），通过mapping进行映射。</p></blockquote> <p>每一个字段都应该有一个对应的类型，例如：Text、Keyword、Byte等</p> <h3 id="document-文档"><a href="#document-文档" class="header-anchor">#</a> document 文档</h3> <blockquote><p>由于es存储的数据是文档型的，一条数据对应一篇文档即相当于mysql数据库中的一行数据row，一个文档中可以有多个字段也就是mysql数据库一行可以有多列。</p></blockquote> <p>一个文档是一个可被索引的基础信息单元，类似一条记录。文档以JSON（Javascript Object Notation）格式来表示；</p> <h3 id="集群-cluster"><a href="#集群-cluster" class="header-anchor">#</a> 集群 cluster</h3> <p>一个集群就是由一个或多个节点组织在一起，它们共同持有整个的数据，并一起提供索引和搜索功能</p> <h3 id="节点-node"><a href="#节点-node" class="header-anchor">#</a> 节点 node</h3> <p>一个节点是集群中的一个服务器，作为集群的一部分，它存储数据，参与集群的索引和搜索功能</p> <p>一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点都会被安排加入到一个叫做“elasticsearch”的集群中</p> <p>这意味着，如果在网络中启动了若干个节点，并假定它们能够相互发现彼此，它们将会自动地形成并加入到一个叫做“elasticsearch”的集群中</p> <p>在一个集群里，可以拥有任意多个节点。而且，如果当前网络中没有运行任何Elasticsearch节点，这时启动一个节点，会默认创建并加入一个叫做“elasticsearch”的集群。</p> <h3 id="分片和副本-shards-replicas"><a href="#分片和副本-shards-replicas" class="header-anchor">#</a> 分片和副本 shards&amp;replicas</h3> <p><strong>分片</strong></p> <ul><li><p>一个索引可以存储超出单个结点硬件限制的大量数据。比如，一个具有10亿文档的索引占据1TB的磁盘空间，而任一节点都没有这样大的磁盘空间；或者单个节点处理搜索请求，响应太慢</p></li> <li><p>为了解决这个问题，Elasticsearch提供了将索引划分成多份的能力，这些份就叫做分片</p></li> <li><p>当创建一个索引的时候，可以指定你想要的分片的数量</p></li> <li><p>每个分片本身也是一个功能完善并且独立的“索引”，这个“索引”可以被放置到集群中的任何节点上</p></li> <li><p>分片很重要，主要有两方面的原因</p> <ul><li>允许水平分割/扩展你的内容容量</li> <li>允许在分片之上进行分布式的、并行的操作，进而提高性能/吞吐量</li></ul></li> <li><p>至于一个分片怎样分布，它的文档怎样聚合回搜索请求，是完全由Elasticsearch管理的，对于作为用户来说，这些都是透明的</p></li></ul> <p><strong>副本</strong></p> <ul><li><p>在一个网络/云的环境里，失败随时都可能发生，在某个分片/节点不知怎么的就处于离线状态，或者由于任何原因消失了，这种情况下，有一个故障转移机制是非常有用并且是强烈推荐的。为此目的，Elasticsearch允许你创建分片的一份或多份拷贝，这些拷贝叫做副本分片，或者直接叫副本</p></li> <li><p>副本之所以重要，有两个主要原因</p> <ul><li>在分片/节点失败的情况下，提供了高可用性。注意到复制分片从不与原/主要（original/primary）分片置于同一节点上是非常重要的</li> <li>扩展搜索量/吞吐量，因为搜索可以在所有的副本上并行运行；每个索引可以被分成多个分片；一个索引有0个或者多个副本；一旦设置了副本，每个索引就有了主分片和副本分片，分片和副本的数量可以在索引；创建的时候指定；在索引创建之后，可以在任何时候动态地改变副本的数量，但是不能改变分片的数量。</li></ul></li></ul> <h2 id="_6-query-dsl-domain-specific-language"><a href="#_6-query-dsl-domain-specific-language" class="header-anchor">#</a> 6.Query DSL(Domain Specific Language)</h2> <h3 id="_6-1-查询上下文"><a href="#_6-1-查询上下文" class="header-anchor">#</a> 6.1 查询上下文</h3> <p>使用query关键字进行检索，倾向于相关度搜索，故需要计算评分。搜索是Elasticsearch最关键和重要的部分。</p> <h3 id="_6-2-相关度评分-score"><a href="#_6-2-相关度评分-score" class="header-anchor">#</a> 6.2 相关度评分：_score</h3> <p>概念：相关度评分用于对搜索结果排序，评分越高则认为其结果和搜索的预期值相关度越高，即越符合搜索预期值。在7.x之前相关度评分默认使用TF/IDF算法计算而来，7.x之后默认为BM25。在核心知识篇不必关心相关评分的具体原理，只需知晓其概念即可。</p> <p>排序：相关度评分为搜索结果的排序依据，默认情况下评分越高，则结果越靠前。</p> <h3 id="_6-3-元数据-source"><a href="#_6-3-元数据-source" class="header-anchor">#</a> 6.3 元数据：_source</h3> <ol><li><p>禁用_source：</p> <ul><li><p>好处：节省存储开销</p></li> <li><p>坏处：</p> <ul><li>不支持update、update_by_query和reindex API。</li> <li>不支持高亮。</li> <li>不支持reindex、更改mapping分析器和版本升级。</li> <li>通过查看索引时使用的原始文档来调试查询或聚合的功能。</li> <li>将来有可能自动修复索引损坏。</li></ul></li></ul> <blockquote><p>总结：如果只是为了节省磁盘，可以压缩索引比禁用_source更好。</p></blockquote></li> <li><p>数据源过滤器：</p> <p><strong>Including：结果中返回哪些field</strong></p> <p><strong>Excluding：结果中不要返回哪些field，不返回的field不代表不能通过该字段进行检索，因为元数据不存在不代表索引不存在</strong></p> <ol><li><p>在mapping中定义过滤：支持通配符，但是这种方式不推荐，因为mapping不可变</p> <div class="language-console line-numbers-mode"><pre class="language-text"><code>PUT product
{
  &quot;mappings&quot;: {
    &quot;_source&quot;: {
      &quot;includes&quot;: [
        &quot;name&quot;,
        &quot;price&quot;
      ],
      &quot;excludes&quot;: [
        &quot;desc&quot;,
        &quot;tags&quot;
      ]
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li> <li><p>常用过滤规则</p> <ul><li>&quot;_source&quot;: &quot;false&quot;,</li> <li>&quot;_source&quot;: &quot;obj.*&quot;,</li> <li>&quot;_source&quot;: [ &quot;obj1.*&quot;, &quot;obj2.*&quot; ],</li> <li>&quot;_source&quot;: {
&quot;includes&quot;: [ &quot;obj1.*&quot;, &quot;obj2.*&quot; ],
&quot;excludes&quot;: [ &quot;*.description&quot; ]
}</li></ul></li></ol></li></ol> <h3 id="_6-4-query-string"><a href="#_6-4-query-string" class="header-anchor">#</a> 6.4 Query String</h3> <p><strong>查询所有：</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /product/_search
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>带参数：</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /product/_search?q=name:xiaomi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>分页：</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /product/_search?from=0&amp;size=2&amp;sort=price:asc
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>精准匹配 exact value</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /product/_search?q=date:2021-06-01
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>_all搜索 相当于在所有有索引的字段中检索</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /product/_search?q=2021-06-01
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>DELETE product
# 验证_all搜索
PUT product
{
  &quot;mappings&quot;: {
    &quot;properties&quot;: {
      &quot;desc&quot;: {
        &quot;type&quot;: &quot;text&quot;, 
        &quot;index&quot;: false
      }
    }
  }
}
# 先初始化数据
POST /product/_update/5
{
  &quot;doc&quot;: {
    &quot;desc&quot;: &quot;erji zhong de kendeji 2021-06-01&quot;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_6-5-全文检索-full-text-query"><a href="#_6-5-全文检索-full-text-query" class="header-anchor">#</a> 6.5 全文检索-Full text query</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET index/_search
{
  &quot;query&quot;: {
    ***
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>match</strong>：匹配包含某个term的子句</p> <p><strong>match_all</strong>：匹配所有结果的子句</p> <p><strong>multi_match</strong>：多字段条件</p> <p><strong>match_phrase</strong>：短语查询，</p> <h3 id="_6-6-精准查询-term-query"><a href="#_6-6-精准查询-term-query" class="header-anchor">#</a> 6.6 精准查询-Term query</h3> <ul><li><h4 id="term-匹配和搜索词项完全相等的结果"><a href="#term-匹配和搜索词项完全相等的结果" class="header-anchor">#</a> term：匹配和搜索词项完全相等的结果</h4> <ul><li><p>term和match_phrase区别:</p> <blockquote><p>match_phrase 会将检索关键词分词, match_phrase的分词结果必须在被检索字段的分词中都包含，而且顺序必须相同，而且默认必须都是连续的</p></blockquote></li></ul></li></ul> <blockquote><p>term搜索不会将搜索词分词</p></blockquote> <ul><li><p>term和keyword区别</p> <blockquote><p>term是对于搜索词不分词,</p></blockquote></li></ul> <blockquote><p>keyword是字段类型,是对于source data中的字段值不分词</p></blockquote> <ul><li><h4 id="terms-匹配和搜索词项列表中任意项匹配的结果"><a href="#terms-匹配和搜索词项列表中任意项匹配的结果" class="header-anchor">#</a> terms：匹配和搜索词项列表中任意项匹配的结果</h4></li> <li><h4 id="range-范围查找"><a href="#range-范围查找" class="header-anchor">#</a> range：范围查找</h4></li></ul> <h3 id="_6-7-过滤器-filter"><a href="#_6-7-过滤器-filter" class="header-anchor">#</a> 6.7 过滤器-Filter</h3> <div class="language-console line-numbers-mode"><pre class="language-text"><code>GET _search
{
  &quot;query&quot;: {
    &quot;constant_score&quot;: {
      &quot;filter&quot;: {
        &quot;term&quot;: {
          &quot;status&quot;: &quot;active&quot;
        }
      }
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>query和filter的主要区别:</strong></p> <blockquote><p>filter是结果导向的而query是过程导向。query倾向于“当前文档和查询的语句的相关度”，而filter倾向于“当前文档和查询的条件是不是相符”。</p> <p>即在查询过程中，query是要对查询的每个结果计算相关性得分的，而filter不会。</p> <p>另外filter有相应的缓存机制，可以提高查询效率。</p></blockquote> <h3 id="_6-8-组合查询-bool-query"><a href="#_6-8-组合查询-bool-query" class="header-anchor">#</a> 6.8 组合查询-Bool query</h3> <p><strong>bool</strong>：可以组合多个查询条件，bool查询也是采用more_matches_is_better的机制，因此满足must和should子句的文档将会合并起来计算分值</p> <ul><li><strong>must</strong>：必须满足子句（查询）必须出现在匹配的文档中，并将有助于得分。</li> <li><strong>filter</strong>：过滤器 不计算相关度分数，cache子句（查询）必须出现在匹配的文档中。但是不像 must查询的分数将被忽略。Filter子句在 filter上下文 中执行，这意味着计分被忽略，并且子句被考虑用于缓存。</li> <li><strong>should</strong>：可能满足 or子句（查询）应出现在匹配的文档中。</li> <li><strong>must_not</strong>：必须不满足 不计算相关度分数  not子句（查询）不得出现在匹配的文档中。子句在 过滤器上下文 中执行，这意味着计分被忽略，并且子句被视为用于缓存。由于忽略计分，因此将返回所有文档的分数。</li></ul> <p><strong>minimum_should_match</strong>：参数指定should返回的文档必须匹配的子句的数量或百分比。如果bool查询包含至少一个should子句，而没有must或 filter子句，则默认值为1。否则，默认值为0。</p> <h3 id="_6-9-聚合查询"><a href="#_6-9-聚合查询" class="header-anchor">#</a> 6.9 聚合查询</h3> <p><strong>概念</strong></p> <p>聚合（aggs）不同于普通查询，是目前学到的第二种大的查询分类，第一种即“query”，因此在代码中的第一层嵌套由“query”变为了“aggs”。<strong>用于进行聚合的字段必须是exact value，分词字段不可进行聚合</strong>，对于text字段如果需要使用聚合，需要开启fielddata，但是通常不建议，因为fielddata是将聚合使用的数据结构由磁盘（doc_values）变为了堆内存（field_data），大数据的聚合操作很容易导致OOM，详细原理会在进阶篇中阐述。</p> <p><strong>分类</strong></p> <ol><li>分桶聚合（Bucket agregations）：类比SQL中的group by的作用，主要用于统计不同类型数据的数量</li> <li>指标聚合（Metrics agregations）：主要用于最大值、最小值、平均值、字段之和等指标的统计</li> <li>管道聚合（Pipeline agregations）：用于对聚合的结果进行二次聚合，如要统计绑定数量最多的标签bucket，就是要先按照标签进行分桶，再在分桶的结果上计算最大值。</li></ol> <p><strong>语法</strong></p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;&lt;aggs_name&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;&lt;agg_type&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;field_name&gt;&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

aggs_name：聚合函数的名称
agg_type：聚合种类，比如是桶聚合（terms）或者是指标聚合（avg、sum、min、max等）
field_name：字段名称或者叫域名。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="桶聚合"><a href="#桶聚合" class="header-anchor">#</a> 桶聚合</h4> <p>场景：用于统计不同种类的文档的数量，可进行嵌套统计。</p> <p>函数：terms</p> <p>注意：聚合字段必须是exact value，如keyword</p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/image-20211026152151544.png" alt=""></p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/image-20211026152304947.png" alt=""></p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/image-20211026152315266.png" alt=""></p> <h4 id="指标聚合"><a href="#指标聚合" class="header-anchor">#</a> 指标聚合</h4> <p>场景：用于统计某个指标，如最大值、最小值、平均值，可以结合桶聚合一起使用，如按照商品类型分桶，统计每个桶的平均价格。</p> <p>函数：平均值：Avg、最大值：Max、最小值：Min、求和：Sum、详细信息：Stats、数量：Value count</p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/image-20211026152337653.png" alt=""></p> <h4 id="管道聚合"><a href="#管道聚合" class="header-anchor">#</a> 管道聚合</h4> <p>场景：用于对聚合查询的二次聚合，如统计平均价格最低的商品分类，即先按照商品分类进行桶聚合，并计算其平均价格，然后对其平均价格计算最小值聚合</p> <p>函数：Min bucket：最小桶、Max bucket：最大桶、Avg bucket：桶平均值、Sum bucket：桶求和、Stats bucket：桶信息</p> <p>注意：buckets_path为管道聚合的关键字，其值从当前聚合统计的聚合函数开始计算为第一级。比如下面例子中，my_aggs和my_min_bucket同级，my_aggs就是buckets_path值的起始值。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;my_aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        ...
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;my_price_bucket&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          ...
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;my_min_bucket&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token property">&quot;min_bucket&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;buckets_path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my_aggs&gt;price_bucket&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><img src="https://gitee.com/nylg/picture/raw/master/elastic/image-20211026152418834.png" alt=""></p> <h4 id="嵌套聚合"><a href="#嵌套聚合" class="header-anchor">#</a> 嵌套聚合</h4> <p>语法：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;&lt;agg_name&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;&lt;agg_type&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;field_name&gt;&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;&lt;agg_name_child&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;&lt;agg_type&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;field_name&gt;&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>用途：用于在某种聚合的计算结果之上再次聚合，如统计不同类型商品的平均价格，就是在按照商品类型桶聚合之后，在其结果之上计算平均价格</p> <h4 id="聚合和查询的相互关系"><a href="#聚合和查询的相互关系" class="header-anchor">#</a> 聚合和查询的相互关系</h4> <p><strong>基于query或filter的聚合</strong></p> <p>语法：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    ...
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    ...
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>注意：以上语法，执行顺序为先query后aggs，顺序和谁在上谁在下没有关系。query中可以是查询、也可以是filter、或者bool query</p> <p><strong>基于聚合结果的查询、</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET product/_search
{
  &quot;aggs&quot;: {
    ...
  },
  &quot;post_filter&quot;: {
    ...
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>注意：以上语法，执行顺序为先aggs后post_filter，顺序和谁在上谁在下没有关系。</p> <p><strong>查询条件的作用域</strong></p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    ...
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      ...
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;all_avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;global&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        ...
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>上面例子中，avg_price的计算结果是基于query的查询结果的，而all_avg_price的聚合是基于all data的</p> <h4 id="聚合排序"><a href="#聚合排序" class="header-anchor">#</a> 聚合排序</h4> <ol><li><strong>排序规则</strong></li></ol> <p>order_type：_count（数量） _key（聚合结果的key值） _term（废弃但是仍然可用，使用_key代替）</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;type_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tags&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;&lt;order_type&gt;&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ol start="2"><li><strong>多级排序：即排序的优先级，按照外层优先的顺序</strong></li></ol> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET product/_search?size=<span class="token number">0</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;first_sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      ...
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;second_sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          ...
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>上例中，先按照first_sort排序，再按照second_sort排序</p> <ol start="3"><li><strong>多层排序：即按照多层聚合中的里层某个聚合的结果进行排序</strong></li></ol> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET /product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;tag_avg_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;type.keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;agg_stats&gt;my_stats.sum&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;agg_stats&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          ...
          <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;my_stats&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;extended_stats&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                ...
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>上例中，按照里层聚合“my_stats”进行排序</p> <ol start="4"><li><strong>常用的查询函数</strong></li></ol> <ul><li>① histogram：直方图或柱状图统计</li></ul> <p>用途：用于区间统计，如不同价格商品区间的销售情况</p> <p>语法：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET product/_search?size=<span class="token number">0</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;&lt;histogram_name&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;histogram&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span><span class="token punctuation">,</span> #字段名称
        <span class="token property">&quot;interval&quot;</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> #区间间隔
        <span class="token property">&quot;keyed&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> #返回数据的结构化类型
        <span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span> &lt;num&gt;<span class="token punctuation">,</span> #返回桶的最小文档数阈值，即文档数小于num的桶不会被输出
        <span class="token property">&quot;missing&quot;</span><span class="token operator">:</span> <span class="token number">1999</span> #空值的替换值，即如果文档对应字段的值为空，则默认输出<span class="token number">1999</span>（参数值）
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>② date-histogram：基于日期的直方图，比如统计一年每个月的销售额</li></ul> <p>语法：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET product/_search?size=<span class="token number">0</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;my_date_histogram&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;date_histogram&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;createtime&quot;</span><span class="token punctuation">,</span> #字段需为date类型
        <span class="token property">&quot;&lt;interval_type&gt;&quot;</span><span class="token operator">:</span> <span class="token string">&quot;month&quot;</span><span class="token punctuation">,</span> #时间间隔的参数可选项
        <span class="token property">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yyyy-MM&quot;</span><span class="token punctuation">,</span> #日期的格式化输出
        <span class="token property">&quot;extended_bounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> #输出空桶
        <span class="token property">&quot;min&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-01&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;max&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-12&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span>

interval_type：时间间隔的参数可选项

fixed_interval：ms（毫秒）、s（秒）、 m（分钟）、h（小时）、d（天），注意单位需要带上具体的数值，如2d为两天。需要当心当单位过小，会导致输出桶过多而导致服务崩溃。

calendar_interval：month、year

interval：（废弃，但是仍然可用）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ul><li><p>③ percentile 百分位统计 或者 饼状图</p> <p>计算结果为何为近似值？</p></li></ul> <ol><li><p>percentiles：用于评估当前数值分布情况，比如99 percentile 是 1000 ， 是指 99%的数值都在1000以内。常见的一个场景就是我们制定 SLA 的时候常说 99% 的请求延迟都在100ms 以内，这个时候你就可以用 99 percentile 来查一下，看一下 99 percenttile 的值如果在 100ms 以内，就代表SLA达标了。</p> <p>语法：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET product/_search?size=<span class="token number">0</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;&lt;percentiles_name&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;percentiles&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;price&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;percents&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          percent1，#区间的数值，如<span class="token number">5</span>、<span class="token number">10</span>、<span class="token number">30</span>、<span class="token number">50</span>、<span class="token number">99</span> 即代表<span class="token number">5</span>%、<span class="token number">10</span>%、<span class="token number">30</span>%、<span class="token number">50</span>%、<span class="token number">99</span>%的数值分布
          percent2，
          ...
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li> <li><p>percentile_ranks： percentile rank 其实就是percentiles的反向查询，比如我想看一下 1000、3000 在当前数值中处于哪一个范围内，你查一下它的 rank，发现是95，99，那么说明有95%的数值都在1000以内，99%的数值都在3000以内。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET product/_search?size=<span class="token number">0</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;&lt;percentiles_name&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;percentile_ranks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;field_value&gt;&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;values&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          rank1<span class="token punctuation">,</span>
          rank2<span class="token punctuation">,</span>
          ...
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li></ol> <h3 id="_6-10-脚本查询"><a href="#_6-10-脚本查询" class="header-anchor">#</a> 6.10 脚本查询</h3> <p><strong>概念</strong></p> <p>Scripting是Elasticsearch支持的一种专门用于复杂场景下支持自定义编程的强大的脚本功能，ES支持多种脚本语言，如painless，其语法类似于Java,也有注释、关键字、类型、变量、函数等，其就要相对于其他脚本高出几倍的性能，并且安全可靠，可以用于内联和存储脚本。</p> <p><strong>支持的语言</strong></p> <ol><li><p><strong>groovy</strong>：ES 1.4.x-5.0的默认脚本语言</p></li> <li><p><strong>painless</strong>：JavaEE使用java语言开发，.Net使用C#/F#语言开发，Flutter使用Dart语言开发，同样，ES 5.0+版本后的Scripting使用的语言默认就是painless，painless是一种专门用于Elasticsearch的简单,用于内联和存储脚本，是ES 5.0+的默认脚本语言，类似于Java,也有注释、关键字、类型、变量、函数等，是一种安全的脚本语言。并且是Elasticsearch的默认脚本语言。</p></li> <li><p><strong>其他</strong>：</p> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-expression.html" target="_blank" rel="noopener noreferrer">expression<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：每个文档的开销较低：表达式的作用更多，可以非常快速地执行，甚至比编写native脚本还要快，支持javascript语法的子集：单个表达式。缺点：只能访问数字，布尔值，日期和geo_point字段，存储的字段不可用</p> <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-template.html" target="_blank" rel="noopener noreferrer">mustache<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：提供模板参数化查询</p></li></ol> <p><strong>特点</strong></p> <ol><li>语法简单，学习成本低</li> <li>灵活度高，可编程能力强</li> <li>性能相较于其他脚本语言很高</li> <li>安全性好</li> <li>独立语言，虽然易学但仍需单独学习</li> <li>相较于DSL性能低</li> <li>不适用于复杂的业务场景</li></ol> <p><strong>应用场景</strong>：各种复杂的应用场景，如自定义评分、自定义聚合查询等。</p> <p><strong>正则</strong></p> <p>早先某些版本正则表达式默认情况下处于禁用模式，因为它绕过了painless的针对长时间运行和占用内存脚本的保护机制。而且有深度对战行为。如果需要开启正则，需要配置：script.painless.regex.enabled: true</p> <p><strong>注意</strong>：通常正则的使用范围比较小，应用范围基本限制在数据量比较小和并发量比较小的应用场景下。</p> <h3 id="_6-11-1-批量查询-mget"><a href="#_6-11-1-批量查询-mget" class="header-anchor">#</a> 6.11.1 批量查询 _mget</h3> <p>批量获取文档数据是通过_mget的API来实现的</p> <p><strong>① 在URL中不指定index和type</strong></p> <ul><li><p>请求方式：GET</p></li> <li><p>请求地址：_mget</p></li> <li><p>功能说明 ： 可以通过ID批量获取不同index和type的数据</p></li> <li><p>请求参数：</p></li> <li><ul><li>docs : 文档数组参数
<ul><li>_index : 指定index</li> <li>_type : 指定type</li> <li>_id : 指定id</li> <li>_source : 指定要查询的字段</li></ul></li></ul></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET _mget
{
  &quot;docs&quot;: [
    {
      &quot;_index&quot;: &quot;es_db&quot;,
      &quot;_type&quot;: &quot;_doc&quot;,
      &quot;_id&quot;: 1
    },
    {
      &quot;_index&quot;: &quot;es_db&quot;,
      &quot;_type&quot;: &quot;_doc&quot;,
      &quot;_id&quot;: 2
    }
  ]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>响应结果如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;docs&quot; : [
    {
      &quot;_index&quot; : &quot;es_db&quot;,
      &quot;_type&quot; : &quot;_doc&quot;,
      &quot;_id&quot; : &quot;1&quot;,
      &quot;_version&quot; : 3,
      &quot;_seq_no&quot; : 7,
      &quot;_primary_term&quot; : 1,
      &quot;found&quot; : true,
      &quot;_source&quot; : {
        &quot;name&quot; : &quot;张三666&quot;,
        &quot;sex&quot; : 1,
        &quot;age&quot; : 25,
        &quot;address&quot; : &quot;广州天河公园&quot;,
        &quot;remark&quot; : &quot;java developer&quot;
      }
    },
    {
      &quot;_index&quot; : &quot;es_db&quot;,
      &quot;_type&quot; : &quot;_doc&quot;,
      &quot;_id&quot; : &quot;2&quot;,
      &quot;_version&quot; : 1,
      &quot;_seq_no&quot; : 1,
      &quot;_primary_term&quot; : 1,
      &quot;found&quot; : true,
      &quot;_source&quot; : {
        &quot;name&quot; : &quot;李四&quot;,
        &quot;sex&quot; : 1,
        &quot;age&quot; : 28,
        &quot;address&quot; : &quot;广州荔湾大厦&quot;,
        &quot;remark&quot; : &quot;java assistant&quot;
      }
    }
  ]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><strong>② 在URL中指定index</strong></p> <ul><li><p>请求方式：GET</p></li> <li><p>请求地址：//_mget</p></li> <li><p>功能说明 ： 可以通过ID批量获取不同index和type的数据</p></li> <li><p>请求参数：</p></li> <li><ul><li>docs : 文档数组参数
<ul><li>_index : 指定index</li> <li>_type : 指定type</li> <li>_id : 指定id</li> <li>_source : 指定要查询的字段</li></ul></li></ul></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_mget
{
  &quot;docs&quot;: [
    {
      &quot;_type&quot;: &quot;_doc&quot;,
      &quot;_id&quot;: 3
    },
    {
      &quot;_type&quot;: &quot;_doc&quot;,
      &quot;_id&quot;: 4
    }
  ]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>​</p> <p><strong>③ 在URL中指定index和type</strong></p> <ul><li><p>请求方式：GET</p></li> <li><p>请求地址：///_mget</p></li> <li><p>功能说明 ： 可以通过ID批量获取不同index和type的数据</p></li> <li><p>请求参数：</p></li> <li><ul><li>docs : 文档数组参数
<ul><li>_index : 指定index</li> <li>_type : 指定type</li> <li>_id : 指定id</li> <li>_source : 指定要查询的字段</li></ul></li></ul></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_doc/_mget
{
  &quot;docs&quot;: [
    {
      &quot;_id&quot;: 1
    },
    {
      &quot;_id&quot;: 2
    }
  ]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_6-11-2-批量增删改-bulk"><a href="#_6-11-2-批量增删改-bulk" class="header-anchor">#</a> 6.11.2 批量增删改 _bulk</h3> <p>批量对文档进行写操作是通过_bulk的API来实现的</p> <ul><li><p>请求方式：POST</p></li> <li><p>请求地址：_bulk</p></li> <li><p>请求参数：通过_bulk操作文档，一般至少有两行参数(或偶数行参数)</p> <ul><li>第一行参数为指定操作的类型及操作的对象(index,type和id)</li> <li>第二行参数才是操作的数据</li></ul></li></ul> <p>参数类似于：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;actionName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;indexName&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;typeName&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;id&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;field1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;field2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;value2&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>actionName：表示操作类型，主要有create,index,delete和update</li></ul> <ol><li>批量创建文档create</li></ol> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST _bulk
<span class="token punctuation">{</span>
  <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;article&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">3</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;白起老师1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;白起老师666&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;java&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;面向对象&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;create_time&quot;</span><span class="token operator">:</span> <span class="token number">1554015482530</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;article&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">4</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;白起老师2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;白起老师NB&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;java&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;面向对象&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;create_time&quot;</span><span class="token operator">:</span> <span class="token number">1554015482530</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><ol start="2"><li>普通创建或全量替换index</li></ol> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST _bulk
<span class="token punctuation">{</span>
  <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;article&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">3</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;图灵徐庶老师(一)&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;图灵学院徐庶老师666&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;java&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;面向对象&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;create_time&quot;</span><span class="token operator">:</span> <span class="token number">1554015482530</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;article&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">4</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;图灵诸葛老师(二)&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;图灵学院诸葛老师NB&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;java&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;面向对象&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;create_time&quot;</span><span class="token operator">:</span> <span class="token number">1554015482530</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><ul><li>如果原文档不存在，则是创建</li> <li>如果原文档存在，则是替换(全量修改原文档)</li></ul> <ol start="3"><li>批量删除delete</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST _bulk
{
  &quot;delete&quot;: {
    &quot;_index&quot;: &quot;article&quot;,
    &quot;_type&quot;: &quot;_doc&quot;,
    &quot;_id&quot;: 3
  }
}
{
  &quot;delete&quot;: {
    &quot;_index&quot;: &quot;article&quot;,
    &quot;_type&quot;: &quot;_doc&quot;,
    &quot;_id&quot;: 4
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ol start="4"><li>批量修改update</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST _bulk
{
  &quot;update&quot;: {
    &quot;_index&quot;: &quot;article&quot;,
    &quot;_type&quot;: &quot;_doc&quot;,
    &quot;_id&quot;: 3
  }
}
{
  &quot;doc&quot;: {
    &quot;title&quot;: &quot;ES大法必修内功&quot;
  }
}
{
  &quot;update&quot;: {
    &quot;_index&quot;: &quot;article&quot;,
    &quot;_type&quot;: &quot;_doc&quot;,
    &quot;_id&quot;: 4
  }
}
{
  &quot;doc&quot;: {
    &quot;create_time&quot;: 1554018421008
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>​</p> <h3 id="_6-12-模糊查询-智能搜索推荐"><a href="#_6-12-模糊查询-智能搜索推荐" class="header-anchor">#</a> 6.12 模糊查询，智能搜索推荐</h3> <h4 id="前缀搜索-prefix"><a href="#前缀搜索-prefix" class="header-anchor">#</a> 前缀搜索：prefix</h4> <p>概念：以xx开头的搜索，不计算相关度评分。</p> <p>注意：</p> <ul><li>前缀搜索匹配的是term，而不是field。</li> <li>前缀搜索的性能很差</li> <li>前缀搜索没有缓存</li> <li>前缀搜索尽可能把前缀长度设置的更长</li></ul> <p>语法：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET &lt;index&gt;/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;prefix&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;&lt;field&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;word_prefix&gt;&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
index_prefixes<span class="token operator">:</span> 默认   <span class="token property">&quot;min_chars&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>   <span class="token property">&quot;max_chars&quot;</span> <span class="token operator">:</span> <span class="token number">5</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="通配符-wildcard"><a href="#通配符-wildcard" class="header-anchor">#</a> 通配符：wildcard</h4> <p>概念：通配符运算符是匹配一个或多个字符的占位符。例如，*通配符运算符匹配零个或多个字符。您可以将通配符运算符与其他字符结合使用以创建通配符模式。</p> <p>注意：</p> <ul><li>通配符匹配的也是term，而不是field</li></ul> <p>语法：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET &lt;index&gt;/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;wildcard&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;&lt;field&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;word_with_wildcard&gt;&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="正则-regexp"><a href="#正则-regexp" class="header-anchor">#</a> 正则：regexp</h4> <p>概念：regexp查询的性能可以根据提供的正则表达式而有所不同。为了提高性能，应避免使用通配符模式，如.<em>或 .</em>?+未经前缀或后缀</p> <p>语法：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET &lt;index&gt;/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;regexp&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;&lt;field&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;regex&gt;&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;flags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ALL&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>flags参数：</strong></p> <ul><li><p>ALL：启用所有可选操作符。</p></li> <li><p>COMPLEMENT：启用~操作符。可以使用~对下面最短的模式进行否定。例如</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>a~bc  # matches 'adc' and 'aec' but not 'abc'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>INTERVAL：启用&lt;&gt;操作符。可以使用&lt;&gt;匹配数值范围。例如</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>foo&lt;1-100&gt;    # matches 'foo1', 'foo2' ... 'foo99', 'foo100'
foo&lt;01-100&gt;   # matches 'foo01', 'foo02' ... 'foo99', 'foo100'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>INTERSECTION：启用&amp;操作符，它充当AND操作符。如果左边和右边的模式都匹配，则匹配成功。例如:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>aaa.+&amp;.+bbb  # matches 'aaabbb'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>ANYSTRING：启用@操作符。您可以使用@来匹配任何整个字符串。您可以将@操作符与&amp;和~操作符组合起来，创建一个“everything except”逻辑。例如:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@&amp;~(abc.+)  # matches everything except terms beginning with 'abc'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>
#### 模糊查询：fuzzy

混淆字符 (**b**ox → fox)							

缺少字符 (**b**lack → lack)

多出字符 (sic → sic**k**)							 

颠倒次序 (a**c**t → **c**at)



语法：

```json
GET &lt;index&gt;/_search
{
  &quot;query&quot;: {
    &quot;fuzzy&quot;: {
      &quot;&lt;field&gt;&quot;: {
        &quot;value&quot;: &quot;&lt;keyword&gt;&quot;
      }
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>参数：</p> <ul><li><p>value：（必须，关键词）</p></li> <li><p>fuzziness：编辑距离，（0，1，2）并非越大越好，召回率高但结果不准确</p> <ol><li><p>两段文本之间的Damerau-Levenshtein距离是使一个字符串与另一个字符串匹配所需的插入、删除、替换和调换的数量</p></li> <li><p>距离公式：Levenshtein是lucene的，es改进版：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Damerau-Levenshtein，
axe=&gt;aex  
Levenshtein=2  
Damerau-Levenshtein=1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ol></li> <li><p>transpositions：（可选，布尔值）指示编辑是否包括两个相邻字符的变位（ab→ba）。默认为true。</p></li></ul> <h4 id="match-phrase-prefix短语前缀"><a href="#match-phrase-prefix短语前缀" class="header-anchor">#</a> match_phrase_prefix短语前缀</h4> <p>match_phrase：</p> <ul><li>match_phrase会分词</li> <li>被检索字段必须包含match_phrase中的所有词项并且顺序必须是相同的</li> <li>被检索字段包含的match_phrase中的词项之间不能有其他词项</li></ul> <p>概念：</p> <p>​	match_phrase_prefix与match_phrase相同,但是它多了一个特性,就是它允许在文本的最后一个词项(term)上的前缀匹配,如果 是一个单词,比如a,它会匹配文档字段所有以a开头的文档,如果是一个短语,比如 &quot;this is ma&quot; ,他会先在倒排索引中做以ma做前缀搜索,然后在匹配到的doc中做match_phrase查询,(网上有的说是先match_phrase,然后再进行前缀搜索, 是不对的)</p> <p>参数</p> <ul><li>analyzer 指定何种分析器来对该短语进行分词处理</li> <li>max_expansions 限制匹配的最大词项</li> <li>boost 用于设置该查询的权重</li> <li>slop 允许短语间的词项(term)间隔：slop 参数告诉 match_phrase 查询词条相隔多远时仍然能将文档视为匹配 什么是相隔多远？ 意思是说为了让查询和文档匹配你需要移动词条多少次？</li></ul> <p>原理解析：https://www.elastic.co/cn/blog/found-fuzzy-search#performance-considerations</p> <h4 id="n-gram和edge-ngram"><a href="#n-gram和edge-ngram" class="header-anchor">#</a> N-gram和edge ngram</h4> <p>tokenizer</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET _analyze
<span class="token punctuation">{</span>
  <span class="token property">&quot;tokenizer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ngram&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reba always loves me&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>token filter</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET _analyze
<span class="token punctuation">{</span>
  <span class="token property">&quot;tokenizer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;ngram&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reba always loves me&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>min_gram：创建索引所拆分字符的最小阈值</p> <p>max_gram：创建索引所拆分字符的最大阈值</p> <p>ngram：从每一个字符开始,按照步长,进行分词,适合前缀中缀检索</p> <p>edge_ngram：从第一个字符开始,按照步长,进行分词,适合前缀匹配场景</p> <h3 id="_6-13-搜索推荐-suggest"><a href="#_6-13-搜索推荐-suggest" class="header-anchor">#</a> 6.13 搜索推荐 Suggest</h3> <p>现代的搜索引擎，一般会具备&quot;Suggest As You Type&quot;功能，即在用户输入搜索的过程中，进行自动补全或者纠错。 通过协助用户输入更精准的关键词，提高后续全文搜索阶段文档匹配的程度。</p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/image-20211115135758855.png" alt=""></p> <p><strong>概述</strong></p> <p>搜索一般都会要求具有“搜索推荐”或者叫“搜索补全”的功能，即在用户输入搜索的过程中，进行自动补全或者纠错。以此来提高搜索文档的匹配精准度，进而提升用户的搜索体验，这就是Suggest。</p> <p><strong>四种Suggester</strong></p> <ol><li><strong>term suggester</strong>：term suggester正如其名，只基于tokenizer之后的单个term去匹配建议词，并不会考虑多个term之间的关系</li></ol> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST &lt;index&gt;/_search
<span class="token punctuation">{</span> 
  <span class="token property">&quot;suggest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;&lt;suggest_name&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;search_content&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;suggest_mode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;suggest_mode&gt;&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;field_name&gt;&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>参数：</p> <blockquote><ul><li><strong>text</strong>：用户搜索的文本</li> <li><strong>field</strong>：要从哪个字段选取推荐数据</li> <li><strong>analyzer</strong>：使用哪种分词器</li> <li><strong>size</strong>：每个建议返回的最大结果数</li> <li><strong>sort</strong>：如何按照提示词项排序，参数值只可以是以下两个枚举：
<ul><li><strong>score</strong>：分数&gt;词频&gt;词项本身</li> <li><strong>frequency</strong>：词频&gt;分数&gt;词项本身</li></ul></li> <li><strong>suggest_mode</strong>：搜索推荐的推荐模式，参数值亦是枚举：
<ul><li>missing：默认值，仅为不在索引中的词项生成建议词</li> <li>popular：仅返回与搜索词文档词频或文档词频更高的建议词</li> <li>always：根据 建议文本中的词项 推荐 任何匹配的建议词</li></ul></li> <li><strong>max_edits</strong>：可以具有最大偏移距离候选建议以便被认为是建议。只能是1到2之间的值。任何其他值都将导致引发错误的请求错误。默认为2</li> <li><strong>prefix_length</strong>：前缀匹配的时候，必须满足的最少字符</li> <li><strong>min_word_length</strong>：最少包含的单词数量</li> <li><strong>min_doc_freq</strong>：最少的文档频率</li> <li><strong>max_term_freq</strong>：最大的词频</li></ul></blockquote> <ol start="2"><li><strong>phrase suggester</strong>：phrase suggester和term suggester相比，对建议的文本会参考上下文，也就是一个句子的其他token，不只是单纯的token距离匹配，它可以基于共生和频率选出更好的建议。</li></ol> <p>参数：</p> <blockquote><ul><li>real_word_error_likelihood： 此选项的默认值为 0.95。此选项告诉 Elasticsearch 索引中 5% 的术语拼写错误。这意味着随着这个参数的值越来越低，Elasticsearch 会将越来越多存在于索引中的术语视为拼写错误，即使它们是正确的</li> <li>max_errors：为了形成更正，最多被认为是拼写错误的术语的最大百分比。默认值为 1</li> <li>confidence：默认值为 1.0，最大值也是。该值充当与建议分数相关的阈值。只有得分超过此值的建议才会显示。例如，置信度为 1.0 只会返回得分高于输入短语的建议</li> <li>collate：告诉 Elasticsearch 根据指定的查询检查每个建议，以修剪索引中不存在匹配文档的建议。在这种情况下，它是一个匹配查询。由于此查询是模板查询，因此搜索查询是当前建议，位于查询中的参数下。可以在查询下的“params”对象中添加更多字段。同样，当参数“prune”设置为true时，我们将在响应中增加一个字段“collate_match”，指示建议结果中是否存在所有更正关键字的匹配</li> <li>direct_generator：phrase suggester使用候选生成器生成给定文本中每个项可能的项的列表。单个候选生成器类似于为文本中的每个单独的调用term suggester。生成器的输出随后与建议候选项中的候选项结合打分。目前只支持一种候选生成器，即direct_generator。建议API接受密钥直接生成器下的生成器列表；列表中的每个生成器都按原始文本中的每个项调用。</li></ul></blockquote> <ol start="3"><li><strong>completion suggester</strong>：自动补全，自动完成，支持三种查询【前缀查询（prefix）模糊查询（fuzzy）正则表达式查询（regex)】 ，主要针对的应用场景就是&quot;Auto Completion&quot;。 此场景下用户每输入一个字符的时候，就需要即时发送一次查询请求到后端查找匹配项，在用户输入速度较高的情况下对后端响应速度要求比较苛刻。因此实现上它和前面两个Suggester采用了不同的数据结构，索引并非通过倒排来完成，而是将analyze过的数据编码成FST和索引一起存放。对于一个open状态的索引，FST会被ES整个装载到内存里的，进行前缀查找速度极快。但是FST只能用于前缀查找，这也是Completion Suggester的局限所在。</li></ol> <blockquote><ul><li>completion：es的一种特有类型，专门为suggest提供，基于内存，性能很高。</li> <li>prefix query：基于前缀查询的搜索提示，是最常用的一种搜索推荐查询。
<ul><li>prefix：客户端搜索词</li> <li>field：建议词字段</li> <li>size：需要返回的建议词数量（默认5）</li> <li>skip_duplicates：是否过滤掉重复建议，默认false</li></ul></li> <li>fuzzy query
<ul><li>fuzziness：允许的偏移量，默认auto</li> <li>transpositions：如果设置为true，则换位计为一次更改而不是两次更改，默认为true。</li> <li>min_length：返回模糊建议之前的最小输入长度，默认 3</li> <li>prefix_length：输入的最小长度（不检查模糊替代项）默认为 1</li> <li>unicode_aware：如果为true，则所有度量（如模糊编辑距离，换位和长度）均以Unicode代码点而不是以字节为单位。这比原始字节略慢，因此默认情况下将其设置为false。</li></ul></li> <li>regex query：可以用正则表示前缀，不建议使用</li></ul></blockquote> <ol start="4"><li><strong>context suggester</strong>：完成建议者会考虑索引中的所有文档，但是通常来说，我们在进行智能推荐的时候最好通过某些条件过滤，并且有可能会针对某些特性提升权重。</li></ol> <blockquote><ul><li>contexts：上下文对象，可以定义多个
<ul><li>name：<code>context</code>的名字，用于区分同一个索引中不同的<code>context</code>对象。需要在查询的时候指定当前name</li> <li>type：<code>context</code>对象的类型，目前支持两种：category和geo，分别用于对suggest  item分类和指定地理位置。</li> <li>boost：权重值，用于提升排名</li></ul></li> <li>path：如果没有path，相当于在PUT数据的时候需要指定context.name字段，如果在Mapping中指定了path，在PUT数据的时候就不需要了，因为 Mapping是一次性的，而PUT数据是频繁操作，这样就简化了代码。这段解释有木有很牛逼，网上搜到的都是官方文档的翻译，觉悟雷同。</li></ul></blockquote> <h3 id="_6-14-数据建模"><a href="#_6-14-数据建模" class="header-anchor">#</a> 6.14 数据建模</h3> <h4 id="_6-14-1-嵌套类型-nested"><a href="#_6-14-1-嵌套类型-nested" class="header-anchor">#</a> 6.14.1 嵌套类型：Nested</h4> <p>nested属于object类型的一种，是Elasticsearch中用于复杂类型对象数组的索引操作。Elasticsearch没有内部对象的概念，因此，ES在存储复杂类型的时候会把对象的复杂层次结果扁平化为一个键值对列表。</p> <p><strong>比如</strong>：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>PUT my-index<span class="token number">-000001</span>/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;group&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;fans&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span> 
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;Smith&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;White&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>上面的文档被创建之后，user数组中的每个json对象会以下面的形式存储</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;group&quot; :        &quot;fans&quot;,
  &quot;user.first&quot; : [ &quot;alice&quot;, &quot;john&quot; ],
  &quot;user.last&quot; :  [ &quot;smith&quot;, &quot;white&quot; ]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>user.first</code>和<code>user.last</code>字段被扁平化为多值字段，<code>first</code>和<code>last</code>之间的关联丢失。</p> <p><strong>使用nested为复杂类型创建mapping：</strong></p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>PUT &lt;index_name&gt;
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;&lt;nested_field_name&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>查询</strong>：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET &lt;index_name&gt;/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;nested_field_name&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        ...
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>Optins:</strong></p> <ul><li>path：nested对象的查询深度</li> <li>score_mode：评分计算方式
<ul><li>avg （默认）：使用所有匹配的子对象的平均相关性得分。</li> <li>max：使用所有匹配的子对象中的最高相关性得分。</li> <li>min：使用所有匹配的子对象中最低的相关性得分。</li> <li>none：不要使用匹配的子对象的相关性分数。该查询为父文档分配得分为0。</li> <li>sum：将所有匹配的子对象的相关性得分相加。</li></ul></li></ul> <h4 id="_6-14-2-父子级关系-join"><a href="#_6-14-2-父子级关系-join" class="header-anchor">#</a> 6.14.2 父子级关系：Join</h4> <p>连接数据类型是一个特殊字段，它在同一索引的文档中创建父/子关系。关系部分在文档中定义了一组可能的关系，每个关系是一个父名和一个子名。父/子关系可以定义如下</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>PUT &lt;index_name&gt;
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;&lt;join_field_name&gt;&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;join&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;relations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;&lt;parent_name&gt;&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;child_name&gt;&quot;</span> 
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>使用场景</strong></p> <p><code>join</code>类型不能像关系数据库中的表链接那样去用，不论是<code>has_child</code>或者是<code>has_parent</code>查询都会对索引的查询性能有严重的负面影响。并且会触发<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.12/eager-global-ordinals.html#_what_are_global_ordinals" target="_blank" rel="noopener noreferrer">global ordinals<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>join</code><strong>唯一</strong>合适应用场景是：当索引数据包含一对多的关系，并且其中一个实体的数量远远超过另一个的时候。比如：<code>老师</code>有<code>一万个学生</code></p> <p><strong>注意</strong></p> <ul><li>在索引父子级关系数据的时候必须传入routing参数，即指定把数据存入哪个分片，因为父文档和子文档必须在同一个分片上，因此，在获取、删除或更新子文档时需要提供相同的路由值。</li> <li>每个索引只允许有一个<code>join</code>类型的字段映射</li> <li>一个元素可以有多个子元素但只有一个父元素</li> <li>可以向现有连接字段添加新关系</li> <li>也可以向现有元素添加子元素，但前提是该元素已经是父元素</li></ul> <h4 id="_6-14-3-数据建模"><a href="#_6-14-3-数据建模" class="header-anchor">#</a> 6.14.3 数据建模</h4> <h5 id="_6-14-3-1-概念"><a href="#_6-14-3-1-概念" class="header-anchor">#</a> 6.14.3.1 概念</h5> <p>数据模型是描述现实世界某种现象或者状态的物理抽象，比如我们之前用<code>FSA</code>来描述<code>周老师的一天</code>这种现象，就是把现实世界抽象成某种模型。现实世界有很多重要的关联关系：博客帖子有一些评论，银行账户有多次交易记录，客户有多个银行账户，订单有多个订单明细，文件目录有多个文件和子目录。</p> <p>关系型数据库关联关系：</p> <ul><li>每个实体（或 行 ，在关系世界中）可以被<code>主键</code>唯一标识。</li> <li>实体<code>规范化</code>（范式）。唯一实体的数据只存储一次，而相关实体只存储它的主键。只能在一个具体位置修改这个实体的数据。</li> <li>实体可以进行关联查询，可以跨实体搜索。</li> <li>单个实体的变化是<code>原子性</code>，<code>一致性</code>，<code>隔离性</code>， 和<code>持久性</code>。 （可以在 <a href="http://en.wikipedia.org/wiki/ACID_transactions" target="_blank" rel="noopener noreferrer"><em>ACID Transactions</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中查看更多细节。）</li> <li>大多数关系数据库支持跨多个实体的 ACID 事务。</li></ul> <p>但是关系型数据库有其局限性，包括对全文检索有限的支持能力。 实体关联查询时间消耗是很昂贵的，关联的越多，消耗就越昂贵。特别是跨服务器进行实体关联时成本极其昂贵，基本不可用。 但单个的服务器上又存在数据量的限制。</p> <p>Elasticsearch ，和大多数 NoSQL 数据库类似，是扁平化的。索引是独立文档的集合体。 文档是否匹配搜索请求取决于它是否包含所有的所需信息。</p> <p>Elasticsearch 中单个文档的数据变更是 <a href="http://en.wikipedia.org/wiki/ACID_transactions" target="_blank" rel="noopener noreferrer">ACIDic<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的， 而涉及多个文档的事务则不是。当一个事务部分失败时，无法回滚索引数据到前一个状态。</p> <p>扁平化有以下优势：</p> <ul><li>索引过程是快速和无锁的。</li> <li>搜索过程是快速和无锁的。</li> <li>因为每个文档相互都是独立的，大规模数据可以在多个节点上进行分布。</li></ul> <p>但关联关系仍然非常重要。某些时候，我们需要缩小扁平化和现实世界关系模型的差异。以下四种常用的方法，用来在 Elasticsearch 中进行关系型数据的管理：</p> <ul><li><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/application-joins.html" target="_blank" rel="noopener noreferrer">Application-side joins<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/denormalization.html" target="_blank" rel="noopener noreferrer">Data denormalization<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/nested-objects.html" target="_blank" rel="noopener noreferrer">Nested objects<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/parent-child.html" target="_blank" rel="noopener noreferrer">Parent/child relationships<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h5 id="_6-14-3-2-对象和实体"><a href="#_6-14-3-2-对象和实体" class="header-anchor">#</a> 6.14.3.2 对象和实体</h5> <p>对象和实体的关系就是现实世界和数据模型的映射，我们在做Java开发的时候经常用到的POJO的领域模型就是这种关系：</p> <p>分层领域模型规约：</p> <ul><li>DO（ Data Object）：与数据库表结构一一对应，通过DAO层向上传输数据源对象。</li> <li>DTO（ Data Transfer Object）：数据传输对象，Service或Manager向外传输的对象。</li> <li>BO（ Business Object）：业务对象。 由Service层输出的封装业务逻辑的对象。</li> <li>AO（ Application Object）：应用对象。 在Web层与Service层之间抽象的复用对象模型，极为贴近展示层，复用度不高。</li> <li>VO（ View Object）：显示层对象，通常是Web向模板渲染引擎层传输的对象。</li> <li>POJO（ Plain Ordinary Java Object）：在本手册中， POJO专指只有setter/getter/toString的简单类，包括DO/DTO/BO/VO等。</li> <li>Query：数据查询对象，各层接收上层的查询请求。 注意超过2个参数的查询封装，禁止使用Map类来传输。</li></ul> <p>领域模型命名规约：</p> <ul><li>数据对象：xxxDO，xxx即为数据表名。</li> <li>数据传输对象：xxxDTO，xxx为业务领域相关的名称。</li> <li>展示对象：xxxVO，xxx一般为网页名称。</li> <li>POJO是DO/DTO/BO/VO的统称，禁止命名成xxxPOJO。</li></ul> <h5 id="_6-14-3-3-数据建模的过程"><a href="#_6-14-3-3-数据建模的过程" class="header-anchor">#</a> 6.14.3.3 数据建模的过程</h5> <ul><li>概念：需求 =&gt; 抽象。即把实际的用户需求抽象为某种数据模型，比如我们在存储<code>倒排表</code>的时候，就是把”储存倒排表“这个需求抽象成<code>FST</code>的这种抽象的数据模型。</li> <li>逻辑：抽象 =&gt; 具体。仍然以”存储倒排表“为例，FST模型构建完成之后，我们需要把其抽象变成具体的代码和对象，把实现变为肉眼可见的东西。</li> <li>物理：具体 =&gt; 落地。同上，当我们有了逻辑之后，就可以通过具体的对象、属性编程实实在在的数据文件，保存在你的磁盘里。</li></ul> <h5 id="_6-14-3-4-意义"><a href="#_6-14-3-4-意义" class="header-anchor">#</a> 6.14.3.4 意义</h5> <p>​	<strong>我个人总结如下，但其实不仅限于以下几点：</strong></p> <ul><li>开发：简化开发流程，从而提高效率</li> <li>产品：提升数据的存储效率，提升查询性能</li> <li>管理：前期准备充分，降低后期出现问题的可能性</li> <li>成本：综合各个因素，降低整体的运营和管理成本</li></ul> <h5 id="_6-14-3-5-数据建模的包含的内容"><a href="#_6-14-3-5-数据建模的包含的内容" class="header-anchor">#</a> 6.14.3.5 数据建模的包含的内容</h5> <ul><li><h5 id="关联关系处理-index-relations"><a href="#关联关系处理-index-relations" class="header-anchor">#</a> 关联关系处理（index relations）：</h5> <ul><li><h5 id="数据模型的关联-我们通过在我们的应用程序中实现联接可以-部分-模拟关系数据库。应用层联接的主要优点是可以对数据进行标准化处理。只能在-user-文档中修改用户的名称。缺点是-为了在搜索时联接文档-必须运行额外的查询"><a href="#数据模型的关联-我们通过在我们的应用程序中实现联接可以-部分-模拟关系数据库。应用层联接的主要优点是可以对数据进行标准化处理。只能在-user-文档中修改用户的名称。缺点是-为了在搜索时联接文档-必须运行额外的查询" class="header-anchor">#</a> <strong>数据模型的关联</strong>：我们通过在我们的应用程序中实现联接可以（部分）模拟关系数据库。应用层联接的主要优点是可以对数据进行标准化处理。只能在 <code>user</code> 文档中修改用户的名称。缺点是，为了在搜索时联接文档，必须运行额外的查询</h5></li> <li><h5 id="非规范化数据-使用-elasticsearch-得到最好的搜索性能的方法是有目的的通过在索引时进行非规范化-denormalizing。对每个文档保持一定数量的冗余副本可以在需要访问时避免进行关联"><a href="#非规范化数据-使用-elasticsearch-得到最好的搜索性能的方法是有目的的通过在索引时进行非规范化-denormalizing。对每个文档保持一定数量的冗余副本可以在需要访问时避免进行关联" class="header-anchor">#</a> <strong>非规范化数据</strong>：使用 Elasticsearch 得到最好的搜索性能的方法是有目的的通过在索引时进行非规范化 <a href="http://en.wikipedia.org/wiki/Denormalization" target="_blank" rel="noopener noreferrer">denormalizing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。对每个文档保持一定数量的冗余副本可以在需要访问时避免进行关联</h5></li> <li><p><strong>稀疏字段</strong>：避免稀疏字段文档</p></li> <li><p><strong>并发问题</strong>：全局锁、文档锁、树锁（独占锁、共享锁）、乐观锁、悲观锁</p></li></ul></li> <li><p>Object类型：通俗点就是通过字段冗余，以一张大宽表来实现粗粒度的index，这样可以充分发挥扁平化的优势。但是这是以牺牲索引性能及灵活度为代价的。使用的前提：冗余的字段应该是很少改变的；比较适合与一对少量关系的处理。当业务数据库并非采用非规范化设计时，这时要将数据同步到作为二级索引库的ES中，就很难使用上述增量同步方案，必须进行定制化开发，基于特定业务进行应用开发来处理join关联和实体拼接</p></li> <li><p><strong>嵌套对象</strong>：索引性能和查询性能二者不可兼得，必须进行取舍。嵌套文档将实体关系嵌套组合在单文档内部（类似与json的一对多层级结构），这种方式牺牲索引性能（文档内任一属性变化都需要重新索引该文档）来换取查询性能，可以同时返回关系实体，比较适合于一对少量的关系处理。当使用嵌套文档时，使用通用的查询方式是无法访问到的，必须使用合适的查询方式（nested query、nested filter、nested facet等），很多场景下，使用嵌套文档的复杂度在于索引阶段对关联关系的组织拼装</p></li> <li><p><strong>父子级关系</strong>：父子文档牺牲了一定的查询性能来换取索引性能，适用于一对多的关系处理。其通过两种type的文档来表示父子实体，父子文档的索引是独立的。父-子文档ID映射存储在 Doc Values 中。当映射完全在内存中时， Doc Values 提供对映射的快速处理能力，另一方面当映射非常大时，可以通过溢出到磁盘提供足够的扩展能力。 在查询parent-child替代方案时，发现了一种filter-terms的语法，要求某一字段里有关联实体的ID列表。基本的原理是在terms的时候，对于多项取值，如果在另外的index或者type里已知主键id的情况下，某一字段有这些值，可以直接嵌套查询。具体可参考官方文档的示例：通过用户里的粉丝关系，微博和用户的关系，来查询某个用户的粉丝发表的微博列表。</p></li> <li><p><strong>扩展性</strong>：</p> <ul><li>分片分配感知</li> <li>索引模板</li> <li>索引生命周期</li> <li>冷热架构</li> <li>分片管理和规划</li> <li>滚动索引和别名</li> <li>跨集群搜索</li></ul></li></ul> <h3 id="_6-15-多字段检索-multi-match"><a href="#_6-15-多字段检索-multi-match" class="header-anchor">#</a> 6.15 多字段检索 multi_match</h3> <p><strong>概念</strong>：多字段检索，是组合查询的另一种形态，考试的时候如果考察多字段检索，并不一定必须使用multi_match，使用bool query，只要结果正确亦可，除非题目中明确要求（目前没有强制要求过）</p> <p><strong>语法：</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET &lt;index&gt;/_search
{
  &quot;query&quot;: {
    &quot;multi_match&quot;: {
      &quot;query&quot;: &quot;&lt;query keyword&gt;&quot;,
      &quot;type&quot;: &quot;&lt;multi_match_type&gt;&quot;,
      &quot;fields&quot;: [
        &quot;&lt;field_a&gt;&quot;,
        &quot;&lt;field_b&gt;&quot;
      ]
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>multi_match和_source区别</strong></p> <ul><li>multi_match：从哪些字段中检索，指的是查询条件</li> <li>_source：查询的结果包含哪些字段，指的是元数据</li></ul> <p>打个形象的比喻，在MySQL中，Select * From Table Where a=x and b = x，那么multi_match即指的是<code>a和b两个字段</code>，而<code>_source</code>指的是<code>*</code>。</p> <h4 id="_6-15-1-best-fields"><a href="#_6-15-1-best-fields" class="header-anchor">#</a> 6.15.1 best_fields</h4> <p><strong>概念</strong></p> <p>侧重于“字段”维度，单个字段的得分权重大，对于同一个query，单个field匹配更多的term，则优先排序。</p> <p><strong>用法</strong></p> <p>注意，best_fields是multi_match中type的默认值</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET product/_search
{
  &quot;query&quot;: {
    &quot;multi_match&quot; : {
      &quot;query&quot;:      &quot;super charge&quot;,
      &quot;type&quot;:       &quot;best_fields&quot;, // 默认
      &quot;fields&quot;:     [ &quot;name^2&quot;, &quot;desc&quot; ],
      &quot;tie_breaker&quot;: 0.3
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>案例</strong></p> <p>针对于以下查询，包含两个查询条件：分别是条件1和条件2</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET product/_search
{
  &quot;query&quot;: {
    &quot;dis_max&quot;: {
      &quot;queries&quot;: [
        { &quot;match&quot;: { &quot;name&quot;: &quot;chiji shouji&quot; }},   #条件1
        { &quot;match&quot;: { &quot;desc&quot;: &quot;chiji shouji&quot; }}		#条件2
      ]
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>假设上述查询的执行得到以下结果，best_fields策略强调hits中单个字段的评分权重。打个比方：每一条hit代表一个奥运会的参加国，每个字段代表该国家的参赛运动员，但是限定每个国家只能派出一名运动员，其成绩就代表该国家的成绩，最后以该运动员的成绩代表国家进行排名。所谓“best_fields”就是说最好的字段嘛，用最好的字段的评分代表当前文档的最终评分，即侧重字段权重。在这个例子中，多个查询条件并未起到关键性作用。</p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/image.png" alt=""></p> <h4 id="_6-15-2-tie-breaker参数"><a href="#_6-15-2-tie-breaker参数" class="header-anchor">#</a> 6.15.2 tie_breaker参数</h4> <p>在best_fields策略中给其他剩余字段设置的权重值，取值范围 [0,1]，其中 0 代表使用 dis_max 最佳匹配语句的普通逻辑，1表示所有匹配语句同等重要。最佳的精确值需要根据数据与查询调试得出，但是合理值应该与零接近（处于 0.1 - 0.4 之间），这样就不会颠覆 dis_max （Disjunction Max Query）最佳匹配性质的根本。</p> <p>在上面例子中，如果一个国家仅仅由一个运动员的成绩来决定，显然不是很有代表性，因为一个国家可能整体实力很弱，但是有一个运动员（假设叫做阿尔法）就是特别的出类拔萃，世界第一！但是其他人都很弱，这时他就不能代表整个国家的实力了。反而可能另一个国家，虽然国内成绩最好的运动员没有“阿尔法”的成绩好，但是这个国家包揽了世界的第二名到第十名，并且实力比较接近，那这样这个国家的整体实力仍然是可以排第一的。所以我们不应该让第一名完全代表一个国家的成绩，一个更好的做法是：每个国家的最终成绩由所有运动员的成绩经过计算得来，每个运动员的成绩都可能影响总成绩，但是这个国家排名第一的运动员的成绩占的权重最大。这种做法更容易凸显一个国家的整体实力，这个整体实力就等价于我们搜索结果排名中的相关度。</p> <p><strong>用法：</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET product/_search
{
  &quot;query&quot;: {
    &quot;dis_max&quot;: {
      &quot;queries&quot;: [
        { &quot;match&quot;: { &quot;name&quot;: &quot;super charge&quot; }},
        { &quot;match&quot;: { &quot;desc&quot;: &quot;super charge&quot; }}
      ],
      &quot;tie_breaker&quot;: 0.3 # 代表次要评分字段的权重是 0.3
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>类比</strong></p> <p><strong>以下两个查询等价</strong></p> <p>查询1</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET product/_search
{
  &quot;query&quot;: {
    &quot;dis_max&quot;: {
      &quot;queries&quot;: [
        {
          &quot;match&quot;: {
            &quot;name&quot;: {
              &quot;query&quot;: &quot;chiji shouji&quot;,
              &quot;boost&quot;: 2	# name字段评分两倍权重
            }
          }
        },
        {
          &quot;match&quot;: {
            &quot;desc&quot;: &quot;chiji shouji&quot;
          }
        }
      ],
      &quot;tie_breaker&quot;: 0.3
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>查询2</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET product/_search
{
  &quot;query&quot;: {
    &quot;multi_match&quot; : {
      &quot;query&quot;:      &quot;super charge&quot;,
      &quot;type&quot;:       &quot;best_fields&quot;, // 默认
      &quot;fields&quot;:     [ &quot;name^2&quot;, &quot;desc&quot; ], # name字段评分两倍权重
      &quot;tie_breaker&quot;: 0.3
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_6-15-3-most-fields"><a href="#_6-15-3-most-fields" class="header-anchor">#</a> 6.15.3 most_fields</h4> <p><strong>概念</strong></p> <p>侧重于“查询”维度，单个查询条件的得分权重大，如果一次请求中，对于同一个doc，匹配到某个term的field越多，则越优先排序。</p> <p><strong>类比</strong></p> <p><strong>以下两个查询脚本等价</strong></p> <p>查询1：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 下面查询中包含两个查询条件
GET product/_search
{
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;should&quot;: [
        {
          &quot;match&quot;: {
            &quot;name&quot;: &quot;chiji shouji&quot;
          }
        },
        {
          &quot;match&quot;: {
            &quot;desc&quot;: &quot;chiji shouji&quot;
          }
        }
      ]
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>查询2</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET product/_search
{
  &quot;query&quot;: {
    &quot;multi_match&quot;: {
      &quot;query&quot;: &quot;chiji shouji&quot;,
      &quot;type&quot;: &quot;most_fields&quot;,
      &quot;fields&quot;: [
        &quot;name&quot;,
        &quot;desc&quot;
      ]
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_6-15-4-cross-fields"><a href="#_6-15-4-cross-fields" class="header-anchor">#</a> 6.15.4 cross_fields</h4> <p>**注意：**理解“cross_fields”的概念之前，需要对ES的评分规则有基本的了解，戳：<a href="https://www.yuque.com/u1230450/hg3b38/tgapcl" target="_blank" rel="noopener noreferrer">评分<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，学习ES评分的基本原理</p> <p><strong>概念</strong></p> <p>将任何与任一查询匹配的文档作为结果返回，但只将最佳匹配的评分作为查询的评分结果返回</p> <p><strong>用法</strong></p> <p>以下查询语义：</p> <ul><li><code>吴</code> 必须包含在 name.姓 或者 name.名 里</li> <li><code>磊</code> 必须包含在 name.姓 或者 name.名 里</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET teacher/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;multi_match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;吴磊&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross_fields&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;name.姓&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;name.名&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;operator&quot;</span><span class="token operator">:</span> <span class="token string">&quot;or&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>案例</strong></p> <p>假设我们有如下“teacher”索引，索引中包含了“name”字段，包含“姓”和“名”两个field（案例中使用中文为方便观察和理解，切勿在生产环境中使用中文命名，一定要遵循命名规范）。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST /teacher/_bulk
{
  &quot;index&quot;: {
    &quot;_id&quot;: &quot;1&quot;
  }
}{
  &quot;name&quot;: {
    &quot;姓&quot;: &quot;吴&quot;,
    &quot;名&quot;: &quot;磊&quot;
  }
}{
  &quot;index&quot;: {
    &quot;_id&quot;: &quot;2&quot;
  }
}    {
  &quot;name&quot;: {
    &quot;姓&quot;: &quot;连&quot;,
    &quot;名&quot;: &quot;鹏鹏&quot;
  }
}
....
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>我们执行以上代码创建teacher索引，并且执行以下查询语句</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 语义： 默认分词器的对“吴磊”的分词结果为“吴”和“磊”
# name.姓 中包含 “吴” 或者 “磊”  
# OR  
# name.名 中包含 “吴” 或者 “磊” 
# 如果设置了&quot;operator&quot;: &quot;and&quot;，则中间 OR 的关系变为 
ANDGET teacher/_search
{
  &quot;query&quot;: {
    &quot;multi_match&quot;: {
      &quot;query&quot;: &quot;吴 磊&quot;,
      &quot;type&quot;: &quot;most_fields&quot;,
      &quot;fields&quot;: [
        &quot;name.姓&quot;,
        &quot;name.名&quot;
      ]
      // ,&quot;operator&quot;: &quot;and&quot;    
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>根据上面查询的语义，我们期望的结果是：姓为“吴”并且名为“磊”的doc评分最高，然而结果却如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;took&quot;: 3,
  &quot;timed_out&quot;: false,
  &quot;_shards&quot;: {
    &quot;total&quot;: 1,
    &quot;successful&quot;: 1,
    &quot;skipped&quot;: 0,
    &quot;failed&quot;: 0
  },
  &quot;hits&quot;: {
    &quot;total&quot;: {
      &quot;value&quot;: 9,
      &quot;relation&quot;: &quot;eq&quot;
    },
    &quot;max_score&quot;: 2.4548545,
    &quot;hits&quot;: [
      {
        &quot;_index&quot;: &quot;teacher&quot;,
        &quot;_type&quot;: &quot;_doc&quot;,
        &quot;_id&quot;: &quot;8&quot;,
        &quot;_score&quot;: 2.4548545,
        &quot;_source&quot;: {
          &quot;name&quot;: {
            &quot;姓&quot;: &quot;帅&quot;,
            &quot;名&quot;: &quot;吴&quot;
          }
        }
      },
      {
        &quot;_index&quot;: &quot;teacher&quot;,
        &quot;_type&quot;: &quot;_doc&quot;,
        &quot;_id&quot;: &quot;1&quot;,
        &quot;_score&quot;: 2.03873,
        &quot;_source&quot;: {
          &quot;name&quot;: {
            &quot;姓&quot;: &quot;吴&quot;,
            &quot;名&quot;: &quot;磊&quot;
          }
        }
      },
      {
        &quot;_index&quot;: &quot;teacher&quot;,
        &quot;_type&quot;: &quot;_doc&quot;,
        &quot;_id&quot;: &quot;5&quot;,
        &quot;_score&quot;: 1.060872,
        &quot;_source&quot;: {
          &quot;name&quot;: {
            &quot;姓&quot;: &quot;吴&quot;,
            &quot;名&quot;: &quot;亦凡&quot;
          }
        }
      },
      {
        &quot;_index&quot;: &quot;teacher&quot;,
        &quot;_type&quot;: &quot;_doc&quot;,
        &quot;_id&quot;: &quot;6&quot;,
        &quot;_score&quot;: 1.060872,
        &quot;_source&quot;: {
          &quot;name&quot;: {
            &quot;姓&quot;: &quot;吴&quot;,
            &quot;名&quot;: &quot;京&quot;
          }
        }
      },
      {
        &quot;_index&quot;: &quot;teacher&quot;,
        &quot;_type&quot;: &quot;_doc&quot;,
        &quot;_id&quot;: &quot;7&quot;,
        &quot;_score&quot;: 1.060872,
        &quot;_source&quot;: {
          &quot;name&quot;: {
            &quot;姓&quot;: &quot;吴&quot;,
            &quot;名&quot;: &quot;彦祖&quot;
          }
        }
      },
      {
        &quot;_index&quot;: &quot;teacher&quot;,
        &quot;_type&quot;: &quot;_doc&quot;,
        &quot;_id&quot;: &quot;9&quot;,
        &quot;_score&quot;: 0.977858,
        &quot;_source&quot;: {
          &quot;name&quot;: {
            &quot;姓&quot;: &quot;连&quot;,
            &quot;名&quot;: &quot;磊&quot;
          }
        }
      },
      {
        &quot;_index&quot;: &quot;teacher&quot;,
        &quot;_type&quot;: &quot;_doc&quot;,
        &quot;_id&quot;: &quot;10&quot;,
        &quot;_score&quot;: 0.977858,
        &quot;_source&quot;: {
          &quot;name&quot;: {
            &quot;姓&quot;: &quot;周&quot;,
            &quot;名&quot;: &quot;磊&quot;
          }
        }
      },
      {
        &quot;_index&quot;: &quot;teacher&quot;,
        &quot;_type&quot;: &quot;_doc&quot;,
        &quot;_id&quot;: &quot;11&quot;,
        &quot;_score&quot;: 0.977858,
        &quot;_source&quot;: {
          &quot;name&quot;: {
            &quot;姓&quot;: &quot;张&quot;,
            &quot;名&quot;: &quot;磊&quot;
          }
        }
      },
      {
        &quot;_index&quot;: &quot;teacher&quot;,
        &quot;_type&quot;: &quot;_doc&quot;,
        &quot;_id&quot;: &quot;12&quot;,
        &quot;_score&quot;: 0.977858,
        &quot;_source&quot;: {
          &quot;name&quot;: {
            &quot;姓&quot;: &quot;马&quot;,
            &quot;名&quot;: &quot;磊&quot;
          }
        }
      }
    ]
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br></div></div><p>上面结果显示，名叫“帅磊”的doc排在了最前面，即便我们使用best_fields策略结果也是“帅磊”评分最高，因为导致这个结果的原因和使用哪种搜索策略并无关系。这些然不是我们希望的结果。那么导致上述问题的原因是什么呢？看以下三条基本的评分规则：</p> <p><strong>评分基本规则：</strong></p> <ul><li><p>词频（TF term frequency ）：关键词在每个doc中出现的次数，词频越高，评分越高</p></li> <li><p>反词频（ IDF inverse doc frequency）：关键词在整个索引中出现的次数，反词频越高，评分越低</p></li> <li><p>每个doc的长度，越长相关度评分越低</p></li></ul> <p><strong>分析结果：</strong></p> <p>在上述案例中，“吴磊”作为预期结果，其中“吴”字作为姓氏是非常常见的，“磊”作为名也是非常常见的。反应在索引中，他们的IDF都是非常高的，而反词频越高则评分越低，因此吴磊在索引中的IDF评分则会很低。</p> <p>而“帅磊”中“帅”作为姓氏却是非常少见的，因此IDF的得分就很高。在词频相同的情况下就会导致以上不符合常理的搜索预期。</p> <p><strong>解决办法：</strong></p> <p>为了避免某一个字段的词频或者反词频对结果产生巨大影响，我们需要把“姓”和“名”作为一个整体来查询，体现在代码上即：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 吴必须包含在 name.姓 或者 name.名里
# 并且#磊 必须包含在 name.姓 或者 name.名里
GET teacher/_search
{
  &quot;query&quot;: {
    &quot;multi_match&quot;: {
      &quot;query&quot;: &quot;吴磊&quot;,
      &quot;type&quot;: &quot;cross_fields&quot;,
      &quot;fields&quot;: [
        &quot;name.姓&quot;,
        &quot;name.名&quot;
      ],
      &quot;operator&quot;: &quot;and&quot;
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_6-16-地理位置搜索"><a href="#_6-16-地理位置搜索" class="header-anchor">#</a> 6.16 地理位置搜索</h3> <h4 id="_6-16-1-两种数据类型"><a href="#_6-16-1-两种数据类型" class="header-anchor">#</a> 6.16.1 两种数据类型</h4> <p><strong>geo_point：</strong></p> <p><strong>概念</strong>：经纬度坐标，只支持WGS84坐标系，坐标范围Lat值为[-90,90]，Lon为[-180,180]</p> <ul><li><p>latitude：维度  缩写：lat</p></li> <li><p>longitude：经度  缩写：lon</p></li> <li><p>ignore_malformed：则忽略格式错误的地理位置。如果<code>false</code>（默认）</p></li></ul> <p><strong>五种存储方式</strong></p> <p><strong>Geo_shape</strong></p> <p><strong>概念</strong>：ES的特殊类型之一，用来描述复杂的几何图形的类型，比如点、线、面，多边形等二维几何模型。</p> <ul><li>GeoJSON：GeoJSON是一种用于编码各种地理数据结构的格式，支持以下几种几何类型：
<ul><li>Point：点</li> <li>LineString：线段</li> <li>Polygon：多边形</li> <li>MultiPoint：多点</li> <li>MultiLineString：多线段</li> <li>MultiPolygon：多边形集合</li> <li>Feature：具有其他属性的对象</li></ul></li> <li>WKT（Well-Known Text）：POINT(125.6 10.1)</li></ul> <p><strong>GeoJSON（OGC）和WKT到Elasticsearch类型的映射关系</strong></p> <table><thead><tr><th>GeoJSON类型</th> <th>WKT类型</th> <th>Elasticsearch类型</th> <th>描述</th></tr></thead> <tbody><tr><td><strong>Point</strong></td> <td>POINT</td> <td>point</td> <td>单个地理坐标。注意：Elasticsearch仅使用WGS-84坐标。</td></tr> <tr><td><strong>LineString</strong></td> <td>LINESTRING</td> <td>linestring</td> <td>给定两个或两个以上点的任意线。</td></tr> <tr><td><strong>Polygon</strong></td> <td>POLYGON</td> <td>polygon</td> <td>一个封闭的多边形，其第一个点和最后一个点必须匹配，因此需要n + 1顶点创建一个带n边的多边形和一个最小的4顶点。</td></tr> <tr><td><strong>MultiPoint</strong></td> <td>MULTIPOINT</td> <td>multipoint</td> <td>一组未连接但可能相关的点。</td></tr> <tr><td><strong>MultiLineString</strong></td> <td>MULTILINESTRING</td> <td>multilinestring</td> <td>单独的线串数组。</td></tr> <tr><td><strong>MultiPolygon</strong></td> <td>MULTIPOLYGON</td> <td>multipolygon</td> <td>一组单独的多边形。</td></tr> <tr><td><strong>GeometryCollection</strong></td> <td>GEOMETRYCOLLECTION</td> <td>geometrycollection</td> <td>与JSON形状相似的GeoJSON形状， multi*但可以同时存在多种类型（例如，Point和LineString）。</td></tr> <tr><td><strong>N/A</strong></td> <td>BBOX</td> <td>envelope</td> <td>通过仅指定左上和右下点指定的边界矩形。</td></tr> <tr><td><strong>N/A</strong></td> <td>N/A</td> <td>circle</td> <td>由中心点和半径指定的圆，单位为，默认为METERS。</td></tr></tbody></table> <h4 id="_6-16-2-四种查询"><a href="#_6-16-2-四种查询" class="header-anchor">#</a> 6.16.2 四种查询</h4> <ol><li><p>矩形查询（geo_bounding box）</p> <p>概念：在同一个平面内，两个点确定一个矩形，搜索矩形内的坐标。</p> <blockquote><p>top_left：矩形左上点坐标</p> <p>bottom_right：矩形右上角表</p></blockquote></li> <li><p>半径查询（geo_distance）</p> <p>概念：以某个点为圆心查找指定半径的圆内的坐标。</p> <blockquote><ul><li>distance：距离单位，默认是米，支持以下选项
<ul><li>Mile（英里）：mi 或者 miles</li> <li>Yard（码）：yd  或者 yards</li> <li>Feet（英尺）：ft 或者 feet</li> <li>Inch（英寸）：<code>in</code> 或者 inch</li> <li>Kilometer（公里）：<code>km</code> 或者 kilometers</li> <li>Meter（米）：m 或者 meters</li> <li>Centimeter（厘米）：<code>cm</code> 或者 centimeters</li> <li>Millimeter（毫米）： mm  或者 millimeters</li> <li>Nautical mile（海里）： NM ,  nmi , 或者 nauticalmiles</li></ul></li> <li>distance_type：计算距离的方式
<ul><li>arc（默认值）：更准确，但是速度慢</li> <li>plane：（更快，但在长距离和极点附近不准确）</li></ul></li></ul></blockquote></li> <li><p>多边形（geo_polygon）</p> <p>概念：查找给定多个点连成的多边形内的坐标。</p></li> <li><p>特殊几何图形（geo_shape）</p> <p>概念：支持指定几何图形相交、包含或是不相交等图形检索</p> <blockquote><ul><li>Inline Shape Definition：内联形状</li> <li>Pre-Indexed Shape：预定义形状
<ul><li><code>id</code>- 包含预索引形状的文档ID。</li> <li><code>index</code>- 索引的名称，其中预索引形状为：默认形状。</li> <li>routing- 非必须。</li> <li><code>path</code>- 包含预索引形状的指定路径，默认形状。</li></ul></li> <li>Spatial Relations：空间关系
<ul><li>INTERSECTS<code>- (default) Return all documents whose</code>shape<code>field intersects the query geometry。</code></li> <li>DISJOINT - Return all documents whose <code>shape</code> field has nothing in common with the query geometry</li> <li>WITHIN - Return all documents whose <code>shape</code> field is within the query geometry。</li> <li>CONTAINS- Return all documents whose <code>shape</code> field contains the query geometry。</li></ul></li></ul></blockquote></li></ol> <h4 id="_6-16-3-地理几何分类-geo-shape-type"><a href="#_6-16-3-地理几何分类-geo-shape-type" class="header-anchor">#</a> 6.16.3 地理几何分类（geo_shape type）</h4> <ul><li><p>点（point）</p></li> <li><p>矩形（envelope）</p></li> <li><p>多边形 （polygon）</p></li> <li><p>圆形（circle）</p></li></ul> <h4 id="_6-16-4-圆形处理精度解释"><a href="#_6-16-4-圆形处理精度解释" class="header-anchor">#</a> 6.16.4 圆形处理精度解释</h4> <p>表示圆的多边形的精度定义为error_distance。这种差异越小，多边形越接近理想圆。下表是旨在帮助捕获在给定不同输入的情况下圆的半径如何影响多边形的边数的表格。最小边数为4，最大为1000。</p> <table><thead><tr><th style="text-align:center;"><strong>error_distance</strong></th> <th style="text-align:center;"><strong>半径（米）</strong></th> <th style="text-align:center;"><strong>多边形的边数</strong></th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td style="text-align:center;">1</td> <td style="text-align:center;">4</td></tr> <tr><td style="text-align:center;">1</td> <td style="text-align:center;">10</td> <td style="text-align:center;">14</td></tr> <tr><td style="text-align:center;">1</td> <td style="text-align:center;">100</td> <td style="text-align:center;">45</td></tr> <tr><td style="text-align:center;">1</td> <td style="text-align:center;">1,000</td> <td style="text-align:center;">141</td></tr> <tr><td style="text-align:center;">1</td> <td style="text-align:center;">10,000</td> <td style="text-align:center;">445</td></tr> <tr><td style="text-align:center;">1</td> <td style="text-align:center;">100,000</td> <td style="text-align:center;">1000</td></tr></tbody></table> <h3 id="_6-17-dsl语言高级查询"><a href="#_6-17-dsl语言高级查询" class="header-anchor">#</a> 6.17 DSL语言高级查询</h3> <p>Domain Specific Language。Elasticsearch provides a ful1 Query DSL based on JSON to define queries。</p> <p>Elasticsearch提供了基于JSON的DSL来定义查询。<strong>DSL由叶子查询子句和复合查询子句两种子句组成</strong>。</p> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/11.png" alt=""></p> <p>​</p> <p><strong>2.无查询条件</strong></p> <p>无查询条件是查询所有，默认是查询所有的，或者使用match_all表示所有</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_doc/_search
{
&quot;query&quot;:{
&quot;match_all&quot;:{}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>3.有查询条件</strong></p> <p><strong>3.1 叶子条件查询(单字段查询条件)</strong></p> <p><strong>3.1.1 模糊匹配</strong></p> <p>模糊匹配主要是针对文本类型的字段，文本类型的字段会对内容进行分词，对查询时，也会对搜索条件进行分词，然后通过倒排索引查找到匹配的数据，模糊匹配主要通过match等参数来实现</p> <ul><li>match : 通过match关键词模糊匹配条件内容</li> <li>prefix : 前缀匹配</li> <li>regexp : 通过正则表达式来匹配数据</li></ul> <p><strong>match的复杂用法</strong></p> <p>match条件还支持以下参数：</p> <ul><li><p>query : 指定匹配的值</p></li> <li><p>operator : 匹配条件类型</p></li> <li><ul><li>and : 条件分词后都要匹配</li> <li>or : 条件分词后有一个匹配即可(默认)</li></ul></li> <li><p>minmum_should_match : 指定最小匹配的数量</p></li></ul> <p><strong>3.1.2 精确匹配</strong></p> <ul><li>term : 单个条件相等</li> <li>terms : 单个字段属于某个值数组内的值</li> <li>range : 字段属于某个范围内的值</li> <li>exists : 某个字段的值是否存在</li> <li>ids : 通过ID批量查询</li></ul> <p><strong>3.2 组合条件查询(多条件查询)</strong></p> <p>组合条件查询是将叶子条件查询语句进行组合而形成的一个完整的查询条件</p> <ul><li><p>bool : 各条件之间有and,or或not的关系</p></li> <li><ul><li>must : 各个条件都必须满足，即各条件是and的关系</li> <li>should : 各个条件有一个满足即可，即各条件是or的关系</li> <li>must_not : 不满足所有条件，即各条件是not的关系</li> <li>filter : 不计算相关度评分，它不计算_score即相关度评分，效率更高</li></ul></li> <li><p>constant_score : 不计算相关度评分</p></li></ul> <p><strong>must/filter/shoud/must_not</strong> 等的子条件是通过 <strong>term/terms/range/ids/exists/match</strong> 等叶子条件为参数的</p> <p>注：以上参数，当只有一个搜索条件时，must等对应的是一个对象，当是多个条件时，对应的是一个数组</p> <p><strong>3.3 连接查询(多文档合并查询)</strong></p> <ul><li>父子文档查询：parent/child</li> <li>嵌套文档查询: nested</li></ul> <p>3.4 DSL查询语言中存在两种：查询DSL（query DSL）和过滤DSL（filter DSL）</p> <p>它们两个的区别如下图：</p> <p>​    <img src="https://gitee.com/nylg/picture/raw/master/es/21.png" alt=""></p> <p><strong>query DSL</strong></p> <p>在查询上下文中，查询会回答这个问题——“这个文档匹不匹配这个查询，它的相关度高么？”</p> <p>如何验证匹配很好理解，如何计算相关度呢？ES中索引的数据都会存储一个_score分值，分值越高就代表越匹配。另外关于某个搜索的分值计算还是很复杂的，因此也需要一定的时间。</p> <p><strong>filter DSL</strong></p> <p>在过滤器上下文中，查询会回答这个问题——“这个文档匹不匹配？”</p> <p>答案很简单，是或者不是。它不会去计算任何分值，也不会关心返回的排序问题，因此效率会高一点。</p> <p>过滤上下文 是在使用filter参数时候的执行环境，比如在bool查询中使用must_not或者filter</p> <p>另外，经常使用过滤器，ES会自动的缓存过滤器的内容，这对于查询来说，会提高很多性能。</p> <p>一些过滤的情况：</p> <p>​</p> <p><strong>3.5 Query方式查询:案例</strong></p> <ul><li><p>根据名称精确查询姓名 term, term查询不会对字段进行分词查询，会采用精确匹配</p> <p>注意: 采用term精确查询, 查询字段映射类型属于为keyword.</p></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST /es_db/_doc/_search
{
&quot;query&quot;: {
&quot;term&quot;: {
&quot;name&quot;: &quot;admin&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>SQL: select * from student where name = 'admin'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>根据备注信息模糊查询 match, match会根据该字段的分词器，进行分词查询</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST /es_db/_doc/_search
{
&quot;from&quot;: 0,
&quot;size&quot;: 2, 
&quot;query&quot;: {
&quot;match&quot;: {
&quot;address&quot;: &quot;广州&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>SQL: select * from user where address like '%广州%' limit 0, 2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>多字段模糊匹配查询与精准查询 multi_match</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST /es_db/_doc/_search
{
&quot;query&quot;:{
&quot;multi_match&quot;:{
&quot;query&quot;:&quot;张三&quot;,
&quot;fields&quot;:[&quot;address&quot;,&quot;name&quot;]
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>SQL: select * from student  where name like '%张三%' or address like '%张三%' 	
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​</p> <ul><li>未指定字段条件查询 query_string , 含 AND 与 OR 条件</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST /es_db/_doc/_search
{
&quot;query&quot;:{
&quot;query_string&quot;:{
&quot;query&quot;:&quot;广州 OR 长沙&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>指定字段条件查询 query_string , 含 AND 与 OR 条件</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST /es_db/_doc/_search
{
&quot;query&quot;:{
&quot;query_string&quot;:{
&quot;query&quot;:&quot;admin OR 长沙&quot;,
&quot;fields&quot;:[&quot;name&quot;,&quot;address&quot;]
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>范围查询</li></ul> <p>注：json请求字符串中部分字段的含义</p> <p>​	range：范围关键字</p> <p>​	gte 大于等于</p> <p>​	lte  小于等于</p> <p>​	gt 大于</p> <p>​	lt 小于</p> <p>​	now 当前时间</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST /es_db/_doc/_search
{
&quot;query&quot; : {
&quot;range&quot; : {
&quot;age&quot; : {
&quot;gte&quot;:25,
&quot;lte&quot;:28
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>SQL: select * from user where age between 25 and 28
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​</p> <p>​</p> <ul><li>分页、输出字段、排序综合查询</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST /es_db/_doc/_search
{
&quot;query&quot; : {
&quot;range&quot; : {
&quot;age&quot; : {
&quot;gte&quot;:25,
&quot;lte&quot;:28
}
}
},
&quot;from&quot;: 0,
&quot;size&quot;: 2,
&quot;_source&quot;: [&quot;name&quot;, &quot;age&quot;, &quot;book&quot;],
&quot;sort&quot;: {&quot;age&quot;:&quot;desc&quot;}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>​</p> <p><strong>3.6 Filter过滤器方式查询，它的查询不会计算相关性分值，也不会对结果进行排序, 因此效率会高一点，查询的结果可以被缓存。</strong></p> <p>Filter Context 对数据进行过滤</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST /es_db/_doc/_search
{
&quot;query&quot; : {
&quot;bool&quot; : {
&quot;filter&quot; : {
&quot;term&quot;:{
&quot;age&quot;:25
}
}
}
}
}		
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>​</p> <p><strong>总结:</strong></p> <p><strong>1. match</strong></p> <p>match：模糊匹配，需要指定字段名，但是输入会进行分词，比如&quot;hello world&quot;会进行拆分为hello和world，然后匹配，如果字段中包含hello或者world，或者都包含的结果都会被查询出来，也就是说match是一个部分匹配的模糊查询。查询条件相对来说比较宽松。</p> <p><strong>2. term</strong></p> <p>term:  这种查询和match在有些时候是等价的，比如我们查询单个的词hello，那么会和match查询结果一样，但是如果查询&quot;hello world&quot;，结果就相差很大，因为这个输入不会进行分词，就是说查询的时候，是查询字段分词结果中是否有&quot;hello world&quot;的字样，而不是查询字段中包含&quot;hello world&quot;的字样。当保存数据&quot;hello world&quot;时，elasticsearch会对字段内容进行分词，&quot;hello world&quot;会被分成hello和world，不存在&quot;hello world&quot;，因此这里的查询结果会为空。这也是term查询和match的区别。</p> <p><strong>3. match_phase</strong></p> <p>match_phase：会对输入做分词，但是需要结果中也包含所有的分词，而且<strong>顺序要求一样</strong>。以&quot;hello world&quot;为例，要求结果中必须包含hello和world，而且<strong>还要求他们是连着的，顺序也是固定的</strong>，hello that world不满足，world hello也不满足条件。</p> <p><strong>4. query_string</strong></p> <p>query_string：和match类似，但是match需要指定字段名，<strong>query_string是在所有字段中搜索</strong>，范围更广泛。</p> <h2 id="_7-分词器"><a href="#_7-分词器" class="header-anchor">#</a> 7 分词器</h2> <ol><li><p>normalization：文档规范化,提高召回率</p></li> <li><p>字符过滤器（character filter）：分词之前的预处理，过滤无用字符</p> <blockquote><ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-htmlstrip-charfilter.html" target="_blank" rel="noopener noreferrer">HTML Strip Character Filter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：html_strip
<ul><li>参数：escaped_tags  需要保留的html标签</li></ul></li> <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-mapping-charfilter.html" target="_blank" rel="noopener noreferrer">Mapping Character Filter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：type mapping</li> <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-pattern-replace-charfilter.html" target="_blank" rel="noopener noreferrer">Pattern Replace Character Filter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：type pattern_replace</li></ul></blockquote></li> <li><p>令牌过滤器（token filter）：停用词、时态转换、大小写转换、同义词转换、语气词处理等。</p> <p>比如：has=&gt;have  him=&gt;he  apples=&gt;apple  the/oh/a=&gt;干掉</p></li> <li><p>分词器（tokenizer）：切词</p></li> <li><p>常见分词器：</p> <blockquote><ul><li>standard analyzer：默认分词器，中文支持的不理想，会逐字拆分。</li> <li>pattern tokenizer：以正则匹配分隔符，把文本拆分成若干词项。</li> <li>simple pattern tokenizer：以正则匹配词项，速度比pattern tokenizer快。</li> <li>whitespace analyzer：以空白符分隔	Tim_cookie</li></ul></blockquote></li> <li><p>自定义分词器：custom analyzer</p> <blockquote><ul><li>char_filter：内置或自定义字符过滤器 。</li> <li>token filter：内置或自定义token filter 。</li> <li>tokenizer：内置或自定义分词器。</li></ul></blockquote></li> <li><p>中文分词器：ik分词</p> <ul><li><p>安装和部署</p> <blockquote><ul><li>ik下载地址：https://github.com/medcl/elasticsearch-analysis-ik</li> <li>Github加速器：https://github.com/fhefh2015/Fast-GitHub</li> <li>创建插件文件夹 cd your-es-root/plugins/ &amp;&amp; mkdir ik</li> <li>将插件解压缩到文件夹 your-es-root/plugins/ik</li> <li>重新启动es</li></ul></blockquote></li> <li><p>IK文件描述</p> <blockquote><ul><li><p>IKAnalyzer.cfg.xml：IK分词配置文件</p></li> <li><p>主词库：main.dic</p></li> <li><p>英文停用词：stopword.dic，不会建立在倒排索引中</p></li> <li><p>特殊词库：</p> <ul><li><p>quantifier.dic：特殊词库：计量单位等</p></li> <li><p>suffix.dic：特殊词库：行政单位</p></li> <li><p>surname.dic：特殊词库：百家姓</p></li> <li><p>preposition：特殊词库：语气词</p></li> <li><p>自定义词库：网络词汇、流行词、自造词等</p></li></ul></li></ul></blockquote></li> <li><p>ik提供的两种analyzer</p> <blockquote><p>ik_max_word会将文本做最细粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,中华人民,中华,华人,人民共和国,人民,人,民,共和国,共和,和,国国,国歌”，会穷尽各种可能的组合，适合 Term Query；</p> <p>ik_smart: 会做最粗粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,国歌”，适合 Phrase 查询。</p></blockquote></li> <li><p><strong>热更新</strong></p> <ul><li><p>远程词库文件</p> <blockquote><ol><li><p>优点：上手简单</p></li> <li><p>缺点：</p> <ol><li><p>词库的管理不方便，要操作直接操作磁盘文件，检索页很麻烦</p></li> <li><p>文件的读写没有专门的优化性能不好</p></li> <li><p>多一层接口调用和网络传输</p> <p>解决方案：写一个远程项目提供热更新词。通过ES配置文件中指定远程调用接口，即可ES实时刷新远程接口进行热更新。远程项目代码示例：https://gitee.com/nylg/picture/tree/master/file/iktest</p> <p>![image-20211026150838579](<img src="https://gitee.com/nylg/picture/raw/master/elastic/image-20211026150838579.png" alt=""></p></li></ol></li></ol></blockquote></li> <li><p>ik访问数据库</p> <blockquote><ol><li><p>MySQL驱动版本兼容性</p> <ol><li>https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-versions.html</li> <li>https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-versions.html</li></ol></li> <li><p>驱动下载地址</p> <ol><li>https://mvnrepository.com/artifact/mysql/mysql-connector-java</li></ol> <p>解决方案：重写IK源码，添加MySQL连接步骤 https://gitee.com/nylg/picture/tree/master/file/elasticsearch-analysis-ik-7.10.0</p> <p><img src="https://gitee.com/nylg/picture/raw/master/elastic/image-20211026143529692.png" alt=""></p> <p>然后maven package打包成jar后解压，放到ES节点的plugins目录下，重命名jar解压后的文件名为ik，重启ES节点即可生效，以后更新MySQL库即实现热更新词库。注意IK分词器的MySQL连接驱动版本问题</p></li></ol></blockquote></li></ul></li></ul></li></ol> <h2 id="_8-es客户端-elasticsearch-clients"><a href="#_8-es客户端-elasticsearch-clients" class="header-anchor">#</a> 8 ES客户端：Elasticsearch Clients</h2> <table><thead><tr><th></th> <th><strong>Java API</strong></th> <th><strong>Low Level Client</strong></th> <th><strong>High Level Client</strong></th></tr></thead> <tbody><tr><td><strong>优点</strong></td> <td>性能略好</td> <td>安全，易用，轻耦合，轻依赖，兼容性极好</td> <td>功能全，松耦合，接口稳定</td></tr> <tr><td><strong>缺点</strong></td> <td>重依赖     紧耦合     不安全</td> <td>功能少</td> <td>性能略逊于Java API，兼容性中等</td></tr> <tr><td><strong>兼容性</strong></td> <td>主版本必须相同     次要版本最好相同</td> <td>兼容所有版本</td> <td>主版本必须相同，次要版本向后兼容</td></tr></tbody></table> <h3 id="语言无关性"><a href="#语言无关性" class="header-anchor">#</a> 语言无关性</h3> <ul><li><strong>Java REST Client</strong></li> <li><strong>Java API</strong></li> <li><strong>Python API</strong></li> <li><strong>Go API</strong></li> <li><strong>.Net API</strong></li> <li>PHP API</li> <li>JavaScripts API</li> <li>Ruby API</li> <li>Perl API</li> <li>Eland</li> <li>Rust</li> <li>Community Contributed Clients</li></ul> <h3 id="java-api"><a href="#java-api" class="header-anchor">#</a> Java API</h3> <p><strong>生命周期（生卒年：ES 0.9 - ES 7.x）</strong></p> <p><code>Java API</code>使用的客户端名称叫<code>TransportClient</code>，从7.0.0开始，官方已经不建议使用<code>TransportClient</code>作为ES的Java客户端了，并且从8.0会被彻底删除。</p> <p><strong>注意事项</strong></p> <ul><li><code>TransportClient</code> 使用<code>transport</code>模块（<strong>9300端口</strong>）远程连接到 Elasticsearch 集群，客户端并不加入集群，而是通过获取单个或者多个transport地址来以轮询的方式与他们通信。</li> <li><code>TransportClient</code>使用<code>transport</code>协议与Elasticsearch节点通信，如果客户端的版本和与其通信的ES实例的版本不同，就会出现兼容性问题。而<code>low-level REST</code>使用的是HTTP协议，可以与任意版本ES集群通信。<code>high-level REST</code>是基于<code>low-level REST</code>的。</li></ul> <p><strong>Maven依赖</strong></p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>transport<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>7.12.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>使用</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 创建客户端连接</span>
<span class="token class-name">TransportClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreBuiltTransportClient</span><span class="token punctuation">(</span><span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addTransportAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransportAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">&quot;host1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9300</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addTransportAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransportAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">&quot;host2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 关闭客户端</span>
client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>嗅探器</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Settings</span> settings <span class="token operator">=</span> <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;client.transport.sniff&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TransportClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreBuiltTransportClient</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>Java REST Client</strong>：<code>RestClient</code> 是线程安全的，<code>RestClient</code>使用 Elasticsearch 的 HTTP 服务，默认为<code>9200</code>端口，这一点和<code>transport client</code>不同。</p> <p><strong>生命周期（ES 5.0.0-alpha4至今）</strong></p> <h3 id="java-low-level-rest-client"><a href="#java-low-level-rest-client" class="header-anchor">#</a> Java Low-level REST client</h3> <p>第一个 5.0.0 版 Java REST 客户端，之所以称为低级客户端，是因为它几乎没有帮助 Java 用户构建请求或解析响应。它处理请求的路径和查询字符串构造，但它将 JSON 请求和响应主体视为必须由用户处理的不透明字节数组。</p> <p><strong>特点</strong></p> <ul><li>与任何 Elasticsearch 版本兼容
<ul><li>ES 5.0.0只是发布第一个<code>Java Low-level REST client</code>时的ES版本（2016年），不代表其向前只兼容到5.0，<code>Java Low-level REST client</code>基于Apache HTTP 客户端，它允许使用 HTTP 与任何版本的 Elasticsearch 集群进行通信。</li></ul></li> <li>最小化依赖</li> <li>跨所有可用节点的负载平衡</li> <li>在节点故障和特定响应代码的情况下进行故障转移</li> <li>连接失败惩罚（是否重试失败的节点取决于它连续失败的次数；失败的尝试越多，客户端在再次尝试同一节点之前等待的时间就越长）</li> <li>持久连接</li> <li>请求和响应的跟踪记录</li> <li>可选的集群节点自动发现（也称为嗅探）</li></ul> <p><strong>Maven依赖</strong></p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-rest-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>7.12.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>初始化</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">RestClient</span> restClient <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">&quot;localhost1&quot;</span><span class="token punctuation">,</span> <span class="token number">9200</span><span class="token punctuation">,</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">&quot;localhost2&quot;</span><span class="token punctuation">,</span> <span class="token number">9200</span><span class="token punctuation">,</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>资源释放</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>restClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>嗅探器</strong></p> <p>允许从正在运行的 Elasticsearch 集群中自动发现节点并将它们设置为现有 RestClient 实例的最小库</p> <p><strong>Maven依赖</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;
    &lt;artifactId&gt;elasticsearch-rest-client-sniffer&lt;/artifactId&gt;
    &lt;version&gt;7.12.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>代码</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 默认每五分钟发现一次</span>
<span class="token class-name">RestClient</span> restClient <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">9200</span><span class="token punctuation">,</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Sniffer</span> sniffer <span class="token operator">=</span> <span class="token class-name">Sniffer</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>restClient<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>资源释放</strong></p> <p><code>Sniffer</code> 对象应该与<code>RestClient</code> 具有相同的生命周期，并在客户端之前关闭。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>sniffer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
restClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>设置嗅探间隔</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">RestClient</span> restClient <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">9200</span><span class="token punctuation">,</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置嗅探间隔为60000毫秒</span>
<span class="token class-name">Sniffer</span> sniffer <span class="token operator">=</span> <span class="token class-name">Sniffer</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>restClient<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setSniffIntervalMillis</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>失败时重启嗅探</strong></p> <p>启用失败时嗅探，也就是在每次失败后，节点列表会立即更新，而不是在接下来的普通嗅探轮中更新。在这种情况下，首先需要创建一个 SniffOnFailureListener 并在 RestClient 创建时提供。此外，一旦稍后创建嗅探器，它需要与同一个 SniffOnFailureListener 实例相关联，它将在每次失败时收到通知，并使用嗅探器执行额外的嗅探轮</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SniffOnFailureListener</span> sniffOnFailureListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SniffOnFailureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RestClient</span> restClient <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">9200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setFailureListener</span><span class="token punctuation">(</span>sniffOnFailureListener<span class="token punctuation">)</span> <span class="token comment">//将失败侦听器设置为 RestClient实例 </span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Sniffer</span> sniffer <span class="token operator">=</span> <span class="token class-name">Sniffer</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>restClient<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setSniffAfterFailureDelayMillis</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span> <span class="token comment">//在嗅探失败时，不仅节点在每次失败后都会更新，而且还会比平常更早安排额外的嗅探轮次，默认情况下是在失败后一分钟，假设事情会恢复正常并且我们想要检测尽快地。可以在 Sniffer 创建时通过 setSniffAfterFailureDelayMillis 方法自定义所述间隔。请注意，如果如上所述未启用故障嗅探，则最后一个配置参数无效。</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sniffOnFailureListener<span class="token punctuation">.</span><span class="token function">setSniffer</span><span class="token punctuation">(</span>sniffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将 Sniffer 实例设置为失败侦听器</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="java-high-level-rest-client"><a href="#java-high-level-rest-client" class="header-anchor">#</a> Java High Level REST Client</h3> <p>生命周期（ES 5.0.0-alpha4至今）</p> <p>Java 高级 REST 客户端在 Java 低级 REST 客户端之上运行。它的主要目标是公开 API 特定的方法，接受请求对象作为参数并返回响应对象，以便请求编组和响应解组由客户端本身处理。要求Elasticsearch版本为<code>2.0</code>或者更高。</p> <p><strong>客户端优缺点及兼容性建议</strong></p> <p>阅读：https://www.elastic.co/cn/blog/benchmarking-rest-client-transport-client</p> <h3 id="java-api-rest-api-优缺"><a href="#java-api-rest-api-优缺" class="header-anchor">#</a> Java API / Rest API 优缺</h3> <p><strong>Java API：</strong></p> <blockquote><ul><li><strong>优点</strong>：
<ul><li>性能略好：</li> <li>吞吐量大：<code>Transport Client</code>的批量索引吞吐量比HTTP 客户端大 4% 到 7%（实验室条件）</li></ul></li> <li><strong>缺点</strong>：
<ul><li>重依赖：并非单独意义上的“客户端”，其依赖于lucene、log4j2等，可能会产生依赖冲突</li> <li>不安全：Java API通过传输层调用服务，不安全。</li> <li>重耦合：和ES核心服务有共同依赖，版本兼容性要求高。</li></ul></li></ul></blockquote> <p><strong>Rest API:</strong></p> <blockquote><p><strong>优点</strong></p> <ul><li>安全：<code>REST API</code>使用单一的集群入口点，可以通过 HTTPS 保障数据安全性，传输层只用于内部节点到节点的通信。</li> <li>易用：客户端只通过 REST 层而不是通过传输层调用服务，可以大大简化代码编写</li></ul> <p><strong>缺点</strong></p> <ul><li><p>性能略逊于<code>Java API</code>，但是差距不大</p></li> <li><h5 id="low-level-client"><a href="#low-level-client" class="header-anchor">#</a> Low level Client</h5> <ul><li><strong>优点</strong>：
<ul><li>轻依赖：Apache HTTP 异步客户端及其传递依赖项（Apache HTTP 客户端、Apache HTTP Core、Apache HTTP Core NIO、Apache Commons Codec 和 Apache Commons Logging）</li> <li>兼容性强：兼容所有ES版本</li></ul></li> <li><strong>缺点</strong>：
<ul><li>功能少：显而易见，轻量化带来的必然后果</li></ul></li></ul></li> <li><h5 id="high-level-client"><a href="#high-level-client" class="header-anchor">#</a> High level Client</h5> <ul><li><strong>优点</strong>：
<ul><li>功能强大：支持所有ES的API调用。</li> <li>松耦合：客户端和ES核心服务完全独立，无共同依赖。</li> <li>接口稳定：REST API 比与 Elasticsearch 版本完全匹配的<code>Transport Client</code>接口稳定得多。</li></ul></li> <li><strong>缺点</strong>：
<ul><li>兼容性中等：基于Low Level Client，只向后兼容ES的大版本，比如6.0的客户端兼容6.x（即6.0之后的版本），但是6.1的客户端未必支持所有6.0ES的API，但是这并不是什么大问题，咱们使用相同版本的客户端和服务端即可，而且不会带来其他问题。</li></ul></li></ul></li></ul></blockquote> <h2 id="_9-spring-data-elasticsearch"><a href="#_9-spring-data-elasticsearch" class="header-anchor">#</a> 9 Spring Data Elasticsearch</h2> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <p>Spring Data 的目的是用统一的接口，适配所有不同的存储类型。</p> <p>Spring Data Elasticsearch是Spring Data的一个子项目，该项目旨在为新数据存储提供熟悉且一致的基于 Spring 的编程模型，同时保留特定于存储的功能和功能。Spring Data Elasticsearch是一个以 POJO 为中心的模型，用于与 Elastichsearch 文档交互并轻松编写 Repository 风格的数据访问层。</p> <p>Spring Data 存储库抽象中的中心接口是Repository. 它需要域类来管理以及域类的 ID 类型作为类型参数。此接口主要用作标记接口，以捕获要使用的类型并帮助您发现扩展此接口的接口。该CrudRepository接口为正在管理的实体类提供复杂的 CRUD 功能。</p> <h3 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h3> <ul><li>Spring 配置支持使用基于 Java 的<code>@Configuration</code>类或用于 ES 客户端实例的 XML 命名空间。</li> <li><code>ElasticsearchTemplate</code>提高执行常见 ES 操作的生产力的助手类。包括文档和 POJO 之间的集成对象映射。</li> <li>功能丰富的对象映射与 Spring 的转换服务集成</li> <li>基于注释的映射元数据但可扩展以支持其他元数据格式</li> <li><code>Repository</code>接口的自动实现，包括对自定义查找器方法的支持。</li> <li>对存储库的 CDI 支持</li></ul> <h3 id="官网"><a href="#官网" class="header-anchor">#</a> 官网</h3> <p>https://spring.io/projects/spring-data-elasticsearch</p> <h3 id="兼容性-必看"><a href="#兼容性-必看" class="header-anchor">#</a> 兼容性(必看)</h3> <p>https://docs.spring.io/spring-data/elasticsearch/docs/4.2.1/reference/html/#preface.requirements</p> <h3 id="文档地址"><a href="#文档地址" class="header-anchor">#</a> 文档地址</h3> <p>https://docs.spring.io/spring-data/elasticsearch/docs/4.2.1/reference/html/#reference</p> <h3 id="优缺点"><a href="#优缺点" class="header-anchor">#</a> 优缺点</h3> <ul><li>优点：用统一的接口，适配所有不同的存储类型，学习成本低。</li> <li>缺点：适配的版本要比原生的 API 要慢。这个取决于 Spring Data Elasticsearch 团队的开发速度。无法使用ES的一些新特性</li></ul> <h3 id="maven-repository"><a href="#maven-repository" class="header-anchor">#</a> Maven Repository</h3> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="注解"><a href="#注解" class="header-anchor">#</a> 注解</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Document</span>：在类级别应用，以指示该类是映射到数据库的候选类。最重要的属性包括：

indexName：用于存储此实体的索引的名称。它可以包含类似于“日志<span class="token operator">-</span>#<span class="token punctuation">{</span><span class="token class-name">T</span>（<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>LocalDate</span>）<span class="token punctuation">.</span>now（）<span class="token punctuation">.</span>toString（）<span class="token punctuation">}</span>”

type <span class="token operator">:</span>映射类型。如果未设置，则使用该类的小写简单名称。（自<span class="token number">4.0</span>版起已弃用）

createIndex：标记是否在存储库引导时创建索引。默认值为<span class="token boolean">true</span>。请参阅自动创建带有相应映射的索引

versionType：版本管理的配置。默认值为外部 <span class="token punctuation">.</span>

<span class="token annotation punctuation">@Id</span>：在字段级别应用，以标记用于标识的字段。

<span class="token annotation punctuation">@Transient</span>：默认情况下，存储或检索文档时，所有字段都映射到文档，此批注不包括该字段。

<span class="token annotation punctuation">@PersistenceConstructor</span>：标记在从数据库实例化对象时要使用的给定构造函数（甚至是包受保护的构造函数）。构造函数参数按名称映射到检索文档中的键值。

<span class="token annotation punctuation">@Field</span>：应用于字段级别并定义字段的属性，大多数属性映射到相应的<span class="token class-name">Elasticsearch</span>映射定义（以下列表不完整，请查看注释<span class="token class-name">Javadoc</span>以获取完整的参考）：

name：将在<span class="token class-name">Elasticsearch</span>文档中表示的字段的名称，如果未设置，则使用<span class="token class-name">Java</span>字段名称。

type：字段类型，可以是<span class="token class-name">Text</span>，关键字，<span class="token class-name">Long</span>，<span class="token class-name">Integer</span>，<span class="token class-name">Short</span>，<span class="token class-name">Byte</span>，<span class="token class-name">Double</span>，<span class="token class-name">Float</span>，<span class="token class-name">Half_Float</span>，<span class="token class-name">Scaled_Float</span>，日期，日期<span class="token class-name">Nanos</span>，<span class="token class-name">Boolean</span>，<span class="token class-name">Binary</span>，<span class="token class-name">Integer_Range</span>，<span class="token class-name">Float_Range</span>，<span class="token class-name">Long_Range</span>，<span class="token class-name">Double</span>ˉ<span class="token class-name">Range</span>，<span class="token class-name">Date</span>ˉ<span class="token class-name">Range</span>，<span class="token class-name">Object</span>，<span class="token class-name">Nested</span>，<span class="token class-name">Ip</span>，<span class="token class-name">TokenCount</span>，percollator，flatten，搜索。请参阅<span class="token class-name">Elasticsearch</span>映射类型

format：一个或多个内置日期格式，请参阅下一节格式数据映射 <span class="token punctuation">.</span>

pattern：一个或多个自定义日期格式，请参阅下一节格式数据映射 <span class="token punctuation">.</span>

store：标志是否应将原始字段值存储在<span class="token class-name">Elasticsearch</span>中，默认值为假 <span class="token punctuation">.</span>

analyzer <span class="token punctuation">,</span>搜索分析器 <span class="token punctuation">,</span>normalizer用于指定自定义分析器和规格化器。

<span class="token annotation punctuation">@GeoPoint</span>：将字段标记为地理点如果字段是<span class="token class-name">GeoPoint</span>班级
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="操作类型"><a href="#操作类型" class="header-anchor">#</a> 操作类型</h3> <p>Spring Data Elasticsearch 使用多个接口来定义可以针对 Elasticsearch 索引调用的操作。</p> <ul><li><code>IndexOperations</code>定义索引级别的操作，例如创建或删除索引。</li> <li><code>DocumentOperations</code>定义基于 id 存储、更新和检索实体的操作。</li> <li><code>SearchOperations</code>定义使用查询搜索多个实体的操作</li> <li><code>ElasticsearchOperations</code>结合了<code>DocumentOperations</code>和<code>SearchOperations</code>接口。</li></ul> <h3 id="high-level-rest-client"><a href="#high-level-rest-client" class="header-anchor">#</a> High Level REST Client</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestClientConfig</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractElasticsearchConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">elasticsearchClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">final</span> <span class="token class-name">ClientConfiguration</span> clientConfiguration <span class="token operator">=</span> <span class="token class-name">ClientConfiguration</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token punctuation">.</span><span class="token function">connectedTo</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9200&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">RestClients</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>clientConfiguration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RestHighLevelClient</span> highLevelClient<span class="token punctuation">;</span>
<span class="token class-name">RestClient</span> lowLevelClient <span class="token operator">=</span> highLevelClient<span class="token punctuation">.</span><span class="token function">lowLevelClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        


<span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;spring-data&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token function">randomID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token function">singletonMap</span><span class="token punctuation">(</span><span class="token string">&quot;feature&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;high-level-rest-client&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setRefreshPolicy</span><span class="token punctuation">(</span><span class="token constant">IMMEDIATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IndexResponse</span> response <span class="token operator">=</span> highLevelClient<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/04/21, 18:39:57</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/e4c6b5/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Dubbo服务调用源码解析</div></a> <a href="/pages/0f5882/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">ElasticSearch原理</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/e4c6b5/" class="prev">Dubbo服务调用源码解析</a></span> <span class="next"><a href="/pages/0f5882/">ElasticSearch原理</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/80365f/"><div>
            证券市场基本法律法规
            <!----></div></a> <span class="date">03-13</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/d9e4f4/"><div>
            证券考试规则
            <!----></div></a> <span class="date">03-12</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/cb2c17/"><div>
            金融市场基础知识
            <!----></div></a> <span class="date">03-12</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:cloudjava@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/bigdatajava" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/nylg" title="Gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2014-2024
    <span>wen chao | <a href="https://github.com/bigdatajava/blog-talk/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.b2807c2b.js" defer></script><script src="/assets/js/2.eeaab5de.js" defer></script><script src="/assets/js/76.3a946a81.js" defer></script>
  </body>
</html>

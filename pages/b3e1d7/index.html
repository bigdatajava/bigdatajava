<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Sharding分库分表实战 | wen chao</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3129839_xft6cqs5gc.css">
    <meta name="description" content="架构进阶之路...">
    <meta name="keywords" content="全栈博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,js,ES6,TypeScript,vue">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.237ce36e.css" as="style"><link rel="preload" href="/assets/js/app.b2807c2b.js" as="script"><link rel="preload" href="/assets/js/2.eeaab5de.js" as="script"><link rel="preload" href="/assets/js/267.c9ede946.js" as="script"><link rel="prefetch" href="/assets/js/10.30d760c8.js"><link rel="prefetch" href="/assets/js/100.d2a91f05.js"><link rel="prefetch" href="/assets/js/101.aa15113f.js"><link rel="prefetch" href="/assets/js/102.303aae62.js"><link rel="prefetch" href="/assets/js/103.39dbd83e.js"><link rel="prefetch" href="/assets/js/104.30434bc2.js"><link rel="prefetch" href="/assets/js/105.68d90558.js"><link rel="prefetch" href="/assets/js/106.2a47de1c.js"><link rel="prefetch" href="/assets/js/107.6c92802c.js"><link rel="prefetch" href="/assets/js/108.1a019470.js"><link rel="prefetch" href="/assets/js/109.f2cc4655.js"><link rel="prefetch" href="/assets/js/11.8c97a85c.js"><link rel="prefetch" href="/assets/js/110.8630d06d.js"><link rel="prefetch" href="/assets/js/111.fdf10f1a.js"><link rel="prefetch" href="/assets/js/112.ea841a58.js"><link rel="prefetch" href="/assets/js/113.bd8e761d.js"><link rel="prefetch" href="/assets/js/114.63ed667a.js"><link rel="prefetch" href="/assets/js/115.909a8353.js"><link rel="prefetch" href="/assets/js/116.62dab6c0.js"><link rel="prefetch" href="/assets/js/117.d0ef1d76.js"><link rel="prefetch" href="/assets/js/118.39e6e925.js"><link rel="prefetch" href="/assets/js/119.e0265f93.js"><link rel="prefetch" href="/assets/js/12.156b3963.js"><link rel="prefetch" href="/assets/js/120.4be98e6e.js"><link rel="prefetch" href="/assets/js/121.518d8dd5.js"><link rel="prefetch" href="/assets/js/122.477dd94b.js"><link rel="prefetch" href="/assets/js/123.d6065aca.js"><link rel="prefetch" href="/assets/js/124.c6f965c7.js"><link rel="prefetch" href="/assets/js/125.3ee79c35.js"><link rel="prefetch" href="/assets/js/126.bcc69ad9.js"><link rel="prefetch" href="/assets/js/127.8f3ce1ac.js"><link rel="prefetch" href="/assets/js/128.03c90841.js"><link rel="prefetch" href="/assets/js/129.ab248cd9.js"><link rel="prefetch" href="/assets/js/13.c67aac42.js"><link rel="prefetch" href="/assets/js/130.dd64983e.js"><link rel="prefetch" href="/assets/js/131.6ffe6940.js"><link rel="prefetch" href="/assets/js/132.2a8fed26.js"><link rel="prefetch" href="/assets/js/133.6a7673eb.js"><link rel="prefetch" href="/assets/js/134.c00b7bf2.js"><link rel="prefetch" href="/assets/js/135.59d75ce6.js"><link rel="prefetch" href="/assets/js/136.bcd27d57.js"><link rel="prefetch" href="/assets/js/137.75dd3384.js"><link rel="prefetch" href="/assets/js/138.a2ababbf.js"><link rel="prefetch" href="/assets/js/139.6aa75eaa.js"><link rel="prefetch" href="/assets/js/14.8ab9a27a.js"><link rel="prefetch" href="/assets/js/140.58295019.js"><link rel="prefetch" href="/assets/js/141.8d05c3a5.js"><link rel="prefetch" href="/assets/js/142.18498abf.js"><link rel="prefetch" href="/assets/js/143.20c6bdde.js"><link rel="prefetch" href="/assets/js/144.ac94f8ff.js"><link rel="prefetch" href="/assets/js/145.e135dd8a.js"><link rel="prefetch" href="/assets/js/146.13a537e3.js"><link rel="prefetch" href="/assets/js/147.016b19e9.js"><link rel="prefetch" href="/assets/js/148.d3a909f2.js"><link rel="prefetch" href="/assets/js/149.90d05716.js"><link rel="prefetch" href="/assets/js/15.2b8ce9c5.js"><link rel="prefetch" href="/assets/js/150.e61c5f29.js"><link rel="prefetch" href="/assets/js/151.c81aa646.js"><link rel="prefetch" href="/assets/js/152.82944cc0.js"><link rel="prefetch" href="/assets/js/153.410a3789.js"><link rel="prefetch" href="/assets/js/154.cc1235ef.js"><link rel="prefetch" href="/assets/js/155.1e7fae81.js"><link rel="prefetch" href="/assets/js/156.cfaa0244.js"><link rel="prefetch" href="/assets/js/157.47981f53.js"><link rel="prefetch" href="/assets/js/158.e9c295a1.js"><link rel="prefetch" href="/assets/js/159.50ba3574.js"><link rel="prefetch" href="/assets/js/16.a8b0b084.js"><link rel="prefetch" href="/assets/js/160.5845ca9d.js"><link rel="prefetch" href="/assets/js/161.0e97694f.js"><link rel="prefetch" href="/assets/js/162.3c77226a.js"><link rel="prefetch" href="/assets/js/163.17c9ec79.js"><link rel="prefetch" href="/assets/js/164.7736f87d.js"><link rel="prefetch" href="/assets/js/165.ff7b4f9e.js"><link rel="prefetch" href="/assets/js/166.6956307c.js"><link rel="prefetch" href="/assets/js/167.366611f7.js"><link rel="prefetch" href="/assets/js/168.57345d6b.js"><link rel="prefetch" href="/assets/js/169.25420ee7.js"><link rel="prefetch" href="/assets/js/17.68e41786.js"><link rel="prefetch" href="/assets/js/170.bedd4eac.js"><link rel="prefetch" href="/assets/js/171.374570cf.js"><link rel="prefetch" href="/assets/js/172.2f8bf4a8.js"><link rel="prefetch" href="/assets/js/173.42ea0d36.js"><link rel="prefetch" href="/assets/js/174.0ccfd7c6.js"><link rel="prefetch" href="/assets/js/175.7ab333d2.js"><link rel="prefetch" href="/assets/js/176.c7266816.js"><link rel="prefetch" href="/assets/js/177.d0a95fb6.js"><link rel="prefetch" href="/assets/js/178.2bb652ad.js"><link rel="prefetch" href="/assets/js/179.a8eab386.js"><link rel="prefetch" href="/assets/js/18.8e0d47a1.js"><link rel="prefetch" href="/assets/js/180.9fd22be7.js"><link rel="prefetch" href="/assets/js/181.5d5358d4.js"><link rel="prefetch" href="/assets/js/182.af7d36e2.js"><link rel="prefetch" href="/assets/js/183.dddc555d.js"><link rel="prefetch" href="/assets/js/184.a3396baf.js"><link rel="prefetch" href="/assets/js/185.2f7da675.js"><link rel="prefetch" href="/assets/js/186.92639766.js"><link rel="prefetch" href="/assets/js/187.711debd8.js"><link rel="prefetch" href="/assets/js/188.149256e6.js"><link rel="prefetch" href="/assets/js/189.c118aa93.js"><link rel="prefetch" href="/assets/js/19.770d847c.js"><link rel="prefetch" href="/assets/js/190.4d85ee4e.js"><link rel="prefetch" href="/assets/js/191.ff095a9a.js"><link rel="prefetch" href="/assets/js/192.4b5fe55c.js"><link rel="prefetch" href="/assets/js/193.415828fe.js"><link rel="prefetch" href="/assets/js/194.ce801921.js"><link rel="prefetch" href="/assets/js/195.c668b288.js"><link rel="prefetch" href="/assets/js/196.8825af00.js"><link rel="prefetch" href="/assets/js/197.d09dcd8b.js"><link rel="prefetch" href="/assets/js/198.396382cf.js"><link rel="prefetch" href="/assets/js/199.facc6630.js"><link rel="prefetch" href="/assets/js/20.97979961.js"><link rel="prefetch" href="/assets/js/200.db1ff45e.js"><link rel="prefetch" href="/assets/js/201.ab79fbd5.js"><link rel="prefetch" href="/assets/js/202.46e8525c.js"><link rel="prefetch" href="/assets/js/203.2cc13ae9.js"><link rel="prefetch" href="/assets/js/204.3c8a5bcd.js"><link rel="prefetch" href="/assets/js/205.3d0d8394.js"><link rel="prefetch" href="/assets/js/206.261623f6.js"><link rel="prefetch" href="/assets/js/207.6260c0aa.js"><link rel="prefetch" href="/assets/js/208.0fd63045.js"><link rel="prefetch" href="/assets/js/209.e5eaeeca.js"><link rel="prefetch" href="/assets/js/21.e6565c56.js"><link rel="prefetch" href="/assets/js/210.bccc650e.js"><link rel="prefetch" href="/assets/js/211.c238d796.js"><link rel="prefetch" href="/assets/js/212.dd4703ab.js"><link rel="prefetch" href="/assets/js/213.110becf0.js"><link rel="prefetch" href="/assets/js/214.a90d9da2.js"><link rel="prefetch" href="/assets/js/215.81872845.js"><link rel="prefetch" href="/assets/js/216.2ae9609f.js"><link rel="prefetch" href="/assets/js/217.567657f9.js"><link rel="prefetch" href="/assets/js/218.bc570e81.js"><link rel="prefetch" href="/assets/js/219.32a64945.js"><link rel="prefetch" href="/assets/js/22.92562bc3.js"><link rel="prefetch" href="/assets/js/220.d1605ea9.js"><link rel="prefetch" href="/assets/js/221.c1483dee.js"><link rel="prefetch" href="/assets/js/222.188d3bb6.js"><link rel="prefetch" href="/assets/js/223.b4d7fc4a.js"><link rel="prefetch" href="/assets/js/224.5495522d.js"><link rel="prefetch" href="/assets/js/225.ea320f20.js"><link rel="prefetch" href="/assets/js/226.1f245007.js"><link rel="prefetch" href="/assets/js/227.280e3176.js"><link rel="prefetch" href="/assets/js/228.7ea12e2e.js"><link rel="prefetch" href="/assets/js/229.0697746f.js"><link rel="prefetch" href="/assets/js/23.4b595789.js"><link rel="prefetch" href="/assets/js/230.8efdd773.js"><link rel="prefetch" href="/assets/js/231.44bfbfb5.js"><link rel="prefetch" href="/assets/js/232.24dc2667.js"><link rel="prefetch" href="/assets/js/233.6c77b12b.js"><link rel="prefetch" href="/assets/js/234.1ea57e5c.js"><link rel="prefetch" href="/assets/js/235.efb990b9.js"><link rel="prefetch" href="/assets/js/236.2e8820ed.js"><link rel="prefetch" href="/assets/js/237.b108feed.js"><link rel="prefetch" href="/assets/js/238.22baaff8.js"><link rel="prefetch" href="/assets/js/239.ac2c0eba.js"><link rel="prefetch" href="/assets/js/24.b1f29ab1.js"><link rel="prefetch" href="/assets/js/240.1f419e38.js"><link rel="prefetch" href="/assets/js/241.e23fbc50.js"><link rel="prefetch" href="/assets/js/242.83b3226c.js"><link rel="prefetch" href="/assets/js/243.1ce8a9be.js"><link rel="prefetch" href="/assets/js/244.d7c93bdb.js"><link rel="prefetch" href="/assets/js/245.a1b402c0.js"><link rel="prefetch" href="/assets/js/246.7eeb5e18.js"><link rel="prefetch" href="/assets/js/247.b2c0ab4a.js"><link rel="prefetch" href="/assets/js/248.5b2dd7ed.js"><link rel="prefetch" href="/assets/js/249.6278d6f1.js"><link rel="prefetch" href="/assets/js/25.748022ff.js"><link rel="prefetch" href="/assets/js/250.e3114578.js"><link rel="prefetch" href="/assets/js/251.1f576677.js"><link rel="prefetch" href="/assets/js/252.7e83dd55.js"><link rel="prefetch" href="/assets/js/253.ab219365.js"><link rel="prefetch" href="/assets/js/254.31655221.js"><link rel="prefetch" href="/assets/js/255.402ba0fd.js"><link rel="prefetch" href="/assets/js/256.2f1f131a.js"><link rel="prefetch" href="/assets/js/257.cd0dac87.js"><link rel="prefetch" href="/assets/js/258.5e84f5d0.js"><link rel="prefetch" href="/assets/js/259.72cf210e.js"><link rel="prefetch" href="/assets/js/26.d566b8b1.js"><link rel="prefetch" href="/assets/js/260.ddfd8bc7.js"><link rel="prefetch" href="/assets/js/261.b074e8b6.js"><link rel="prefetch" href="/assets/js/262.e0b94776.js"><link rel="prefetch" href="/assets/js/263.2e66950f.js"><link rel="prefetch" href="/assets/js/264.f3ac339f.js"><link rel="prefetch" href="/assets/js/265.384c189b.js"><link rel="prefetch" href="/assets/js/266.635a72af.js"><link rel="prefetch" href="/assets/js/268.9ec888f5.js"><link rel="prefetch" href="/assets/js/269.2a81258c.js"><link rel="prefetch" href="/assets/js/27.3085f660.js"><link rel="prefetch" href="/assets/js/270.973f0998.js"><link rel="prefetch" href="/assets/js/271.de24bbf3.js"><link rel="prefetch" href="/assets/js/272.68e83c3c.js"><link rel="prefetch" href="/assets/js/273.d740150b.js"><link rel="prefetch" href="/assets/js/274.dc1b1f0c.js"><link rel="prefetch" href="/assets/js/275.cf028a33.js"><link rel="prefetch" href="/assets/js/276.351dbc96.js"><link rel="prefetch" href="/assets/js/277.6a9f5699.js"><link rel="prefetch" href="/assets/js/278.0c28ac6f.js"><link rel="prefetch" href="/assets/js/279.b14576ac.js"><link rel="prefetch" href="/assets/js/28.47957820.js"><link rel="prefetch" href="/assets/js/280.906a73b1.js"><link rel="prefetch" href="/assets/js/281.4173499d.js"><link rel="prefetch" href="/assets/js/282.43873aa6.js"><link rel="prefetch" href="/assets/js/283.2a3d0552.js"><link rel="prefetch" href="/assets/js/284.2c7aa3fb.js"><link rel="prefetch" href="/assets/js/285.a62f9799.js"><link rel="prefetch" href="/assets/js/286.2f0b6532.js"><link rel="prefetch" href="/assets/js/287.d770d01f.js"><link rel="prefetch" href="/assets/js/288.97207297.js"><link rel="prefetch" href="/assets/js/289.ddf5a46c.js"><link rel="prefetch" href="/assets/js/29.716c8a52.js"><link rel="prefetch" href="/assets/js/290.9f1b4436.js"><link rel="prefetch" href="/assets/js/291.885ac485.js"><link rel="prefetch" href="/assets/js/292.b1fe886b.js"><link rel="prefetch" href="/assets/js/293.f597359f.js"><link rel="prefetch" href="/assets/js/294.f559040e.js"><link rel="prefetch" href="/assets/js/295.ef66e1a4.js"><link rel="prefetch" href="/assets/js/296.47009685.js"><link rel="prefetch" href="/assets/js/297.fb7d20ba.js"><link rel="prefetch" href="/assets/js/298.cb1631f8.js"><link rel="prefetch" href="/assets/js/299.25f28097.js"><link rel="prefetch" href="/assets/js/3.9c10c990.js"><link rel="prefetch" href="/assets/js/30.b35b7ad0.js"><link rel="prefetch" href="/assets/js/300.ab5c587e.js"><link rel="prefetch" href="/assets/js/301.544c6982.js"><link rel="prefetch" href="/assets/js/302.70396486.js"><link rel="prefetch" href="/assets/js/303.fa1f3a02.js"><link rel="prefetch" href="/assets/js/304.c344682e.js"><link rel="prefetch" href="/assets/js/305.a0620b1d.js"><link rel="prefetch" href="/assets/js/306.8cb43e28.js"><link rel="prefetch" href="/assets/js/307.ee4d9e2d.js"><link rel="prefetch" href="/assets/js/308.bb04656d.js"><link rel="prefetch" href="/assets/js/309.b3e3c0be.js"><link rel="prefetch" href="/assets/js/31.af0fa05e.js"><link rel="prefetch" href="/assets/js/310.162df0c7.js"><link rel="prefetch" href="/assets/js/311.1a5e341e.js"><link rel="prefetch" href="/assets/js/312.9fe4ed85.js"><link rel="prefetch" href="/assets/js/313.e187b781.js"><link rel="prefetch" href="/assets/js/314.c832b372.js"><link rel="prefetch" href="/assets/js/315.66b7260d.js"><link rel="prefetch" href="/assets/js/316.074c1e65.js"><link rel="prefetch" href="/assets/js/317.9210b762.js"><link rel="prefetch" href="/assets/js/318.50ac3392.js"><link rel="prefetch" href="/assets/js/319.996a4c1b.js"><link rel="prefetch" href="/assets/js/32.81b4ee4b.js"><link rel="prefetch" href="/assets/js/320.661c3aa7.js"><link rel="prefetch" href="/assets/js/321.91d065c2.js"><link rel="prefetch" href="/assets/js/322.21d177e9.js"><link rel="prefetch" href="/assets/js/323.c240199c.js"><link rel="prefetch" href="/assets/js/324.fc71e18c.js"><link rel="prefetch" href="/assets/js/325.d441ab5e.js"><link rel="prefetch" href="/assets/js/326.6065a9e1.js"><link rel="prefetch" href="/assets/js/327.b68a9e0f.js"><link rel="prefetch" href="/assets/js/328.082fa547.js"><link rel="prefetch" href="/assets/js/329.17abf0b7.js"><link rel="prefetch" href="/assets/js/33.c41edd68.js"><link rel="prefetch" href="/assets/js/330.076712a3.js"><link rel="prefetch" href="/assets/js/331.b883690e.js"><link rel="prefetch" href="/assets/js/332.a942e6bd.js"><link rel="prefetch" href="/assets/js/333.e193acf6.js"><link rel="prefetch" href="/assets/js/334.5721c074.js"><link rel="prefetch" href="/assets/js/335.b759f5ec.js"><link rel="prefetch" href="/assets/js/336.8f786a4b.js"><link rel="prefetch" href="/assets/js/337.8ef80b90.js"><link rel="prefetch" href="/assets/js/338.8c63fda7.js"><link rel="prefetch" href="/assets/js/339.3df2ba0b.js"><link rel="prefetch" href="/assets/js/34.e166f3d5.js"><link rel="prefetch" href="/assets/js/340.e54bd836.js"><link rel="prefetch" href="/assets/js/341.1de3160e.js"><link rel="prefetch" href="/assets/js/342.52f64508.js"><link rel="prefetch" href="/assets/js/343.f56c914e.js"><link rel="prefetch" href="/assets/js/344.63033532.js"><link rel="prefetch" href="/assets/js/345.b23610d1.js"><link rel="prefetch" href="/assets/js/346.2c817177.js"><link rel="prefetch" href="/assets/js/347.bb20d78f.js"><link rel="prefetch" href="/assets/js/348.bba2b968.js"><link rel="prefetch" href="/assets/js/349.620d4fde.js"><link rel="prefetch" href="/assets/js/35.827d2ea3.js"><link rel="prefetch" href="/assets/js/350.a24a894c.js"><link rel="prefetch" href="/assets/js/351.9fc8ae8f.js"><link rel="prefetch" href="/assets/js/352.9229b958.js"><link rel="prefetch" href="/assets/js/353.ffe6628c.js"><link rel="prefetch" href="/assets/js/354.4f883a51.js"><link rel="prefetch" href="/assets/js/355.3232e481.js"><link rel="prefetch" href="/assets/js/356.52bb9172.js"><link rel="prefetch" href="/assets/js/357.4ee29887.js"><link rel="prefetch" href="/assets/js/358.22886190.js"><link rel="prefetch" href="/assets/js/359.1f40fcc5.js"><link rel="prefetch" href="/assets/js/36.7c80731a.js"><link rel="prefetch" href="/assets/js/360.630b9c12.js"><link rel="prefetch" href="/assets/js/37.6608ea0a.js"><link rel="prefetch" href="/assets/js/38.4c69b602.js"><link rel="prefetch" href="/assets/js/39.19f940a6.js"><link rel="prefetch" href="/assets/js/4.55a001d1.js"><link rel="prefetch" href="/assets/js/40.d3257c4f.js"><link rel="prefetch" href="/assets/js/41.89db1eaf.js"><link rel="prefetch" href="/assets/js/42.4a12d693.js"><link rel="prefetch" href="/assets/js/43.cbe3ed47.js"><link rel="prefetch" href="/assets/js/44.61c79193.js"><link rel="prefetch" href="/assets/js/45.ce5ed428.js"><link rel="prefetch" href="/assets/js/46.eea0f2fa.js"><link rel="prefetch" href="/assets/js/47.f3bd04d8.js"><link rel="prefetch" href="/assets/js/48.ed81abeb.js"><link rel="prefetch" href="/assets/js/49.978d3cae.js"><link rel="prefetch" href="/assets/js/5.fe551af2.js"><link rel="prefetch" href="/assets/js/50.e21176fc.js"><link rel="prefetch" href="/assets/js/51.2f5a0327.js"><link rel="prefetch" href="/assets/js/52.125f820a.js"><link rel="prefetch" href="/assets/js/53.4a1c114d.js"><link rel="prefetch" href="/assets/js/54.dfe3253b.js"><link rel="prefetch" href="/assets/js/55.5959dcbb.js"><link rel="prefetch" href="/assets/js/56.9d18670e.js"><link rel="prefetch" href="/assets/js/57.c238fb54.js"><link rel="prefetch" href="/assets/js/58.e221eedb.js"><link rel="prefetch" href="/assets/js/59.f628533d.js"><link rel="prefetch" href="/assets/js/6.4670d323.js"><link rel="prefetch" href="/assets/js/60.919ac5be.js"><link rel="prefetch" href="/assets/js/61.3a63b17e.js"><link rel="prefetch" href="/assets/js/62.e61011ad.js"><link rel="prefetch" href="/assets/js/63.55200ef4.js"><link rel="prefetch" href="/assets/js/64.7c19f83d.js"><link rel="prefetch" href="/assets/js/65.833da817.js"><link rel="prefetch" href="/assets/js/66.13f4f83f.js"><link rel="prefetch" href="/assets/js/67.0c77e799.js"><link rel="prefetch" href="/assets/js/68.cc0e543d.js"><link rel="prefetch" href="/assets/js/69.555bef08.js"><link rel="prefetch" href="/assets/js/7.90cda232.js"><link rel="prefetch" href="/assets/js/70.5d2ec40f.js"><link rel="prefetch" href="/assets/js/71.81f1af4b.js"><link rel="prefetch" href="/assets/js/72.8a66936f.js"><link rel="prefetch" href="/assets/js/73.2655fba2.js"><link rel="prefetch" href="/assets/js/74.ba0b3153.js"><link rel="prefetch" href="/assets/js/75.536955ba.js"><link rel="prefetch" href="/assets/js/76.3a946a81.js"><link rel="prefetch" href="/assets/js/77.9b243f6c.js"><link rel="prefetch" href="/assets/js/78.f580a907.js"><link rel="prefetch" href="/assets/js/79.38cbcc11.js"><link rel="prefetch" href="/assets/js/8.9cebf18a.js"><link rel="prefetch" href="/assets/js/80.e82012e8.js"><link rel="prefetch" href="/assets/js/81.73c65f97.js"><link rel="prefetch" href="/assets/js/82.ddfa06dd.js"><link rel="prefetch" href="/assets/js/83.b75fcea2.js"><link rel="prefetch" href="/assets/js/84.5e0efc6d.js"><link rel="prefetch" href="/assets/js/85.3a495ae2.js"><link rel="prefetch" href="/assets/js/86.1ebe8967.js"><link rel="prefetch" href="/assets/js/87.cd673062.js"><link rel="prefetch" href="/assets/js/88.f50e4960.js"><link rel="prefetch" href="/assets/js/89.06660ffb.js"><link rel="prefetch" href="/assets/js/9.04fce59d.js"><link rel="prefetch" href="/assets/js/90.aa61aeaf.js"><link rel="prefetch" href="/assets/js/91.865e8535.js"><link rel="prefetch" href="/assets/js/92.fd2d2a62.js"><link rel="prefetch" href="/assets/js/93.b185de83.js"><link rel="prefetch" href="/assets/js/94.f5290c38.js"><link rel="prefetch" href="/assets/js/95.be5b7fed.js"><link rel="prefetch" href="/assets/js/96.d442acd0.js"><link rel="prefetch" href="/assets/js/97.2f9b0746.js"><link rel="prefetch" href="/assets/js/98.3bba4945.js"><link rel="prefetch" href="/assets/js/99.cd82a6ed.js">
    <link rel="stylesheet" href="/assets/css/0.styles.237ce36e.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="wen chao" class="logo"> <span class="site-name can-hide">wen chao</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Algorithm" class="dropdown-title"><a href="/Algorithm/" class="link-title">Algorithm</a> <span class="title" style="display:none;">Algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d8e764/" class="nav-link">Theory</a></li><li class="dropdown-item"><!----> <a href="/pages/81a4bd/" class="nav-link">LeetCode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/Spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/373439/" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technology" class="dropdown-title"><a href="/Technology/" class="link-title">Technology</a> <span class="title" style="display:none;">Technology</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3b6841/" class="nav-link">DB</a></li><li class="dropdown-item"><!----> <a href="/pages/d7857e/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b89362/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/ec8b81/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/pages/4e3ff1/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/a75fef/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/pages/b194d7/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/pages/371f2f/" class="nav-link">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/027aa3/" class="nav-link">Workflow</a></li><li class="dropdown-item"><!----> <a href="/pages/73ab4b/" class="nav-link">OAuth2</a></li><li class="dropdown-item"><!----> <a href="/pages/d7a38a/" class="nav-link">JPA</a></li><li class="dropdown-item"><!----> <a href="/pages/eb5dc1/" class="nav-link">Liquibase</a></li><li class="dropdown-item"><!----> <a href="/pages/e54277/" class="nav-link">Lombok</a></li><li class="dropdown-item"><!----> <a href="/pages/62e4f6/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/13c836/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/b50b3d/" class="nav-link">Mini Program</a></li><li class="dropdown-item"><!----> <a href="/pages/09d3b8/" class="nav-link">JVM</a></li><li class="dropdown-item"><!----> <a href="/pages/a526c7/" class="nav-link">Log</a></li><li class="dropdown-item"><!----> <a href="/pages/59cf4f/" class="nav-link">JDK</a></li><li class="dropdown-item"><!----> <a href="/pages/d50dab/" class="nav-link">Thymeleaf</a></li><li class="dropdown-item"><!----> <a href="/pages/97abaa/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/7879f1/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/745b7c/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/pages/274dac/" class="nav-link">Raspberrypi</a></li><li class="dropdown-item"><!----> <a href="/pages/87c097/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/pages/927664/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/2c3f19/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><a href="/Other/" class="link-title">Other</a> <span class="title" style="display:none;">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fea344/" class="nav-link">Book</a></li><li class="dropdown-item"><!----> <a href="/pages/d62f72/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/f3d338/" class="nav-link">问题</a></li><li class="dropdown-item"><!----> <a href="/pages/ff202b/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/pages/2b746e/" class="nav-link">证券</a></li></ul></div></div><div class="nav-item"><a href="/About/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Index" class="dropdown-title"><a href="/archives/" class="link-title">Index</a> <span class="title" style="display:none;">Index</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/touxiang-lanse.png"> <div class="blogger-info"><h3>wen chao</h3> <span>持之以恒做正确有价值的事!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Algorithm" class="dropdown-title"><a href="/Algorithm/" class="link-title">Algorithm</a> <span class="title" style="display:none;">Algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d8e764/" class="nav-link">Theory</a></li><li class="dropdown-item"><!----> <a href="/pages/81a4bd/" class="nav-link">LeetCode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/Spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/373439/" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technology" class="dropdown-title"><a href="/Technology/" class="link-title">Technology</a> <span class="title" style="display:none;">Technology</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3b6841/" class="nav-link">DB</a></li><li class="dropdown-item"><!----> <a href="/pages/d7857e/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b89362/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/ec8b81/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/pages/4e3ff1/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/a75fef/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/pages/b194d7/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/pages/371f2f/" class="nav-link">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/027aa3/" class="nav-link">Workflow</a></li><li class="dropdown-item"><!----> <a href="/pages/73ab4b/" class="nav-link">OAuth2</a></li><li class="dropdown-item"><!----> <a href="/pages/d7a38a/" class="nav-link">JPA</a></li><li class="dropdown-item"><!----> <a href="/pages/eb5dc1/" class="nav-link">Liquibase</a></li><li class="dropdown-item"><!----> <a href="/pages/e54277/" class="nav-link">Lombok</a></li><li class="dropdown-item"><!----> <a href="/pages/62e4f6/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/13c836/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/b50b3d/" class="nav-link">Mini Program</a></li><li class="dropdown-item"><!----> <a href="/pages/09d3b8/" class="nav-link">JVM</a></li><li class="dropdown-item"><!----> <a href="/pages/a526c7/" class="nav-link">Log</a></li><li class="dropdown-item"><!----> <a href="/pages/59cf4f/" class="nav-link">JDK</a></li><li class="dropdown-item"><!----> <a href="/pages/d50dab/" class="nav-link">Thymeleaf</a></li><li class="dropdown-item"><!----> <a href="/pages/97abaa/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/7879f1/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/745b7c/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/pages/274dac/" class="nav-link">Raspberrypi</a></li><li class="dropdown-item"><!----> <a href="/pages/87c097/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/pages/927664/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/2c3f19/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><a href="/Other/" class="link-title">Other</a> <span class="title" style="display:none;">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fea344/" class="nav-link">Book</a></li><li class="dropdown-item"><!----> <a href="/pages/d62f72/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/f3d338/" class="nav-link">问题</a></li><li class="dropdown-item"><!----> <a href="/pages/ff202b/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/pages/2b746e/" class="nav-link">证券</a></li></ul></div></div><div class="nav-item"><a href="/About/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Index" class="dropdown-title"><a href="/archives/" class="link-title">Index</a> <span class="title" style="display:none;">Index</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Book</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>性能调优专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>并发编程专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>源码框架专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>微服务专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>项目实战专题</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/6f8d3f/" class="sidebar-link">项目搭建</a></li><li><a href="/pages/3f9765/" class="sidebar-link">项目技术</a></li><li><a href="/pages/165d97/" class="sidebar-link">商品详细页多级缓存实战1</a></li><li><a href="/pages/248afc/" class="sidebar-link">商品详细页多级缓存实战2</a></li><li><a href="/pages/cde965/" class="sidebar-link">商品详细页多级缓存实战3</a></li><li><a href="/pages/684f32/" class="sidebar-link">电商项目微服务架构拆分</a></li><li><a href="/pages/528503/" class="sidebar-link">电商项目微服务网关整合授权中心实现单点登录</a></li><li><a href="/pages/f4e7c3/" class="sidebar-link">ES电商项目笔记</a></li><li><a href="/pages/a076e7/" class="sidebar-link">秒杀系统-订单交易全链路优化实战</a></li><li><a href="/pages/17d7cb/" class="sidebar-link">秒杀系统-订单交易全链路优化实战2</a></li><li><a href="/pages/1cc02e/" class="sidebar-link">canal安装与使用和原理详解</a></li><li><a href="/pages/7c3ae9/" class="sidebar-link">秒杀链路兜底方案之限流和降级实战</a></li><li><a href="/pages/b3e1d7/" aria-current="page" class="active sidebar-link">Sharding分库分表实战</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#一、分库分表基础" class="sidebar-link">一、分库分表基础</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#二、定制分库分表策略" class="sidebar-link">二、定制分库分表策略</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#三、实现订单分库分表" class="sidebar-link">三、实现订单分库分表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/b3e1d7/#基础环境配置" class="sidebar-link">基础环境配置：</a></li><li class="sidebar-sub-header level3"><a href="/pages/b3e1d7/#实现分库分表的核心步骤" class="sidebar-link">实现分库分表的核心步骤：</a></li><li class="sidebar-sub-header level3"><a href="/pages/b3e1d7/#开发过程" class="sidebar-link">开发过程</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#四、补充内容-配置shardingproxy" class="sidebar-link">四、补充内容 配置ShardingProxy</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/b3e1d7/#_1、理想与现实的差距" class="sidebar-link">1、理想与现实的差距</a></li><li class="sidebar-sub-header level3"><a href="/pages/b3e1d7/#_2、旧数据处理方式" class="sidebar-link">2、旧数据处理方式</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#五、分库分表带来的问题" class="sidebar-link">五、分库分表带来的问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/b3e1d7/#定制主键生成策略" class="sidebar-link">定制主键生成策略</a></li><li class="sidebar-sub-header level3"><a href="/pages/b3e1d7/#很多sql不支持" class="sidebar-link">很多SQL不支持</a></li><li class="sidebar-sub-header level3"><a href="/pages/b3e1d7/#其他问题" class="sidebar-link">其他问题</a></li><li class="sidebar-sub-header level3"><a href="/pages/b3e1d7/#分布式事务处理" class="sidebar-link">分布式事务处理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#_1、定制主键生成策略" class="sidebar-link">1、定制主键生成策略</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#_2、如何定制适合自己项目的分片策略" class="sidebar-link">2、如何定制适合自己项目的分片策略</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#_3、关于shardingsphere的扩展点" class="sidebar-link">3、关于ShardingSphere的扩展点：</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#_1、强一致性与最终一致性" class="sidebar-link">1、强一致性与最终一致性</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#_2、最终一致性事务设计方案" class="sidebar-link">2、最终一致性事务设计方案：</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#_3、分布式事务的角色划分" class="sidebar-link">3、分布式事务的角色划分</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#_1、xa事务" class="sidebar-link">1、XA事务</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#_2、base柔性事务" class="sidebar-link">2、BASE柔性事务</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3e1d7/#_1、分库分表场景下的分布式事务问题" class="sidebar-link">1、分库分表场景下的分布式事务问题：</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/b3e1d7/#xa事务" class="sidebar-link">XA事务</a></li><li class="sidebar-sub-header level3"><a href="/pages/b3e1d7/#seata-at事务" class="sidebar-link">Seata AT事务</a></li></ul></li></ul></li><li><a href="/pages/21df2c/" class="sidebar-link">项目实战总结与项目管理分享</a></li><li><a href="/pages/98944c/" class="sidebar-link">中台建设和DDD</a></li><li><a href="/pages/b36dd7/" class="sidebar-link">Docker详解与部署微服务实战</a></li><li><a href="/pages/75ec88/" class="sidebar-link">Docker-Compose编排电商微服务项目实战</a></li><li><a href="/pages/e77282/" class="sidebar-link">自动化性能监控系统Prometheus-Grafana实战</a></li><li><a href="/pages/fd685e/" class="sidebar-link">Kubernetes快速实战与核心原理剖析</a></li><li><a href="/pages/cdff9c/" class="sidebar-link">Kubernetes电商微服务部署实战</a></li><li><a href="/pages/33fd02/" class="sidebar-link">电商项目性能优化实战</a></li><li><a href="/pages/c5f7e6/" class="sidebar-link">推荐系统-机器学习</a></li><li><a href="/pages/98b787/" class="sidebar-link">企业级IM系统后端架构实战</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>设计模式专题</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>面试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>问题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>友链</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>证券</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/Other/#Other" data-v-06225672>Other</a></li><li data-v-06225672><a href="/Other/#Book" data-v-06225672>Book</a></li><li data-v-06225672><a href="/Other/#项目实战专题" data-v-06225672>项目实战专题</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://nylg.gitee.io" target="_blank" title="作者" class="beLink" data-v-06225672>wen chao</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-06-23</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">Sharding分库分表实战<!----></h1>  <div class="theme-vdoing-content content__default"><div class="language- line-numbers-mode"><pre class="language-text"><code>U2FsdGVkX1+IALsVjC+rzfLQJwhlei2cKvFYB/RREGhtna6/zdLjt+K9Qn1KqKE/
Cx78AtGDupuA8rtYMiiAhE0Bj/RnpqngoAtRda7F7gjfXoaR
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="一、分库分表基础"><a href="#一、分库分表基础" class="header-anchor">#</a> 一、分库分表基础</h2> <p>1、什么是分库分表？什么时候要分库分表？</p> <p>​	先将tulingmall-order的jdbc数据源调整到本地，然后在本地数据库中，已经插入了20+W的订单数据，全都是Monkey用户插入的。</p> <blockquote><p>调整方法：  1、在启动类上排除掉SpringBootConfiguration.class，这个是ShardingSphere进行分库分表的配置类。@SpringBootApplication(exclude = {SpringBootConfiguration.class})</p> <p>2、调整配置文件，打开application.yml中的datasource配置。</p></blockquote> <p>​	然后在前端tuling-front用Monkey/123用户登录，进入&quot;我的订单&quot;页面，这个页面可以查询到所有的订单。--页面没有分页，但是能够加载更多的订单。简单分析下这个查询订单的SQL：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span>
 <span class="token keyword">SELECT</span>
  o<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
  o<span class="token punctuation">.</span><span class="token keyword">status</span><span class="token punctuation">,</span>
  o<span class="token punctuation">.</span>total_amount<span class="token punctuation">,</span>
  o<span class="token punctuation">.</span>pay_amount<span class="token punctuation">,</span>
  o<span class="token punctuation">.</span>order_sn<span class="token punctuation">,</span>
  o<span class="token punctuation">.</span>member_id<span class="token punctuation">,</span>
  ot<span class="token punctuation">.</span>id ot_id<span class="token punctuation">,</span>
  ot<span class="token punctuation">.</span>product_id ot_product_id<span class="token punctuation">,</span>
  ot<span class="token punctuation">.</span>product_name ot_product_name<span class="token punctuation">,</span>
  ot<span class="token punctuation">.</span>product_pic ot_product_pic<span class="token punctuation">,</span>
  ot<span class="token punctuation">.</span>product_price ot_product_price<span class="token punctuation">,</span>
  ot<span class="token punctuation">.</span>product_sku_id ot_product_sku_id<span class="token punctuation">,</span>
  ot<span class="token punctuation">.</span>product_sku_code ot_product_sku_code<span class="token punctuation">,</span>
  ot<span class="token punctuation">.</span>product_quantity ot_product_quantity<span class="token punctuation">,</span>
  ot<span class="token punctuation">.</span>product_attr ot_product_attr
        <span class="token keyword">FROM</span>
    oms_order o
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span>
    oms_order_item ot <span class="token keyword">ON</span> o<span class="token punctuation">.</span>id <span class="token operator">=</span> ot<span class="token punctuation">.</span>order_id
        <span class="token keyword">WHERE</span>
          o<span class="token punctuation">.</span>delete_status <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">and</span> o<span class="token punctuation">.</span>member_id<span class="token operator">=</span><span class="token number">8</span>
          <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> o<span class="token punctuation">.</span>create_time <span class="token keyword">desc</span>
<span class="token punctuation">)</span>t  <span class="token keyword">limit</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><blockquote><p>查第一页会非常快，只要0.002秒。但是往后翻页时，效率会越来越低。当翻页翻到 10000,10时，执行时间需要3秒多。100000,10时执行时间需要4秒多。</p></blockquote> <p>查询会耗时2秒多。而简单执行下面这个SQL语句，会要消耗7秒多。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>select <span class="token operator">*</span> from <span class="token punctuation">(</span>
select <span class="token number">1</span> from oms_order o <span class="token constant">LEFT</span> <span class="token constant">JOIN</span> oms_order_item ot on o<span class="token punctuation">.</span>id <span class="token operator">=</span> ot<span class="token punctuation">.</span>order_id
<span class="token punctuation">)</span> t limit <span class="token number">200000</span><span class="token punctuation">,</span><span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>这个时长如果需要响应到页面上，那就已经是无法忍受了。这还只是一个简单的查询，并且返回的数据其实还不多。如果数据更多(比如导出)，查询更复杂，并发量更大，那消耗的时间会更长。</p> <p>单表数据量太大带来的问题还不止是查询变慢，如果数据更多，还很容易造成系统假死。如果我们的订单页面不断的加载订单，那浏览器也会崩溃。</p></blockquote> <p><strong>分库分表的作用：1、加大存储，2、提升查询效率，3、提升数据库的并发能力。</strong></p> <p>阿里的开发规范中建议预估三年内单表数据量上500W，或者大小上2G，就要考虑分库分表。</p> <h2 id="二、定制分库分表策略"><a href="#二、定制分库分表策略" class="header-anchor">#</a> 二、定制分库分表策略</h2> <p>这一部分，我们来进行实战，对最为重要的订单数据进行分库分表配置。</p> <blockquote><p>实战代码演示，参见tulingmall-order-sharding模块。主要是通过在application.properties文件中定制数据分片策略</p></blockquote> <p>定制分库分表策略的注意点：</p> <ul><li>分库分表一般要在开发之前设计，尽量避免临时设计。只针对最核心的表。</li> <li>分库分表后，对表的查询必须足够简单，不要有跨表，跨库的复杂查询。</li> <li>分库和分表尽量同时进行，分库可以分担网络压力。</li></ul> <p>关于数据分片策略。</p> <ul><li>分库策略：将核心的订单表和订单物品表从业务库中移出来，单独放到一个库。我们分成两个库。分散网络压力。</li> <li>分表策略：在每个库分两个表，尽量将数据平均的分配到这四个表中。分散单表查询压力。</li></ul> <blockquote><p>考虑的问题：</p> <p>1、回顾下ShardingSphere的几种分片策略实现方式：inline, standard, complex, hint。</p> <p>2、两个库，四个表。要如何将数据分配均匀？</p> <p>3、如何定制适合业务场景的数据分片策略？</p> <p>有哪些常用的数据分片策略？取模分片、按时间范围分片、按业务要素(如地区、前缀等)分片。。。。</p> <p>​	取模分片能够将数据分配得尽量的平均，但是不利于扩展。</p> <p>​	按范围分片便于扩展但是他的数据分布又不够均匀。</p> <p>​	是不是可以定制一种分片策略，将这两种分片策略结合起来？比如大尺度上按范围分片，但是在每个数据范围内，使用取模分片。这种分片策略要如何在ShardingSphere中实现？提供思路，留给大家自己实现。</p></blockquote> <ul><li>主键生成策略：ShardingSphere内置UUID和SNOWFLAKE两种。扩展自定义主键生成策略</li></ul> <p>application.properties分库分表配置如下：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment"># 配置ds0 和ds1两个数据源</span>
<span class="token key attr-name">spring.shardingsphere.datasource.names</span><span class="token punctuation">=</span><span class="token value attr-value">ds,ds0,ds1</span>
<span class="token comment">#ds1 配置</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds.type</span><span class="token punctuation">=</span><span class="token value attr-value">com.alibaba.druid.pool.DruidDataSource</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds.driver-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/micromall?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span>
<span class="token comment">#初始连接数</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds.initialSize</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>
<span class="token comment">#最小空闲连接数</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds.minIdle</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
<span class="token comment">#最大连接数</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds.maxActive</span><span class="token punctuation">=</span><span class="token value attr-value">30</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds.validationQuery</span><span class="token punctuation">=</span><span class="token value attr-value">SELECT 1 FROM DUAL</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds.password</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token comment">#ds0 配置</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds0.type</span><span class="token punctuation">=</span><span class="token value attr-value">com.alibaba.druid.pool.DruidDataSource</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds0.driver-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds0.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/micromall_ds_0?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds0.initialSize</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds0.minIdle</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds0.maxActive</span><span class="token punctuation">=</span><span class="token value attr-value">30</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds0.validationQuery</span><span class="token punctuation">=</span><span class="token value attr-value">SELECT 1 FROM DUAL</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds0.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds0.password</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token comment">#ds1 配置</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds1.type</span><span class="token punctuation">=</span><span class="token value attr-value">com.alibaba.druid.pool.DruidDataSource</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds1.driver-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds1.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://localhost:3306/micromall_ds_1?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds1.initialSize</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds1.minIdle</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds1.maxActive</span><span class="token punctuation">=</span><span class="token value attr-value">30</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds1.validationQuery</span><span class="token punctuation">=</span><span class="token value attr-value">SELECT 1 FROM DUAL</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds1.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">spring.shardingsphere.datasource.ds1.password</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>

<span class="token comment"># 对于没有做任何业务拆分的表，直接走本默认数据源即可</span>
<span class="token key attr-name">spring.shardingsphere.sharding.default-data-source-name</span><span class="token punctuation">=</span><span class="token value attr-value">ds</span>

<span class="token key attr-name">spring.shardingsphere.sharding.default-database-strategy.hint.algorithm-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.tuling.tulingmall.sharding.OrderAllRangeHintAlgorithm</span>
<span class="token key attr-name">spring.shardingsphere.sharding.default-table-strategy.hint.algorithm-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.tuling.tulingmall.sharding.OrderAllRangeHintAlgorithm</span>
<span class="token comment"># oms_order分片策略</span>
<span class="token comment"># 节点 ds0.oms_order_0,ds0.oms_order_1,ds1.oms_order_0,ds1.oms_order_1</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order.actual-data-nodes</span><span class="token punctuation">=</span><span class="token value attr-value">ds$-&gt;{0..1}.oms_order_$-&gt;{0..1}</span>
<span class="token comment">#分库策略</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order.database-strategy.inline.sharding-column</span><span class="token punctuation">=</span><span class="token value attr-value">id</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order.database-strategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token value attr-value">ds$-&gt;{id % 2}</span>
<span class="token comment"># 分表策略</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order.table-strategy.inline.sharding-column</span><span class="token punctuation">=</span><span class="token value attr-value">id</span>
<span class="token comment"># 注意下，对于除法，groovy会计算出浮点数，而不是整数。即 3/2=1.5，如果需要计算出整数 3.intdiv(2)=1</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order.table-strategy.inline.algorithm-expression</span> <span class="token punctuation">=</span> <span class="token value attr-value">oms_order_$-&gt;{((id+1) % 4).intdiv(2)}</span>
<span class="token comment"># 复合分片算法</span>
<span class="token comment">#spring.shardingsphere.sharding.tables.oms_order.table-strategy.complex.sharding-columns=id</span>
<span class="token comment">#spring.shardingsphere.sharding.tables.oms_order.table-strategy.complex.algorithm-class-name = com.tuling.tulingmall.sharding.OrderComplexShardingAlgorithm</span>
<span class="token comment"># 使用SNOWFLAKE算法生成主键</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order.key-generator.column</span><span class="token punctuation">=</span><span class="token value attr-value">id</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order.key-generator.type</span><span class="token punctuation">=</span><span class="token value attr-value">SNOWFLAKE</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order.key-generator.props.worker.id</span><span class="token punctuation">=</span><span class="token value attr-value">123</span>
<span class="token comment"># 使用自定义主键生成策略</span>
<span class="token comment">#spring.shardingsphere.sharding.tables.oms_order.key-generator.type=CUSTOM</span>
<span class="token comment">#spring.shardingsphere.sharding.tables.oms_order.key-generator.props.redis.prefix=order:id:prefix:</span>

<span class="token comment"># 节点 ds0.oms_order_item_0,ds0.oms_order_item_1,ds1.oms_order_item_0,ds1.oms_order_item_1</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order_item.actual-data-nodes</span><span class="token punctuation">=</span><span class="token value attr-value">ds$-&gt;{0..1}.oms_order_item_$-&gt;{0..1}</span>
<span class="token comment"># 分库策略 按order_id分片</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order_item.database-strategy.inline.sharding-column</span><span class="token punctuation">=</span><span class="token value attr-value">order_id</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order_item.database-strategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token value attr-value">ds$-&gt;{order_id % 2}</span>
<span class="token comment"># 分表策略</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order_item.table-strategy.inline.sharding-column</span><span class="token punctuation">=</span><span class="token value attr-value">order_id</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order_item.table-strategy.inline.algorithm-expression</span><span class="token punctuation">=</span><span class="token value attr-value">oms_order_item_$-&gt;{((order_id+1) % 4).intdiv(2)}</span>
<span class="token comment"># 使用SNOWFLAKE算法生成主键</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order_item.key-generator.column</span><span class="token punctuation">=</span><span class="token value attr-value">id</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order_item.key-generator.type</span><span class="token punctuation">=</span><span class="token value attr-value">SNOWFLAKE</span>
<span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order_item.key-generator.props.worker.id</span><span class="token punctuation">=</span><span class="token value attr-value">123</span>

<span class="token comment"># 配置绑定表，防止笛卡尔乘积</span>
<span class="token key attr-name">spring.shardingsphere.sharding.binding-tables[0]</span><span class="token punctuation">=</span><span class="token value attr-value">oms_order,oms_order_item</span>
<span class="token comment"># 打印SQL语句</span>
<span class="token key attr-name">spring.shardingsphere.props.sql.show</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><blockquote><p>注意： 1、我们配置的分库分表策略是将oms_order和oms_order_item两个表配置分库分表策略，其他的没有配置的表还是会走ds数据库。</p> <p>2、注意理解下分库分表的策略。如何将记录平均分配到两个库的四个表中？如果分表策略只是oms_order_${order_id % 2}，能平均分配吗？</p> <p>3、为什么要配置绑定表？</p></blockquote> <h2 id="三、实现订单分库分表"><a href="#三、实现订单分库分表" class="header-anchor">#</a> 三、实现订单分库分表</h2> <p>这一部分主要是将数据分片策略整合到tulingmall-order-sharding模块当中。</p> <h3 id="基础环境配置"><a href="#基础环境配置" class="header-anchor">#</a> 基础环境配置：</h3> <p>1、将项目中的mysql数据库配置迁移到本地数据库，后续将在本地数据库完成分库分表开发。</p> <blockquote><p>所有服务都安装在192.168.65.232服务器上。包括RocketMQ,RabbitMQ,Zookeeper,Nacos,Seata,MySQL,Redis...</p> <p>可以在本地hosts文件中增加一个配置 192.168.65.232 <a href="http://tlshop.com" target="_blank" rel="noopener noreferrer">tlshop.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这是因为在nacos的配置中心，大都是把服务按照tlshop.com的域名配置的。</p></blockquote> <p>2、将tulingmall-product模块的bootstrap.xml中去掉tulingmall-db-common.yml的配置依赖，再在application.yml中，将mysql数据库改为本地数据库配置。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>spring:  
  datasource:    
    url: jdbc:mysql://localhost:3306/micromall?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这一步是为了让product模块不去依赖nacos上的配置，而采用本地数据库mysql。因为系统中订单流程是跟产品功能绑定的。必须要先将产品加入到购物车，然后在购物车中确认商品后才能生成订单。所以在调整订单模块之前需要将产品模块的数据库一起调整过来。</p> <p>3、将192.168.65.232服务器上mysql里micromall库的数据全都移植到本地mysql的micromall中。</p> <p>​	其他模块比如用户模块，可以不用调整数据源，因为我们不会修改这部分数据。</p> <h3 id="实现分库分表的核心步骤"><a href="#实现分库分表的核心步骤" class="header-anchor">#</a> 实现分库分表的核心步骤：</h3> <p>1、定义分库分表数据源：使用ShardingSphere的DataSource替换原始的DataSource</p> <p>2、定制分库分表规则：将oms_order和oms_order_item两张表映射成为ShardingSphere中的逻辑表，并配置分库分表规则，将这两张表移动到单独的数据库中。其他表不要动。</p> <p>3、分库分表规则优化：分库分表规则、绑定表、读写分离、自定义路由策略、自定义主键生成策略等。</p> <h3 id="开发过程"><a href="#开发过程" class="header-anchor">#</a> 开发过程</h3> <p>1、加入分库分表的数据源配置</p> <p>在tulingmall-order模块的application.yml中，去掉spring.datasource部分的配置。然后引入application.properties，并在其中配置分库分表。</p> <p>2、将TulingmallOrderApplication 启动类上排除掉的SpringBootConfiguration.class给加回来。</p> <p>这样就完成了简单的分库分表。</p> <h2 id="四、补充内容-配置shardingproxy"><a href="#四、补充内容-配置shardingproxy" class="header-anchor">#</a> 四、补充内容 配置ShardingProxy</h2> <blockquote><p>这一部分是要配置shardingproxy支持同样的分片策略。</p></blockquote> <h3 id="_1、理想与现实的差距"><a href="#_1、理想与现实的差距" class="header-anchor">#</a> 1、理想与现实的差距</h3> <p>分库分表后对整个业务功能的影响是很大的，所以通常建议是要在系统设计之初就想明白要不要进行分库分表以及如何分库分表。但是很多公司在实践过程中，对于分库分表都是后知后觉的，很多业务都是等数量累积到了一定程度，数据量的问题爆发出来了，才想起要分库分表。那这时要怎么处理？</p> <h3 id="_2、旧数据处理方式"><a href="#_2、旧数据处理方式" class="header-anchor">#</a> 2、旧数据处理方式</h3> <p>​	如果要在中途进行分库分表，要分为两个步骤：</p> <p>​	首先：要评估数据分片方案，对关键的SQL进行整理并分析。分库分表后，有很多SQL是无法支持的，这些SQL一定要优先从业务中去掉。这个步骤很容易被忽略，但是一定是必不可少的。<strong>有哪些SQL是ShardingSphere不支持的？</strong>	参见官网。</p> <p>​	然后：当你制定好了分库分表方案后，不要急于迁移旧数据。最好是在业务中对SQL进行数据双写。即老数据库写一份，新的分片后的数据库也写一份。观察一段时间，等业务稳定了之后，再考虑全部转移到分片后的新数据库中。<strong>这同样需要多方定制ShardingSphere的分片策略，简单的inline是很难达到这个目的的</strong>。</p> <p>​	接下来：进行旧数据迁移时，<strong>可以采用ShardingProxy来协助进行数据转移</strong>。部署同样分片策略的ShardingProxy，一方面可以在MySQL的客户端工具中快速验证分片策略，另外可以使用sqoop、keetle等工具来协助进行数据转移。</p> <p>下面来实战在ShardingProxy中复制</p> <p>config-sharding.yaml配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>schemaName: sharding_db
    
dataSources:
  ds:
    url: jdbc:mysql://localhost:3306/micromall?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8
    username: root
    password: root
  ds0:
    url: jdbc:mysql://localhost:3306/micromall_ds_0?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8
    username: root
    password: root
  ds1:
    url: jdbc:mysql://localhost:3306/micromall_ds_1?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8
    username: root
    password: root

shardingRule:
  tables:
    oms_order:
      actualDataNodes: ds$-&gt;{0..1}.oms_order_$-&gt;{0..1}
      databaseStrategy:
        inline:
          shardingColumn: id
          algorithmExpression: ds$-&gt;{id % 2}
      tableStrategy:
        inline:
          shardingColumn: id
          algorithmExpression: oms_order_$-&gt;{(id+1) % 4 /2}
      keyGenerator:
        column: id
        type: SNOWFLAKE
        props:
          worker.id: 123
    oms_order_item:
      actualDataNodes: ds$-&gt;{0..1}.oms_order_item_$-&gt;{0..1}
      databaseStrategy:
        inline:
          shardingColumn: order_id
          algorithmExpression: ds$-&gt;{id % 2}
      tableStrategy:
        inline:
          shardingColumn: order_id
          algorithmExpression: oms_order_item_$-&gt;{(order_id+1) % 4 / 2}
      keyGenerator:
        column: id
        type: SNOWFLAKE
        props:
          worker.id: 123
  bindingTables: 
    - oms_order,oms_order_item
  defaultDataSourceName: ds
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><blockquote><p>在定制分表策略时，这种配置方式是有问题的，因为groovy在进行除2的计算时，如果是奇数，会计算出浮点数0.5，所有会间断报错。这时需要将除法改成div方法。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>oms_order_$-&gt;{((id+1) % 4).intdiv(2)}
oms_order_item_$-&gt;{((order_id+1) % 4).intdiv(2)}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></blockquote> <p>开发完成后，将分库分表策略分配到ShardingProxy中，用于进行快速实验。</p> <p>shardingProxy的config-sharding.yaml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">schemaName</span><span class="token punctuation">:</span> sharding_db
    
<span class="token key atrule">dataSources</span><span class="token punctuation">:</span>
  <span class="token key atrule">ds</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/micromall<span class="token punctuation">?</span>serverTimezone=UTC<span class="token important">&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-</span><span class="token number">8</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
  <span class="token key atrule">ds0</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/micromall_ds_0<span class="token punctuation">?</span>serverTimezone=UTC<span class="token important">&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-</span><span class="token number">8</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
  <span class="token key atrule">ds1</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/micromall_ds_1<span class="token punctuation">?</span>serverTimezone=UTC<span class="token important">&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-</span><span class="token number">8</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root

<span class="token key atrule">shardingRule</span><span class="token punctuation">:</span>
  <span class="token key atrule">tables</span><span class="token punctuation">:</span>
    <span class="token key atrule">oms_order</span><span class="token punctuation">:</span>
      <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.oms_order_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>
      <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
        <span class="token key atrule">inline</span><span class="token punctuation">:</span>
          <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> id
          <span class="token key atrule">algorithmExpression</span><span class="token punctuation">:</span> ds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>id % 2<span class="token punctuation">}</span>
      <span class="token key atrule">tableStrategy</span><span class="token punctuation">:</span>
        <span class="token key atrule">inline</span><span class="token punctuation">:</span>
          <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> id
          <span class="token key atrule">algorithmExpression</span><span class="token punctuation">:</span> oms_order_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>((id+1) % 4).intdiv(2)<span class="token punctuation">}</span>
      <span class="token key atrule">keyGenerator</span><span class="token punctuation">:</span>
        <span class="token key atrule">column</span><span class="token punctuation">:</span> id
        <span class="token key atrule">type</span><span class="token punctuation">:</span> SNOWFLAKE
        <span class="token key atrule">props</span><span class="token punctuation">:</span>
          <span class="token key atrule">worker.id</span><span class="token punctuation">:</span> <span class="token number">123</span>
    <span class="token key atrule">oms_order_item</span><span class="token punctuation">:</span>
      <span class="token key atrule">actualDataNodes</span><span class="token punctuation">:</span> ds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>.oms_order_item_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..1<span class="token punctuation">}</span>
      <span class="token key atrule">databaseStrategy</span><span class="token punctuation">:</span>
        <span class="token key atrule">inline</span><span class="token punctuation">:</span>
          <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> order_id
          <span class="token key atrule">algorithmExpression</span><span class="token punctuation">:</span> ds$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>id % 2<span class="token punctuation">}</span>
      <span class="token key atrule">tableStrategy</span><span class="token punctuation">:</span>
        <span class="token key atrule">inline</span><span class="token punctuation">:</span>
          <span class="token key atrule">shardingColumn</span><span class="token punctuation">:</span> order_id
          <span class="token key atrule">algorithmExpression</span><span class="token punctuation">:</span> oms_order_item_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>((order_id+1) % 4).intdiv(2)<span class="token punctuation">}</span>
      <span class="token key atrule">keyGenerator</span><span class="token punctuation">:</span>
        <span class="token key atrule">column</span><span class="token punctuation">:</span> id
        <span class="token key atrule">type</span><span class="token punctuation">:</span> SNOWFLAKE
        <span class="token key atrule">props</span><span class="token punctuation">:</span>
          <span class="token key atrule">worker.id</span><span class="token punctuation">:</span> <span class="token number">123</span>
  <span class="token key atrule">bindingTables</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> oms_order<span class="token punctuation">,</span>oms_order_item
  <span class="token key atrule">defaultDataSourceName</span><span class="token punctuation">:</span> ds
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h2 id="五、分库分表带来的问题"><a href="#五、分库分表带来的问题" class="header-anchor">#</a> 五、分库分表带来的问题</h2> <h3 id="定制主键生成策略"><a href="#定制主键生成策略" class="header-anchor">#</a> 定制主键生成策略</h3> <p>​	主键是分库分表中非常重要的业务要素，通常分库分表都会采用主键来作为分片键，这个时候主键就不再只是用来提升查询效率了，还需要坚固数据分片的效率。要如何定制高效的主键生成策略？</p> <h3 id="很多sql不支持"><a href="#很多sql不支持" class="header-anchor">#</a> 很多SQL不支持</h3> <p>​	例如MySQL里会配for each标签来执行批量SQL，原始数据库是支持的，但是分库分表不支持。</p> <p>​	查询的SQL比较多时，路由策略是否支持？</p> <p>​	去官网上查一下分库分表的不支持项。</p> <h3 id="其他问题"><a href="#其他问题" class="header-anchor">#</a> 其他问题</h3> <p>​	数据迁移、扩缩容、公共表、读写分离、配置往注册中心集中配置</p> <h3 id="分布式事务处理"><a href="#分布式事务处理" class="header-anchor">#</a> 分布式事务处理</h3> <p>​	一旦涉及到分布式事务，就会带来非常多麻烦的事情。前面fox老师才讲了分布式事务要如何处理，分布式事务的各种处理机制你是否弄明白了？</p> <p>​	在分库分表场景下的分布式事务是什么样的？要怎么处理？下一节课来讲。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>U2FsdGVkX1+FSiT7vqsnDchV2YUM9VgurJYdJls2o5uJO4upKKh6TkkEoq4Q/cut
Ufrlv0DA+V3Z90zh1RtxcZz/JupdOAduH4cnN67DXMouSWpE
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h1 id="一、上一节课的课后作业分析"><a href="#一、上一节课的课后作业分析" class="header-anchor">#</a> 一、上一节课的课后作业分析：</h1> <h2 id="_1、定制主键生成策略"><a href="#_1、定制主键生成策略" class="header-anchor">#</a> 1、定制主键生成策略</h2> <p>分布式主键要怎么设计？1、全局唯一，2、高性能，3、高可用，4、趋势递增</p> <p>数据库自增长：  单机下自增长没有问题，但是分布式情况下会造成主键冲突。解决方案：集群模式，设置起始值和自增步长。例如三个集群，第一个台机器初始值0，自增长3；第二台机器初始值1，自增长3；第三台机器初始值2，自增长3。优点：解决DB单点问题。缺点：不利于扩容，高并发下每个数据库的自身压力还是会非常大。</p> <p>ShardingSphere默认提供的两种分布式主键生成策略： UUID， SnowFlake。</p> <p>UUID有什么问题？优点：生成简单、无网络消耗、全局唯一。缺点：无序字符串、没有具体业务含义、长度太长，对MySQL 的性能消耗较大。</p> <p>SnowFlake有什么问题？优点：趋势递增、全局唯一、无网络消耗。缺点：时间戳依赖于机器时钟。如果机器时间回调，还是可能会有冲突。</p> <p>扩展方式：基于Redis扩展自己的分布式主键。--基于SPI机制扩展 OrderByRedisKeyGenerator</p> <blockquote><p>如何在ShardingProxy中使用自定义的主键生成策略？</p></blockquote> <h2 id="_2、如何定制适合自己项目的分片策略"><a href="#_2、如何定制适合自己项目的分片策略" class="header-anchor">#</a> 2、如何定制适合自己项目的分片策略</h2> <p>上一节课提到了我们是采用的取模平均分配的方式，这种分片策略数据分布得比较平均，但是不容易扩展，以后如果需要加减机器，都需要进行庞大的数据迁移。所以可以实现一种定制的分片策略，在整体上是按年份进行分片，在每年的数据内再按照取模进行分片。</p> <p>​	实现方式：1、对于oms_order表，要实现的是按照id=xxx这样的逻辑进行分片。包含insert 语句和select 语句。所以，要采用Standard中的precise精确分片方式。在分库分表配置文件中，增加配置信息：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">spring.shardingsphere.sharding.tables.oms_order.table-strategy.standard.precise-algorithm-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.tuling.tulingmall.sharding.OrderPreciseShardingAlgorithm</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	然后就可以在分片逻辑实现类中实现对id先按年划分范围，然后按2取模平均分配数据</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderPreciseShardingAlgorithm</span> <span class="token keyword">implements</span> <span class="token class-name">PreciseShardingAlgorithm</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span> collection<span class="token punctuation">,</span> <span class="token class-name">PreciseShardingValue</span> preciseShardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// collection中保存所有真实节点</span>
        collection<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;actual node table:{}&quot;</span><span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Long</span> columnValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span>preciseShardingValue<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> columnName <span class="token operator">=</span> preciseShardingValue<span class="token punctuation">.</span><span class="token function">getColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> logicTableName <span class="token operator">=</span> preciseShardingValue<span class="token punctuation">.</span><span class="token function">getLogicTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//preciseShardingValue中保存分片逻辑，包含逻辑表，分片字段和查询的条件值</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;logic table name:{},rout column:{}&quot;</span><span class="token punctuation">,</span> logicTableName<span class="token punctuation">,</span> columnName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;column value:{}&quot;</span><span class="token punctuation">,</span> columnValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//采用自定义的ID生成器后，ID的前四位数字就是年份</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> year <span class="token operator">=</span> columnValue<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RedisOpsUtil</span> redisOpsUtil <span class="token operator">=</span> <span class="token class-name">TulingmallOrderApplication</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;redisOpsUtil&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Integer</span> shardingKey <span class="token operator">=</span> redisOpsUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;shardingYear:&quot;</span> <span class="token operator">+</span> year<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> actualTableName <span class="token operator">=</span> logicTableName<span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span>year<span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span>columnValue <span class="token operator">%</span> shardingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回的结构就是具体的实际表。sharddingsphere会把逻辑表改成这个实际表</span>
        <span class="token keyword">return</span> actualTableName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><blockquote><p>这是分表的逻辑。分库如何做？</p></blockquote> <h2 id="_3、关于shardingsphere的扩展点"><a href="#_3、关于shardingsphere的扩展点" class="header-anchor">#</a> 3、关于ShardingSphere的扩展点：</h2> <p>ShardingSphere基于SPI机制提供了非常多的扩展点，具体可以参见估官方文档，开发者手册部分。</p> <p>ShardingAlgorithm扩展点就列出了ShardingSphere默认提供的多种分片策略：
InlineShardingAlgorithm：基于⾏表达式的分⽚算法
ModShardingAlgorithm：基于取模的分⽚算法
HashModShardingAlgorithm：基于哈希取模的分⽚算法
FixedIntervalShardingAlgorithm：基于固定时间范围的分⽚算法
MutableIntervalShardingAlgorithm：基于可变时间范围的分⽚算法
VolumeBasedRangeShardingAlgorithm：基于分⽚容量的范围分⽚算法
BoundaryBasedRangeShardingAlgorithm：基于分⽚边界的范围分⽚算法</p> <p>还有其他扩展点，也要学会自己去理解。</p> <h1 id="二、分布式事务处理方式梳理"><a href="#二、分布式事务处理方式梳理" class="header-anchor">#</a> 二、分布式事务处理方式梳理：</h1> <h2 id="_1、强一致性与最终一致性"><a href="#_1、强一致性与最终一致性" class="header-anchor">#</a> 1、强一致性与最终一致性</h2> <p>在通常的分布式事务场景中，首先会根据业务场景要求，将事务分为强一致性和最终一致性。这里所谓强一致性，就是指在任何时刻，分布式事务的各个参与方的事务状态都是对齐的。典型的强一致性场景就是操作系统的文件系统。不管有多少个软件操作同一个文件，文件的状态始终是一致的。</p> <p>但是通常来说，要实现强一致性的事务难度是非常大的，尤其在分布式场景下，还需要面对非常多不确定的资源，比如网络、服务状态等。所以通常情况下，只需要实现最终一致性就可以了。  他的核心思想是既然无法保证分布式事务每时每刻的强一致性，那就根据每个业务自身的特点，采用合适的方式来使系统达到最终一致性。而经过阿里的不断研究，最终提出了柔性事务BASE这样</p> <h2 id="_2、最终一致性事务设计方案"><a href="#_2、最终一致性事务设计方案" class="header-anchor">#</a> 2、最终一致性事务设计方案：</h2> <p>​	一般来说，要达成事务最终一致性，大体上有以下几种处理模式：</p> <ul><li>最大努力通知型：  即分布式事务参与方都努力将自己的事务处理结果通知给分布式事务的其他参与方，也就是只保证尽力而为，不保证一定成功。适用于很多跨公司、流程复杂的场景。例如  电商完成一笔支付需要电商自己更改订单状态，同时需要调用支付宝完成实际支付。这种场景下，如果支付宝处理订单支付出错了，就只能尽力将错误结果通知给电商网站，让电商网站回退订单状态。</li> <li>补偿性：不保证事务实时的对齐状态，对于未对齐的事务，事后进行补偿。同样在电商调用支付宝的这个场景中，就只能通过定期对账的方式保证在一个账期内，双方的事务最终是对齐的，至于具体的每一笔订单，只能进行最大努力通知，不保证事务对齐。</li> <li>异步确保型： 典型的场景就是RocketMQ的事务消息机制。通过不断的异步确认，保证分布式事务的最终一致性。</li> <li>两阶段型： 通常用于都是操作数据库的分布式事务场景。 第一阶段准备阶段：分布式事务的各个参与方都提交自己的本地事务，并且锁定相关的资源。第二阶段提交阶段：由一个第三方的事务协调者综合处理各方的事务执行情况，通知各个参与方统一进行事务提交或者回退。</li></ul> <blockquote><p>与两阶段协议对应的是增强版的三阶段协议。他们的本质区别在于，两阶段协议在准备阶段需要锁定资源，例如在数据库中，就是要加行锁。防止其他事务对数据做了调整，这样会导致在第二个阶段数据无法正常回滚。而对于Redis等其他的一些数据源，无法提供对应的锁资源操作。为了适应这样的场景，就在两阶段的准备阶段之前加一个询问阶段，在这一阶段，事务协调者只是询问各个参与方是否做好了准备。例如对于Redis，可能就是表示创建好了Redis连接。对于数据库，就只是表示已经创建好了JDBC连接。然后在准备阶段，参与者统一去写redo和undo日志，记录自己的事务提交状态。然后在最后的提交阶段，由事务协调者通知各个参与方统一进行事务提交或者回滚。</p> <p>**两阶段协议与三阶段协议的本质区别在于要不要锁资源。三阶段不用锁资源，所以适用性更强，并且对于事务的一致性强度也更高。**但是在编程实现上，两阶段对业务的侵入比较小，在很多框架中，直接声明一个注解就可以完成了。而三阶段对业务的侵入就比较大了，需要所有业务都按照三阶段的要求改造成TCC的模式。所以三阶段适合于一些对分布式事务准确性和时效性要求非常高的场景，比如很多银行系统。例如在一个典型的订单那支付操作中，A需要向B支付100元。使用TCC，在try阶段，通常会要求给订单设定一个状态UPDATING，同时A减少100元，B增加100元，并且将A需要减少的100元与B需要增加的100元这两个数据都单独记录下来，相当于锁定库存。这样可以用来实现类似锁资源的效果。然后在后续的confirm或者cancel操作中，将事务最终进行对齐。在这一步，首先需要修改订单状态，然后修改A和B的账户。这里注意，给A和B调整的账户都需要从锁定的资源中取，而不能凭空修改账户的数据。这是针对事务的高一致性场景进行要求的，任何资源都不能凭空产生。</p></blockquote> <ul><li>SAGA模式：由分布式事务的各个参与方自己提供正向的提交操作以及逆向的回滚操作。事务协调者可以在各个参与方提交事务后，随时协调各个事务参与方进行回滚。具体来说，每个SAGA事务包含T1,T2,T3....Tn操作，每个操作都对应具体的补偿操作C1,C2,C3....Cn。那么SAGA事务就需要保证： 1、所遇事务T1,T2,T3...Tn执行成功(最佳情况)，2、如果有事务执行失败了，  T1,T2,T3....Tj,Cj,....C3,C2,C1执行成功(0&lt;j&lt;n)。例如对于客户扣款100块钱的操作，电商网站和支付宝都提供扣减客户100块钱的操作作为正向事务，同时也提供给客户加100块钱余额的操作作为逆向操作。这样事务协调者可以在检查电商网站和支付宝的扣款行为后，随时通知他们进行回滚。 这种方式对业务的影响也是比较大的。适合于事务流程比较长，参与方比较多的场景。</li></ul> <h2 id="_3、分布式事务的角色划分"><a href="#_3、分布式事务的角色划分" class="header-anchor">#</a> 3、分布式事务的角色划分</h2> <p>​	我们都在知道，处理分布式事务时，由于每个事务参与者都无法知道整个事务的执行情况，所以需要抽取出一个第三方的事务协调者角色来对事务进行协调。那事务协调者要做哪些事情呢？</p> <p>​	我们先来聊一个故事，分布式事务问题的起源： <strong>拜占庭将军问题</strong></p> <p>拜占庭的首都。由于当时拜占庭罗马帝国国土辽阔，为了达到防御目的，每个军队都分隔很远，将军与将军之间只能靠信差传消息。在战争的时候，拜占庭军队内所有将军和副官必须达成一致的共识，决定是否有赢的机会才去攻打敌人的阵营。但是，在军队内有可能存有叛徒和敌军的间谍，左右将军们的决定又扰乱整体军队的秩序。在进行共识时，结果并不代表大多数人的意见。这时候，在已知有成员谋反的情况下，其余忠诚的将军在不受叛徒的影响下如何达成一致的协议，拜占庭问题就此形成。</p> <p>拜占庭将军问题是一个协议问题，拜占庭国军队的将军们必须全体一致的决定是否攻击某一支敌军。问题是这些将军在地理上是分隔开来的，并且将军中存在叛徒。叛徒可以任意行动以达到以下目标：欺骗某些将军采取进攻行动；促成一个不是所有将军都同意的决定，如当将军们不希望进攻时促成进攻行动；或者迷惑某些将军，使他们无法做出决定。如果叛徒达到了这些目的之一，则任何攻击行动的结果都是注定要失败的，只有完全达成一致的努力才能获得胜利  。</p> <p>拜占庭假设是对现实世界的模型化，由于硬件错误、网络拥塞或断开以及遭到恶意攻击，计算机和网络可能出现不可预料的行为。</p> <p>​	分布式场景下，事务参与者已经无法控制整个事务的执行情况，所以需要单独抽取出一个事务协调者对象来对整体事务进度进行控制。所以事务协调者要处理的问题就不只是简单的事务协调，还需要处理非常多的特殊情况。</p> <h1 id="三、分库分表场景下的分布式事务方案"><a href="#三、分库分表场景下的分布式事务方案" class="header-anchor">#</a> 三、分库分表场景下的分布式事务方案</h1> <p>​	接下来回到分库分表的场景下，如果让你来给ShardingJDBC来设计一个事务管理功能，你会怎么选择？两阶段还是三阶段？</p> <p>​	分库分表场景下，针对的都是关系型数据库，是可以锁资源的，所以，肯定会选择两阶段的方式来设计。而两阶段主要有两种方式，就是XA事务和BASE柔性事务。</p> <blockquote><p>理解XA事务和BASE柔性事务的区别的重点在于，协调者角色是谁，以及协调者的职能要求。</p></blockquote> <h2 id="_1、xa事务"><a href="#_1、xa事务" class="header-anchor">#</a> 1、XA事务</h2> <p><strong>什么是XA事务？</strong></p> <p>XA是由X/Open组织提出的分布式事务的规范。 主流的关系型 数据库产品都是实现了XA接口的。  例如在MySQL从5.0.3版本开始，就已经可以直接支持XA事务了，但是要注意只有InnoDB引擎才提供支持。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">//1、 XA START|BEGIN 开启事务，这个test就相当于是事务ID，将事务置于ACTIVE状态</span>
XA <span class="token keyword">START</span> <span class="token string">'test'</span><span class="token punctuation">;</span> 
<span class="token comment">//2、对一个ACTIVE状态的XA事务，执行构成事务的SQL语句。</span>
 <span class="token keyword">insert</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//business sql</span>
<span class="token comment">//3、发布一个XA END指令，将事务置于IDLE状态</span>
XA <span class="token keyword">END</span> <span class="token string">'test'</span><span class="token punctuation">;</span> <span class="token comment">//事务结束</span>
<span class="token comment">//4、对于IDLE状态的XACT事务，执行XA PREPARED指令 将事务置于PREPARED状态。</span>
<span class="token comment">//也可以执行 XA COMMIT 'test' ON PHASE 将预备和提交一起操作。</span>
XA <span class="token keyword">PREPARE</span> <span class="token string">'test'</span><span class="token punctuation">;</span> <span class="token comment">//准备事务</span>
<span class="token comment">//PREPARED状态的事务可以用XA RECOVER指令列出。列出的事务ID会包含gtrid,bqual,formatID和data四个字段。</span>
XA RECOVER；
<span class="token comment">//5、对于PREPARED状态的XA事务，可以进行提交或者回滚。</span>
XA <span class="token keyword">COMMIT</span> <span class="token string">'test'</span><span class="token punctuation">;</span> <span class="token comment">//提交事务</span>
XA <span class="token keyword">ROLLBACK</span> <span class="token string">'test'</span><span class="token punctuation">;</span> <span class="token comment">//回滚事务。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>XA事务中，事务都是有状态控制的，例如如果对于一个ACTIVE状态的事务进行COMMIT提交，mysql就会抛出异常</p> <blockquote><p>ERROR 1399 (XAE07): XAER_RMFAIL: The command cannot be executed when global transaction is in the ACTIVE state</p></blockquote> <p>​	而MySQL的JDBC连接驱动包从5.0.0版本开始，也已经直接支持XA事务。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MysqlXAConnectionTest</span> <span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
      <span class="token comment">//true表示打印XA语句,，用于调试</span>
      <span class="token keyword">boolean</span> logXaCommands <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// 获得资源管理器操作接口实例 RM1</span>
      <span class="token class-name">Connection</span> conn1 <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://localhost:3306/test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">XAConnection</span> xaConn1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlXAConnection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Connection</span><span class="token punctuation">)</span> conn1<span class="token punctuation">,</span> logXaCommands<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">XAResource</span> rm1 <span class="token operator">=</span> xaConn1<span class="token punctuation">.</span><span class="token function">getXAResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 获得资源管理器操作接口实例 RM2</span>
      <span class="token class-name">Connection</span> conn2 <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://localhost:3306/test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">XAConnection</span> xaConn2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlXAConnection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Connection</span><span class="token punctuation">)</span> conn2<span class="token punctuation">,</span> logXaCommands<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">XAResource</span> rm2 <span class="token operator">=</span> xaConn2<span class="token punctuation">.</span><span class="token function">getXAResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// AP请求TM执行一个分布式事务，TM生成全局事务id</span>
      <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gtrid <span class="token operator">=</span> <span class="token string">&quot;g12345&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> formatId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// ==============分别执行RM1和RM2上的事务分支====================</span>
         <span class="token comment">// TM生成rm1上的事务分支id</span>
         <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bqual1 <span class="token operator">=</span> <span class="token string">&quot;b00001&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">Xid</span> xid1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlXid</span><span class="token punctuation">(</span>gtrid<span class="token punctuation">,</span> bqual1<span class="token punctuation">,</span> formatId<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 执行rm1上的事务分支</span>
         rm1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>xid1<span class="token punctuation">,</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span><span class="token constant">TMNOFLAGS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//One of TMNOFLAGS, TMJOIN, or TMRESUME.</span>
         <span class="token class-name">PreparedStatement</span> ps1 <span class="token operator">=</span> conn1<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT into user(name) VALUES ('tianshouzhi')&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         ps1<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         rm1<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>xid1<span class="token punctuation">,</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span><span class="token constant">TMSUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// TM生成rm2上的事务分支id</span>
         <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bqual2 <span class="token operator">=</span> <span class="token string">&quot;b00002&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">Xid</span> xid2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlXid</span><span class="token punctuation">(</span>gtrid<span class="token punctuation">,</span> bqual2<span class="token punctuation">,</span> formatId<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 执行rm2上的事务分支</span>
         rm2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>xid2<span class="token punctuation">,</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span><span class="token constant">TMNOFLAGS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">PreparedStatement</span> ps2 <span class="token operator">=</span> conn2<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT into user(name) VALUES ('wangxiaoxiao')&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         ps2<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         rm2<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>xid2<span class="token punctuation">,</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span><span class="token constant">TMSUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// ===================两阶段提交================================</span>
         <span class="token comment">// phase1：询问所有的RM 准备提交事务分支</span>
         <span class="token keyword">int</span> rm1_prepare <span class="token operator">=</span> rm1<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>xid1<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">int</span> rm2_prepare <span class="token operator">=</span> rm2<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>xid2<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// phase2：提交所有事务分支</span>
         <span class="token keyword">boolean</span> onePhase <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//TM判断有2个事务分支，所以不能优化为一阶段提交</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>rm1_prepare <span class="token operator">==</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span><span class="token constant">XA_OK</span>
               <span class="token operator">&amp;&amp;</span> rm2_prepare <span class="token operator">==</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span><span class="token constant">XA_OK</span>
               <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//所有事务分支都prepare成功，提交所有事务分支</span>
            rm1<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>xid1<span class="token punctuation">,</span> onePhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rm2<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>xid2<span class="token punctuation">,</span> onePhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//如果有事务分支没有成功，则回滚</span>
            rm1<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>xid1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rm1<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>xid2<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XAException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 如果出现异常，也要进行回滚</span>
         e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><blockquote><p>之前跟一个同学讨论了一个有意思的问题：在mysql当中，使用begin、commit、rollback语句也能实现二阶段执行，但是，他是不是就可以作为一个分布式事务的实现方案呢？</p> <p>begin;</p> <p>insert into user values('aaa');</p> <p>select * from user;</p> <p>rollback;
--commit;</p> <p>select * from user;</p></blockquote> <p>​	这其中，XA标准规范了事务XID的格式。有三个部分: gtrid [, bqual [, formatID ]] 其中</p> <ul><li>gtrid 是一个全局事务标识符 global transaction identifier</li> <li>bqual 是一个分支限定符 branch qualifier 。如果没有提供，会使用默认值就是一个空字符串。</li> <li>formatID 是一个数字，用于标记gtrid和bqual值的格式，这是一个正整数，最小为0，默认值就是1。</li></ul> <p>但是使用XA事务时需要注意以下几点：</p> <ul><li>XA事务无法自动提交</li> <li>XA事务效率非常低下，全局事务的状态都需要持久化。性能非常低下，通常耗时能达到本地事务的10倍。</li> <li>XA事务在提交前出现故障的话，很难将问题隔离开。</li></ul> <blockquote><p>XA事务只是一套规范，并不限定具体的语言。在JAVA当中有JTA规范来支持XA事务，具体有很多个实现框架。比如ShardingSphere默认采用atomikos作为实现框架。同时，也支持bitronix、narayana等框架，甚至提供了SPI扩展点，可以自行扩展具体的实现。如果对分布式事务真正感兴趣的同学，不妨自行去深入理解下这几个框架。</p></blockquote> <h2 id="_2、base柔性事务"><a href="#_2、base柔性事务" class="header-anchor">#</a> 2、BASE柔性事务</h2> <p>BASE柔性事务是指 Basic Available(基本可用)、Soft-state(软状态/柔性事务)、Eventual  Consistency(最终一致性)。从广义上来看，像XA事务其实也是属于一种柔性事务。但是一般情况下，BASE柔性事务特指Seata框架提供的柔性事务，因为BASE实际上是集成了阿里对于分布式事务的所有研究，而阿里的这些研究成果，最终都沉淀到了Seata框架中。ShardingSphere中对于柔性事务的支持，其实也是更多的基于Seata的AT模式，来实现的两阶段提交。这里要注意的是，虽然XA和AT都是基于两阶段协议提供的实现，但是AT模式相比XA模式，简化了对于资源锁的要求，所以可以认为在大部分的业务场景下，AT模式比XA模式性能稍高。</p> <h1 id="四、xa事务和base柔性事务实战"><a href="#四、xa事务和base柔性事务实战" class="header-anchor">#</a> 四、XA事务和BASE柔性事务实战</h1> <h2 id="_1、分库分表场景下的分布式事务问题"><a href="#_1、分库分表场景下的分布式事务问题" class="header-anchor">#</a> 1、分库分表场景下的分布式事务问题：</h2> <p>修改完成后，下单操作需要插入两张逻辑表。oms_order和oms_order_item。这时候，如果插入oms_order数据成功，但是插入oms_order_item失败，就会造成事务不一致的问题。 这种情况在分库分表下会怎么样？就从一个本地事务问题升级成了分布式事务问题。</p> <p>在这种场景下，适合哪种方式处理？</p> <blockquote><p>分库分表只针对关系型数据库，所以采用两阶段事务处理就足够了。</p></blockquote> <p>ShardingSphere基于SPI扩展分布式事务管理器。官方提供了两种实现方式， XA事务和Seata AT事务。</p> <h3 id="xa事务"><a href="#xa事务" class="header-anchor">#</a> XA事务</h3> <p>需要引入maven依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- 使用XA事务时，需要引入此模块 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sharding-transaction-xa-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${shardingsphere.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>然后使用的话，需要在MyBatis中打开@EnableTransactionManagement注解。然后注入PlatformTransactionManager对象。</p> <p>然后在OmsPortalOrderService的generateOrder方法上打开@Transactional注解 和 @ShardingTransactionType(TransactionType.XA) 注解。</p> <p>然后就可以来测试了。  把其中一个oms_order_item表删掉，然后从前端下单，来测试下。如果报错了就检查oms_order表的数据是否回滚了。--也可以从源码的BusiTest案例来测试。这个测试需要打开SeataATOrderService相关的application.properties配置文件。</p> <blockquote><p>SPI扩展机制见sharding-transaction-xa-core-4.1.1.jar下的  \META-INF\services\org.apache.shardingsphere.transaction.spi.ShardingTransactionManager。这个就是SPI扩展配置文件。</p></blockquote> <h3 id="seata-at事务"><a href="#seata-at事务" class="header-anchor">#</a> Seata AT事务</h3> <p>首先需要提前部署好Seata，采用nacos配置中心，把Seata的一大堆配置项都提前导入到nacos中。</p> <p>使用时，需要引入依赖以下依赖，并且把XA事务的依赖去掉。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;!-- 使用BASE事务时，需要引入此模块 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;
    &lt;artifactId&gt;sharding-transaction-base-seata-at&lt;/artifactId&gt;
    &lt;version&gt;${sharding-sphere.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>然后需要在resource下添加seata.conf文件。文件内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>client {
    application.id = example    ## 应用唯一id
    transaction.service.group = my_test_tx_group   ## 所属事务组
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后需要在每个数据分片建立undo_log表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>undo_log<span class="token punctuation">`</span></span>
<span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>            <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'increment id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span>     <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'branch transaction id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>           <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'global transaction id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>context<span class="token punctuation">`</span></span>       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'undo_log context,such as serialization'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rollback_info<span class="token punctuation">`</span></span> <span class="token keyword">LONGBLOB</span>     <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'rollback info'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>log_status<span class="token punctuation">`</span></span>    <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'0:normal status,1:defense status'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>log_created<span class="token punctuation">`</span></span>   <span class="token keyword">DATETIME</span>     <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'create datetime'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>log_modified<span class="token punctuation">`</span></span>  <span class="token keyword">DATETIME</span>     <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'modify datetime'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>ux_undo_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
  <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COMMENT</span> <span class="token operator">=</span><span class="token string">'AT transaction mode undo table'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>测试示例在BusiTest中。尽量就不要到实际项目中去试了，seata这东西问题太多了。</p> <blockquote><p>代码已经修改完成。下单操作只需要切换Pom依赖就可以了。然后用PostMan进行下单操作(下单操作已经修改过，下单后不会删除购物车的物品，所以可以不停的重复下单)。通过调整表名制造出分布式事务的事件。</p></blockquote> <h1 id="五、sharingproxy的分布式事务"><a href="#五、sharingproxy的分布式事务" class="header-anchor">#</a> 五、SharingProxy的分布式事务</h1> <p>​	对于ShardingProxy，由于他的功能并没有ShardingJDBC那么灵活，所以在ShardingProxy中使用分布式事务的方式就简单很多。</p> <p>对于XA事务：可以直接在config配置文件中将事务直接配置为XA。默认就会采用Atomikos来实现，当然也可以自行选择其他的实现框架，但是需要手动替换jar包。。而如果要使用seata的BASE柔性事务，就需要自行将jar包拷贝到lib目录下，比较麻烦，一般项目中很少用到。</p> <h1 id="六、分库分表课程总结"><a href="#六、分库分表课程总结" class="header-anchor">#</a> 六、分库分表课程总结</h1> <p>传统的关系型数据库像mysql,oracle，他们的集群功能往往都是偏弱的。当他们面临数据量过大的问题时，往往有两个解决思路，一种就是换产品，换成VoltDB、TiDB、ES、Hbase等这些大数据产品，但是换产品往往需要大量的投入，包括资金、人力投入，更重要的是要对项目进行大的改造，难以保证项目整体的稳定性。所以最常使用的还是第二种方案，即分库分表。</p> <p>分库分表看似只是将数据简单的从一个数据库分布多个数据库，但是需要面对的问题还是非常多的。而shardingsphere框架能够很好的帮我们解决分库分表面临的非常多的问题。我们只需要对核心业务进行简单配置，就能够实现分库分表。课上也带大家在实战项目中实现了对电商订单的分库分表配置。但是，框架功能虽然强大，但是要用好shrdingsphere，也对技术提出了更高的门槛。另外，ShardingSphere的功能非常多，留给用户的扩展点也很多，如果在项目中真正想要把ShardingSphere用好的话，还是需要回顾下我们的shardingsphere的VIP课程，或者自行查阅资料，加深对ShardingSphere的理解，这个框架绝对不是简单的配置下分库分表就可以用了的。</p> <p>分库分表带来了数据扩展性，但是同时也带来了非常多的问题。其中分布式事务就是最为令人头疼的问题。ShardingSphere集成了主流的开源框架，同时也预留了SPI扩展点，让用户自行扩展分布式事务逻辑。但是，分布式事务是个非常非常复杂的问题，在不同场景下需要有不同的控制方式。电商项目只是向大家展示了分布式事务很小的一个场景，在项目中面临不同业务场景时，针对分布式事务也需要有不同的取舍与设计方式。这样才能设计出高质量的三高项目。</p></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/06/25, 15:58:02</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/7c3ae9/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">秒杀链路兜底方案之限流和降级实战</div></a> <a href="/pages/21df2c/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">项目实战总结与项目管理分享</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/7c3ae9/" class="prev">秒杀链路兜底方案之限流和降级实战</a></span> <span class="next"><a href="/pages/21df2c/">项目实战总结与项目管理分享</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/80365f/"><div>
            证券市场基本法律法规
            <!----></div></a> <span class="date">03-13</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/d9e4f4/"><div>
            证券考试规则
            <!----></div></a> <span class="date">03-12</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/cb2c17/"><div>
            金融市场基础知识
            <!----></div></a> <span class="date">03-12</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:cloudjava@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/bigdatajava" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/nylg" title="Gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2014-2024
    <span>wen chao | <a href="https://github.com/bigdatajava/blog-talk/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.b2807c2b.js" defer></script><script src="/assets/js/2.eeaab5de.js" defer></script><script src="/assets/js/267.c9ede946.js" defer></script>
  </body>
</html>

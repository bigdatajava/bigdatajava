<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RocketMQ综述 | wen chao</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3129839_xft6cqs5gc.css">
    <meta name="description" content="架构进阶之路...">
    <meta name="keywords" content="全栈博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,js,ES6,TypeScript,vue">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.877370ef.css" as="style"><link rel="preload" href="/assets/js/app.af2629f3.js" as="script"><link rel="preload" href="/assets/js/2.c7acc05c.js" as="script"><link rel="preload" href="/assets/js/60.ca146265.js" as="script"><link rel="prefetch" href="/assets/js/10.003809e3.js"><link rel="prefetch" href="/assets/js/100.05e6d7b0.js"><link rel="prefetch" href="/assets/js/101.aedcfb99.js"><link rel="prefetch" href="/assets/js/102.0f45ef0b.js"><link rel="prefetch" href="/assets/js/103.f6349067.js"><link rel="prefetch" href="/assets/js/104.159e4fea.js"><link rel="prefetch" href="/assets/js/105.cf376772.js"><link rel="prefetch" href="/assets/js/106.4a24f110.js"><link rel="prefetch" href="/assets/js/107.9130a4fc.js"><link rel="prefetch" href="/assets/js/108.557f1de3.js"><link rel="prefetch" href="/assets/js/109.0eae2c98.js"><link rel="prefetch" href="/assets/js/11.46d1f704.js"><link rel="prefetch" href="/assets/js/110.be00b9ae.js"><link rel="prefetch" href="/assets/js/111.454bc20b.js"><link rel="prefetch" href="/assets/js/112.c987bc96.js"><link rel="prefetch" href="/assets/js/113.f07c8b3c.js"><link rel="prefetch" href="/assets/js/114.ab099d7d.js"><link rel="prefetch" href="/assets/js/115.a5bda3c7.js"><link rel="prefetch" href="/assets/js/116.eb280ad8.js"><link rel="prefetch" href="/assets/js/117.1863722f.js"><link rel="prefetch" href="/assets/js/118.3f192a2d.js"><link rel="prefetch" href="/assets/js/119.66b89deb.js"><link rel="prefetch" href="/assets/js/12.03486813.js"><link rel="prefetch" href="/assets/js/120.69b1d465.js"><link rel="prefetch" href="/assets/js/121.113b1b5a.js"><link rel="prefetch" href="/assets/js/122.917086b7.js"><link rel="prefetch" href="/assets/js/123.ef1b72cd.js"><link rel="prefetch" href="/assets/js/124.a52fd442.js"><link rel="prefetch" href="/assets/js/125.65cf0d15.js"><link rel="prefetch" href="/assets/js/126.9257bcef.js"><link rel="prefetch" href="/assets/js/127.c080527e.js"><link rel="prefetch" href="/assets/js/128.90389431.js"><link rel="prefetch" href="/assets/js/129.582bff3e.js"><link rel="prefetch" href="/assets/js/13.ba8e34d1.js"><link rel="prefetch" href="/assets/js/130.fb170212.js"><link rel="prefetch" href="/assets/js/131.ed138ac9.js"><link rel="prefetch" href="/assets/js/132.4223d6f9.js"><link rel="prefetch" href="/assets/js/133.012411be.js"><link rel="prefetch" href="/assets/js/134.ed98c78a.js"><link rel="prefetch" href="/assets/js/135.2b6eb13f.js"><link rel="prefetch" href="/assets/js/136.65149943.js"><link rel="prefetch" href="/assets/js/137.341d7363.js"><link rel="prefetch" href="/assets/js/138.e9834544.js"><link rel="prefetch" href="/assets/js/139.ff517435.js"><link rel="prefetch" href="/assets/js/14.71b2ed4a.js"><link rel="prefetch" href="/assets/js/140.bf2b9d2d.js"><link rel="prefetch" href="/assets/js/141.ef8d876a.js"><link rel="prefetch" href="/assets/js/142.c28e6ef9.js"><link rel="prefetch" href="/assets/js/143.d0b43d89.js"><link rel="prefetch" href="/assets/js/144.9545dbb1.js"><link rel="prefetch" href="/assets/js/145.c5c5aca2.js"><link rel="prefetch" href="/assets/js/146.c6989cd8.js"><link rel="prefetch" href="/assets/js/147.fe16ad8a.js"><link rel="prefetch" href="/assets/js/148.102ea00d.js"><link rel="prefetch" href="/assets/js/149.2e62b9d1.js"><link rel="prefetch" href="/assets/js/15.1736a531.js"><link rel="prefetch" href="/assets/js/150.daf684ac.js"><link rel="prefetch" href="/assets/js/151.988a3ba9.js"><link rel="prefetch" href="/assets/js/152.4742bb74.js"><link rel="prefetch" href="/assets/js/153.02bcce99.js"><link rel="prefetch" href="/assets/js/154.ebde7923.js"><link rel="prefetch" href="/assets/js/155.c906862e.js"><link rel="prefetch" href="/assets/js/156.3b3d94d4.js"><link rel="prefetch" href="/assets/js/157.81d8c740.js"><link rel="prefetch" href="/assets/js/158.40095645.js"><link rel="prefetch" href="/assets/js/159.2abc32c5.js"><link rel="prefetch" href="/assets/js/16.fb9d3b9b.js"><link rel="prefetch" href="/assets/js/160.dfa13df3.js"><link rel="prefetch" href="/assets/js/161.5697eb79.js"><link rel="prefetch" href="/assets/js/162.fef5ab87.js"><link rel="prefetch" href="/assets/js/163.8b3dff03.js"><link rel="prefetch" href="/assets/js/164.826228d2.js"><link rel="prefetch" href="/assets/js/165.e0099d56.js"><link rel="prefetch" href="/assets/js/166.8294f6c0.js"><link rel="prefetch" href="/assets/js/167.d07b77dd.js"><link rel="prefetch" href="/assets/js/168.c23c0d7b.js"><link rel="prefetch" href="/assets/js/169.c7f7599b.js"><link rel="prefetch" href="/assets/js/17.e42188aa.js"><link rel="prefetch" href="/assets/js/170.b11ea482.js"><link rel="prefetch" href="/assets/js/171.73278046.js"><link rel="prefetch" href="/assets/js/172.040cd7fc.js"><link rel="prefetch" href="/assets/js/173.e0199ce5.js"><link rel="prefetch" href="/assets/js/174.3010733d.js"><link rel="prefetch" href="/assets/js/175.05c196ea.js"><link rel="prefetch" href="/assets/js/176.c490fc2b.js"><link rel="prefetch" href="/assets/js/177.7bcb888a.js"><link rel="prefetch" href="/assets/js/178.34093cd3.js"><link rel="prefetch" href="/assets/js/179.b2413571.js"><link rel="prefetch" href="/assets/js/18.383f6a09.js"><link rel="prefetch" href="/assets/js/180.9648ec05.js"><link rel="prefetch" href="/assets/js/181.342f0059.js"><link rel="prefetch" href="/assets/js/182.35eac70e.js"><link rel="prefetch" href="/assets/js/183.f4a83742.js"><link rel="prefetch" href="/assets/js/184.d82b8a96.js"><link rel="prefetch" href="/assets/js/185.9f5f32ef.js"><link rel="prefetch" href="/assets/js/186.600a4950.js"><link rel="prefetch" href="/assets/js/187.df953d4f.js"><link rel="prefetch" href="/assets/js/188.2491fa83.js"><link rel="prefetch" href="/assets/js/189.32d3c1a4.js"><link rel="prefetch" href="/assets/js/19.cb72d9a9.js"><link rel="prefetch" href="/assets/js/190.39ac92fc.js"><link rel="prefetch" href="/assets/js/191.3125fa77.js"><link rel="prefetch" href="/assets/js/192.7655632a.js"><link rel="prefetch" href="/assets/js/193.7f55a678.js"><link rel="prefetch" href="/assets/js/194.b9c56642.js"><link rel="prefetch" href="/assets/js/195.189fe681.js"><link rel="prefetch" href="/assets/js/196.71658166.js"><link rel="prefetch" href="/assets/js/197.af445c6a.js"><link rel="prefetch" href="/assets/js/198.1de2afd9.js"><link rel="prefetch" href="/assets/js/199.2c218726.js"><link rel="prefetch" href="/assets/js/20.0e9f2f72.js"><link rel="prefetch" href="/assets/js/200.26590f9f.js"><link rel="prefetch" href="/assets/js/201.36d7a8ea.js"><link rel="prefetch" href="/assets/js/202.6c36d934.js"><link rel="prefetch" href="/assets/js/203.d4ae9b00.js"><link rel="prefetch" href="/assets/js/204.c3b2f994.js"><link rel="prefetch" href="/assets/js/205.f480166b.js"><link rel="prefetch" href="/assets/js/206.90dc53ae.js"><link rel="prefetch" href="/assets/js/207.f959801b.js"><link rel="prefetch" href="/assets/js/208.5da4dac0.js"><link rel="prefetch" href="/assets/js/209.217e41a9.js"><link rel="prefetch" href="/assets/js/21.7a7c5c4f.js"><link rel="prefetch" href="/assets/js/210.fb1d985a.js"><link rel="prefetch" href="/assets/js/211.5a3d515c.js"><link rel="prefetch" href="/assets/js/212.bb654f9b.js"><link rel="prefetch" href="/assets/js/213.b8f5ac66.js"><link rel="prefetch" href="/assets/js/214.cfb1547f.js"><link rel="prefetch" href="/assets/js/215.a1de2fe7.js"><link rel="prefetch" href="/assets/js/216.d76003a4.js"><link rel="prefetch" href="/assets/js/217.ad201174.js"><link rel="prefetch" href="/assets/js/218.5adcad1a.js"><link rel="prefetch" href="/assets/js/219.9f3b9b01.js"><link rel="prefetch" href="/assets/js/22.b9540503.js"><link rel="prefetch" href="/assets/js/220.af64e5ad.js"><link rel="prefetch" href="/assets/js/221.379beb37.js"><link rel="prefetch" href="/assets/js/222.85aa5cd0.js"><link rel="prefetch" href="/assets/js/223.13475fe5.js"><link rel="prefetch" href="/assets/js/224.d06abfcb.js"><link rel="prefetch" href="/assets/js/225.1f738876.js"><link rel="prefetch" href="/assets/js/226.a09031a1.js"><link rel="prefetch" href="/assets/js/227.f6018b9a.js"><link rel="prefetch" href="/assets/js/228.ae3296e4.js"><link rel="prefetch" href="/assets/js/229.d9bcea85.js"><link rel="prefetch" href="/assets/js/23.6b5fd8ae.js"><link rel="prefetch" href="/assets/js/230.68a89532.js"><link rel="prefetch" href="/assets/js/231.b31aa02f.js"><link rel="prefetch" href="/assets/js/232.cc07d501.js"><link rel="prefetch" href="/assets/js/233.76443c50.js"><link rel="prefetch" href="/assets/js/234.5efbcd6a.js"><link rel="prefetch" href="/assets/js/235.dfcf36cf.js"><link rel="prefetch" href="/assets/js/236.4bb99856.js"><link rel="prefetch" href="/assets/js/237.79a22c20.js"><link rel="prefetch" href="/assets/js/238.1b592be7.js"><link rel="prefetch" href="/assets/js/239.a4c119aa.js"><link rel="prefetch" href="/assets/js/24.63372db7.js"><link rel="prefetch" href="/assets/js/240.22d7d47a.js"><link rel="prefetch" href="/assets/js/241.36336698.js"><link rel="prefetch" href="/assets/js/242.b7db4d20.js"><link rel="prefetch" href="/assets/js/243.f156bf47.js"><link rel="prefetch" href="/assets/js/244.14f3046b.js"><link rel="prefetch" href="/assets/js/245.984447ea.js"><link rel="prefetch" href="/assets/js/246.cd55bf13.js"><link rel="prefetch" href="/assets/js/247.d2a77b3d.js"><link rel="prefetch" href="/assets/js/248.c23e38fd.js"><link rel="prefetch" href="/assets/js/249.a0b42d1f.js"><link rel="prefetch" href="/assets/js/25.d3f99e2a.js"><link rel="prefetch" href="/assets/js/250.870b2e9a.js"><link rel="prefetch" href="/assets/js/251.ee8edd7f.js"><link rel="prefetch" href="/assets/js/252.15e2c05e.js"><link rel="prefetch" href="/assets/js/253.18d0fc46.js"><link rel="prefetch" href="/assets/js/254.39ecf5f7.js"><link rel="prefetch" href="/assets/js/255.d42ae6e7.js"><link rel="prefetch" href="/assets/js/256.5a2b4630.js"><link rel="prefetch" href="/assets/js/257.df147154.js"><link rel="prefetch" href="/assets/js/258.f42bcf46.js"><link rel="prefetch" href="/assets/js/259.022f92f9.js"><link rel="prefetch" href="/assets/js/26.c6b54266.js"><link rel="prefetch" href="/assets/js/260.abb07bf2.js"><link rel="prefetch" href="/assets/js/261.74b1bebb.js"><link rel="prefetch" href="/assets/js/262.680edf56.js"><link rel="prefetch" href="/assets/js/263.0cdbe35a.js"><link rel="prefetch" href="/assets/js/264.ea699edd.js"><link rel="prefetch" href="/assets/js/265.cf168b25.js"><link rel="prefetch" href="/assets/js/266.18f03883.js"><link rel="prefetch" href="/assets/js/267.007dcd30.js"><link rel="prefetch" href="/assets/js/268.41de028b.js"><link rel="prefetch" href="/assets/js/269.e206560c.js"><link rel="prefetch" href="/assets/js/27.120b6069.js"><link rel="prefetch" href="/assets/js/270.164398a3.js"><link rel="prefetch" href="/assets/js/271.7d100757.js"><link rel="prefetch" href="/assets/js/272.0b83e5d3.js"><link rel="prefetch" href="/assets/js/273.f317bcb6.js"><link rel="prefetch" href="/assets/js/274.2947d9f0.js"><link rel="prefetch" href="/assets/js/275.e99b65f2.js"><link rel="prefetch" href="/assets/js/276.ea03cf89.js"><link rel="prefetch" href="/assets/js/277.93476fbc.js"><link rel="prefetch" href="/assets/js/278.db0ff8eb.js"><link rel="prefetch" href="/assets/js/279.b36007aa.js"><link rel="prefetch" href="/assets/js/28.91595b48.js"><link rel="prefetch" href="/assets/js/280.14723ae7.js"><link rel="prefetch" href="/assets/js/281.f27b79de.js"><link rel="prefetch" href="/assets/js/282.718708d7.js"><link rel="prefetch" href="/assets/js/283.f91a771c.js"><link rel="prefetch" href="/assets/js/284.25b1d4f7.js"><link rel="prefetch" href="/assets/js/285.a641722b.js"><link rel="prefetch" href="/assets/js/286.9d2d85fb.js"><link rel="prefetch" href="/assets/js/287.a8a0d7a2.js"><link rel="prefetch" href="/assets/js/288.ee27e2fe.js"><link rel="prefetch" href="/assets/js/289.e4300193.js"><link rel="prefetch" href="/assets/js/29.a5ef89d9.js"><link rel="prefetch" href="/assets/js/290.ba445f12.js"><link rel="prefetch" href="/assets/js/291.7a767d85.js"><link rel="prefetch" href="/assets/js/292.aa96cc76.js"><link rel="prefetch" href="/assets/js/293.e18d36c6.js"><link rel="prefetch" href="/assets/js/294.7113dff7.js"><link rel="prefetch" href="/assets/js/295.abae5e0e.js"><link rel="prefetch" href="/assets/js/296.010241c4.js"><link rel="prefetch" href="/assets/js/297.4bbe88fd.js"><link rel="prefetch" href="/assets/js/298.9f291f83.js"><link rel="prefetch" href="/assets/js/299.bf9e031a.js"><link rel="prefetch" href="/assets/js/3.1403d3ee.js"><link rel="prefetch" href="/assets/js/30.3bb57e98.js"><link rel="prefetch" href="/assets/js/300.fc58f3c4.js"><link rel="prefetch" href="/assets/js/301.69cd291f.js"><link rel="prefetch" href="/assets/js/302.c34ca8e9.js"><link rel="prefetch" href="/assets/js/303.25655f40.js"><link rel="prefetch" href="/assets/js/304.97a8e358.js"><link rel="prefetch" href="/assets/js/305.1c5e713f.js"><link rel="prefetch" href="/assets/js/306.b53f2ea6.js"><link rel="prefetch" href="/assets/js/307.e4a9a150.js"><link rel="prefetch" href="/assets/js/308.92931c17.js"><link rel="prefetch" href="/assets/js/309.6e452bde.js"><link rel="prefetch" href="/assets/js/31.f1ddaeee.js"><link rel="prefetch" href="/assets/js/310.6abc9668.js"><link rel="prefetch" href="/assets/js/311.1bd77809.js"><link rel="prefetch" href="/assets/js/312.78b7405d.js"><link rel="prefetch" href="/assets/js/313.3b23ded5.js"><link rel="prefetch" href="/assets/js/314.ae150cf1.js"><link rel="prefetch" href="/assets/js/315.d375ed9c.js"><link rel="prefetch" href="/assets/js/316.c8a05987.js"><link rel="prefetch" href="/assets/js/317.febd6c4f.js"><link rel="prefetch" href="/assets/js/318.34fe4d11.js"><link rel="prefetch" href="/assets/js/319.5b558d88.js"><link rel="prefetch" href="/assets/js/32.8019bc57.js"><link rel="prefetch" href="/assets/js/320.af89e963.js"><link rel="prefetch" href="/assets/js/321.f646b641.js"><link rel="prefetch" href="/assets/js/322.897f28f1.js"><link rel="prefetch" href="/assets/js/323.38229c39.js"><link rel="prefetch" href="/assets/js/324.7baf2418.js"><link rel="prefetch" href="/assets/js/325.e0225366.js"><link rel="prefetch" href="/assets/js/326.e30b69cd.js"><link rel="prefetch" href="/assets/js/327.6774c791.js"><link rel="prefetch" href="/assets/js/328.58239b5d.js"><link rel="prefetch" href="/assets/js/329.570eb01e.js"><link rel="prefetch" href="/assets/js/33.2009be2a.js"><link rel="prefetch" href="/assets/js/330.6c29d590.js"><link rel="prefetch" href="/assets/js/331.bbe673f1.js"><link rel="prefetch" href="/assets/js/332.6d2bbedd.js"><link rel="prefetch" href="/assets/js/333.7e60b6bd.js"><link rel="prefetch" href="/assets/js/334.9f9ea9bb.js"><link rel="prefetch" href="/assets/js/335.0f60cf92.js"><link rel="prefetch" href="/assets/js/336.3981edeb.js"><link rel="prefetch" href="/assets/js/337.0ca91dae.js"><link rel="prefetch" href="/assets/js/338.09e14c30.js"><link rel="prefetch" href="/assets/js/339.31147ffa.js"><link rel="prefetch" href="/assets/js/34.f4ffaa4e.js"><link rel="prefetch" href="/assets/js/340.b216b6b7.js"><link rel="prefetch" href="/assets/js/341.7af949b2.js"><link rel="prefetch" href="/assets/js/342.03e80905.js"><link rel="prefetch" href="/assets/js/343.147ff16c.js"><link rel="prefetch" href="/assets/js/344.c95f6de9.js"><link rel="prefetch" href="/assets/js/345.7cc8cfaa.js"><link rel="prefetch" href="/assets/js/346.d5ff42a4.js"><link rel="prefetch" href="/assets/js/347.f1f1478f.js"><link rel="prefetch" href="/assets/js/348.32ea340f.js"><link rel="prefetch" href="/assets/js/349.4d743984.js"><link rel="prefetch" href="/assets/js/35.6f997bc2.js"><link rel="prefetch" href="/assets/js/350.c218cb98.js"><link rel="prefetch" href="/assets/js/351.a6f08d8b.js"><link rel="prefetch" href="/assets/js/352.46538632.js"><link rel="prefetch" href="/assets/js/353.6702d9ff.js"><link rel="prefetch" href="/assets/js/354.10264327.js"><link rel="prefetch" href="/assets/js/355.bc66e304.js"><link rel="prefetch" href="/assets/js/356.36d9208c.js"><link rel="prefetch" href="/assets/js/357.708af07a.js"><link rel="prefetch" href="/assets/js/358.61ab6834.js"><link rel="prefetch" href="/assets/js/359.bb4ad887.js"><link rel="prefetch" href="/assets/js/36.5172c464.js"><link rel="prefetch" href="/assets/js/360.9ae57e7b.js"><link rel="prefetch" href="/assets/js/37.72aa4947.js"><link rel="prefetch" href="/assets/js/38.77129de5.js"><link rel="prefetch" href="/assets/js/39.01d84c7e.js"><link rel="prefetch" href="/assets/js/4.5517c98c.js"><link rel="prefetch" href="/assets/js/40.b2fb57bd.js"><link rel="prefetch" href="/assets/js/41.fa63fb49.js"><link rel="prefetch" href="/assets/js/42.c68fd691.js"><link rel="prefetch" href="/assets/js/43.071af6f3.js"><link rel="prefetch" href="/assets/js/44.99321348.js"><link rel="prefetch" href="/assets/js/45.4c105e24.js"><link rel="prefetch" href="/assets/js/46.91a5aa2c.js"><link rel="prefetch" href="/assets/js/47.18bd4930.js"><link rel="prefetch" href="/assets/js/48.deef5f67.js"><link rel="prefetch" href="/assets/js/49.12c80dd9.js"><link rel="prefetch" href="/assets/js/5.6b7a7b35.js"><link rel="prefetch" href="/assets/js/50.259ff32b.js"><link rel="prefetch" href="/assets/js/51.ee83db82.js"><link rel="prefetch" href="/assets/js/52.1cf54e16.js"><link rel="prefetch" href="/assets/js/53.821dd297.js"><link rel="prefetch" href="/assets/js/54.bf29c9d1.js"><link rel="prefetch" href="/assets/js/55.25e00784.js"><link rel="prefetch" href="/assets/js/56.b1112045.js"><link rel="prefetch" href="/assets/js/57.5923ed3a.js"><link rel="prefetch" href="/assets/js/58.ee7fa86f.js"><link rel="prefetch" href="/assets/js/59.7b9800f0.js"><link rel="prefetch" href="/assets/js/6.207c7bac.js"><link rel="prefetch" href="/assets/js/61.77a27075.js"><link rel="prefetch" href="/assets/js/62.2839e098.js"><link rel="prefetch" href="/assets/js/63.6c8cdea8.js"><link rel="prefetch" href="/assets/js/64.1a5f538c.js"><link rel="prefetch" href="/assets/js/65.a3708a3e.js"><link rel="prefetch" href="/assets/js/66.63a1d86b.js"><link rel="prefetch" href="/assets/js/67.5563ad9d.js"><link rel="prefetch" href="/assets/js/68.182b4324.js"><link rel="prefetch" href="/assets/js/69.b695215c.js"><link rel="prefetch" href="/assets/js/7.00b0f0bb.js"><link rel="prefetch" href="/assets/js/70.819c0991.js"><link rel="prefetch" href="/assets/js/71.534cf941.js"><link rel="prefetch" href="/assets/js/72.b3c641ef.js"><link rel="prefetch" href="/assets/js/73.e613a0d5.js"><link rel="prefetch" href="/assets/js/74.d7fc07e0.js"><link rel="prefetch" href="/assets/js/75.d50101e4.js"><link rel="prefetch" href="/assets/js/76.18e7ac7b.js"><link rel="prefetch" href="/assets/js/77.bb898521.js"><link rel="prefetch" href="/assets/js/78.a08d2106.js"><link rel="prefetch" href="/assets/js/79.0f362a00.js"><link rel="prefetch" href="/assets/js/8.197a9ad8.js"><link rel="prefetch" href="/assets/js/80.8b74cf4c.js"><link rel="prefetch" href="/assets/js/81.3e8c87af.js"><link rel="prefetch" href="/assets/js/82.83cb55b7.js"><link rel="prefetch" href="/assets/js/83.7355f968.js"><link rel="prefetch" href="/assets/js/84.51061851.js"><link rel="prefetch" href="/assets/js/85.b5df8911.js"><link rel="prefetch" href="/assets/js/86.baf2296e.js"><link rel="prefetch" href="/assets/js/87.2e9ae95d.js"><link rel="prefetch" href="/assets/js/88.57a8401a.js"><link rel="prefetch" href="/assets/js/89.a0d99eba.js"><link rel="prefetch" href="/assets/js/9.53a0556a.js"><link rel="prefetch" href="/assets/js/90.6121d367.js"><link rel="prefetch" href="/assets/js/91.56f285e2.js"><link rel="prefetch" href="/assets/js/92.7d7c0428.js"><link rel="prefetch" href="/assets/js/93.17841bd6.js"><link rel="prefetch" href="/assets/js/94.832fcc1c.js"><link rel="prefetch" href="/assets/js/95.e9c523bc.js"><link rel="prefetch" href="/assets/js/96.d8aae52a.js"><link rel="prefetch" href="/assets/js/97.bd436fab.js"><link rel="prefetch" href="/assets/js/98.78f6e4f3.js"><link rel="prefetch" href="/assets/js/99.a405fc1f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.877370ef.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="wen chao" class="logo"> <span class="site-name can-hide">wen chao</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Algorithm" class="dropdown-title"><a href="/Algorithm/" class="link-title">Algorithm</a> <span class="title" style="display:none;">Algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d8e764/" class="nav-link">Theory</a></li><li class="dropdown-item"><!----> <a href="/pages/81a4bd/" class="nav-link">LeetCode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/Spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/373439/" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technology" class="dropdown-title"><a href="/Technology/" class="link-title">Technology</a> <span class="title" style="display:none;">Technology</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3b6841/" class="nav-link">DB</a></li><li class="dropdown-item"><!----> <a href="/pages/d7857e/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b89362/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/ec8b81/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/pages/4e3ff1/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/a75fef/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/pages/b194d7/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/pages/371f2f/" class="nav-link">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/027aa3/" class="nav-link">Workflow</a></li><li class="dropdown-item"><!----> <a href="/pages/73ab4b/" class="nav-link">OAuth2</a></li><li class="dropdown-item"><!----> <a href="/pages/d7a38a/" class="nav-link">JPA</a></li><li class="dropdown-item"><!----> <a href="/pages/eb5dc1/" class="nav-link">Liquibase</a></li><li class="dropdown-item"><!----> <a href="/pages/e54277/" class="nav-link">Lombok</a></li><li class="dropdown-item"><!----> <a href="/pages/62e4f6/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/13c836/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/b50b3d/" class="nav-link">Mini Program</a></li><li class="dropdown-item"><!----> <a href="/pages/09d3b8/" class="nav-link">JVM</a></li><li class="dropdown-item"><!----> <a href="/pages/a526c7/" class="nav-link">Log</a></li><li class="dropdown-item"><!----> <a href="/pages/59cf4f/" class="nav-link">JDK</a></li><li class="dropdown-item"><!----> <a href="/pages/d50dab/" class="nav-link">Thymeleaf</a></li><li class="dropdown-item"><!----> <a href="/pages/97abaa/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/7879f1/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/745b7c/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/pages/274dac/" class="nav-link">Raspberrypi</a></li><li class="dropdown-item"><!----> <a href="/pages/87c097/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/pages/927664/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/2c3f19/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><a href="/Other/" class="link-title">Other</a> <span class="title" style="display:none;">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fea344/" class="nav-link">Book</a></li><li class="dropdown-item"><!----> <a href="/pages/d62f72/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/f3d338/" class="nav-link">问题</a></li><li class="dropdown-item"><!----> <a href="/pages/ff202b/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/pages/2b746e/" class="nav-link">证券</a></li></ul></div></div><div class="nav-item"><a href="/About/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Index" class="dropdown-title"><a href="/archives/" class="link-title">Index</a> <span class="title" style="display:none;">Index</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/touxiang-lanse.png"> <div class="blogger-info"><h3>wen chao</h3> <span>持之以恒做正确有价值的事!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Algorithm" class="dropdown-title"><a href="/Algorithm/" class="link-title">Algorithm</a> <span class="title" style="display:none;">Algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d8e764/" class="nav-link">Theory</a></li><li class="dropdown-item"><!----> <a href="/pages/81a4bd/" class="nav-link">LeetCode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/Spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/373439/" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technology" class="dropdown-title"><a href="/Technology/" class="link-title">Technology</a> <span class="title" style="display:none;">Technology</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3b6841/" class="nav-link">DB</a></li><li class="dropdown-item"><!----> <a href="/pages/d7857e/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b89362/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/ec8b81/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/pages/4e3ff1/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/a75fef/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/pages/b194d7/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/pages/371f2f/" class="nav-link">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/027aa3/" class="nav-link">Workflow</a></li><li class="dropdown-item"><!----> <a href="/pages/73ab4b/" class="nav-link">OAuth2</a></li><li class="dropdown-item"><!----> <a href="/pages/d7a38a/" class="nav-link">JPA</a></li><li class="dropdown-item"><!----> <a href="/pages/eb5dc1/" class="nav-link">Liquibase</a></li><li class="dropdown-item"><!----> <a href="/pages/e54277/" class="nav-link">Lombok</a></li><li class="dropdown-item"><!----> <a href="/pages/62e4f6/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/13c836/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/b50b3d/" class="nav-link">Mini Program</a></li><li class="dropdown-item"><!----> <a href="/pages/09d3b8/" class="nav-link">JVM</a></li><li class="dropdown-item"><!----> <a href="/pages/a526c7/" class="nav-link">Log</a></li><li class="dropdown-item"><!----> <a href="/pages/59cf4f/" class="nav-link">JDK</a></li><li class="dropdown-item"><!----> <a href="/pages/d50dab/" class="nav-link">Thymeleaf</a></li><li class="dropdown-item"><!----> <a href="/pages/97abaa/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/7879f1/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/745b7c/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/pages/274dac/" class="nav-link">Raspberrypi</a></li><li class="dropdown-item"><!----> <a href="/pages/87c097/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/pages/927664/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/2c3f19/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><a href="/Other/" class="link-title">Other</a> <span class="title" style="display:none;">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fea344/" class="nav-link">Book</a></li><li class="dropdown-item"><!----> <a href="/pages/d62f72/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/f3d338/" class="nav-link">问题</a></li><li class="dropdown-item"><!----> <a href="/pages/ff202b/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/pages/2b746e/" class="nav-link">证券</a></li></ul></div></div><div class="nav-item"><a href="/About/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Index" class="dropdown-title"><a href="/archives/" class="link-title">Index</a> <span class="title" style="display:none;">Index</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Zookeeper</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MQ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a75fef/" class="sidebar-link">MQ概述</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>RocketMQ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4a7b42/" aria-current="page" class="active sidebar-link">RocketMQ综述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/4a7b42/#rocketmq安装使用" class="sidebar-link">RocketMQ安装使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#下载" class="sidebar-link">下载</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#运行" class="sidebar-link">运行</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#启动nameserver" class="sidebar-link">启动NameServer</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#启动broker" class="sidebar-link">启动Broker</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#命令行验证" class="sidebar-link">命令行验证</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#关闭" class="sidebar-link">关闭</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4a7b42/#rocketmq集群架构" class="sidebar-link">RocketMQ集群架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#rocketmq集群中的角色" class="sidebar-link">RocketMQ集群中的角色</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#rocketmq集群搭建" class="sidebar-link">RocketMQ集群搭建</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#机器环境" class="sidebar-link">机器环境</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#创建用户" class="sidebar-link">创建用户</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#系统配置" class="sidebar-link">系统配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#安装java" class="sidebar-link">安装java</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#安装rocketmq" class="sidebar-link">安装RocketMQ</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#配置rocketmq集群" class="sidebar-link">配置RocketMQ集群</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#启动rocketmq" class="sidebar-link">启动RocketMQ</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#命令行验证-2" class="sidebar-link">命令行验证</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#搭建管理控制台" class="sidebar-link">搭建管理控制台</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#dleger高可用集群搭建" class="sidebar-link">Dleger高可用集群搭建</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#调整系统参数" class="sidebar-link">调整系统参数</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#配置rocketmq的jvm内存大小" class="sidebar-link">配置RocketMQ的JVM内存大小：</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#rocketmq的其他一些核心参数" class="sidebar-link">RocketMQ的其他一些核心参数</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#linux内核参数定制" class="sidebar-link">Linux内核参数定制</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4a7b42/#rocketmq全部配置表" class="sidebar-link">RocketMQ全部配置表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#broker配置" class="sidebar-link">Broker配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#客户端的公共配置" class="sidebar-link">客户端的公共配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#producer配置" class="sidebar-link">Producer配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#pushconsumer配置" class="sidebar-link">PushConsumer配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#pushconsumer配置-2" class="sidebar-link">PushConsumer配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#message数据结构" class="sidebar-link">Message数据结构</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4a7b42/#rocketmq参考资料" class="sidebar-link">RocketMQ参考资料</a></li><li class="sidebar-sub-header level2"><a href="/pages/4a7b42/#基础概念" class="sidebar-link">基础概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_1-消息模型-message-model" class="sidebar-link">1 消息模型（Message Model）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_2-消息生产者-producer" class="sidebar-link">2 消息生产者（Producer）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_3-消息消费者-consumer" class="sidebar-link">3 消息消费者（Consumer）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_4-主题-topic" class="sidebar-link">4 主题（Topic）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_5-代理服务器-broker-server" class="sidebar-link">5 代理服务器（Broker Server）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_6-名字服务-name-server" class="sidebar-link">6 名字服务（Name Server）</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_7-消息-message" class="sidebar-link">7 消息（Message）</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4a7b42/#消息存储" class="sidebar-link">消息存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_1、何时存储消息" class="sidebar-link">1、何时存储消息</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_2、消息存储介质" class="sidebar-link">2、消息存储介质</a></li><li class="sidebar-sub-header level4"><a href="/pages/4a7b42/#_2-1磁盘保存文件慢吗" class="sidebar-link">2.1磁盘保存文件慢吗？</a></li><li class="sidebar-sub-header level4"><a href="/pages/4a7b42/#_2-2零拷贝技术加速文件读写" class="sidebar-link">2.2零拷贝技术加速文件读写</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_3-消息存储结构" class="sidebar-link">3 消息存储结构</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_4-刷盘机制" class="sidebar-link">4 刷盘机制</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_5-消息主从复制" class="sidebar-link">5 消息主从复制</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_6-负载均衡" class="sidebar-link">6 负载均衡</a></li><li class="sidebar-sub-header level4"><a href="/pages/4a7b42/#_6-1producer负载均衡" class="sidebar-link">6.1Producer负载均衡</a></li><li class="sidebar-sub-header level4"><a href="/pages/4a7b42/#_6-2-consumer负载均衡" class="sidebar-link">6.2 Consumer负载均衡</a></li><li class="sidebar-sub-header level5"><a href="/pages/4a7b42/#_1、集群模式" class="sidebar-link">1、集群模式</a></li><li class="sidebar-sub-header level5"><a href="/pages/4a7b42/#_2、广播模式" class="sidebar-link">2、广播模式</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_7、消息重试" class="sidebar-link">7、消息重试</a></li><li class="sidebar-sub-header level4"><a href="/pages/4a7b42/#_1、如何让消息进行重试" class="sidebar-link">1、如何让消息进行重试</a></li><li class="sidebar-sub-header level4"><a href="/pages/4a7b42/#_2、重试消息如何处理" class="sidebar-link">2、重试消息如何处理</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_8、死信队列" class="sidebar-link">8、死信队列</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_9、消息幂等" class="sidebar-link">9、消息幂等</a></li><li class="sidebar-sub-header level4"><a href="/pages/4a7b42/#_1、幂等的概念" class="sidebar-link">1、幂等的概念</a></li><li class="sidebar-sub-header level3"><a href="/pages/4a7b42/#_4-are-messages-delivered-exactly-once" class="sidebar-link">4. Are messages delivered exactly once?</a></li><li class="sidebar-sub-header level4"><a href="/pages/4a7b42/#_2、消息幂等的必要性" class="sidebar-link">2、消息幂等的必要性</a></li><li class="sidebar-sub-header level4"><a href="/pages/4a7b42/#_3、处理方式" class="sidebar-link">3、处理方式</a></li></ul></li></ul></li><li><a href="/pages/5f13a2/" class="sidebar-link">21RocketMQ实践问题</a></li><li><a href="/pages/3374a6/" class="sidebar-link">RocketMQ使用</a></li><li><a href="/pages/830c94/" class="sidebar-link">RocketMQ源码</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>RabbitMQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>kafka</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Dubbo</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ElasticSearch</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Workflow</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OAuth2</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JPA</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Liquibase</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Lombok</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Log</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JDK</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Thymeleaf</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Maven</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mybatis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Raspberrypi</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/Technology/#Technology" data-v-06225672>Technology</a></li><li data-v-06225672><a href="/Technology/#MQ" data-v-06225672>MQ</a></li><li data-v-06225672><a href="/Technology/#RocketMQ" data-v-06225672>RocketMQ</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/nylg" target="_blank" title="作者" class="beLink" data-v-06225672>wenchao</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2021-09-02</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">RocketMQ综述<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="rocketmq安装使用"><a href="#rocketmq安装使用" class="header-anchor">#</a> RocketMQ安装使用</h2> <p>​	RocketMQ是阿里巴巴开源的一个消息中间件，在阿里内部历经了双十一等很多高并发场景的考验，能够处理亿万级别的消息。2016年开源后捐赠给Apache，现在是Apache的一个顶级项目。</p> <p>​	目前RocketMQ在阿里云上有一个购买即可用的商业版本，商业版本集成了阿里内部一些更深层次的功能及运维定制。我们这里学习的是Apache的开源版本。开源版本相对于阿里云上的商业版本，功能上略有缺失，但是大体上功能是一样的。</p> <p>​	RocketMQ的官网地址： http://rocketmq.apache.org ，github地址是  https://github.com/apache/rocketmq ，当前最新的版本是4.7.1。我们就用这个4.7.1版本来进行学习。</p> <h3 id="下载"><a href="#下载" class="header-anchor">#</a> 下载</h3> <p>​		RocketMQ运行版本下载地址： https://www.apache.org/dyn/closer.cgi?path=rocketmq/4.7.1/rocketmq-all-4.7.1-bin-release.zip</p> <p>​		RocketMQ源码版本下载地址： https://www.apache.org/dyn/closer.cgi?path=rocketmq/4.7.1/rocketmq-all-4.7.1-source-release.zip</p> <p>这两个版本我们都下载下来。</p> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <p>​	RocketMQ的安装非常简单，就是上传解压就可以了。</p> <p>​	然后我们准备一台CentOS7的Linux机器，快速把RocketMQ给运行起来。我使用的Linux版本如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[oper@worker1 jdk1.8]$ uname -a
Linux worker1 3.10.0-1127.el7.x86_64 #1 SMP Tue Mar 31 23:36:51 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>​	我们需要创建一个操作用户用来运行自己的程序，与root用户区分开。使用root用户创建一个oper用户，并给他创建一个工作目录。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@worker1 ~]# useradd oper
[root@worker1 ~]# passwd oper 
设置用户密码
[root@worker1 ~]# mkdir /app
[root@worker1 ~]# chown oper:oper /app
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>​	 运行RocketMQ需要先安装JDK。我们采用目前最稳定的JDK1.8版本。CentOS可以采用课件资料中的jdk-8u171-linux-x64.tar.gz，也可以自行去Oracle官网上下载。然后用FTP上传到oper用户的工作目录下。由oper用户解压到/app/jdk1.8目录下。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[oper@worker1 tools]$ tar -zxvf jdk-8u171-linux-x64.tar.gz
[oper@worker1 tools]$ mv jdk1.8.0_171/ /app/jdk1.8
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>​	配置环境变量。使用 vi ~/.bash_profile编辑文件，在下面加入以下内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>export JAVA_HOME=/app/jdk1.8/
PATH=$JAVA_HOME/bin:$PATH:$HOME/.local/bin:$HOME/bin
export PATH
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>​	编辑完成后，执行 source ~/.bash_profile让环境变量生效。输入java -version能查看到以下内容表明JDK安装成功了。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[oper@worker1 ~]$ java -version
java version &quot;1.8.0_171&quot;
Java(TM) SE Runtime Environment (build 1.8.0_171-b11)
Java HotSpot(TM) 64-Bit Server VM (build 25.171-b11, mixed mode)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>​	 然后我们把下载的rocketmq-all-4.7.1-bin-release.zip在本地完成解压，并上传到/app/rocketmq目录。完成后，把rocketmq的bin目录也配置到环境变量当中。 vi ~/.bash_profile，加入以下内容，并执行source ~/.bash_profile让环境变量生效：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>export JAVA_HOME=/app/jdk1.8/
export ROCKETMQ_HOME=/app/rocketmq/rocketmq-all-4.7.1-bin-release
PATH=$ROCKETMQ_HOME/bin:$JAVA_HOME/bin:$PATH:$HOME/.local/bin:$HOME/bin
export PATH
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>​	这样RocketMQ就安装完成了。我们把他运行起来。</p> <blockquote><p>这个ROCKETMQ_HOME的环境变量是必须要单独配置的，如果不配置的话，启动NameSever和Broker都会报错。</p> <p>这个环境变量的作用是用来加载$ROCKETMQ_HOME/conf下的除broker.conf以外的几个配置文件。所以实际情况中，可以不按这个配置，但是一定要能找到配置文件。</p></blockquote> <h3 id="运行"><a href="#运行" class="header-anchor">#</a> 运行</h3> <p>​	运行之前，我们需要对RocketMQ的组件结构有个大致的了解。</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/rocketmq/BAD094A2F5B249EA87FB5B9048B62B19-1.png" alt=""></p> <p>​	RocketMQ由以下这几个组件组成</p> <ul><li>NameServer : 提供轻量级的Broker路由服务。</li> <li>Broker：实际处理消息存储、转发等服务的核心组件。</li> <li>Producer：消息生产者集群。通常是业务系统中的一个功能模块。</li> <li>Consumer：消息消费者集群。通常也是业务系统中的一个功能模块。</li></ul> <p>所以我们要启动RocketMQ服务，需要先启动NameServer。</p> <h3 id="启动nameserver"><a href="#启动nameserver" class="header-anchor">#</a> 启动NameServer</h3> <p>​	启动NameServer非常简单， 在$ROCKETMQ_HOME/bin目录下有个mqnamesrv。直接执行这个脚本就可以启动RocketMQ的NameServer服务。</p> <p>​	但是要注意，RocketMQ默认预设的JVM内存是4G，这是RocketMQ给我们的最佳配置。但是通常我们用虚拟机的话都是不够4G内存的，所以需要调整下JVM内存大小。<a href="http://xn--runserver-z89na9857bcqmtlfda85rmzcf95l5zb.sh" target="_blank" rel="noopener noreferrer">修改的方式是直接修改runserver.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。 用vi runserver.sh编辑这个脚本，在脚本中找到这一行调整内存大小为512M</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>JAVA_OPT=&quot;${JAVA_OPT} -server -Xms512m -Xmx512m -Xmn256m -
XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>​	然后我们用静默启动的方式启动NameServer服务：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup bin/mqnamesrv &amp; 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	启动完成后，在nohup.out里看到这一条关键日志就是启动成功了。并且使用jps指令可以看到有一个NamesrvStartup进程。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Java HotSpot(TM) 64-Bit Server VM warning: Using the DefNew young collector with the CMS
collector is deprecated and will likely be removed in a future release
Java HotSpot(TM) 64-Bit Server VM warning: UseCMSCompactAtFullCollection is deprecated and
will likely be removed in a future release.
The Name Server boot success. serializeType=JSON
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="启动broker"><a href="#启动broker" class="header-anchor">#</a> 启动Broker</h3> <p>​	<a href="http://xn--Brokerrunbroker-wy8y53qb44gl6dtn1h9p4b.sh" target="_blank" rel="noopener noreferrer">启动Broker的脚本是runbroker.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。Broker的默认预设内存是8G，启动前，如果内存不够，同样需要调整下JVM内存。vi <a href="http://runbroker.sh" target="_blank" rel="noopener noreferrer">runbroker.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，找到这一行，进行内存调整</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>JAVA_OPT=&quot;${JAVA_OPT} -server -Xms512m -Xmx512m -Xmn256m&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	然后我们需要找到$ROCKETMQ_HOME/conf/broker.conf， vi指令进行编辑，在最下面加入一个配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>autoCreateTopicEnable=true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	<a href="http://xn--runbroker-zz6n89bg5xa221choab1448bmczanv9bfgw6s1niq8a.sh" target="_blank" rel="noopener noreferrer">然后也以静默启动的方式启动runbroker.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup ./mqbroker &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	启动完成后，同样是检查nohup.out日志，有这一条关键日志就标识启动成功了。 并且jps指令可以看到一个BrokerStartup进程。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>The broker[worker1, 192.168.232.128:10911] boot success. serializeType=JSON
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>在观察runserver.sh和runbroker.sh时，我们还可以查看到其他的JVM执行参数，这些参数都可以进行定制。例如我们观察到一个比较有意思的地方，nameServer使用的是CMS垃圾回收器，而Broker使用的是G1垃圾回收器。 关于垃圾回收器的知识你还记得吗？</p></blockquote> <h3 id="命令行验证"><a href="#命令行验证" class="header-anchor">#</a> 命令行验证</h3> <p>​	在RocketMQ的安装包中，提供了一个tools.sh工具可以用来在命令行快速验证RocketMQ服务。我们在worker2上进入RocketMQ的安装目录：</p> <p>首先需要配置一个环境变量NAMESRV_ADDR指向我们启动的NameServer服务。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>export NAMESRV_ADDR='localhost:9876'	
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后启动消息生产者发送消息：默认会发1000条消息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bin/tools.sh org.apache.rocketmq.example.quickstart.Producer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们可以看到发送消息的日志：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>.....
SendResult [sendStatus=SEND_OK, msgId=C0A8E88007AC3764951D891CE9A003E7, offsetMsgId=C0A8E88000002A9F00000000000317BF, messageQueue=MessageQueue [topic=TopicTest, brokerName=worker1, queueId=1], queueOffset=249]
14:59:33.418 [NettyClientSelector_1] INFO  RocketmqRemoting - closeChannel: close the connection to remote address[127.0.0.1:9876] result: true
14:59:33.423 [NettyClientSelector_1] INFO  RocketmqRemoting - closeChannel: close the connection to remote address[192.168.232.128:10911] result: true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这日志中，上面部分就是我们发送的消息的内容。后面两句标识消息生产者正常关闭。</p> <p>然后启动消息消费者接收消息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bin/tools.sh  org.apache.rocketmq.example.quickstart.Consumer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启动后，可以看到消费到的消息。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>......
ConsumeMessageThread_19 Receive New Messages: [MessageExt [brokerName=worker1, queueId=2, storeSize=203, queueOffset=53, sysFlag=0, bornTimestamp=1606460371999, bornHost=/192.168.232.128:43436, storeTimestamp=1606460372000, storeHost=/192.168.232.128:10911, msgId=C0A8E88000002A9F000000000000A7AE, commitLogOffset=42926, bodyCRC=1968636794, reconsumeTimes=0, preparedTransactionOffset=0, toString()=Message{topic='TopicTest', flag=0, properties={MIN_OFFSET=0, MAX_OFFSET=250, CONSUME_START_TIME=1606460450150, UNIQ_KEY=C0A8E88007AC3764951D891CE41F00D4, CLUSTER=DefaultCluster, WAIT=true, TAGS=TagA}, body=[72, 101, 108, 108, 111, 32, 82, 111, 99, 107, 101, 116, 77, 81, 32, 50, 49, 50], transactionId='null'}]] 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>日志中MessageExt后的整个内容就是一条完整的RocketMQ消息。我们要对这个消息的结构有个大概的了解，后面会对这个消息进行深入的理解。</p> <p>其中比较关键的属性有：brokerName，queueId，msgId，topic，cluster，tags，body，transactionId。先找下这些属性在哪里。</p></blockquote> <p>而这个Consume指令并不会结束，他会继续挂起，等待消费其他的消息。我们可以使用CTRL+C停止该进程。</p> <h3 id="关闭"><a href="#关闭" class="header-anchor">#</a> 关闭</h3> <p>要关闭RocketMQ服务可以通过mqshutdown脚本直接关闭</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 1.关闭NameServer
sh bin/mqshutdown namesrv
# 2.关闭Broker
sh bin/mqshutdown broker
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="rocketmq集群架构"><a href="#rocketmq集群架构" class="header-anchor">#</a> RocketMQ集群架构</h2> <p>​	刚才的演示中，我们已经体验到了RocketMQ是如何工作的。这样，我们回头看RocketMQ的集群架构，就能够有更全面的理解了。</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/rocketmq/2.png" alt=""></p> <h3 id="rocketmq集群中的角色"><a href="#rocketmq集群中的角色" class="header-anchor">#</a> RocketMQ集群中的角色</h3> <p>一个完整的RocketMQ集群中，有如下几个角色</p> <ul><li>Producer：消息的发送者；举例：发信者</li> <li>Consumer：消息接收者；举例：收信者</li> <li>Broker：暂存和传输消息；举例：邮局</li> <li>NameServer：管理Broker；举例：各个邮局的管理机构</li> <li>Topic：区分消息的种类；一个发送者可以发送消息给一个或者多个Topic；一个消息的接收者可以订阅一个或者多个Topic消息</li></ul> <blockquote><p>我们之前的测试案例中，Topic是什么？topic='TopicTest'</p> <p>现在你能看懂我们之前在broker.conf中添加的autoCreateTopicEnable=true这个属性的用处了吗？</p></blockquote> <ul><li>Message Queue：相当于是Topic的分区；用于并行发送和接收消息</li></ul> <blockquote><p>在我们之前的测试案例中，一个queueId就代表了一个MessageQueue。有哪些queueId？ 0，1，2，3四个MessageQueue，你都找到了吗？</p></blockquote> <h3 id="rocketmq集群搭建"><a href="#rocketmq集群搭建" class="header-anchor">#</a> RocketMQ集群搭建</h3> <h3 id="机器环境"><a href="#机器环境" class="header-anchor">#</a> 机器环境</h3> <p>准备三台虚拟机，root密码 root ;IP地址：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>192.168.232.128 worker1
192.168.232.129 worker2
192.168.232.130 worker3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>这里特意不把每个机器的机器名定义得太过规范，比如master slave这样的，有助于更理解各项配置。</p></blockquote> <h3 id="创建用户"><a href="#创建用户" class="header-anchor">#</a> 创建用户</h3> <p>useradd oper</p> <p>passwd oper  (密码输入 123qweasd)</p> <h3 id="系统配置"><a href="#系统配置" class="header-anchor">#</a> 系统配置</h3> <p><strong>免密登录</strong></p> <p>切换oper用户，在worker1上 生成key</p> <p>ssh-kengen</p> <p>然后分发给其他机器</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ssh-copy-id worker1
ssh-copy-id worker2
ssh-copy-id worker3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样就可以在worker1上直接ssh 或者scp到另外的机器，不需要输密码了。</p> <p><strong>关闭防火墙</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>systemctl stop firewalld.service
firewall-cmd --state 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="安装java"><a href="#安装java" class="header-anchor">#</a> 安装java</h3> <p>给oper创建/app目录</p> <p>上传jdk的tar包</p> <p>修改~/.bash_profile，配置环境变量。source生效。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>export JAVA_HOME=/app/jdk1.8/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="安装rocketmq"><a href="#安装rocketmq" class="header-anchor">#</a> 安装RocketMQ</h3> <p>上传tar包，直接解压。然后配置环境变量</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>export ROCKETMQ_HOME=/app/rocketmq/rocketmq-all-4.7.1-bin-release
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>RocketMQ在4.5版本之前都不支持master宕机后slave自动切换。在4.5版本后，增加了基于Dleger实现的主从切换。这里用的目前最新的4.7.1版本</p></blockquote> <h3 id="配置rocketmq集群"><a href="#配置rocketmq集群" class="header-anchor">#</a> 配置RocketMQ集群</h3> <p>我们为了便于观察，这次搭建一个2主2从异步刷盘的集群，所以我们会使用conf/2m-2s-async下的配置文件，实际项目中，为了达到高可用，一般会使用dleger。预备设计的集群情况如下：</p> <table><thead><tr><th>机器名</th> <th>nemaeServer节点部署</th> <th>broker节点部署</th></tr></thead> <tbody><tr><td>worker1</td> <td>nameserver</td> <td></td></tr> <tr><td>worker2</td> <td>nameserver</td> <td>broker-a, broker-b-s</td></tr> <tr><td>worker3</td> <td>nameserver</td> <td>broker-b,broker-a-s</td></tr></tbody></table> <p>所以修改的配置文件是进入rocketmq的config目录下修改2m-2s-async的配置文件。--只需要配置broker.conf。</p> <blockquote><p>在rocketmq的config目录下可以看到rocketmq建议的各种配置方式：</p> <ul><li>2m-2s-async: 2主2从异步刷盘(吞吐量较大，但是消息可能丢失),</li> <li>2m-2s-sync:2主2从同步刷盘(吞吐量会下降，但是消息更安全)，</li> <li>2m-noslave:2主无从(单点故障)，然后还可以直接配置broker.conf，进行单点环境配置。</li> <li>而dleger就是用来实现主从切换的。集群中的节点会基于Raft协议随机选举出一个leader，其他的就都是follower。通常正式环境都会采用这种方式来搭建集群。</li></ul></blockquote> <p>我们这次采用2m-2s-async的方式搭建集群。</p> <p><strong>配置第一组broker-a</strong></p> <p>在<strong>worker2</strong>上先配置borker-a的master节点。先配置2m-2s-async/broker-a.properties</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#所属集群名字，名字一样的节点就在同一个集群内
brokerClusterName=rocketmq-cluster
#broker名字，名字一样的节点就是一组主从节点。
brokerName=broker-a
#brokerid,0就表示是Master，&gt;0的都是表示 Slave
brokerId=0
#nameServer地址，分号分割
namesrvAddr=worker1:9876;worker2:9876;worker3:9876
#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
defaultTopicQueueNums=4
#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭
autoCreateTopicEnable=true
#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭
autoCreateSubscriptionGroup=true
#Broker 对外服务的监听端口
listenPort=10911
#删除文件时间点，默认凌晨 4点
deleteWhen=04
#文件保留时间，默认 48 小时
fileReservedTime=120
#commitLog每个文件的大小默认1G
mapedFileSizeCommitLog=1073741824
#ConsumeQueue每个文件默认存30W条，根据业务情况调整
mapedFileSizeConsumeQueue=300000
#destroyMapedFileIntervalForcibly=120000
#redeleteHangedFileInterval=120000
#检测物理文件磁盘空间
diskMaxUsedSpaceRatio=88
#存储路径
storePathRootDir=/app/rocketmq/store
#commitLog 存储路径
storePathCommitLog=/app/rocketmq/store/commitlog
#消费队列存储路径存储路径
storePathConsumeQueue=/app/rocketmq/store/consumequeue
#消息索引存储路径
storePathIndex=/app/rocketmq/store/index
#checkpoint 文件存储路径
storeCheckpoint=/app/rocketmq/store/checkpoint
#abort 文件存储路径
abortFile=/app/rocketmq/store/abort
#限制的消息大小
maxMessageSize=65536
#flushCommitLogLeastPages=4
#flushConsumeQueueLeastPages=2
#flushCommitLogThoroughInterval=10000
#flushConsumeQueueThoroughInterval=60000
#Broker 的角色
#- ASYNC_MASTER 异步复制Master
#- SYNC_MASTER 同步双写Master
#- SLAVE
brokerRole=ASYNC_MASTER
#刷盘方式
#- ASYNC_FLUSH 异步刷盘
#- SYNC_FLUSH 同步刷盘
flushDiskType=ASYNC_FLUSH
#checkTransactionMessageEnable=false
#发消息线程池数量
#sendMessageThreadPoolNums=128
#拉消息线程池数量
#pullMessageThreadPoolNums=128
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>该节点对应的从节点在<strong>worker3</strong>上。修改2m-2s-async/broker-a-s.properties  <code>只需要修改brokerId和brokerRole</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#所属集群名字，名字一样的节点就在同一个集群内
brokerClusterName=rocketmq-cluster
#broker名字，名字一样的节点就是一组主从节点。
brokerName=broker-a
#brokerid,0就表示是Master，&gt;0的都是表示 Slave
brokerId=1
#nameServer地址，分号分割
namesrvAddr=worker1:9876;worker2:9876;worker3:9876
#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
defaultTopicQueueNums=4
#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭
autoCreateTopicEnable=true
#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭
autoCreateSubscriptionGroup=true
#Broker 对外服务的监听端口
listenPort=11011
#删除文件时间点，默认凌晨 4点
deleteWhen=04
#文件保留时间，默认 48 小时
fileReservedTime=120
#commitLog每个文件的大小默认1G
mapedFileSizeCommitLog=1073741824
#ConsumeQueue每个文件默认存30W条，根据业务情况调整
mapedFileSizeConsumeQueue=300000
#destroyMapedFileIntervalForcibly=120000
#redeleteHangedFileInterval=120000
#检测物理文件磁盘空间
diskMaxUsedSpaceRatio=88
#存储路径
storePathRootDir=/app/rocketmq/storeSlave
#commitLog 存储路径
storePathCommitLog=/app/rocketmq/storeSlave/commitlog
#消费队列存储路径存储路径
storePathConsumeQueue=/app/rocketmq/storeSlave/consumequeue
#消息索引存储路径
storePathIndex=/app/rocketmq/storeSlave/index
#checkpoint 文件存储路径
storeCheckpoint=/app/rocketmq/storeSlave/checkpoint
#abort 文件存储路径
abortFile=/app/rocketmq/storeSlave/abort
#限制的消息大小
maxMessageSize=65536
#flushCommitLogLeastPages=4
#flushConsumeQueueLeastPages=2
#flushCommitLogThoroughInterval=10000
#flushConsumeQueueThoroughInterval=60000
#Broker 的角色
#- ASYNC_MASTER 异步复制Master
#- SYNC_MASTER 同步双写Master
#- SLAVE
brokerRole=SLAVE
#刷盘方式
#- ASYNC_FLUSH 异步刷盘
#- SYNC_FLUSH 同步刷盘
flushDiskType=ASYNC_FLUSH
#checkTransactionMessageEnable=false
#发消息线程池数量
#sendMessageThreadPoolNums=128
#拉消息线程池数量
#pullMessageThreadPoolNums=128
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p><strong>配置第二组Broker-b</strong></p> <p>这一组broker的主节点在<strong>worker3</strong>上，所以需要配置worker3上的config/2m-2s-async/broker-b.properties</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#所属集群名字，名字一样的节点就在同一个集群内
brokerClusterName=rocketmq-cluster
#broker名字，名字一样的节点就是一组主从节点。
brokerName=broker-b
#brokerid,0就表示是Master，&gt;0的都是表示 Slave
brokerId=0
#nameServer地址，分号分割
namesrvAddr=worker1:9876;worker2:9876;worker3:9876
#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
defaultTopicQueueNums=4
#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭
autoCreateTopicEnable=true
#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭
autoCreateSubscriptionGroup=true
#Broker 对外服务的监听端口
listenPort=10911
#删除文件时间点，默认凌晨 4点
deleteWhen=04
#文件保留时间，默认 48 小时
fileReservedTime=120
#commitLog每个文件的大小默认1G
mapedFileSizeCommitLog=1073741824
#ConsumeQueue每个文件默认存30W条，根据业务情况调整
mapedFileSizeConsumeQueue=300000
#destroyMapedFileIntervalForcibly=120000
#redeleteHangedFileInterval=120000
#检测物理文件磁盘空间
diskMaxUsedSpaceRatio=88
#存储路径
storePathRootDir=/app/rocketmq/store
#commitLog 存储路径
storePathCommitLog=/app/rocketmq/store/commitlog
#消费队列存储路径存储路径
storePathConsumeQueue=/app/rocketmq/store/consumequeue
#消息索引存储路径
storePathIndex=/app/rocketmq/store/index
#checkpoint 文件存储路径
storeCheckpoint=/app/rocketmq/store/checkpoint
#abort 文件存储路径
abortFile=/app/rocketmq/store/abort
#限制的消息大小
maxMessageSize=65536
#flushCommitLogLeastPages=4
#flushConsumeQueueLeastPages=2
#flushCommitLogThoroughInterval=10000
#flushConsumeQueueThoroughInterval=60000
#Broker 的角色
#- ASYNC_MASTER 异步复制Master
#- SYNC_MASTER 同步双写Master
#- SLAVE
brokerRole=ASYNC_MASTER
#刷盘方式
#- ASYNC_FLUSH 异步刷盘
#- SYNC_FLUSH 同步刷盘
flushDiskType=ASYNC_FLUSH
#checkTransactionMessageEnable=false
#发消息线程池数量
#sendMessageThreadPoolNums=128
#拉消息线程池数量
#pullMessageThreadPoolNums=128
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>然后他对应的slave在worker2上，修改work2上的 conf/2m-2s-async/broker-b-s.properties</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#所属集群名字，名字一样的节点就在同一个集群内
brokerClusterName=rocketmq-cluster
#broker名字，名字一样的节点就是一组主从节点。
brokerName=broker-b
#brokerid,0就表示是Master，&gt;0的都是表示 Slave
brokerId=1
#nameServer地址，分号分割
namesrvAddr=worker1:9876;worker2:9876;worker3:9876
#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
defaultTopicQueueNums=4
#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭
autoCreateTopicEnable=true
#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭
autoCreateSubscriptionGroup=true
#Broker 对外服务的监听端口
listenPort=11011
#删除文件时间点，默认凌晨 4点
deleteWhen=04
#文件保留时间，默认 48 小时
fileReservedTime=120
#commitLog每个文件的大小默认1G
mapedFileSizeCommitLog=1073741824
#ConsumeQueue每个文件默认存30W条，根据业务情况调整
mapedFileSizeConsumeQueue=300000
#destroyMapedFileIntervalForcibly=120000
#redeleteHangedFileInterval=120000
#检测物理文件磁盘空间
diskMaxUsedSpaceRatio=88
#存储路径
storePathRootDir=/app/rocketmq/storeSlave
#commitLog 存储路径
storePathCommitLog=/app/rocketmq/storeSlave/commitlog
#消费队列存储路径存储路径
storePathConsumeQueue=/app/rocketmq/storeSlave/consumequeue
#消息索引存储路径
storePathIndex=/app/rocketmq/storeSlave/index
#checkpoint 文件存储路径
storeCheckpoint=/app/rocketmq/storeSlave/checkpoint
#abort 文件存储路径
abortFile=/app/rocketmq/storeSlave/abort
#限制的消息大小
maxMessageSize=65536
#flushCommitLogLeastPages=4
#flushConsumeQueueLeastPages=2
#flushCommitLogThoroughInterval=10000
#flushConsumeQueueThoroughInterval=60000
#Broker 的角色
#- ASYNC_MASTER 异步复制Master
#- SYNC_MASTER 同步双写Master
#- SLAVE
brokerRole=SLAVE
#刷盘方式
#- ASYNC_FLUSH 异步刷盘
#- SYNC_FLUSH 同步刷盘
flushDiskType=ASYNC_FLUSH
#checkTransactionMessageEnable=false
#发消息线程池数量
#sendMessageThreadPoolNums=128
#拉消息线程池数量
#pullMessageThreadPoolNums=128
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><blockquote><p>这样broker就配置完成了。</p> <p>需要注意的配置项：1、同一机器上两个实例的store目录不能相同，否则会报错 Lock failed,MQ already started</p> <p>2、同一机器上两个实例的listenPort也不能相同。否则会报端口占用的错</p> <p>nameserver不需要进行配置，直接启动就行。这也看出nameserver是无状态的。</p> <p>3、其他的配置项参见《RcoketMQ全部配置表.pdf》</p></blockquote> <h3 id="启动rocketmq"><a href="#启动rocketmq" class="header-anchor">#</a> 启动RocketMQ</h3> <p>启动就比较简单了，直接调用bin目录下的脚本就行。只是启动之前要注意看下他们的JVM内存配置，默认的配置都比较高。</p> <ol><li><strong>先启动nameServer。</strong></li></ol> <p>修改三个节点上的bin/runserver.sh，调整里面的jvm内存配置。找到下面这一行调整下内存</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>JAVA_OPT=&quot;${JAVA_OPT} -server -Xms512m -Xmx512m -Xmn256m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>直接在三个节点上启动nameServer。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup bin/mqnamesrv &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启动完成后，在nohup.out里看到这一条关键日志就是启动成功了。</p> <p>Java HotSpot(TM) 64-Bit Server VM warning: Using the DefNew young collector  with the CMS collector is deprecated and will likely be removed in a  future release Java HotSpot(TM) 64-Bit Server VM warning: UseCMSCompactAtFullCollection is deprecated and will likely be removed in a future release. The Name Server boot success. serializeType=JSON</p> <p>使用jps指令可以看到一个NamesrvStartup进程。</p> <blockquote><p>这里也看到，RocketMQ在runserver.sh中是使用的CMS垃圾回收期，而在runbroker.sh中使用的是G1垃圾回收期。</p></blockquote> <ol start="2"><li><strong>再启动broker</strong></li></ol> <p>启动broker是使用的mqbroker指令，只是注意启动broker时需要通过-c 指定对应的配置文件。</p> <p>在<strong>worker2</strong>上启动broker-a的master节点和broker-b的slave节点</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup ./mqbroker -c ../conf/2m-2s-async/broker-a.properties &amp;
nohup ./mqbroker -c ../conf/2m-2s-async/broker-b-s.properties &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在work3上启动broker-b的master节点和broker-a的slave节点</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>nohup ./mqbroker -c ../conf/2m-2s-async/broker-b.properties &amp;
nohup ./mqbroker -c ../conf/2m-2s-async/broker-a-s.properties &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>启动slave时，如果遇到报错 Lock failed,MQ already started ，那是因为有多个实例共用了同一个storePath造成的，这时就需要调整store的路径。</p></blockquote> <ol start="3"><li><strong>启动状态检查</strong></li></ol> <p>使用jps指令，能看到一个NameSrvStartup进程和两个BrokerStartup进程。</p> <p>nohup.out中也有启动成功的日志。</p> <p>对应的日志文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 查看nameServer日志
tail -500f ~/logs/rocketmqlogs/namesrv.log
# 查看broker日志
tail -500f ~/logs/rocketmqlogs/broker.log
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="4"><li><strong>测试mqadmin管理工具</strong></li></ol> <p>RocketMQ的源代码中并没有为我们提供类似于Nacos或者RabbitMQ那样的控制台，只提供了一个mqadmin指令来管理RocketMQ，命令在bin目录下。使用方式是 ./mqadmin {command} {args}</p> <p>所有指令如下：</p> <p>4.1 <strong>Topic相关</strong>：</p> <table><thead><tr><th>名称</th> <th>含义</th> <th>命令选项</th> <th>说明</th></tr></thead> <tbody><tr><td>updateTopic</td> <td>创建更新Topic配置</td> <td>-b</td> <td>Broker 地址，表示 topic 所在  Broker，只支持单台Broker，地址为ip:port</td></tr> <tr><td>-c</td> <td>cluster 名称，表示 topic 所在集群（集群可通过  clusterList 查询）</td> <td></td> <td></td></tr> <tr><td>-h-</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-p</td> <td>指定新topic的读写权限( W=2|R=4|WR=6 )</td> <td></td> <td></td></tr> <tr><td>-r</td> <td>可读队列数（默认为 8）</td> <td></td> <td></td></tr> <tr><td>-w</td> <td>可写队列数（默认为 8）</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>topic 名称（名称只能使用字符  ^[a-zA-Z0-9_-]+$ ）</td> <td></td> <td></td></tr> <tr><td>deleteTopic</td> <td>删除Topic</td> <td>-c</td> <td>cluster 名称，表示删除某集群下的某个 topic （集群  可通过 clusterList 查询）</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>topic 名称（名称只能使用字符  ^[a-zA-Z0-9_-]+$ ）</td> <td></td> <td></td></tr> <tr><td>topicList</td> <td>查看 Topic 列表信息</td> <td>-h</td> <td>打印帮助</td></tr> <tr><td>-c</td> <td>不配置-c只返回topic列表，增加-c返回clusterName,  topic, consumerGroup信息，即topic的所属集群和订阅关系，没有参数</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>topicRoute</td> <td>查看 Topic 路由信息</td> <td>-t</td> <td>topic 名称</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>topicStatus</td> <td>查看 Topic 消息队列offset</td> <td>-t</td> <td>topic 名称</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>topicClusterList</td> <td>查看 Topic 所在集群列表</td> <td>-t</td> <td>topic 名称</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>updateTopicPerm</td> <td>更新 Topic 读写权限</td> <td>-t</td> <td>topic 名称</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-b</td> <td>Broker 地址，表示 topic 所在  Broker，只支持单台Broker，地址为ip:port</td> <td></td> <td></td></tr> <tr><td>-p</td> <td>指定新 topic 的读写权限( W=2|R=4|WR=6 )</td> <td></td> <td></td></tr> <tr><td>-c</td> <td>cluster 名称，表示 topic 所在集群（集群可通过  clusterList 查询），-b优先，如果没有-b，则对集群中所有Broker执行命令</td> <td></td> <td></td></tr> <tr><td>updateOrderConf</td> <td>从NameServer上创建、删除、获取特定命名空间的kv配置，目前还未启用</td> <td>-h</td> <td>打印帮助</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>topic，键</td> <td></td> <td></td></tr> <tr><td>-v</td> <td>orderConf，值</td> <td></td> <td></td></tr> <tr><td>-m</td> <td>method，可选get、put、delete</td> <td></td> <td></td></tr> <tr><td>allocateMQ</td> <td>以平均负载算法计算消费者列表负载消息队列的负载结果</td> <td>-t</td> <td>topic 名称</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-i</td> <td>ipList，用逗号分隔，计算这些ip去负载Topic的消息队列</td> <td></td> <td></td></tr> <tr><td>statsAll</td> <td>打印Topic订阅关系、TPS、积累量、24h读写总量等信息</td> <td>-h</td> <td>打印帮助</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-a</td> <td>是否只打印活跃topic</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>指定topic</td> <td></td> <td></td></tr></tbody></table> <p>4.2 <strong>集群相关</strong></p> <table><thead><tr><th>名称</th> <th>含义</th> <th>命令选项</th> <th>说明</th></tr></thead> <tbody><tr><td>clusterList</td> <td>查看集群信息，集群、BrokerName、BrokerId、TPS等信息</td> <td>-m</td> <td>打印更多信息 (增加打印出如下信息 #InTotalYest,  #OutTotalYest, #InTotalToday ,#OutTotalToday)</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-i</td> <td>打印间隔，单位秒</td> <td></td> <td></td></tr> <tr><td>clusterRT</td> <td>发送消息检测集群各Broker RT。消息发往${BrokerName} Topic。</td> <td>-a</td> <td>amount，每次探测的总数，RT = 总时间 /  amount</td></tr> <tr><td>-s</td> <td>消息大小，单位B</td> <td></td> <td></td></tr> <tr><td>-c</td> <td>探测哪个集群</td> <td></td> <td></td></tr> <tr><td>-p</td> <td>是否打印格式化日志，以|分割，默认不打印</td> <td></td> <td></td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-m</td> <td>所属机房，打印使用</td> <td></td> <td></td></tr> <tr><td>-i</td> <td>发送间隔，单位秒</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr></tbody></table> <p>4.3 <strong>Broker相关</strong></p> <table><thead><tr><th>名称</th> <th>含义</th> <th>命令选项</th> <th>说明</th></tr></thead> <tbody><tr><td>updateBrokerConfig</td> <td>更新 Broker 配置文件，会修改Broker.conf</td> <td>-b</td> <td>Broker 地址，格式为ip:port</td></tr> <tr><td>-c</td> <td>cluster 名称</td> <td></td> <td></td></tr> <tr><td>-k</td> <td>key 值</td> <td></td> <td></td></tr> <tr><td>-v</td> <td>value 值</td> <td></td> <td></td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>brokerStatus</td> <td>查看 Broker 统计信息、运行状态（你想要的信息几乎都在里面）</td> <td>-b</td> <td>Broker 地址，地址为ip:port</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>brokerConsumeStats</td> <td>Broker中各个消费者的消费情况，按Message Queue维度返回Consume  Offset，Broker Offset，Diff，TImestamp等信息</td> <td>-b</td> <td>Broker 地址，地址为ip:port</td></tr> <tr><td>-t</td> <td>请求超时时间</td> <td></td> <td></td></tr> <tr><td>-l</td> <td>diff阈值，超过阈值才打印</td> <td></td> <td></td></tr> <tr><td>-o</td> <td>是否为顺序topic，一般为false</td> <td></td> <td></td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>getBrokerConfig</td> <td>获取Broker配置</td> <td>-b</td> <td>Broker 地址，地址为ip:port</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>wipeWritePerm</td> <td>从NameServer上清除 Broker写权限</td> <td>-b</td> <td>Broker 地址，地址为ip:port</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>cleanExpiredCQ</td> <td>清理Broker上过期的Consume Queue，如果手动减少对列数可能产生过期队列</td> <td>-n</td> <td>NameServer 服务地址，格式 ip:port</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-b</td> <td>Broker 地址，地址为ip:port</td> <td></td> <td></td></tr> <tr><td>-c</td> <td>集群名称</td> <td></td> <td></td></tr> <tr><td>cleanUnusedTopic</td> <td>清理Broker上不使用的Topic，从内存中释放Topic的Consume  Queue，如果手动删除Topic会产生不使用的Topic</td> <td>-n</td> <td>NameServer 服务地址，格式 ip:port</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-b</td> <td>Broker 地址，地址为ip:port</td> <td></td> <td></td></tr> <tr><td>-c</td> <td>集群名称</td> <td></td> <td></td></tr> <tr><td>sendMsgStatus</td> <td>向Broker发消息，返回发送状态和RT</td> <td>-n</td> <td>NameServer 服务地址，格式 ip:port</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-b</td> <td>BrokerName，注意不同于Broker地址</td> <td></td> <td></td></tr> <tr><td>-s</td> <td>消息大小，单位B</td> <td></td> <td></td></tr> <tr><td>-c</td> <td>发送次数</td> <td></td> <td></td></tr></tbody></table> <p>4.4 <strong>消息相关</strong></p> <table><thead><tr><th>名称</th> <th>含义</th> <th>命令选项</th> <th>说明</th></tr></thead> <tbody><tr><td>queryMsgById</td> <td>根据offsetMsgId查询msg，如果使用开源控制台，应使用offsetMsgId，此命令还有其他参数，具体作用请阅读QueryMsgByIdSubCommand。</td> <td>-i</td> <td>msgId</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>queryMsgByKey</td> <td>根据消息 Key 查询消息</td> <td>-k</td> <td>msgKey</td></tr> <tr><td>-t</td> <td>Topic 名称</td> <td></td> <td></td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>queryMsgByOffset</td> <td>根据 Offset 查询消息</td> <td>-b</td> <td>Broker 名称，（这里需要注意  填写的是 Broker 的名称，不是 Broker 的地址，Broker 名称可以在 clusterList 查到）</td></tr> <tr><td>-i</td> <td>query 队列 id</td> <td></td> <td></td></tr> <tr><td>-o</td> <td>offset 值</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>topic 名称</td> <td></td> <td></td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>queryMsgByUniqueKey</td> <td>根据msgId查询，msgId不同于offsetMsgId，区别详见常见运维问题。-g，-d配合使用，查到消息后尝试让特定的消费者消费消息并返回消费结果</td> <td>-h</td> <td>打印帮助</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-i</td> <td>uniqe msg id</td> <td></td> <td></td></tr> <tr><td>-g</td> <td>consumerGroup</td> <td></td> <td></td></tr> <tr><td>-d</td> <td>clientId</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>topic名称</td> <td></td> <td></td></tr> <tr><td>checkMsgSendRT</td> <td>检测向topic发消息的RT，功能类似clusterRT</td> <td>-h</td> <td>打印帮助</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>topic名称</td> <td></td> <td></td></tr> <tr><td>-a</td> <td>探测次数</td> <td></td> <td></td></tr> <tr><td>-s</td> <td>消息大小</td> <td></td> <td></td></tr> <tr><td>sendMessage</td> <td>发送一条消息，可以根据配置发往特定Message Queue，或普通发送。</td> <td>-h</td> <td>打印帮助</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>topic名称</td> <td></td> <td></td></tr> <tr><td>-p</td> <td>body，消息体</td> <td></td> <td></td></tr> <tr><td>-k</td> <td>keys</td> <td></td> <td></td></tr> <tr><td>-c</td> <td>tags</td> <td></td> <td></td></tr> <tr><td>-b</td> <td>BrokerName</td> <td></td> <td></td></tr> <tr><td>-i</td> <td>queueId</td> <td></td> <td></td></tr> <tr><td>consumeMessage</td> <td>消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td> <td>-h</td> <td>打印帮助</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>topic名称</td> <td></td> <td></td></tr> <tr><td>-b</td> <td>BrokerName</td> <td></td> <td></td></tr> <tr><td>-o</td> <td>从offset开始消费</td> <td></td> <td></td></tr> <tr><td>-i</td> <td>queueId</td> <td></td> <td></td></tr> <tr><td>-g</td> <td>消费者分组</td> <td></td> <td></td></tr> <tr><td>-s</td> <td>开始时间戳，格式详见-h</td> <td></td> <td></td></tr> <tr><td>-d</td> <td>结束时间戳</td> <td></td> <td></td></tr> <tr><td>-c</td> <td>消费多少条消息</td> <td></td> <td></td></tr> <tr><td>printMsg</td> <td>从Broker消费消息并打印，可选时间段</td> <td>-h</td> <td>打印帮助</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>topic名称</td> <td></td> <td></td></tr> <tr><td>-c</td> <td>字符集，例如UTF-8</td> <td></td> <td></td></tr> <tr><td>-s</td> <td>subExpress，过滤表达式</td> <td></td> <td></td></tr> <tr><td>-b</td> <td>开始时间戳，格式参见-h</td> <td></td> <td></td></tr> <tr><td>-e</td> <td>结束时间戳</td> <td></td> <td></td></tr> <tr><td>-d</td> <td>是否打印消息体</td> <td></td> <td></td></tr> <tr><td>printMsgByQueue</td> <td>类似printMsg，但指定Message Queue</td> <td>-h</td> <td>打印帮助</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>topic名称</td> <td></td> <td></td></tr> <tr><td>-i</td> <td>queueId</td> <td></td> <td></td></tr> <tr><td>-a</td> <td>BrokerName</td> <td></td> <td></td></tr> <tr><td>-c</td> <td>字符集，例如UTF-8</td> <td></td> <td></td></tr> <tr><td>-s</td> <td>subExpress，过滤表达式</td> <td></td> <td></td></tr> <tr><td>-b</td> <td>开始时间戳，格式参见-h</td> <td></td> <td></td></tr> <tr><td>-e</td> <td>结束时间戳</td> <td></td> <td></td></tr> <tr><td>-p</td> <td>是否打印消息</td> <td></td> <td></td></tr> <tr><td>-d</td> <td>是否打印消息体</td> <td></td> <td></td></tr> <tr><td>-f</td> <td>是否统计tag数量并打印</td> <td></td> <td></td></tr> <tr><td>resetOffsetByTime</td> <td>按时间戳重置offset，Broker和consumer都会重置</td> <td>-h</td> <td>打印帮助</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-g</td> <td>消费者分组</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>topic名称</td> <td></td> <td></td></tr> <tr><td>-s</td> <td>重置为此时间戳对应的offset</td> <td></td> <td></td></tr> <tr><td>-f</td> <td>是否强制重置，如果false，只支持回溯offset，如果true，不管时间戳对应offset与consumeOffset关系</td> <td></td> <td></td></tr> <tr><td>-c</td> <td>是否重置c++客户端offset</td> <td></td> <td></td></tr></tbody></table> <p>4.5 <strong>消费者和消费者组相关</strong></p> <table><thead><tr><th>名称</th> <th>含义</th> <th>命令选项</th> <th>说明</th></tr></thead> <tbody><tr><td>consumerProgress</td> <td>查看订阅组消费状态，可以查看具体的client IP的消息积累量</td> <td>-g</td> <td>消费者所属组名</td></tr> <tr><td>-s</td> <td>是否打印client IP</td> <td></td> <td></td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>consumerStatus</td> <td>查看消费者状态，包括同一个分组中是否都是相同的订阅，分析Process  Queue是否堆积，返回消费者jstack结果，内容较多，使用者参见ConsumerStatusSubCommand</td> <td>-h</td> <td>打印帮助</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-g</td> <td>consumer group</td> <td></td> <td></td></tr> <tr><td>-i</td> <td>clientId</td> <td></td> <td></td></tr> <tr><td>-s</td> <td>是否执行jstack</td> <td></td> <td></td></tr> <tr><td>getConsumerStatus</td> <td>获取 Consumer 消费进度</td> <td>-g</td> <td>消费者所属组名</td></tr> <tr><td>-t</td> <td>查询主题</td> <td></td> <td></td></tr> <tr><td>-i</td> <td>Consumer 客户端 ip</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>updateSubGroup</td> <td>更新或创建订阅关系</td> <td>-n</td> <td>NameServer 服务地址，格式 ip:port</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-b</td> <td>Broker地址</td> <td></td> <td></td></tr> <tr><td>-c</td> <td>集群名称</td> <td></td> <td></td></tr> <tr><td>-g</td> <td>消费者分组名称</td> <td></td> <td></td></tr> <tr><td>-s</td> <td>分组是否允许消费</td> <td></td> <td></td></tr> <tr><td>-m</td> <td>是否从最小offset开始消费</td> <td></td> <td></td></tr> <tr><td>-d</td> <td>是否是广播模式</td> <td></td> <td></td></tr> <tr><td>-q</td> <td>重试队列数量</td> <td></td> <td></td></tr> <tr><td>-r</td> <td>最大重试次数</td> <td></td> <td></td></tr> <tr><td>-i</td> <td>当slaveReadEnable开启时有效，且还未达到从slave消费时建议从哪个BrokerId消费，可以配置备机id，主动从备机消费</td> <td></td> <td></td></tr> <tr><td>-w</td> <td>如果Broker建议从slave消费，配置决定从哪个slave消费，配置BrokerId，例如1</td> <td></td> <td></td></tr> <tr><td>-a</td> <td>当消费者数量变化时是否通知其他消费者负载均衡</td> <td></td> <td></td></tr> <tr><td>deleteSubGroup</td> <td>从Broker删除订阅关系</td> <td>-n</td> <td>NameServer 服务地址，格式 ip:port</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-b</td> <td>Broker地址</td> <td></td> <td></td></tr> <tr><td>-c</td> <td>集群名称</td> <td></td> <td></td></tr> <tr><td>-g</td> <td>消费者分组名称</td> <td></td> <td></td></tr> <tr><td>cloneGroupOffset</td> <td>在目标群组中使用源群组的offset</td> <td>-n</td> <td>NameServer 服务地址，格式 ip:port</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-s</td> <td>源消费者组</td> <td></td> <td></td></tr> <tr><td>-d</td> <td>目标消费者组</td> <td></td> <td></td></tr> <tr><td>-t</td> <td>topic名称</td> <td></td> <td></td></tr> <tr><td>-o</td> <td>暂未使用</td> <td></td> <td></td></tr></tbody></table> <p>4.6 <strong>连接相关</strong></p> <table><thead><tr><th>名称</th> <th>含义</th> <th>命令选项</th> <th>说明</th></tr></thead> <tbody><tr><td>consumerConnec tion</td> <td>查询 Consumer 的网络连接</td> <td>-g</td> <td>消费者所属组名</td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>producerConnec tion</td> <td>查询 Producer 的网络连接</td> <td>-g</td> <td>生产者所属组名</td></tr> <tr><td>-t</td> <td>主题名称</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr></tbody></table> <p>4.7 <strong>NameServer相关</strong></p> <table><thead><tr><th>名称</th> <th>含义</th> <th>命令选项</th> <th>说明</th></tr></thead> <tbody><tr><td>updateKvConfig</td> <td>更新NameServer的kv配置，目前还未使用</td> <td>-s</td> <td>命名空间</td></tr> <tr><td>-k</td> <td>key</td> <td></td> <td></td></tr> <tr><td>-v</td> <td>value</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>deleteKvConfig</td> <td>删除NameServer的kv配置</td> <td>-s</td> <td>命名空间</td></tr> <tr><td>-k</td> <td>key</td> <td></td> <td></td></tr> <tr><td>-n</td> <td>NameServer 服务地址，格式 ip:port</td> <td></td> <td></td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>getNamesrvConfig</td> <td>获取NameServer配置</td> <td>-n</td> <td>NameServer 服务地址，格式 ip:port</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>updateNamesrvConfig</td> <td>修改NameServer配置</td> <td>-n</td> <td>NameServer 服务地址，格式 ip:port</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr> <tr><td>-k</td> <td>key</td> <td></td> <td></td></tr> <tr><td>-v</td> <td>value</td> <td></td> <td></td></tr></tbody></table> <p>4.8 其他</p> <table><thead><tr><th>名称</th> <th>含义</th> <th>命令选项</th> <th>说明</th></tr></thead> <tbody><tr><td>startMonitoring</td> <td>开启监控进程，监控消息误删、重试队列消息数等</td> <td>-n</td> <td>NameServer 服务地址，格式 ip:port</td></tr> <tr><td>-h</td> <td>打印帮助</td> <td></td> <td></td></tr></tbody></table> <blockquote><p>注意：</p> <p>1、几乎所有指令都需要通过-n参数配置nameServer地址，格式为ip:port</p> <p>2、几乎所有执行都可以通过-h参数获得帮助</p> <p>3、当既有Broker地址(-b)又有集群名称clustername(-c)配合项，则优先以Broker地址执行指令。如果不配置Broker地址，则对集群中所有主机执行指令。</p></blockquote> <h3 id="命令行验证-2"><a href="#命令行验证-2" class="header-anchor">#</a> 命令行验证</h3> <p>在RocketMQ的安装包中，提供了一个tools.sh工具可以用来在命令行快速验证RocketMQ服务。我们在worker2上进入RocketMQ的安装目录：</p> <p>发送消息：默认会发1000条消息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bin/tools.sh org.apache.rocketmq.example.quickstart.Producer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接收消息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bin/tools.sh  org.apache.rocketmq.example.quickstart.Consumer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>注意，这是官方提供的Demo，但是官方的源码中，这两个类都是没有指定nameServer的，所以运行会有点问题。要指定NameServer地址，可以配置一个环境变量NAMESRV_ADDR，这样默认会读取这个NameServer地址。可以配到.bash_profile里或者直接临时指定。</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>export NAMESRV_ADDR='worker1:9876;worker2:9876;worker3:9876'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后就可以正常执行了。</p> <p>这个NameServer地址的读取方式见源码中org.apache.rocketmq.common.utils.NameServerAddressUtils</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>    public static String getNameServerAddresses() {
        return System.getProperty(&quot;rocketmq.namesrv.addr&quot;, System.getenv(&quot;NAMESRV_ADDR&quot;));
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这个方法就是在DefaultMQProducer中默认的设置NameServer地址的方式，这个rokcetmq.namesrv.addr属性可以在java中使用System.setproperties指定，也可以在SpringBoot中配到配置文件里。</p> <blockquote><p>这个tools.sh就封装了一个简单的运行RocketMQ的环境，可以运行源码中的其他示例，然后自己的例子也可以放到RocketMQ的lib目录下去执行。</p></blockquote> <h3 id="搭建管理控制台"><a href="#搭建管理控制台" class="header-anchor">#</a> 搭建管理控制台</h3> <p>RocketMQ源代码中并没有提供控制台，但是有一个Rocket的社区扩展项目中提供了一个控制台，地址： https://github.com/apache/rocketmq-externals</p> <p>下载下来后，进入其中的rocket-console目录，使用maven进行编译</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mvn clean package -Dmaven.test.skip=true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>编译完成后，获取target下的jar包，就可以直接执行。但是这个时候要注意，在这个项目的application.properties中需要指定nameserver的地址。默认这个属性是空的。</p> <p>那我们可以在jar包的当前目录下增加一个application.properties文件，覆盖jar包中默认的一个属性：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>rocketmq.config.namesrvAddr=worker1:9876;worker2:9876;worker3:9876
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后执行：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>java -jar rocketmq-console-ng-1.0.1.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启动完成后，可以访问 http://192.168.232.128:8080看到管理页面</p> <blockquote><p>在管理页面的右上角可以选择语言。</p></blockquote> <h3 id="dleger高可用集群搭建"><a href="#dleger高可用集群搭建" class="header-anchor">#</a> Dleger高可用集群搭建</h3> <p>通过这种方式，我们搭建了一个主从结构的RocketMQ集群，但是我们要注意，这种主从结构是只做数据备份，没有容灾功能的。也就是说当一个master节点挂了后，slave节点是无法切换成master节点继续提供服务的。注意这个集群至少要是3台，允许少于一半的节点发生故障。</p> <blockquote><p>如果slave挂了，对集群的影响不会很大，因为slave只是做数据备份的。但是影响也是会有的，例如，当消费者要拉取的数据量比较大时，RocketMQ有一定的机制会优先保证Master节点的性能，只让Master节点返回一小部分数据，而让其他部分的数据从slave节点去拉取。</p> <p>另外，需要注意，Dleger会有他自己的CommitLog机制，也就是说，使用主从集群累计下来的消息，是无法转移到Dleger集群中的。</p></blockquote> <p>​	而如果要进行高可用的容灾备份，需要采用Dledger的方式来搭建高可用集群。注意，这个Dledger需要在RocketMQ4.5以后的版本才支持，我们使用的4.7.1版本已经默认集成了dledger。</p> <p><strong>搭建方法</strong></p> <p>​	要搭建高可用的Broker集群，我们只需要配置conf/dleger下的配置文件就行。</p> <blockquote><p>这种模式是基于Raft协议的，是一个类似于Zookeeper的paxos协议的选举协议，也是会在集群中随机选举出一个leader，其他的就是follower。只是他选举的过程跟paxos有点不同。Raft协议基于随机休眠机制的，选举过程会比paxos相对慢一点。</p></blockquote> <p>​	首先：<a href="http://xn--runserver-947nw2gmts9m8bkijnsdy1kk96m302b.xn--shrunbroker-804s.sh" target="_blank" rel="noopener noreferrer">我们同样是需要修改runserver.sh和runbroker.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，对JVM内存进行定制。</p> <p>​	然后：我们需要修改conf/dleger下的配置文件。 跟dleger相关的几个配置项如下：</p> <table><thead><tr><th>name</th> <th>含义</th> <th>举例</th></tr></thead> <tbody><tr><td>enableDLegerCommitLog</td> <td>是否启动 DLedger</td> <td>true</td></tr> <tr><td>dLegerGroup</td> <td>DLedger Raft Group的名字，建议和 brokerName 保持一致</td> <td>RaftNode00</td></tr> <tr><td>dLegerPeers</td> <td>DLedger Group 内各节点的端口信息，同一个 Group 内的各个节点配置必须要保证一致</td> <td>n0-127.0.0.1:40911;n1-127.0.0.1:40912;n2-127.0.0.1:40913</td></tr> <tr><td>dLegerSelfId</td> <td>节点 id, 必须属于 dLegerPeers 中的一个；同 Group 内各个节点要唯一</td> <td>n0</td></tr> <tr><td>sendMessageThreadPoolNums</td> <td>发送线程个数，建议配置成 Cpu 核数</td> <td>16</td></tr></tbody></table> <p>配置完后，同样是使用 nohup bin/mqbroker -c $conf_name &amp; 的方式指定实例文件。</p> <blockquote><p>在bin/dleger下有个fast-try.sh，这个脚本是在本地启动三个RocketMQ实例，搭建一个高可用的集群，读取的就是conf/dleger下的broker-no.conf，broker-n1.conf和broker-n2.conf。使用这个脚本同样要注意定制下JVM内存，他给每个实例默认定制的是1G内存，虚拟机肯定是不够的。</p> <p>这种单机三实例的集群搭建完成后，可以使用  bin/mqadmin clusterList -n worker1.conf的方式查看集群状态。</p> <p>单机状态下一般一次主从切换需要大概10S的时间。</p></blockquote> <h3 id="调整系统参数"><a href="#调整系统参数" class="header-anchor">#</a> 调整系统参数</h3> <p>到这里，我们的整个RocketMQ的服务就搭建完成了。但是在实际使用时，我们说RocketMQ的吞吐量、性能都很高，那要发挥RocketMQ的高性能，还需要对RocketMQ以及服务器的性能进行定制</p> <h3 id="配置rocketmq的jvm内存大小"><a href="#配置rocketmq的jvm内存大小" class="header-anchor">#</a> 配置RocketMQ的JVM内存大小：</h3> <p>之前提到过，在runserver.sh中需要定制nameserver的内存大小，在runbroker.sh中需要定制broker的内存大小。这些默认的配置可以认为都是经过检验的最优化配置，但是在实际情况中都还需要根据服务器的实际情况进行调整。这里以runbroker.sh中对G1GC的配置举例，在runbroker.sh中的关键配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>JAVA_OPT=&quot;${JAVA_OPT} -XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:G1ReservePercent=25 -XX:InitiatingHeapOccupancyPercent=30 -XX:SoftRefLRUPolicyMSPerMB=0&quot;
JAVA_OPT=&quot;${JAVA_OPT} -verbose:gc -Xloggc:${GC_LOG_DIR}/rmq_broker_gc_%p_%t.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime -XX:+PrintAdaptiveSizePolicy&quot;
JAVA_OPT=&quot;${JAVA_OPT} -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=30m&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>-XX:+UseG1GC: 使用G1垃圾回收器，  -XX:G1HeapRegionSize=16m  将G1的region块大小设为16M，-XX:G1ReservePercent：在G1的老年代中预留25%空闲内存，这个默认值是10%，RocketMQ把这个参数调大了。-XX:InitiatingHeapOccupancyPercent=30：当堆内存的使用率达到30%之后就会启动G1垃圾回收器尝试回收垃圾，默认值是45%，RocketMQ把这个参数调小了，也就是提高了GC的频率，但是避免了垃圾对象过多，一次垃圾回收时间太长的问题。</p> <p>然后，后面定制了GC的日志文件，确定GC日志文件的地址、打印的内容以及控制每个日志文件的大小为30M并且只保留5个文件。这些在进行性能检验时，是相当重要的参考内容。</p> <h3 id="rocketmq的其他一些核心参数"><a href="#rocketmq的其他一些核心参数" class="header-anchor">#</a> RocketMQ的其他一些核心参数</h3> <p>例如在conf/dleger/broker-n0.conf中有一个参数：sendMessageThreadPoolNums=16。这一个参数是表明RocketMQ内部用来发送消息的线程池的线程数量是16个，其实这个参数可以根据机器的CPU核心数进行适当调整，例如如果你的机器核心数超过16个，就可以把这个参数适当调大。</p> <h3 id="linux内核参数定制"><a href="#linux内核参数定制" class="header-anchor">#</a> Linux内核参数定制</h3> <p>我们在部署RocketMQ的时候，还需要对Linux内核参数进行一定的定制。例如</p> <ul><li><strong>ulimit</strong>，需要进行大量的网络通信和磁盘IO。</li> <li><strong>vm.extra_free_kbytes</strong>，告诉VM在后台回收（kswapd）启动的阈值与直接回收（通过分配进程）的阈值之间保留额外的可用内存。RocketMQ使用此参数来避免内存分配中的长延迟。（与具体内核版本相关）</li> <li><strong>vm.min_free_kbytes</strong>，如果将其设置为低于1024KB，将会巧妙的将系统破坏，并且系统在高负载下容易出现死锁。</li> <li><strong>vm.max_map_count</strong>，限制一个进程可能具有的最大内存映射区域数。RocketMQ将使用mmap加载CommitLog和ConsumeQueue，因此建议将为此参数设置较大的值。</li> <li><strong>vm.swappiness</strong>，定义内核交换内存页面的积极程度。较高的值会增加攻击性，较低的值会减少交换量。建议将值设置为10来避免交换延迟。</li> <li><strong>File descriptor limits</strong>，RocketMQ需要为文件（CommitLog和ConsumeQueue）和网络连接打开文件描述符。我们建议设置文件描述符的值为655350。</li></ul> <blockquote><p>这些参数在CentOS7中的配置文件都在 /proc/sys/vm目录下。</p> <p>另外，RocketMQ的bin目录下有个os.sh里面设置了RocketMQ建议的系统内核参数，可以根据情况进行调整。</p></blockquote> <h2 id="rocketmq全部配置表"><a href="#rocketmq全部配置表" class="header-anchor">#</a> RocketMQ全部配置表</h2> <h3 id="broker配置"><a href="#broker配置" class="header-anchor">#</a> Broker配置</h3> <table><thead><tr><th><strong>参数名</strong></th> <th><strong>默认值</strong></th> <th><strong>说明</strong></th></tr></thead> <tbody><tr><td>listenPort</td> <td>10911</td> <td>接受客户端连接的监听端口</td></tr> <tr><td>namesrvAddr</td> <td>null</td> <td>nameServer 地址</td></tr> <tr><td>brokerIP1</td> <td>网卡的  InetAddress</td> <td>当前  broker 监听的 IP</td></tr> <tr><td>brokerIP2</td> <td>跟  brokerIP1 一样</td> <td>存在主从  broker 时，如果在 broker 主节点上配置了 brokerIP2 属性，broker 从节点会连接主节点配置的  brokerIP2 进行同步</td></tr> <tr><td>brokerName</td> <td>null</td> <td>broker 的名称</td></tr> <tr><td>brokerClusterName</td> <td>DefaultCluster</td> <td>本  broker 所属的 Cluser 名称</td></tr> <tr><td>brokerId</td> <td>0</td> <td>broker id, 0 表示 master, 其他的正整数表示 slave</td></tr> <tr><td>storePathCommitLog</td> <td>$HOME/store/commitlog/</td> <td>存储  commit log 的路径</td></tr> <tr><td>storePathConsumerQueue</td> <td>$HOME/store/consumequeue/</td> <td>存储  consume queue 的路径</td></tr> <tr><td>mappedFileSizeCommitLog</td> <td>1024 * 1024 *  1024(1G)</td> <td>commit log 的映射文件大小</td></tr> <tr><td>deleteWhen</td> <td>04</td> <td>在每天的什么时间删除已经超过文件保留时间的  commit log</td></tr> <tr><td>fileReservedTime</td> <td>72</td> <td>以小时计算的文件保留时间</td></tr> <tr><td>brokerRole</td> <td>ASYNC_MASTER</td> <td>SYNC_MASTER/ASYNC_MASTER/SLAVE</td></tr> <tr><td>flushDiskType</td> <td>ASYNC_FLUSH</td> <td>SYNC_FLUSH/ASYNC_FLUSH  SYNC_FLUSH 模式下的 broker 保证在收到确认生产者之前将消息刷盘。ASYNC_FLUSH 模式下的 broker 则利用刷盘一组消息的模式，可以取得更好的性能。</td></tr></tbody></table> <h3 id="客户端的公共配置"><a href="#客户端的公共配置" class="header-anchor">#</a> 客户端的公共配置</h3> <table><thead><tr><th><strong>参数名</strong></th> <th><strong>默认值</strong></th> <th><strong>说明</strong></th></tr></thead> <tbody><tr><td>namesrvAddr</td> <td></td> <td>Name  Server地址列表，多个NameServer地  址用分号隔开</td></tr> <tr><td>clientIP</td> <td>本机IP</td> <td>客户端本机IP地址，某些机器会发生无法识别客户端IP地址情况，需要应用在代码中强制指定</td></tr> <tr><td>instanceName</td> <td>DEFAULT</td> <td>客户端实例名称，客户端创建的多个  Producer、Consumer实际是共用一个内部实例（这个实例包含网络连接、线程资源等）</td></tr> <tr><td>clientCallbackExecutorThreads</td> <td>4</td> <td>通信层异步回调线程数</td></tr> <tr><td>pollNameServerInteval</td> <td>30000</td> <td>轮询Name  Server间隔时间，单位毫秒</td></tr> <tr><td>heartbeatBrokerInterval</td> <td>30000</td> <td>向Broker发送心跳间隔时间，单位毫秒</td></tr> <tr><td>persistConsumerOffsetInterval</td> <td>5000</td> <td>持久化Consumer消费进度间隔时间，单位毫秒</td></tr></tbody></table> <h3 id="producer配置"><a href="#producer配置" class="header-anchor">#</a> Producer配置</h3> <table><thead><tr><th><strong>参数名</strong></th> <th><strong>默认值</strong></th> <th><strong>说明</strong></th></tr></thead> <tbody><tr><td>producerGroup</td> <td>DEFAULT_PRODUCER</td> <td>Producer组名，多个Producer如果属于一个应用，发送同样的消息，则应该将它们归为同一组</td></tr> <tr><td>createTopicKey</td> <td>TBW102</td> <td>在发送消息时，自动创建服务器不存在的topic，需要指定  Key，该Key可用于配置发送消息所在topic的默认路由。</td></tr> <tr><td>defaultTopicQueueNums</td> <td>4</td> <td>在发送消息，自动创建服务器不存在的topic时，默认创建的队列数</td></tr> <tr><td>sendMsgTimeout</td> <td>10000</td> <td>发送消息超时时间，单位毫秒</td></tr> <tr><td>compressMsgBodyOverHowmuch</td> <td>4096</td> <td>消息Body超过多大开始压缩（Consumer收到消息会自动解压缩），单位字节</td></tr> <tr><td>retryAnotherBrokerWhenNotStoreOK</td> <td>FALSE</td> <td>如果发送消息返回sendResult，但是 sendStatus!=SEND_OK，是否重试发送</td></tr> <tr><td>retryTimesWhenSendFailed</td> <td>2</td> <td>如果消息发送失败，最大重试次数，该参数只对同步发送模式起作用</td></tr> <tr><td>maxMessageSize</td> <td>4MB</td> <td>客户端限制的消息大小，超过报错，同时服务端也会限制，所以需要跟服务端配合使用。</td></tr> <tr><td>transactionCheckListener</td> <td></td> <td>事务消息回查监听器，如果发送事务消息，必须设置</td></tr> <tr><td>checkThreadPoolMinSize</td> <td>1</td> <td>Broker回查Producer事务状态时，线程池最小线程数</td></tr> <tr><td>checkThreadPoolMaxSize</td> <td>1</td> <td>Broker回查Producer事务状态时，线程池最大线程数</td></tr> <tr><td>checkRequestHoldMax</td> <td>2000</td> <td>Broker回查Producer事务状态时，Producer本地缓冲请求队  列大小</td></tr> <tr><td>RPCHook</td> <td>null</td> <td>该参数是在Producer创建时传入的，包含消息发送前的预处理和消息响应后的处理两个接口，用户可以在第一个接口中做一些安全控制或者其他操作。</td></tr></tbody></table> <h3 id="pushconsumer配置"><a href="#pushconsumer配置" class="header-anchor">#</a> PushConsumer配置</h3> <table><thead><tr><th><strong>参数名</strong></th> <th><strong>默认值</strong></th> <th><strong>说明</strong></th></tr></thead> <tbody><tr><td>consumerGroup</td> <td>DEFAULT_CONSUMER</td> <td>Consumer组名，多个Consumer如果属于一个应用，订阅同样的消息，且消费逻辑一致，则应该将它们归为同一组</td></tr> <tr><td>messageModel</td> <td>CLUSTERING</td> <td>消费模型支持集群消费和广播消费两种</td></tr> <tr><td>consumeFromWhere</td> <td>CONSUME_FROM_LAST_OFFSET</td> <td>Consumer启动后，默认从上次消费的位置开始消费，这包含两种情况：一种是上次消费的位置未过期，则消费从上次中止的位置进行；一种是上次消费位置已经过期，则从当前队列第一条消息开始消费</td></tr> <tr><td>consumeTimestamp</td> <td>半个小时前</td> <td>只有当consumeFromWhere值为CONSUME_FROM_TIMESTAMP时才起作用。</td></tr> <tr><td>allocateMessageQueueStrategy</td> <td>AllocateMessageQueueAveragely</td> <td>Rebalance算法实现策略</td></tr> <tr><td>subscription</td> <td></td> <td>订阅关系</td></tr> <tr><td>messageListener</td> <td></td> <td>消息监听器</td></tr> <tr><td>offsetStore</td> <td></td> <td>消费进度存储</td></tr> <tr><td>consumeThreadMin</td> <td>10</td> <td>消费线程池最小线程数</td></tr> <tr><td>consumeThreadMax</td> <td>20</td> <td>消费线程池最大线程数</td></tr> <tr><td>consumeConcurrentlyMaxSpan</td> <td>2000</td> <td>单队列并行消费允许的最大跨度</td></tr> <tr><td>pullThresholdForQueue</td> <td>1000</td> <td>拉消息本地队列缓存消息最大数</td></tr> <tr><td>pullInterval</td> <td>0</td> <td>拉消息间隔，由于是长轮询，所以为0，但是如果应用为了流控，也可以设置大于0的值，单位毫秒</td></tr> <tr><td>consumeMessageBatchMaxSize</td> <td>1</td> <td>批量消费，一次消费多少条消息</td></tr> <tr><td>pullBatchSize</td> <td>32</td> <td>批量拉消息，一次最多拉多少条</td></tr></tbody></table> <h3 id="pushconsumer配置-2"><a href="#pushconsumer配置-2" class="header-anchor">#</a> PushConsumer配置</h3> <table><thead><tr><th><strong>参数名</strong></th> <th><strong>默认值</strong></th> <th><strong>说明</strong></th></tr></thead> <tbody><tr><td>consumerGroup</td> <td>DEFAULT_CONSUMER</td> <td>Consumer组名，多个Consumer如果属于一个应用，订阅同样的消息，且消费逻辑一致，则应该将它们归为同一组</td></tr> <tr><td>brokerSuspendMaxTimeMillis</td> <td>20000</td> <td>长轮询，Consumer拉消息请求在Broker 挂起最长时间，单位毫秒</td></tr> <tr><td>consumerTimeoutMillisWhenSuspend</td> <td>30000</td> <td>长轮询，Consumer拉消息请求在Broker 挂起超过指定时间，客户端认为超时，单位毫秒</td></tr> <tr><td>consumerPullTimeoutMillis</td> <td>10000</td> <td>非长轮询，拉消息超时时间，单位毫秒</td></tr> <tr><td>messageModel</td> <td>BROADCASTING</td> <td>消息支持两种模式：集群消费和广播消费</td></tr> <tr><td>messageQueueListener</td> <td></td> <td>监听队列变化</td></tr> <tr><td>offsetStore</td> <td></td> <td>消费进度存储</td></tr> <tr><td>registerTopics</td> <td></td> <td>注册的topic集合</td></tr> <tr><td>allocateMessageQueueStrategy</td> <td>AllocateMessageQueueAveragely</td> <td>Rebalance算法实现策略</td></tr></tbody></table> <h3 id="message数据结构"><a href="#message数据结构" class="header-anchor">#</a> Message数据结构</h3> <table><thead><tr><th><strong>字段名</strong></th> <th><strong>默认值</strong></th> <th><strong>说明</strong></th></tr></thead> <tbody><tr><td>Topic</td> <td>null</td> <td>必填，消息所属topic的名称</td></tr> <tr><td>Body</td> <td>null</td> <td>必填，消息体</td></tr> <tr><td>Tags</td> <td>null</td> <td>选填，消息标签，方便服务器过滤使用。目前只支持每个消息设置一个tag</td></tr> <tr><td>Keys</td> <td>null</td> <td>选填，代表这条消息的业务关键词，服务器会根据keys创建哈希索引，设置后，可以在Console系统根据Topic、Keys来查询消  息，由于是哈希索引，请尽可能保证key唯一，例如订单号，商品  Id等。</td></tr> <tr><td>Flag</td> <td>0</td> <td>选填，完全由应用来设置，RocketMQ不做干预</td></tr> <tr><td>DelayTimeLevel</td> <td>0</td> <td>选填，消息延时级别，0表示不延时，大于0会延时特定的时间才会被消费</td></tr> <tr><td>WaitStoreMsgOK</td> <td>TRUE</td> <td>选填，表示消息是否在服务器落盘后才返回应答。</td></tr></tbody></table> <h2 id="rocketmq参考资料"><a href="#rocketmq参考资料" class="header-anchor">#</a> RocketMQ参考资料</h2> <blockquote><p>RocketMQ的源代码中有个docs目录，在他的docs/cn/architecture.md文档中，有对RocketMQ架构的更详细的介绍！非常nice！</p></blockquote> <h2 id="基础概念"><a href="#基础概念" class="header-anchor">#</a> 基础概念</h2> <h3 id="_1-消息模型-message-model"><a href="#_1-消息模型-message-model" class="header-anchor">#</a> 1 消息模型（Message Model）</h3> <p>RocketMQ主要由 Producer、Broker、Consumer 三部分组成，其中Producer 负责生产消息，Consumer 负责消费消息，Broker 负责存储消息。Broker 在实际部署过程中对应一台服务器，每个 Broker  可以存储多个Topic的消息，每个Topic的消息也可以分片存储于不同的 Broker。Message Queue  用于存储消息的物理地址，每个Topic中的消息地址存储于多个 Message Queue 中。ConsumerGroup 由多个Consumer 实例构成。</p> <h3 id="_2-消息生产者-producer"><a href="#_2-消息生产者-producer" class="header-anchor">#</a> 2 消息生产者（Producer）</h3> <p>负责生产消息，一般由业务系统负责生产消息。一个消息生产者会把业务应用系统里产生的消息发送到broker服务器。RocketMQ提供多种发送方式，同步发送、异步发送、顺序发送、单向发送。同步和异步方式均需要Broker返回确认信息，单向发送不需要。</p> <p>生产者中，会把同一类Producer组成一个集合，叫做生产者组，这类Producer发送同一类消息且发送逻辑一致。如果发送的是事务消息且原始生产者在发送之后崩溃，则Broker服务器会联系同一生产者组的其他生产者实例以提交或回溯消费。</p> <h3 id="_3-消息消费者-consumer"><a href="#_3-消息消费者-consumer" class="header-anchor">#</a> 3 消息消费者（Consumer）</h3> <p>负责消费消息，一般是后台系统负责异步消费。一个消息消费者会从Broker服务器拉取消息、并将其提供给应用程序。从用户应用的角度而言提供了两种消费形式：拉取式消费、推动式消费。</p> <ul><li>拉取式消费的应用通常主动调用Consumer的拉消息方法从Broker服务器拉消息、主动权由应用控制。一旦获取了批量消息，应用就会启动消费过程。</li> <li>推动式消费模式下Broker收到数据后会主动推送给消费端，该消费模式一般实时性较高。</li></ul> <p>消费者同样会把同一类Consumer组成一个集合，叫做消费者组，这类Consumer通常消费同一类消息且消费逻辑一致。消费者组使得在消息消费方面，实现负载均衡和容错的目标变得非常容易。要注意的是，消费者组的消费者实例必须订阅完全相同的Topic。RocketMQ 支持两种消息模式：集群消费（Clustering）和广播消费（Broadcasting）。</p> <ul><li>集群消费模式下,相同Consumer Group的每个Consumer实例平均分摊消息。</li> <li>广播消费模式下，相同Consumer Group的每个Consumer实例都接收全量的消息。</li></ul> <h3 id="_4-主题-topic"><a href="#_4-主题-topic" class="header-anchor">#</a> 4 主题（Topic）</h3> <p>表示一类消息的集合，每个主题包含若干条消息，每条消息只能属于一个主题，是RocketMQ进行消息订阅的基本单位。</p> <p>同一个Topic下的数据，会分片保存到不同的Broker上，而每一个分片单位，就叫做MessageQueue。MessageQueue是生产者发送消息与消费者消费消息的最小单位。</p> <h3 id="_5-代理服务器-broker-server"><a href="#_5-代理服务器-broker-server" class="header-anchor">#</a> 5 代理服务器（Broker Server）</h3> <p>消息中转角色，负责存储消息、转发消息。代理服务器在RocketMQ系统中负责接收从生产者发送来的消息并存储、同时为消费者的拉取请求作准备。代理服务器也存储消息相关的元数据，包括消费者组、消费进度偏移和主题和队列消息等。</p> <p>Broker Server是RocketMQ真正的业务核心，包含了多个重要的子模块：</p> <ul><li>Remoting Module：整个Broker的实体，负责处理来自clients端的请求。</li> <li>Client Manager：负责管理客户端(Producer/Consumer)和维护Consumer的Topic订阅信息</li> <li>Store Service：提供方便简单的API接口处理消息存储到物理硬盘和查询功能。</li> <li>HA Service：高可用服务，提供Master Broker 和 Slave Broker之间的数据同步功能。</li> <li>Index Service：根据特定的Message key对投递到Broker的消息进行索引服务，以提供消息的快速查询。</li></ul> <p>而Broker Server要保证高可用需要搭建主从集群架构。RocketMQ中有两种Broker架构模式：</p> <ul><li>普通集群：</li></ul> <p>这种集群模式下会给每个节点分配一个固定的角色，master负责响应客户端的请求，并存储消息。slave则只负责对master的消息进行同步保存，并响应部分客户端的读请求。消息同步方式分为同步同步和异步同步。</p> <p>这种集群模式下各个节点的角色无法进行切换，也就是说，master节点挂了，这一组Broker就不可用了。</p> <ul><li>Dledger高可用集群：</li></ul> <p>Dledger是RocketMQ自4.5版本引入的实现高可用集群的一项技术。这个模式下的集群会随机选出一个节点作为master，而当master节点挂了后，会从slave中自动选出一个节点升级成为master。</p> <p>Dledger技术做的事情：1、接管Broker的CommitLog消息存储  2、从集群中选举出master节点  3、完成master节点往slave节点的消息同步。</p> <p>Dledger的关键部分是在他的节点选举上。Dledger是使用Raft算法来进行节点选举的。这里简单介绍下Raft算法的选举过程:</p> <blockquote><p>首先：每个节点有三个状态，Leader，follower和candidate(候选人)。正常运行的情况下，集群中会有一个leader，其他都是follower，follower只响应Leader和Candidate的请求，而客户端的请求全部由Leader处理，即使有客户端请求到了一个follower，也会将请求转发到leader。</p> <p>集群刚启动时，每个节点都是follower状态，之后集群内部会发送一个timeout信号，所有follower就转成candidate去拉取选票，获得大多数选票的节点选为leader，其他候选人转为follower。如果一个timeout信号发出时，没有选出leader，将会重新开始一次新的选举。而Leader节点会往其他节点发送心跳信号，确认他的leader状态。</p> <p>-- 然后会启动定时器，如果在指定时间内没有收到Leader的心跳，就会转为Candidate状态，然后向其他成员发起投票请求，如果收到半数以上成员的投票，则Candidate会晋升为Leader。然后leader也有可能会退化成follower。</p> <p>​	然后，在Raft协议中，会将时间分为一些任意时间长度的时间片段，叫做term。term会使用一个全局唯一，连续递增的编号作为标识，也就是起到了一个逻辑时钟的作用。</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/rocketmq/3.png" alt=""></p> <p>在每一个term时间片里，都会进行新的选举，每一个Candidate都会努力争取成为leader。获得票数最多的节点就会被选举为Leader。被选为Leader的这个节点，在一个term时间片里就会保持leader状态。这样，就会保证在同一时间段内，集群中只会有一个Leader。在某些情况下，选票可能会被各个节点瓜分，形成不了多数派，那这个term可能直到结束都没有leader，直到下一个term再重新发起选举，这也就没有了Zookeeper中的脑裂问题。而在每次重新选举的过程中， leader也有可能会退化成为follower。也就是说，在这个集群中， leader节点是会不断变化的。</p> <p>​	 然后，每次选举的过程中，每个节点都会存储当前term编号，并在节点之间进行交流时，都会带上自己的term编号。如果一个节点发现他的编号比另外一个小，那么他就会将自己的编号更新为较大的那一个。而如果leader或者candidate发现自己的编号不是最新的，他就会自动转成follower。如果接收到的请求term编号小于自己的编号，term将会拒绝执行。</p> <p>在选举过程中，Raft协议会通过心跳机制发起leader选举。节点都是从follower状态开始的，如果收到了来自leader或者candidate的心跳RPC请求，那他就会保持follower状态，避免争抢成为candidate。而leader会往其他节点发送心跳信号，来确认自己的地位。如果follower一段时间(两个timeout信号)内没有收到Leader的心跳信号，他就会认为leader挂了，发起新一轮选举。</p> <p>​	选举开始后，每个follower会增加自己当前的term，并将自己转为candidate。然后向其他节点发起投票请求，请求时会带上自己的编号和term，也就是说都会默认投自己一票。之后candidate状态可能会发生以下三种变化：</p> <ul><li><strong>赢得选举，成为leader</strong>：  如果它在一个term内收到了大多数的选票，将会在接下的剩余term时间内称为leader，然后就可以通过发送心跳确立自己的地位。(每一个server在一个term内只能投一张选票，并且按照先到先得的原则投出)</li> <li><strong>其他节点成为leader</strong>：   在等待投票时，可能会收到其他server发出心跳信号，说明其他leader已经产生了。这时通过比较自己的term编号和RPC过来的term编号，如果比对方大，说明leader的term过期了，就会拒绝该RPC,并继续保持候选人身份; 如果对方编号不比自己小,则承认对方的地位,转为follower。</li> <li><strong>选票被瓜分,选举失败</strong>:  如果没有candidate获取大多数选票, 则没有leader产生, candidate们等待超时后发起另一轮选举.  为了防止下一次选票还被瓜分,必须采取一些额外的措施, raft采用随机election  timeout(随机休眠时间)的机制防止选票被持续瓜分。通过将timeout随机设为一段区间上的某个值,  因此很大概率会有某个candidate率先超时然后赢得大部分选票。</li></ul> <p>所以以三个节点的集群为例，选举过程会是这样的：</p> <ol><li>集群启动时，三个节点都是follower，发起投票后，三个节点都会给自己投票。这样一轮投票下来，三个节点的term都是1，是一样的，这样是选举不出Leader的。</li> <li>当一轮投票选举不出Leader后，三个节点会进入随机休眠，例如A休眠1秒，B休眠3秒，C休眠2秒。</li> <li>一秒后，A节点醒来，会把自己的term加一票，投为2。然后2秒时，C节点醒来，发现A的term已经是2，比自己的1大，就会承认A是Leader，把自己的term也更新为2。实际上这个时候，A已经获得了集群中的多数票，2票，A就会被选举成Leader。这样，一般经过很短的几轮选举，就会选举出一个Leader来。</li> <li>到3秒时，B节点会醒来，他也同样会承认A的term最大，他是Leader，自己的term也会更新为2。这样集群中的所有Candidate就都确定成了leader和follower.</li> <li>然后在一个任期内，A会不断发心跳给另外两个节点。当A挂了后，另外的节点没有收到A的心跳，就会都转化成Candidate状态，重新发起选举。</li></ol></blockquote> <p>Dledger还会采用Raft协议进行多副本的消息同步：</p> <blockquote><p>简单来说，数据同步会通过两个阶段，一个是uncommitted阶段，一个是commited阶段。</p> <p>Leader Broker上的Dledger收到一条数据后，会标记为uncommitted状态，然后他通过自己的DledgerServer组件把这个uncommitted数据发给Follower Broker的DledgerServer组件。</p> <p>接着Follower Broker的DledgerServer收到uncommitted消息之后，必须返回一个ack给Leader  Broker的Dledger。然后如果Leader Broker收到超过半数的Follower  Broker返回的ack之后，就会把消息标记为committed状态。</p> <p>​		再接下来， Leader  Broker上的DledgerServer就会发送committed消息给Follower  Broker上的DledgerServer，让他们把消息也标记为committed状态。这样，就基于Raft协议完成了两阶段的数据同步。</p></blockquote> <p>最后，关于Dledger以及Raft协议的更底层的详细资料，后续会有一个分布式一致性协议的专题，将会结合其他分布式一致性算法做统一讲解，这里就不深入展开了。</p> <h3 id="_6-名字服务-name-server"><a href="#_6-名字服务-name-server" class="header-anchor">#</a> 6 名字服务（Name Server）</h3> <p>名称服务充当路由消息的提供者。Broker Server会在启动时向所有的Name  Server注册自己的服务信息，并且后续通过心跳请求的方式保证这个服务信息的实时性。生产者或消费者能够通过名字服务查找各主题相应的Broker  IP列表。多个Namesrv实例组成集群，但相互独立，没有信息交换。</p> <p>这种特性也就意味着NameServer中任意的节点挂了，只要有一台服务节点正常，整个路由服务就不会有影响。当然，这里不考虑节点的负载情况。</p> <h3 id="_7-消息-message"><a href="#_7-消息-message" class="header-anchor">#</a> 7 消息（Message）</h3> <p>消息系统所传输信息的物理载体，生产和消费数据的最小单位，每条消息必须属于一个主题Topic。RocketMQ中每个消息拥有唯一的Message ID，且可以携带具有业务标识的Key。系统提供了通过Message ID和Key查询消息的功能。</p> <p>并且Message上有一个为消息设置的标志，Tag标签。用于同一主题下区分不同类型的消息。来自同一业务单元的消息，可以根据不同业务目的在同一主题下设置不同标签。标签能够有效地保持代码的清晰度和连贯性，并优化RocketMQ提供的查询系统。消费者可以根据Tag实现对不同子主题的不同消费逻辑，实现更好的扩展性。</p> <blockquote><p>关于Message的更详细字段，在源码的docs/cn/best_practice.md中有详细介绍。</p></blockquote> <h2 id="消息存储"><a href="#消息存储" class="header-anchor">#</a> 消息存储</h2> <h3 id="_1、何时存储消息"><a href="#_1、何时存储消息" class="header-anchor">#</a> 1、何时存储消息</h3> <p>分布式队列因为有高可靠性的要求，所以数据要进行持久化存储。</p> <ol><li>MQ收到一条消息后，需要向生产者返回一个ACK响应，并将消息存储起来。</li> <li>MQ Push一条消息给消费者后，等待消费者的ACK响应，需要将消息标记为已消费。如果没有标记为消费，MQ会不断的尝试往消费者推送这条消息。</li> <li>MQ需要定期删除一些过期的消息，这样才能保证服务一直可用。</li></ol> <h3 id="_2、消息存储介质"><a href="#_2、消息存储介质" class="header-anchor">#</a> 2、消息存储介质</h3> <p>RocketMQ采用的是类似于Kafka的文件存储机制，即直接用磁盘文件来保存消息，而不需要借助MySQL这一类索引工具。</p> <h4 id="_2-1磁盘保存文件慢吗"><a href="#_2-1磁盘保存文件慢吗" class="header-anchor">#</a> 2.1磁盘保存文件慢吗？</h4> <p>磁盘如果使用得当，磁盘的速度完全可以匹配上网络 的数据传输速度。目前的高性能磁盘，顺序写速度可以达到600MB/s，  超过了一般网卡的传输速度。但是磁盘随机写的速度只有大概100KB/s，和顺序写的性能相差6000倍！因为有如此巨大的速度差别，好的消息队列系统会比普通的消息队列系统速度快多个数量级。RocketMQ的消息用顺序写,保证了消息存储的速度。</p> <h4 id="_2-2零拷贝技术加速文件读写"><a href="#_2-2零拷贝技术加速文件读写" class="header-anchor">#</a> 2.2零拷贝技术加速文件读写</h4> <p>Linux操作系统分为【用户态】和【内核态】，文件操作、网络操作需要涉及这两种形态的切换，免不了进行数据复制。</p> <p>一台服务器 把本机磁盘文件的内容发送到客户端，一般分为两个步骤：</p> <p>1）read；读取本地文件内容；</p> <p>2）write；将读取的内容通过网络发送出去。</p> <p>这两个看似简单的操作，实际进行了4 次数据复制，分别是：</p> <ol><li>从磁盘复制数据到内核态内存；</li> <li>从内核态内存复 制到用户态内存；</li> <li>然后从用户态 内存复制到网络驱动的内核态内存；</li> <li>最后是从网络驱动的内核态内存复 制到网卡中进行传输。</li></ol> <p>而通过使用mmap的方式，可以省去向用户态的内存复制，提高速度。这种机制在Java中是通过NIO包中的MappedByteBuffer实现的。RocketMQ充分利用了上述特性，也就是所谓的“零拷贝”技术，提高消息存盘和网络发送的速度。</p> <blockquote><p>这里需要注意的是，采用MappedByteBuffer这种内存映射的方式有几个限制，其中之一是一次只能映射1.5~2G 的文件至用户态的虚拟内存，这也是为何RocketMQ默认设置单个CommitLog日志数据文件为1G的原因了</p></blockquote> <blockquote><p>关于零拷贝，JAVA的NIO中提供了两种实现方式，mmap和sendfile，其中mmap适合比较小的文件，而sendfile适合传递比较大的文件。同学们自行回顾下这部分的内容。</p></blockquote> <h3 id="_3-消息存储结构"><a href="#_3-消息存储结构" class="header-anchor">#</a> 3 消息存储结构</h3> <p>RocketMQ消息的存储分为三个部分：</p> <ul><li>CommitLog：存储消息的元数据。所有消息都会顺序存入到CommitLog文件当中。CommitLog由多个文件组成，每个文件固定大小1G。以第一条消息的偏移量为文件名。</li> <li>ConsumerQueue：存储消息在CommitLog的索引。一个MessageQueue一个文件，记录当前MessageQueue被哪些消费者组消费到了哪一条CommitLog。</li> <li>IndexFile：为了消息查询提供了一种通过key或时间区间来查询消息的方法，这种通过IndexFile来查找消息的方法不影响发送与消费消息的主流程</li></ul> <p>整体的消息存储结构如下图：</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/rocketmq/4.png" alt=""></p> <blockquote><p>还记得我们在搭建集群时都特意指定的文件存储路径吗？现在可以上去看看这些文件都是什么样子。还有哪些落盘的文件？</p> <p>另外还有几个文件可以了解下。</p> <p>abort：这个文件是RocketMQ用来判断程序是否正常关闭的一个标识文件。正常情况下，会在启动时创建，而关闭服务时删除。但是如果遇到一些服务器宕机，或者kill  -9这样一些非正常关闭服务的情况，这个abort文件就不会删除，因此RocketMQ就可以判断上一次服务是非正常关闭的，后续就会做一些数据恢复的操作。</p> <p>checkpoint：数据存盘检查点</p> <p>config/*.json：这些文件是将RocketMQ的一些关键配置信息进行存盘保存。例如Topic配置、消费者组配置、消费者组消息偏移量Offset 等等一些信息。</p></blockquote> <h3 id="_4-刷盘机制"><a href="#_4-刷盘机制" class="header-anchor">#</a> 4 刷盘机制</h3> <p>RocketMQ需要将消息存储到磁盘上，这样才能保证断电后消息不会丢失。同时这样才可以让存储的消息量可以超出内存的限制。RocketMQ为了提高性能，会尽量保证磁盘的顺序写。消息在写入磁盘时，有两种写磁盘的方式，同步刷盘和异步刷盘</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/rocketmq/5.png" alt=""></p> <ul><li><p>同步刷盘：</p> <p>在返回写成功状态时，消息已经被写入磁盘。具体流程是，消息写入内存的PAGECACHE后，立刻通知刷盘线程刷盘， 然后等待刷盘完成，刷盘线程执行完成后唤醒等待的线程，返回消息写 成功的状态。</p></li> <li><p>异步刷盘：</p> <p>在返回写成功状态时，消息可能只是被写入了内存的PAGECACHE，写操作的返回快，吞吐量大；当内存里的消息量积累到一定程度时，统一触发写磁盘动作，快速写入。</p></li> <li><p>配置方式：</p> <p>刷盘方式是通过Broker配置文件里的flushDiskType 参数设置的，这个参数被配置成SYNC_FLUSH、ASYNC_FLUSH中的 一个。</p></li></ul> <h3 id="_5-消息主从复制"><a href="#_5-消息主从复制" class="header-anchor">#</a> 5 消息主从复制</h3> <p>如果Broker以一个集群的方式部署，会有一个master节点和多个slave节点，消息需要从Master复制到Slave上。而消息复制的方式分为同步复制和异步复制。</p> <ul><li>同步复制：</li></ul> <p>同步复制是等Master和Slave都写入消息成功后才反馈给客户端写入成功的状态。</p> <p>在同步复制下，如果Master节点故障，Slave上有全部的数据备份，这样容易恢复数据。但是同步复制会增大数据写入的延迟，降低系统的吞吐量。</p> <ul><li>异步复制：</li></ul> <p>异步复制是只要master写入消息成功，就反馈给客户端写入成功的状态。然后再异步的将消息复制给Slave节点。</p> <p>在异步复制下，系统拥有较低的延迟和较高的吞吐量。但是如果master节点故障，而有些数据没有完成复制，就会造成数据丢失。</p> <ul><li>配置方式：</li></ul> <p>消息复制方式是通过Broker配置文件里的brokerRole参数进行设置的，这个参数可以被设置成ASYNC_MASTER、 SYNC_MASTER、SLAVE三个值中的一个。</p> <h3 id="_6-负载均衡"><a href="#_6-负载均衡" class="header-anchor">#</a> 6 负载均衡</h3> <h4 id="_6-1producer负载均衡"><a href="#_6-1producer负载均衡" class="header-anchor">#</a> 6.1Producer负载均衡</h4> <p>Producer发送消息时，默认会轮询目标Topic下的所有MessageQueue，并采用递增取模的方式往不同的MessageQueue上发送消息，以达到让消息平均落在不同的queue上的目的。而由于MessageQueue是分布在不同的Broker上的，所以消息也会发送到不同的broker上。</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/rocketmq/6.png" alt=""></p> <p>同时生产者在发送消息时，可以指定一个MessageQueueSelector。通过这个对象来将消息发送到自己指定的MessageQueue上。这样可以保证消息局部有序。</p> <h4 id="_6-2-consumer负载均衡"><a href="#_6-2-consumer负载均衡" class="header-anchor">#</a> 6.2 Consumer负载均衡</h4> <p>Consumer也是以MessageQueue为单位来进行负载均衡。分为集群模式和广播模式。</p> <h5 id="_1、集群模式"><a href="#_1、集群模式" class="header-anchor">#</a> 1、集群模式</h5> <p>在集群消费模式下，每条消息只需要投递到订阅这个topic的Consumer Group下的一个实例即可。RocketMQ采用主动拉取的方式拉取并消费消息，在拉取的时候需要明确指定拉取哪一条message queue。</p> <p>而每当实例的数量有变更，都会触发一次所有实例的负载均衡，这时候会按照queue的数量和实例的数量平均分配queue给每个实例。</p> <p>每次分配时，都会将MessageQueue和消费者ID进行排序后，再用不同的分配算法进行分配。内置的分配的算法共有六种，分别对应AllocateMessageQueueStrategy下的六种实现类，可以在consumer中直接set来指定。默认情况下使用的是最简单的平均分配策略。</p> <ul><li>AllocateMachineRoomNearby： 将同机房的Consumer和Broker优先分配在一起。</li></ul> <p>​	这个策略可以通过一个machineRoomResolver对象来定制Consumer和Broker的机房解析规则。然后还需要引入另外一个分配策略来对同机房的Broker和Consumer进行分配。一般也就用简单的平均分配策略或者轮询分配策略。</p> <blockquote><p>感觉这东西挺鸡肋的，直接给个属性指定机房不是挺好的吗。</p></blockquote> <p>​	源码中有测试代码AllocateMachineRoomNearByTest。</p> <p>​	在示例中：Broker的机房指定方式： messageQueue.getBrokerName().split(&quot;-&quot;)[0]，而Consumer的机房指定方式：clientID.split(&quot;-&quot;)[0]</p> <p>​		clinetID的构建方式：见ClientConfig.buildMQClientId方法。按他的测试代码应该是要把clientIP指定为IDC1-CID-0这样的形式。</p> <ul><li>AllocateMessageQueueAveragely：平均分配。将所有MessageQueue平均分给每一个消费者</li> <li>AllocateMessageQueueAveragelyByCircle： 轮询分配。轮流的给一个消费者分配一个MessageQueue。</li> <li>AllocateMessageQueueByConfig： 不分配，直接指定一个messageQueue列表。类似于广播模式，直接指定所有队列。</li> <li>AllocateMessageQueueByMachineRoom：按逻辑机房的概念进行分配。又是对BrokerName和ConsumerIdc有定制化的配置。</li> <li>AllocateMessageQueueConsistentHash。源码中有测试代码AllocateMessageQueueConsitentHashTest。这个一致性哈希策略只需要指定一个虚拟节点数，是用的一个哈希环的算法，虚拟节点是为了让Hash数据在换上分布更为均匀。</li></ul> <p>例如平均分配时的分配情况是这样的：</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/rocketmq/7.png" alt=""></p> <h5 id="_2、广播模式"><a href="#_2、广播模式" class="header-anchor">#</a> 2、广播模式</h5> <p>广播模式下，每一条消息都会投递给订阅了Topic的所有消费者实例，所以也就没有消息分配这一说。而在实现上，就是在Consumer分配Queue时，所有Consumer都分到所有的Queue。</p> <h3 id="_7、消息重试"><a href="#_7、消息重试" class="header-anchor">#</a> 7、消息重试</h3> <p>首先对于广播模式的消息， 是不存在消息重试的机制的，即消息消费失败后，不会再重新进行发送，而只是继续消费新的消息。</p> <p>而对于普通的消息，当消费者消费消息失败后，你可以通过设置返回状态达到消息重试的结果。</p> <h4 id="_1、如何让消息进行重试"><a href="#_1、如何让消息进行重试" class="header-anchor">#</a> 1、如何让消息进行重试</h4> <p>集群消费方式下，消息消费失败后期望消息重试，需要在消息监听器接口的实现中明确进行配置。可以有三种配置方式：</p> <ul><li>返回Action.ReconsumeLater-推荐</li> <li>返回null</li> <li>抛出异常</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>public class MessageListenerImpl implements MessageListener {
    @Override
    public Action consume(Message message, ConsumeContext context) {
        //处理消息
        doConsumeMessage(message);
        //方式1：返回 Action.ReconsumeLater，消息将重试
        return Action.ReconsumeLater;
        //方式2：返回 null，消息将重试
        return null;
        //方式3：直接抛出异常， 消息将重试
        throw new RuntimeException(&quot;Consumer Message exceotion&quot;);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>如果希望消费失败后不重试，可以直接返回Action.CommitMessage。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public class MessageListenerImpl implements MessageListener {
    @Override
    public Action consume(Message message, ConsumeContext context) {
        try {
            doConsumeMessage(message);
        } catch (Throwable e) {
            //捕获消费逻辑中的所有异常，并返回 Action.CommitMessage;
            return Action.CommitMessage;
        }
        //消息处理正常，直接返回 Action.CommitMessage;
        return Action.CommitMessage;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_2、重试消息如何处理"><a href="#_2、重试消息如何处理" class="header-anchor">#</a> 2、重试消息如何处理</h4> <p>重试的消息会进入一个 “%RETRY%”+ConsumeGroup  的队列中。</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/rocketmq/8.png" alt=""></p> <p>然后RocketMQ默认允许每条消息最多重试16次，每次重试的间隔时间如下：</p> <table><thead><tr><th style="text-align:center;">重试次数</th> <th style="text-align:center;">与上次重试的间隔时间</th> <th style="text-align:center;">重试次数</th> <th style="text-align:center;">与上次重试的间隔时间</th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td style="text-align:center;">10 秒</td> <td style="text-align:center;">9</td> <td style="text-align:center;">7 分钟</td></tr> <tr><td style="text-align:center;">2</td> <td style="text-align:center;">30 秒</td> <td style="text-align:center;">10</td> <td style="text-align:center;">8 分钟</td></tr> <tr><td style="text-align:center;">3</td> <td style="text-align:center;">1 分钟</td> <td style="text-align:center;">11</td> <td style="text-align:center;">9 分钟</td></tr> <tr><td style="text-align:center;">4</td> <td style="text-align:center;">2 分钟</td> <td style="text-align:center;">12</td> <td style="text-align:center;">10 分钟</td></tr> <tr><td style="text-align:center;">5</td> <td style="text-align:center;">3 分钟</td> <td style="text-align:center;">13</td> <td style="text-align:center;">20 分钟</td></tr> <tr><td style="text-align:center;">6</td> <td style="text-align:center;">4 分钟</td> <td style="text-align:center;">14</td> <td style="text-align:center;">30 分钟</td></tr> <tr><td style="text-align:center;">7</td> <td style="text-align:center;">5 分钟</td> <td style="text-align:center;">15</td> <td style="text-align:center;">1 小时</td></tr> <tr><td style="text-align:center;">8</td> <td style="text-align:center;">6 分钟</td> <td style="text-align:center;">16</td> <td style="text-align:center;">2 小时</td></tr></tbody></table> <blockquote><p>这个重试时间跟延迟消息的延迟级别是对应的。不过取的是延迟级别的后16级别。</p> <p>messageDelayLevel=1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</p> <p>这个重试时间可以将源码中的org.apache.rocketmq.example.quickstart.Consumer里的消息监听器返回状态改为RECONSUME_LATER测试一下。</p></blockquote> <p><strong>重试次数：</strong></p> <p>如果消息重试16次后仍然失败，消息将不再投递。转为进入死信队列。</p> <p>另外一条消息无论重试多少次，这些重试消息的MessageId始终都是一样的。</p> <p>然后关于这个重试次数，RocketMQ可以进行定制。例如通过consumer.setMaxReconsumeTimes(20);将重试次数设定为20次。当定制的重试次数超过16次后，消息的重试时间间隔均为2小时。</p> <p><strong>关于MessageId：</strong></p> <p>在老版本的RocketMQ中，一条消息无论重试多少次，这些重试消息的MessageId始终都是一样的。</p> <p>但是在4.7.1版本中，每次重试MessageId都会重建。</p> <p><strong>配置覆盖：</strong></p> <p>消息最大重试次数的设置对相同GroupID下的所有Consumer实例有效。并且最后启动的Consumer会覆盖之前启动的Consumer的配置。</p> <h3 id="_8、死信队列"><a href="#_8、死信队列" class="header-anchor">#</a> 8、死信队列</h3> <p>当一条消息消费失败，RocketMQ就会自动进行消息重试。而如果消息超过最大重试次数，RocketMQ就会认为这个消息有问题。但是此时，RocketMQ不会立刻将这个有问题的消息丢弃，而会将其发送到这个消费者组对应的一种特殊队列：死信队列。</p> <p>死信队列的名称是%DLQ%+ConsumGroup</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/rocketmq/9.png" alt=""></p> <p><strong>死信队列的特征：</strong></p> <ul><li>一个死信队列对应一个ConsumGroup，而不是对应某个消费者实例。</li> <li>如果一个ConsumeGroup没有产生死信队列，RocketMQ就不会为其创建相应的死信队列。</li> <li>一个死信队列包含了这个ConsumeGroup里的所有死信消息，而不区分该消息属于哪个Topic。</li> <li>死信队列中的消息不会再被消费者正常消费。</li> <li>死信队列的有效期跟正常消息相同。默认3天，对应broker.conf中的fileReservedTime属性。超过这个最长时间的消息都会被删除，而不管消息是否消费过。</li></ul> <p>通常，一条消息进入了死信队列，意味着消息在消费处理的过程中出现了比较严重的错误，并且无法自行恢复。此时，一般需要人工去查看死信队列中的消息，对错误原因进行排查。然后对死信消息进行处理，比如转发到正常的Topic重新进行消费，或者丢弃。</p> <blockquote><p>注：默认创建出来的死信队列，他里面的消息是无法读取的，在控制台和消费者中都无法读取。这是因为这些默认的死信队列，他们的权限perm被设置成了2:禁读(这个权限有三种 2:禁读，4:禁写,6:可读可写)。需要手动将死信队列的权限配置成6，才能被消费(可以通过mqadmin指定或者web控制台)。</p></blockquote> <h3 id="_9、消息幂等"><a href="#_9、消息幂等" class="header-anchor">#</a> 9、消息幂等</h3> <h4 id="_1、幂等的概念"><a href="#_1、幂等的概念" class="header-anchor">#</a> 1、幂等的概念</h4> <p>在MQ系统中，对于消息幂等有三种实现语义：</p> <ul><li>at most once 最多一次：每条消息最多只会被消费一次</li> <li>at least once 至少一次：每条消息至少会被消费一次</li> <li>exactly once 刚刚好一次：每条消息都只会确定的消费一次</li></ul> <p>这三种语义都有他适用的业务场景。</p> <p>其中，at most once是最好保证的。RocketMQ中可以直接用异步发送、sendOneWay等方式就可以保证。</p> <p>而at least once这个语义，RocketMQ也有同步发送、事务消息等很多方式能够保证。</p> <p>而这个exactly once是MQ中最理想也是最难保证的一种语义，需要有非常精细的设计才行。RocketMQ只能保证at least once，保证不了exactly once。所以，使用RocketMQ时，需要由业务系统自行保证消息的幂等性。</p> <blockquote><p>关于这个问题，官网上有明确的回答：</p> <h3 id="_4-are-messages-delivered-exactly-once"><a href="#_4-are-messages-delivered-exactly-once" class="header-anchor">#</a> 4. Are messages delivered exactly once?</h3> <p>RocketMQ ensures that all messages are delivered at least once. In most cases, the messages are not repeated.</p></blockquote> <h4 id="_2、消息幂等的必要性"><a href="#_2、消息幂等的必要性" class="header-anchor">#</a> 2、消息幂等的必要性</h4> <p>在互联网应用中，尤其在网络不稳定的情况下，消息队列 RocketMQ 的消息有可能会出现重复，这个重复简单可以概括为以下情况：</p> <ul><li><p>发送时消息重复</p> <p>当一条消息已被成功发送到服务端并完成持久化，此时出现了网络闪断或者客户端宕机，导致服务端对客户端应答失败。 如果此时生产者意识到消息发送失败并尝试再次发送消息，消费者后续会收到两条内容相同并且 Message ID 也相同的消息。</p></li> <li><p>投递时消息重复</p> <p>消息消费的场景下，消息已投递到消费者并完成业务处理，当客户端给服务端反馈应答的时候网络闪断。 为了保证消息至少被消费一次，消息队列 RocketMQ  的服务端将在网络恢复后再次尝试投递之前已被处理过的消息，消费者后续会收到两条内容相同并且 Message ID 也相同的消息。</p></li> <li><p>负载均衡时消息重复（包括但不限于网络抖动、Broker 重启以及订阅方应用重启）</p> <p>当消息队列 RocketMQ 的 Broker 或客户端重启、扩容或缩容时，会触发 Rebalance，此时消费者可能会收到重复消息。</p></li></ul> <h4 id="_3、处理方式"><a href="#_3、处理方式" class="header-anchor">#</a> 3、处理方式</h4> <p>从上面的分析中，我们知道，在RocketMQ中，是无法保证每个消息只被投递一次的，所以要在业务上自行来保证消息消费的幂等性。</p> <p>而要处理这个问题，RocketMQ的每条消息都有一个唯一的MessageId，这个参数在多次投递的过程中是不会改变的，所以业务上可以用这个MessageId来作为判断幂等的关键依据。</p> <p>但是，这个MessageId是无法保证全局唯一的，也会有冲突的情况。所以在一些对幂等性要求严格的场景，最好是使用业务上唯一的一个标识比较靠谱。例如订单ID。而这个业务标识可以使用Message的Key来进行传递。</p></div></div>  <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/a75fef/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">MQ概述</div></a> <a href="/pages/5f13a2/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">21RocketMQ实践问题</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/a75fef/" class="prev">MQ概述</a></span> <span class="next"><a href="/pages/5f13a2/">21RocketMQ实践问题</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/80365f/"><div>
            证券市场基本法律法规
            <!----></div></a> <span class="date">03-13</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/d9e4f4/"><div>
            证券考试规则
            <!----></div></a> <span class="date">03-12</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/cb2c17/"><div>
            金融市场基础知识
            <!----></div></a> <span class="date">03-12</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:cloudjava@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/bigdatajava" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/nylg" title="Gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2014-2025
    <span>wen chao | <a href="https://github.com/bigdatajava/blog-talk/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.af2629f3.js" defer></script><script src="/assets/js/2.c7acc05c.js" defer></script><script src="/assets/js/60.ca146265.js" defer></script>
  </body>
</html>

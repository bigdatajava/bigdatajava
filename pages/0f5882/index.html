<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ElasticSearch原理 | wen chao</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3129839_xft6cqs5gc.css">
    <meta name="description" content="架构进阶之路...">
    <meta name="keywords" content="全栈博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,js,ES6,TypeScript,vue">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.877370ef.css" as="style"><link rel="preload" href="/assets/js/app.af2629f3.js" as="script"><link rel="preload" href="/assets/js/2.c7acc05c.js" as="script"><link rel="preload" href="/assets/js/77.bb898521.js" as="script"><link rel="prefetch" href="/assets/js/10.003809e3.js"><link rel="prefetch" href="/assets/js/100.05e6d7b0.js"><link rel="prefetch" href="/assets/js/101.aedcfb99.js"><link rel="prefetch" href="/assets/js/102.0f45ef0b.js"><link rel="prefetch" href="/assets/js/103.f6349067.js"><link rel="prefetch" href="/assets/js/104.159e4fea.js"><link rel="prefetch" href="/assets/js/105.cf376772.js"><link rel="prefetch" href="/assets/js/106.4a24f110.js"><link rel="prefetch" href="/assets/js/107.9130a4fc.js"><link rel="prefetch" href="/assets/js/108.557f1de3.js"><link rel="prefetch" href="/assets/js/109.0eae2c98.js"><link rel="prefetch" href="/assets/js/11.46d1f704.js"><link rel="prefetch" href="/assets/js/110.be00b9ae.js"><link rel="prefetch" href="/assets/js/111.454bc20b.js"><link rel="prefetch" href="/assets/js/112.c987bc96.js"><link rel="prefetch" href="/assets/js/113.f07c8b3c.js"><link rel="prefetch" href="/assets/js/114.ab099d7d.js"><link rel="prefetch" href="/assets/js/115.a5bda3c7.js"><link rel="prefetch" href="/assets/js/116.eb280ad8.js"><link rel="prefetch" href="/assets/js/117.1863722f.js"><link rel="prefetch" href="/assets/js/118.3f192a2d.js"><link rel="prefetch" href="/assets/js/119.66b89deb.js"><link rel="prefetch" href="/assets/js/12.03486813.js"><link rel="prefetch" href="/assets/js/120.69b1d465.js"><link rel="prefetch" href="/assets/js/121.113b1b5a.js"><link rel="prefetch" href="/assets/js/122.917086b7.js"><link rel="prefetch" href="/assets/js/123.ef1b72cd.js"><link rel="prefetch" href="/assets/js/124.a52fd442.js"><link rel="prefetch" href="/assets/js/125.65cf0d15.js"><link rel="prefetch" href="/assets/js/126.9257bcef.js"><link rel="prefetch" href="/assets/js/127.c080527e.js"><link rel="prefetch" href="/assets/js/128.90389431.js"><link rel="prefetch" href="/assets/js/129.582bff3e.js"><link rel="prefetch" href="/assets/js/13.ba8e34d1.js"><link rel="prefetch" href="/assets/js/130.fb170212.js"><link rel="prefetch" href="/assets/js/131.ed138ac9.js"><link rel="prefetch" href="/assets/js/132.4223d6f9.js"><link rel="prefetch" href="/assets/js/133.012411be.js"><link rel="prefetch" href="/assets/js/134.ed98c78a.js"><link rel="prefetch" href="/assets/js/135.2b6eb13f.js"><link rel="prefetch" href="/assets/js/136.65149943.js"><link rel="prefetch" href="/assets/js/137.341d7363.js"><link rel="prefetch" href="/assets/js/138.e9834544.js"><link rel="prefetch" href="/assets/js/139.ff517435.js"><link rel="prefetch" href="/assets/js/14.71b2ed4a.js"><link rel="prefetch" href="/assets/js/140.bf2b9d2d.js"><link rel="prefetch" href="/assets/js/141.ef8d876a.js"><link rel="prefetch" href="/assets/js/142.c28e6ef9.js"><link rel="prefetch" href="/assets/js/143.d0b43d89.js"><link rel="prefetch" href="/assets/js/144.9545dbb1.js"><link rel="prefetch" href="/assets/js/145.c5c5aca2.js"><link rel="prefetch" href="/assets/js/146.c6989cd8.js"><link rel="prefetch" href="/assets/js/147.fe16ad8a.js"><link rel="prefetch" href="/assets/js/148.102ea00d.js"><link rel="prefetch" href="/assets/js/149.2e62b9d1.js"><link rel="prefetch" href="/assets/js/15.1736a531.js"><link rel="prefetch" href="/assets/js/150.daf684ac.js"><link rel="prefetch" href="/assets/js/151.988a3ba9.js"><link rel="prefetch" href="/assets/js/152.4742bb74.js"><link rel="prefetch" href="/assets/js/153.02bcce99.js"><link rel="prefetch" href="/assets/js/154.ebde7923.js"><link rel="prefetch" href="/assets/js/155.c906862e.js"><link rel="prefetch" href="/assets/js/156.3b3d94d4.js"><link rel="prefetch" href="/assets/js/157.81d8c740.js"><link rel="prefetch" href="/assets/js/158.40095645.js"><link rel="prefetch" href="/assets/js/159.2abc32c5.js"><link rel="prefetch" href="/assets/js/16.fb9d3b9b.js"><link rel="prefetch" href="/assets/js/160.dfa13df3.js"><link rel="prefetch" href="/assets/js/161.5697eb79.js"><link rel="prefetch" href="/assets/js/162.fef5ab87.js"><link rel="prefetch" href="/assets/js/163.8b3dff03.js"><link rel="prefetch" href="/assets/js/164.826228d2.js"><link rel="prefetch" href="/assets/js/165.e0099d56.js"><link rel="prefetch" href="/assets/js/166.8294f6c0.js"><link rel="prefetch" href="/assets/js/167.d07b77dd.js"><link rel="prefetch" href="/assets/js/168.c23c0d7b.js"><link rel="prefetch" href="/assets/js/169.c7f7599b.js"><link rel="prefetch" href="/assets/js/17.e42188aa.js"><link rel="prefetch" href="/assets/js/170.b11ea482.js"><link rel="prefetch" href="/assets/js/171.73278046.js"><link rel="prefetch" href="/assets/js/172.040cd7fc.js"><link rel="prefetch" href="/assets/js/173.e0199ce5.js"><link rel="prefetch" href="/assets/js/174.3010733d.js"><link rel="prefetch" href="/assets/js/175.05c196ea.js"><link rel="prefetch" href="/assets/js/176.c490fc2b.js"><link rel="prefetch" href="/assets/js/177.7bcb888a.js"><link rel="prefetch" href="/assets/js/178.34093cd3.js"><link rel="prefetch" href="/assets/js/179.b2413571.js"><link rel="prefetch" href="/assets/js/18.383f6a09.js"><link rel="prefetch" href="/assets/js/180.9648ec05.js"><link rel="prefetch" href="/assets/js/181.342f0059.js"><link rel="prefetch" href="/assets/js/182.35eac70e.js"><link rel="prefetch" href="/assets/js/183.f4a83742.js"><link rel="prefetch" href="/assets/js/184.d82b8a96.js"><link rel="prefetch" href="/assets/js/185.9f5f32ef.js"><link rel="prefetch" href="/assets/js/186.600a4950.js"><link rel="prefetch" href="/assets/js/187.df953d4f.js"><link rel="prefetch" href="/assets/js/188.2491fa83.js"><link rel="prefetch" href="/assets/js/189.32d3c1a4.js"><link rel="prefetch" href="/assets/js/19.cb72d9a9.js"><link rel="prefetch" href="/assets/js/190.39ac92fc.js"><link rel="prefetch" href="/assets/js/191.3125fa77.js"><link rel="prefetch" href="/assets/js/192.7655632a.js"><link rel="prefetch" href="/assets/js/193.7f55a678.js"><link rel="prefetch" href="/assets/js/194.b9c56642.js"><link rel="prefetch" href="/assets/js/195.189fe681.js"><link rel="prefetch" href="/assets/js/196.71658166.js"><link rel="prefetch" href="/assets/js/197.af445c6a.js"><link rel="prefetch" href="/assets/js/198.1de2afd9.js"><link rel="prefetch" href="/assets/js/199.2c218726.js"><link rel="prefetch" href="/assets/js/20.0e9f2f72.js"><link rel="prefetch" href="/assets/js/200.26590f9f.js"><link rel="prefetch" href="/assets/js/201.36d7a8ea.js"><link rel="prefetch" href="/assets/js/202.6c36d934.js"><link rel="prefetch" href="/assets/js/203.d4ae9b00.js"><link rel="prefetch" href="/assets/js/204.c3b2f994.js"><link rel="prefetch" href="/assets/js/205.f480166b.js"><link rel="prefetch" href="/assets/js/206.90dc53ae.js"><link rel="prefetch" href="/assets/js/207.f959801b.js"><link rel="prefetch" href="/assets/js/208.5da4dac0.js"><link rel="prefetch" href="/assets/js/209.217e41a9.js"><link rel="prefetch" href="/assets/js/21.7a7c5c4f.js"><link rel="prefetch" href="/assets/js/210.fb1d985a.js"><link rel="prefetch" href="/assets/js/211.5a3d515c.js"><link rel="prefetch" href="/assets/js/212.bb654f9b.js"><link rel="prefetch" href="/assets/js/213.b8f5ac66.js"><link rel="prefetch" href="/assets/js/214.cfb1547f.js"><link rel="prefetch" href="/assets/js/215.a1de2fe7.js"><link rel="prefetch" href="/assets/js/216.d76003a4.js"><link rel="prefetch" href="/assets/js/217.ad201174.js"><link rel="prefetch" href="/assets/js/218.5adcad1a.js"><link rel="prefetch" href="/assets/js/219.9f3b9b01.js"><link rel="prefetch" href="/assets/js/22.b9540503.js"><link rel="prefetch" href="/assets/js/220.af64e5ad.js"><link rel="prefetch" href="/assets/js/221.379beb37.js"><link rel="prefetch" href="/assets/js/222.85aa5cd0.js"><link rel="prefetch" href="/assets/js/223.13475fe5.js"><link rel="prefetch" href="/assets/js/224.d06abfcb.js"><link rel="prefetch" href="/assets/js/225.1f738876.js"><link rel="prefetch" href="/assets/js/226.a09031a1.js"><link rel="prefetch" href="/assets/js/227.f6018b9a.js"><link rel="prefetch" href="/assets/js/228.ae3296e4.js"><link rel="prefetch" href="/assets/js/229.d9bcea85.js"><link rel="prefetch" href="/assets/js/23.6b5fd8ae.js"><link rel="prefetch" href="/assets/js/230.68a89532.js"><link rel="prefetch" href="/assets/js/231.b31aa02f.js"><link rel="prefetch" href="/assets/js/232.cc07d501.js"><link rel="prefetch" href="/assets/js/233.76443c50.js"><link rel="prefetch" href="/assets/js/234.5efbcd6a.js"><link rel="prefetch" href="/assets/js/235.dfcf36cf.js"><link rel="prefetch" href="/assets/js/236.4bb99856.js"><link rel="prefetch" href="/assets/js/237.79a22c20.js"><link rel="prefetch" href="/assets/js/238.1b592be7.js"><link rel="prefetch" href="/assets/js/239.a4c119aa.js"><link rel="prefetch" href="/assets/js/24.63372db7.js"><link rel="prefetch" href="/assets/js/240.22d7d47a.js"><link rel="prefetch" href="/assets/js/241.36336698.js"><link rel="prefetch" href="/assets/js/242.b7db4d20.js"><link rel="prefetch" href="/assets/js/243.f156bf47.js"><link rel="prefetch" href="/assets/js/244.14f3046b.js"><link rel="prefetch" href="/assets/js/245.984447ea.js"><link rel="prefetch" href="/assets/js/246.cd55bf13.js"><link rel="prefetch" href="/assets/js/247.d2a77b3d.js"><link rel="prefetch" href="/assets/js/248.c23e38fd.js"><link rel="prefetch" href="/assets/js/249.a0b42d1f.js"><link rel="prefetch" href="/assets/js/25.d3f99e2a.js"><link rel="prefetch" href="/assets/js/250.870b2e9a.js"><link rel="prefetch" href="/assets/js/251.ee8edd7f.js"><link rel="prefetch" href="/assets/js/252.15e2c05e.js"><link rel="prefetch" href="/assets/js/253.18d0fc46.js"><link rel="prefetch" href="/assets/js/254.39ecf5f7.js"><link rel="prefetch" href="/assets/js/255.d42ae6e7.js"><link rel="prefetch" href="/assets/js/256.5a2b4630.js"><link rel="prefetch" href="/assets/js/257.df147154.js"><link rel="prefetch" href="/assets/js/258.f42bcf46.js"><link rel="prefetch" href="/assets/js/259.022f92f9.js"><link rel="prefetch" href="/assets/js/26.c6b54266.js"><link rel="prefetch" href="/assets/js/260.abb07bf2.js"><link rel="prefetch" href="/assets/js/261.74b1bebb.js"><link rel="prefetch" href="/assets/js/262.680edf56.js"><link rel="prefetch" href="/assets/js/263.0cdbe35a.js"><link rel="prefetch" href="/assets/js/264.ea699edd.js"><link rel="prefetch" href="/assets/js/265.cf168b25.js"><link rel="prefetch" href="/assets/js/266.18f03883.js"><link rel="prefetch" href="/assets/js/267.007dcd30.js"><link rel="prefetch" href="/assets/js/268.41de028b.js"><link rel="prefetch" href="/assets/js/269.e206560c.js"><link rel="prefetch" href="/assets/js/27.120b6069.js"><link rel="prefetch" href="/assets/js/270.164398a3.js"><link rel="prefetch" href="/assets/js/271.7d100757.js"><link rel="prefetch" href="/assets/js/272.0b83e5d3.js"><link rel="prefetch" href="/assets/js/273.f317bcb6.js"><link rel="prefetch" href="/assets/js/274.2947d9f0.js"><link rel="prefetch" href="/assets/js/275.e99b65f2.js"><link rel="prefetch" href="/assets/js/276.ea03cf89.js"><link rel="prefetch" href="/assets/js/277.93476fbc.js"><link rel="prefetch" href="/assets/js/278.db0ff8eb.js"><link rel="prefetch" href="/assets/js/279.b36007aa.js"><link rel="prefetch" href="/assets/js/28.91595b48.js"><link rel="prefetch" href="/assets/js/280.14723ae7.js"><link rel="prefetch" href="/assets/js/281.f27b79de.js"><link rel="prefetch" href="/assets/js/282.718708d7.js"><link rel="prefetch" href="/assets/js/283.f91a771c.js"><link rel="prefetch" href="/assets/js/284.25b1d4f7.js"><link rel="prefetch" href="/assets/js/285.a641722b.js"><link rel="prefetch" href="/assets/js/286.9d2d85fb.js"><link rel="prefetch" href="/assets/js/287.a8a0d7a2.js"><link rel="prefetch" href="/assets/js/288.ee27e2fe.js"><link rel="prefetch" href="/assets/js/289.e4300193.js"><link rel="prefetch" href="/assets/js/29.a5ef89d9.js"><link rel="prefetch" href="/assets/js/290.ba445f12.js"><link rel="prefetch" href="/assets/js/291.7a767d85.js"><link rel="prefetch" href="/assets/js/292.aa96cc76.js"><link rel="prefetch" href="/assets/js/293.e18d36c6.js"><link rel="prefetch" href="/assets/js/294.7113dff7.js"><link rel="prefetch" href="/assets/js/295.abae5e0e.js"><link rel="prefetch" href="/assets/js/296.010241c4.js"><link rel="prefetch" href="/assets/js/297.4bbe88fd.js"><link rel="prefetch" href="/assets/js/298.9f291f83.js"><link rel="prefetch" href="/assets/js/299.bf9e031a.js"><link rel="prefetch" href="/assets/js/3.1403d3ee.js"><link rel="prefetch" href="/assets/js/30.3bb57e98.js"><link rel="prefetch" href="/assets/js/300.fc58f3c4.js"><link rel="prefetch" href="/assets/js/301.69cd291f.js"><link rel="prefetch" href="/assets/js/302.c34ca8e9.js"><link rel="prefetch" href="/assets/js/303.25655f40.js"><link rel="prefetch" href="/assets/js/304.97a8e358.js"><link rel="prefetch" href="/assets/js/305.1c5e713f.js"><link rel="prefetch" href="/assets/js/306.b53f2ea6.js"><link rel="prefetch" href="/assets/js/307.e4a9a150.js"><link rel="prefetch" href="/assets/js/308.92931c17.js"><link rel="prefetch" href="/assets/js/309.6e452bde.js"><link rel="prefetch" href="/assets/js/31.f1ddaeee.js"><link rel="prefetch" href="/assets/js/310.6abc9668.js"><link rel="prefetch" href="/assets/js/311.1bd77809.js"><link rel="prefetch" href="/assets/js/312.78b7405d.js"><link rel="prefetch" href="/assets/js/313.3b23ded5.js"><link rel="prefetch" href="/assets/js/314.ae150cf1.js"><link rel="prefetch" href="/assets/js/315.d375ed9c.js"><link rel="prefetch" href="/assets/js/316.c8a05987.js"><link rel="prefetch" href="/assets/js/317.febd6c4f.js"><link rel="prefetch" href="/assets/js/318.34fe4d11.js"><link rel="prefetch" href="/assets/js/319.5b558d88.js"><link rel="prefetch" href="/assets/js/32.8019bc57.js"><link rel="prefetch" href="/assets/js/320.af89e963.js"><link rel="prefetch" href="/assets/js/321.f646b641.js"><link rel="prefetch" href="/assets/js/322.897f28f1.js"><link rel="prefetch" href="/assets/js/323.38229c39.js"><link rel="prefetch" href="/assets/js/324.7baf2418.js"><link rel="prefetch" href="/assets/js/325.e0225366.js"><link rel="prefetch" href="/assets/js/326.e30b69cd.js"><link rel="prefetch" href="/assets/js/327.6774c791.js"><link rel="prefetch" href="/assets/js/328.58239b5d.js"><link rel="prefetch" href="/assets/js/329.570eb01e.js"><link rel="prefetch" href="/assets/js/33.2009be2a.js"><link rel="prefetch" href="/assets/js/330.6c29d590.js"><link rel="prefetch" href="/assets/js/331.bbe673f1.js"><link rel="prefetch" href="/assets/js/332.6d2bbedd.js"><link rel="prefetch" href="/assets/js/333.7e60b6bd.js"><link rel="prefetch" href="/assets/js/334.9f9ea9bb.js"><link rel="prefetch" href="/assets/js/335.0f60cf92.js"><link rel="prefetch" href="/assets/js/336.3981edeb.js"><link rel="prefetch" href="/assets/js/337.0ca91dae.js"><link rel="prefetch" href="/assets/js/338.09e14c30.js"><link rel="prefetch" href="/assets/js/339.31147ffa.js"><link rel="prefetch" href="/assets/js/34.f4ffaa4e.js"><link rel="prefetch" href="/assets/js/340.b216b6b7.js"><link rel="prefetch" href="/assets/js/341.7af949b2.js"><link rel="prefetch" href="/assets/js/342.03e80905.js"><link rel="prefetch" href="/assets/js/343.147ff16c.js"><link rel="prefetch" href="/assets/js/344.c95f6de9.js"><link rel="prefetch" href="/assets/js/345.7cc8cfaa.js"><link rel="prefetch" href="/assets/js/346.d5ff42a4.js"><link rel="prefetch" href="/assets/js/347.f1f1478f.js"><link rel="prefetch" href="/assets/js/348.32ea340f.js"><link rel="prefetch" href="/assets/js/349.4d743984.js"><link rel="prefetch" href="/assets/js/35.6f997bc2.js"><link rel="prefetch" href="/assets/js/350.c218cb98.js"><link rel="prefetch" href="/assets/js/351.a6f08d8b.js"><link rel="prefetch" href="/assets/js/352.46538632.js"><link rel="prefetch" href="/assets/js/353.6702d9ff.js"><link rel="prefetch" href="/assets/js/354.10264327.js"><link rel="prefetch" href="/assets/js/355.bc66e304.js"><link rel="prefetch" href="/assets/js/356.36d9208c.js"><link rel="prefetch" href="/assets/js/357.708af07a.js"><link rel="prefetch" href="/assets/js/358.61ab6834.js"><link rel="prefetch" href="/assets/js/359.bb4ad887.js"><link rel="prefetch" href="/assets/js/36.5172c464.js"><link rel="prefetch" href="/assets/js/360.9ae57e7b.js"><link rel="prefetch" href="/assets/js/37.72aa4947.js"><link rel="prefetch" href="/assets/js/38.77129de5.js"><link rel="prefetch" href="/assets/js/39.01d84c7e.js"><link rel="prefetch" href="/assets/js/4.5517c98c.js"><link rel="prefetch" href="/assets/js/40.b2fb57bd.js"><link rel="prefetch" href="/assets/js/41.fa63fb49.js"><link rel="prefetch" href="/assets/js/42.c68fd691.js"><link rel="prefetch" href="/assets/js/43.071af6f3.js"><link rel="prefetch" href="/assets/js/44.99321348.js"><link rel="prefetch" href="/assets/js/45.4c105e24.js"><link rel="prefetch" href="/assets/js/46.91a5aa2c.js"><link rel="prefetch" href="/assets/js/47.18bd4930.js"><link rel="prefetch" href="/assets/js/48.deef5f67.js"><link rel="prefetch" href="/assets/js/49.12c80dd9.js"><link rel="prefetch" href="/assets/js/5.6b7a7b35.js"><link rel="prefetch" href="/assets/js/50.259ff32b.js"><link rel="prefetch" href="/assets/js/51.ee83db82.js"><link rel="prefetch" href="/assets/js/52.1cf54e16.js"><link rel="prefetch" href="/assets/js/53.821dd297.js"><link rel="prefetch" href="/assets/js/54.bf29c9d1.js"><link rel="prefetch" href="/assets/js/55.25e00784.js"><link rel="prefetch" href="/assets/js/56.b1112045.js"><link rel="prefetch" href="/assets/js/57.5923ed3a.js"><link rel="prefetch" href="/assets/js/58.ee7fa86f.js"><link rel="prefetch" href="/assets/js/59.7b9800f0.js"><link rel="prefetch" href="/assets/js/6.207c7bac.js"><link rel="prefetch" href="/assets/js/60.ca146265.js"><link rel="prefetch" href="/assets/js/61.77a27075.js"><link rel="prefetch" href="/assets/js/62.2839e098.js"><link rel="prefetch" href="/assets/js/63.6c8cdea8.js"><link rel="prefetch" href="/assets/js/64.1a5f538c.js"><link rel="prefetch" href="/assets/js/65.a3708a3e.js"><link rel="prefetch" href="/assets/js/66.63a1d86b.js"><link rel="prefetch" href="/assets/js/67.5563ad9d.js"><link rel="prefetch" href="/assets/js/68.182b4324.js"><link rel="prefetch" href="/assets/js/69.b695215c.js"><link rel="prefetch" href="/assets/js/7.00b0f0bb.js"><link rel="prefetch" href="/assets/js/70.819c0991.js"><link rel="prefetch" href="/assets/js/71.534cf941.js"><link rel="prefetch" href="/assets/js/72.b3c641ef.js"><link rel="prefetch" href="/assets/js/73.e613a0d5.js"><link rel="prefetch" href="/assets/js/74.d7fc07e0.js"><link rel="prefetch" href="/assets/js/75.d50101e4.js"><link rel="prefetch" href="/assets/js/76.18e7ac7b.js"><link rel="prefetch" href="/assets/js/78.a08d2106.js"><link rel="prefetch" href="/assets/js/79.0f362a00.js"><link rel="prefetch" href="/assets/js/8.197a9ad8.js"><link rel="prefetch" href="/assets/js/80.8b74cf4c.js"><link rel="prefetch" href="/assets/js/81.3e8c87af.js"><link rel="prefetch" href="/assets/js/82.83cb55b7.js"><link rel="prefetch" href="/assets/js/83.7355f968.js"><link rel="prefetch" href="/assets/js/84.51061851.js"><link rel="prefetch" href="/assets/js/85.b5df8911.js"><link rel="prefetch" href="/assets/js/86.baf2296e.js"><link rel="prefetch" href="/assets/js/87.2e9ae95d.js"><link rel="prefetch" href="/assets/js/88.57a8401a.js"><link rel="prefetch" href="/assets/js/89.a0d99eba.js"><link rel="prefetch" href="/assets/js/9.53a0556a.js"><link rel="prefetch" href="/assets/js/90.6121d367.js"><link rel="prefetch" href="/assets/js/91.56f285e2.js"><link rel="prefetch" href="/assets/js/92.7d7c0428.js"><link rel="prefetch" href="/assets/js/93.17841bd6.js"><link rel="prefetch" href="/assets/js/94.832fcc1c.js"><link rel="prefetch" href="/assets/js/95.e9c523bc.js"><link rel="prefetch" href="/assets/js/96.d8aae52a.js"><link rel="prefetch" href="/assets/js/97.bd436fab.js"><link rel="prefetch" href="/assets/js/98.78f6e4f3.js"><link rel="prefetch" href="/assets/js/99.a405fc1f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.877370ef.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="wen chao" class="logo"> <span class="site-name can-hide">wen chao</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Algorithm" class="dropdown-title"><a href="/Algorithm/" class="link-title">Algorithm</a> <span class="title" style="display:none;">Algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d8e764/" class="nav-link">Theory</a></li><li class="dropdown-item"><!----> <a href="/pages/81a4bd/" class="nav-link">LeetCode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/Spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/373439/" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technology" class="dropdown-title"><a href="/Technology/" class="link-title">Technology</a> <span class="title" style="display:none;">Technology</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3b6841/" class="nav-link">DB</a></li><li class="dropdown-item"><!----> <a href="/pages/d7857e/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b89362/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/ec8b81/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/pages/4e3ff1/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/a75fef/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/pages/b194d7/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/pages/371f2f/" class="nav-link">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/027aa3/" class="nav-link">Workflow</a></li><li class="dropdown-item"><!----> <a href="/pages/73ab4b/" class="nav-link">OAuth2</a></li><li class="dropdown-item"><!----> <a href="/pages/d7a38a/" class="nav-link">JPA</a></li><li class="dropdown-item"><!----> <a href="/pages/eb5dc1/" class="nav-link">Liquibase</a></li><li class="dropdown-item"><!----> <a href="/pages/e54277/" class="nav-link">Lombok</a></li><li class="dropdown-item"><!----> <a href="/pages/62e4f6/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/13c836/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/b50b3d/" class="nav-link">Mini Program</a></li><li class="dropdown-item"><!----> <a href="/pages/09d3b8/" class="nav-link">JVM</a></li><li class="dropdown-item"><!----> <a href="/pages/a526c7/" class="nav-link">Log</a></li><li class="dropdown-item"><!----> <a href="/pages/59cf4f/" class="nav-link">JDK</a></li><li class="dropdown-item"><!----> <a href="/pages/d50dab/" class="nav-link">Thymeleaf</a></li><li class="dropdown-item"><!----> <a href="/pages/97abaa/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/7879f1/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/745b7c/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/pages/274dac/" class="nav-link">Raspberrypi</a></li><li class="dropdown-item"><!----> <a href="/pages/87c097/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/pages/927664/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/2c3f19/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><a href="/Other/" class="link-title">Other</a> <span class="title" style="display:none;">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fea344/" class="nav-link">Book</a></li><li class="dropdown-item"><!----> <a href="/pages/d62f72/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/f3d338/" class="nav-link">问题</a></li><li class="dropdown-item"><!----> <a href="/pages/ff202b/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/pages/2b746e/" class="nav-link">证券</a></li></ul></div></div><div class="nav-item"><a href="/About/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Index" class="dropdown-title"><a href="/archives/" class="link-title">Index</a> <span class="title" style="display:none;">Index</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/touxiang-lanse.png"> <div class="blogger-info"><h3>wen chao</h3> <span>持之以恒做正确有价值的事!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Algorithm" class="dropdown-title"><a href="/Algorithm/" class="link-title">Algorithm</a> <span class="title" style="display:none;">Algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d8e764/" class="nav-link">Theory</a></li><li class="dropdown-item"><!----> <a href="/pages/81a4bd/" class="nav-link">LeetCode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/Spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/373439/" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technology" class="dropdown-title"><a href="/Technology/" class="link-title">Technology</a> <span class="title" style="display:none;">Technology</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3b6841/" class="nav-link">DB</a></li><li class="dropdown-item"><!----> <a href="/pages/d7857e/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b89362/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/ec8b81/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/pages/4e3ff1/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/a75fef/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/pages/b194d7/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/pages/371f2f/" class="nav-link">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/027aa3/" class="nav-link">Workflow</a></li><li class="dropdown-item"><!----> <a href="/pages/73ab4b/" class="nav-link">OAuth2</a></li><li class="dropdown-item"><!----> <a href="/pages/d7a38a/" class="nav-link">JPA</a></li><li class="dropdown-item"><!----> <a href="/pages/eb5dc1/" class="nav-link">Liquibase</a></li><li class="dropdown-item"><!----> <a href="/pages/e54277/" class="nav-link">Lombok</a></li><li class="dropdown-item"><!----> <a href="/pages/62e4f6/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/13c836/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/b50b3d/" class="nav-link">Mini Program</a></li><li class="dropdown-item"><!----> <a href="/pages/09d3b8/" class="nav-link">JVM</a></li><li class="dropdown-item"><!----> <a href="/pages/a526c7/" class="nav-link">Log</a></li><li class="dropdown-item"><!----> <a href="/pages/59cf4f/" class="nav-link">JDK</a></li><li class="dropdown-item"><!----> <a href="/pages/d50dab/" class="nav-link">Thymeleaf</a></li><li class="dropdown-item"><!----> <a href="/pages/97abaa/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/7879f1/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/745b7c/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/pages/274dac/" class="nav-link">Raspberrypi</a></li><li class="dropdown-item"><!----> <a href="/pages/87c097/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/pages/927664/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/2c3f19/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><a href="/Other/" class="link-title">Other</a> <span class="title" style="display:none;">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fea344/" class="nav-link">Book</a></li><li class="dropdown-item"><!----> <a href="/pages/d62f72/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/f3d338/" class="nav-link">问题</a></li><li class="dropdown-item"><!----> <a href="/pages/ff202b/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/pages/2b746e/" class="nav-link">证券</a></li></ul></div></div><div class="nav-item"><a href="/About/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Index" class="dropdown-title"><a href="/archives/" class="link-title">Index</a> <span class="title" style="display:none;">Index</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Zookeeper</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Dubbo</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ElasticSearch</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/371f2f/" class="sidebar-link">ElasticSearch指南</a></li><li><a href="/pages/0f5882/" aria-current="page" class="active sidebar-link">ElasticSearch原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/0f5882/#一-elasticsearch架构原理" class="sidebar-link">一.Elasticsearch架构原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_1、elasticsearch的节点类型" class="sidebar-link">1、Elasticsearch的节点类型</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/0f5882/#三-elasticsearch重要工作流程" class="sidebar-link">三.Elasticsearch重要工作流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-1-elasticsearch文档写入原理" class="sidebar-link">3.1  Elasticsearch文档写入原理</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-2-elasticsearch检索原理" class="sidebar-link">3.2  Elasticsearch检索原理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/0f5882/#四-elasticsearch准实时索引实现" class="sidebar-link">四.Elasticsearch准实时索引实现</a></li><li class="sidebar-sub-header level2"><a href="/pages/0f5882/#六-经验分享" class="sidebar-link">六.经验分享</a></li><li class="sidebar-sub-header level2"><a href="/pages/0f5882/#" class="sidebar-link"></a></li><li class="sidebar-sub-header level2"><a href="/pages/0f5882/#master选举" class="sidebar-link">master选举</a></li><li class="sidebar-sub-header level2"><a href="/pages/0f5882/#附录" class="sidebar-link">附录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#cat命令" class="sidebar-link">Cat命令</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/0f5882/#第三节-elasticsearch原理" class="sidebar-link">第三节 ElasticSearch原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-1-解析es的分布式架构" class="sidebar-link">3.1 解析es的分布式架构</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_3-1-1-分布式架构的透明隐藏特性" class="sidebar-link">3.1.1 分布式架构的透明隐藏特性</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_3-1-2-扩容机制" class="sidebar-link">3.1.2 扩容机制</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_3-1-3-rebalance" class="sidebar-link">3.1.3 rebalance</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_3-1-4-master节点" class="sidebar-link">3.1.4 master节点</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_3-1-5-节点对等" class="sidebar-link">3.1.5 节点对等</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-2-分片和副本机制" class="sidebar-link">3.2 分片和副本机制</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-3-单节点环境下创建索引分析" class="sidebar-link">3.3 单节点环境下创建索引分析</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-4-两个节点环境下创建索引分析" class="sidebar-link">3.4 两个节点环境下创建索引分析</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-5-水平扩容的过程" class="sidebar-link">3.5 水平扩容的过程</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-6elasticsearch的容错机制" class="sidebar-link">3.6ElasticSearch的容错机制</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-7文档的核心元数据" class="sidebar-link">3.7文档的核心元数据</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-8-文档id生成方式" class="sidebar-link">3.8 文档id生成方式</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-9-source元数据分析" class="sidebar-link">3.9 _source元数据分析</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-10-改变文档内容原理解析" class="sidebar-link">3.10 改变文档内容原理解析</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-11-基于groovy脚本执行partial-update" class="sidebar-link">3.11 基于groovy脚本执行partial update</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-12-partial-update-处理并发冲突" class="sidebar-link">3.12 partial update 处理并发冲突</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-13-文档数据路由原理解析" class="sidebar-link">3.13 文档数据路由原理解析</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-14-文档增删改内部原理" class="sidebar-link">3.14 文档增删改内部原理</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-15-写一致性原理和quorum机制" class="sidebar-link">3.15 写一致性原理和quorum机制</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-16-文档查询内部原理" class="sidebar-link">3.16 文档查询内部原理</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-17-bulk批量操作的json格式解析" class="sidebar-link">3.17 bulk批量操作的json格式解析</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-18-查询结果分析" class="sidebar-link">3.18 查询结果分析</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-19-多index-多type查询模式" class="sidebar-link">3.19 多index，多type查询模式</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-20-分页查询中的deep-paging问题" class="sidebar-link">3.20 分页查询中的deep paging问题</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-21-query-string查询及copy-to解析" class="sidebar-link">3.21 query string查询及copy_to解析</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-22字符串排序问题" class="sidebar-link">3.22字符串排序问题</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-23-如何计算相关度分数" class="sidebar-link">3.23 如何计算相关度分数</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-24-doc-values-解析" class="sidebar-link">3.24 Doc Values 解析</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-25-基于scroll技术滚动搜索大量数据" class="sidebar-link">3.25 基于scroll技术滚动搜索大量数据</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-26-dynamic-mapping策略" class="sidebar-link">3.26 dynamic mapping策略</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-27重建索引" class="sidebar-link">3.27重建索引</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3-28-索引不可变的原因" class="sidebar-link">3.28 索引不可变的原因</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/0f5882/#elasticsearch分布式原理" class="sidebar-link">Elasticsearch分布式原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_1、单机服务有哪些问题" class="sidebar-link">1、单机服务有哪些问题</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_2、分布式的好处" class="sidebar-link">2、分布式的好处</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_3、集群环境选择" class="sidebar-link">3、集群环境选择</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#核心配置" class="sidebar-link">核心配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#可执行以下命令启动一个9节点集群" class="sidebar-link">可执行以下命令启动一个9节点集群</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#开发模式和生产模式" class="sidebar-link">开发模式和生产模式</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#单节点模式" class="sidebar-link">单节点模式</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#引导检查-bootstrap-checks" class="sidebar-link">引导检查—Bootstrap Checks</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_4、主从模式" class="sidebar-link">4、主从模式</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_5、节点" class="sidebar-link">5、节点</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#候选节点-投票节点-master-eligible-有时候也叫master节点" class="sidebar-link">候选节点/投票节点（master-eligible，有时候也叫master节点）</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#仅投票节点" class="sidebar-link">仅投票节点</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#主节点-active-master" class="sidebar-link">主节点（active master）</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#数据节点" class="sidebar-link">数据节点</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#协调节点" class="sidebar-link">协调节点</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_6、es常见模块-mudules" class="sidebar-link">6、ES常见模块：Mudules</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#cluster" class="sidebar-link">Cluster</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#allocation" class="sidebar-link">Allocation</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#bootstrap" class="sidebar-link">Bootstrap</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#ingest" class="sidebar-link">Ingest</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#monitor" class="sidebar-link">Monitor</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#discovery" class="sidebar-link">Discovery</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#gateway" class="sidebar-link">Gateway</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#indices" class="sidebar-link">Indices</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#http" class="sidebar-link">HTTP</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#transport" class="sidebar-link">Transport</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_7、分片-shard" class="sidebar-link">7、分片：Shard</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_7-1-分片创建策略" class="sidebar-link">7.1 分片创建策略</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_7-1-1-分片分配策略" class="sidebar-link">7.1.1 分片分配策略</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_7-1-2-分片的数量" class="sidebar-link">7.1.2 分片的数量</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_7-1-3-分片的大小决策" class="sidebar-link">7.1.3 分片的大小决策</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_7-2-重要的配置" class="sidebar-link">7.2 重要的配置</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_7-2-1-自定义属性" class="sidebar-link">7.2.1 自定义属性</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_7-2-2-索引级配置" class="sidebar-link">7.2.2 索引级配置</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_7-2-3-集群级配置" class="sidebar-link">7.2.3 集群级配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_7-3-索引分片分配-index-shard-allocation" class="sidebar-link">7.3 索引分片分配：Index Shard Allocation</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_7-2-1-分片均衡策略-shard-rebalance" class="sidebar-link">7.2.1 分片均衡策略：shard rebalance</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_7-2-2-延迟分配策略-默认1m" class="sidebar-link">7.2.2 延迟分配策略（默认1m）：</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_7-2-3-分片过滤-即-shard-allocation-filtering-控制那个分片分配给哪个节点。" class="sidebar-link">7.2.3 分片过滤：即（Shard allocation filtering），控制那个分片分配给哪个节点。</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_7-4-分片分配感知-shard-allocation-awareness" class="sidebar-link">7.4 分片分配感知：Shard Allocation Awareness</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_7-4-1-启用分片感知策略" class="sidebar-link">7.4.1 启用分片感知策略</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_7-5-强制感知策略-forced-awareness" class="sidebar-link">7.5 强制感知策略：Forced awareness</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_7-5-1-部署强制感知策略" class="sidebar-link">7.5.1 部署强制感知策略</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_8、高可用性-★★★" class="sidebar-link">8、高可用性 ★★★</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_8-1-高可用性原理" class="sidebar-link">8.1 高可用性原理</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_8-2-es的容灾机制" class="sidebar-link">8.2 ES的容灾机制</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_8-3-master节点和投票节点" class="sidebar-link">8.3  Master节点和投票节点</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_8-3-1-主节点职责" class="sidebar-link">8.3.1 主节点职责</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_8-3-2-如何设置dedicated-master" class="sidebar-link">8.3.2 如何设置dedicated master</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_8-3-3-投票节点" class="sidebar-link">8.3.3 投票节点</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_8-3-4-如何配置仅投票节点" class="sidebar-link">8.3.4 如何配置仅投票节点</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_8-4-高可用性集群" class="sidebar-link">8.4 高可用性集群：</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_8-4-1-小规模集群" class="sidebar-link">8.4.1 小规模集群</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_8-4-2-大规模集群" class="sidebar-link">8.4.2 大规模集群</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_8-4-3-总结" class="sidebar-link">8.4.3 总结</a></li><li class="sidebar-sub-header level3"><a href="/pages/0f5882/#_9、master选举-★★★★" class="sidebar-link">9、Master选举 ★★★★</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_9-1-设计思路" class="sidebar-link">9.1 设计思路</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_9-2-es的选举算法" class="sidebar-link">9.2 ES的选举算法</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_9-3-几个重要概念" class="sidebar-link">9.3 几个重要概念</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_9-3-1-候选节点与投票节点" class="sidebar-link">9.3.1 候选节点与投票节点</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_9-3-2-有效选票与法定票数" class="sidebar-link">9.3.2 有效选票与法定票数</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_9-4-选举过程" class="sidebar-link">9.4 选举过程</a></li><li class="sidebar-sub-header level5"><a href="/pages/0f5882/#_9-4-1-节点失效监测-faultdetection类" class="sidebar-link">9.4.1 节点失效监测：FaultDetection类</a></li><li class="sidebar-sub-header level4"><a href="/pages/0f5882/#_9-5-脑裂问题" class="sidebar-link">9.5 脑裂问题：</a></li></ul></li></ul></li><li><a href="/pages/036417/" class="sidebar-link">ElasticSearch查询</a></li><li><a href="/pages/f2c921/" class="sidebar-link">ElasticSearch文档分值_score计算底层原理</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Workflow</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OAuth2</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JPA</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Liquibase</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Lombok</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Log</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JDK</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Thymeleaf</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Maven</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mybatis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Raspberrypi</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/Technology/#Technology" data-v-06225672>Technology</a></li><li data-v-06225672><a href="/Technology/#ElasticSearch" data-v-06225672>ElasticSearch</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/nylg" target="_blank" title="作者" class="beLink" data-v-06225672>wenchao</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2021-09-08</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">ElasticSearch原理<!----></h1>  <div class="theme-vdoing-content content__default"><p><strong>回顾：</strong></p> <p><strong>1、通过term 和 match查询数据时细节点以及数据类型keyword与text区别</strong></p> <p><strong>1.1 term查询</strong></p> <p>1.1.1 term查询keyword字段。</p> <p>term不会分词。而keyword字段也不分词。需要完全匹配才可。</p> <p>​</p> <p>hello world  ===  hello       world</p> <p>hello world</p> <p>1.1.2 term查询text字段。</p> <p>因为text字段会分词，而term不分词，所以term查询的条件必须是text字段分词后的某一个。</p> <p><strong>1.2.match查询</strong></p> <p>1.2.1 match查询keyword字段</p> <p>match会被分词，而keyword不会被分词，match的需要跟keyword的完全匹配可以。</p> <p>1.2.2 match查询text字段</p> <p>match分词，text也分词，只要match的分词结果和text的分词结果有相同的就匹配。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /es_db_test
{
&quot;mappings&quot;:{
&quot;properties&quot;:{
&quot;name&quot;:{&quot;type&quot;:&quot;keyword&quot;,&quot;index&quot;:true,&quot;store&quot;:true},
&quot;sex&quot;:{&quot;type&quot;:&quot;integer&quot;,&quot;index&quot;:true,&quot;store&quot;:true},
&quot;age&quot;:{&quot;type&quot;:&quot;integer&quot;,&quot;index&quot;:true,&quot;store&quot;:true},
&quot;book&quot;:{&quot;type&quot;:&quot;text&quot;,&quot;index&quot;:true,&quot;store&quot;:true},
&quot;address&quot;:{&quot;type&quot;:&quot;keyword&quot;,&quot;index&quot;:true,&quot;store&quot;:true}
}
}
}


PUT /es_db_test/_doc/1
{
&quot;name&quot;: &quot;Jack&quot;,
&quot;sex&quot;: 1,
&quot;age&quot;: 25,
&quot;book&quot;: &quot;elasticSearch入门至精通&quot;,
&quot;address&quot;: &quot;广州车陂&quot;
}


POST /es_db_test/_doc/_search
{
&quot;query&quot;: {
&quot;term&quot;: {
&quot;address&quot;: &quot;广州车陂&quot;
}
}
}

POST /es_db_test/_doc/_search
{
&quot;query&quot;: {
&quot;match&quot;: {
&quot;address&quot;: &quot;广州车陂&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>**2、**<strong>乐观锁并发控制 if_seq_no 和 if_primary_term意义</strong></p> <p><strong>if_seq_no 和 if_primary_term 是用来并发控制，他们和version不同，version属于当个文档，而seq_no属于整个index。</strong></p> <p>_primary_term表示文档所在主分片的编号</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db_tem/_doc/1

DELETE /es_db_tem/_doc/1


PUT /es_db_tem/_doc/1
{
  &quot;name&quot;: &quot;Jack&quot;,
  &quot;sex&quot;: 1,
  &quot;age&quot;: 25,
  &quot;book&quot;: &quot;elasticSearch入门至精通&quot;,
  &quot;address&quot;: &quot;广州车陂&quot;
}
PUT /es_db_tem/_doc/2
{
  &quot;name&quot;: &quot;Jack&quot;,
  &quot;sex&quot;: 1,
  &quot;age&quot;: 25,
  &quot;book&quot;: &quot;elasticSearch入门至精通&quot;,
  &quot;address&quot;: &quot;广州车陂&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>_primary_term：_primary_term也和_seq_no一样都是整数，每当Primary Shard发生重新分配时，比如重启，Primary选举等，_primary_term会递增1。</strong></p> <p>_primary_term主要是用来恢复数据时处理当多个文档的_seq_no一样时的冲突，比如当一个shard宕机了，raplica需要用到最新的数据，就会根据_primary_term和_seq_no这两个值来拿到最新的document</p> <p><strong>3、对已存在的mapping映射进行修改</strong></p> <p>具体方法</p> <p>1）如果要推倒现有的映射, 你得重新建立一个静态索引</p> <p>2）然后把之前索引里的数据导入到新的索引里</p> <p>3）删除原创建的索引</p> <p>4）为新索引起个别名, 为原索引名</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DELETE /myes_db       
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /myes_db     
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /myes_db/_doc/1
{
&quot;name&quot;: &quot;Jack&quot;,
&quot;sex&quot;: 1,
&quot;age&quot;: 25,
&quot;book&quot;: &quot;java入门至精通&quot;,
&quot;address&quot;: &quot;广州小蛮腰&quot;
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>​</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /myes_db/_mapping           
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /myes_db2
{
&quot;mappings&quot;:{
&quot;properties&quot;:{
&quot;name&quot;:{&quot;type&quot;:&quot;keyword&quot;,&quot;index&quot;:true,&quot;store&quot;:true},
&quot;sex&quot;:{&quot;type&quot;:&quot;integer&quot;,&quot;index&quot;:true,&quot;store&quot;:true},
&quot;age&quot;:{&quot;type&quot;:&quot;integer&quot;,&quot;index&quot;:true,&quot;store&quot;:true},
&quot;book&quot;:{&quot;type&quot;:&quot;text&quot;,&quot;index&quot;:true,&quot;store&quot;:true},
&quot;address&quot;:{&quot;type&quot;:&quot;text&quot;,&quot;index&quot;:true,&quot;store&quot;:true}
}
}
}				
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>POST _reindex
{
&quot;source&quot;: {
&quot;index&quot;: &quot;myes_db&quot;
},
&quot;dest&quot;: {
&quot;index&quot;: &quot;myes_db2&quot;
}
}

DELETE /myes_db

PUT /myes_db2/_alias/myes_db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="一-elasticsearch架构原理"><a href="#一-elasticsearch架构原理" class="header-anchor">#</a> 一.Elasticsearch架构原理</h2> <h3 id="_1、elasticsearch的节点类型"><a href="#_1、elasticsearch的节点类型" class="header-anchor">#</a> 1、Elasticsearch的节点类型</h3> <p>在Elasticsearch主要分成两类节点，一类是Master，一类是DataNode。</p> <p><strong>1.1  Master节点</strong></p> <p>在Elasticsearch启动时，会选举出来一个Master节点。当某个节点启动后，然后使用Zen Discovery机制找到集群中的其他节点，并建立连接。</p> <p>discovery.seed_hosts: [&quot;192.168.21.130&quot;, &quot;192.168.21.131&quot;, &quot;192.168.21.132&quot;]</p> <p>并从候选主节点中选举出一个主节点。</p> <p>cluster.initial_master_nodes: [&quot;node1&quot;, &quot;node2&quot;,&quot;node3&quot;]</p> <p>Master节点主要负责：</p> <p>管理索引（创建索引、删除索引）、分配分片</p> <p>维护元数据</p> <p>管理集群节点状态</p> <p>不负责数据写入和查询，比较轻量级</p> <p>一个Elasticsearch集群中，只有一个Master节点。在生产环境中，内存可以相对小一点，但机器要稳定。</p> <p><strong>1.2  DataNode节点</strong></p> <p>在Elasticsearch集群中，会有N个DataNode节点。DataNode节点主要负责：</p> <p>数据写入、数据检索，大部分Elasticsearch的压力都在DataNode节点上</p> <p>在生产环境中，内存最好配置大一些</p> <p><strong>二 、分片和副本机制</strong></p> <p><strong>2.1  分片（Shard）</strong></p> <p><strong>Elasticsearch是一个分布式的搜索引擎，索引的数据也是分成若干部分，分布在不同的服务器节点中</strong></p> <p>分布在不同服务器节点中的索引数据，就是分片（Shard）。Elasticsearch会自动管理分片，如果发现分片分布不均衡，就会自动迁移</p> <p>一个索引（index）由多个shard（分片）组成，而分片是分布在不同的服务器上的</p> <p><strong>2.2  副本</strong></p> <p>为了对Elasticsearch的分片进行容错，假设某个节点不可用，会导致整个索引库都将不可用。所以，需要对分片进行副本容错。每一个分片都会有对应的副本。</p> <p>在Elasticsearch中，默认创建的索引为1个分片、每个分片有1个主分片和1个副本分片。</p> <p>每个分片都会有一个Primary Shard（主分片），也会有若干个Replica Shard（副本分片）</p> <p>Primary Shard和Replica Shard不在同一个节点上</p> <p><strong>2.3  指定分片、副本数量</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 创建指定分片数量、副本数量的索引
PUT /job_idx_shard_temp
{
&quot;mappings&quot;:{
&quot;properties&quot;:{
&quot;id&quot;:{&quot;type&quot;:&quot;long&quot;,&quot;store&quot;:true},
&quot;area&quot;:{&quot;type&quot;:&quot;keyword&quot;,&quot;store&quot;:true},
&quot;exp&quot;:{&quot;type&quot;:&quot;keyword&quot;,&quot;store&quot;:true},
&quot;edu&quot;:{&quot;type&quot;:&quot;keyword&quot;,&quot;store&quot;:true},
&quot;salary&quot;:{&quot;type&quot;:&quot;keyword&quot;,&quot;store&quot;:true},
&quot;job_type&quot;:{&quot;type&quot;:&quot;keyword&quot;,&quot;store&quot;:true},
&quot;cmp&quot;:{&quot;type&quot;:&quot;keyword&quot;,&quot;store&quot;:true},
&quot;pv&quot;:{&quot;type&quot;:&quot;keyword&quot;,&quot;store&quot;:true},
&quot;title&quot;:{&quot;type&quot;:&quot;text&quot;,&quot;store&quot;:true},
&quot;jd&quot;:{&quot;type&quot;:&quot;text&quot;}

}
},
&quot;settings&quot;:{
&quot;number_of_shards&quot;:3,
&quot;number_of_replicas&quot;:2
}
}

// 查看分片、主分片、副本分片
GET /_cat/indices?v
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>​</p> <h2 id="三-elasticsearch重要工作流程"><a href="#三-elasticsearch重要工作流程" class="header-anchor">#</a> 三.Elasticsearch重要工作流程</h2> <h3 id="_3-1-elasticsearch文档写入原理"><a href="#_3-1-elasticsearch文档写入原理" class="header-anchor">#</a> 3.1  Elasticsearch文档写入原理</h3> <p>​    <img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/es/31.jpg" alt=""></p> <p>1.选择任意一个DataNode发送请求，例如：node2。此时，node2就成为一个coordinating node（协调节点）</p> <p>2.计算得到文档要写入的分片</p> <p><code>shard = hash(routing) % number_of_primary_shards</code></p> <p>routing 是一个可变值，默认是文档的 _id</p> <p>3.coordinating node会进行路由，将请求转发给对应的primary shard所在的DataNode（假设primary shard在node1、replica shard在node2）</p> <p>4.node1节点上的Primary Shard处理请求，写入数据到索引库中，并将数据同步到Replica shard</p> <p>5.Primary Shard和Replica Shard都保存好了文档，返回client</p> <h3 id="_3-2-elasticsearch检索原理"><a href="#_3-2-elasticsearch检索原理" class="header-anchor">#</a> 3.2  Elasticsearch检索原理</h3> <p>​    <img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/es/32.jpg" alt=""></p> <p>client发起查询请求，某个DataNode接收到请求，该DataNode就会成为协调节点（Coordinating Node）</p> <p>协调节点（Coordinating Node）将查询请求广播到每一个数据节点，这些数据节点的分片会处理该查询请求</p> <p>每个分片进行数据查询，将符合条件的数据放在一个优先队列中，并将这些数据的文档ID、节点信息、分片信息返回给协调节点</p> <p>协调节点将所有的结果进行汇总，并进行全局排序</p> <p>协调节点向包含这些文档ID的分片发送get请求，对应的分片将文档数据返回给协调节点，最后协调节点将数据返回给客户端</p> <h2 id="四-elasticsearch准实时索引实现"><a href="#四-elasticsearch准实时索引实现" class="header-anchor">#</a> 四.Elasticsearch准实时索引实现</h2> <p><strong>4.1  溢写到文件系统缓存</strong></p> <p>当数据写入到ES分片时，会首先写入到内存中，然后通过内存的buffer生成一个segment，并刷到<strong>文件系统缓存</strong>中，数据可以被检索（注意不是直接刷到磁盘）</p> <p>ES中默认1秒，refresh一次</p> <p><strong>4.2  写translog保障容错</strong></p> <p>在写入到内存中的同时，也会记录translog日志，在refresh期间出现异常，会根据translog来进行数据恢复</p> <p>等到文件系统缓存中的segment数据都刷到磁盘中，清空translog文件</p> <p><strong>4.3  flush到磁盘</strong></p> <p>ES默认每隔30分钟会将文件系统缓存的数据刷入到磁盘</p> <p><strong>4.4  segment合并</strong></p> <p>Segment太多时，ES定期会将多个segment合并成为大的segment，减少索引查询时IO开销，此阶段ES会真正的物理删除（之前执行过的delete的数据）</p> <p>​    <img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/es/33.png" alt=""></p> <p><strong>五.手工控制搜索结果精准度</strong></p> <p>5.1、下述搜索中，如果document中的remark字段包含java或developer词组，都符合搜索条件。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_search
{
&quot;query&quot;: {
&quot;match&quot;: {
&quot;remark&quot;: &quot;java developer&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果需要搜索的document中的remark字段，包含java和developer词组，则需要使用下述语法：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_search
{
&quot;query&quot;: {
&quot;match&quot;: {
&quot;remark&quot;: {
&quot;query&quot;: &quot;java developer&quot;,
&quot;operator&quot;: &quot;and&quot;
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>​</p> <p>上述语法中，如果将operator的值改为or。则与第一个案例搜索语法效果一致。默认的ES执行搜索的时候，operator就是or。</p> <p>如果在搜索的结果document中，需要remark字段中包含多个搜索词条中的一定比例，可以使用下述语法实现搜索。其中minimum_should_match可以使用百分比或固定数字。百分比代表query搜索条件中词条百分比，如果无法整除，向下匹配（如，query条件有3个单词，如果使用百分比提供精准度计算，那么是无法除尽的，如果需要至少匹配两个单词，则需要用67%来进行描述。如果使用66%描述，ES则认为匹配一个单词即可。）。固定数字代表query搜索条件中的词条，至少需要匹配多少个。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_search
{
&quot;query&quot;: {
&quot;match&quot;: {
&quot;remark&quot;: {
&quot;query&quot;: &quot;java architect assistant&quot;,
&quot;minimum_should_match&quot;: &quot;68%&quot;
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>​</p> <p>如果使用should+bool搜索的话，也可以控制搜索条件的匹配度。具体如下：下述案例代表搜索的document中的remark字段中，必须匹配java、developer、assistant三个词条中的至少2个。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_search
{
&quot;query&quot;: {
&quot;bool&quot;: {
&quot;should&quot;: [
{ 
&quot;match&quot;: {
&quot;remark&quot;: &quot;java&quot;
} 
},
{
&quot;match&quot;: {
&quot;remark&quot;: &quot;developer&quot;
}
},
{
&quot;match&quot;: {
&quot;remark&quot;: &quot;assistant&quot;
}
}
],
&quot;minimum_should_match&quot;: 2
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>​</p> <p><strong>5.2、match 的底层转换</strong></p> <p>其实在ES中，执行match搜索的时候，ES底层通常都会对搜索条件进行底层转换，来实现最终的搜索结果。如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_search
{
&quot;query&quot;: {
&quot;match&quot;: {
&quot;remark&quot;: &quot;java developer&quot;
}
}
}

转换后是：
GET /es_db/_search
{
&quot;query&quot;: {
&quot;bool&quot;: {
&quot;should&quot;: [
{
&quot;term&quot;: {
&quot;remark&quot;: &quot;java&quot;
}
},
{
&quot;term&quot;: {
&quot;remark&quot;: {
&quot;value&quot;: &quot;developer&quot;
}
}
}
]
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_search
{
&quot;query&quot;: {
&quot;match&quot;: {
&quot;remark&quot;: {
&quot;query&quot;: &quot;java developer&quot;,
&quot;operator&quot;: &quot;and&quot;
}
}
}
}

转换后是：
GET /es_db/_search
{
&quot;query&quot;: {
&quot;bool&quot;: {
&quot;must&quot;: [
{
&quot;term&quot;: {
&quot;remark&quot;: &quot;java&quot;
}
},
{
&quot;term&quot;: {
&quot;remark&quot;: {
&quot;value&quot;: &quot;developer&quot;
}
}
}
]
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_search
{
&quot;query&quot;: {
&quot;match&quot;: {
&quot;remark&quot;: {
&quot;query&quot;: &quot;java architect assistant&quot;,
&quot;minimum_should_match&quot;: &quot;68%&quot;
}
}
}
}

转换后为：
GET /es_db/_search
{
&quot;query&quot;: {
&quot;bool&quot;: {
&quot;should&quot;: [
{
&quot;term&quot;: {
&quot;remark&quot;: &quot;java&quot;
}
},
{
&quot;term&quot;: {
&quot;remark&quot;: &quot;architect&quot;
}
},
{
&quot;term&quot;: {
&quot;remark&quot;: &quot;assistant&quot;
}
}
],
&quot;minimum_should_match&quot;: 2
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>​</p> <p>建议，如果不怕麻烦，尽量使用转换后的语法执行搜索，效率更高。</p> <p>如果开发周期短，工作量大，使用简化的写法。</p> <p><strong>5.3、boost权重控制</strong></p> <p>搜索document中remark字段中包含java的数据，如果remark中包含developer或architect，则包含architect的document优先显示。（就是将architect数据匹配时的相关度分数增加）。</p> <p>一般用于搜索时相关度排序使用。如：电商中的综合排序。将一个商品的销量，广告投放，评价值，库存，单价比较综合排序。在上述的排序元素中，广告投放权重最高，库存权重最低。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_search
{
&quot;query&quot;: {
&quot;bool&quot;: {
&quot;must&quot;: [
{
&quot;match&quot;: {
&quot;remark&quot;: &quot;java&quot;
}
}
],
&quot;should&quot;: [
{
&quot;match&quot;: {
&quot;remark&quot;: {
&quot;query&quot;: &quot;developer&quot;,
&quot;boost&quot; : 1
}
}
},
{
&quot;match&quot;: {
&quot;remark&quot;: {
&quot;query&quot;: &quot;architect&quot;,
&quot;boost&quot; : 3
}
}
}
]
}
}
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><strong>5.4、基于dis_max实现best fields策略进行多字段搜索</strong></p> <p>best fields策略： 搜索的document中的某一个field，尽可能多的匹配搜索条件。与之相反的是，尽可能多的字段匹配到搜索条件（most fields策略）。如百度搜索使用这种策略。</p> <p><strong>优点：精确匹配的数据可以尽可能的排列在最前端，且可以通过minimum_should_match来去除长尾数据，避免长尾数据字段对排序结果的影响。</strong></p> <p>​              长尾数据比如说我们搜索4个关键词，但很多文档只匹配1个，也显示出来了，这些文档其实不是我们想要的</p> <p><strong>缺点：相对排序不均匀。</strong></p> <p><strong>dis_max语法： 直接获取搜索的多条件中的，单条件query相关度分数最高的数据，以这个数据做相关度排序。</strong></p> <p>下述的案例中，就是找name字段中rod匹配相关度分数或remark字段中java developer匹配相关度分数，哪个高，就使用哪一个相关度分数进行结果排序。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_search
{
&quot;query&quot;: {
&quot;dis_max&quot;: {
&quot;queries&quot;: [
{
&quot;match&quot;: {
&quot;name&quot;: &quot;rod&quot;
}
},
{
&quot;match&quot;: {
&quot;remark&quot;: &quot;java developer&quot;
}
}
]
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>​</p> <p><strong>5.5、基于tie_breaker参数优化dis_max搜索效果</strong></p> <p>dis_max是将多个搜索query条件中相关度分数最高的用于结果排序，忽略其他query分数，在某些情况下，可能还需要其他query条件中的相关度介入最终的结果排序，这个时候可以使用tie_breaker参数来优化dis_max搜索。tie_breaker参数代表的含义是：将其他query搜索条件的相关度分数乘以参数值，再参与到结果排序中。如果不定义此参数，相当于参数值为0。所以其他query条件的相关度分数被忽略。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_search
{
&quot;query&quot;: {
&quot;dis_max&quot;: {
&quot;queries&quot;: [
{
&quot;match&quot;: {
&quot;name&quot;: &quot;rod&quot;
}
},
{
&quot;match&quot;: {
&quot;remark&quot;: &quot;java developer&quot;
}
}
],
&quot;tie_breaker&quot;:0.5
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>5.6、使用multi_match简化dis_max+tie_breaker</strong></p> <p>ES中相同结果的搜索也可以使用不同的语法语句来实现。不需要特别关注，只要能够实现搜索，就是完成任务！</p> <p>如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_search
{
&quot;query&quot;: {
&quot;dis_max&quot;: {
&quot;queries&quot;: [
{
&quot;match&quot;: {
&quot;name&quot;: &quot;rod&quot;
}
},
{
&quot;match&quot;: {
&quot;remark&quot;: {
&quot;query&quot;: &quot;java developer&quot;,
&quot;boost&quot; : 2,
&quot;minimum_should_match&quot;: 2
}
}
}
],
&quot;tie_breaker&quot;: 0.5
}
}
}

#使用multi_match语法为：其中type常用的有best_fields和most_fields。^n代表权重，相当于&quot;boost&quot;:n。
GET /es_db/_search
{
&quot;query&quot;: {
&quot;multi_match&quot;: {
&quot;query&quot;: &quot;rod java developer&quot;,
&quot;fields&quot;: [&quot;name&quot;, &quot;remark^2&quot;],
&quot;type&quot;: &quot;best_fields&quot;,
&quot;tie_breaker&quot;: 0.5,
&quot;minimum_should_match&quot; : &quot;50%&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><strong>5.7、cross fields搜索</strong></p> <p>cross fields ： 一个唯一的标识，分部在多个fields中，使用这种唯一标识搜索数据就称为cross fields搜索。如：人名可以分为姓和名，地址可以分为省、市、区县、街道等。那么使用人名或地址来搜索document，就称为cross fields搜索。</p> <p>实现这种搜索，一般都是使用most fields搜索策略。因为这就不是一个field的问题。</p> <p>Cross fields搜索策略，是从多个字段中搜索条件数据。默认情况下，和most fields搜索的逻辑是一致的，计算相关度分数是和best fields策略一致的。一般来说，如果使用cross fields搜索策略，那么都会携带一个额外的参数operator。用来标记搜索条件如何在多个字段中匹配。</p> <p>当然，在ES中也有cross fields搜索策略。具体语法如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_search
{
&quot;query&quot;: {
&quot;multi_match&quot;: {
&quot;query&quot;: &quot;java developer&quot;,
&quot;fields&quot;: [&quot;name&quot;, &quot;remark&quot;],
&quot;type&quot;: &quot;cross_fields&quot;,
&quot;operator&quot; : &quot;and&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>上述语法代表的是，搜索条件中的java必须在name或remark字段中匹配，developer也必须在name或remark字段中匹配。</p> <p><strong>most field策略问题：most fields策略是尽可能匹配更多的字段，所以会导致精确搜索结果排序问题。又因为cross fields搜索，不能使用minimum_should_match来去除长尾数据。</strong></p> <p><strong>所以在使用most fields和cross fields策略搜索数据的时候，都有不同的缺陷。所以商业项目开发中，都推荐使用best fields策略实现搜索。</strong></p> <p><strong>5.8、copy_to组合fields</strong></p> <p>京东中，如果在搜索框中输入“手机”，点击搜索，那么是在商品的类型名称、商品的名称、商品的卖点、商品的描述等字段中，哪一个字段内进行数据的匹配？如果使用某一个字段做搜索不合适，那么使用_all做搜索是否合适？也不合适，因为_all字段中可能包含图片，价格等字段。</p> <p>假设，有一个字段，其中的内容包括(但不限于)：商品类型名称、商品名称、商品卖点等字段的数据内容。是否可以在这个特殊的字段上进行数据搜索匹配？</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;category_name&quot; : &quot;手机&quot;,
  &quot;product_name&quot; : &quot;一加6T手机&quot;,
  &quot;price&quot; : 568800,
  &quot;sell_point&quot; : &quot;国产最好的Android手机&quot;,
  &quot;tags&quot;: [&quot;8G+128G&quot;, &quot;256G可扩展&quot;],
  &quot;color&quot; : &quot;红色&quot;,
  &quot;keyword&quot; : &quot;手机 一加6T手机 国产最好的Android手机&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>copy_to : 就是将多个字段，复制到一个字段中，实现一个多字段组合。copy_to可以解决cross fields搜索问题，在商业项目中，也用于解决搜索条件默认字段问题。</p> <p>如果需要使用copy_to语法，则需要在定义index的时候，手工指定mapping映射策略。</p> <p>copy_to语法：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /es_db/_mapping
{
&quot;properties&quot;: {
&quot;provice&quot; : {
&quot;type&quot;: &quot;text&quot;,
&quot;analyzer&quot;: &quot;standard&quot;,
&quot;copy_to&quot;: &quot;address&quot;
},
&quot;city&quot; : {
&quot;type&quot;: &quot;text&quot;,
&quot;analyzer&quot;: &quot;standard&quot;,
&quot;copy_to&quot;: &quot;address&quot;
},
&quot;street&quot; : {
&quot;type&quot;: &quot;text&quot;,
&quot;analyzer&quot;: &quot;standard&quot;,
&quot;copy_to&quot;: &quot;address&quot;
},
&quot;address&quot; : {
&quot;type&quot;: &quot;text&quot;,
&quot;analyzer&quot;: &quot;standard&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>上述的mapping定义中，是新增了4个字段，分别是provice、city、street、address，其中provice、city、street三个字段的值，会自动复制到address字段中，实现一个字段的组合。那么在搜索地址的时候，就可以在address字段中做条件匹配，从而避免most fields策略导致的问题。在维护数据的时候，不需对address字段特殊的维护。因为address字段是一个组合字段，是由ES自动维护的。类似java代码中的推导属性。在存储的时候，未必存在，但是在逻辑上是一定存在的，因为address是由3个物理存在的属性province、city、street组成的。</p> <p><strong>5.9、近似匹配</strong></p> <p>前文都是精确匹配。如doc中有数据java assistant，那么搜索jave是搜索不到数据的。因为jave单词在doc中是不存在的。</p> <p>如果搜索的语法是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET _search
{
&quot;query&quot; : {
&quot;match&quot; : {
&quot;name&quot; : &quot;jave&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果需要的结果是有特殊要求，如：hello world必须是一个完整的短语，不可分割；或document中的field内，包含的hello和world单词，且两个单词之间离的越近，相关度分数越高。那么这种特殊要求的搜索就是近似搜索。包括hell搜索条件在hello world数据中搜索，包括h搜索提示等都数据近似搜索的一部分。</p> <p>如何上述特殊要求的搜索，使用match搜索语法就无法实现了。</p> <p><strong>5.10、match phrase</strong></p> <p>短语搜索。就是搜索条件不分词。代表搜索条件不可分割。</p> <p>如果hello world是一个不可分割的短语，我们可以使用前文学过的短语搜索match phrase来实现。语法如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET _search
{
&quot;query&quot;: {
&quot;match_phrase&quot;: {
&quot;remark&quot;: &quot;java assistant&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>-1)、 match phrase原理 -- term position</strong></p> <p>ES是如何实现match phrase短语搜索的？其实在ES中，使用match phrase做搜索的时候，也是和match类似，首先对搜索条件进行分词-analyze。将搜索条件拆分成hello和world。既然是分词后再搜索，ES是如何实现短语搜索的？</p> <p>这里涉及到了倒排索引的建立过程。在倒排索引建立的时候，ES会先对document数据进行分词，如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET _analyze
{
&quot;text&quot;: &quot;hello world, java spark&quot;,
&quot;analyzer&quot;: &quot;standard&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>分词的结果是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
&quot;tokens&quot;: [
    {
      &quot;token&quot;: &quot;hello&quot;,
      &quot;start_offset&quot;: 0,
      &quot;end_offset&quot;: 5,
      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,
      &quot;position&quot;: 0
    },
    {
      &quot;token&quot;: &quot;world&quot;,
      &quot;start_offset&quot;: 6,
      &quot;end_offset&quot;: 11,
      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,
      &quot;position&quot;: 1
    },
    {
      &quot;token&quot;: &quot;java&quot;,
      &quot;start_offset&quot;: 13,
      &quot;end_offset&quot;: 17,
      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,
      &quot;position&quot;: 2
    },
    {
      &quot;token&quot;: &quot;spark&quot;,
      &quot;start_offset&quot;: 18,
      &quot;end_offset&quot;: 23,
      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,
      &quot;position&quot;: 3
    }
  ]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>从上述结果中，可以看到。ES在做分词的时候，除了将数据切分外，还会保留一个position。position代表的是这个词在整个数据中的下标。当ES执行match phrase搜索的时候，首先将搜索条件hello world分词为hello和world。然后在倒排索引中检索数据，如果hello和world都在某个document的某个field出现时，那么检查这两个匹配到的单词的position是否是连续的，如果是连续的，代表匹配成功，如果是不连续的，则匹配失败。</p> <p><strong>-2). match phrase搜索参数 -- slop</strong></p> <p>在做搜索操作的是，如果搜索参数是hello spark。而ES中存储的数据是hello world, java spark。那么使用match phrase则无法搜索到。在这个时候，可以使用match来解决这个问题。但是，当我们需要在搜索的结果中，做一个特殊的要求：hello和spark两个单词距离越近，document在结果集合中排序越靠前，这个时候再使用match则未必能得到想要的结果。</p> <p>ES的搜索中，对match phrase提供了参数slop。slop代表match phrase短语搜索的时候，单词最多移动多少次，可以实现数据匹配。在所有匹配结果中，多个单词距离越近，相关度评分越高，排序越靠前。</p> <p>这种使用slop参数的match phrase搜索，就称为近似匹配（proximity search）</p> <p>如：</p> <p>数据为： hello world, java spark</p> <p>搜索为： match phrase : hello spark。</p> <p>slop为： 3  （代表单词最多移动3次。）</p> <p>执行短语搜索的时候，将条件hello spark分词为hello和spark两个单词。并且连续。</p> <p>hello  spark</p> <p>接下来，可以根据slop参数执行单词的移动。</p> <p>下标 ：	0		1		2		3</p> <p>doc  ：	hello	        world	      java		spark</p> <p>搜索 ：     hello	        spark</p> <p>移动1：	hello			      spark</p> <p>移动2：	hello					       spark</p> <p>匹配成功，不需要移动第三次即可匹配。</p> <p>如果：</p> <p>数据为： hello world, java spark</p> <p>搜索为： match phrase : spark hello。</p> <p>slop为： 5  （代表单词最多移动5次。）</p> <p>执行短语搜索的时候，将条件hello spark分词为hello和spark两个单词。并且连续。</p> <p>spark   hello</p> <p>接下来，可以根据slop参数执行单词的移动。</p> <p>下标 ：	0		1		2		3</p> <p>doc  ：	hello	        world	       java	      spark</p> <p>搜索 ：     spark	        hello</p> <p>移动1：			spark/hello</p> <p>移动2：	hello	        spark</p> <p>移动3：	hello			        spark</p> <p>移动4：	hello					      spark</p> <p>匹配成功，不需要移动第五次即可匹配。</p> <p>如果当slop移动次数使用完毕，还没有匹配成功，则无搜索结果。如果使用中文分词，则移动次数更加复杂，因为中文词语有重叠情况，很难计算具体次数，需要多次尝试才行。</p> <p>测试案例：</p> <p>英文：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET _analyze
{
&quot;text&quot;: &quot;hello world, java spark&quot;,
&quot;analyzer&quot;: &quot;standard&quot;
}

POST /test_a/_doc/3
{
&quot;f&quot; : &quot;hello world, java spark&quot;
}

GET /test_a/_search
{
&quot;query&quot;: {
&quot;match_phrase&quot;: {
&quot;f&quot; : {
&quot;query&quot;: &quot;hello spark&quot;,
&quot;slop&quot; : 2
}
}
}
}

GET /test_a/_search
{
&quot;query&quot;: {
&quot;match_phrase&quot;: {
&quot;f&quot; : {
&quot;query&quot;: &quot;spark hello&quot;,
&quot;slop&quot; : 4
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>中文：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET _analyze
{
&quot;text&quot;: &quot;中国，一个世界上最强的国家&quot;,
&quot;analyzer&quot;: &quot;ik_max_word&quot;
}

POST /test_a/_doc/1
{
&quot;f&quot; : &quot;中国，一个世界上最强的国家&quot;
}

GET /test_a/_search
{
&quot;query&quot;: {
&quot;match_phrase&quot;: {
&quot;f&quot; : {
&quot;query&quot;: &quot;中国最强&quot;,
&quot;slop&quot; : 5
}
}
}
}

GET /test_a/_search
{
&quot;query&quot;: {
&quot;match_phrase&quot;: {
&quot;f&quot; : {
&quot;query&quot;: &quot;最强中国&quot;,
&quot;slop&quot; : 9
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>​</p> <p>## 五.版本控制</p> <p><strong>在数据库领域中，有两种方法来确保并发更新，不会丢失数据：</strong></p> <p>1、悲观并发控制</p> <p>这种方法被关系型数据库广泛使用，它假定有变更冲突可能发生，因此阻塞访问资源以防止冲突。 一个典型的例子是读取一行数据之前先将其锁住，确保只有放置锁的线程能够对这行数据进行修改。</p> <p>2、乐观并发控制</p> <p>Elasticsearch 中使用的这种方法假定冲突是不可能发生的，并且不会阻塞正在尝试的操作。 然而，如果源数据在读写当中被修改，更新将会失败。应用程序接下来将决定该如何解决冲突。 例如，可以重试更新、使用新的数据、或者将相关情况报告给用户。</p> <p>3、再以创建一个文档为例    ES老版本</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /db_index/_doc/1
{
&quot;name&quot;: &quot;Jack&quot;,
&quot;sex&quot;: 1,
&quot;age&quot;: 25,
&quot;book&quot;: &quot;Spring Boot 入门到精通&quot;,
&quot;remark&quot;: &quot;hello world&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>​</p> <p>​</p> <p>4、实现_version乐观锁更新文档</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /db_index/_doc/1?version=1
{
&quot;name&quot;: &quot;Jack&quot;,
&quot;sex&quot;: 1,
&quot;age&quot;: 25,
&quot;book&quot;: &quot;Spring Boot 入门到精通&quot;,
&quot;remark&quot;: &quot;hello world&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>​</p> <p>5、ES新版本(7.x)不使用version进行并发版本控制  if_seq_no=版本值&amp;if_primary_term=文档位置</p> <p>_seq_no：文档版本号，作用同_version</p> <p>_primary_term：文档所在位置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST /es_sc/_search

DELETE /es_sc

POST /es_sc/_doc/1
{
&quot;id&quot;: 1,
&quot;name&quot;: &quot;图灵学院&quot;,
&quot;desc&quot;: &quot;图灵学院白起老师&quot;,
&quot;create_date&quot;: &quot;2021-02-24&quot;
}

POST /es_sc/_update/1
{
&quot;doc&quot;: {
&quot;name&quot;: &quot;图灵教育666&quot;
}
}


POST /es_sc/_update/1/?if_seq_no=1&amp;if_primary_term=1
{
&quot;doc&quot;: {
&quot;name&quot;: &quot;图灵学院1&quot;
}    
}

POST /es_sc/_update/1/?if_seq_no=1&amp;if_primary_term=1
{
&quot;doc&quot;: {
&quot;name&quot;: &quot;图灵学院2&quot;
}    
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>​</p> <p>​	ElasticSearch采用了乐观锁来保证数据的一致性，也就是说，当用户对document进行操作时，并不需要对该document作加锁和解锁的操作，只需要指定要操作的版本即可。当版本号一致时，ElasticSearch会允许该操作顺利执行，而当版本号存在冲突时，ElasticSearch会提示冲突并抛出异常（VersionConflictEngineException异常）。</p> <p>ElasticSearch的版本号的取值范围为1到2^63-1。</p> <p>内部版本控制：使用的是_version</p> <p>外部版本控制：elasticsearch在处理外部版本号时会与对内部版本号的处理有些不同。它不再是检查_version是否与请求中指定的数值_相同_,而是检查当前的_version是否比指定的数值小。如果请求成功，那么外部的版本号就会被存储到文档中的_version中。</p> <p>为了保持_version与外部版本控制的数据一致</p> <p>使用version_type=external</p> <h2 id="六-经验分享"><a href="#六-经验分享" class="header-anchor">#</a> 六.经验分享</h2> <p>使用match和proximity search实现召回率和精准度平衡。</p> <p>召回率：召回率就是搜索结果比率，如：索引A中有100个document，搜索时返回多少个document，就是召回率（recall）。</p> <p>精准度：就是搜索结果的准确率，如：搜索条件为hello java，在搜索结果中尽可能让短语匹配和hello java离的近的结果排序靠前，就是精准度（precision）。</p> <p>如果在搜索的时候，只使用match phrase语法，会导致召回率底下，因为搜索结果中必须包含短语（包括proximity search）。</p> <p>如果在搜索的时候，只使用match语法，会导致精准度底下，因为搜索结果排序是根据相关度分数算法计算得到。</p> <p>那么如果需要在结果中兼顾召回率和精准度的时候，就需要将match和proximity search混合使用，来得到搜索结果。</p> <p>测试案例：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST /test_a/_doc/3
{
&quot;f&quot; : &quot;hello, java is very good, spark is also very good&quot;
}

POST /test_a/_doc/4
{
&quot;f&quot; : &quot;java and spark, development language &quot;
}

POST /test_a/_doc/5
{
&quot;f&quot; : &quot;Java Spark is a fast and general-purpose cluster computing system. It provides high-level APIs in Java, Scala, Python and R, and an optimized engine that supports general execution graphs.&quot;
}

POST /test_a/_doc/6
{
&quot;f&quot; : &quot;java spark and, development language &quot;
}

GET /test_a/_search
{
&quot;query&quot;: {
&quot;match&quot;: {
&quot;f&quot;: &quot;java spark&quot;
}
}
}

GET /test_a/_search
{
&quot;query&quot;: {
&quot;bool&quot;: {
&quot;must&quot;: [
{
&quot;match&quot;: {
&quot;f&quot;: &quot;java spark&quot;
}
}
],
&quot;should&quot;: [
{
&quot;match_phrase&quot;: {
&quot;f&quot;: {
&quot;query&quot;: &quot;java spark&quot;,
&quot;slop&quot; : 50
}
}
}
]
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>七、前缀搜索 prefix search</p> <p>使用前缀匹配实现搜索能力。通常针对keyword类型字段，也就是不分词的字段。</p> <p>语法：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /test_a/_search
{
&quot;query&quot;: {
&quot;prefix&quot;: {
&quot;f.keyword&quot;: {
&quot;value&quot;: &quot;J&quot;
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>注意：针对前缀搜索，是对keyword类型字段而言。而keyword类型字段数据大小写敏感。</strong></p> <p>前缀搜索效率比较低。前缀搜索不会计算相关度分数。前缀越短，效率越低。如果使用前缀搜索，建议使用长前缀。因为前缀搜索需要扫描完整的索引内容，所以前缀越长，相对效率越高。</p> <p><strong>八、通配符搜索</strong></p> <p>ES中也有通配符。但是和java还有数据库不太一样。通配符可以在倒排索引中使用，也可以在keyword类型字段中使用。</p> <p>常用通配符：</p> <p>? - 一个任意字符</p> <p>* - 0~n个任意字符</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /test_a/_search
{
&quot;query&quot;: {
&quot;wildcard&quot;: {
&quot;f.keyword&quot;: {
&quot;value&quot;: &quot;?e*o*&quot;
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>性能也很低，也是需要扫描完整的索引。不推荐使用。</p> <p><strong>九、正则搜索</strong></p> <p>ES支持正则表达式。可以在倒排索引或keyword类型字段中使用。</p> <p>常用符号：</p> <p>[] - 范围，如： [0-9]是0~9的范围数字</p> <p>. - 一个字符</p> <p>+ - 前面的表达式可以出现多次。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /test_a/_search
{
&quot;query&quot;: {
&quot;regexp&quot; : {
&quot;f.keyword&quot; : &quot;[A-z].+&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>性能也很低，需要扫描完整索引。</p> <p><strong>十、搜索推荐</strong></p> <p>搜索推荐： search as your type， 搜索提示。如：索引中有若干数据以“hello”开头，那么在输入hello的时候，推荐相关信息。（类似百度输入框）</p> <p>语法：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /test_a/_search
{
&quot;query&quot;: {
&quot;match_phrase_prefix&quot;: {
&quot;f&quot;: {
&quot;query&quot;: &quot;java s&quot;,
&quot;slop&quot; : 10,
&quot;max_expansions&quot;: 10
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>​</p> <p>其原理和match phrase类似，是先使用match匹配term数据（java），然后在指定的slop移动次数范围内，前缀匹配（s），max_expansions是用于指定prefix最多匹配多少个term（单词），超过这个数量就不再匹配了。</p> <p>这种语法的限制是，只有最后一个term会执行前缀搜索。</p> <p>执行性能很差，毕竟最后一个term是需要扫描所有符合slop要求的倒排索引的term。</p> <p>因为效率较低，如果必须使用，则一定要使用参数max_expansions。</p> <p><strong>十一、fuzzy模糊搜索技术</strong></p> <p>搜索的时候，可能搜索条件文本输入错误，如：hello world -&gt; hello word。这种拼写错误还是很常见的。fuzzy技术就是用于解决错误拼写的（在英文中很有效，在中文中几乎无效。）。其中fuzziness代表value的值word可以修改多少个字母来进行拼写错误的纠正（修改字母的数量包含字母变更，增加或减少字母。）。f代表要搜索的字段名称。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /test_a/_search
{
&quot;query&quot;: {
&quot;fuzzy&quot;: {
&quot;f&quot; : {
&quot;value&quot; : &quot;word&quot;,
&quot;fuzziness&quot;: 2
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id=""><a href="#" class="header-anchor">#</a></h2> <p><strong>回顾:</strong></p> <p>1）集群状态</p> <p><strong>如何快速了解集群的健康状况？green、yellow、red？</strong></p> <p>green：每个索引的primary shard和replica shard都是active状态的</p> <p>yellow：每个索引的primary shard都是active状态的，但是部分replica shard不是active状态，处于不可用的状态</p> <p>red：不是所有索引的primary shard都是active状态的，部分索引有数据丢失了</p> <p>集群什么情况会处于一个yellow状态？</p> <p>假设现在就一台linux服务器，就启动了一个es进程，相当于就只有一个node。现在es中有一个index，就是kibana自己内置建立的index。由于默认的配置是给每个index分配1个primary shard和1个replica shard，而且primary shard和replica shard不能在同一台机器上（为了容错）。现在kibana自己建立的index是1个primary shard和1个replica shard。当前就一个node，所以只有1个primary shard被分配了和启动了，但是一个replica shard没有第二台机器去启动。</p> <p>测试：启动第二个es进程，就会在es集群中有2个node，然后那1个replica shard就会自动分配过去，然后cluster status就会变成green状态。</p> <p><strong>2）不同节点介绍</strong></p> <p>主节点：node.master：true</p> <p>数据节点: node.data: true</p> <p>-1. 客户端节点</p> <p>当主节点和数据节点配置都设置为false的时候，该节点只能处理路由请求，处理搜索，分发索引操作等，从本质上来说该客户节点表现为智能负载平衡器。</p> <p>​    独立的客户端节点在一个比较大的集群中是非常有用的，他协调主节点和数据节点，客户端节点加入集群可以得到集群的状态，根据集群的状态可以直接路由请求。</p> <p>-2. 数据节点</p> <p>数据节点主要是存储索引数据的节点，主要对文档进行增删改查操作，聚合操作等。数据节点对cpu，内存，io要求较高， 在优化的时候需要监控数据节点的状态，当资源不够的时候，需要在集群中添加新的节点。</p> <p>-3. 主节点</p> <p>主资格节点的主要职责是和集群操作相关的内容，如创建或删除索引，跟踪哪些节点是群集的一部分，并决定哪些分片分配给相关的节点。稳定的主节点对集群的健康是非常重要的，默认情况下任何一个集群中的节点都有可能被选为主节点，索引数据和搜索查询等操作会占用大量的cpu，内存，io资源，为了确保一个集群的稳定，分离主节点和数据节点是一个比较好的选择。</p> <p>在一个生产集群中我们可以对这些节点的职责进行划分，建议集群中设置3台以上的节点作为master节点，这些节点只负责成为主节点，维护整个集群的状态。再根据数据量设置一批data节点，这些节点只负责存储数据，后期提供建立索引和查询索引的服务，这样的话如果用户请求比较频繁，这些节点的压力也会比较大，所以在集群中建议再设置一批client节点(node.master: false node.data: false)，这些节点只负责处理用户请求，实现请求转发，负载均衡等功能</p> <p><strong>一、ElasticSearch文档分值_score计算</strong>底层原理</p> <p>1）boolean model</p> <p>根据用户的query条件，先过滤出包含指定term的doc</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>query &quot;hello world&quot; --&gt;  hello / world / hello &amp; world

bool --&gt; must/must not/should --&gt; 过滤 --&gt; 包含 / 不包含 / 可能包含

doc --&gt; 不打分数 --&gt; 正或反 true or false --&gt; 为了减少后续要计算的doc的数量，提升性能
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>2)relevance score算法，简单来说，就是计算出，一个索引中的文本，与搜索文本，他们之间的关联匹配程度</p> <p>Elasticsearch使用的是 term frequency/inverse document frequency算法，简称为TF/IDF算法</p> <p><strong>Term frequency</strong>：搜索文本中的各个词条在field文本中出现了多少次，出现次数越多，就越相关</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>搜索请求：hello world



doc1：hello you, and world is very good

doc2：hello, how are you

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>Inverse document frequency</strong>：搜索文本中的各个词条在整个索引的所有文档中出现了多少次，出现的次数越多，就越不相关</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>搜索请求：hello world



doc1：hello, tuling is very good

doc2：hi world, how are you

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>比如说，在index中有1万条document，hello这个单词在所有的document中，一共出现了1000次；world这个单词在所有的document中，一共出现了100次</p> <p>Field-length norm：field长度，field越长，相关度越弱</p> <p>搜索请求：hello world</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>doc1：{ &quot;title&quot;: &quot;hello article&quot;, &quot;content&quot;: &quot;...... N个单词&quot; }

doc2：{ &quot;title&quot;: &quot;my article&quot;, &quot;content&quot;: &quot;...... N个单词，hi world&quot; }

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>​</p> <p>hello world在整个index中出现的次数是一样多的</p> <p>doc1更相关，title field更短</p> <p>2、分析一个document上的_score是如何被计算出来的</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /es_db/_doc/1/_explain
{
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;remark&quot;: &quot;java developer&quot;
    }
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>二、分词器工作流程</p> <p>切分词语，normalization</p> <p>给你一段句子，然后将这段句子拆分成一个一个的单个的单词，同时对每个单词进行normalization（时态转换，单复数转换），分词器</p> <p>recall，召回率：搜索的时候，增加能够搜索到的结果的数量</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>character filter：在一段文本进行分词之前，先进行预处理，比如说最常见的就是，过滤html标签（&lt;span&gt;hello&lt;span&gt; --&gt; hello），&amp; --&gt; and（I&amp;you --&gt; I and you）

tokenizer：分词，hello you and me --&gt; hello, you, and, me

token filter：lowercase，stop word，synonymom，liked --&gt; like，Tom --&gt; tom，a/the/an --&gt; 干掉，small --&gt; little

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>一个分词器，很重要，将一段文本进行各种处理，最后处理好的结果才会拿去建立倒排索引</p> <p>2、内置分词器的介绍</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Set the shape to semi-transparent by calling set_trans(5)

standard analyzer：set, the, shape, to, semi, transparent, by, calling, set_trans, 5（默认的是standard）

simple analyzer：set, the, shape, to, semi, transparent, by, calling, set, trans

whitespace analyzer：Set, the, shape, to, semi-transparent, by, calling, set_trans(5)

stop analyzer:移除停用词，比如a the it等等

测试：
POST _analyze
{
&quot;analyzer&quot;:&quot;standard&quot;,
&quot;text&quot;:&quot;Set the shape to semi-transparent by calling set_trans(5)&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>3、定制分词器</p> <p>1）默认的分词器</p> <p>standard</p> <p>standard tokenizer：以单词边界进行切分</p> <p>standard token filter：什么都不做</p> <p>lowercase token filter：将所有字母转换为小写</p> <p>stop token filer（默认被禁用）：移除停用词，比如a the it等等</p> <p>2）修改分词器的设置</p> <p>启用english停用词token filter</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /my_index
{
  &quot;settings&quot;: {
    &quot;analysis&quot;: {
      &quot;analyzer&quot;: {
        &quot;es_std&quot;: {
          &quot;type&quot;: &quot;standard&quot;,
          &quot;stopwords&quot;: &quot;_english_&quot;
        }
      }
    }
  }
}

GET /my_index/_analyze
{
  &quot;analyzer&quot;: &quot;standard&quot;, 
  &quot;text&quot;: &quot;a dog is in the house&quot;
}

GET /my_index/_analyze
{
  &quot;analyzer&quot;: &quot;es_std&quot;,
  &quot;text&quot;:&quot;a dog is in the house&quot;
}

3、定制化自己的分词器

PUT /my_index
{
&quot;settings&quot;: {
&quot;analysis&quot;: {
&quot;char_filter&quot;: {
&quot;&amp;_to_and&quot;: {
&quot;type&quot;: &quot;mapping&quot;,
&quot;mappings&quot;: [&quot;&amp;=&gt; and&quot;]
}
},
&quot;filter&quot;: {
&quot;my_stopwords&quot;: {
&quot;type&quot;: &quot;stop&quot;,
&quot;stopwords&quot;: [&quot;the&quot;, &quot;a&quot;]
}
},
&quot;analyzer&quot;: {
&quot;my_analyzer&quot;: {
&quot;type&quot;: &quot;custom&quot;,
&quot;char_filter&quot;: [&quot;html_strip&quot;, &quot;&amp;_to_and&quot;],
&quot;tokenizer&quot;: &quot;standard&quot;,
&quot;filter&quot;: [&quot;lowercase&quot;, &quot;my_stopwords&quot;]
}
}
}
}
}

GET /my_index/_analyze
{
&quot;text&quot;: &quot;tom&amp;jerry are a friend in the house, &lt;a&gt;, HAHA!!&quot;,
&quot;analyzer&quot;: &quot;my_analyzer&quot;
}

PUT /my_index/_mapping/my_type
{
&quot;properties&quot;: {
&quot;content&quot;: {
&quot;type&quot;: &quot;text&quot;,
&quot;analyzer&quot;: &quot;my_analyzer&quot;
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p>​</p> <p>3）ik分词器详解</p> <p>ik配置文件地址：es/plugins/ik/config目录</p> <p>IKAnalyzer.cfg.xml：用来配置自定义词库</p> <p>main.dic：ik原生内置的中文词库，总共有27万多条，只要是这些单词，都会被分在一起</p> <p>quantifier.dic：放了一些单位相关的词</p> <p>suffix.dic：放了一些后缀</p> <p>surname.dic：中国的姓氏</p> <p>stopword.dic：英文停用词</p> <p>ik原生最重要的两个配置文件</p> <p>main.dic：包含了原生的中文词语，会按照这个里面的词语去分词</p> <p>stopword.dic：包含了英文的停用词</p> <p>停用词，stopword</p> <p>a the and at but</p> <p>一般，像停用词，会在分词的时候，直接被干掉，不会建立在倒排索引中</p> <p>4）IK分词器自定义词库</p> <p>（1）自己建立词库：每年都会涌现一些特殊的流行词，网红，蓝瘦香菇，喊麦，鬼畜，一般不会在ik的原生词典里</p> <p>自己补充自己的最新的词语，到ik的词库里面去</p> <p>IKAnalyzer.cfg.xml：ext_dict，custom/mydict.dic</p> <p>补充自己的词语，然后需要重启es，才能生效</p> <p>（2）自己建立停用词库：比如了，的，啥，么，我们可能并不想去建立索引，让人家搜索</p> <p>custom/ext_stopword.dic，已经有了常用的中文停用词，可以补充自己的停用词，然后重启es</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>IK分词器源码下载：https://github.com/medcl/elasticsearch-analysis-ik/tree
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>5）IK热更新</p> <p>每次都是在es的扩展词典中，手动添加新词语，很坑</p> <p>（1）每次添加完，都要重启es才能生效，非常麻烦</p> <p>（2）es是分布式的，可能有数百个节点，你不能每次都一个一个节点上面去修改</p> <p>es不停机，直接我们在外部某个地方添加新的词语，es中立即热加载到这些新词语</p> <p>IKAnalyzer.cfg.xml</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;properties&gt;
	&lt;comment&gt;IK Analyzer 扩展配置&lt;/comment&gt;
	&lt;!--用户可以在这里配置自己的扩展字典 --&gt;
	&lt;entry key=&quot;ext_dict&quot;&gt;location&lt;/entry&gt;
	 &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;
	&lt;entry key=&quot;ext_stopwords&quot;&gt;location&lt;/entry&gt;
	&lt;!--用户可以在这里配置远程扩展字典 --&gt;
	&lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; 
	&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;
	&lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt;
&lt;/properties&gt;

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>三. 高亮显示</strong></p> <p>在搜索中，经常需要对搜索关键字做高亮显示，高亮显示也有其常用的参数，在这个案例中做一些常用参数的介绍。</p> <p>现在搜索cars索引中remark字段中包含“大众”的document。并对“XX关键字”做高亮显示，高亮效果使用html标签，并设定字体为红色。如果remark数据过长，则只显示前20个字符。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /news_website
{
  &quot;mappings&quot;: {

      &quot;properties&quot;: {
        &quot;title&quot;: {
          &quot;type&quot;: &quot;text&quot;,
          &quot;analyzer&quot;: &quot;ik_max_word&quot;
        },
        &quot;content&quot;: {
          &quot;type&quot;: &quot;text&quot;,
          &quot;analyzer&quot;: &quot;ik_max_word&quot;
        }
      }
    }
  
}


PUT /news_website
{
    &quot;settings&quot; : {
        &quot;index&quot; : {
            &quot;analysis.analyzer.default.type&quot;: &quot;ik_max_word&quot;
        }
    }
}




PUT /news_website/_doc/1
{
  &quot;title&quot;: &quot;这是我写的第一篇文章&quot;,
  &quot;content&quot;: &quot;大家好，这是我写的第一篇文章，特别喜欢这个文章门户网站！！！&quot;
}

GET /news_website/_doc/_search 
{
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;title&quot;: &quot;文章&quot;
    }
  },
  &quot;highlight&quot;: {
    &quot;fields&quot;: {
      &quot;title&quot;: {}
    }
  }
}

{
  &quot;took&quot; : 458,
  &quot;timed_out&quot; : false,
  &quot;_shards&quot; : {
    &quot;total&quot; : 1,
    &quot;successful&quot; : 1,
    &quot;skipped&quot; : 0,
    &quot;failed&quot; : 0
  },
  &quot;hits&quot; : {
    &quot;total&quot; : {
      &quot;value&quot; : 1,
      &quot;relation&quot; : &quot;eq&quot;
    },
    &quot;max_score&quot; : 0.2876821,
    &quot;hits&quot; : [
      {
        &quot;_index&quot; : &quot;news_website&quot;,
        &quot;_type&quot; : &quot;_doc&quot;,
        &quot;_id&quot; : &quot;1&quot;,
        &quot;_score&quot; : 0.2876821,
        &quot;_source&quot; : {
          &quot;title&quot; : &quot;我的第一篇文章&quot;,
          &quot;content&quot; : &quot;大家好，这是我写的第一篇文章，特别喜欢这个文章门户网站！！！&quot;
        },
        &quot;highlight&quot; : {
          &quot;title&quot; : [
            &quot;我的第一篇&lt;em&gt;文章&lt;/em&gt;&quot;
          ]
        }
      }
    ]
  }
}

&lt;em&gt;&lt;/em&gt;表现，会变成红色，所以说你的指定的field中，如果包含了那个搜索词的话，就会在那个field的文本中，对搜索词进行红色的高亮显示

GET /news_website/_doc/_search 
{
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;should&quot;: [
        {
          &quot;match&quot;: {
            &quot;title&quot;: &quot;文章&quot;
          }
        },
        {
          &quot;match&quot;: {
            &quot;content&quot;: &quot;文章&quot;
          }
        }
      ]
    }
  },
  &quot;highlight&quot;: {
    &quot;fields&quot;: {
      &quot;title&quot;: {},
      &quot;content&quot;: {}
    }
  }
}

highlight中的field，必须跟query中的field一一对齐的

2、常用的highlight介绍

plain highlight，lucene highlight，默认

posting highlight，index_options=offsets

（1）性能比plain highlight要高，因为不需要重新对高亮文本进行分词
（2）对磁盘的消耗更少


DELETE news_website
PUT /news_website
{
  &quot;mappings&quot;: {
      &quot;properties&quot;: {
        &quot;title&quot;: {
          &quot;type&quot;: &quot;text&quot;,
          &quot;analyzer&quot;: &quot;ik_max_word&quot;
        },
        &quot;content&quot;: {
          &quot;type&quot;: &quot;text&quot;,
          &quot;analyzer&quot;: &quot;ik_max_word&quot;,
          &quot;index_options&quot;: &quot;offsets&quot;
        }
      }
  }
}

PUT /news_website/_doc/1
{
  &quot;title&quot;: &quot;我的第一篇文章&quot;,
  &quot;content&quot;: &quot;大家好，这是我写的第一篇文章，特别喜欢这个文章门户网站！！！&quot;
}

GET /news_website/_doc/_search 
{
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;content&quot;: &quot;文章&quot;
    }
  },
  &quot;highlight&quot;: {
    &quot;fields&quot;: {
      &quot;content&quot;: {}
    }
  }
}

fast vector highlight

index-time term vector设置在mapping中，就会用fast verctor highlight

（1）对大field而言（大于1mb），性能更高

delete  /news_website

PUT /news_website
{
  &quot;mappings&quot;: {
      &quot;properties&quot;: {
        &quot;title&quot;: {
          &quot;type&quot;: &quot;text&quot;,
          &quot;analyzer&quot;: &quot;ik_max_word&quot;
        },
        &quot;content&quot;: {
          &quot;type&quot;: &quot;text&quot;,
          &quot;analyzer&quot;: &quot;ik_max_word&quot;,
          &quot;term_vector&quot; : &quot;with_positions_offsets&quot;
        }
      }
  }
}

强制使用某种highlighter，比如对于开启了term vector的field而言，可以强制使用plain highlight

GET /news_website/_doc/_search 
{
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;content&quot;: &quot;文章&quot;
    }
  },
  &quot;highlight&quot;: {
    &quot;fields&quot;: {
      &quot;content&quot;: {
        &quot;type&quot;: &quot;plain&quot;
      }
    }
  }
}

总结一下，其实可以根据你的实际情况去考虑，一般情况下，用plain highlight也就足够了，不需要做其他额外的设置
如果对高亮的性能要求很高，可以尝试启用posting highlight
如果field的值特别大，超过了1M，那么可以用fast vector highlight

3、设置高亮html标签，默认是&lt;em&gt;标签

GET /news_website/_doc/_search 
{
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;content&quot;: &quot;文章&quot;
    }
  },
  &quot;highlight&quot;: {
    &quot;pre_tags&quot;: [&quot;&lt;span color='red'&gt;&quot;],
    &quot;post_tags&quot;: [&quot;&lt;/span&gt;&quot;], 
    &quot;fields&quot;: {
      &quot;content&quot;: {
        &quot;type&quot;: &quot;plain&quot;
      }
    }
  }
}

4、高亮片段fragment的设置

GET /_search
{
    &quot;query&quot; : {
        &quot;match&quot;: { &quot;content&quot;: &quot;文章&quot; }
    },
    &quot;highlight&quot; : {
        &quot;fields&quot; : {
            &quot;content&quot; : {&quot;fragment_size&quot; : 150, &quot;number_of_fragments&quot; : 3 }
        }
    }
}

fragment_size: 你一个Field的值，比如有长度是1万，但是你不可能在页面上显示这么长啊。。。设置要显示出来的fragment文本判断的长度，默认是100
number_of_fragments：你可能你的高亮的fragment文本片段有多个片段，你可以指定就显示几个片段

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br></div></div><p><strong>四、 聚合搜索技术深入</strong></p> <p><strong>1.bucket和metric概念简介</strong></p> <p>bucket就是一个聚合搜索时的数据分组。如：销售部门有员工张三和李四，开发部门有员工王五和赵六。那么根据部门分组聚合得到结果就是两个bucket。销售部门bucket中有张三和李四，</p> <p>开发部门 bucket中有王五和赵六。</p> <p>metric就是对一个bucket数据执行的统计分析。如上述案例中，开发部门有2个员工，销售部门有2个员工，这就是metric。</p> <p>metric有多种统计，如：求和，最大值，最小值，平均值等。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>用一个大家容易理解的SQL语法来解释，如：select count(*) from table group by column。那么group by column分组后的每组数据就是bucket。对每个分组执行的count(*)就是metric。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>2.准备案例数据</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT /cars
{
&quot;mappings&quot;: {
&quot;properties&quot;: {
&quot;price&quot;: {
&quot;type&quot;: &quot;long&quot;
},
&quot;color&quot;: {
&quot;type&quot;: &quot;keyword&quot;
},
&quot;brand&quot;: {
&quot;type&quot;: &quot;keyword&quot;
},
&quot;model&quot;: {
&quot;type&quot;: &quot;keyword&quot;
},
&quot;sold_date&quot;: {
&quot;type&quot;: &quot;date&quot;
},
&quot;remark&quot; : {
&quot;type&quot; : &quot;text&quot;,
&quot;analyzer&quot; : &quot;ik_max_word&quot;
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>​</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>POST /cars/_bulk
{ &quot;index&quot;: {}}
{ &quot;price&quot; : 258000, &quot;color&quot; : &quot;金色&quot;, &quot;brand&quot;:&quot;大众&quot;, &quot;model&quot; : &quot;大众迈腾&quot;, &quot;sold_date&quot; : &quot;2021-10-28&quot;,&quot;remark&quot; : &quot;大众中档车&quot; }
{ &quot;index&quot;: {}}
{ &quot;price&quot; : 123000, &quot;color&quot; : &quot;金色&quot;, &quot;brand&quot;:&quot;大众&quot;, &quot;model&quot; : &quot;大众速腾&quot;, &quot;sold_date&quot; : &quot;2021-11-05&quot;,&quot;remark&quot; : &quot;大众神车&quot; }
{ &quot;index&quot;: {}}
{ &quot;price&quot; : 239800, &quot;color&quot; : &quot;白色&quot;, &quot;brand&quot;:&quot;标志&quot;, &quot;model&quot; : &quot;标志508&quot;, &quot;sold_date&quot; : &quot;2021-05-18&quot;,&quot;remark&quot; : &quot;标志品牌全球上市车型&quot; }
{ &quot;index&quot;: {}}
{ &quot;price&quot; : 148800, &quot;color&quot; : &quot;白色&quot;, &quot;brand&quot;:&quot;标志&quot;, &quot;model&quot; : &quot;标志408&quot;, &quot;sold_date&quot; : &quot;2021-07-02&quot;,&quot;remark&quot; : &quot;比较大的紧凑型车&quot; }
{ &quot;index&quot;: {}}
{ &quot;price&quot; : 1998000, &quot;color&quot; : &quot;黑色&quot;, &quot;brand&quot;:&quot;大众&quot;, &quot;model&quot; : &quot;大众辉腾&quot;, &quot;sold_date&quot; : &quot;2021-08-19&quot;,&quot;remark&quot; : &quot;大众最让人肝疼的车&quot; }
{ &quot;index&quot;: {}}
{ &quot;price&quot; : 218000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot;:&quot;奥迪&quot;, &quot;model&quot; : &quot;奥迪A4&quot;, &quot;sold_date&quot; : &quot;2021-11-05&quot;,&quot;remark&quot; : &quot;小资车型&quot; }
{ &quot;index&quot;: {}}
{ &quot;price&quot; : 489000, &quot;color&quot; : &quot;黑色&quot;, &quot;brand&quot;:&quot;奥迪&quot;, &quot;model&quot; : &quot;奥迪A6&quot;, &quot;sold_date&quot; : &quot;2022-01-01&quot;,&quot;remark&quot; : &quot;政府专用？&quot; }
{ &quot;index&quot;: {}}
{ &quot;price&quot; : 1899000, &quot;color&quot; : &quot;黑色&quot;, &quot;brand&quot;:&quot;奥迪&quot;, &quot;model&quot; : &quot;奥迪A 8&quot;, &quot;sold_date&quot; : &quot;2022-02-12&quot;,&quot;remark&quot; : &quot;很贵的大A6。。。&quot; }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>五.聚合操作案例</strong></p> <p>1、根据color分组统计销售数量</p> <p>只执行聚合分组，不做复杂的聚合统计。在ES中最基础的聚合为terms，相当于SQL中的count。</p> <p>在ES中默认为分组数据做排序，使用的是doc_count数据执行降序排列。可以使用_key元数据，根据分组后的字段数据执行不同的排序方案，也可以根据_count元数据，根据分组后的统计值执行不同的排序方案。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /cars/_search
{
&quot;aggs&quot;: {
&quot;group_by_color&quot;: {
&quot;terms&quot;: {
&quot;field&quot;: &quot;color&quot;,
&quot;order&quot;: {
&quot;_count&quot;: &quot;desc&quot;
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>2、统计不同color车辆的平均价格</strong></p> <p>本案例先根据color执行聚合分组，在此分组的基础上，对组内数据执行聚合统计，这个组内数据的聚合统计就是metric。同样可以执行排序，因为组内有聚合统计，且对统计数据给予了命名avg_by_price，所以可以根据这个聚合统计数据字段名执行排序逻辑。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /cars/_search
{
&quot;aggs&quot;: {
&quot;group_by_color&quot;: {
&quot;terms&quot;: {
&quot;field&quot;: &quot;color&quot;,
&quot;order&quot;: {
&quot;avg_by_price&quot;: &quot;asc&quot;
}
},
&quot;aggs&quot;: {
&quot;avg_by_price&quot;: {
&quot;avg&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>size可以设置为0，表示不返回ES中的文档，只返回ES聚合之后的数据，提高查询速度，当然如果你需要这些文档的话，也可以按照实际情况进行设置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /cars/_search
{
&quot;size&quot; : 0,
&quot;aggs&quot;: {
&quot;group_by_color&quot;: {
&quot;terms&quot;: {
&quot;field&quot;: &quot;color&quot;
},
&quot;aggs&quot;: {
&quot;group_by_brand&quot; : {
&quot;terms&quot;: {
&quot;field&quot;: &quot;brand&quot;,
&quot;order&quot;: {
&quot;avg_by_price&quot;: &quot;desc&quot;
}
},
&quot;aggs&quot;: {
&quot;avg_by_price&quot;: {
&quot;avg&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>3、统计不同color不同brand中车辆的平均价格</strong></p> <p>先根据color聚合分组，在组内根据brand再次聚合分组，这种操作可以称为下钻分析。</p> <p>Aggs如果定义比较多，则会感觉语法格式混乱，aggs语法格式，有一个相对固定的结构，简单定义：aggs可以嵌套定义，可以水平定义。</p> <p>嵌套定义称为下钻分析。水平定义就是平铺多个分组方式。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /index_name/type_name/_search
{
&quot;aggs&quot; : {
&quot;定义分组名称（最外层）&quot;: {
&quot;分组策略如：terms、avg、sum&quot; : {
&quot;field&quot; : &quot;根据哪一个字段分组&quot;,
&quot;其他参数&quot; : &quot;&quot;
},
&quot;aggs&quot; : {
&quot;分组名称1&quot; : {},
&quot;分组名称2&quot; : {}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>GET /cars/_search
{
&quot;aggs&quot;: {
&quot;group_by_color&quot;: {
&quot;terms&quot;: {
&quot;field&quot;: &quot;color&quot;,
&quot;order&quot;: {
&quot;avg_by_price_color&quot;: &quot;asc&quot;
}
},
&quot;aggs&quot;: {
&quot;avg_by_price_color&quot; : {
&quot;avg&quot;: {
&quot;field&quot;: &quot;price&quot;
}
},
&quot;group_by_brand&quot; : {
&quot;terms&quot;: {
&quot;field&quot;: &quot;brand&quot;,
&quot;order&quot;: {
&quot;avg_by_price_brand&quot;: &quot;desc&quot;
}
},
&quot;aggs&quot;: {
&quot;avg_by_price_brand&quot;: {
&quot;avg&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p><strong>4、统计不同color中的最大和最小价格、总价</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /cars/_search
{
&quot;aggs&quot;: {
&quot;group_by_color&quot;: {
&quot;terms&quot;: {
&quot;field&quot;: &quot;color&quot;
},
&quot;aggs&quot;: {
&quot;max_price&quot;: {
&quot;max&quot;: {
&quot;field&quot;: &quot;price&quot;
}
},
&quot;min_price&quot; : {
&quot;min&quot;: {
&quot;field&quot;: &quot;price&quot;
}
},
&quot;sum_price&quot; : {
&quot;sum&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>在常见的业务常见中，聚合分析，最常用的种类就是统计数量，最大，最小，平均，总计等。通常占有聚合业务中的60%以上的比例，小型项目中，甚至占比85%以上。</p> <p><strong>5、统计不同品牌汽车中价格排名最高的车型</strong></p> <p>在分组后，可能需要对组内的数据进行排序，并选择其中排名高的数据。那么可以使用s来实现：top_top_hithits中的属性size代表取组内多少条数据（默认为10）；sort代表组内使用什么字段什么规则排序（默认使用_doc的asc规则排序）；_source代表结果中包含document中的那些字段（默认包含全部字段）。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET cars/_search
{
&quot;size&quot; : 0,
&quot;aggs&quot;: {
&quot;group_by_brand&quot;: {
&quot;terms&quot;: {
&quot;field&quot;: &quot;brand&quot;
},
&quot;aggs&quot;: {
&quot;top_car&quot;: {
&quot;top_hits&quot;: {
&quot;size&quot;: 1,
&quot;sort&quot;: [
{
&quot;price&quot;: {
&quot;order&quot;: &quot;desc&quot;
}
}
],
&quot;_source&quot;: {
&quot;includes&quot;: [&quot;model&quot;, &quot;price&quot;]
}
}
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>6、histogram 区间统计</strong></p> <p>histogram类似terms，也是进行bucket分组操作的，是根据一个field，实现数据区间分组。</p> <p>如：以100万为一个范围，统计不同范围内车辆的销售量和平均价格。那么使用histogram的聚合的时候，field指定价格字段price。区间范围是100万-interval ： 1000000。这个时候ES会将price价格区间划分为： [0, 1000000), [1000000, 2000000), [2000000, 3000000)等，依次类推。在划分区间的同时，histogram会类似terms进行数据数量的统计（count），可以通过嵌套aggs对聚合分组后的组内数据做再次聚合分析。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /cars/_search
{
&quot;aggs&quot;: {
&quot;histogram_by_price&quot;: {
&quot;histogram&quot;: {
&quot;field&quot;: &quot;price&quot;,
&quot;interval&quot;: 1000000
},
&quot;aggs&quot;: {
&quot;avg_by_price&quot;: {
&quot;avg&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>7、date_histogram区间分组</strong></p> <p>date_histogram可以对date类型的field执行区间聚合分组，如每月销量，每年销量等。</p> <p>如：以月为单位，统计不同月份汽车的销售数量及销售总金额。这个时候可以使用date_histogram实现聚合分组，其中field来指定用于聚合分组的字段，interval指定区间范围（可选值有：year、quarter、month、week、day、hour、minute、second），format指定日期格式化，min_doc_count指定每个区间的最少document（如果不指定，默认为0，当区间范围内没有document时，也会显示bucket分组），extended_bounds指定起始时间和结束时间（如果不指定，默认使用字段中日期最小值所在范围和最大值所在范围为起始和结束时间）。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ES7.x之前的语法
GET /cars/_search
{
&quot;aggs&quot;: {
&quot;histogram_by_date&quot; : {
&quot;date_histogram&quot;: {
&quot;field&quot;: &quot;sold_date&quot;,
&quot;interval&quot;: &quot;month&quot;,
&quot;format&quot;: &quot;yyyy-MM-dd&quot;,
&quot;min_doc_count&quot;: 1,
&quot;extended_bounds&quot;: {
&quot;min&quot;: &quot;2021-01-01&quot;,
&quot;max&quot;: &quot;2022-12-31&quot;
}
},
&quot;aggs&quot;: {
&quot;sum_by_price&quot;: {
&quot;sum&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
}
}
执行后出现
#! Deprecation: [interval] on [date_histogram] is deprecated, use [fixed_interval] or [calendar_interval] in the future.

7.X之后
GET /cars/_search
{
&quot;aggs&quot;: {
&quot;histogram_by_date&quot; : {
&quot;date_histogram&quot;: {
&quot;field&quot;: &quot;sold_date&quot;,
&quot;calendar_interval&quot;: &quot;month&quot;,
&quot;format&quot;: &quot;yyyy-MM-dd&quot;,
&quot;min_doc_count&quot;: 1,
&quot;extended_bounds&quot;: {
&quot;min&quot;: &quot;2021-01-01&quot;,
&quot;max&quot;: &quot;2022-12-31&quot;
}
},
&quot;aggs&quot;: {
&quot;sum_by_price&quot;: {
&quot;sum&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p><strong>8、_global bucket</strong></p> <p>在聚合统计数据的时候，有些时候需要对比部分数据和总体数据。</p> <p>如：统计某品牌车辆平均价格和所有车辆平均价格。global是用于定义一个全局bucket，这个bucket会忽略query的条件，检索所有document进行对应的聚合统计。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /cars/_search
{
&quot;size&quot; : 0,
&quot;query&quot;: {
&quot;match&quot;: {
&quot;brand&quot;: &quot;大众&quot;
}
},
&quot;aggs&quot;: {
&quot;volkswagen_of_avg_price&quot;: {
&quot;avg&quot;: {
&quot;field&quot;: &quot;price&quot;
}
},
&quot;all_avg_price&quot; : {
&quot;global&quot;: {},
&quot;aggs&quot;: {
&quot;all_of_price&quot;: {
&quot;avg&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><strong>9、aggs+order</strong></p> <p>对聚合统计数据进行排序。</p> <p>如：统计每个品牌的汽车销量和销售总额，按照销售总额的降序排列。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /cars/_search
{
&quot;aggs&quot;: {
&quot;group_of_brand&quot;: {
&quot;terms&quot;: {
&quot;field&quot;: &quot;brand&quot;,
&quot;order&quot;: {
&quot;sum_of_price&quot;: &quot;desc&quot;
}
},
&quot;aggs&quot;: {
&quot;sum_of_price&quot;: {
&quot;sum&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>如果有多层aggs，执行下钻聚合的时候，也可以根据最内层聚合数据执行排序。</p> <p>如：统计每个品牌中每种颜色车辆的销售总额，并根据销售总额降序排列。<strong>这就像SQL中的分组排序一样，只能组内数据排序，而不能跨组实现排序。</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /cars/_search
{
&quot;aggs&quot;: {
&quot;group_by_brand&quot;: {
&quot;terms&quot;: {
&quot;field&quot;: &quot;brand&quot;
},
&quot;aggs&quot;: {
&quot;group_by_color&quot;: {
&quot;terms&quot;: {
&quot;field&quot;: &quot;color&quot;,
&quot;order&quot;: {
&quot;sum_of_price&quot;: &quot;desc&quot;
}
},
&quot;aggs&quot;: {
&quot;sum_of_price&quot;: {
&quot;sum&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>10、search+aggs</strong></p> <p>聚合类似SQL中的group by子句，search类似SQL中的where子句。在ES中是完全可以将search和aggregations整合起来，执行相对更复杂的搜索统计。</p> <p>如：统计某品牌车辆每个季度的销量和销售额。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /cars/_search
{
&quot;query&quot;: {
&quot;match&quot;: {
&quot;brand&quot;: &quot;大众&quot;
}
},
&quot;aggs&quot;: {
&quot;histogram_by_date&quot;: {
&quot;date_histogram&quot;: {
&quot;field&quot;: &quot;sold_date&quot;,
&quot;calendar_interval&quot;: &quot;quarter&quot;,
&quot;min_doc_count&quot;: 1
},
&quot;aggs&quot;: {
&quot;sum_by_price&quot;: {
&quot;sum&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>​</p> <p><strong>11、filter+aggs</strong></p> <p>在ES中，filter也可以和aggs组合使用，实现相对复杂的过滤聚合分析。</p> <p>如：统计10万~50万之间的车辆的平均价格。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /cars/_search
{
&quot;query&quot;: {
&quot;constant_score&quot;: {
&quot;filter&quot;: {
&quot;range&quot;: {
&quot;price&quot;: {
&quot;gte&quot;: 100000,
&quot;lte&quot;: 500000
}
}
}
}
},
&quot;aggs&quot;: {
&quot;avg_by_price&quot;: {
&quot;avg&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>12、聚合中使用filter</strong></p> <p>filter也可以使用在aggs句法中，filter的范围决定了其过滤的范围。</p> <p>如：统计某品牌汽车最近一年的销售总额。将filter放在aggs内部，代表这个过滤器只对query搜索得到的结果执行filter过滤。如果filter放在aggs外部，过滤器则会过滤所有的数据。</p> <ul><li>12M/M 表示 12 个月。</li> <li>1y/y 表示 1年。</li> <li>d 表示天</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /cars/_search
{
&quot;query&quot;: {
&quot;match&quot;: {
&quot;brand&quot;: &quot;大众&quot;
}
},
&quot;aggs&quot;: {
&quot;count_last_year&quot;: {
&quot;filter&quot;: {
&quot;range&quot;: {
&quot;sold_date&quot;: {
&quot;gte&quot;: &quot;now-12M&quot;
}
}
},
&quot;aggs&quot;: {
&quot;sum_of_price_last_year&quot;: {
&quot;sum&quot;: {
&quot;field&quot;: &quot;price&quot;
}
}
}
}
}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="master选举"><a href="#master选举" class="header-anchor">#</a> master选举</h2> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/elastic/1.png" alt=""></p> <h2 id="附录"><a href="#附录" class="header-anchor">#</a> 附录</h2> <h3 id="cat命令"><a href="#cat命令" class="header-anchor">#</a> Cat命令</h3> <p>/_cat/allocation    #查看单节点的shard分配整体情况</p> <p>/_cat/shards     #查看各shard的详细情况</p> <p>/_cat/shards/{index}   #查看指定分片的详细情况</p> <p>/_cat/master     #查看master节点信息</p> <p>/_cat/nodes      #查看所有节点信息</p> <p>/_cat/indices     #查看集群中所有index的详细信息</p> <p>/_cat/indices/{index}   #查看集群中指定index的详细信息</p> <p>/_cat/segments    #查看各index的segment详细信息,包括segment名, 所属shard, 内存(磁盘)占用大小, 是否刷盘</p> <p>/_cat/segments/{index}#查看指定index的segment详细信息</p> <p>/_cat/count      #查看当前集群的doc数量</p> <p>/_cat/count/{index}  #查看指定索引的doc数量</p> <p>/_cat/recovery     #查看集群内每个shard的recovery过程.调整replica。</p> <p>/_cat/recovery/{index}#查看指定索引shard的recovery过程</p> <p>/_cat/health     #查看集群当前状态：红、黄、绿</p> <p>/_cat/pending_tasks  #查看当前集群的pending task</p> <p>/_cat/aliases     #查看集群中所有alias信息,路由配置等</p> <p>/_cat/aliases/{alias} #查看指定索引的alias信息</p> <p>/_cat/thread_pool   #查看集群各节点内部不同类型的threadpool的统计信息,</p> <p>/_cat/plugins     #查看集群各个节点上的plugin信息</p> <p>/_cat/fielddata    #查看当前集群各个节点的fielddata内存使用情况</p> <p>/_cat/fielddata/{fields}   #查看指定field的内存使用情况,里面传field属性对应的值</p> <p>/_cat/nodeattrs       #查看单节点的自定义属性</p> <p>/_cat/repositories      #输出集群中注册快照存储库</p> <p>/_cat/templates       #输出当前正在存在的模板信息</p> <h2 id="第三节-elasticsearch原理"><a href="#第三节-elasticsearch原理" class="header-anchor">#</a> 第三节 ElasticSearch原理</h2> <h3 id="_3-1-解析es的分布式架构"><a href="#_3-1-解析es的分布式架构" class="header-anchor">#</a> 3.1 解析es的分布式架构</h3> <h4 id="_3-1-1-分布式架构的透明隐藏特性"><a href="#_3-1-1-分布式架构的透明隐藏特性" class="header-anchor">#</a> 3.1.1 分布式架构的透明隐藏特性</h4> <p>ElasticSearch是一个分布式系统，隐藏了复杂的处理机制</p> <p>分片机制：我们不用关心数据是按照什么机制分片的、最后放入到哪个分片中</p> <p>分片的副本：</p> <p>集群发现机制(cluster discovery)：比如当前我们启动了一个es进程，当启动了第二个es进程时，这个进程作为一个node自动就发现了集群，并且加入了进去</p> <p>shard负载均衡：比如现在有10shard，集群中有3个节点，es会进行均衡的进行分配，以保持每个节点均衡的负载请求</p> <p>请求路由</p> <h4 id="_3-1-2-扩容机制"><a href="#_3-1-2-扩容机制" class="header-anchor">#</a> 3.1.2 扩容机制</h4> <p>垂直扩容：购置新的机器，替换已有的机器</p> <p>水平扩容：直接增加机器</p> <h4 id="_3-1-3-rebalance"><a href="#_3-1-3-rebalance" class="header-anchor">#</a> 3.1.3 rebalance</h4> <p>增加或减少节点时会自动均衡</p> <h4 id="_3-1-4-master节点"><a href="#_3-1-4-master节点" class="header-anchor">#</a> 3.1.4 master节点</h4> <p>主节点的主要职责是和集群操作相关的内容，如创建或删除索引，跟踪哪些节点是群集的一部分，并决定哪些分片分配给相关的节点。稳定的主节点对集群的健康是非常重要的。</p> <h4 id="_3-1-5-节点对等"><a href="#_3-1-5-节点对等" class="header-anchor">#</a> 3.1.5 节点对等</h4> <p>每个节点都能接收请求</p> <p>每个节点接收到请求后都能把该请求路由到有相关数据的其它节点上</p> <p>接收原始请求的节点负责采集数据并返回给客户端</p> <h3 id="_3-2-分片和副本机制"><a href="#_3-2-分片和副本机制" class="header-anchor">#</a> 3.2 分片和副本机制</h3> <p>1.index包含多个shard</p> <p>2.每个shard都是一个最小工作单元，承载部分数据；每个shard都是一个lucene实例，有完整的建立索引和处理请求的能力</p> <p>3.增减节点时，shard会自动在nodes中负载均衡</p> <p>4.primary shard和replica shard，每个document肯定只存在于某一个primary shard以及其对应的replica shard中，不可能存在于多个primary shard</p> <p>5.replica shard是primary shard的副本，负责容错，以及承担读请求负载</p> <p>6.primary shard的数量在创建索引的时候就固定了，replica shard的数量可以随时修改</p> <p>7.primary shard的默认数量是5，replica默认是1，默认有10个shard，5个primary shard，5个replica shard</p> <p>8.primary shard不能和自己的replica shard放在同一个节点上（否则节点宕机，primary shard和副本都丢失，起不到容错的作用），但是可以和其他primary shard的replica shard放在同一个节点上</p> <h3 id="_3-3-单节点环境下创建索引分析"><a href="#_3-3-单节点环境下创建索引分析" class="header-anchor">#</a> 3.3 单节点环境下创建索引分析</h3> <p>PUT /myindex</p> <p>{</p> <p>&quot;settings&quot; : {</p> <p>​      &quot;number_of_shards&quot; : 3,</p> <p>​      &quot;number_of_replicas&quot; : 1</p> <p>}</p> <p>}</p> <p>这个时候，只会将3个primary shard分配到仅有的一个node上去，另外3个replica shard是无法分配的（一个shard的副本replica，他们两个是不能在同一个节点的）。集群可以正常工作，但是一旦出现节点宕机，数据全部丢失，而且集群不可用，无法接收任何请求。</p> <h3 id="_3-4-两个节点环境下创建索引分析"><a href="#_3-4-两个节点环境下创建索引分析" class="header-anchor">#</a> 3.4 两个节点环境下创建索引分析</h3> <p>将3个primary shard分配到一个node上去，另外3个replica shard分配到另一个节点上</p> <p>primary shard 和replica shard 保持同步</p> <p>primary shard 和replica shard 都可以处理客户端的读请求</p> <h3 id="_3-5-水平扩容的过程"><a href="#_3-5-水平扩容的过程" class="header-anchor">#</a> 3.5 水平扩容的过程</h3> <p>1.扩容后primary shard和replica shard会自动的负载均衡</p> <p>2.扩容后每个节点上的shard会减少，那么分配给每个shard的CPU，内存，IO资源会更多，性能提高</p> <p>3.扩容的极限，如果有6个shard，扩容的极限就是6个节点，每个节点上一个shard，如果想超出扩容的极限，比如说扩容到9个节点，那么可以增加replica shard的个数</p> <p>4.6个shard，3个节点，最多能承受几个节点所在的服务器宕机？(容错性)</p> <p>任何一台服务器宕机都会丢失部分数据</p> <p>为了提高容错性，增加shard的个数：</p> <p>9个shard，(3个primary shard，6个replicashard)，这样就能容忍最多两台服务器宕机了</p> <p>总结：扩容是为了提高系统的吞吐量，同时也要考虑容错性，也就是让尽可能多的服务器宕机还能保证数据不丢失</p> <h3 id="_3-6elasticsearch的容错机制"><a href="#_3-6elasticsearch的容错机制" class="header-anchor">#</a> 3.6ElasticSearch的容错机制</h3> <p>以9个shard，3个节点为例：</p> <p>1.如果master node 宕机，此时不是所有的primary shard都是Active status，所以此时的集群状态是red。</p> <p>容错处理的第一步:是选举一台服务器作为master</p> <p>容错处理的第二步:新选举出的master会把挂掉的primary shard的某个replica shard 提升为primary shard,此时集群的状态为yellow，因为少了一个replica shard，并不是所有的replica shard都是active status</p> <p>容错处理的第三步：重启故障机，新master会把所有的副本都复制一份到该节点上，（同步一下宕机后发生的修改），此时集群的状态为green，因为所有的primary shard和replica shard都是Active status</p> <h3 id="_3-7文档的核心元数据"><a href="#_3-7文档的核心元数据" class="header-anchor">#</a> 3.7文档的核心元数据</h3> <p>1._index:</p> <p>说明了一个文档存储在哪个索引中</p> <p>同一个索引下存放的是相似的文档(文档的field多数是相同的)</p> <p>索引名必须是小写的，不能以下划线开头，不能包括逗号</p> <p>2._type:</p> <p>表示文档属于索引中的哪个类型</p> <p>一个索引下只能有一个type</p> <p>类型名可以是大写也可以是小写的，不能以下划线开头，不能包括逗号</p> <p>3._id:</p> <p>文档的唯一标识，和索引，类型组合在一起唯一标识了一个文档</p> <p>可以手动指定值，也可以由es来生成这个值</p> <h3 id="_3-8-文档id生成方式"><a href="#_3-8-文档id生成方式" class="header-anchor">#</a> 3.8 文档id生成方式</h3> <p>1.手动指定</p> <p>put /index/type/66</p> <p>通常是把其它系统的已有数据导入到es时</p> <p>2.由es生成id值</p> <p>post /index/type</p> <p>es生成的id长度为20个字符，使用的是base64编码，URL安全，使用的是GUID算法，分布式下并发生成id值时不会冲突</p> <h3 id="_3-9-source元数据分析"><a href="#_3-9-source元数据分析" class="header-anchor">#</a> 3.9 _source元数据分析</h3> <p>其实就是我们在添加文档时request body中的内容</p> <p>指定返回的结果中含有哪些字段：</p> <p>get /index/type/1?_source=name</p> <h3 id="_3-10-改变文档内容原理解析"><a href="#_3-10-改变文档内容原理解析" class="header-anchor">#</a> 3.10 改变文档内容原理解析</h3> <p>替换方式：</p> <p>PUT /lib/user/4</p> <p>{ &quot;first_name&quot; : &quot;Jane&quot;,</p> <p>&quot;last_name&quot; :   &quot;Lucy&quot;,</p> <p>&quot;age&quot; :         24,</p> <p>&quot;about&quot; :       &quot;I like to collect rock albums&quot;,</p> <p>&quot;interests&quot;:  [ &quot;music&quot; ]</p> <p>}</p> <p>修改方式(partial update)：</p> <p>POST /lib/user/2/_update</p> <p>{</p> <p>​    &quot;doc&quot;:{</p> <p>​       &quot;age&quot;:26</p> <p>​     }</p> <p>}</p> <p>删除文档：标记为deleted，随着数据量的增加，es会选择合适的时间删除掉</p> <h3 id="_3-11-基于groovy脚本执行partial-update"><a href="#_3-11-基于groovy脚本执行partial-update" class="header-anchor">#</a> 3.11 基于groovy脚本执行partial update</h3> <p>es有内置的脚本支持，可以基于groovy脚本实现复杂的操作</p> <p>1.修改年龄</p> <p>POST /lib/user/4/_update</p> <p>{</p> <p>&quot;script&quot;: &quot;ctx._source.age+=1&quot;</p> <p>}</p> <p>2.修改名字</p> <p>POST /lib/user/4/_update</p> <p>{</p> <p>&quot;script&quot;: &quot;ctx._source.last_name+='hehe'&quot;</p> <p>}</p> <p>3.添加爱好</p> <p>POST /lib/user/4/_update</p> <p>{</p> <p>&quot;script&quot;: {</p> <p>​    &quot;source&quot;: &quot;ctx._source.interests.add(params.tag)&quot;,</p> <p>​    &quot;params&quot;: {</p> <p>​      &quot;tag&quot;:&quot;picture&quot;</p> <p>​    }</p> <p>}</p> <p>}</p> <p>4.删除爱好</p> <p>POST /lib/user/4/_update</p> <p>{</p> <p>&quot;script&quot;: {</p> <p>​    &quot;source&quot;: &quot;ctx._source.interests.remove(ctx._source.interests.indexOf(params.tag))&quot;,</p> <p>​    &quot;params&quot;: {</p> <p>​      &quot;tag&quot;:&quot;picture&quot;</p> <p>​    }</p> <p>}</p> <p>}</p> <p>5.删除文档</p> <p>POST /lib/user/4/_update</p> <p>{</p> <p>&quot;script&quot;: {</p> <p>​    &quot;source&quot;: &quot;ctx.op=ctx._source.age==params.count?'delete':'none'&quot;,</p> <p>​    &quot;params&quot;: {</p> <p>​        &quot;count&quot;:29</p> <p>​    }</p> <p>}</p> <p>}</p> <p>6.upsert</p> <p>POST /lib/user/4/_update</p> <p>{</p> <p>&quot;script&quot;: &quot;ctx._source.age += 1&quot;,</p> <p>&quot;upsert&quot;: {</p> <p>​     &quot;first_name&quot; : &quot;Jane&quot;,</p> <p>​     &quot;last_name&quot; :   &quot;Lucy&quot;,</p> <p>​     &quot;age&quot; :  20,</p> <p>​     &quot;about&quot; :       &quot;I like to collect rock albums&quot;,</p> <p>​     &quot;interests&quot;:  [ &quot;music&quot; ]</p> <p>}</p> <p>}</p> <h3 id="_3-12-partial-update-处理并发冲突"><a href="#_3-12-partial-update-处理并发冲突" class="header-anchor">#</a> 3.12 partial update 处理并发冲突</h3> <p>使用的是乐观锁:_version</p> <p>retry_on_conflict:</p> <p>POST /lib/user/4/_update?retry_on_conflict=3</p> <p>重新获取文档数据和版本信息进行更新，不断的操作，最多操作的次数就是retry_on_conflict的值</p> <h3 id="_3-13-文档数据路由原理解析"><a href="#_3-13-文档数据路由原理解析" class="header-anchor">#</a> 3.13 文档数据路由原理解析</h3> <p>1.文档路由到分片上：</p> <p>一个索引由多个分片构成，当添加(删除，修改)一个文档时，es就需要决定这个文档存储在哪个分片上，这个过程就称为数据路由(routing)</p> <p>2.路由算法：</p> <p>​     shard=hash(routing) % number_of_pirmary_shards</p> <p>示例：一个索引，3个primary shard</p> <p>(1)每次增删改查时，都有一个routing值，默认是文档的_id的值</p> <p>(2)对这个routing值使用哈希函数进行计算</p> <p>(3)计算出的值再和主分片个数取余数</p> <p>余数肯定在0---（number_of_pirmary_shards-1）之间，文档就在对应的shard上</p> <p>routing值默认是文档的_id的值，也可以手动指定一个值，手动指定对于负载均衡以及提高批量读取的性能都有帮助</p> <p>3.primary shard个数一旦确定就不能修改了</p> <h3 id="_3-14-文档增删改内部原理"><a href="#_3-14-文档增删改内部原理" class="header-anchor">#</a> 3.14 文档增删改内部原理</h3> <p>1:发送增删改请求时，可以选择任意一个节点，该节点就成了协调节点(coordinating node)</p> <p>2.协调节点使用路由算法进行路由，然后将请求转到primary shard所在节点，该节点处理请求，并把数据同步到它的replica shard</p> <p>3.协调节点对客户端做出响应</p> <h3 id="_3-15-写一致性原理和quorum机制"><a href="#_3-15-写一致性原理和quorum机制" class="header-anchor">#</a> 3.15 写一致性原理和quorum机制</h3> <p>1.任何一个增删改操作都可以跟上一个参数</p> <p>consistency</p> <p>可以给该参数指定的值：</p> <p>one: (primary shard)只要有一个primary shard是活跃的就可以执行</p> <p>all: (all shard)所有的primary shard和replica shard都是活跃的才能执行</p> <p>quorum: (default) 默认值，大部分shard是活跃的才能执行 （例如共有6个shard，至少有3个shard是活跃的才能执行写操作）</p> <p>2.quorum机制：多数shard都是可用的，</p> <p>int((primary+number_of_replica)/2)+1</p> <p>例如：3个primary shard，1个replica</p> <p>int((3+1)/2)+1=3</p> <p>至少3个shard是活跃的</p> <p>注意：可能出现shard不能分配齐全的情况</p> <p>比如：1个primary shard,1个replica</p> <p>int((1+1)/2)+1=2</p> <p>但是如果只有一个节点，因为primary shard和replica shard不能在同一个节点上，所以仍然不能执行写操作</p> <p>再举例：1个primary shard,3个replica,2个节点</p> <p>int((1+3)/2)+1=3</p> <p>最后:当活跃的shard的个数没有达到要求时，</p> <p>es默认会等待一分钟，如果在等待的期间活跃的shard的个数没有增加，则显示timeout</p> <p>put /index/type/id?timeout=60s</p> <h3 id="_3-16-文档查询内部原理"><a href="#_3-16-文档查询内部原理" class="header-anchor">#</a> 3.16 文档查询内部原理</h3> <p>第一步：查询请求发给任意一个节点，该节点就成了coordinating node，该节点使用路由算法算出文档所在的primary shard</p> <p>第二步：协调节点把请求转发给primary shard也可以转发给replica shard(使用轮询调度算法(Round-Robin Scheduling，把请求平均分配至primary shard 和replica shard)</p> <p>第三步：处理请求的节点把结果返回给协调节点，协调节点再返回给应用程序</p> <p>特殊情况：请求的文档还在建立索引的过程中，primary shard上存在，但replica shar上不存在，但是请求被转发到了replica shard上，这时就会提示找不到文档</p> <h3 id="_3-17-bulk批量操作的json格式解析"><a href="#_3-17-bulk批量操作的json格式解析" class="header-anchor">#</a> 3.17 bulk批量操作的json格式解析</h3> <p>bulk的格式：</p> <p>{action:{metadata}}n</p> <p>{requstbody}\n</p> <p>为什么不使用如下格式：</p> <p>[{</p> <p>&quot;action&quot;: {</p> <p>},</p> <p>&quot;data&quot;: {</p> <p>}</p> <p>}]</p> <p>这种方式可读性好，但是内部处理就麻烦了：</p> <p>1.将json数组解析为JSONArray对象，在内存中就需要有一份json文本的拷贝，另外还有一个JSONArray对象。</p> <p>2.解析json数组里的每个json，对每个请求中的document进行路由</p> <p>3.为路由到同一个shard上的多个请求，创建一个请求数组</p> <p>4.将这个请求数组序列化</p> <p>5.将序列化后的请求数组发送到对应的节点上去</p> <p>耗费更多内存，增加java虚拟机开销</p> <p>1.不用将其转换为json对象，直接按照换行符切割json，内存中不需要json文本的拷贝</p> <p>2.对每两个一组的json，读取meta，进行document路由</p> <p>3.直接将对应的json发送到node上去</p> <h3 id="_3-18-查询结果分析"><a href="#_3-18-查询结果分析" class="header-anchor">#</a> 3.18 查询结果分析</h3> <p>{</p> <p>&quot;took&quot;: 419,</p> <p>&quot;timed_out&quot;: false,</p> <p>&quot;_shards&quot;: {</p> <p>​    &quot;total&quot;: 3,</p> <p>​    &quot;successful&quot;: 3,</p> <p>​    &quot;skipped&quot;: 0,</p> <p>​    &quot;failed&quot;: 0</p> <p>},</p> <p>&quot;hits&quot;: {</p> <p>​    &quot;total&quot;: 3,</p> <p>​    &quot;max_score&quot;: 0.6931472,</p> <p>​    &quot;hits&quot;: [</p> <p>​      {</p> <p>​        &quot;_index&quot;: &quot;lib3&quot;,</p> <p>​        &quot;_type&quot;: &quot;user&quot;,</p> <p>​        &quot;_id&quot;: &quot;3&quot;,</p> <p>​        &quot;_score&quot;: 0.6931472,</p> <p>​        &quot;_source&quot;: {</p> <p>​          &quot;address&quot;: &quot;bei jing hai dian qu qing he zhen&quot;,</p> <p>​          &quot;name&quot;: &quot;lisi&quot;</p> <p>​        }</p> <p>​      },</p> <p>​      {</p> <p>​        &quot;_index&quot;: &quot;lib3&quot;,</p> <p>​        &quot;_type&quot;: &quot;user&quot;,</p> <p>​        &quot;_id&quot;: &quot;2&quot;,</p> <p>​        &quot;_score&quot;: 0.47000363,</p> <p>​        &quot;_source&quot;: {</p> <p>​          &quot;address&quot;: &quot;bei jing hai dian qu qing he zhen&quot;,</p> <p>​          &quot;name&quot;: &quot;zhaoming&quot;</p> <p>​        }</p> <p>​      }</p> <p>​</p> <p>took：查询耗费的时间，单位是毫秒</p> <p>_shards：共请求了多少个shard</p> <p>total：查询出的文档总个数</p> <p>max_score： 本次查询中，相关度分数的最大值，文档和此次查询的匹配度越高，_score的值越大，排位越靠前</p> <p>hits：默认查询前10个文档</p> <p>timed_out：</p> <p>GET /lib3/user/_search?timeout=10ms</p> <p>{</p> <p>​    &quot;_source&quot;: [&quot;address&quot;,&quot;name&quot;],</p> <p>​    &quot;query&quot;: {</p> <p>​        &quot;match&quot;: {</p> <p>​            &quot;interests&quot;: &quot;changge&quot;</p> <p>​        }</p> <p>​    }</p> <p>}</p> <h3 id="_3-19-多index-多type查询模式"><a href="#_3-19-多index-多type查询模式" class="header-anchor">#</a> 3.19 多index，多type查询模式</h3> <p>GET _search</p> <p>GET /lib/_search</p> <p>GET /lib,lib3/_search</p> <p>GET /*3,*4/_search</p> <p>GET /lib/user/_search</p> <p>GET /lib,lib4/user,items/_search</p> <p>GET /_all/_search</p> <p>GET /_all/user,items/_search</p> <h3 id="_3-20-分页查询中的deep-paging问题"><a href="#_3-20-分页查询中的deep-paging问题" class="header-anchor">#</a> 3.20 分页查询中的deep paging问题</h3> <p>GET /lib3/user/_search</p> <p>{</p> <p>​    &quot;from&quot;:0,</p> <p>​    &quot;size&quot;:2,</p> <p>​    &quot;query&quot;:{</p> <p>​        &quot;terms&quot;:{</p> <p>​            &quot;interests&quot;: [&quot;hejiu&quot;,&quot;changge&quot;]</p> <p>​        }</p> <p>​    }</p> <p>}</p> <p>GET /_search?from=0&amp;size=3</p> <p>deep paging:查询的很深，比如一个索引有三个primary shard，分别存储了6000条数据，我们要得到第100页的数据(每页10条)，类似这种情况就叫deep paging</p> <p>如何得到第100页的10条数据？</p> <p>在每个shard中搜索990到999这10条数据，然后用这30条数据排序，排序之后取10条数据就是要搜索的数据，这种做法是错的，因为3个shard中的数据的_score分数不一样，可能这某一个shard中第一条数据的_score分数比另一个shard中第1000条都要高，所以在每个shard中搜索990到999这10条数据然后排序的做法是不正确的。</p> <p>正确的做法是每个shard把0到999条数据全部搜索出来（按排序顺序），然后全部返回给coordinate node，由coordinate node按_score分数排序后，取出第100页的10条数据，然后返回给客户端。</p> <p>deep paging性能问题</p> <p>1.耗费网络带宽，因为搜索过深的话，各shard要把数据传送给coordinate node，这个过程是有大量数据传递的，消耗网络，</p> <p>2.消耗内存，各shard要把数据传送给coordinate node，这个传递回来的数据，是被coordinate node保存在内存中的，这样会大量消耗内存。</p> <p>3.消耗cpu coordinate node要把传回来的数据进行排序，这个排序过程很消耗cpu.</p> <p>鉴于deep paging的性能问题，所以应尽量减少使用。</p> <h3 id="_3-21-query-string查询及copy-to解析"><a href="#_3-21-query-string查询及copy-to解析" class="header-anchor">#</a> 3.21 query string查询及copy_to解析</h3> <p>GET /lib3/user/_search?q=interests:changge</p> <p>GET /lib3/user/_search?q=+interests:changge</p> <p>GET /lib3/user/_search?q=-interests:changge</p> <p>copy_to字段是把其它字段中的值，以空格为分隔符组成一个大字符串，然后被分析和索引，但是不存储，也就是说它能被查询，但不能被取回显示。</p> <p>注意:copy_to指向的字段字段类型要为：text</p> <p>当没有指定field时，就会从copy_to字段中查询</p> <p>GET /lib3/user/_search?q=changge</p> <h3 id="_3-22字符串排序问题"><a href="#_3-22字符串排序问题" class="header-anchor">#</a> 3.22字符串排序问题</h3> <p>对一个字符串类型的字段进行排序通常不准确，因为已经被分词成多个词条了</p> <p>解决方式：对字段索引两次，一次索引分词（用于搜索），一次索引不分词(用于排序)</p> <p>GET /lib3/_search</p> <p>GET /lib3/user/_search</p> <p>{</p> <p>&quot;query&quot;: {</p> <p>​    &quot;match_all&quot;: {}</p> <p>},</p> <p>&quot;sort&quot;: [</p> <p>​    {</p> <p>​      &quot;interests&quot;: {</p> <p>​        &quot;order&quot;: &quot;desc&quot;</p> <p>​      }</p> <p>​    }</p> <p>]</p> <p>}</p> <p>GET /lib3/user/_search</p> <p>{</p> <p>&quot;query&quot;: {</p> <p>​    &quot;match_all&quot;: {}</p> <p>},</p> <p>&quot;sort&quot;: [</p> <p>​    {</p> <p>​      &quot;interests.raw&quot;: {</p> <p>​        &quot;order&quot;: &quot;asc&quot;</p> <p>​      }</p> <p>​    }</p> <p>]</p> <p>}</p> <p>DELETE lib3</p> <p>PUT /lib3</p> <p>{</p> <p>​    &quot;settings&quot;:{</p> <p>​        &quot;number_of_shards&quot; : 3,</p> <p>​        &quot;number_of_replicas&quot; : 0</p> <p>​      },</p> <p>​     &quot;mappings&quot;:{</p> <p>​      &quot;user&quot;:{</p> <p>​        &quot;properties&quot;:{</p> <p>​            &quot;name&quot;: {&quot;type&quot;:&quot;text&quot;},</p> <p>​            &quot;address&quot;: {&quot;type&quot;:&quot;text&quot;},</p> <p>​            &quot;age&quot;: {&quot;type&quot;:&quot;integer&quot;},</p> <p>​            &quot;birthday&quot;: {&quot;type&quot;:&quot;date&quot;},</p> <p>​            &quot;interests&quot;: {</p> <p>​                &quot;type&quot;:&quot;text&quot;,</p> <p>​                &quot;fields&quot;: {</p> <p>​                  &quot;raw&quot;:{</p> <p>​                     &quot;type&quot;: &quot;keyword&quot;</p> <p>​                   }</p> <p>​                },</p> <p>​                &quot;fielddata&quot;: true</p> <p>​             }</p> <p>​          }</p> <p>​        }</p> <p>​     }</p> <p>}</p> <h3 id="_3-23-如何计算相关度分数"><a href="#_3-23-如何计算相关度分数" class="header-anchor">#</a> 3.23 如何计算相关度分数</h3> <p>使用的是TF/IDF算法(Term Frequency&amp;Inverse Document Frequency)</p> <p>1.Term Frequency:我们查询的文本中的词条在document本中出现了多少次，出现次数越多，相关度越高</p> <p>搜索内容： hello world</p> <p>Hello，I love china.</p> <p>Hello world,how are you!</p> <p>2.Inverse Document Frequency：我们查询的文本中的词条在索引的所有文档中出现了多少次，出现的次数越多，相关度越低</p> <p>搜索内容：hello world</p> <p>hello，what are you doing?</p> <p>I like the world.</p> <p>hello 在索引的所有文档中出现了500次，world出现了100次</p> <p>3.Field-length(字段长度归约) norm:field越长，相关度越低</p> <p>搜索内容：hello world</p> <p>{&quot;title&quot;:&quot;hello,what's your name?&quot;,&quot;content&quot;:{&quot;owieurowieuolsdjflk&quot;}}</p> <p>{&quot;title&quot;:&quot;hi,good morning&quot;,&quot;content&quot;:{&quot;lkjkljkj.......world&quot;}}</p> <p>查看分数是如何计算的：</p> <p>GET /lib3/user/_search?explain=true</p> <p>{</p> <p>​    &quot;query&quot;:{</p> <p>​        &quot;match&quot;:{</p> <p>​            &quot;interests&quot;: &quot;duanlian,changge&quot;</p> <p>​        }</p> <p>​    }</p> <p>}</p> <p>查看一个文档能否匹配上某个查询：</p> <p>GET /lib3/user/2/_explain</p> <p>{</p> <p>​    &quot;query&quot;:{</p> <p>​        &quot;match&quot;:{</p> <p>​            &quot;interests&quot;: &quot;duanlian,changge&quot;</p> <p>​        }</p> <p>​    }</p> <p>}</p> <h3 id="_3-24-doc-values-解析"><a href="#_3-24-doc-values-解析" class="header-anchor">#</a> 3.24 Doc Values 解析</h3> <p>DocValues其实是Lucene在构建倒排索引时，会额外建立一个有序的正排索引(基于document =&gt; field value的映射列表)</p> <p>{&quot;birthday&quot;:&quot;1985-11-11&quot;,age:23}</p> <p>{&quot;birthday&quot;:&quot;1989-11-11&quot;,age:29}</p> <p>document     age       birthday</p> <p>doc1         23         1985-11-11</p> <p>doc2         29         1989-11-11</p> <p>存储在磁盘上，节省内存</p> <p>对排序，分组和一些聚合操作能够大大提升性能</p> <p>注意：默认对不分词的字段是开启的，对分词字段无效（需要把fielddata设置为true）</p> <p>PUT /lib3</p> <p>{</p> <p>​    &quot;settings&quot;:{</p> <p>​    &quot;number_of_shards&quot; : 3,</p> <p>​    &quot;number_of_replicas&quot; : 0</p> <p>​    },</p> <p>​     &quot;mappings&quot;:{</p> <p>​      &quot;user&quot;:{</p> <p>​        &quot;properties&quot;:{</p> <p>​            &quot;name&quot;: {&quot;type&quot;:&quot;text&quot;},</p> <p>​            &quot;address&quot;: {&quot;type&quot;:&quot;text&quot;},</p> <p>​            &quot;age&quot;: {</p> <p>​              &quot;type&quot;:&quot;integer&quot;,</p> <p>​              &quot;doc_values&quot;:false</p> <p>​            },</p> <p>​            &quot;interests&quot;: {&quot;type&quot;:&quot;text&quot;},</p> <p>​            &quot;birthday&quot;: {&quot;type&quot;:&quot;date&quot;}</p> <p>​        }</p> <p>​      }</p> <p>​     }</p> <p>}</p> <h3 id="_3-25-基于scroll技术滚动搜索大量数据"><a href="#_3-25-基于scroll技术滚动搜索大量数据" class="header-anchor">#</a> 3.25 基于scroll技术滚动搜索大量数据</h3> <p>如果一次性要查出来比如10万条数据，那么性能会很差，此时一般会采取用scoll滚动查询，一批一批的查，直到所有数据都查询完为止。</p> <p>1.scoll搜索会在第一次搜索的时候，保存一个当时的视图快照，之后只会基于该旧的视图快照提供数据搜索，如果这个期间数据变更，是不会让用户看到的</p> <p>2.采用基于_doc(不使用_score)进行排序的方式，性能较高</p> <p>3.每次发送scroll请求，我们还需要指定一个scoll参数，指定一个时间窗口，每次搜索请求只要在这个时间窗口内能完成就可以了</p> <p>GET /lib3/user/_search?scroll=1m</p> <p>{</p> <p>&quot;query&quot;: {</p> <p>​    &quot;match_all&quot;: {}</p> <p>},</p> <p>&quot;sort&quot;:[&quot;_doc&quot;],</p> <p>&quot;size&quot;:3</p> <p>}</p> <p>GET /_search/scroll</p> <p>{</p> <p>&quot;scroll&quot;: &quot;1m&quot;,</p> <p>&quot;scroll_id&quot;: &quot;DnF1ZXJ5VGhlbkZldGNoAwAAAAAAAAAdFkEwRENOVTdnUUJPWVZUd1p2WE5hV2cAAAAAAAAAHhZBMERDTlU3Z1FCT1lWVHdadlhOYVdnAAAAAAAAAB8WQTBEQ05VN2dRQk9ZVlR3WnZYTmFXZw==&quot;</p> <p>}</p> <h3 id="_3-26-dynamic-mapping策略"><a href="#_3-26-dynamic-mapping策略" class="header-anchor">#</a> 3.26 dynamic mapping策略</h3> <p><strong>dynamic</strong>:</p> <p>1.true:遇到陌生字段就 dynamic mapping</p> <p>2.false:遇到陌生字段就忽略</p> <p>3.strict:约到陌生字段就报错</p> <p>PUT /lib8</p> <p>{</p> <p>​    &quot;settings&quot;:{</p> <p>​    &quot;number_of_shards&quot; : 3,</p> <p>​    &quot;number_of_replicas&quot; : 0</p> <p>​    },</p> <p>​     &quot;mappings&quot;:{</p> <p>​      &quot;user&quot;:{</p> <p>​        &quot;dynamic&quot;:strict,</p> <p>​        &quot;properties&quot;:{</p> <p>​            &quot;name&quot;: {&quot;type&quot;:&quot;text&quot;},</p> <p>​            &quot;address&quot;:{</p> <p>​                &quot;type&quot;:&quot;object&quot;,</p> <p>​                &quot;dynamic&quot;:true</p> <p>​            },</p> <p>​        }</p> <p>​      }</p> <p>​     }</p> <p>}</p> <p>#会报错</p> <p>PUT  /lib8/user/1</p> <p>{</p> <p>&quot;name&quot;:&quot;lisi&quot;,</p> <p>&quot;age&quot;:20,</p> <p>&quot;address&quot;:{</p> <p>​    &quot;province&quot;:&quot;beijing&quot;,</p> <p>​    &quot;city&quot;:&quot;beijing&quot;</p> <p>}</p> <p>}</p> <p><strong>date_detection</strong>:默认会按照一定格式识别date，比如yyyy-MM-dd</p> <p>可以手动关闭某个type的date_detection</p> <p>PUT /lib8</p> <p>{</p> <p>​    &quot;settings&quot;:{</p> <p>​    &quot;number_of_shards&quot; : 3,</p> <p>​    &quot;number_of_replicas&quot; : 0</p> <p>​    },</p> <p>​     &quot;mappings&quot;:{</p> <p>​      &quot;user&quot;:{</p> <p>​        &quot;date_detection&quot;: false,</p> <p>​        }</p> <p>​    }</p> <p>}</p> <p><strong>定制 dynamic mapping template(type)</strong></p> <p>PUT /my_index</p> <p>{</p> <p>&quot;mappings&quot;: {</p> <p>​    &quot;my_type&quot;: {</p> <p>​      &quot;dynamic_templates&quot;: [</p> <p>​        {</p> <p>​          &quot;en&quot;: {</p> <p>​            &quot;match&quot;: &quot;*_en&quot;,</p> <p>​            &quot;match_mapping_type&quot;: &quot;string&quot;,</p> <p>​            &quot;mapping&quot;: {</p> <p>​              &quot;type&quot;: &quot;text&quot;,</p> <p>​              &quot;analyzer&quot;: &quot;english&quot;</p> <p>​            }</p> <p>​          }</p> <p>​        }</p> <p>​      ]</p> <p>​     }</p> <p>}</p> <p>}</p> <p>#使用了模板</p> <p>PUT /my_index/my_type/3</p> <p>{</p> <p>&quot;title_en&quot;: &quot;this is my dog&quot;</p> <p>}</p> <p>#没有使用模板</p> <p>PUT /my_index/my_type/5</p> <p>{</p> <p>&quot;title&quot;: &quot;this is my cat&quot;</p> <p>}</p> <p>GET my_index/my_type/_search</p> <p>{</p> <p>&quot;query&quot;: {</p> <p>​    &quot;match&quot;: {</p> <p>​      &quot;title&quot;: &quot;is&quot;</p> <p>​    }</p> <p>}</p> <p>}</p> <h3 id="_3-27重建索引"><a href="#_3-27重建索引" class="header-anchor">#</a> 3.27重建索引</h3> <p>一个field的设置是不能修改的，如果要修改一个field，那么应该重新按照新的mapping，建立一个index，然后将数据批量查询出来，重新用bulk api写入到index中。</p> <p>批量查询的时候，建议采用scroll api，并且采用多线程并发的方式来reindex数据，每次scroll就查询指定日期的一段数据，交给一个线程即可。</p> <p>PUT /index1/type1/4</p> <p>{</p> <p>&quot;content&quot;:&quot;1990-12-12&quot;</p> <p>}</p> <p>GET /index1/type1/_search</p> <p>GET /index1/type1/_mapping</p> <p>#报错</p> <p>PUT /index1/type1/4</p> <p>{</p> <p>&quot;content&quot;:&quot;I am very happy.&quot;</p> <p>}</p> <p>#修改content的类型为string类型,报错，不允许修改</p> <p>PUT /index1/_mapping/type1</p> <p>{</p> <p>&quot;properties&quot;: {</p> <p>​    &quot;content&quot;:{</p> <p>​      &quot;type&quot;: &quot;text&quot;</p> <p>​    }</p> <p>}</p> <p>}</p> <p>#创建一个新的索引，把index1索引中的数据查询出来导入到新的索引中</p> <p>#但是应用程序使用的是之前的索引，为了不用重启应用程序，给index1这个索引起个#别名</p> <p>PUT /index1/_alias/index2</p> <p>#创建新的索引，把content的类型改为字符串</p> <p>PUT /newindex</p> <p>{</p> <p>&quot;mappings&quot;: {</p> <p>​    &quot;type1&quot;:{</p> <p>​      &quot;properties&quot;: {</p> <p>​        &quot;content&quot;:{</p> <p>​          &quot;type&quot;: &quot;text&quot;</p> <p>​        }</p> <p>​      }</p> <p>​    }</p> <p>}</p> <p>}</p> <p>#使用scroll批量查询</p> <p>GET /index1/type1/_search?scroll=1m</p> <p>{</p> <p>&quot;query&quot;: {</p> <p>​    &quot;match_all&quot;: {}</p> <p>},</p> <p>&quot;sort&quot;: [&quot;_doc&quot;],</p> <p>&quot;size&quot;: 2</p> <p>}</p> <p>#使用bulk批量写入新的索引</p> <p>POST /_bulk</p> <p>{&quot;index&quot;:{&quot;_index&quot;:&quot;newindex&quot;,&quot;_type&quot;:&quot;type1&quot;,&quot;_id&quot;:1}}</p> <p>{&quot;content&quot;:&quot;1982-12-12&quot;}</p> <p>#将别名index2和新的索引关联，应用程序不用重启</p> <p>POST /_aliases</p> <p>{</p> <p>&quot;actions&quot;: [</p> <p>​    {&quot;remove&quot;: {&quot;index&quot;:&quot;index1&quot;,&quot;alias&quot;:&quot;index2&quot;}},</p> <p>​    {&quot;add&quot;: {&quot;index&quot;: &quot;newindex&quot;,&quot;alias&quot;: &quot;index2&quot;}}</p> <p>]</p> <p>}</p> <p>GET index2/type1/_search</p> <h3 id="_3-28-索引不可变的原因"><a href="#_3-28-索引不可变的原因" class="header-anchor">#</a> 3.28 索引不可变的原因</h3> <p>倒排索引包括：</p> <p>文档的列表，文档的数量，词条在每个文档中出现的次数，出现的位置，每个文档的长度，所有文档的平均长度</p> <p>索引不变的原因：</p> <p>不需要锁，提升了并发性能</p> <p>可以一直保存在缓存中（filter）</p> <p>节省cpu和io开销</p> <h2 id="elasticsearch分布式原理"><a href="#elasticsearch分布式原理" class="header-anchor">#</a> Elasticsearch分布式原理</h2> <h3 id="_1、单机服务有哪些问题"><a href="#_1、单机服务有哪些问题" class="header-anchor">#</a> 1、单机服务有哪些问题</h3> <p>单机服务性能有限</p> <p>可用性差</p> <p>维护不便</p> <h3 id="_2、分布式的好处"><a href="#_2、分布式的好处" class="header-anchor">#</a> 2、分布式的好处</h3> <p>高可用性：集群可容忍部分节点宕机而保持服务的可用性和数据的完整性</p> <p>易扩展：当集群的性能不满足业务要求时，可以方便快速的扩容集群，而无需停止服务。</p> <p>高性能：集群通过负载均衡器分摊并发请求压力，可以大大提高集群的吞吐能力和并发能力。-</p> <h3 id="_3、集群环境选择"><a href="#_3、集群环境选择" class="header-anchor">#</a> 3、集群环境选择</h3> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/elastic/%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2.png" alt=""></p> <p>集群理论知识学习，侧重原理，因此选择本地多节点部署，根据自己情况可选择单项目启动或者多项目启动，区别在基础课程中已经讲解，不再赘述。</p> <h4 id="核心配置"><a href="#核心配置" class="header-anchor">#</a> 核心配置</h4> <ul><li>cluster.name: 集群名称，唯一确定一个集群。</li> <li>node.name：节点名称，一个集群中的节点名称是唯一固定的，不同节点不能同名。</li> <li>node.master: 主节点属性值</li> <li>node.data: 数据节点属性值</li> <li>network.host： 本节点的绑定ip，及提供服务的ip地址</li> <li>http.port: 本节点的http端口</li> <li>transport.port：9300——集群之间通信的端口，若不指定默认：9300</li> <li>discovery.seed_hosts: 节点发现需要配置一些种子节点，与7.X之前老版本：disvoery.zen.ping.unicast.hosts类似，一般配置集群中的全部节点</li> <li>cluster.initial_master_nodes：指定集群初次选举中用到的具有主节点资格的节点，称为集群引导，只在第一次形成集群时需要。</li></ul> <h4 id="可执行以下命令启动一个9节点集群"><a href="#可执行以下命令启动一个9节点集群" class="header-anchor">#</a> 可执行以下命令启动一个9节点集群</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>./elasticsearch <span class="token parameter variable">-Ecluster.name</span><span class="token operator">=</span>msb_cluster <span class="token parameter variable">-Enode.name</span><span class="token operator">=</span>node1 <span class="token parameter variable">-Enode.roles</span><span class="token operator">=</span>master <span class="token parameter variable">-Epath.data</span><span class="token operator">=</span><span class="token punctuation">..</span>/node1/data <span class="token parameter variable">-Epath.logs</span><span class="token operator">=</span><span class="token punctuation">..</span>/node1/logs <span class="token parameter variable">-Ehttp.port</span><span class="token operator">=</span><span class="token number">9201</span> <span class="token parameter variable">-Etransport.port</span><span class="token operator">=</span><span class="token number">9301</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-Ediscovery.seed_hosts</span><span class="token operator">=</span>localhost:9301,localhost:9302,localhost:9303,localhost:9304,localhost:9305,localhost:9306,localhost:9307,localhost:9308,localhost:9309 <span class="token parameter variable">-Ecluster.initial_master_nodes</span><span class="token operator">=</span>node1,node2,node3
./elasticsearch <span class="token parameter variable">-Ecluster.name</span><span class="token operator">=</span>msb_cluster <span class="token parameter variable">-Enode.name</span><span class="token operator">=</span>node2 <span class="token parameter variable">-Enode.roles</span><span class="token operator">=</span>master <span class="token parameter variable">-Epath.data</span><span class="token operator">=</span><span class="token punctuation">..</span>/node2/data <span class="token parameter variable">-Epath.logs</span><span class="token operator">=</span><span class="token punctuation">..</span>/node2/logs <span class="token parameter variable">-Ehttp.port</span><span class="token operator">=</span><span class="token number">9202</span> <span class="token parameter variable">-Etransport.port</span><span class="token operator">=</span><span class="token number">9302</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-Ediscovery.seed_hosts</span><span class="token operator">=</span>localhost:9301,localhost:9302,localhost:9303,localhost:9304,localhost:9305,localhost:9306,localhost:9307,localhost:9308,localhost:9309 <span class="token parameter variable">-Ecluster.initial_master_nodes</span><span class="token operator">=</span>node1,node2,node3
./elasticsearch <span class="token parameter variable">-Ecluster.name</span><span class="token operator">=</span>msb_cluster <span class="token parameter variable">-Enode.name</span><span class="token operator">=</span>node3 <span class="token parameter variable">-Enode.roles</span><span class="token operator">=</span>master <span class="token parameter variable">-Epath.data</span><span class="token operator">=</span><span class="token punctuation">..</span>/node3/data <span class="token parameter variable">-Epath.logs</span><span class="token operator">=</span><span class="token punctuation">..</span>/node3/logs <span class="token parameter variable">-Ehttp.port</span><span class="token operator">=</span><span class="token number">9203</span> <span class="token parameter variable">-Etransport.port</span><span class="token operator">=</span><span class="token number">9303</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-Ediscovery.seed_hosts</span><span class="token operator">=</span>localhost:9301,localhost:9302,localhost:9303,localhost:9304,localhost:9305,localhost:9306,localhost:9307,localhost:9308,localhost:9309 <span class="token parameter variable">-Ecluster.initial_master_nodes</span><span class="token operator">=</span>node1,node2,node3
./elasticsearch <span class="token parameter variable">-Ecluster.name</span><span class="token operator">=</span>msb_cluster <span class="token parameter variable">-Enode.name</span><span class="token operator">=</span>node4 <span class="token parameter variable">-Enode.roles</span><span class="token operator">=</span>data <span class="token parameter variable">-Epath.data</span><span class="token operator">=</span><span class="token punctuation">..</span>/node4/data <span class="token parameter variable">-Epath.logs</span><span class="token operator">=</span><span class="token punctuation">..</span>/node4/logs <span class="token parameter variable">-Ehttp.port</span><span class="token operator">=</span><span class="token number">9204</span> <span class="token parameter variable">-Etransport.port</span><span class="token operator">=</span><span class="token number">9304</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-Ediscovery.seed_hosts</span><span class="token operator">=</span>localhost:9301,localhost:9302,localhost:9303,localhost:9304,localhost:9305,localhost:9306,localhost:9307,localhost:9308,localhost:9309
./elasticsearch <span class="token parameter variable">-Ecluster.name</span><span class="token operator">=</span>msb_cluster <span class="token parameter variable">-Enode.name</span><span class="token operator">=</span>node5 <span class="token parameter variable">-Enode.roles</span><span class="token operator">=</span>data <span class="token parameter variable">-Epath.data</span><span class="token operator">=</span><span class="token punctuation">..</span>/node5/data <span class="token parameter variable">-Epath.logs</span><span class="token operator">=</span><span class="token punctuation">..</span>/node5/logs <span class="token parameter variable">-Ehttp.port</span><span class="token operator">=</span><span class="token number">9205</span> <span class="token parameter variable">-Etransport.port</span><span class="token operator">=</span><span class="token number">9305</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-Ediscovery.seed_hosts</span><span class="token operator">=</span>localhost:9301,localhost:9302,localhost:9303,localhost:9304,localhost:9305,localhost:9306,localhost:9307,localhost:9308,localhost:9309
./elasticsearch <span class="token parameter variable">-Ecluster.name</span><span class="token operator">=</span>msb_cluster <span class="token parameter variable">-Enode.name</span><span class="token operator">=</span>node6 <span class="token parameter variable">-Enode.roles</span><span class="token operator">=</span>data <span class="token parameter variable">-Epath.data</span><span class="token operator">=</span><span class="token punctuation">..</span>/node6/data <span class="token parameter variable">-Epath.logs</span><span class="token operator">=</span><span class="token punctuation">..</span>/node6/logs <span class="token parameter variable">-Ehttp.port</span><span class="token operator">=</span><span class="token number">9206</span> <span class="token parameter variable">-Etransport.port</span><span class="token operator">=</span><span class="token number">9306</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-Ediscovery.seed_hosts</span><span class="token operator">=</span>localhost:9301,localhost:9302,localhost:9303,localhost:9304,localhost:9305,localhost:9306,localhost:9307,localhost:9308,localhost:9309
./elasticsearch <span class="token parameter variable">-Ecluster.name</span><span class="token operator">=</span>msb_cluster <span class="token parameter variable">-Enode.name</span><span class="token operator">=</span>node7 <span class="token parameter variable">-Enode.roles</span><span class="token operator">=</span>data <span class="token parameter variable">-Epath.data</span><span class="token operator">=</span><span class="token punctuation">..</span>/node7/data <span class="token parameter variable">-Epath.logs</span><span class="token operator">=</span><span class="token punctuation">..</span>/node7/logs <span class="token parameter variable">-Ehttp.port</span><span class="token operator">=</span><span class="token number">9207</span> <span class="token parameter variable">-Etransport.port</span><span class="token operator">=</span><span class="token number">9307</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-Ediscovery.seed_hosts</span><span class="token operator">=</span>localhost:9301,localhost:9302,localhost:9303,localhost:9304,localhost:9305,localhost:9306,localhost:9307,localhost:9308,localhost:9309
./elasticsearch <span class="token parameter variable">-Ecluster.name</span><span class="token operator">=</span>msb_cluster <span class="token parameter variable">-Enode.name</span><span class="token operator">=</span>node8 <span class="token parameter variable">-Enode.roles</span><span class="token operator">=</span>data <span class="token parameter variable">-Epath.data</span><span class="token operator">=</span><span class="token punctuation">..</span>/node8/data <span class="token parameter variable">-Epath.logs</span><span class="token operator">=</span><span class="token punctuation">..</span>/node8/logs <span class="token parameter variable">-Ehttp.port</span><span class="token operator">=</span><span class="token number">9208</span> <span class="token parameter variable">-Etransport.port</span><span class="token operator">=</span><span class="token number">9308</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-Ediscovery.seed_hosts</span><span class="token operator">=</span>localhost:9301,localhost:9302,localhost:9303,localhost:9304,localhost:9305,localhost:9306,localhost:9307,localhost:9308,localhost:9309
./elasticsearch <span class="token parameter variable">-Ecluster.name</span><span class="token operator">=</span>msb_cluster <span class="token parameter variable">-Enode.name</span><span class="token operator">=</span>node9 <span class="token parameter variable">-Enode.roles</span><span class="token operator">=</span>data <span class="token parameter variable">-Epath.data</span><span class="token operator">=</span><span class="token punctuation">..</span>/node9/data <span class="token parameter variable">-Epath.logs</span><span class="token operator">=</span><span class="token punctuation">..</span>/node9/logs <span class="token parameter variable">-Ehttp.port</span><span class="token operator">=</span><span class="token number">9209</span> <span class="token parameter variable">-Etransport.port</span><span class="token operator">=</span><span class="token number">9309</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-Ediscovery.seed_hosts</span><span class="token operator">=</span>localhost:9301,localhost:9302,localhost:9303,localhost:9304,localhost:9305,localhost:9306,localhost:9307,localhost:9308,localhost:9309
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="开发模式和生产模式"><a href="#开发模式和生产模式" class="header-anchor">#</a> 开发模式和生产模式</h4> <ul><li><strong>开发模式</strong>：开发模式是默认配置（未配置集群发现设置），如果用户只是出于学习目的，而引导检查会把很多用户挡在门外，所以ES提供了一个设置项discovery.type=single-node。此项配置为指定节点为单节点发现以绕过引导检查。</li> <li><strong>生产模式</strong>：当用户修改了有关集群的相关配置会触发生产模式，在生产模式下，服务启动会触发ES的引导检查或者叫启动检查（bootstrap checks）（或者叫启动检查），所谓引导检查就是在服务启动之前对一些重要的配置项进行检查，检查其配置值是否是合理的。引导检查包括对JVM大小、内存锁、虚拟内存、最大线程数、集群发现相关配置等相关的检查，如果某一项或者几项的配置不合理，ES会拒绝启动服务，并且在开发模式下的某些警告信息会升级成错误信息输出。引导检查十分严格，之所以宁可拒绝服务也要阻止用户启动服务是为了防止用户在对ES的基本使用不了解的前提下启动服务而导致的后期性能问题无法解决或者解决起来很麻烦。因为一旦服务以某种不合理的配置启动，时间久了之后可能会产生较大的性能问题，但此时集群已经变得难以维护，ES为了避免这种情况而做出了引导检查的设置。这种设定虽然增加了用户的使用门槛，但是避免了日后产生更大的问题</li></ul> <h4 id="单节点模式"><a href="#单节点模式" class="header-anchor">#</a> 单节点模式</h4> <p>单节点启动，节点会选举自己成为active master节点，会绕过引导检查。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">discovery.type</span><span class="token punctuation">:</span> single<span class="token punctuation">-</span>node
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="引导检查-bootstrap-checks"><a href="#引导检查-bootstrap-checks" class="header-anchor">#</a> 引导检查—Bootstrap Checks</h4> <p>在启用生产模式时，节点启动之前ES会自动对节点的相关配置逐项检查，目的是避免开发者在对其配置项不了解的前提下做出不合理的配置。如果配置不符合性能或者兼容性要求，ES会阻止服务启动以保证服务的性能和可用性。</p> <p>检查项：</p> <ul><li><strong>堆大小检查</strong></li> <li><strong>文件描述符检查</strong></li> <li><strong>内存锁检查</strong></li> <li><strong>最大线程数检查</strong></li> <li><strong>最大文件大小检查</strong></li> <li>虚拟内存检查</li> <li>文件系统映射数检查</li> <li>客户端JVM检查</li> <li>串行收集器检查</li> <li>系统调用过滤器检查</li> <li>OnError和OnOOMError检查</li> <li>早期访问检查</li> <li>所有权限检查</li> <li><strong>发现配置检查</strong></li></ul> <h3 id="_4、主从模式"><a href="#_4、主从模式" class="header-anchor">#</a> 4、主从模式</h3> <p>Elasticsearch为什么使用主从模式（Leader/Follower）？Elasticsearch使用的主从架构模式，其实除此之外，还可以使用分布式哈希表（DHT），其区别在于：</p> <ul><li>主从模式适合节点数量不多，并且节点的状态改变（加入集群或者离开集群）不频繁的情况。</li> <li>分布式哈希表支持每小时数千个节点的加入或离开，响应约为4-10跳。</li></ul> <p>ES的应用场景一般来说单个集群中一般不会有太多节点（一般来说不超过一千个），节点的数量远远小于单个节点（只的是主节点）所能维护的连接数。并且通常主节点不必经常处理节点的加入和离开，处于相对稳定的对等网络中，因此使用主从模式。</p> <h3 id="_5、节点"><a href="#_5、节点" class="header-anchor">#</a> 5、节点</h3> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/elastic/Master%E9%80%89%E4%B8%BE.jpg" alt=""></p> <h4 id="候选节点-投票节点-master-eligible-有时候也叫master节点"><a href="#候选节点-投票节点-master-eligible-有时候也叫master节点" class="header-anchor">#</a> 候选节点/投票节点（master-eligible，有时候也叫master节点）</h4> <p>默认情况下，master-eligible节点是那些在集群状态发布期间参与选举并执行某些任务的节点，配置了master角色的节点都是有效的投票节点，可以参与选举也可以投票</p> <p>硬件要求：</p> <p>CPU：高</p> <p>内存：高</p> <p>网络：高</p> <p>存储：高</p> <hr> <h4 id="仅投票节点"><a href="#仅投票节点" class="header-anchor">#</a> 仅投票节点</h4> <p>配置了master和voting_only角色的节点将成为仅投票节点，仅投票节点虽然也是候选节点，但是在选举过程中仅可以投票而不参与竞选。不过仅投票节点可以同时也是数据节点，这样的话，其不具备被选举为Master的资格，但是参与投票，可以在选举过程中发挥关键票的作用。</p> <p>硬件要求：</p> <p>CPU：高</p> <p>内存：低</p> <p>网络：高</p> <p>存储：高</p> <hr> <h4 id="主节点-active-master"><a href="#主节点-active-master" class="header-anchor">#</a> 主节点（active master）</h4> <ul><li>避免重负载：主节点负责轻量级集群范围的操作，例如创建或删除索引、跟踪哪些节点是集群的一部分以及决定将哪些分片分配给哪些节点。拥有一个稳定的主节点对于集群健康很重要。当选的主节点拥有履行其职责所需的资源，这对于集群的健康非常重要。如果所选的主节点承载了其他任务，那么集群将不能很好地运行。避免 master 被其他任务超载的最可靠方法是将所有符合 master 的节点配置为仅具有 master 角色的专用 master 节点，使它们能够专注于管理集群。专用master节点仍将充当协调节点，将请求从客户端路由到集群中的其他节点，但是不要以负载均衡器的目的而设置候选节点。</li> <li>一般来说，如果小型或轻负载集群的主节点具有其他角色和职责，则其可能运行良好，但是一旦您的集群包含多个节点，使用专用的主节点通常是有意义的。</li> <li>任何不是<code>voting-only</code>的<code>master-eligible</code>节点都可以被选举为<code>active master</code>。</li> <li>主节点必须有一个<code>path.data</code>目录，其内容在重启后仍然存在，就像数据节点一样，因为这是存储集群元数据的地方。集群元数据描述了如何读取存储在数据节点上的数据，因此如果丢失，则无法读取存储在数据节点上的数据。</li> <li>高可用性 (HA) 集群需要至少三个候选节点，其中至少两个不是仅投票节点。这样即使其中一个节点发生故障，也可以保证剩下的节点能够选举出一个主节点。</li></ul> <p>硬件要求：</p> <p>CPU：高</p> <p>内存：高</p> <p>网络：高</p> <p>存储：高 但是无需 大</p> <hr> <h4 id="数据节点"><a href="#数据节点" class="header-anchor">#</a> 数据节点</h4> <p>数据节点保存包含已编入索引的文档的分片。数据节点处理数据相关操作，如 CRUD、搜索和聚合。这些操作是 I/O 密集型、内存密集型和 CPU 密集型的。监控这些资源并在它们过载时添加更多数据节点非常重要。</p> <p>硬件要求：</p> <p>CPU：高</p> <p>内存：高</p> <p>网络：高</p> <p>存储：速度快、容量大</p> <hr> <h4 id="协调节点"><a href="#协调节点" class="header-anchor">#</a> 协调节点</h4> <ul><li>如果主动关闭了master、data和ingest的角色配置，当前节点就剩下一个只能路由请求、处理搜索减少阶段和分发批量索引功能的<strong>仅协调节点</strong>。本质上，仅协调节点的就相当于一个智能负载均衡器。换句话说，你是没有办法配置一个不具备协调转发能力的节点的。</li> <li>仅协调节点过多会增加集群负担，因为主节更新集群状态必须等待每个节点的确认，而仅协调节点从这个角度上讲纯粹是一种负担。数据节点可以愉快地完成转发任务。</li></ul> <h3 id="_6、es常见模块-mudules"><a href="#_6、es常见模块-mudules" class="header-anchor">#</a> 6、ES常见模块：Mudules</h3> <h4 id="cluster"><a href="#cluster" class="header-anchor">#</a> Cluster</h4> <p>Cluster模块是Master节点执行集群管理的封装实现，管理集群状态，维护集群级（除了集群级，还有索引级分片级等级别）的配置信息。其主要功能包括：</p> <ul><li>管理集群状态，将新生成的集群状态发布到集群的所有节点</li> <li>调用allocation模块执行分片分配感知，决策分片分配行为</li> <li>在集群各个节点直接迁移分片，保证数据平衡，shard rebalance</li></ul> <h4 id="allocation"><a href="#allocation" class="header-anchor">#</a> Allocation</h4> <p>此模块是实现了对节点分片的分配感知策略，新节点加入离开、动态扩容都需要分片分配感知，此模块由主节点调用，常见的使用场景如：跨机架强制感知实现高可用，冷热集群架构设计等。</p> <h4 id="bootstrap"><a href="#bootstrap" class="header-anchor">#</a> Bootstrap</h4> <p>引导检查模块，不再赘述</p> <h4 id="ingest"><a href="#ingest" class="header-anchor">#</a> Ingest</h4> <p>预处理模块负责数据索引之前的一些预操作，比如数据类型处理、数据的结构转换等，很多场景下课替代logstash处理管道消息，Elastic认证考试考点之一。</p> <h4 id="monitor"><a href="#monitor" class="header-anchor">#</a> Monitor</h4> <p>监控功能提供了一种方式来了解 Elasticsearch 集群的运行状况和性能</p> <h4 id="discovery"><a href="#discovery" class="header-anchor">#</a> Discovery</h4> <p>发现模块负责管理如发现集群中新加入的节点，或者节点退出之后将状态信息移除，起作用类似于ZooKeeper。发现木块是用于elasticsearch和的内置发现模块 默认值。它提供单播发现，但可以扩展到 支持云环境和其他形式的发现</p> <h4 id="gateway"><a href="#gateway" class="header-anchor">#</a> Gateway</h4> <p>负责说对收到Master广播下来的集群状态数据的持久化存储，并在集群完全重启时恢复他们</p> <h4 id="indices"><a href="#indices" class="header-anchor">#</a> Indices</h4> <p>索引模块管理全局级索引配置，不包括索引级及索引以下级。集群启动阶段需要主副本分片恢复就是在这个模块完成的</p> <h4 id="http"><a href="#http" class="header-anchor">#</a> HTTP</h4> <p>HTTP模块允许通过JSON over HTTP的方式访问ES的API，HTTP模块本质上是完全异步的，这一位置没有阻塞线程等待响应。使用异步通信进行HTTP的好处是解决了C10k的问题。</p> <h4 id="transport"><a href="#transport" class="header-anchor">#</a> Transport</h4> <p>传输模块用于集群内部节点通信。传输模块使用TCP协议，每个节点都与其他节点维持若干个TCP长连接，通信本质也是完全异步的。</p> <h3 id="_7、分片-shard"><a href="#_7、分片-shard" class="header-anchor">#</a> 7、分片：Shard</h3> <p>Shard即数据分片，是ES的数据载体。在ES中数据分为primary shard（主分片）和replica shard（副本分片），每一个primary承载单个索引的一部分数据，分布于各个节点，replica为某个primary的副本，即备份。分片分配的原则是尽量均匀的分配在集群中的各个节点，以最大程度降低部分shard在出现意外时对整个集群乃至服务造成的影响。</p> <p>每个分片就是一个Lucene的实例，具有完整的功能。</p> <h4 id="_7-1-分片创建策略"><a href="#_7-1-分片创建策略" class="header-anchor">#</a> 7.1 分片创建策略</h4> <p>分片产生的目的是为了实现分布式，而分布式的好处之一就是实现“高可用性”（还包括高性能如提高吞吐量等会再后面内容展开讲），分片的分配策略极大程度上都是围绕如何提高可用性而来的，如<strong>分片分配感知</strong>、<strong>强制感知</strong>等。</p> <p>互联网开发没有“银弹”，分片的数量分配也没有适用于所有场景的最佳值，创建分片策略的最佳方法是使用您在生产中看到的相同查询和索引负载在生产硬件上对生产数据进行基准测试。分片的分配策略主要从两个指标来衡量：即数量和单个分片的大小。</p> <h5 id="_7-1-1-分片分配策略"><a href="#_7-1-1-分片分配策略" class="header-anchor">#</a> 7.1.1 分片分配策略</h5> <ul><li>ES使用数据分片（shard）来提高服务的可用性，将数据分散保存在不同的节点上以降低当单个节点发生故障时对数据完整性的影响，同时使用副本（repiica）来保证数据的完整性。关于分片的默认分配策略，在7.x之前，默认5个primary shard，每个primary shard默认分配一个replica，即5主1副，而7.x之后，默认1主1副</li> <li>ES在分配单个索引的分片时会将每个分片尽可能分配到更多的节点上。但是，实际情况取决于集群拥有的分片和索引的数量以及它们的大小，不一定总是能均匀地分布。</li> <li>Paimary只能在索引创建时配置数量，而replica可以在任何时间分配，并且primary支持读和写操作，而replica只支持客户端的读取操作，数据由es自动管理，从primary同步。</li> <li>ES不允许Primary和它的Replica放在同一个节点中，并且同一个节点不接受完全相同的两个Replica</li> <li>同一个节点允许多个索引的分片同时存在。</li></ul> <h5 id="_7-1-2-分片的数量"><a href="#_7-1-2-分片的数量" class="header-anchor">#</a> 7.1.2 分片的数量</h5> <ul><li><strong>避免分片过多</strong>：大多数搜索会命中多个分片。每个分片在单个 CPU 线程上运行搜索。虽然分片可以运行多个并发搜索，但跨大量分片的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-threadpool.html" target="_blank" rel="noopener noreferrer">搜索<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>会耗尽节点的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-threadpool.html" target="_blank" rel="noopener noreferrer">搜索线程池<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这会导致低吞吐量和缓慢的搜索速度。</li> <li><strong>分片越少越好</strong>：每个分片都使用内存和 CPU 资源。在大多数情况下，一小组大分片比许多小分片使用更少的资源。</li></ul> <h5 id="_7-1-3-分片的大小决策"><a href="#_7-1-3-分片的大小决策" class="header-anchor">#</a> 7.1.3 分片的大小决策</h5> <ul><li><strong>分片的合理容量</strong>：10GB-50GB。虽然不是硬性限制，但 10GB 到 50GB 之间的分片往往效果很好。根据网络和用例，也许可以使用更大的分片。在索引的生命周期管理中，一般设置50GB为单个索引的最大阈值。</li> <li><strong>堆内存容量和分片数量的关联</strong>：小于20分片/每GB堆内存，一个节点可以容纳的分片数量与节点的堆内存成正比。例如，一个拥有 30GB 堆内存的节点最多应该有 600 个分片。如果节点超过每 GB 20 个分片，考虑添加另一个节点。</li></ul> <p>查询当前节点堆内存大小：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET _cat/nodes?v=<span class="token boolean">true</span>&amp;h=heap.current
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>避免重负载节点：如果分配给特定节点的分片过多，会造成当前节点为<strong>重负载节点</strong></li></ul> <h4 id="_7-2-重要的配置"><a href="#_7-2-重要的配置" class="header-anchor">#</a> 7.2 重要的配置</h4> <h5 id="_7-2-1-自定义属性"><a href="#_7-2-1-自定义属性" class="header-anchor">#</a> 7.2.1 自定义属性</h5> <div class="language- line-numbers-mode"><pre class="language-text"><code>node.attr.{attribute}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如何查看节点属性？</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET _cat/nodeattrs?v
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="_7-2-2-索引级配置"><a href="#_7-2-2-索引级配置" class="header-anchor">#</a> 7.2.2 索引级配置</h5> <ul><li>index.routing.allocation.include.{attribute}：表示索引可以分配在包含多个值中其中一个的节点上。</li> <li>index.routing.allocation.require.{attribute}：表示索引要分配在包含索引指定值的节点上（通常一般设置一个值）。</li> <li>index.routing.allocation.exclude.{attribute}：表示索引只能分配在不包含所有指定值的节点上。</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">//索引创建之前执行</span>
PUT &lt;index_name&gt;
<span class="token punctuation">{</span>
  <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;number_of_shards&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token property">&quot;number_of_replicas&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;index.routing.allocation.include._name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node1&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h5 id="_7-2-3-集群级配置"><a href="#_7-2-3-集群级配置" class="header-anchor">#</a> 7.2.3 集群级配置</h5> <p>elasticsearch修改集群范围设置提供两种方式，</p> <ul><li>persistent：永久性修改，persistent相关的修改保存在了<code>/path.data/cluster.name/nodes/0/_state/global-n.st</code>，如果想删除设置，删除此文件即可。</li> <li>transient：集群重启后失效。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>PUT _cluster/settings
{
  &quot;persistent&quot;: {
    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;rack_id&quot;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_7-3-索引分片分配-index-shard-allocation"><a href="#_7-3-索引分片分配-index-shard-allocation" class="header-anchor">#</a> 7.3 索引分片分配：Index Shard Allocation</h4> <h5 id="_7-2-1-分片均衡策略-shard-rebalance"><a href="#_7-2-1-分片均衡策略-shard-rebalance" class="header-anchor">#</a> 7.2.1 分片均衡策略：shard rebalance</h5> <p>当集群在每个节点上具有相同数量的分片而没有集中在任何节点上的任何索引的分片时，集群是平衡的。Elasticsearch 运行一个称为<strong>rebalancing</strong> 的自动过程，它在集群中的节点之间移动分片以改善其平衡。重新平衡遵循所有其他分片分配规则，例如<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-cluster.html#cluster-shard-allocation-filtering" target="_blank" rel="noopener noreferrer">分配过滤<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-cluster.html#forced-awareness" target="_blank" rel="noopener noreferrer">强制意识<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，这可能会阻止它完全平衡集群。在这种情况下，重新平衡会努力在您配置的规则内实现最平衡的集群。如果您使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/data-tiers.html" target="_blank" rel="noopener noreferrer">数据层<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>然后 Elasticsearch 会自动应用分配过滤规则将每个分片放置在适当的层中。这些规则意味着平衡器在每一层内独立工作。</p> <p><strong>cluster.routing.rebalance.enable</strong></p> <p>(<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/settings.html#dynamic-cluster-setting" target="_blank" rel="noopener noreferrer">动态<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>) 为特定类型的分片启用或禁用重新平衡：</p> <ul><li><code>all</code> -（默认）允许对所有类型的分片进行分片平衡。</li> <li><code>primaries</code> - 只允许主分片的分片平衡。</li> <li><code>replicas</code> - 仅允许对副本分片进行分片平衡。</li> <li><code>none</code> - 任何索引都不允许进行任何类型的分片平衡。</li></ul> <p><strong>cluster.routing.allocation.allow_rebalance</strong></p> <p>(<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/settings.html#dynamic-cluster-setting" target="_blank" rel="noopener noreferrer">动态<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>) 指定何时允许分片重新平衡：</p> <ul><li><code>always</code> - 始终允许重新平衡。</li> <li><code>indices_primaries_active</code> - 仅当集群中的所有主节点都已分配时。</li> <li><code>indices_all_active</code> -（默认）仅当集群中的所有分片（主分片和副本）都被分配时。</li></ul> <h5 id="_7-2-2-延迟分配策略-默认1m"><a href="#_7-2-2-延迟分配策略-默认1m" class="header-anchor">#</a> 7.2.2 延迟分配策略（默认1m）：</h5> <p>当节点出于任何原因（有意或无意）离开集群时，主节点会做出以下反应</p> <ul><li>将副本分片提升为主分片以替换节点上的任何主分片。</li> <li>分配副本分片以替换丢失的副本（假设有足够的节点）。</li> <li>在其余节点之间均匀地重新平衡分片。</li></ul> <p>这些操作旨在通过确保尽快完全复制每个分片来保护集群免受数据丢失。即使我们在<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.2/recovery.html" target="_blank" rel="noopener noreferrer">节点级别<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.2/shards-allocation.html" target="_blank" rel="noopener noreferrer">集群级别<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>限制并发恢复 ，这种“分片洗牌”仍然会给集群带来很多额外的负载，如果丢失的节点可能很快就会返回，这可能是不必要的</p> <h5 id="_7-2-3-分片过滤-即-shard-allocation-filtering-控制那个分片分配给哪个节点。"><a href="#_7-2-3-分片过滤-即-shard-allocation-filtering-控制那个分片分配给哪个节点。" class="header-anchor">#</a> 7.2.3 分片过滤：即（<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/shard-allocation-filtering.html" target="_blank" rel="noopener noreferrer">Shard allocation filtering<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），控制那个分片分配给哪个节点。</h5> <ul><li>index.routing.allocation.include.{attribute}：表示索引可以分配在包含多个值中其中一个的至少节点上。</li> <li>index.routing.allocation.require.{attribute}：表示索引要分配在包含索引指定值的节点上（通常一般设置一个值）。</li> <li>index.routing.allocation.exclude.{attribute}：表示索引只能分配在不包含所有指定值的节点上。</li></ul> <h4 id="_7-4-分片分配感知-shard-allocation-awareness"><a href="#_7-4-分片分配感知-shard-allocation-awareness" class="header-anchor">#</a> 7.4 分片分配感知：Shard Allocation Awareness</h4> <p>Shard Allocation Awareness的设计初衷是为了提高服务的可用性，通过自定义节点属性作为感知属性，让 Elasticsearch 在分配分片时将物理硬件配置考虑在内。如果 Elasticsearch 知道哪些节点位于同一物理服务器上、同一机架中或同一区域中，则它可以分离主副本分片，以最大程度地降低在发生故障时丢失数据的风险。</p> <h5 id="_7-4-1-启用分片感知策略"><a href="#_7-4-1-启用分片感知策略" class="header-anchor">#</a> 7.4.1 启用分片感知策略</h5> <p>配置节点属性</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>node.attr.rack_id: rack1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通过以下设置告诉主节点在分配分片的时候需要考虑哪些属性。这些信息会保存在每个候选节点的集群状态信息中</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>PUT _cluster/settings<span class="token punctuation">{</span>  <span class="token property">&quot;persistent&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">&quot;cluster.routing.allocation.awareness.attributes&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rack_id&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_7-5-强制感知策略-forced-awareness"><a href="#_7-5-强制感知策略-forced-awareness" class="header-anchor">#</a> 7.5 强制感知策略：Forced awareness</h4> <p>默认情况下，如果一个区域发生故障，Elasticsearch 会将所有故障的副本分片分配给其他区域。但是剩余区域可能没有足够的性能冗余来承载这些分片。</p> <p>为了防止在发生故障时单个位置过载，您可以设置为<code>cluster.routing.allocation.awareness.force</code>不分配副本，直到另一个位置的节点可用。</p> <h5 id="_7-5-1-部署强制感知策略"><a href="#_7-5-1-部署强制感知策略" class="header-anchor">#</a> 7.5.1 部署强制感知策略</h5> <p>设置强制感知策略，告诉主节点当前通过某个属性来划分区域，并且告知区域有哪些值</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cluster.routing.allocation.awareness.attributes: zonecluster.routing.allocation.awareness.force.zone.values: zone1,zone2 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_8、高可用性-★★★"><a href="#_8、高可用性-★★★" class="header-anchor">#</a> 8、高可用性 ★★★</h3> <p>高可用性即：High Availability（HA），高可用性是分布式系统架构设计的重要因素之一，简单来说，可用性越高的集群在发生意外情况（如断电、节点宕机）的时候，服务发生故障而不可用的可能性越低，也就是降低了意外情况而对整体服务产生的影响的可能性。</p> <h4 id="_8-1-高可用性原理"><a href="#_8-1-高可用性原理" class="header-anchor">#</a> 8.1 高可用性原理</h4> <ul><li>通过“分布式”的概念实现多个节点的负载均衡，并且使服务具备可扩展能力。</li> <li>通过针对分片、节点的一列策略降低单个故障点对整体服务产生的影响。</li> <li>通过<strong>容灾机制</strong>，尽可能把故障点还原，以恢复服务的最大可用性。</li></ul> <h4 id="_8-2-es的容灾机制"><a href="#_8-2-es的容灾机制" class="header-anchor">#</a> 8.2 ES的容灾机制</h4> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/elastic/ES%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6.jpg" alt=""></p> <p><strong>容错性</strong>可以理解系统容忍的局部发生异常情况的比率和当异常发生时自行恢复的能力。在<code>ES</code>中表现为对节点宕机的处理机制。</p> <p>步骤：</p> <ol><li><strong>Master选举</strong>：选出集群中的Leader。</li> <li>Replica容错：新的<code>Active Master</code>会将丢失的Primary的某个Replica提升为Primary。</li> <li>尝试恢复故障节点：Master尝试恢复故障节点。</li> <li>数据同步：Master将宕机期间丢失的数据同步到重启节点对应的分片上去，从而使服务恢复正常。</li></ol> <h4 id="_8-3-master节点和投票节点"><a href="#_8-3-master节点和投票节点" class="header-anchor">#</a> 8.3  Master节点和投票节点</h4> <h5 id="_8-3-1-主节点职责"><a href="#_8-3-1-主节点职责" class="header-anchor">#</a> 8.3.1 主节点职责</h5> <p>负责轻量级集群范围的操作，比如：</p> <ul><li>创建或删除索引</li> <li>规划和执行分片策略</li> <li>发布、修改集群状态</li></ul> <p>选择的主节点拥有履行其职责所需的资源，这对于集群的健康非常重要。如果选择的主节点被其他任务重载，那么集群将无法正常运行。避免主机因其他任务而过载的最可靠方法是将所有符合主机条件的节点配置为<code>dedicated master</code></p> <h5 id="_8-3-2-如何设置dedicated-master"><a href="#_8-3-2-如何设置dedicated-master" class="header-anchor">#</a> 8.3.2 如何设置<code>dedicated master</code></h5> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">node.roles</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> master <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="_8-3-3-投票节点"><a href="#_8-3-3-投票节点" class="header-anchor">#</a> 8.3.3 投票节点</h5> <p>每个候选节点默认有<strong>选举权</strong>和<strong>被选举权</strong>，称之为投票节点。投票节点可以参加Master竞选，同时也可以参加投票。</p> <p>但是有一种投票节点比较特殊，其只具备选举权而不具备被选举权，也就是“仅投票”节点，仅投票节点只能在Master选举过程中参与投票，而不能参加竞选。仅投票在某些场景下发挥着极其重要的作用：</p> <ul><li>当现有票数不足以选出Master的时候，充当决胜票。</li> <li>在小型集群中仅投票节点可同时作为数据节点避免资源浪费</li></ul> <h5 id="_8-3-4-如何配置仅投票节点"><a href="#_8-3-4-如何配置仅投票节点" class="header-anchor">#</a> 8.3.4 如何配置仅投票节点</h5> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">node.roles</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> master<span class="token punctuation">,</span> voting_only <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_8-4-高可用性集群"><a href="#_8-4-高可用性集群" class="header-anchor">#</a> 8.4 高可用性集群：</h4> <p>高可用性的中心思想就是采取一切可能的策略，降低集群中任意一部分节点出现问题后导致服务整体不可用的概率。其包含数据的完整性，集群的存活概率以及选主等。</p> <h5 id="_8-4-1-小规模集群"><a href="#_8-4-1-小规模集群" class="header-anchor">#</a> 8.4.1 小规模集群</h5> <ul><li><p>单节点集群：</p> <p>一般用于学习或者开发、测试环境，不推荐在生产环境中使用单节点集群。由于集群只有单个节点，为了适应这一点，ES默认会给集群分配所有角色。单节点角色不具备高可用性，并且无法分配副本分片。为了使集群保持健康，单节点模式下创建索引，需要使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/index-modules.html#dynamic-index-settings" target="_blank" rel="noopener noreferrer"><code>index.number_of_replicas</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>设置副本数量为0。</p></li> <li><p>两节点集群：</p> <ul><li>如果出于硬件成本考虑，集群中只允许有两个节点，那么一般来说最好把两个节点都设置成数据节点。您还应该通过设置索引确保每个分片都在两个节点上冗余存储。每个非可搜索快照索引上的<code>Number_of_replicas</code>为1。这是默认行为，但可能会被<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/index-templates.html" target="_blank" rel="noopener noreferrer">索引模板<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>覆盖。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/index-modules.html#dynamic-index-settings" target="_blank" rel="noopener noreferrer">Auto-expand replicas<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>也可以达到同样的效果，但是在这么小的集群中没有必要使用这个功能。</li> <li>推荐在两个节点之一设置<code>node.master: false</code>明确告知其不具备候选节点资格。目的是为了确定哪个节点是主节点。集群可以容忍另一个不具备候选资格的节点的丢失。如果不做此设置，这时两个节点都会具有候选资格，但是其中一个节点如果宕机，由于选主需要票数过半（票数&gt;N/2+1），也就是票数必须是两票才能选出active master，所以会导致无法选主。此时集群无法容忍任何一个节点宕机</li> <li>默认情况下，ES会为每个节点分配所有角色，如果手动分配角色，一般建议为每个节点分配所有角色，如果其中一个节点宕机，另一个节点可以取而代之。</li> <li>两个节点的集群，只允许其中一个固定的节点宕机，而不是任意一个节点。因为如果允许两个节点可以独立选举，那么如果集群由于网络或者其他原因导致节点连接断开，那么两个节点没办法确定另一个节点是否是宕机了，也就是会产生所谓的”脑裂“问题，而产生多主的情况。Elasticsearch 避免了这种情况并通过不选择任何一个节点作为主节点来保护数据，直到该节点可以确保它具有最新的集群状态并且集群中没有其他主节点。这可能导致集群在连接恢复之前没有主节点。</li></ul></li> <li><p>三节点集群 &lt;HA的最低配置&gt;：</p> <ul><li>三节点部署：如果整个集群中所有节点一共只有三个，建议把三个节点全部部署为数据节点和候选节点。虽然active master节点一般只负责轻量级任务不做数据节点。但是通常来说三节点集群一般不会承载很大的业务量，也就不必考虑那么多了。这也是处于成本考虑不得已而为之。三节点集群的容错能力是1，即允许一台节点故障。</li> <li>二加一部署：即两个候选节点，一个仅投票节点，若干数据节点。这种配置的最大好处就是在保证高可用的前提下性价比更高，适用于小规模集群。由于在避免脑裂的前提下，要选举出主节点的最小节点数量是3，也就是选主的必要条件是票数过半也就是2票。而候选节点一般是不负责其他的任务的，也就不会为其分配data角色，那么集群通常会出现三个节点不存放数据的局面。此时会产生造成资源浪费。因为<code>active master</code>只存在一个，另外两个master作为候选节点，在及群众仅仅是充当了负载均衡器。为了避免这种资源浪费，通常的做法是把其中一个候选节点设置为仅投票节点，即<code>node.roles: [ data, master, voting_only ]</code>，此时，当前节点在选举过程中，仅有选举权而没有被选举权，这样就可以同时给他分配数据节点的角色，因为其不会被选举为<code>active master</code>。三节点集群中，三个节点必须都具有<code>master</code>角色，并且仅投票节点最多只能有一个。仅投票节点由叫<code>仲裁节点</code>起着<code>决胜票</code>的作用。</li></ul></li> <li><p>多节点集群</p> <ul><li><p>一旦集群增长到三个以上的节点，可以开始根据它们的职责对这些节点做职责专一化。主要根据需要配置尽可能多的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-node.html#data-node" target="_blank" rel="noopener noreferrer">数据节点<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/ingest.html" target="_blank" rel="noopener noreferrer">预处理节点<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-node.html#ml-node" target="_blank" rel="noopener noreferrer">机器学习节点<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>等来均衡工作负载。随着集群变大，一般建议给每个角色使用专用节点，以便为每个任务独立扩展资源。</p> <p>但是，最好将集群中候选节点数量限制为三个。主节点不像其他节点类型那样扩展，因为集群总是只选择其中之一作为集群的主节点。如果有太多候选节点，那么主选举可能需要更长的时间才能完成。在较大的集群中，一般建议把候选节点设置为专用候选节点，即不分配其他角色，并避免向这些专用节点发送任何客户端请求。以免候选节点被不必要的额外工作所拖累导致集群服务不稳定。</p> <p>但是可以把候选节点之一配置为<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-node.html#voting-only-node" target="_blank" rel="noopener noreferrer">仅投票节点<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>以便它永远不会被选为主节点。例如，集群可能有两个专用的候选节点和一个既是数据节点又是仅投票的候选节点的第三个节点。这第三个仅投票节点将在Master选举中投出决胜票，但是自己永远不会被选举为active master。</p></li></ul></li></ul> <h5 id="_8-4-2-大规模集群"><a href="#_8-4-2-大规模集群" class="header-anchor">#</a> 8.4.2 大规模集群</h5> <ul><li>单集群
<ul><li>避免跨数据中心：ES对网络和宽带要求较高，并且一般来说要尽量避免服务跨多个数据中心。因为一旦遇到分区恢复问题，它必须重新同步任何丢失的数据并重新平衡集群。如果一定要跨多个数据中心，建议在每个数据中心部署独立集群，然后配置<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-cross-cluster-search.html" target="_blank" rel="noopener noreferrer">跨集群搜索<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>或<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/xpack-ccr.html" target="_blank" rel="noopener noreferrer">跨集群复制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li> <li>部署分片分配感知：为了降低当集群出现单个或区域节点（比如一个机架）宕机对整个服务造成的影响，一般策略是通过<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/allocation-awareness.html" target="_blank" rel="noopener noreferrer">分配感知来实现<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul></li> <li>双区集群：
<ul><li>如果集群部署在两个区域比如两个机房内，应该在每个区域中拥有不同数量的候选节点，这样在其中一个区域出现问题的时候，会增加另一个区域的存活概率。比如两个机房部署同一个集群，那么两个机房的候选节点避免相等，因为此时如果一个机房意外断电，两个机房的服务都会停止。配置单数投票节点可避免此问题。此时其中一个机房断电，服务可用的概率为50%。</li> <li>双区集群理论上能容忍一个区域的数据丢失，但不是任意一个区域，打个比方：服务部署在两个机房，机房A和机房B，要么是仅允许A机房出现故障而不允许B机房出现故障，也就是A机房断电服务可用，但是B机房断电服务中断；要么是仅允许B机房出现故障而不允许A机房出现故障，也就是B机房断电服务可用，但是A机房断电服务中断。从高可用的角度想，我们更希望任意一个机房断电，另一个机房的服务都不受影响，但是这是不可能的。因为没有断电的机房不知道出现故障的机房是断网了还是断电了，也就不知道应该是发起独立选举还是等待下去。如果两个机房都可以独立选主，那么就无法避免脑裂，可能会产生两个机房选出active master。解决办法是在两个区域中都配置一个仅投票节点并在独立的第三个区域添加一个额外的候选节点。这样两个区域其中之一断电，额外的投票节点就可以投出关键票。这个额外的节点也叫<code>专用tiebreaker</code>节点，此节点可以用低配服务器。</li></ul></li> <li>多区集群
<ul><li>如果集群中有三个区域，那么每个区域中应该有一个候选节点。如果集群包含三个以上的区域，那么应该选择其中的三个区域，并在这三个区域中的每一个区域中放置一个候选节点。这意味着即使其中一个区域发生故障，集群仍然可以选举主节点。</li></ul></li> <li>多集群
<ul><li>Elasticsearch是主从结构，主节点能管理的节点上线一般不超过一千个，如果继续增加节点，可能会导致active master不稳定，如果集群想突破集群规模带来的性能瓶颈，一般可配置多集群，利用跨集群搜索单个超大集群拆分成多个小集群（相对小，千节点级别）来完成对集群的性能扩展。</li></ul></li></ul> <h5 id="_8-4-3-总结"><a href="#_8-4-3-总结" class="header-anchor">#</a> 8.4.3 总结</h5> <ul><li>集群应该至少有两个区域包含数据节点。</li> <li>除了主分片之外，每个 不是<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/searchable-snapshots.html" target="_blank" rel="noopener noreferrer">可搜索快照索引的索引<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>都应该有每个主分片的至少一个副本。</li> <li>分片分配感知配置为避免将分片的所有副本集中在单个区域内。</li> <li>集群至少有三个候选节点。这些节点中至少有两个不是仅投票节点，均衡分配在至少三个区域中。</li> <li>客户端被配置为将其请求发送到多个区域中的节点，或者被配置为使用负载平衡器来平衡一组适当的节点之间的请求。</li></ul> <h3 id="_9、master选举-★★★★"><a href="#_9、master选举-★★★★" class="header-anchor">#</a> 9、Master选举 ★★★★</h3> <h4 id="_9-1-设计思路"><a href="#_9-1-设计思路" class="header-anchor">#</a> 9.1 设计思路</h4> <p>所有分布式系统都需要解决数据的一致性问题，处理这类问题一般采取两种策略：</p> <ul><li>避免数据不一致情况的发生</li> <li>定义数据不一致后的处理策略</li></ul> <p>分布式一致性解读：</p> <p>我们可以通过一个简单的例子解释：
假设我们有一个单节点系统，对于此示例，你可以认为我们的节点是一个只存储一个值的数据库服务器。我们还有一个客户端去向服务器发送存储的值，在单节点的时候，存的这个值很容易达成一致或者共识。但是，如果我们有多个节点，那么怎么达成共识呢？这就是分布式一致性的问题。</p> <h4 id="_9-2-es的选举算法"><a href="#_9-2-es的选举算法" class="header-anchor">#</a> 9.2 ES的选举算法</h4> <p>ES基于Bully和Paxos两种算法实现，而并非就是两种算法或之一。 ES 7.x 基于以上算法，加入了基于Raft的优化。</p> <ul><li>Bully：Bully是Leader选举的基本算法之一，基本原理就是按照节点ID进行排序，任何时候当前Leader的节点ID都是集群中最高节点ID。该算法非常易于实现但是当Leader处于不稳定状态的时候，如因负载过重而假死，此时可能会触发选主，选出第二大ID的节点为新的Leader。ES通过推迟选举直到Master失效（Master放弃Active Master资格触发选举）来解决问题，但是会产生双主或多主（也就是脑裂）问题。</li> <li>Paxos：Paxos非常强大，在选举方面的灵活性比Bully算法有很大的优势，但是其原理非常复杂。</li> <li>Raft：Raft是一种使用较为广泛的分布式一致性的协议，在Raft中，节点可能的状态有三种：
<ul><li>Leader：主节点</li> <li>Candidate：候选节点</li> <li>Follower：跟随节点</li></ul></li></ul> <p>所有的节点开始都是跟随节点。如果跟随节点收不89到领导节点的信号，则他们可以成为候选节点候选节点接着请求其他节点投票节点将以他们的投票回复候选节点如果候选节点获取到大多数节点的投票，则他将会成为领导节点此过程称为Leader选举。此时，所有对系统的修改将通过Leader节点进行。任意改变将以entry的形式添加到节点的日志中。这个日志的entry此时是没有提交的，所以，它不会更新节点的值。为了提交entry，节点首先会备份至跟随节点，然后leader等待，知直到多数节点将entry写入（自己的日志），此时Leader节点将提交entry，并且节点的数据被修改，接着Leader通知其他跟随者entry已经被提交了。此时集群的系统状态称为一致的。这个过程称为日志复制</p> <p>在Raft中有两个设置超时时间的地方去控制选举
<strong>选举超时</strong>：
此时间就是跟随节点等待Leader信号直到成为候选节点的时间。选举超时时间随机设置在150ms到300ms之间。当选举超时以后，跟随节点成为候选节点，然后为自己发起一轮新的选举，并且向其他节点发起投票请求。如果收到请求的节点本轮没有发出投票，则候选节点的投票。并且节点重置选举超时时间
一旦候选节点收到大多数投票，那么他将成为Leader。Leader开始对其他跟随节点发送追加entry的消息。这些消息按心跳超时指定的时间间隔发送。跟随节点接着响应每一个追加entry的消息。在选举任期持续直到跟随节点停止接收到心跳消息，并成为候选节点。
<strong>重新选举</strong>：
和Leader选举一样。要求大多数投票，保证了本期选举只能有一个Leader被选中。如果两个节点同时成为候选节点，则会发送分裂投票。
<strong>分裂投票</strong>：
两个节点在同一期间都开始选举，并且每个都在其他节点之前到达一个单一节点。此时，每个候选节点都有两票，并且本次投票无法再收到更多投票，则节点将等待新的选举并重试。</p> <h4 id="_9-3-几个重要概念"><a href="#_9-3-几个重要概念" class="header-anchor">#</a> 9.3 几个重要概念</h4> <h5 id="_9-3-1-候选节点与投票节点"><a href="#_9-3-1-候选节点与投票节点" class="header-anchor">#</a> 9.3.1 候选节点与投票节点</h5> <ul><li>**候选节点：**具备<code>master</code>角色的节点默认都有“被选举权”，即是一个候选节点。候选节点可以参与Master选举过程</li> <li>**投票节点：**每个候选节点默认都有投票权，即每个候选节点默认都是一个投票节点，但如果配置了“voting_only ”的候选节点将只有选举权而没有被选举权，即仅投票节点。</li></ul> <h5 id="_9-3-2-有效选票与法定票数"><a href="#_9-3-2-有效选票与法定票数" class="header-anchor">#</a> 9.3.2 有效选票与法定票数</h5> <ul><li><strong>有效选票</strong>：包括非候选节点的所有节点都会参与选举并参与投票，但是只有投票节点的投票才是有效投票。</li> <li><strong>法定票数</strong>：即当选Master所需的最小票数，可通过：discovery.zen.minimum_master_nodes配置，通常情况下法定票数为投票数过半（不包含一半）。为了避免平票而导致脑裂，一般候选节点数量一般设置为奇数，即便是偶数，系统默认也会阉割掉其中一个节点的投票权，以保证不出选平票或多主。</li></ul> <h4 id="_9-4-选举过程"><a href="#_9-4-选举过程" class="header-anchor">#</a> 9.4 选举过程</h4> <h5 id="_9-4-1-节点失效监测-faultdetection类"><a href="#_9-4-1-节点失效监测-faultdetection类" class="header-anchor">#</a> 9.4.1 节点失效监测：FaultDetection类</h5> <p>在源码的描述文件中有这样一段描述：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>There are two fault detection processes running. The first is by themaster, to ping all the other nodes in the cluster and verify that theyare alive. And on the other end, each node pings to master to verify ifits still alive or an election process needs to be initiated
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol><li>NodesFaultDetection：即NodesFD，用于定期检查集群中的节点是否存活。</li> <li>MasterFaultDetection：即MasterFD，作用是定期检查Master节点是否存活。</li></ol> <h4 id="_9-5-脑裂问题"><a href="#_9-5-脑裂问题" class="header-anchor">#</a> 9.5 脑裂问题：</h4> <ul><li>何为脑裂：双主或多主</li> <li>解决办法：discovery.zen.minimum_master_nodes=N/2+1，N为有效投票节点数。</li></ul> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/elastic/%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98.jpg" alt=""></p></div></div>  <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/371f2f/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">ElasticSearch指南</div></a> <a href="/pages/036417/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">ElasticSearch查询</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/371f2f/" class="prev">ElasticSearch指南</a></span> <span class="next"><a href="/pages/036417/">ElasticSearch查询</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/80365f/"><div>
            证券市场基本法律法规
            <!----></div></a> <span class="date">03-13</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/d9e4f4/"><div>
            证券考试规则
            <!----></div></a> <span class="date">03-12</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/cb2c17/"><div>
            金融市场基础知识
            <!----></div></a> <span class="date">03-12</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:cloudjava@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/bigdatajava" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/nylg" title="Gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2014-2025
    <span>wen chao | <a href="https://github.com/bigdatajava/blog-talk/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.af2629f3.js" defer></script><script src="/assets/js/2.c7acc05c.js" defer></script><script src="/assets/js/77.bb898521.js" defer></script>
  </body>
</html>

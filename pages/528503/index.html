<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>电商项目微服务网关整合授权中心实现单点登录 | wen chao</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3129839_xft6cqs5gc.css">
    <meta name="description" content="架构进阶之路...">
    <meta name="keywords" content="全栈博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,js,ES6,TypeScript,vue">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.877370ef.css" as="style"><link rel="preload" href="/assets/js/app.af2629f3.js" as="script"><link rel="preload" href="/assets/js/2.c7acc05c.js" as="script"><link rel="preload" href="/assets/js/261.74b1bebb.js" as="script"><link rel="prefetch" href="/assets/js/10.003809e3.js"><link rel="prefetch" href="/assets/js/100.05e6d7b0.js"><link rel="prefetch" href="/assets/js/101.aedcfb99.js"><link rel="prefetch" href="/assets/js/102.0f45ef0b.js"><link rel="prefetch" href="/assets/js/103.f6349067.js"><link rel="prefetch" href="/assets/js/104.159e4fea.js"><link rel="prefetch" href="/assets/js/105.cf376772.js"><link rel="prefetch" href="/assets/js/106.4a24f110.js"><link rel="prefetch" href="/assets/js/107.9130a4fc.js"><link rel="prefetch" href="/assets/js/108.557f1de3.js"><link rel="prefetch" href="/assets/js/109.0eae2c98.js"><link rel="prefetch" href="/assets/js/11.46d1f704.js"><link rel="prefetch" href="/assets/js/110.be00b9ae.js"><link rel="prefetch" href="/assets/js/111.454bc20b.js"><link rel="prefetch" href="/assets/js/112.c987bc96.js"><link rel="prefetch" href="/assets/js/113.f07c8b3c.js"><link rel="prefetch" href="/assets/js/114.ab099d7d.js"><link rel="prefetch" href="/assets/js/115.a5bda3c7.js"><link rel="prefetch" href="/assets/js/116.eb280ad8.js"><link rel="prefetch" href="/assets/js/117.1863722f.js"><link rel="prefetch" href="/assets/js/118.3f192a2d.js"><link rel="prefetch" href="/assets/js/119.66b89deb.js"><link rel="prefetch" href="/assets/js/12.03486813.js"><link rel="prefetch" href="/assets/js/120.69b1d465.js"><link rel="prefetch" href="/assets/js/121.113b1b5a.js"><link rel="prefetch" href="/assets/js/122.917086b7.js"><link rel="prefetch" href="/assets/js/123.ef1b72cd.js"><link rel="prefetch" href="/assets/js/124.a52fd442.js"><link rel="prefetch" href="/assets/js/125.65cf0d15.js"><link rel="prefetch" href="/assets/js/126.9257bcef.js"><link rel="prefetch" href="/assets/js/127.c080527e.js"><link rel="prefetch" href="/assets/js/128.90389431.js"><link rel="prefetch" href="/assets/js/129.582bff3e.js"><link rel="prefetch" href="/assets/js/13.ba8e34d1.js"><link rel="prefetch" href="/assets/js/130.fb170212.js"><link rel="prefetch" href="/assets/js/131.ed138ac9.js"><link rel="prefetch" href="/assets/js/132.4223d6f9.js"><link rel="prefetch" href="/assets/js/133.012411be.js"><link rel="prefetch" href="/assets/js/134.ed98c78a.js"><link rel="prefetch" href="/assets/js/135.2b6eb13f.js"><link rel="prefetch" href="/assets/js/136.65149943.js"><link rel="prefetch" href="/assets/js/137.341d7363.js"><link rel="prefetch" href="/assets/js/138.e9834544.js"><link rel="prefetch" href="/assets/js/139.ff517435.js"><link rel="prefetch" href="/assets/js/14.71b2ed4a.js"><link rel="prefetch" href="/assets/js/140.bf2b9d2d.js"><link rel="prefetch" href="/assets/js/141.ef8d876a.js"><link rel="prefetch" href="/assets/js/142.c28e6ef9.js"><link rel="prefetch" href="/assets/js/143.d0b43d89.js"><link rel="prefetch" href="/assets/js/144.9545dbb1.js"><link rel="prefetch" href="/assets/js/145.c5c5aca2.js"><link rel="prefetch" href="/assets/js/146.c6989cd8.js"><link rel="prefetch" href="/assets/js/147.fe16ad8a.js"><link rel="prefetch" href="/assets/js/148.102ea00d.js"><link rel="prefetch" href="/assets/js/149.2e62b9d1.js"><link rel="prefetch" href="/assets/js/15.1736a531.js"><link rel="prefetch" href="/assets/js/150.daf684ac.js"><link rel="prefetch" href="/assets/js/151.988a3ba9.js"><link rel="prefetch" href="/assets/js/152.4742bb74.js"><link rel="prefetch" href="/assets/js/153.02bcce99.js"><link rel="prefetch" href="/assets/js/154.ebde7923.js"><link rel="prefetch" href="/assets/js/155.c906862e.js"><link rel="prefetch" href="/assets/js/156.3b3d94d4.js"><link rel="prefetch" href="/assets/js/157.81d8c740.js"><link rel="prefetch" href="/assets/js/158.40095645.js"><link rel="prefetch" href="/assets/js/159.2abc32c5.js"><link rel="prefetch" href="/assets/js/16.fb9d3b9b.js"><link rel="prefetch" href="/assets/js/160.dfa13df3.js"><link rel="prefetch" href="/assets/js/161.5697eb79.js"><link rel="prefetch" href="/assets/js/162.fef5ab87.js"><link rel="prefetch" href="/assets/js/163.8b3dff03.js"><link rel="prefetch" href="/assets/js/164.826228d2.js"><link rel="prefetch" href="/assets/js/165.e0099d56.js"><link rel="prefetch" href="/assets/js/166.8294f6c0.js"><link rel="prefetch" href="/assets/js/167.d07b77dd.js"><link rel="prefetch" href="/assets/js/168.c23c0d7b.js"><link rel="prefetch" href="/assets/js/169.c7f7599b.js"><link rel="prefetch" href="/assets/js/17.e42188aa.js"><link rel="prefetch" href="/assets/js/170.b11ea482.js"><link rel="prefetch" href="/assets/js/171.73278046.js"><link rel="prefetch" href="/assets/js/172.040cd7fc.js"><link rel="prefetch" href="/assets/js/173.e0199ce5.js"><link rel="prefetch" href="/assets/js/174.3010733d.js"><link rel="prefetch" href="/assets/js/175.05c196ea.js"><link rel="prefetch" href="/assets/js/176.c490fc2b.js"><link rel="prefetch" href="/assets/js/177.7bcb888a.js"><link rel="prefetch" href="/assets/js/178.34093cd3.js"><link rel="prefetch" href="/assets/js/179.b2413571.js"><link rel="prefetch" href="/assets/js/18.383f6a09.js"><link rel="prefetch" href="/assets/js/180.9648ec05.js"><link rel="prefetch" href="/assets/js/181.342f0059.js"><link rel="prefetch" href="/assets/js/182.35eac70e.js"><link rel="prefetch" href="/assets/js/183.f4a83742.js"><link rel="prefetch" href="/assets/js/184.d82b8a96.js"><link rel="prefetch" href="/assets/js/185.9f5f32ef.js"><link rel="prefetch" href="/assets/js/186.600a4950.js"><link rel="prefetch" href="/assets/js/187.df953d4f.js"><link rel="prefetch" href="/assets/js/188.2491fa83.js"><link rel="prefetch" href="/assets/js/189.32d3c1a4.js"><link rel="prefetch" href="/assets/js/19.cb72d9a9.js"><link rel="prefetch" href="/assets/js/190.39ac92fc.js"><link rel="prefetch" href="/assets/js/191.3125fa77.js"><link rel="prefetch" href="/assets/js/192.7655632a.js"><link rel="prefetch" href="/assets/js/193.7f55a678.js"><link rel="prefetch" href="/assets/js/194.b9c56642.js"><link rel="prefetch" href="/assets/js/195.189fe681.js"><link rel="prefetch" href="/assets/js/196.71658166.js"><link rel="prefetch" href="/assets/js/197.af445c6a.js"><link rel="prefetch" href="/assets/js/198.1de2afd9.js"><link rel="prefetch" href="/assets/js/199.2c218726.js"><link rel="prefetch" href="/assets/js/20.0e9f2f72.js"><link rel="prefetch" href="/assets/js/200.26590f9f.js"><link rel="prefetch" href="/assets/js/201.36d7a8ea.js"><link rel="prefetch" href="/assets/js/202.6c36d934.js"><link rel="prefetch" href="/assets/js/203.d4ae9b00.js"><link rel="prefetch" href="/assets/js/204.c3b2f994.js"><link rel="prefetch" href="/assets/js/205.f480166b.js"><link rel="prefetch" href="/assets/js/206.90dc53ae.js"><link rel="prefetch" href="/assets/js/207.f959801b.js"><link rel="prefetch" href="/assets/js/208.5da4dac0.js"><link rel="prefetch" href="/assets/js/209.217e41a9.js"><link rel="prefetch" href="/assets/js/21.7a7c5c4f.js"><link rel="prefetch" href="/assets/js/210.fb1d985a.js"><link rel="prefetch" href="/assets/js/211.5a3d515c.js"><link rel="prefetch" href="/assets/js/212.bb654f9b.js"><link rel="prefetch" href="/assets/js/213.b8f5ac66.js"><link rel="prefetch" href="/assets/js/214.cfb1547f.js"><link rel="prefetch" href="/assets/js/215.a1de2fe7.js"><link rel="prefetch" href="/assets/js/216.d76003a4.js"><link rel="prefetch" href="/assets/js/217.ad201174.js"><link rel="prefetch" href="/assets/js/218.5adcad1a.js"><link rel="prefetch" href="/assets/js/219.9f3b9b01.js"><link rel="prefetch" href="/assets/js/22.b9540503.js"><link rel="prefetch" href="/assets/js/220.af64e5ad.js"><link rel="prefetch" href="/assets/js/221.379beb37.js"><link rel="prefetch" href="/assets/js/222.85aa5cd0.js"><link rel="prefetch" href="/assets/js/223.13475fe5.js"><link rel="prefetch" href="/assets/js/224.d06abfcb.js"><link rel="prefetch" href="/assets/js/225.1f738876.js"><link rel="prefetch" href="/assets/js/226.a09031a1.js"><link rel="prefetch" href="/assets/js/227.f6018b9a.js"><link rel="prefetch" href="/assets/js/228.ae3296e4.js"><link rel="prefetch" href="/assets/js/229.d9bcea85.js"><link rel="prefetch" href="/assets/js/23.6b5fd8ae.js"><link rel="prefetch" href="/assets/js/230.68a89532.js"><link rel="prefetch" href="/assets/js/231.b31aa02f.js"><link rel="prefetch" href="/assets/js/232.cc07d501.js"><link rel="prefetch" href="/assets/js/233.76443c50.js"><link rel="prefetch" href="/assets/js/234.5efbcd6a.js"><link rel="prefetch" href="/assets/js/235.dfcf36cf.js"><link rel="prefetch" href="/assets/js/236.4bb99856.js"><link rel="prefetch" href="/assets/js/237.79a22c20.js"><link rel="prefetch" href="/assets/js/238.1b592be7.js"><link rel="prefetch" href="/assets/js/239.a4c119aa.js"><link rel="prefetch" href="/assets/js/24.63372db7.js"><link rel="prefetch" href="/assets/js/240.22d7d47a.js"><link rel="prefetch" href="/assets/js/241.36336698.js"><link rel="prefetch" href="/assets/js/242.b7db4d20.js"><link rel="prefetch" href="/assets/js/243.f156bf47.js"><link rel="prefetch" href="/assets/js/244.14f3046b.js"><link rel="prefetch" href="/assets/js/245.984447ea.js"><link rel="prefetch" href="/assets/js/246.cd55bf13.js"><link rel="prefetch" href="/assets/js/247.d2a77b3d.js"><link rel="prefetch" href="/assets/js/248.c23e38fd.js"><link rel="prefetch" href="/assets/js/249.a0b42d1f.js"><link rel="prefetch" href="/assets/js/25.d3f99e2a.js"><link rel="prefetch" href="/assets/js/250.870b2e9a.js"><link rel="prefetch" href="/assets/js/251.ee8edd7f.js"><link rel="prefetch" href="/assets/js/252.15e2c05e.js"><link rel="prefetch" href="/assets/js/253.18d0fc46.js"><link rel="prefetch" href="/assets/js/254.39ecf5f7.js"><link rel="prefetch" href="/assets/js/255.d42ae6e7.js"><link rel="prefetch" href="/assets/js/256.5a2b4630.js"><link rel="prefetch" href="/assets/js/257.df147154.js"><link rel="prefetch" href="/assets/js/258.f42bcf46.js"><link rel="prefetch" href="/assets/js/259.022f92f9.js"><link rel="prefetch" href="/assets/js/26.c6b54266.js"><link rel="prefetch" href="/assets/js/260.abb07bf2.js"><link rel="prefetch" href="/assets/js/262.680edf56.js"><link rel="prefetch" href="/assets/js/263.0cdbe35a.js"><link rel="prefetch" href="/assets/js/264.ea699edd.js"><link rel="prefetch" href="/assets/js/265.cf168b25.js"><link rel="prefetch" href="/assets/js/266.18f03883.js"><link rel="prefetch" href="/assets/js/267.007dcd30.js"><link rel="prefetch" href="/assets/js/268.41de028b.js"><link rel="prefetch" href="/assets/js/269.e206560c.js"><link rel="prefetch" href="/assets/js/27.120b6069.js"><link rel="prefetch" href="/assets/js/270.164398a3.js"><link rel="prefetch" href="/assets/js/271.7d100757.js"><link rel="prefetch" href="/assets/js/272.0b83e5d3.js"><link rel="prefetch" href="/assets/js/273.f317bcb6.js"><link rel="prefetch" href="/assets/js/274.2947d9f0.js"><link rel="prefetch" href="/assets/js/275.e99b65f2.js"><link rel="prefetch" href="/assets/js/276.ea03cf89.js"><link rel="prefetch" href="/assets/js/277.93476fbc.js"><link rel="prefetch" href="/assets/js/278.db0ff8eb.js"><link rel="prefetch" href="/assets/js/279.b36007aa.js"><link rel="prefetch" href="/assets/js/28.91595b48.js"><link rel="prefetch" href="/assets/js/280.14723ae7.js"><link rel="prefetch" href="/assets/js/281.f27b79de.js"><link rel="prefetch" href="/assets/js/282.718708d7.js"><link rel="prefetch" href="/assets/js/283.f91a771c.js"><link rel="prefetch" href="/assets/js/284.25b1d4f7.js"><link rel="prefetch" href="/assets/js/285.a641722b.js"><link rel="prefetch" href="/assets/js/286.9d2d85fb.js"><link rel="prefetch" href="/assets/js/287.a8a0d7a2.js"><link rel="prefetch" href="/assets/js/288.ee27e2fe.js"><link rel="prefetch" href="/assets/js/289.e4300193.js"><link rel="prefetch" href="/assets/js/29.a5ef89d9.js"><link rel="prefetch" href="/assets/js/290.ba445f12.js"><link rel="prefetch" href="/assets/js/291.7a767d85.js"><link rel="prefetch" href="/assets/js/292.aa96cc76.js"><link rel="prefetch" href="/assets/js/293.e18d36c6.js"><link rel="prefetch" href="/assets/js/294.7113dff7.js"><link rel="prefetch" href="/assets/js/295.abae5e0e.js"><link rel="prefetch" href="/assets/js/296.010241c4.js"><link rel="prefetch" href="/assets/js/297.4bbe88fd.js"><link rel="prefetch" href="/assets/js/298.9f291f83.js"><link rel="prefetch" href="/assets/js/299.bf9e031a.js"><link rel="prefetch" href="/assets/js/3.1403d3ee.js"><link rel="prefetch" href="/assets/js/30.3bb57e98.js"><link rel="prefetch" href="/assets/js/300.fc58f3c4.js"><link rel="prefetch" href="/assets/js/301.69cd291f.js"><link rel="prefetch" href="/assets/js/302.c34ca8e9.js"><link rel="prefetch" href="/assets/js/303.25655f40.js"><link rel="prefetch" href="/assets/js/304.97a8e358.js"><link rel="prefetch" href="/assets/js/305.1c5e713f.js"><link rel="prefetch" href="/assets/js/306.b53f2ea6.js"><link rel="prefetch" href="/assets/js/307.e4a9a150.js"><link rel="prefetch" href="/assets/js/308.92931c17.js"><link rel="prefetch" href="/assets/js/309.6e452bde.js"><link rel="prefetch" href="/assets/js/31.f1ddaeee.js"><link rel="prefetch" href="/assets/js/310.6abc9668.js"><link rel="prefetch" href="/assets/js/311.1bd77809.js"><link rel="prefetch" href="/assets/js/312.78b7405d.js"><link rel="prefetch" href="/assets/js/313.3b23ded5.js"><link rel="prefetch" href="/assets/js/314.ae150cf1.js"><link rel="prefetch" href="/assets/js/315.d375ed9c.js"><link rel="prefetch" href="/assets/js/316.c8a05987.js"><link rel="prefetch" href="/assets/js/317.febd6c4f.js"><link rel="prefetch" href="/assets/js/318.34fe4d11.js"><link rel="prefetch" href="/assets/js/319.5b558d88.js"><link rel="prefetch" href="/assets/js/32.8019bc57.js"><link rel="prefetch" href="/assets/js/320.af89e963.js"><link rel="prefetch" href="/assets/js/321.f646b641.js"><link rel="prefetch" href="/assets/js/322.897f28f1.js"><link rel="prefetch" href="/assets/js/323.38229c39.js"><link rel="prefetch" href="/assets/js/324.7baf2418.js"><link rel="prefetch" href="/assets/js/325.e0225366.js"><link rel="prefetch" href="/assets/js/326.e30b69cd.js"><link rel="prefetch" href="/assets/js/327.6774c791.js"><link rel="prefetch" href="/assets/js/328.58239b5d.js"><link rel="prefetch" href="/assets/js/329.570eb01e.js"><link rel="prefetch" href="/assets/js/33.2009be2a.js"><link rel="prefetch" href="/assets/js/330.6c29d590.js"><link rel="prefetch" href="/assets/js/331.bbe673f1.js"><link rel="prefetch" href="/assets/js/332.6d2bbedd.js"><link rel="prefetch" href="/assets/js/333.7e60b6bd.js"><link rel="prefetch" href="/assets/js/334.9f9ea9bb.js"><link rel="prefetch" href="/assets/js/335.0f60cf92.js"><link rel="prefetch" href="/assets/js/336.3981edeb.js"><link rel="prefetch" href="/assets/js/337.0ca91dae.js"><link rel="prefetch" href="/assets/js/338.09e14c30.js"><link rel="prefetch" href="/assets/js/339.31147ffa.js"><link rel="prefetch" href="/assets/js/34.f4ffaa4e.js"><link rel="prefetch" href="/assets/js/340.b216b6b7.js"><link rel="prefetch" href="/assets/js/341.7af949b2.js"><link rel="prefetch" href="/assets/js/342.03e80905.js"><link rel="prefetch" href="/assets/js/343.147ff16c.js"><link rel="prefetch" href="/assets/js/344.c95f6de9.js"><link rel="prefetch" href="/assets/js/345.7cc8cfaa.js"><link rel="prefetch" href="/assets/js/346.d5ff42a4.js"><link rel="prefetch" href="/assets/js/347.f1f1478f.js"><link rel="prefetch" href="/assets/js/348.32ea340f.js"><link rel="prefetch" href="/assets/js/349.4d743984.js"><link rel="prefetch" href="/assets/js/35.6f997bc2.js"><link rel="prefetch" href="/assets/js/350.c218cb98.js"><link rel="prefetch" href="/assets/js/351.a6f08d8b.js"><link rel="prefetch" href="/assets/js/352.46538632.js"><link rel="prefetch" href="/assets/js/353.6702d9ff.js"><link rel="prefetch" href="/assets/js/354.10264327.js"><link rel="prefetch" href="/assets/js/355.bc66e304.js"><link rel="prefetch" href="/assets/js/356.36d9208c.js"><link rel="prefetch" href="/assets/js/357.708af07a.js"><link rel="prefetch" href="/assets/js/358.61ab6834.js"><link rel="prefetch" href="/assets/js/359.bb4ad887.js"><link rel="prefetch" href="/assets/js/36.5172c464.js"><link rel="prefetch" href="/assets/js/360.9ae57e7b.js"><link rel="prefetch" href="/assets/js/37.72aa4947.js"><link rel="prefetch" href="/assets/js/38.77129de5.js"><link rel="prefetch" href="/assets/js/39.01d84c7e.js"><link rel="prefetch" href="/assets/js/4.5517c98c.js"><link rel="prefetch" href="/assets/js/40.b2fb57bd.js"><link rel="prefetch" href="/assets/js/41.fa63fb49.js"><link rel="prefetch" href="/assets/js/42.c68fd691.js"><link rel="prefetch" href="/assets/js/43.071af6f3.js"><link rel="prefetch" href="/assets/js/44.99321348.js"><link rel="prefetch" href="/assets/js/45.4c105e24.js"><link rel="prefetch" href="/assets/js/46.91a5aa2c.js"><link rel="prefetch" href="/assets/js/47.18bd4930.js"><link rel="prefetch" href="/assets/js/48.deef5f67.js"><link rel="prefetch" href="/assets/js/49.12c80dd9.js"><link rel="prefetch" href="/assets/js/5.6b7a7b35.js"><link rel="prefetch" href="/assets/js/50.259ff32b.js"><link rel="prefetch" href="/assets/js/51.ee83db82.js"><link rel="prefetch" href="/assets/js/52.1cf54e16.js"><link rel="prefetch" href="/assets/js/53.821dd297.js"><link rel="prefetch" href="/assets/js/54.bf29c9d1.js"><link rel="prefetch" href="/assets/js/55.25e00784.js"><link rel="prefetch" href="/assets/js/56.b1112045.js"><link rel="prefetch" href="/assets/js/57.5923ed3a.js"><link rel="prefetch" href="/assets/js/58.ee7fa86f.js"><link rel="prefetch" href="/assets/js/59.7b9800f0.js"><link rel="prefetch" href="/assets/js/6.207c7bac.js"><link rel="prefetch" href="/assets/js/60.ca146265.js"><link rel="prefetch" href="/assets/js/61.77a27075.js"><link rel="prefetch" href="/assets/js/62.2839e098.js"><link rel="prefetch" href="/assets/js/63.6c8cdea8.js"><link rel="prefetch" href="/assets/js/64.1a5f538c.js"><link rel="prefetch" href="/assets/js/65.a3708a3e.js"><link rel="prefetch" href="/assets/js/66.63a1d86b.js"><link rel="prefetch" href="/assets/js/67.5563ad9d.js"><link rel="prefetch" href="/assets/js/68.182b4324.js"><link rel="prefetch" href="/assets/js/69.b695215c.js"><link rel="prefetch" href="/assets/js/7.00b0f0bb.js"><link rel="prefetch" href="/assets/js/70.819c0991.js"><link rel="prefetch" href="/assets/js/71.534cf941.js"><link rel="prefetch" href="/assets/js/72.b3c641ef.js"><link rel="prefetch" href="/assets/js/73.e613a0d5.js"><link rel="prefetch" href="/assets/js/74.d7fc07e0.js"><link rel="prefetch" href="/assets/js/75.d50101e4.js"><link rel="prefetch" href="/assets/js/76.18e7ac7b.js"><link rel="prefetch" href="/assets/js/77.bb898521.js"><link rel="prefetch" href="/assets/js/78.a08d2106.js"><link rel="prefetch" href="/assets/js/79.0f362a00.js"><link rel="prefetch" href="/assets/js/8.197a9ad8.js"><link rel="prefetch" href="/assets/js/80.8b74cf4c.js"><link rel="prefetch" href="/assets/js/81.3e8c87af.js"><link rel="prefetch" href="/assets/js/82.83cb55b7.js"><link rel="prefetch" href="/assets/js/83.7355f968.js"><link rel="prefetch" href="/assets/js/84.51061851.js"><link rel="prefetch" href="/assets/js/85.b5df8911.js"><link rel="prefetch" href="/assets/js/86.baf2296e.js"><link rel="prefetch" href="/assets/js/87.2e9ae95d.js"><link rel="prefetch" href="/assets/js/88.57a8401a.js"><link rel="prefetch" href="/assets/js/89.a0d99eba.js"><link rel="prefetch" href="/assets/js/9.53a0556a.js"><link rel="prefetch" href="/assets/js/90.6121d367.js"><link rel="prefetch" href="/assets/js/91.56f285e2.js"><link rel="prefetch" href="/assets/js/92.7d7c0428.js"><link rel="prefetch" href="/assets/js/93.17841bd6.js"><link rel="prefetch" href="/assets/js/94.832fcc1c.js"><link rel="prefetch" href="/assets/js/95.e9c523bc.js"><link rel="prefetch" href="/assets/js/96.d8aae52a.js"><link rel="prefetch" href="/assets/js/97.bd436fab.js"><link rel="prefetch" href="/assets/js/98.78f6e4f3.js"><link rel="prefetch" href="/assets/js/99.a405fc1f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.877370ef.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="wen chao" class="logo"> <span class="site-name can-hide">wen chao</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Algorithm" class="dropdown-title"><a href="/Algorithm/" class="link-title">Algorithm</a> <span class="title" style="display:none;">Algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d8e764/" class="nav-link">Theory</a></li><li class="dropdown-item"><!----> <a href="/pages/81a4bd/" class="nav-link">LeetCode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/Spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/373439/" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technology" class="dropdown-title"><a href="/Technology/" class="link-title">Technology</a> <span class="title" style="display:none;">Technology</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3b6841/" class="nav-link">DB</a></li><li class="dropdown-item"><!----> <a href="/pages/d7857e/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b89362/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/ec8b81/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/pages/4e3ff1/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/a75fef/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/pages/b194d7/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/pages/371f2f/" class="nav-link">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/027aa3/" class="nav-link">Workflow</a></li><li class="dropdown-item"><!----> <a href="/pages/73ab4b/" class="nav-link">OAuth2</a></li><li class="dropdown-item"><!----> <a href="/pages/d7a38a/" class="nav-link">JPA</a></li><li class="dropdown-item"><!----> <a href="/pages/eb5dc1/" class="nav-link">Liquibase</a></li><li class="dropdown-item"><!----> <a href="/pages/e54277/" class="nav-link">Lombok</a></li><li class="dropdown-item"><!----> <a href="/pages/62e4f6/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/13c836/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/b50b3d/" class="nav-link">Mini Program</a></li><li class="dropdown-item"><!----> <a href="/pages/09d3b8/" class="nav-link">JVM</a></li><li class="dropdown-item"><!----> <a href="/pages/a526c7/" class="nav-link">Log</a></li><li class="dropdown-item"><!----> <a href="/pages/59cf4f/" class="nav-link">JDK</a></li><li class="dropdown-item"><!----> <a href="/pages/d50dab/" class="nav-link">Thymeleaf</a></li><li class="dropdown-item"><!----> <a href="/pages/97abaa/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/7879f1/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/745b7c/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/pages/274dac/" class="nav-link">Raspberrypi</a></li><li class="dropdown-item"><!----> <a href="/pages/87c097/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/pages/927664/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/2c3f19/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><a href="/Other/" class="link-title">Other</a> <span class="title" style="display:none;">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fea344/" class="nav-link">Book</a></li><li class="dropdown-item"><!----> <a href="/pages/d62f72/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/f3d338/" class="nav-link">问题</a></li><li class="dropdown-item"><!----> <a href="/pages/ff202b/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/pages/2b746e/" class="nav-link">证券</a></li></ul></div></div><div class="nav-item"><a href="/About/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Index" class="dropdown-title"><a href="/archives/" class="link-title">Index</a> <span class="title" style="display:none;">Index</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/touxiang-lanse.png"> <div class="blogger-info"><h3>wen chao</h3> <span>持之以恒做正确有价值的事!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Algorithm" class="dropdown-title"><a href="/Algorithm/" class="link-title">Algorithm</a> <span class="title" style="display:none;">Algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d8e764/" class="nav-link">Theory</a></li><li class="dropdown-item"><!----> <a href="/pages/81a4bd/" class="nav-link">LeetCode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/Spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/373439/" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technology" class="dropdown-title"><a href="/Technology/" class="link-title">Technology</a> <span class="title" style="display:none;">Technology</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3b6841/" class="nav-link">DB</a></li><li class="dropdown-item"><!----> <a href="/pages/d7857e/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b89362/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/ec8b81/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/pages/4e3ff1/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/a75fef/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/pages/b194d7/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/pages/371f2f/" class="nav-link">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/027aa3/" class="nav-link">Workflow</a></li><li class="dropdown-item"><!----> <a href="/pages/73ab4b/" class="nav-link">OAuth2</a></li><li class="dropdown-item"><!----> <a href="/pages/d7a38a/" class="nav-link">JPA</a></li><li class="dropdown-item"><!----> <a href="/pages/eb5dc1/" class="nav-link">Liquibase</a></li><li class="dropdown-item"><!----> <a href="/pages/e54277/" class="nav-link">Lombok</a></li><li class="dropdown-item"><!----> <a href="/pages/62e4f6/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/13c836/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/b50b3d/" class="nav-link">Mini Program</a></li><li class="dropdown-item"><!----> <a href="/pages/09d3b8/" class="nav-link">JVM</a></li><li class="dropdown-item"><!----> <a href="/pages/a526c7/" class="nav-link">Log</a></li><li class="dropdown-item"><!----> <a href="/pages/59cf4f/" class="nav-link">JDK</a></li><li class="dropdown-item"><!----> <a href="/pages/d50dab/" class="nav-link">Thymeleaf</a></li><li class="dropdown-item"><!----> <a href="/pages/97abaa/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/7879f1/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/745b7c/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/pages/274dac/" class="nav-link">Raspberrypi</a></li><li class="dropdown-item"><!----> <a href="/pages/87c097/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/pages/927664/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/2c3f19/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><a href="/Other/" class="link-title">Other</a> <span class="title" style="display:none;">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fea344/" class="nav-link">Book</a></li><li class="dropdown-item"><!----> <a href="/pages/d62f72/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/f3d338/" class="nav-link">问题</a></li><li class="dropdown-item"><!----> <a href="/pages/ff202b/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/pages/2b746e/" class="nav-link">证券</a></li></ul></div></div><div class="nav-item"><a href="/About/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Index" class="dropdown-title"><a href="/archives/" class="link-title">Index</a> <span class="title" style="display:none;">Index</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Book</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>性能调优专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>并发编程专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>源码框架专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>微服务专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>项目实战专题</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/6f8d3f/" class="sidebar-link">项目搭建</a></li><li><a href="/pages/3f9765/" class="sidebar-link">项目技术</a></li><li><a href="/pages/165d97/" class="sidebar-link">商品详细页多级缓存实战1</a></li><li><a href="/pages/248afc/" class="sidebar-link">商品详细页多级缓存实战2</a></li><li><a href="/pages/cde965/" class="sidebar-link">商品详细页多级缓存实战3</a></li><li><a href="/pages/684f32/" class="sidebar-link">电商项目微服务架构拆分</a></li><li><a href="/pages/528503/" aria-current="page" class="active sidebar-link">电商项目微服务网关整合授权中心实现单点登录</a></li><li><a href="/pages/f4e7c3/" class="sidebar-link">ES电商项目笔记</a></li><li><a href="/pages/a076e7/" class="sidebar-link">秒杀系统-订单交易全链路优化实战</a></li><li><a href="/pages/17d7cb/" class="sidebar-link">秒杀系统-订单交易全链路优化实战2</a></li><li><a href="/pages/1cc02e/" class="sidebar-link">canal安装与使用和原理详解</a></li><li><a href="/pages/7c3ae9/" class="sidebar-link">秒杀链路兜底方案之限流和降级实战</a></li><li><a href="/pages/b3e1d7/" class="sidebar-link">Sharding分库分表实战</a></li><li><a href="/pages/21df2c/" class="sidebar-link">项目实战总结与项目管理分享</a></li><li><a href="/pages/98944c/" class="sidebar-link">中台建设和DDD</a></li><li><a href="/pages/b36dd7/" class="sidebar-link">Docker详解与部署微服务实战</a></li><li><a href="/pages/75ec88/" class="sidebar-link">Docker-Compose编排电商微服务项目实战</a></li><li><a href="/pages/e77282/" class="sidebar-link">自动化性能监控系统Prometheus-Grafana实战</a></li><li><a href="/pages/fd685e/" class="sidebar-link">Kubernetes快速实战与核心原理剖析</a></li><li><a href="/pages/cdff9c/" class="sidebar-link">Kubernetes电商微服务部署实战</a></li><li><a href="/pages/33fd02/" class="sidebar-link">电商项目性能优化实战</a></li><li><a href="/pages/c5f7e6/" class="sidebar-link">推荐系统-机器学习</a></li><li><a href="/pages/98b787/" class="sidebar-link">企业级IM系统后端架构实战</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>设计模式专题</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>面试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>问题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>友链</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>证券</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/Other/#Other" data-v-06225672>Other</a></li><li data-v-06225672><a href="/Other/#Book" data-v-06225672>Book</a></li><li data-v-06225672><a href="/Other/#项目实战专题" data-v-06225672>项目实战专题</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://nylg.gitee.io" target="_blank" title="作者" class="beLink" data-v-06225672>wen chao</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-06-23</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><!----> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">电商项目微服务网关整合授权中心实现单点登录<!----></h1>  <div class="theme-vdoing-content content__default"><div class="language- line-numbers-mode"><pre class="language-text"><code>U2FsdGVkX19e9Y27q8UAWnzaHTJjYzbsYzLsIoZvsGJzWWY5261rV99YMm92bVdy
bCPfWYmrHQsDnWqkodPpzTnH0iDues/QFTL3FpgXX95SSjBT/1gyyREj9nvaWZxk
aQ==
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>学习本课程的前提： 了解Oauth2协议及其密码授权模式，熟悉Spring Security Oauth2和JWT的使用，熟悉Spring Cloud Gateway网关使用。</p> <p><strong>1. 架构设计分析</strong></p> <p><strong>1.1 多点登录</strong></p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623193937546.png" alt="image-20220623193937546"></p> <p>​</p> <p><strong>1.2 单点登录</strong></p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623193949213.png" alt="image-20220623193949213"></p> <p><strong>1.3 微服务接入网关实现单点登录设计思路</strong></p> <p>网关整合 OAuth2.0 有两种思路，一种是授权服务器生成令牌, 所有请求统一在网关层验证，判断权限等操作；另一种是由各资源服务处理，网关只做请求转发。  比较常用的是第一种，把API网关作为OAuth2.0的资源服务器角色，实现接入客户端权限拦截、令牌解析并转发当前登录用户信息给微服务，这样下游微服务就不需要关心令牌格式解析以及OAuth2.0相关机制了。</p> <p>网关在认证授权体系里主要负责两件事： （1）作为OAuth2.0的资源服务器角色，实现接入方访问权限拦截。 （2）令牌解析并转发当前登录用户信息（明文token）给微服务 微服务拿到明文token(明文token中包含登录用户的身份和权限信息)后也需要做两件事： （1）用户授权拦截（看当前用户是否有权访问该资源） （2）将用户信息存储进当前线程上下文（有利于后续业务逻辑随时获取当前用户信息）</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194000473.png" alt="image-20220623194000473"></p> <p><strong>2. 搭建微服务授权中心</strong></p> <p>授权中心的认证依赖：</p> <ul><li>第三方客户端的信息</li> <li>微服务的信息</li> <li>登录用户的信息</li></ul> <p>创建微服务tulingmall-auth</p> <p><strong>2.1 引入依赖</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
    &lt;artifactId&gt;lombok&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.tuling&lt;/groupId&gt;
    &lt;artifactId&gt;tulingmall-mbg&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!--nacos 注册中心 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- spring security oauth2--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- openfeign 服务远程调用 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p><strong>2.2 添加yml配置</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server:
  port: 9999
spring:
  application:
    name: tulingmall-auth
    #配置nacos注册中心地址
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.65.232:8848  #注册中心地址
        namespace: 80a98d11-492c-4008-85aa-32d889e9b0d0  #环境隔离
  datasource:
    url: jdbc:mysql://tuling.com:3306/tlmall_oauth?serverTimezone=UTC&amp;useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8
    username: root
    password: root
    druid:
      initial-size: 5 #连接池初始化大小
      min-idle: 10 #最小空闲连接数
      max-active: 20 #最大连接数
      web-stat-filter:
        exclusions: &quot;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&quot; #不统计这些请求数据
      stat-view-servlet: #访问监控网页的登录用户名和密码
        login-username: druid
        login-password: druid

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>​</p> <p><strong>2.3 配置授权服务器</strong></p> <p><strong>基于DB模式配置授权服务器存储第三方客户端的信息</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Configuration
@EnableAuthorizationServer
public class TulingAuthorizationServerConfig extends AuthorizationServerConfigurerAdapter {
    
    @Autowired
    private DataSource dataSource;
    
    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
        // 配置授权服务器存储第三方客户端的信息  基于DB存储   oauth_client_details
        clients.withClientDetails(clientDetails());
    }
    
    @Bean
    public ClientDetailsService clientDetails(){
        return new JdbcClientDetailsService(dataSource);
    }
    
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>​</p> <p>在oauth_client_details中添加第三方客户端信息（client_id  client_secret  scope等等）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE TABLE `oauth_client_details`  (
  `client_id` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `resource_ids` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `client_secret` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `scope` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `authorized_grant_types` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `web_server_redirect_uri` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `authorities` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `access_token_validity` int(11) NULL DEFAULT NULL,
  `refresh_token_validity` int(11) NULL DEFAULT NULL,
  `additional_information` varchar(4096) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `autoapprove` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  PRIMARY KEY (`client_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>基于内存模式配置授权服务器存储第三方客户端的信息</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//TulingAuthorizationServerConfig.java
@Override
public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
    //  配置授权服务器存储第三方客户端的信息  基于DB存储   oauth_client_details
   // clients.withClientDetails(clientDetails());
    
    /**
     *授权码模式
     *http://localhost:9999/oauth/authorize?response_type=code&amp;client_id=client&amp;redirect_uri=http://www.baidu.com&amp;scope=all
     *
     * password模式
     *  http://localhost:8080/oauth/token?username=fox&amp;password=123456&amp;grant_type=password&amp;client_id=client&amp;client_secret=123123&amp;scope=all
     *
     */
    clients.inMemory()
            //配置client_id
            .withClient(&quot;client&quot;)
            //配置client-secret
            .secret(passwordEncoder.encode(&quot;123123&quot;))
            //配置访问token的有效期
            .accessTokenValiditySeconds(3600)
            //配置刷新token的有效期
            .refreshTokenValiditySeconds(864000)
            //配置redirect_uri，用于授权成功后跳转
            .redirectUris(&quot;http://www.baidu.com&quot;)
            //配置申请的权限范围
            .scopes(&quot;all&quot;)
            /**
             * 配置grant_type，表示授权类型
             * authorization_code: 授权码
             * password： 密码
             * refresh_token: 更新令牌
             */
            .authorizedGrantTypes(&quot;authorization_code&quot;,&quot;password&quot;,&quot;refresh_token&quot;);
    
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><strong>2.4 配置SpringSecurity</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Configuration
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    @Autowired
    private TulingUserDetailsService tulingUserDetailsService;
    
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        // 从DB获取用户信息
        auth.userDetailsService(tulingUserDetailsService);
    }
    
    
    @Bean
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception {
        // oauth2 密码模式需要拿到这个bean
        return super.authenticationManagerBean();
    }
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.formLogin().permitAll()
                .and().authorizeRequests()
                .antMatchers(&quot;/oauth/**&quot;).permitAll()
                .anyRequest()
                .authenticated()
                .and().logout().permitAll()
                .and().csrf().disable();        
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>​</p> <p><strong>获取会员信息，此处通过feign从tulingmall-member获取会员信息，需要配置feign，核心代码：</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Slf4j
@Component
public class TulingUserDetailsService implements UserDetailsService {
    
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        // 加载用户信息
        if(StringUtils.isEmpty(username)) {
            log.warn(&quot;用户登陆用户名为空:{}&quot;,username);
            throw new UsernameNotFoundException(&quot;用户名不能为空&quot;);
        }
    
        UmsMember umsMember = getByUsername(username);
    
        if(null == umsMember) {
            log.warn(&quot;根据用户名没有查询到对应的用户信息:{}&quot;,username);
        }
    
        log.info(&quot;根据用户名:{}获取用户登陆信息:{}&quot;,username,umsMember);
    
        // 会员信息的封装 implements UserDetails
        MemberDetails memberDetails = new MemberDetails(umsMember);
        
        return memberDetails;
    }
    
    @Autowired
    private UmsMemberFeignService umsMemberFeignService;
    
    public UmsMember getByUsername(String username) {
        // fegin获取会员信息
        CommonResult&lt;UmsMember&gt; umsMemberCommonResult = umsMemberFeignService.loadUserByUsername(username);
        
        return umsMemberCommonResult.getData();
    }
}

@FeignClient(value = &quot;tulingmall-member&quot;,path=&quot;/member/center&quot;)
public interface UmsMemberFeignService {
    
    @RequestMapping(&quot;/loadUmsMember&quot;)
    CommonResult&lt;UmsMember&gt; loadUserByUsername(@RequestParam(&quot;username&quot;) String username);
}

public class MemberDetails implements UserDetails {
    private UmsMember umsMember;

    public MemberDetails(UmsMember umsMember) {
        this.umsMember = umsMember;
    }

    @Override
    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {
        //返回当前用户的权限
        return Arrays.asList(new SimpleGrantedAuthority(&quot;TEST&quot;));
    }

    @Override
    public String getPassword() {
        return umsMember.getPassword();
    }

    @Override
    public String getUsername() {
        return umsMember.getUsername();
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return umsMember.getStatus()==1;
    }

    public UmsMember getUmsMember() {
        return umsMember;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><p><strong>修改授权服务配置，支持密码模式</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//TulingAuthorizationServerConfig.java 
    @Autowired
    private TulingUserDetailsService tulingUserDetailsService;

    @Autowired
    private AuthenticationManager authenticationManagerBean;
    
    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
        //使用密码模式需要配置
        endpoints.authenticationManager(authenticationManagerBean)
                .reuseRefreshTokens(false)  //refresh_token是否重复使用
                .userDetailsService(tulingUserDetailsService) //刷新令牌授权包含对用户信息的检查
                .allowedTokenEndpointRequestMethods(HttpMethod.GET,HttpMethod.POST); //支持GET,POST请求
    }
    
    /**
     * 授权服务器安全配置
     * @param security
     * @throws Exception
     */
    @Override
    public void configure(AuthorizationServerSecurityConfigurer security) throws Exception {
        //第三方客户端校验token需要带入 clientId 和clientSecret来校验
        security.checkTokenAccess(&quot;isAuthenticated()&quot;)
                .tokenKeyAccess(&quot;isAuthenticated()&quot;);//来获取我们的tokenKey需要带入clientId,clientSecret
    
        //允许表单认证
        security.allowFormAuthenticationForClients();
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><strong>2.5 测试模拟用户登录</strong></p> <p><strong>授权码模式</strong></p> <p>授权码（authorization code）方式，指的是第三方应用先申请一个授权码，然后再用该码获取令牌。</p> <p>这种方式是最常用的流程，安全性也最高，它适用于那些有后端的 Web 应用。授权码通过前端传送，令牌则是储存在后端，而且所有与资源服务器的通信都在后端完成。这样的前后端分离，可以避免令牌泄漏。</p> <p>适用场景：目前市面上主流的第三方验证都是采用这种模式</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194011931.png" alt="image-20220623194011931"></p> <p>​</p> <p>它的步骤如下：</p> <p>（A）用户访问客户端，后者将前者导向授权服务器。</p> <p>（B）用户选择是否给予客户端授权。</p> <p>（C）假设用户给予授权，授权服务器将用户导向客户端事先指定的&quot;重定向URI&quot;（redirection URI），同时附上一个授权码。</p> <p>（D）客户端收到授权码，附上早先的&quot;重定向URI&quot;，向授权服务器申请令牌。这一步是在客户端的后台的服务器上完成的，对用户不可见。</p> <p>（E）授权服务器核对了授权码和重定向URI，确认无误后，向客户端发送访问令牌（access token）和更新令牌（refresh token）。</p> <p>http://localhost:9999/oauth/authorize?response_type=code&amp;client_id=client&amp;redirect_uri=http://www.baidu.com&amp;scope=all</p> <p>获取到code</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194024595.png" alt="image-20220623194024595"></p> <p>​    <img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194032711.png" alt="image-20220623194032711"></p> <p><strong>密码模式</strong></p> <p>如果你高度信任某个应用，RFC 6749 也允许用户把用户名和密码，直接告诉该应用。该应用就使用你的密码，申请令牌，这种方式称为&quot;密码式&quot;（password）。</p> <p>在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而授权服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。</p> <p>适用场景：自家公司搭建的授权服务器</p> <p>测试获取token</p> <p>http://localhost:9999/oauth/token?username=test&amp;password=test&amp;grant_type=password&amp;client_id=client&amp;client_secret=123123&amp;scope=all</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194043884.png" alt="image-20220623194043884"></p> <p>​</p> <p>测试校验token接口</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194054385.png" alt="image-20220623194054385"></p> <p>因为授权服务器的security配置需要携带clientId和clientSecret，可以采用basic Auth的方式发请求</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194103322.png" alt="image-20220623194103322"></p> <p>注意： 传参是token</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194124512.png" alt="image-20220623194124512"></p> <p><strong>2.6 配置资源服务器</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Configuration
@EnableResourceServer
public class TulingResourceServerConfig  extends ResourceServerConfigurerAdapter {
    
    @Override
    public void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
                .anyRequest().authenticated();
        
    }
}

@RestController
@RequestMapping(&quot;/user&quot;)
public class UserController {
    
    
    @RequestMapping(&quot;/getCurrentUser&quot;)
    public Object getCurrentUser(Authentication authentication) {
        return authentication.getPrincipal();
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>测试携带token访问资源</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194140153.png" alt="image-20220623194140153"></p> <p>​</p> <p>或者请求头配置Authorization</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194147740.png" alt="image-20220623194147740"></p> <p><strong>2.7 Spring Security Oauth2整合JWT</strong></p> <p>JSON Web Token（JWT）是一个开放的行业标准（RFC 7519），它定义了一种简介的、自包含的协议格式，用于在通信双方传递json对象，传递的信息经过数字签名可以被验证和信任。JWT可以使用HMAC算法或使用RSA的公钥/私钥对来签名，防止被篡改。 官网：https://jwt.io/</p> <p>JWT令牌的优点：</p> <ul><li>jwt基于json，非常方便解析。</li> <li>可以在令牌中自定义丰富的内容，易扩展。</li> <li>通过非对称加密算法及数字签名技术，JWT防止篡改，安全性高。</li> <li>资源服务使用JWT可不依赖认证服务即可完成授权。</li></ul> <p>缺点：</p> <p>​	JWT令牌较长，占存储空间比较大。</p> <p>JWT组成</p> <p>一个JWT实际上就是一个字符串，它由三部分组成，头部（header）、载荷（payload）与签名（signature）。</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194158584.png" alt="image-20220623194158584"></p> <p><strong>头部（header）</strong></p> <p>头部用于描述关于该JWT的最基本的信息：类型（即JWT）以及签名所用的算法（如HMACSHA256或RSA）等。</p> <p>这也可以被表示成一个JSON对象：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;alg&quot;: &quot;HS256&quot;,
  &quot;typ&quot;: &quot;JWT&quot;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后将头部进行base64加密（该加密是可以对称解密的),构成了第一部分:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​</p> <p><strong>载荷（payload）</strong></p> <p>第二部分是载荷，就是存放有效信息的地方。这个名字像是特指飞机上承载的货品，这些有效信息包含三个部分：</p> <ul><li>标准中注册的声明（建议但不强制使用）</li></ul> <p><strong>iss</strong>: jwt签发者</p> <p><strong>sub</strong>: jwt所面向的用户</p> <p><strong>aud</strong>: 接收jwt的一方</p> <p><strong>exp</strong>: jwt的过期时间，这个过期时间必须要大于签发时间</p> <p><strong>nbf</strong>: 定义在什么时间之前，该jwt都是不可用的.</p> <p><strong>iat</strong>: jwt的签发时间</p> <p><strong>jti</strong>: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</p> <ul><li>公共的声明 公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密.</li> <li>私有的声明 私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</li></ul> <p>定义一个payload：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;sub&quot;: &quot;1234567890&quot;,
  &quot;name&quot;: &quot;John Doe&quot;,
  &quot;iat&quot;: 1516239022
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后将其进行base64加密，得到Jwt的第二部分:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​</p> <p><strong>签名（signature）</strong></p> <p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：</p> <ul><li>header (base64后的)</li> <li>payload (base64后的)</li> <li>secret(盐，一定要保密）</li></ul> <p>这个部分需要base64加密后的header和base64加密后的payload使用.连接组成的字符串，然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了jwt的第三部分:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>var encodedString = base64UrlEncode(header) + '.' + base64UrlEncode(payload);
var signature = HMACSHA256(encodedString, 'fox'); // khA7TNYc7_0iELcDyTc7gHBZ_xfIcgbfpzUNWwQtzME
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>​</p> <p>将这三部分用.连接成一个完整的字符串,构成了最终的jwt:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.khA7TNYc7_0iELcDyTc7gHBZ_xfIcgbfpzUNWwQtzME
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​</p> <p>注意：secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret, 那就意味着客户端是可以自我签发jwt了。</p> <p>引入依赖</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;!--spring secuity对jwt的支持 spring cloud oauth2已经依赖，可以不配置--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
    &lt;artifactId&gt;spring-security-jwt&lt;/artifactId&gt;
    &lt;version&gt;1.0.9.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>​</p> <p>添加JWT配置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Configuration
public class JwtTokenStoreConfig {

    @Bean
    public TokenStore jwtTokenStore(){
        return new JwtTokenStore(jwtAccessTokenConverter());
    }

    @Bean
    public JwtAccessTokenConverter jwtAccessTokenConverter(){
        JwtAccessTokenConverter accessTokenConverter = new
                JwtAccessTokenConverter();
        //配置JWT使用的秘钥
        accessTokenConverter.setSigningKey(&quot;123123&quot;);
        return accessTokenConverter;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>​</p> <p>在授权服务器配置中指定令牌的存储策略为JWT</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//TulingAuthorizationServerConfig.java

@Autowired
@Qualifier(&quot;jwtTokenStore&quot;)
private TokenStore tokenStore;

@Autowired
private JwtAccessTokenConverter jwtAccessTokenConverter;

@Autowired
private TulingUserDetailsService tulingUserDetailsService;

@Autowired
private AuthenticationManager authenticationManagerBean;

@Override
public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
    //使用密码模式需要配置
    endpoints.authenticationManager(authenticationManagerBean)
            .tokenStore(tokenStore)  //指定token存储策略是jwt
            .accessTokenConverter(jwtAccessTokenConverter)
            .reuseRefreshTokens(false)  //refresh_token是否重复使用
            .userDetailsService(tulingUserDetailsService) //刷新令牌授权包含对用户信息的检查
            .allowedTokenEndpointRequestMethods(HttpMethod.GET,HttpMethod.POST); //支持GET,POST请求
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>​</p> <p>密码模式测试：</p> <p>http://localhost:9999/oauth/token?username=test&amp;password=test&amp;grant_type=password&amp;client_id=client&amp;client_secret=123123&amp;scope=all</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194210316.png" alt="image-20220623194210316"></p> <p><strong>将access_token复制到</strong><a href="https://jwt.io/" target="_blank" rel="noopener noreferrer"><strong>https://jwt.io/</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><strong>的Encoded中打开,可以看到会员认证信息</strong></p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194236153.png" alt="image-20220623194236153"></p> <p>​</p> <p>测试校验token</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194243536.png" alt="image-20220623194243536"></p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194251808.png" alt="image-20220623194251808"></p> <p>测试获取token_key</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194300290.png" alt="image-20220623194300290"></p> <p>测试刷新token</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194310252.png" alt="image-20220623194310252"></p> <p><strong>2.8 优化：实现JWT非对称加密（公钥私钥）</strong></p> <p><strong>第一步：生成jks 证书文件</strong></p> <p>我们使用jdk自动的工具生成</p> <blockquote><p>命令格式</p> <p>keytool</p> <p>-genkeypair  生成密钥对</p> <p>-alias jwt(别名)</p> <p>-keypass 123456(别名密码)</p> <p>-keyalg RSA(生证书的算法名称，RSA是一种非对称加密算法)</p> <p>-keysize 1024(密钥长度,证书大小)</p> <p>-validity 365(证书有效期，天单位)</p> <p>-keystore D:/jwt/jwt.jks(指定生成证书的位置和证书名称)</p> <p>-storepass 123456(获取keystore信息的密码)</p> <p>-storetype (指定密钥仓库类型)</p> <p>使用 &quot;keytool -help&quot; 获取所有可用命令</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>keytool  -genkeypair -alias jwt -keyalg RSA -keysize 2048 -keystore D:/jwt/jwt.jks
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194321093.png" alt="image-20220623194321093"></p> <p>将生成的jwt.jks文件cope到授权服务器的resource目录下</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194334493.png" alt="image-20220623194334493"></p> <p>查看公钥信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> keytool -list -rfc --keystore jwt.jks  | openssl x509 -inform pem -pubkey
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194345460.png" alt="image-20220623194345460"></p> <p>​</p> <p>第二步：授权服务中增加jwt的属性配置类</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Data
@ConfigurationProperties(prefix = &quot;tuling.jwt&quot;)
public class JwtCAProperties {

    /**
     * 证书名称
     */
    private String keyPairName;


    /**
     * 证书别名
     */
    private String keyPairAlias;

    /**
     * 证书私钥
     */
    private String keyPairSecret;

    /**
     * 证书存储密钥
     */
    private String keyPairStoreSecret;

}

@Configuration
// 指定属性配置类
@EnableConfigurationProperties(value = JwtCAProperties.class)  
public class JwtTokenStoreConfig {
    。。。。。。
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>​</p> <p>yml中添加jwt配置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>tuling:
  jwt:
    keyPairName: jwt.jks
    keyPairAlias: jwt
    keyPairSecret: 123123
    keyPairStoreSecret: 123123
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>​</p> <p>第三步：修改JwtTokenStoreConfig的配置，支持非对称加密</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Bean
public JwtAccessTokenConverter jwtAccessTokenConverter(){
    JwtAccessTokenConverter accessTokenConverter = new
            JwtAccessTokenConverter();
    //配置JWT使用的秘钥  对称加密
    //accessTokenConverter.setSigningKey(&quot;123123&quot;);
    //配置JWT使用的秘钥 非对称加密
    accessTokenConverter.setKeyPair(keyPair());
    return accessTokenConverter;
}

@Autowired
private JwtCAProperties jwtCAProperties;

@Bean
public KeyPair keyPair() {
    KeyStoreKeyFactory keyStoreKeyFactory = new KeyStoreKeyFactory(new ClassPathResource(jwtCAProperties.getKeyPairName()), jwtCAProperties.getKeyPairSecret().toCharArray());
    return keyStoreKeyFactory.getKeyPair(jwtCAProperties.getKeyPairAlias(), jwtCAProperties.getKeyPairStoreSecret().toCharArray());
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>第四步：扩展JWT中的存储内容</p> <p>有时候我们需要扩展JWT中存储的内容，根据自己业务添加字段到Jwt中。 继承TokenEnhancer实现一个JWT内容增强器</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public class TulingTokenEnhancer implements TokenEnhancer {
    @Override
    public OAuth2AccessToken enhance(OAuth2AccessToken accessToken, OAuth2Authentication authentication) {

        MemberDetails memberDetails = (MemberDetails) authentication.getPrincipal();

        final Map&lt;String, Object&gt; additionalInfo = new HashMap&lt;&gt;();

        final Map&lt;String, Object&gt; retMap = new HashMap&lt;&gt;();

        //todo 这里暴露memberId到Jwt的令牌中,后期可以根据自己的业务需要 进行添加字段
        additionalInfo.put(&quot;memberId&quot;,memberDetails.getUmsMember().getId());
        additionalInfo.put(&quot;nickName&quot;,memberDetails.getUmsMember().getNickname());
        additionalInfo.put(&quot;integration&quot;,memberDetails.getUmsMember().getIntegration());

        retMap.put(&quot;additionalInfo&quot;,additionalInfo);

        ((DefaultOAuth2AccessToken) accessToken).setAdditionalInformation(retMap);

        return accessToken;
    }
}


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>​</p> <p>在JwtTokenStoreConfig中配置TulingTokenEnhancer</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//JwtTokenStoreConfig.java
/**
 * token的增强器 根据自己业务添加字段到Jwt中
 * @return
 */
@Bean
public TulingTokenEnhancer tulingTokenEnhancer() {
    return new TulingTokenEnhancer();
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在授权服务器配置中配置JWT的内容增强器</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// TulingAuthorizationServerConfig.java
@Autowired
private TulingTokenEnhancer tulingTokenEnhancer;

@Override
public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
    //配置JWT的内容增强器
    TokenEnhancerChain enhancerChain = new TokenEnhancerChain();
    List&lt;TokenEnhancer&gt; delegates = new ArrayList&lt;&gt;();
    delegates.add(tulingTokenEnhancer);
    delegates.add(jwtAccessTokenConverter);
    enhancerChain.setTokenEnhancers(delegates);
    
    //使用密码模式需要配置
    endpoints.authenticationManager(authenticationManagerBean)
            .tokenStore(tokenStore)  //指定token存储策略是jwt
            .accessTokenConverter(jwtAccessTokenConverter)
            .tokenEnhancer(enhancerChain) //配置tokenEnhancer
            .reuseRefreshTokens(false)  //refresh_token是否重复使用
            .userDetailsService(tulingUserDetailsService) //刷新令牌授权包含对用户信息的检查
            .allowedTokenEndpointRequestMethods(HttpMethod.GET,HttpMethod.POST); //支持GET,POST请求
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>​</p> <p>1）通过密码模式测试获取token</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194354908.png" alt="image-20220623194354908"></p> <p>https://jwt.io/中校验token，可以获取到增强的用户信息，传入私钥和公钥可以校验通过。</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194402884.png" alt="image-20220623194402884"></p> <p>2）测试校验token</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194411618.png" alt="image-20220623194411618"></p> <p><strong>3. 接入网关服务</strong></p> <p>在网关服务tulingmall-gateway中配置tulingmall-auth</p> <p>1）yml中添加对tulingmall-auth的路由</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server:
  port: 9999
spring:
  application:
    name: tulingmall-gateway
  #配置nacos注册中心地址
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.65.232:8848  #注册中心地址
        namespace: 80a98d11-492c-4008-85aa-32d889e9b0d0  #环境隔离

    gateway:
      routes:
      - id: tulingmall-member   #路由ID，全局唯一
        uri: lb://tulingmall-member
        predicates:
        - Path=/member/**,/sso/**
      - id: tulingmall-coupons
        uri: lb://tulingmall-coupons
        predicates:
        - Path=/coupon/**
      - id: tulingmall-auth
        uri: lb://tulingmall-auth
        predicates:
        - Path=/oauth/**
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>2）编写GateWay的全局过滤器进行权限的校验拦截</p> <p>认证过滤器AuthenticationFilter#filter中需要实现的逻辑</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//1.过滤不需要认证的url,比如/oauth/**

//2. 获取token
// 从请求头中解析 Authorization  value:  bearer xxxxxxx
// 或者从请求参数中解析 access_token

//3. 校验token
// 拿到token后，通过公钥（需要从授权服务获取公钥）校验
// 校验失败或超时抛出异常

//4. 校验通过后，从token中获取的用户登录信息存储到请求头中
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>​</p> <p>1）过滤不需要认证的url ，可以通过yml设置不需要认证的url。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/**
 * @author Fox
 *
 * 认证过滤器: 实现认证逻辑
 *
 */
@Component
@Order(0)
@EnableConfigurationProperties(value = NotAuthUrlProperties.class)
public class AuthenticationFilter implements GlobalFilter, InitializingBean {
    
    /**
     * 请求各个微服务 不需要用户认证的URL
     */
    @Autowired
    private NotAuthUrlProperties notAuthUrlProperties;
    
    @Override
    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        String currentUrl = exchange.getRequest().getURI().getPath();
    
        //过滤不需要认证的url
        if(shouldSkip(currentUrl)) {
            //log.info(&quot;跳过认证的URL:{}&quot;,currentUrl);
            return chain.filter(exchange);
        }
        //log.info(&quot;需要认证的URL:{}&quot;,currentUrl);
    
        
    
        return chain.filter(exchange);
    }
    
    @Override
    public void afterPropertiesSet() throws Exception {
        //获取公钥  TODO
        
    }
    
    
    /**
     * 方法实现说明:不需要授权的路径
     * @author:smlz
     * @param currentUrl 当前请求路径
     * @return:
     * @exception:
     * @date:2019/12/26 13:49
     */
    private boolean shouldSkip(String currentUrl) {
        //路径匹配器(简介SpringMvc拦截器的匹配器)
        //比如/oauth/** 可以匹配/oauth/token    /oauth/check_token等
        PathMatcher pathMatcher = new AntPathMatcher();
        for(String skipPath:notAuthUrlProperties.getShouldSkipUrls()) {
            if(pathMatcher.match(skipPath,currentUrl)) {
                return true;
            }
        }
        return false;
    }
}


@Data
@ConfigurationProperties(&quot;tuling.gateway&quot;)
public class NotAuthUrlProperties {

    private LinkedHashSet&lt;String&gt; shouldSkipUrls;
}

//application.yml
tuling:
  gateway:
    shouldSkipUrls:
    - /oauth/**
    - /sso/**
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>网关中引入授权中心配置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>- id: tulingmall-auth
  uri: lb://tulingmall-auth
  predicates:
  - Path=/oauth/**
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>测试： 密码模式 client_id为会员微服务，能够获取到token信息</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194433291.png" alt="image-20220623194433291"></p> <p>​</p> <p>测试：  会员微服务会员登录逻辑</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194449413.png" alt="image-20220623194449413"></p> <p>2） 解析请求，获取token</p> <p>从请求头中解析 Authorization  value:  bearer xxxxxxx 或者 从请求参数中解析 access_token</p> <p>引入依赖</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;com.tuling&lt;/groupId&gt;
    &lt;artifactId&gt;tulingmall-common&lt;/artifactId&gt;
    &lt;exclusions&gt;
        &lt;exclusion&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;
        &lt;/exclusion&gt;
        &lt;exclusion&gt;
            &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;
            &lt;artifactId&gt;pagehelper-spring-boot-starter&lt;/artifactId&gt;
        &lt;/exclusion&gt;
    &lt;/exclusions&gt;
&lt;/dependency&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>​</p> <p>在AuthenticationFilter#filter中实现获取token的逻辑</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//2. 获取token
// 从请求头中解析 Authorization  value:  bearer xxxxxxx
// 或者从请求参数中解析 access_token
//第一步:解析出我们Authorization的请求头  value为: “bearer XXXXXXXXXXXXXX”
String authHeader = exchange.getRequest().getHeaders().getFirst(&quot;Authorization&quot;);

//第二步:判断Authorization的请求头是否为空
if(StringUtils.isEmpty(authHeader)) {
    log.warn(&quot;需要认证的url,请求头为空&quot;);
    throw new GateWayException(ResultCode.AUTHORIZATION_HEADER_IS_EMPTY);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>测试： 通过网关获取用户优惠券信息，因为请求头中不带token信息，所以会抛出异常</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194459013.png" alt="image-20220623194459013"></p> <p>3）校验token</p> <p>拿到token后，通过公钥（需要从授权服务获取公钥）校验，校验失败或超时抛出异常</p> <p>引入依赖</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;!--添加jwt相关的包--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;
    &lt;artifactId&gt;jjwt-api&lt;/artifactId&gt;
    &lt;version&gt;0.10.5&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;
    &lt;artifactId&gt;jjwt-impl&lt;/artifactId&gt;
    &lt;version&gt;0.10.5&lt;/version&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;
    &lt;artifactId&gt;jjwt-jackson&lt;/artifactId&gt;
    &lt;version&gt;0.10.5&lt;/version&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>​</p> <p>在AuthenticationFilter#filter中实现校验token的逻辑</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//3. 校验token
// 拿到token后，通过公钥（需要从授权服务获取公钥）校验
// 校验失败或超时抛出异常
//第三步 校验我们的jwt 若jwt不对或者超时都会抛出异常
Claims claims = JwtUtils.validateJwtToken(authHeader,publicKey);

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>​</p> <p>校验token逻辑</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// AuthenticationFilter.java
/**
 * 请求头中的 token的开始
 */
private static final String AUTH_HEADER = &quot;bearer &quot;;

public static Claims validateJwtToken(String authHeader,PublicKey publicKey) {
    String token =null ;
    try{
        token = StringUtils.substringAfter(authHeader, AUTH_HEADER);
        
        Jwt&lt;JwsHeader, Claims&gt; parseClaimsJwt = Jwts.parser().setSigningKey(publicKey).parseClaimsJws(token);
        
        Claims claims = parseClaimsJwt.getBody();
        
        //log.info(&quot;claims:{}&quot;,claims);
        
        return claims;
        
    }catch(Exception e){
        
        log.error(&quot;校验token异常:{},异常信息:{}&quot;,token,e.getMessage());
        
        throw new GateWayException(ResultCode.JWT_TOKEN_EXPIRE);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>​</p> <p>工具类</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Slf4j
public class JwtUtils {

    /**
     * 认证服务器许可我们的网关的clientId(需要在oauth_client_details表中配置)
     */
    private static final String CLIENT_ID = &quot;tulingmall-gateway&quot;;

    /**
     * 认证服务器许可我们的网关的client_secret(需要在oauth_client_details表中配置)
     */
    private static final String CLIENT_SECRET = &quot;123123&quot;;

    /**
     * 认证服务器暴露的获取token_key的地址
     */
    private static final String AUTH_TOKEN_KEY_URL = &quot;http://tulingmall-auth/oauth/token_key&quot;;

    /**
     * 请求头中的 token的开始
     */
    private static final String AUTH_HEADER = &quot;bearer &quot;;

    /**
     * 方法实现说明: 通过远程调用获取认证服务器颁发jwt的解析的key
     * @author:smlz
     * @param restTemplate 远程调用的操作类
     * @return: tokenKey 解析jwt的tokenKey
     * @exception:
     * @date:2020/1/22 11:31
     */
    private static String getTokenKeyByRemoteCall(RestTemplate restTemplate) throws GateWayException {

        //第一步:封装请求头
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
        headers.setBasicAuth(CLIENT_ID,CLIENT_SECRET);
        HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; entity = new HttpEntity&lt;&gt;(null, headers);

        //第二步:远程调用获取token_key
        try {

            ResponseEntity&lt;Map&gt; response = restTemplate.exchange(AUTH_TOKEN_KEY_URL, HttpMethod.GET, entity, Map.class);

            String tokenKey = response.getBody().get(&quot;value&quot;).toString();

            log.info(&quot;去认证服务器获取Token_Key:{}&quot;,tokenKey);

            return tokenKey;

        }catch (Exception e) {

            log.error(&quot;远程调用认证服务器获取Token_Key失败:{}&quot;,e.getMessage());

            throw new GateWayException(ResultCode.GET_TOKEN_KEY_ERROR);
        }
    }

    /**
     * 方法实现说明:生成公钥
     * @author:smlz
     * @param restTemplate:远程调用操作类
     * @return: PublicKey 公钥对象
     * @exception:
     * @date:2020/1/22 11:52
     */
    public static PublicKey genPulicKey(RestTemplate restTemplate) throws GateWayException {

        String tokenKey = getTokenKeyByRemoteCall(restTemplate);

        try{

            //把获取的公钥开头和结尾替换掉
            String dealTokenKey =tokenKey.replaceAll(&quot;\\-*BEGIN PUBLIC KEY\\-*&quot;, &quot;&quot;).replaceAll(&quot;\\-*END PUBLIC KEY\\-*&quot;, &quot;&quot;).trim();

            java.security.Security.addProvider(new org.bouncycastle.jce.provider.BouncyCastleProvider());

            X509EncodedKeySpec pubKeySpec = new X509EncodedKeySpec(Base64.decodeBase64(dealTokenKey));

            KeyFactory keyFactory = KeyFactory.getInstance(&quot;RSA&quot;);

            PublicKey publicKey = keyFactory.generatePublic(pubKeySpec);

            log.info(&quot;生成公钥:{}&quot;,publicKey);

            return publicKey;

        }catch (Exception e) {

            log.info(&quot;生成公钥异常:{}&quot;,e.getMessage());

            throw new GateWayException(ResultCode.GEN_PUBLIC_KEY_ERROR);
        }
    }

    public static Claims validateJwtToken(String authHeader,PublicKey publicKey) {
        String token =null ;
        try{
            token = StringUtils.substringAfter(authHeader, AUTH_HEADER);

            Jwt&lt;JwsHeader, Claims&gt; parseClaimsJwt = Jwts.parser().setSigningKey(publicKey).parseClaimsJws(token);

            Claims claims = parseClaimsJwt.getBody();

            //log.info(&quot;claims:{}&quot;,claims);

            return claims;

        }catch(Exception e){

            log.error(&quot;校验token异常:{},异常信息:{}&quot;,token,e.getMessage());

            throw new GateWayException(ResultCode.JWT_TOKEN_EXPIRE);
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div><p>​</p> <p>需要从tulingmall-auth获取公钥，实现公钥获取逻辑</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// AuthenticationFilter.java
/**
 * jwt的公钥,需要网关启动,远程调用认证中心去获取公钥
 */
private PublicKey publicKey;

@Autowired
private RestTemplate restTemplate;

@Override
public void afterPropertiesSet() throws Exception {
    //获取公钥  TODO
    this.publicKey = JwtUtils.genPulicKey(restTemplate);
}

@Configuration
public class RibbonConfig {
    
    @Autowired
    private LoadBalancerClient loadBalancer;
    
    @Bean
    public RestTemplate restTemplate(){
        RestTemplate restTemplate = new RestTemplate();
        restTemplate.setInterceptors(
                Collections.singletonList(
                        new LoadBalancerInterceptor(loadBalancer)));
        
        return restTemplate;
    }
    
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>注意： 此处不能直接通过@LoadBalancer配置RestTemplate去获取公钥，思考为什么？</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>源码参考：
org.springframework.cloud.client.loadbalancer.LoadBalancerAutoConfiguration
org.springframework.beans.factory.support.DefaultListableBeanFactory#preInstantiateSingletons
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>测试： 正确的token，通过网关获取用户优惠券信息</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194517235.png" alt="image-20220623194517235"></p> <p>​</p> <p>错误的token，抛出异常</p> <p><img src="https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623194526412.png" alt="image-20220623194526412"></p> <p>4）校验通过后，从token中获取的用户登录信息存储到请求头中</p> <p>在AuthenticationFilter#filter中，将从token中获取的用户登陆信息存储到请求头中</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//4. 校验通过后，从token中获取的用户登录信息存储到请求头中
//第四步 把从jwt中解析出来的 用户登陆信息存储到请求头中
ServerWebExchange webExchange = wrapHeader(exchange,claims);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>​</p> <p>解析用户登录信息存储到请求头中</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// AuthenticationFilter.java

private ServerWebExchange wrapHeader(ServerWebExchange serverWebExchange,Claims claims) {
    
    String loginUserInfo = JSON.toJSONString(claims);
    
    //log.info(&quot;jwt的用户信息:{}&quot;,loginUserInfo);
    
    String memberId = claims.get(&quot;additionalInfo&quot;, Map.class).get(&quot;memberId&quot;).toString();
    
    String nickName = claims.get(&quot;additionalInfo&quot;,Map.class).get(&quot;nickName&quot;).toString();
    
    //向headers中放文件，记得build
    ServerHttpRequest request = serverWebExchange.getRequest().mutate()
            .header(&quot;username&quot;,claims.get(&quot;user_name&quot;,String.class))
            .header(&quot;memberId&quot;,memberId)
            .header(&quot;nickName&quot;,nickName)
            .build();
    
    //将现在的request 变成 change对象
    return serverWebExchange.mutate().request(request).build();
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></div></div>  <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/684f32/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">电商项目微服务架构拆分</div></a> <a href="/pages/f4e7c3/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">ES电商项目笔记</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/684f32/" class="prev">电商项目微服务架构拆分</a></span> <span class="next"><a href="/pages/f4e7c3/">ES电商项目笔记</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/80365f/"><div>
            证券市场基本法律法规
            <!----></div></a> <span class="date">03-13</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/d9e4f4/"><div>
            证券考试规则
            <!----></div></a> <span class="date">03-12</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/cb2c17/"><div>
            金融市场基础知识
            <!----></div></a> <span class="date">03-12</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:cloudjava@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/bigdatajava" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/nylg" title="Gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2014-2025
    <span>wen chao | <a href="https://github.com/bigdatajava/blog-talk/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.af2629f3.js" defer></script><script src="/assets/js/2.c7acc05c.js" defer></script><script src="/assets/js/261.74b1bebb.js" defer></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SQL详解 | wen chao</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3129839_xft6cqs5gc.css">
    <meta name="description" content="架构进阶之路...">
    <meta name="keywords" content="全栈博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,js,ES6,TypeScript,vue">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.237ce36e.css" as="style"><link rel="preload" href="/assets/js/app.b2807c2b.js" as="script"><link rel="preload" href="/assets/js/2.eeaab5de.js" as="script"><link rel="preload" href="/assets/js/36.7c80731a.js" as="script"><link rel="prefetch" href="/assets/js/10.30d760c8.js"><link rel="prefetch" href="/assets/js/100.d2a91f05.js"><link rel="prefetch" href="/assets/js/101.aa15113f.js"><link rel="prefetch" href="/assets/js/102.303aae62.js"><link rel="prefetch" href="/assets/js/103.39dbd83e.js"><link rel="prefetch" href="/assets/js/104.30434bc2.js"><link rel="prefetch" href="/assets/js/105.68d90558.js"><link rel="prefetch" href="/assets/js/106.2a47de1c.js"><link rel="prefetch" href="/assets/js/107.6c92802c.js"><link rel="prefetch" href="/assets/js/108.1a019470.js"><link rel="prefetch" href="/assets/js/109.f2cc4655.js"><link rel="prefetch" href="/assets/js/11.8c97a85c.js"><link rel="prefetch" href="/assets/js/110.8630d06d.js"><link rel="prefetch" href="/assets/js/111.fdf10f1a.js"><link rel="prefetch" href="/assets/js/112.ea841a58.js"><link rel="prefetch" href="/assets/js/113.bd8e761d.js"><link rel="prefetch" href="/assets/js/114.63ed667a.js"><link rel="prefetch" href="/assets/js/115.909a8353.js"><link rel="prefetch" href="/assets/js/116.62dab6c0.js"><link rel="prefetch" href="/assets/js/117.d0ef1d76.js"><link rel="prefetch" href="/assets/js/118.39e6e925.js"><link rel="prefetch" href="/assets/js/119.e0265f93.js"><link rel="prefetch" href="/assets/js/12.156b3963.js"><link rel="prefetch" href="/assets/js/120.4be98e6e.js"><link rel="prefetch" href="/assets/js/121.518d8dd5.js"><link rel="prefetch" href="/assets/js/122.477dd94b.js"><link rel="prefetch" href="/assets/js/123.d6065aca.js"><link rel="prefetch" href="/assets/js/124.c6f965c7.js"><link rel="prefetch" href="/assets/js/125.3ee79c35.js"><link rel="prefetch" href="/assets/js/126.bcc69ad9.js"><link rel="prefetch" href="/assets/js/127.8f3ce1ac.js"><link rel="prefetch" href="/assets/js/128.03c90841.js"><link rel="prefetch" href="/assets/js/129.ab248cd9.js"><link rel="prefetch" href="/assets/js/13.c67aac42.js"><link rel="prefetch" href="/assets/js/130.dd64983e.js"><link rel="prefetch" href="/assets/js/131.6ffe6940.js"><link rel="prefetch" href="/assets/js/132.2a8fed26.js"><link rel="prefetch" href="/assets/js/133.6a7673eb.js"><link rel="prefetch" href="/assets/js/134.c00b7bf2.js"><link rel="prefetch" href="/assets/js/135.59d75ce6.js"><link rel="prefetch" href="/assets/js/136.bcd27d57.js"><link rel="prefetch" href="/assets/js/137.75dd3384.js"><link rel="prefetch" href="/assets/js/138.a2ababbf.js"><link rel="prefetch" href="/assets/js/139.6aa75eaa.js"><link rel="prefetch" href="/assets/js/14.8ab9a27a.js"><link rel="prefetch" href="/assets/js/140.58295019.js"><link rel="prefetch" href="/assets/js/141.8d05c3a5.js"><link rel="prefetch" href="/assets/js/142.18498abf.js"><link rel="prefetch" href="/assets/js/143.20c6bdde.js"><link rel="prefetch" href="/assets/js/144.ac94f8ff.js"><link rel="prefetch" href="/assets/js/145.e135dd8a.js"><link rel="prefetch" href="/assets/js/146.13a537e3.js"><link rel="prefetch" href="/assets/js/147.016b19e9.js"><link rel="prefetch" href="/assets/js/148.d3a909f2.js"><link rel="prefetch" href="/assets/js/149.90d05716.js"><link rel="prefetch" href="/assets/js/15.2b8ce9c5.js"><link rel="prefetch" href="/assets/js/150.e61c5f29.js"><link rel="prefetch" href="/assets/js/151.c81aa646.js"><link rel="prefetch" href="/assets/js/152.82944cc0.js"><link rel="prefetch" href="/assets/js/153.410a3789.js"><link rel="prefetch" href="/assets/js/154.cc1235ef.js"><link rel="prefetch" href="/assets/js/155.1e7fae81.js"><link rel="prefetch" href="/assets/js/156.cfaa0244.js"><link rel="prefetch" href="/assets/js/157.47981f53.js"><link rel="prefetch" href="/assets/js/158.e9c295a1.js"><link rel="prefetch" href="/assets/js/159.50ba3574.js"><link rel="prefetch" href="/assets/js/16.a8b0b084.js"><link rel="prefetch" href="/assets/js/160.5845ca9d.js"><link rel="prefetch" href="/assets/js/161.0e97694f.js"><link rel="prefetch" href="/assets/js/162.3c77226a.js"><link rel="prefetch" href="/assets/js/163.17c9ec79.js"><link rel="prefetch" href="/assets/js/164.7736f87d.js"><link rel="prefetch" href="/assets/js/165.ff7b4f9e.js"><link rel="prefetch" href="/assets/js/166.6956307c.js"><link rel="prefetch" href="/assets/js/167.366611f7.js"><link rel="prefetch" href="/assets/js/168.57345d6b.js"><link rel="prefetch" href="/assets/js/169.25420ee7.js"><link rel="prefetch" href="/assets/js/17.68e41786.js"><link rel="prefetch" href="/assets/js/170.bedd4eac.js"><link rel="prefetch" href="/assets/js/171.374570cf.js"><link rel="prefetch" href="/assets/js/172.2f8bf4a8.js"><link rel="prefetch" href="/assets/js/173.42ea0d36.js"><link rel="prefetch" href="/assets/js/174.0ccfd7c6.js"><link rel="prefetch" href="/assets/js/175.7ab333d2.js"><link rel="prefetch" href="/assets/js/176.c7266816.js"><link rel="prefetch" href="/assets/js/177.d0a95fb6.js"><link rel="prefetch" href="/assets/js/178.2bb652ad.js"><link rel="prefetch" href="/assets/js/179.a8eab386.js"><link rel="prefetch" href="/assets/js/18.8e0d47a1.js"><link rel="prefetch" href="/assets/js/180.9fd22be7.js"><link rel="prefetch" href="/assets/js/181.5d5358d4.js"><link rel="prefetch" href="/assets/js/182.af7d36e2.js"><link rel="prefetch" href="/assets/js/183.dddc555d.js"><link rel="prefetch" href="/assets/js/184.a3396baf.js"><link rel="prefetch" href="/assets/js/185.2f7da675.js"><link rel="prefetch" href="/assets/js/186.92639766.js"><link rel="prefetch" href="/assets/js/187.711debd8.js"><link rel="prefetch" href="/assets/js/188.149256e6.js"><link rel="prefetch" href="/assets/js/189.c118aa93.js"><link rel="prefetch" href="/assets/js/19.770d847c.js"><link rel="prefetch" href="/assets/js/190.4d85ee4e.js"><link rel="prefetch" href="/assets/js/191.ff095a9a.js"><link rel="prefetch" href="/assets/js/192.4b5fe55c.js"><link rel="prefetch" href="/assets/js/193.415828fe.js"><link rel="prefetch" href="/assets/js/194.ce801921.js"><link rel="prefetch" href="/assets/js/195.c668b288.js"><link rel="prefetch" href="/assets/js/196.8825af00.js"><link rel="prefetch" href="/assets/js/197.d09dcd8b.js"><link rel="prefetch" href="/assets/js/198.396382cf.js"><link rel="prefetch" href="/assets/js/199.facc6630.js"><link rel="prefetch" href="/assets/js/20.97979961.js"><link rel="prefetch" href="/assets/js/200.db1ff45e.js"><link rel="prefetch" href="/assets/js/201.ab79fbd5.js"><link rel="prefetch" href="/assets/js/202.46e8525c.js"><link rel="prefetch" href="/assets/js/203.2cc13ae9.js"><link rel="prefetch" href="/assets/js/204.3c8a5bcd.js"><link rel="prefetch" href="/assets/js/205.3d0d8394.js"><link rel="prefetch" href="/assets/js/206.261623f6.js"><link rel="prefetch" href="/assets/js/207.6260c0aa.js"><link rel="prefetch" href="/assets/js/208.0fd63045.js"><link rel="prefetch" href="/assets/js/209.e5eaeeca.js"><link rel="prefetch" href="/assets/js/21.e6565c56.js"><link rel="prefetch" href="/assets/js/210.bccc650e.js"><link rel="prefetch" href="/assets/js/211.c238d796.js"><link rel="prefetch" href="/assets/js/212.dd4703ab.js"><link rel="prefetch" href="/assets/js/213.110becf0.js"><link rel="prefetch" href="/assets/js/214.a90d9da2.js"><link rel="prefetch" href="/assets/js/215.81872845.js"><link rel="prefetch" href="/assets/js/216.2ae9609f.js"><link rel="prefetch" href="/assets/js/217.567657f9.js"><link rel="prefetch" href="/assets/js/218.bc570e81.js"><link rel="prefetch" href="/assets/js/219.32a64945.js"><link rel="prefetch" href="/assets/js/22.92562bc3.js"><link rel="prefetch" href="/assets/js/220.d1605ea9.js"><link rel="prefetch" href="/assets/js/221.c1483dee.js"><link rel="prefetch" href="/assets/js/222.188d3bb6.js"><link rel="prefetch" href="/assets/js/223.b4d7fc4a.js"><link rel="prefetch" href="/assets/js/224.5495522d.js"><link rel="prefetch" href="/assets/js/225.ea320f20.js"><link rel="prefetch" href="/assets/js/226.1f245007.js"><link rel="prefetch" href="/assets/js/227.280e3176.js"><link rel="prefetch" href="/assets/js/228.7ea12e2e.js"><link rel="prefetch" href="/assets/js/229.0697746f.js"><link rel="prefetch" href="/assets/js/23.4b595789.js"><link rel="prefetch" href="/assets/js/230.8efdd773.js"><link rel="prefetch" href="/assets/js/231.44bfbfb5.js"><link rel="prefetch" href="/assets/js/232.24dc2667.js"><link rel="prefetch" href="/assets/js/233.6c77b12b.js"><link rel="prefetch" href="/assets/js/234.1ea57e5c.js"><link rel="prefetch" href="/assets/js/235.efb990b9.js"><link rel="prefetch" href="/assets/js/236.2e8820ed.js"><link rel="prefetch" href="/assets/js/237.b108feed.js"><link rel="prefetch" href="/assets/js/238.22baaff8.js"><link rel="prefetch" href="/assets/js/239.ac2c0eba.js"><link rel="prefetch" href="/assets/js/24.b1f29ab1.js"><link rel="prefetch" href="/assets/js/240.1f419e38.js"><link rel="prefetch" href="/assets/js/241.e23fbc50.js"><link rel="prefetch" href="/assets/js/242.83b3226c.js"><link rel="prefetch" href="/assets/js/243.1ce8a9be.js"><link rel="prefetch" href="/assets/js/244.d7c93bdb.js"><link rel="prefetch" href="/assets/js/245.a1b402c0.js"><link rel="prefetch" href="/assets/js/246.7eeb5e18.js"><link rel="prefetch" href="/assets/js/247.b2c0ab4a.js"><link rel="prefetch" href="/assets/js/248.5b2dd7ed.js"><link rel="prefetch" href="/assets/js/249.6278d6f1.js"><link rel="prefetch" href="/assets/js/25.748022ff.js"><link rel="prefetch" href="/assets/js/250.e3114578.js"><link rel="prefetch" href="/assets/js/251.1f576677.js"><link rel="prefetch" href="/assets/js/252.7e83dd55.js"><link rel="prefetch" href="/assets/js/253.ab219365.js"><link rel="prefetch" href="/assets/js/254.31655221.js"><link rel="prefetch" href="/assets/js/255.402ba0fd.js"><link rel="prefetch" href="/assets/js/256.2f1f131a.js"><link rel="prefetch" href="/assets/js/257.cd0dac87.js"><link rel="prefetch" href="/assets/js/258.5e84f5d0.js"><link rel="prefetch" href="/assets/js/259.72cf210e.js"><link rel="prefetch" href="/assets/js/26.d566b8b1.js"><link rel="prefetch" href="/assets/js/260.ddfd8bc7.js"><link rel="prefetch" href="/assets/js/261.b074e8b6.js"><link rel="prefetch" href="/assets/js/262.e0b94776.js"><link rel="prefetch" href="/assets/js/263.2e66950f.js"><link rel="prefetch" href="/assets/js/264.f3ac339f.js"><link rel="prefetch" href="/assets/js/265.384c189b.js"><link rel="prefetch" href="/assets/js/266.635a72af.js"><link rel="prefetch" href="/assets/js/267.c9ede946.js"><link rel="prefetch" href="/assets/js/268.9ec888f5.js"><link rel="prefetch" href="/assets/js/269.2a81258c.js"><link rel="prefetch" href="/assets/js/27.3085f660.js"><link rel="prefetch" href="/assets/js/270.973f0998.js"><link rel="prefetch" href="/assets/js/271.de24bbf3.js"><link rel="prefetch" href="/assets/js/272.68e83c3c.js"><link rel="prefetch" href="/assets/js/273.d740150b.js"><link rel="prefetch" href="/assets/js/274.dc1b1f0c.js"><link rel="prefetch" href="/assets/js/275.cf028a33.js"><link rel="prefetch" href="/assets/js/276.351dbc96.js"><link rel="prefetch" href="/assets/js/277.6a9f5699.js"><link rel="prefetch" href="/assets/js/278.0c28ac6f.js"><link rel="prefetch" href="/assets/js/279.b14576ac.js"><link rel="prefetch" href="/assets/js/28.47957820.js"><link rel="prefetch" href="/assets/js/280.906a73b1.js"><link rel="prefetch" href="/assets/js/281.4173499d.js"><link rel="prefetch" href="/assets/js/282.43873aa6.js"><link rel="prefetch" href="/assets/js/283.2a3d0552.js"><link rel="prefetch" href="/assets/js/284.2c7aa3fb.js"><link rel="prefetch" href="/assets/js/285.a62f9799.js"><link rel="prefetch" href="/assets/js/286.2f0b6532.js"><link rel="prefetch" href="/assets/js/287.d770d01f.js"><link rel="prefetch" href="/assets/js/288.97207297.js"><link rel="prefetch" href="/assets/js/289.ddf5a46c.js"><link rel="prefetch" href="/assets/js/29.716c8a52.js"><link rel="prefetch" href="/assets/js/290.9f1b4436.js"><link rel="prefetch" href="/assets/js/291.885ac485.js"><link rel="prefetch" href="/assets/js/292.b1fe886b.js"><link rel="prefetch" href="/assets/js/293.f597359f.js"><link rel="prefetch" href="/assets/js/294.f559040e.js"><link rel="prefetch" href="/assets/js/295.ef66e1a4.js"><link rel="prefetch" href="/assets/js/296.47009685.js"><link rel="prefetch" href="/assets/js/297.fb7d20ba.js"><link rel="prefetch" href="/assets/js/298.cb1631f8.js"><link rel="prefetch" href="/assets/js/299.25f28097.js"><link rel="prefetch" href="/assets/js/3.9c10c990.js"><link rel="prefetch" href="/assets/js/30.b35b7ad0.js"><link rel="prefetch" href="/assets/js/300.ab5c587e.js"><link rel="prefetch" href="/assets/js/301.544c6982.js"><link rel="prefetch" href="/assets/js/302.70396486.js"><link rel="prefetch" href="/assets/js/303.fa1f3a02.js"><link rel="prefetch" href="/assets/js/304.c344682e.js"><link rel="prefetch" href="/assets/js/305.a0620b1d.js"><link rel="prefetch" href="/assets/js/306.8cb43e28.js"><link rel="prefetch" href="/assets/js/307.ee4d9e2d.js"><link rel="prefetch" href="/assets/js/308.bb04656d.js"><link rel="prefetch" href="/assets/js/309.b3e3c0be.js"><link rel="prefetch" href="/assets/js/31.af0fa05e.js"><link rel="prefetch" href="/assets/js/310.162df0c7.js"><link rel="prefetch" href="/assets/js/311.1a5e341e.js"><link rel="prefetch" href="/assets/js/312.9fe4ed85.js"><link rel="prefetch" href="/assets/js/313.e187b781.js"><link rel="prefetch" href="/assets/js/314.c832b372.js"><link rel="prefetch" href="/assets/js/315.66b7260d.js"><link rel="prefetch" href="/assets/js/316.074c1e65.js"><link rel="prefetch" href="/assets/js/317.9210b762.js"><link rel="prefetch" href="/assets/js/318.50ac3392.js"><link rel="prefetch" href="/assets/js/319.996a4c1b.js"><link rel="prefetch" href="/assets/js/32.81b4ee4b.js"><link rel="prefetch" href="/assets/js/320.661c3aa7.js"><link rel="prefetch" href="/assets/js/321.91d065c2.js"><link rel="prefetch" href="/assets/js/322.21d177e9.js"><link rel="prefetch" href="/assets/js/323.c240199c.js"><link rel="prefetch" href="/assets/js/324.fc71e18c.js"><link rel="prefetch" href="/assets/js/325.d441ab5e.js"><link rel="prefetch" href="/assets/js/326.6065a9e1.js"><link rel="prefetch" href="/assets/js/327.b68a9e0f.js"><link rel="prefetch" href="/assets/js/328.082fa547.js"><link rel="prefetch" href="/assets/js/329.17abf0b7.js"><link rel="prefetch" href="/assets/js/33.c41edd68.js"><link rel="prefetch" href="/assets/js/330.076712a3.js"><link rel="prefetch" href="/assets/js/331.b883690e.js"><link rel="prefetch" href="/assets/js/332.a942e6bd.js"><link rel="prefetch" href="/assets/js/333.e193acf6.js"><link rel="prefetch" href="/assets/js/334.5721c074.js"><link rel="prefetch" href="/assets/js/335.b759f5ec.js"><link rel="prefetch" href="/assets/js/336.8f786a4b.js"><link rel="prefetch" href="/assets/js/337.8ef80b90.js"><link rel="prefetch" href="/assets/js/338.8c63fda7.js"><link rel="prefetch" href="/assets/js/339.3df2ba0b.js"><link rel="prefetch" href="/assets/js/34.e166f3d5.js"><link rel="prefetch" href="/assets/js/340.e54bd836.js"><link rel="prefetch" href="/assets/js/341.1de3160e.js"><link rel="prefetch" href="/assets/js/342.52f64508.js"><link rel="prefetch" href="/assets/js/343.f56c914e.js"><link rel="prefetch" href="/assets/js/344.63033532.js"><link rel="prefetch" href="/assets/js/345.b23610d1.js"><link rel="prefetch" href="/assets/js/346.2c817177.js"><link rel="prefetch" href="/assets/js/347.bb20d78f.js"><link rel="prefetch" href="/assets/js/348.bba2b968.js"><link rel="prefetch" href="/assets/js/349.620d4fde.js"><link rel="prefetch" href="/assets/js/35.827d2ea3.js"><link rel="prefetch" href="/assets/js/350.a24a894c.js"><link rel="prefetch" href="/assets/js/351.9fc8ae8f.js"><link rel="prefetch" href="/assets/js/352.9229b958.js"><link rel="prefetch" href="/assets/js/353.ffe6628c.js"><link rel="prefetch" href="/assets/js/354.4f883a51.js"><link rel="prefetch" href="/assets/js/355.3232e481.js"><link rel="prefetch" href="/assets/js/356.52bb9172.js"><link rel="prefetch" href="/assets/js/357.4ee29887.js"><link rel="prefetch" href="/assets/js/358.22886190.js"><link rel="prefetch" href="/assets/js/359.1f40fcc5.js"><link rel="prefetch" href="/assets/js/360.630b9c12.js"><link rel="prefetch" href="/assets/js/37.6608ea0a.js"><link rel="prefetch" href="/assets/js/38.4c69b602.js"><link rel="prefetch" href="/assets/js/39.19f940a6.js"><link rel="prefetch" href="/assets/js/4.55a001d1.js"><link rel="prefetch" href="/assets/js/40.d3257c4f.js"><link rel="prefetch" href="/assets/js/41.89db1eaf.js"><link rel="prefetch" href="/assets/js/42.4a12d693.js"><link rel="prefetch" href="/assets/js/43.cbe3ed47.js"><link rel="prefetch" href="/assets/js/44.61c79193.js"><link rel="prefetch" href="/assets/js/45.ce5ed428.js"><link rel="prefetch" href="/assets/js/46.eea0f2fa.js"><link rel="prefetch" href="/assets/js/47.f3bd04d8.js"><link rel="prefetch" href="/assets/js/48.ed81abeb.js"><link rel="prefetch" href="/assets/js/49.978d3cae.js"><link rel="prefetch" href="/assets/js/5.fe551af2.js"><link rel="prefetch" href="/assets/js/50.e21176fc.js"><link rel="prefetch" href="/assets/js/51.2f5a0327.js"><link rel="prefetch" href="/assets/js/52.125f820a.js"><link rel="prefetch" href="/assets/js/53.4a1c114d.js"><link rel="prefetch" href="/assets/js/54.dfe3253b.js"><link rel="prefetch" href="/assets/js/55.5959dcbb.js"><link rel="prefetch" href="/assets/js/56.9d18670e.js"><link rel="prefetch" href="/assets/js/57.c238fb54.js"><link rel="prefetch" href="/assets/js/58.e221eedb.js"><link rel="prefetch" href="/assets/js/59.f628533d.js"><link rel="prefetch" href="/assets/js/6.4670d323.js"><link rel="prefetch" href="/assets/js/60.919ac5be.js"><link rel="prefetch" href="/assets/js/61.3a63b17e.js"><link rel="prefetch" href="/assets/js/62.e61011ad.js"><link rel="prefetch" href="/assets/js/63.55200ef4.js"><link rel="prefetch" href="/assets/js/64.7c19f83d.js"><link rel="prefetch" href="/assets/js/65.833da817.js"><link rel="prefetch" href="/assets/js/66.13f4f83f.js"><link rel="prefetch" href="/assets/js/67.0c77e799.js"><link rel="prefetch" href="/assets/js/68.cc0e543d.js"><link rel="prefetch" href="/assets/js/69.555bef08.js"><link rel="prefetch" href="/assets/js/7.90cda232.js"><link rel="prefetch" href="/assets/js/70.5d2ec40f.js"><link rel="prefetch" href="/assets/js/71.81f1af4b.js"><link rel="prefetch" href="/assets/js/72.8a66936f.js"><link rel="prefetch" href="/assets/js/73.2655fba2.js"><link rel="prefetch" href="/assets/js/74.ba0b3153.js"><link rel="prefetch" href="/assets/js/75.536955ba.js"><link rel="prefetch" href="/assets/js/76.3a946a81.js"><link rel="prefetch" href="/assets/js/77.9b243f6c.js"><link rel="prefetch" href="/assets/js/78.f580a907.js"><link rel="prefetch" href="/assets/js/79.38cbcc11.js"><link rel="prefetch" href="/assets/js/8.9cebf18a.js"><link rel="prefetch" href="/assets/js/80.e82012e8.js"><link rel="prefetch" href="/assets/js/81.73c65f97.js"><link rel="prefetch" href="/assets/js/82.ddfa06dd.js"><link rel="prefetch" href="/assets/js/83.b75fcea2.js"><link rel="prefetch" href="/assets/js/84.5e0efc6d.js"><link rel="prefetch" href="/assets/js/85.3a495ae2.js"><link rel="prefetch" href="/assets/js/86.1ebe8967.js"><link rel="prefetch" href="/assets/js/87.cd673062.js"><link rel="prefetch" href="/assets/js/88.f50e4960.js"><link rel="prefetch" href="/assets/js/89.06660ffb.js"><link rel="prefetch" href="/assets/js/9.04fce59d.js"><link rel="prefetch" href="/assets/js/90.aa61aeaf.js"><link rel="prefetch" href="/assets/js/91.865e8535.js"><link rel="prefetch" href="/assets/js/92.fd2d2a62.js"><link rel="prefetch" href="/assets/js/93.b185de83.js"><link rel="prefetch" href="/assets/js/94.f5290c38.js"><link rel="prefetch" href="/assets/js/95.be5b7fed.js"><link rel="prefetch" href="/assets/js/96.d442acd0.js"><link rel="prefetch" href="/assets/js/97.2f9b0746.js"><link rel="prefetch" href="/assets/js/98.3bba4945.js"><link rel="prefetch" href="/assets/js/99.cd82a6ed.js">
    <link rel="stylesheet" href="/assets/css/0.styles.237ce36e.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="wen chao" class="logo"> <span class="site-name can-hide">wen chao</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Algorithm" class="dropdown-title"><a href="/Algorithm/" class="link-title">Algorithm</a> <span class="title" style="display:none;">Algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d8e764/" class="nav-link">Theory</a></li><li class="dropdown-item"><!----> <a href="/pages/81a4bd/" class="nav-link">LeetCode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/Spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/373439/" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technology" class="dropdown-title"><a href="/Technology/" class="link-title">Technology</a> <span class="title" style="display:none;">Technology</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3b6841/" class="nav-link">DB</a></li><li class="dropdown-item"><!----> <a href="/pages/d7857e/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b89362/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/ec8b81/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/pages/4e3ff1/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/a75fef/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/pages/b194d7/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/pages/371f2f/" class="nav-link">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/027aa3/" class="nav-link">Workflow</a></li><li class="dropdown-item"><!----> <a href="/pages/73ab4b/" class="nav-link">OAuth2</a></li><li class="dropdown-item"><!----> <a href="/pages/d7a38a/" class="nav-link">JPA</a></li><li class="dropdown-item"><!----> <a href="/pages/eb5dc1/" class="nav-link">Liquibase</a></li><li class="dropdown-item"><!----> <a href="/pages/e54277/" class="nav-link">Lombok</a></li><li class="dropdown-item"><!----> <a href="/pages/62e4f6/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/13c836/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/b50b3d/" class="nav-link">Mini Program</a></li><li class="dropdown-item"><!----> <a href="/pages/09d3b8/" class="nav-link">JVM</a></li><li class="dropdown-item"><!----> <a href="/pages/a526c7/" class="nav-link">Log</a></li><li class="dropdown-item"><!----> <a href="/pages/59cf4f/" class="nav-link">JDK</a></li><li class="dropdown-item"><!----> <a href="/pages/d50dab/" class="nav-link">Thymeleaf</a></li><li class="dropdown-item"><!----> <a href="/pages/97abaa/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/7879f1/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/745b7c/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/pages/274dac/" class="nav-link">Raspberrypi</a></li><li class="dropdown-item"><!----> <a href="/pages/87c097/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/pages/927664/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/2c3f19/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><a href="/Other/" class="link-title">Other</a> <span class="title" style="display:none;">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fea344/" class="nav-link">Book</a></li><li class="dropdown-item"><!----> <a href="/pages/d62f72/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/f3d338/" class="nav-link">问题</a></li><li class="dropdown-item"><!----> <a href="/pages/ff202b/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/pages/2b746e/" class="nav-link">证券</a></li></ul></div></div><div class="nav-item"><a href="/About/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Index" class="dropdown-title"><a href="/archives/" class="link-title">Index</a> <span class="title" style="display:none;">Index</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/touxiang-lanse.png"> <div class="blogger-info"><h3>wen chao</h3> <span>持之以恒做正确有价值的事!</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Algorithm" class="dropdown-title"><a href="/Algorithm/" class="link-title">Algorithm</a> <span class="title" style="display:none;">Algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/d8e764/" class="nav-link">Theory</a></li><li class="dropdown-item"><!----> <a href="/pages/81a4bd/" class="nav-link">LeetCode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/Spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/373439/" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Technology" class="dropdown-title"><a href="/Technology/" class="link-title">Technology</a> <span class="title" style="display:none;">Technology</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3b6841/" class="nav-link">DB</a></li><li class="dropdown-item"><!----> <a href="/pages/d7857e/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/pages/b89362/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/ec8b81/" class="nav-link">MongoDB</a></li><li class="dropdown-item"><!----> <a href="/pages/4e3ff1/" class="nav-link">Zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/a75fef/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/pages/b194d7/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/pages/371f2f/" class="nav-link">ElasticSearch</a></li><li class="dropdown-item"><!----> <a href="/pages/027aa3/" class="nav-link">Workflow</a></li><li class="dropdown-item"><!----> <a href="/pages/73ab4b/" class="nav-link">OAuth2</a></li><li class="dropdown-item"><!----> <a href="/pages/d7a38a/" class="nav-link">JPA</a></li><li class="dropdown-item"><!----> <a href="/pages/eb5dc1/" class="nav-link">Liquibase</a></li><li class="dropdown-item"><!----> <a href="/pages/e54277/" class="nav-link">Lombok</a></li><li class="dropdown-item"><!----> <a href="/pages/62e4f6/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/13c836/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/b50b3d/" class="nav-link">Mini Program</a></li><li class="dropdown-item"><!----> <a href="/pages/09d3b8/" class="nav-link">JVM</a></li><li class="dropdown-item"><!----> <a href="/pages/a526c7/" class="nav-link">Log</a></li><li class="dropdown-item"><!----> <a href="/pages/59cf4f/" class="nav-link">JDK</a></li><li class="dropdown-item"><!----> <a href="/pages/d50dab/" class="nav-link">Thymeleaf</a></li><li class="dropdown-item"><!----> <a href="/pages/97abaa/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/7879f1/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/pages/745b7c/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/pages/274dac/" class="nav-link">Raspberrypi</a></li><li class="dropdown-item"><!----> <a href="/pages/87c097/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/pages/927664/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/2c3f19/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><a href="/Other/" class="link-title">Other</a> <span class="title" style="display:none;">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/fea344/" class="nav-link">Book</a></li><li class="dropdown-item"><!----> <a href="/pages/d62f72/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/f3d338/" class="nav-link">问题</a></li><li class="dropdown-item"><!----> <a href="/pages/ff202b/" class="nav-link">友链</a></li><li class="dropdown-item"><!----> <a href="/pages/2b746e/" class="nav-link">证券</a></li></ul></div></div><div class="nav-item"><a href="/About/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Index" class="dropdown-title"><a href="/archives/" class="link-title">Index</a> <span class="title" style="display:none;">Index</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>DB</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/3b6841/" class="sidebar-link">MySQL主从架构及读写分离实战</a></li><li><a href="/pages/0f160b/" class="sidebar-link">Mysql-MHA集群搭建</a></li><li><a href="/pages/2f0227/" class="sidebar-link">ShardingJDBC核心概念与快速实战</a></li><li><a href="/pages/814701/" class="sidebar-link">腾讯COS-对象存储使用</a></li><li><a href="/pages/1d4423/" class="sidebar-link">MYSQL-text类似字段里查找指定字段值，与另外一个字段值比较</a></li><li><a href="/pages/302168/" class="sidebar-link">ABC三表关联，将C表数据赋值给A表</a></li><li><a href="/pages/1b48a2/" class="sidebar-link">Linux下MySQL常用命令</a></li><li><a href="/pages/f2dba5/" class="sidebar-link">MySQL lock wait timeout exceeded; try restarting transactio解决方案</a></li><li><a href="/pages/0424e7/" class="sidebar-link">mysql-执行计划explain理解</a></li><li><a href="/pages/274aed/" class="sidebar-link">MySQL自增-SQL实现</a></li><li><a href="/pages/42314e/" class="sidebar-link">根据父id，查询子id集合的sql快速写法</a></li><li><a href="/pages/8c7f23/" class="sidebar-link">记录下Mysql外键引发的锁等待Lock wait timeout exceeded; try restarting transaction</a></li><li><a href="/pages/5d83f6/" class="sidebar-link">linux安装MySQL</a></li><li><a href="/pages/3916eb/" class="sidebar-link">MySQL数据备份_恢复</a></li><li><a href="/pages/561e93/" class="sidebar-link">记录下数据库根据父节点查询搜有的子节点sql语句（不仅仅限于第一级子节点，包括子节点的子节点）</a></li><li><a href="/pages/bc2f30/" class="sidebar-link">Mariadb连接配置参数</a></li><li><a href="/pages/09fdb1/" class="sidebar-link">CentOS7安装MySQL57</a></li><li><a href="/pages/5b2c13/" aria-current="page" class="active sidebar-link">SQL详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/5b2c13/#sql执行顺序" class="sidebar-link">SQL执行顺序</a></li><li class="sidebar-sub-header level2"><a href="/pages/5b2c13/#行转列-转置" class="sidebar-link">行转列(转置)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#华泰证券1" class="sidebar-link">华泰证券1</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#华泰证券2" class="sidebar-link">华泰证券2</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#腾讯游戏" class="sidebar-link">腾讯游戏</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#腾讯qq" class="sidebar-link">腾讯QQ</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5b2c13/#连续n天登陆" class="sidebar-link">连续N天登陆</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#oppo" class="sidebar-link">OPPO</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#脉脉" class="sidebar-link">脉脉</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#广州银行" class="sidebar-link">广州银行</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5b2c13/#窗口函数" class="sidebar-link">窗口函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#聚合类的窗口函数" class="sidebar-link">聚合类的窗口函数</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#排序类的窗口函数" class="sidebar-link">排序类的窗口函数</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#偏移类-跨行lag-lead-窗口函数" class="sidebar-link">偏移类，跨行lag / lead - 窗口函数</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#其他类-窗口函数" class="sidebar-link">其他类-窗口函数</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#真题" class="sidebar-link">真题</a></li><li class="sidebar-sub-header level4"><a href="/pages/5b2c13/#交通银行" class="sidebar-link">交通银行</a></li><li class="sidebar-sub-header level4"><a href="/pages/5b2c13/#跨越物流" class="sidebar-link">跨越物流</a></li><li class="sidebar-sub-header level4"><a href="/pages/5b2c13/#广州银行-2" class="sidebar-link">广州银行</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5b2c13/#分组内top前几" class="sidebar-link">分组内top前几</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#解题思路" class="sidebar-link">解题思路</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#真题-2" class="sidebar-link">真题</a></li><li class="sidebar-sub-header level4"><a href="/pages/5b2c13/#跨越物流-2" class="sidebar-link">跨越物流</a></li><li class="sidebar-sub-header level4"><a href="/pages/5b2c13/#小米电商" class="sidebar-link">小米电商</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5b2c13/#n日留存率" class="sidebar-link">N日留存率</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#方案1-性能快-步骤稍微复杂" class="sidebar-link">方案1：性能快，步骤稍微复杂</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#方案2-性能慢-但是步骤比较简单" class="sidebar-link">方案2：性能慢，但是步骤比较简单</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#真题-3" class="sidebar-link">真题</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5b2c13/#join系列" class="sidebar-link">join系列</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#left-join" class="sidebar-link">left join</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#right-join" class="sidebar-link">right join</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#left-semi-join" class="sidebar-link">left semi join</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#left-anti-join" class="sidebar-link">left anti join</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#full-join" class="sidebar-link">full join</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#真题-4" class="sidebar-link">真题</a></li><li class="sidebar-sub-header level4"><a href="/pages/5b2c13/#字节跳动" class="sidebar-link">字节跳动</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5b2c13/#join优化" class="sidebar-link">join优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#交通银行-2" class="sidebar-link">交通银行</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5b2c13/#带条件的聚合统计" class="sidebar-link">带条件的聚合统计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#小米电商-2" class="sidebar-link">小米电商</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#华泰证券" class="sidebar-link">华泰证券</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5b2c13/#explode爆炸函数" class="sidebar-link">explode爆炸函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#腾讯qq-2" class="sidebar-link">腾讯QQ</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#vivo" class="sidebar-link">vivo</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5b2c13/#cte语句-with-as语句" class="sidebar-link">CTE语句(with as语句)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#字节跳动-2" class="sidebar-link">字节跳动</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/5b2c13/#综合案例" class="sidebar-link">综合案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#腾讯互娱" class="sidebar-link">腾讯互娱</a></li><li class="sidebar-sub-header level3"><a href="/pages/5b2c13/#巴别时代" class="sidebar-link">巴别时代</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Zookeeper</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Dubbo</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ElasticSearch</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Workflow</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OAuth2</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JPA</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Liquibase</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Lombok</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Log</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JDK</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Thymeleaf</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Maven</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mybatis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Raspberrypi</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/Technology/#Technology" data-v-06225672>Technology</a></li><li data-v-06225672><a href="/Technology/#DB" data-v-06225672>DB</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://nylg.gitee.io" target="_blank" title="作者" class="beLink" data-v-06225672>wen chao</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-02-03</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">SQL详解<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="sql执行顺序"><a href="#sql执行顺序" class="header-anchor">#</a> SQL执行顺序</h2> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">--举例：</span>
<span class="token keyword">select</span> 
       a<span class="token punctuation">.</span>sex<span class="token punctuation">,</span>
       b<span class="token punctuation">.</span>city<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">as</span> sum1
<span class="token keyword">from</span> table1 a
<span class="token keyword">join</span> table2 b <span class="token keyword">on</span> a<span class="token punctuation">.</span>id<span class="token operator">=</span>b<span class="token punctuation">.</span>id
<span class="token keyword">where</span> a<span class="token punctuation">.</span>name<span class="token operator">=</span>b<span class="token punctuation">.</span>name
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>sex<span class="token punctuation">,</span>b<span class="token punctuation">.</span>city
<span class="token keyword">having</span> cnt<span class="token operator">&gt;=</span><span class="token number">2</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>sex<span class="token punctuation">,</span>b<span class="token punctuation">.</span>city
<span class="token keyword">limit</span> <span class="token number">10</span>

<span class="token comment">--或者是</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span>
       a<span class="token punctuation">.</span>sex<span class="token punctuation">,</span>
       b<span class="token punctuation">.</span>city<span class="token punctuation">,</span>
       a<span class="token punctuation">.</span>age
<span class="token keyword">from</span> table1 a
<span class="token keyword">join</span> table2 b <span class="token keyword">on</span> a<span class="token punctuation">.</span>id<span class="token operator">=</span>b<span class="token punctuation">.</span>id
<span class="token keyword">where</span> a<span class="token punctuation">.</span>name<span class="token operator">=</span>b<span class="token punctuation">.</span>name
<span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>sex<span class="token punctuation">,</span>b<span class="token punctuation">.</span>city
<span class="token keyword">limit</span> <span class="token number">10</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>上面的SQL语句的执行顺序是: from (去加载table1 和 table2这2个表 )  -&gt; join -&gt; on -&gt; where  -&gt; group by-&gt;select 后面的聚合函数count,sum  -&gt; having -&gt; distinct -&gt; order by -&gt; limit</p> <h2 id="行转列-转置"><a href="#行转列-转置" class="header-anchor">#</a> 行转列(转置)</h2> <ul><li>行转列的常规做法是，group by+sum(if())【或count(if())】</li></ul> <blockquote><p>与行转列，对应相反的是，列转行，此时用explode+侧视图</p></blockquote> <h3 id="华泰证券1"><a href="#华泰证券1" class="header-anchor">#</a> 华泰证券1</h3> <p>已知</p> <table><thead><tr><th>year</th> <th>month</th> <th>amount</th></tr></thead> <tbody><tr><td>1991</td> <td>1</td> <td>1.1</td></tr> <tr><td>1991</td> <td>2</td> <td>1.2</td></tr> <tr><td>1991</td> <td>3</td> <td>1.3</td></tr> <tr><td>1991</td> <td>4</td> <td>1.4</td></tr> <tr><td>1992</td> <td>1</td> <td>2.1</td></tr> <tr><td>1992</td> <td>2</td> <td>2.2</td></tr> <tr><td>1992</td> <td>3</td> <td>2.3</td></tr> <tr><td>1992</td> <td>4</td> <td>2.4</td></tr></tbody></table> <p>查成这样一个结果</p> <table><thead><tr><th>year</th> <th>m1</th> <th>m2</th> <th>m3</th> <th>m4</th></tr></thead> <tbody><tr><td>1991</td> <td>1.1</td> <td>1.2</td> <td>1.3</td> <td>1.4</td></tr> <tr><td>1992</td> <td>2.1</td> <td>2.2</td> <td>2.3</td> <td>2.4</td></tr></tbody></table> <p>解答</p> <ul><li><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">use</span> test_sql<span class="token punctuation">;</span>
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token punctuation">.</span><span class="token keyword">local</span><span class="token punctuation">.</span>auto<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> table2<span class="token punctuation">(</span><span class="token keyword">year</span> <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">month</span> <span class="token keyword">int</span> <span class="token punctuation">,</span>amount <span class="token keyword">double</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
 <span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> table2 <span class="token keyword">values</span>
           <span class="token punctuation">(</span><span class="token number">1991</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token punctuation">(</span><span class="token number">1991</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token punctuation">(</span><span class="token number">1991</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token punctuation">(</span><span class="token number">1991</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token punctuation">(</span><span class="token number">1992</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token punctuation">(</span><span class="token number">1992</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token punctuation">(</span><span class="token number">1992</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token punctuation">(</span><span class="token number">1992</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> table2<span class="token punctuation">;</span>


<span class="token comment">--行转列</span>
<span class="token comment">--常规做法是，group by+sum(if())</span>
<span class="token comment">--原始写法</span>
<span class="token keyword">select</span> <span class="token keyword">year</span><span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token keyword">as</span> m1<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">as</span> m2<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token keyword">as</span> m3<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token keyword">as</span> m4
<span class="token keyword">from</span>
    <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">month</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> a<span class="token punctuation">,</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">month</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> b<span class="token punctuation">,</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">month</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> c<span class="token punctuation">,</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">month</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> d
     <span class="token keyword">from</span> table2<span class="token punctuation">)</span> t
<span class="token keyword">group</span> <span class="token keyword">by</span> t<span class="token punctuation">.</span><span class="token keyword">year</span>
<span class="token punctuation">;</span>
<span class="token comment">--简化写法</span>
<span class="token keyword">select</span> <span class="token keyword">year</span><span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">month</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> m1<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">month</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> m2<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">month</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> m3<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">month</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> m4
<span class="token keyword">from</span> table2
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">year</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div></li></ul> <h3 id="华泰证券2"><a href="#华泰证券2" class="header-anchor">#</a> 华泰证券2</h3> <ul><li><p>查询课程编号“2”的成绩比课程编号“1”低的所有同学的学号、姓名。</p></li> <li><p>【这是行转列的衍生题】</p></li> <li><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> student<span class="token punctuation">(</span>sid <span class="token keyword">int</span><span class="token punctuation">,</span> sname string<span class="token punctuation">,</span> gender string<span class="token punctuation">,</span> class_id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> student
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token string">'女'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'李四'</span><span class="token punctuation">,</span> <span class="token string">'女'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'王五'</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span>  course <span class="token punctuation">(</span>cid <span class="token keyword">int</span><span class="token punctuation">,</span> cname string<span class="token punctuation">,</span> teacher_id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> course
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'生物'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'体育'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'物理'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> course<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> score <span class="token punctuation">(</span>sid <span class="token keyword">int</span><span class="token punctuation">,</span> student_id <span class="token keyword">int</span><span class="token punctuation">,</span> course_id <span class="token keyword">int</span><span class="token punctuation">,</span> number <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> score
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score<span class="token punctuation">;</span>

<span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span> student_id<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>course_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>number<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pe<span class="token punctuation">,</span> <span class="token comment">--体育</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>course_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>number<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> bio <span class="token comment">--生物</span>
<span class="token keyword">from</span> score
<span class="token keyword">group</span> <span class="token keyword">by</span> student_id
<span class="token keyword">having</span> pe<span class="token operator">&lt;</span>bio<span class="token punctuation">)</span>
<span class="token keyword">select</span> sid<span class="token punctuation">,</span> sname
<span class="token keyword">from</span> t1
<span class="token keyword">join</span> student
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>student_id <span class="token operator">=</span> sid
<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div></li></ul> <h3 id="腾讯游戏"><a href="#腾讯游戏" class="header-anchor">#</a> 腾讯游戏</h3> <p>表table如下：</p> <table><thead><tr><th>DDate</th> <th>shengfu</th></tr></thead> <tbody><tr><td>2015-05-09</td> <td>胜</td></tr> <tr><td>2015-05-09</td> <td>胜</td></tr> <tr><td>2015-05-09</td> <td>负</td></tr> <tr><td>2015-05-09</td> <td>负</td></tr> <tr><td>2015-05-10</td> <td>胜</td></tr> <tr><td>2015-05-10</td> <td>负</td></tr> <tr><td>2015-05-10</td> <td>负</td></tr></tbody></table> <p>如果要生成下列结果, 该如何写sql语句?</p> <table><thead><tr><th>DDate</th> <th>胜</th> <th>负</th></tr></thead> <tbody><tr><td>2015-05-09</td> <td>2</td> <td>2</td></tr> <tr><td>2015-05-10</td> <td>1</td> <td>2</td></tr></tbody></table> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">--建表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> table1<span class="token punctuation">(</span>DDate string<span class="token punctuation">,</span> shengfu string<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> table1 <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2015-05-09'</span><span class="token punctuation">,</span> <span class="token string">&quot;胜&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'2015-05-09'</span><span class="token punctuation">,</span> <span class="token string">&quot;胜&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'2015-05-09'</span><span class="token punctuation">,</span> <span class="token string">&quot;负&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'2015-05-09'</span><span class="token punctuation">,</span> <span class="token string">&quot;负&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'2015-05-10'</span><span class="token punctuation">,</span> <span class="token string">&quot;胜&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'2015-05-10'</span><span class="token punctuation">,</span> <span class="token string">&quot;负&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'2015-05-10'</span><span class="token punctuation">,</span> <span class="token string">&quot;负&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> DDate<span class="token punctuation">,</span>
       <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> shengfu <span class="token operator">=</span> <span class="token string">'胜'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token identifier"><span class="token punctuation">`</span>胜<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
       <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> shengfu <span class="token operator">=</span> <span class="token string">'负'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token identifier"><span class="token punctuation">`</span>负<span class="token punctuation">`</span></span>
<span class="token keyword">from</span> table1
<span class="token keyword">group</span> <span class="token keyword">by</span> DDate<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="腾讯qq"><a href="#腾讯qq" class="header-anchor">#</a> 腾讯QQ</h3> <p>假设tableA如表5, tableB如表6,</p> <p>表5</p> <table><thead><tr><th>qq号（字段名：qq）</th> <th>游戏（字段名：game）</th></tr></thead> <tbody><tr><td>10000</td> <td>a</td></tr> <tr><td>10000</td> <td>b</td></tr> <tr><td>10000</td> <td>c</td></tr> <tr><td>20000</td> <td>c</td></tr> <tr><td>20000</td> <td>d</td></tr></tbody></table> <p>表6</p> <table><thead><tr><th>qq号（字段名：qq）</th> <th>游戏（字段名：game）</th></tr></thead> <tbody><tr><td>10000</td> <td>a_b_c</td></tr> <tr><td>20000</td> <td>c_d</td></tr></tbody></table> <p>请写出以下sql逻辑：</p> <p>a,	将tableA输出为tableB的格式； 【行转列】</p> <p>b,	将tableB输出为tableA的格式;   【列转行】</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> tableA<span class="token punctuation">(</span>qq string<span class="token punctuation">,</span> game string<span class="token punctuation">)</span> 
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> tableA <span class="token keyword">values</span> 
       <span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> tableB<span class="token punctuation">(</span>qq string<span class="token punctuation">,</span> game string<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> tableB <span class="token keyword">values</span> 
<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token string">'a_b_c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">,</span> <span class="token string">'c_d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
<span class="token comment">--将tableA输出为tableB的格式；  </span>
<span class="token keyword">select</span> qq<span class="token punctuation">,</span>
       concat_ws<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">,</span> collect_list<span class="token punctuation">(</span>game<span class="token punctuation">)</span><span class="token punctuation">)</span> game
<span class="token keyword">from</span> tableA
<span class="token keyword">group</span> <span class="token keyword">by</span> qq<span class="token punctuation">;</span>   
       
<span class="token comment">--将tableB输出为tableA的格式;    </span>
<span class="token keyword">select</span> qq<span class="token punctuation">,</span>
       tmp<span class="token punctuation">.</span>game
<span class="token keyword">from</span> tableB lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>game<span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> game<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="连续n天登陆"><a href="#连续n天登陆" class="header-anchor">#</a> 连续N天登陆</h2> <ul><li><p>思路分析过程</p> <ul><li><p><img src="D:/BaiduNetdiskDownload/sql/%E7%AC%AC7%E5%9C%BA-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B1/images/1659757393656.png" alt="1659757393656"></p></li> <li><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">--核心代码</span>
<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token keyword">distinct</span>
<span class="token operator">-</span><span class="token operator">&gt;</span> row_number  <span class="token keyword">as</span> rn
<span class="token operator">-</span><span class="token operator">&gt;</span> date_sub<span class="token punctuation">(</span>dt<span class="token punctuation">,</span>rn<span class="token punctuation">)</span> <span class="token keyword">as</span> dt2
<span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">group</span> <span class="token keyword">by</span> dt2<span class="token punctuation">,</span>name 
<span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span>N天 
<span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">distinct</span> name 
<span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">count</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>思路2</p></li> <li><p><img src="D:/BaiduNetdiskDownload/sql/%E7%AC%AC7%E5%9C%BA-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B1/images/1659759179547.png" alt="1659759179547"></p></li> <li><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">--核心代码</span>
<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token keyword">distinct</span>
<span class="token operator">-</span><span class="token operator">&gt;</span>date_add<span class="token punctuation">(</span>dt<span class="token punctuation">,</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> date2
<span class="token operator">-</span><span class="token operator">&gt;</span>lead<span class="token punctuation">(</span>dt<span class="token punctuation">,</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> userid <span class="token keyword">order</span> <span class="token keyword">by</span> dt<span class="token punctuation">)</span> <span class="token keyword">as</span> date3
<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token keyword">where</span> date2<span class="token operator">=</span>date3
<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token keyword">distinct</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ul></li></ul> <h3 id="oppo"><a href="#oppo" class="header-anchor">#</a> OPPO</h3> <p>3、以下为用户登陆游戏的日期，用一条sQL语句查询出连续三天登录的人员姓名</p> <table><thead><tr><th>name</th> <th>date</th></tr></thead> <tbody><tr><td>张三</td> <td>2021-01-01</td></tr> <tr><td>张三</td> <td>2021-01-02</td></tr> <tr><td>张三</td> <td>2021-01-03</td></tr> <tr><td>张三</td> <td>2021-01-02</td></tr> <tr><td>李四</td> <td>2021-01-01</td></tr> <tr><td>李四</td> <td>2021-01-02</td></tr> <tr><td>王五</td> <td>2021-01-03</td></tr> <tr><td>王五</td> <td>2021-01-02</td></tr> <tr><td>王五</td> <td>2021-01-02</td></tr></tbody></table> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> game<span class="token punctuation">(</span>name string<span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span> string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> game <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token string">'2021-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token string">'2021-01-02'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token string">'2021-01-03'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token string">'2021-01-02'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token string">'2021-01-07'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token string">'2021-01-08'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token string">'2021-01-09'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token punctuation">(</span><span class="token string">'李四'</span><span class="token punctuation">,</span><span class="token string">'2021-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'李四'</span><span class="token punctuation">,</span><span class="token string">'2021-01-02'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'王五'</span><span class="token punctuation">,</span><span class="token string">'2021-01-03'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'王五'</span><span class="token punctuation">,</span><span class="token string">'2021-01-02'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'王五'</span><span class="token punctuation">,</span><span class="token string">'2021-01-02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span> <span class="token keyword">select</span> <span class="token keyword">distinct</span>  name<span class="token punctuation">,</span><span class="token keyword">date</span> <span class="token keyword">from</span> game<span class="token punctuation">)</span><span class="token punctuation">,</span>
     t2 <span class="token keyword">as</span> <span class="token punctuation">(</span> <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
                    row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> name <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">)</span> rn
         <span class="token keyword">from</span> t1<span class="token punctuation">)</span><span class="token punctuation">,</span>
     t3 <span class="token keyword">as</span> <span class="token punctuation">(</span> <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>date_sub<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span>rn<span class="token punctuation">)</span> date2 <span class="token keyword">from</span> t2 <span class="token punctuation">)</span>
     <span class="token keyword">select</span> <span class="token keyword">distinct</span> name <span class="token keyword">from</span> t3 <span class="token keyword">group</span> <span class="token keyword">by</span> name<span class="token punctuation">,</span>date2 <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">3</span><span class="token punctuation">;</span>
     
     
<span class="token comment">--方案二</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> game<span class="token punctuation">;</span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token keyword">distinct</span> name<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span> <span class="token keyword">from</span> game
<span class="token punctuation">)</span><span class="token punctuation">,</span>
    t2 <span class="token keyword">as</span> <span class="token punctuation">(</span>
        <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
               date_add<span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> date2<span class="token punctuation">,</span>
               lead<span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> name <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">as</span> date3
          <span class="token keyword">from</span> t1
    <span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> name <span class="token keyword">from</span> t2 <span class="token keyword">where</span> date2<span class="token operator">=</span>date3<span class="token punctuation">;</span>
<span class="token comment">--方案二的写法2</span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token keyword">distinct</span> name<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span> <span class="token keyword">from</span> game
<span class="token punctuation">)</span><span class="token punctuation">,</span>
    t2 <span class="token keyword">as</span> <span class="token punctuation">(</span>
        <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
               lead<span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> name <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">as</span> date3
          <span class="token keyword">from</span> t1
    <span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> name <span class="token keyword">from</span> t2 <span class="token keyword">where</span> datediff<span class="token punctuation">(</span>date3<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h3 id="脉脉"><a href="#脉脉" class="header-anchor">#</a> 脉脉</h3> <p>用户每日登陆脉脉会访问app不同的模块，现有两个表</p> <p>表1记录了每日脉脉活跃用户的uid和不同模块的活跃时长</p> <p>表2记录了脉脉所有注册用户的一些属性</p> <p>表1：maimai.dau</p> <table><thead><tr><th>d</th> <th>uid</th> <th>module</th> <th>active_duration</th> <th>列说明</th></tr></thead> <tbody><tr><td>2020-01-01</td> <td>1</td> <td>jobs</td> <td>324</td> <td>d：活跃的日期uid：用户的唯一编码module：用户活跃模块actre.duration：该模块下对应的活跃时长（单位：s）</td></tr> <tr><td>2020-01-01</td> <td>2</td> <td>feeds</td> <td>445</td> <td></td></tr> <tr><td>2020-01-01</td> <td>3</td> <td>im</td> <td>345</td> <td></td></tr> <tr><td>2020-01-02</td> <td>2</td> <td>network</td> <td>765</td> <td></td></tr> <tr><td>2020-01-02</td> <td>3</td> <td>jobs</td> <td>342</td> <td></td></tr> <tr><td>…</td> <td>…</td> <td>…</td> <td>…</td> <td></td></tr></tbody></table> <p>在过去一个月内,曾连续两天活跃的用户</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 建表</span>
<span class="token comment">-- 表1 dau   记录了每日脉脉活跃用户的uid和不同模块的活跃时长</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> dau<span class="token punctuation">(</span>d string<span class="token punctuation">,</span> uid <span class="token keyword">int</span><span class="token punctuation">,</span> module string<span class="token punctuation">,</span> active_duration <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dau
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2020-01-01'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'jobs'</span><span class="token punctuation">,</span> <span class="token number">324</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'2020-01-01'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'feeds'</span><span class="token punctuation">,</span> <span class="token number">445</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'2020-01-01'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'im'</span><span class="token punctuation">,</span> <span class="token number">345</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'2020-01-02'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'network'</span><span class="token punctuation">,</span> <span class="token number">765</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'2020-01-02'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'jobs'</span><span class="token punctuation">,</span> <span class="token number">342</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> dau<span class="token punctuation">;</span>


<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token keyword">DISTINCT</span> d<span class="token punctuation">,</span> uid <span class="token keyword">from</span> dau<span class="token punctuation">)</span><span class="token punctuation">,</span>
     t2 <span class="token keyword">as</span> <span class="token punctuation">(</span>
         <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
                date_sub<span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token punctuation">(</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> uid <span class="token keyword">order</span> <span class="token keyword">by</span> d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> dis
         <span class="token keyword">from</span> t1
         <span class="token keyword">where</span> d <span class="token operator">&lt;=</span> <span class="token identifier"><span class="token punctuation">`</span>current_date<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token operator">and</span> d <span class="token operator">&gt;=</span> date_sub<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>current_date<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
t3 <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> uid<span class="token punctuation">,</span>
           <span class="token function">min</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>   <span class="token identifier"><span class="token punctuation">`</span>开始日期<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
           <span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>   <span class="token identifier"><span class="token punctuation">`</span>结束日期<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
           <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token identifier"><span class="token punctuation">`</span>连续登入天数<span class="token punctuation">`</span></span>
    <span class="token keyword">from</span> t2
    <span class="token keyword">group</span> <span class="token keyword">by</span> uid<span class="token punctuation">,</span>dis
    <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span> 
<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token keyword">DISTINCT</span> uid <span class="token keyword">from</span> t3 <span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="广州银行"><a href="#广州银行" class="header-anchor">#</a> 广州银行</h3> <p>有一张表C_T（列举了部分数据）表示持卡人消费记录，表结构如下：</p> <table><thead><tr><th>CARD NER</th> <th>VARCHAR2</th> <th>卡号，</th></tr></thead> <tbody><tr><td>C_MONTH</td> <td>NUMBER</td> <td>消费月份，</td></tr> <tr><td>C_DATE</td> <td>DATE</td> <td>消费日期，</td></tr> <tr><td>C_TYPEVAR</td> <td>CHAR2</td> <td>消费类型</td></tr> <tr><td>C_ATM</td> <td>NUMBER</td> <td>消费金额</td></tr></tbody></table> <p>每个月每张卡连续消费的最大天数（如卡在当月只有一次消费则为1）。</p> <p>连续消费天数：指一楼时间内连续每天都有消费，同一天有多笔消费算一天消费，不能跨月份统计。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> c_t
<span class="token punctuation">(</span>
    card_nbr string<span class="token punctuation">,</span>
    c_month  string<span class="token punctuation">,</span>
    c_date   string<span class="token punctuation">,</span>
    c_type   string<span class="token punctuation">,</span>
    c_atm    <span class="token keyword">decimal</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> c_t <span class="token keyword">values</span>
                               <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2022-01'</span><span class="token punctuation">,</span><span class="token string">'2022-01-01'</span><span class="token punctuation">,</span><span class="token string">'网购'</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2022-01'</span><span class="token punctuation">,</span><span class="token string">'2022-01-02'</span><span class="token punctuation">,</span><span class="token string">'网购'</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2022-01'</span><span class="token punctuation">,</span><span class="token string">'2022-01-03'</span><span class="token punctuation">,</span><span class="token string">'网购'</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2022-01'</span><span class="token punctuation">,</span><span class="token string">'2022-01-15'</span><span class="token punctuation">,</span><span class="token string">'网购'</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2022-01'</span><span class="token punctuation">,</span><span class="token string">'2022-01-16'</span><span class="token punctuation">,</span><span class="token string">'网购'</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2022-01'</span><span class="token punctuation">,</span><span class="token string">'2022-01-06'</span><span class="token punctuation">,</span><span class="token string">'网购'</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2022-01'</span><span class="token punctuation">,</span><span class="token string">'2022-01-07'</span><span class="token punctuation">,</span><span class="token string">'网购'</span><span class="token punctuation">,</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2022-02'</span><span class="token punctuation">,</span><span class="token string">'2022-02-01'</span><span class="token punctuation">,</span><span class="token string">'网购'</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2022-02'</span><span class="token punctuation">,</span><span class="token string">'2022-02-02'</span><span class="token punctuation">,</span><span class="token string">'网购'</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2022-02'</span><span class="token punctuation">,</span><span class="token string">'2022-02-03'</span><span class="token punctuation">,</span><span class="token string">'网购'</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2022-02'</span><span class="token punctuation">,</span><span class="token string">'2022-02-06'</span><span class="token punctuation">,</span><span class="token string">'网购'</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2022-02'</span><span class="token punctuation">,</span><span class="token string">'2022-02-07'</span><span class="token punctuation">,</span><span class="token string">'网购'</span><span class="token punctuation">,</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> card_nbr<span class="token punctuation">,</span>c_month<span class="token punctuation">,</span>c_date <span class="token keyword">from</span> c_t<span class="token punctuation">)</span><span class="token punctuation">,</span>
     t2 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> card_nbr<span class="token punctuation">,</span>c_month <span class="token keyword">order</span> <span class="token keyword">by</span> c_date<span class="token punctuation">)</span> rn <span class="token keyword">from</span> t1  <span class="token punctuation">)</span><span class="token punctuation">,</span>
     t3 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>date_sub<span class="token punctuation">(</span>c_date<span class="token punctuation">,</span>rn<span class="token punctuation">)</span> dt2 <span class="token keyword">from</span> t2  <span class="token punctuation">)</span><span class="token punctuation">,</span>
     t4 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span>  dt2<span class="token punctuation">,</span>card_nbr<span class="token punctuation">,</span>c_month<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> t3 <span class="token keyword">group</span> <span class="token keyword">by</span> dt2<span class="token punctuation">,</span>card_nbr<span class="token punctuation">,</span>c_month<span class="token punctuation">)</span><span class="token punctuation">,</span>
     t5 <span class="token keyword">as</span> <span class="token punctuation">(</span> <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> card_nbr<span class="token punctuation">,</span>c_month <span class="token keyword">order</span> <span class="token keyword">by</span> cnt <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> t4<span class="token punctuation">)</span>
<span class="token keyword">select</span> card_nbr<span class="token punctuation">,</span>c_month<span class="token punctuation">,</span>cnt <span class="token keyword">from</span> t5 <span class="token keyword">where</span> rn<span class="token operator">=</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="窗口函数"><a href="#窗口函数" class="header-anchor">#</a> 窗口函数</h2> <blockquote><p>窗口函数最重要的特点是有over关键字，代表定义窗口</p> <ul><li>函数名(字段名) over(partition by xxx,yyy order by zzz [row between rows between unbounded preceding and current row可省略])</li> <li>partition by相当于group by，进行分组；</li> <li>执行顺序：先partition by -&gt; order by -&gt; row between 起点 and 终点 -&gt; 函数名()</li></ul></blockquote> <h3 id="聚合类的窗口函数"><a href="#聚合类的窗口函数" class="header-anchor">#</a> 聚合类的窗口函数</h3> <blockquote><p>sum() over()</p> <p>count/avg/max/min</p></blockquote> <p>聚合类sun()-窗口函数举例：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 创建表，表数据
drop table  score;
create table score(
    cid int, # 班级
    sname nvarchar(255),
    score int
);
delete from score;
insert into score values (1,'张三',60);
insert into score values (1,'李四',70);
insert into score values (1,'王五',80);
insert into score values (1,'赵六',90);
insert into score values (2,'安安',80);
insert into score values (2,'平平',90);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>让每个学生都知道班级总数</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>select *,sum(score) over(partition by cid) as '班级总分' from score;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><table><thead><tr><th>cids</th> <th>name</th> <th>score</th> <th>班级总分</th></tr></thead> <tbody><tr><td>1</td> <td>张三</td> <td>60</td> <td>470</td></tr> <tr><td>1</td> <td>李四</td> <td>70</td> <td>470</td></tr> <tr><td>1</td> <td>王五</td> <td>80</td> <td>470</td></tr> <tr><td>1</td> <td>赵六</td> <td>90</td> <td>470</td></tr> <tr><td>1</td> <td>安安</td> <td>80</td> <td>470</td></tr> <tr><td>1</td> <td>平平</td> <td>90</td> <td>470</td></tr></tbody></table> <ul><li>按照 score 排序，累计score: n+n-1+....+1</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>select *,sum(score) over(order by score) as '累加数量' from score;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><table><thead><tr><th>cid</th> <th>sname</th> <th>score</th> <th>累加数量</th></tr></thead> <tbody><tr><td>1</td> <td>张三</td> <td>60</td> <td>60</td></tr> <tr><td>1</td> <td>李四</td> <td>70</td> <td>130</td></tr> <tr><td>1</td> <td>王五</td> <td>80</td> <td>290</td></tr> <tr><td>2</td> <td>安安</td> <td>80</td> <td>290</td></tr> <tr><td>1</td> <td>赵六</td> <td>90</td> <td>470</td></tr> <tr><td>2</td> <td>平平</td> <td>90</td> <td>470</td></tr></tbody></table> <p>计算同一个班级内， 每个同学和比他分数低的总分是多少</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>select *,sum(score) over(partition by cid order by score) as '累加分数' from score;
# ==等价于 （rows between unbounded preceding and current row 可以省略：rows between 起点 and 终点）
select *,sum(score) over(partition by cid order by score rows between unbounded preceding and current row ) as '累加分数' from score;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><table><thead><tr><th>cid</th> <th>sname</th> <th>score</th> <th>累加分数</th></tr></thead> <tbody><tr><td>1</td> <td>张三</td> <td>60</td> <td>60</td></tr> <tr><td>1</td> <td>李四</td> <td>70</td> <td>130</td></tr> <tr><td>1</td> <td>王五</td> <td>80</td> <td>210</td></tr> <tr><td>1</td> <td>赵六</td> <td>90</td> <td>300</td></tr> <tr><td>2</td> <td>安安</td> <td>80</td> <td>80</td></tr> <tr><td>2</td> <td>平平</td> <td>90</td> <td>170</td></tr></tbody></table> <p>计算在班级内，计算每个同事：他自己，比他低一名的，比他高一名的，这三个分数求和</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>select *,sum(score) over(partition by cid order by score rows between 1 preceding and 1 following ) as '累加分数3' from score;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>窗口函数的精髓：rows between 1 preceding and 1 following ：低N位，高N位</p> <table><thead><tr><th>cid</th> <th>sname</th> <th>score</th> <th>累加分数3</th></tr></thead> <tbody><tr><td>1</td> <td>张三</td> <td>60</td> <td>130</td></tr> <tr><td>1</td> <td>李四</td> <td>70</td> <td>210</td></tr> <tr><td>1</td> <td>王五</td> <td>80</td> <td>240</td></tr> <tr><td>1</td> <td>赵六</td> <td>90</td> <td>170</td></tr> <tr><td>2</td> <td>安安</td> <td>80</td> <td>170</td></tr> <tr><td>2</td> <td>平平</td> <td>90</td> <td>170</td></tr></tbody></table> <h3 id="排序类的窗口函数"><a href="#排序类的窗口函数" class="header-anchor">#</a> 排序类的窗口函数</h3> <blockquote><ul><li>row_number，rank，dense_rank</li> <li>偏移类的，跨行的：lag / lead</li></ul></blockquote> <p>排序类row_number，rank，dense_rank-窗口函数举例</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>delete from score;
insert into score values (1,'张三',60);
insert into score values (1,'李四',70);
insert into score values (1,'李四的弟弟',70);
insert into score values (1,'王五',80);
insert into score values (1,'赵六',90);
insert into score values (2,'安安',80);
insert into score values (2,'平平',90);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>按班级分类，将学生分数进行排名</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>select *,
       row_number() over (partition by cid order by score) as '分数排名' ,
       rank() over (partition by cid order by score) as '分数排名-支持并列但不连续',
       dense_rank() over (partition by cid order by score) as '分数排名-支持并列和连续'
from score;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><table><thead><tr><th>cid</th> <th>sname</th> <th>score</th> <th>分数排名</th> <th>分数排名-支持并列但不连续</th> <th>分数排名-支持并列和连续</th></tr></thead> <tbody><tr><td>1</td> <td>张三</td> <td>60</td> <td>1</td> <td>1</td> <td>1</td></tr> <tr><td>1</td> <td>李四</td> <td>70</td> <td>2</td> <td>2</td> <td>2</td></tr> <tr><td>1</td> <td>李四的弟弟</td> <td>70</td> <td>3</td> <td>2</td> <td>2</td></tr> <tr><td>1</td> <td>王五</td> <td>80</td> <td>4</td> <td>4</td> <td>3</td></tr> <tr><td>1</td> <td>赵六</td> <td>90</td> <td>5</td> <td>5</td> <td>4</td></tr> <tr><td>2</td> <td>安安</td> <td>80</td> <td>1</td> <td>1</td> <td>1</td></tr> <tr><td>2</td> <td>平平</td> <td>90</td> <td>2</td> <td>2</td> <td>2</td></tr></tbody></table> <h3 id="偏移类-跨行lag-lead-窗口函数"><a href="#偏移类-跨行lag-lead-窗口函数" class="header-anchor">#</a> 偏移类，跨行lag / lead - 窗口函数</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>delete from score;
insert into score values (1,'张三',60);
insert into score values (1,'李四',70);
insert into score values (1,'王五',80);
insert into score values (1,'赵六',90);
insert into score values (2,'安安',80);
insert into score values (2,'平平',90);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>同一个班级内，考的比自己低/高N名的分数是多少</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>select *,
       # 同一个班级内，考的比自己低一名的分数是多少
       lag(score,1) over (partition by cid order by score) as '低1名的分数',
       # 同一个班级内，考的比自己低两名的分数是多少
       lag(score,2) over (partition by cid order by score) as '低2名的分数',
       # 同一个班级内，考的比自己低两名的分数是多少（支持默认值）
       lag(score,2,0) over (partition by cid order by score) as '低2名的分数，默认值0',
       # 同一个班级内，考的比自己高一名的分数是多少
       lead(score,2) over (partition by cid order by score) as '高2名的分数',
       # 同一个班级内，考的比自己高两名的分数是多少（支持默认值）
       lead(score,2,0) over (partition by cid order by score) as '高2名的分数，默认值0'
from score;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><table><thead><tr><th>cid</th> <th>sname</th> <th>score</th> <th>低1名的分数</th> <th>低2名的分数</th> <th>低2名的分数，默认值0</th> <th>高2名的分数</th> <th>高2名的分数，默认值0</th></tr></thead> <tbody><tr><td>1</td> <td>张三</td> <td>60</td> <td></td> <td></td> <td>0</td> <td>80</td> <td>80</td></tr> <tr><td>1</td> <td>李四</td> <td>70</td> <td>60</td> <td></td> <td>0</td> <td>90</td> <td>90</td></tr> <tr><td>1</td> <td>王五</td> <td>80</td> <td>70</td> <td>60</td> <td>60</td> <td></td> <td>0</td></tr> <tr><td>1</td> <td>赵六</td> <td>90</td> <td>80</td> <td>70</td> <td>70</td> <td></td> <td>0</td></tr> <tr><td>2</td> <td>安安</td> <td>80</td> <td></td> <td></td> <td>0</td> <td></td> <td>0</td></tr> <tr><td>2</td> <td>平平</td> <td>90</td> <td>80</td> <td></td> <td>0</td> <td></td> <td>0</td></tr></tbody></table> <h3 id="其他类-窗口函数"><a href="#其他类-窗口函数" class="header-anchor">#</a> 其他类-窗口函数</h3> <p>【了解】first_value和last_value</p> <p>【了解】ntile</p> <h3 id="真题"><a href="#真题" class="header-anchor">#</a> 真题</h3> <h4 id="交通银行"><a href="#交通银行" class="header-anchor">#</a> 交通银行</h4> <p>Emp表的表数据如下：</p> <table><thead><tr><th>NAME</th> <th>MONTH</th> <th>AMT</th></tr></thead> <tbody><tr><td>张三</td> <td>01</td> <td>100</td></tr> <tr><td>李四</td> <td>02</td> <td>120</td></tr> <tr><td>王五</td> <td>03</td> <td>150</td></tr> <tr><td>赵六</td> <td>04</td> <td>500</td></tr> <tr><td>张三</td> <td>05</td> <td>400</td></tr> <tr><td>李四</td> <td>06</td> <td>350</td></tr> <tr><td>王五</td> <td>07</td> <td>180</td></tr> <tr><td>赵六</td> <td>08</td> <td>400</td></tr></tbody></table> <p>问题：请写出可以得到以下的结果SQL</p> <table><thead><tr><th>NAME</th> <th>总金额</th> <th>排名</th> <th>占比</th></tr></thead> <tbody><tr><td>赵六</td> <td>900</td> <td>1</td> <td>40.91%</td></tr> <tr><td>张三</td> <td>500</td> <td>2</td> <td>22.73%</td></tr> <tr><td>李四</td> <td>470</td> <td>3</td> <td>21.36%</td></tr> <tr><td>王五</td> <td>330</td> <td>4</td> <td>15.00%</td></tr></tbody></table> <p>分析：分成三步做：1，根据name分组后，统计总金额；2，排序函数row_number进行排名；3，聚合函数sum()计算数据占比；</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> emp<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> emp
<span class="token punctuation">(</span>
    name nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">month</span> nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    amt <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> emp <span class="token keyword">values</span> <span class="token punctuation">(</span>
        <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token string">'01'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'李四'</span><span class="token punctuation">,</span> <span class="token string">'02'</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'王五'</span><span class="token punctuation">,</span> <span class="token string">'03'</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'赵六'</span><span class="token punctuation">,</span> <span class="token string">'04'</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token string">'05'</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'李四'</span><span class="token punctuation">,</span> <span class="token string">'06'</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'王五'</span><span class="token punctuation">,</span> <span class="token string">'07'</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'赵六'</span><span class="token punctuation">,</span> <span class="token string">'08'</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> name<span class="token punctuation">,</span>
                   <span class="token function">sum</span><span class="token punctuation">(</span>amt<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_amt
            <span class="token keyword">from</span> emp
            <span class="token keyword">group</span> <span class="token keyword">by</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
     t2 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> name<span class="token punctuation">,</span>
                   sum_amt<span class="token punctuation">,</span> <span class="token comment"># 职工总金额</span>
                   row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token boolean">null</span> <span class="token keyword">order</span> <span class="token keyword">by</span> sum_amt <span class="token keyword">desc</span><span class="token punctuation">)</span> rn<span class="token punctuation">,</span><span class="token comment"># 排名</span>
                   <span class="token function">sum</span><span class="token punctuation">(</span>sum_amt<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total_amt<span class="token punctuation">,</span><span class="token comment"># 所有职工金额</span>
                   sum_amt <span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span>sum_amt<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  rate <span class="token comment"># 职工占总金额比例</span>
            <span class="token keyword">from</span> t1<span class="token punctuation">)</span>
<span class="token keyword">select</span> name<span class="token punctuation">,</span> sum_amt<span class="token punctuation">,</span> rn<span class="token punctuation">,</span> total_amt<span class="token punctuation">,</span> concat<span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span>rate <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'%'</span><span class="token punctuation">)</span> rate
<span class="token keyword">from</span> t2<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="跨越物流"><a href="#跨越物流" class="header-anchor">#</a> 跨越物流</h4> <p>题目描述</p> <p>在第一题员工表的基础上，统计每年入职总数以及截至本年累计入职总人数。</p> <p>截至本年累计入职总人数=本年总入职人数 + 本年之前所有年的总入职人数之和</p> <p>结果</p> <p><img src="https://gitee.com/nylg/picture/raw/master/20240202/image-20240202164108498.png" alt="image-20240202164108498"></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> year1<span class="token punctuation">)</span> cnt2
<span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">year</span><span class="token punctuation">(</span>hiredate<span class="token punctuation">)</span> <span class="token keyword">as</span> year1<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
<span class="token keyword">from</span> emp
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">year</span><span class="token punctuation">(</span>hiredate<span class="token punctuation">)</span><span class="token punctuation">)</span> a<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="广州银行-2"><a href="#广州银行-2" class="header-anchor">#</a> 广州银行</h4> <p>假设有商品表goods，数据如下</p> <table><thead><tr><th>Goods_type</th> <th>goods_name</th> <th>price</th></tr></thead> <tbody><tr><td>手机</td> <td>华为mate</td> <td>2999</td></tr> <tr><td>手机</td> <td>苹果phoneX</td> <td>7999</td></tr> <tr><td>手机</td> <td>荣耀V10</td> <td>2399</td></tr> <tr><td>水果</td> <td>车厘子</td> <td>79</td></tr> <tr><td>水果</td> <td>葡萄</td> <td>18</td></tr> <tr><td>水果</td> <td>苹果</td> <td>12</td></tr> <tr><td>电脑</td> <td>金士顿16G</td> <td>499</td></tr></tbody></table> <p>根据商品大类Goods_type对商品金额price从小到大排序；前30%为低挡，30%~85%为中档，高于85%为高档，打上标签。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> goods<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> goods
<span class="token punctuation">(</span>
    goods_type <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    goods_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    price <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> goods<span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> goods <span class="token keyword">values</span>
    <span class="token punctuation">(</span><span class="token string">'手机'</span><span class="token punctuation">,</span> <span class="token string">'华为保时捷折叠手机'</span><span class="token punctuation">,</span> <span class="token number">12000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'手机'</span><span class="token punctuation">,</span> <span class="token string">'苹果phoneX'</span><span class="token punctuation">,</span> <span class="token number">7999</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'手机'</span><span class="token punctuation">,</span> <span class="token string">'华为mate'</span><span class="token punctuation">,</span> <span class="token number">2999</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'手机'</span><span class="token punctuation">,</span> <span class="token string">'荣耀V10'</span><span class="token punctuation">,</span> <span class="token number">2399</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'水果'</span><span class="token punctuation">,</span> <span class="token string">'榴莲'</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'水果'</span><span class="token punctuation">,</span> <span class="token string">'车厘子'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'水果'</span><span class="token punctuation">,</span> <span class="token string">'葡萄'</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'水果'</span><span class="token punctuation">,</span> <span class="token string">'苹果'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'电脑'</span><span class="token punctuation">,</span> <span class="token string">'金士顿16G'</span><span class="token punctuation">,</span> <span class="token number">499</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>with t1 as (select *,
                   row_number() over (partition by goods_type order by price) as rn, -- 每个在组内的排名
                   count(1) over (partition by goods_type)                    as cnt -- 每个组内有多少个
            from goods),
     t2 as (select *,
                   rn / cnt as rate -- 比例
            from t1)
select *,
       case
           when rate &lt; 0.3 then '低挡'
           when rate &gt;= 0.3 and rate &lt; 0.85 then '中挡'
           when rate &gt;= 0.85 then '高挡'
           end as type
from t2;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>分而治之，最后简化为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>select *,
       rn / cnt as rate,
       case
           when rn / cnt &lt; 0.3 then '低挡'
           when rn / cnt &gt;= 0.3 and rn / cnt &lt; 0.85 then '中挡'
           when rn / cnt &gt;= 0.85 then '高挡'
       end flag
from (
         select *,
                row_number() over (partition by goods_type order by price) rn,
                count(1) over (partition by goods_type)                     cnt
         from goods
     ) t1;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><table><thead><tr><th>goods_type</th> <th>goods_name</th> <th>price</th> <th>rn</th> <th>cnt</th> <th>rate</th> <th>type</th></tr></thead> <tbody><tr><td>手机</td> <td>荣耀V10</td> <td>2399</td> <td>1</td> <td>4</td> <td>0.2500</td> <td>低挡</td></tr> <tr><td>手机</td> <td>华为mate</td> <td>2999</td> <td>2</td> <td>4</td> <td>0.5000</td> <td>中挡</td></tr> <tr><td>手机</td> <td>苹果phoneX</td> <td>7999</td> <td>3</td> <td>4</td> <td>0.7500</td> <td>中挡</td></tr> <tr><td>手机</td> <td>华为保时捷折叠手机</td> <td>12000</td> <td>4</td> <td>4</td> <td>1.0000</td> <td>高挡</td></tr> <tr><td>水果</td> <td>苹果</td> <td>12</td> <td>1</td> <td>4</td> <td>0.2500</td> <td>低挡</td></tr> <tr><td>水果</td> <td>葡萄</td> <td>18</td> <td>2</td> <td>4</td> <td>0.5000</td> <td>中挡</td></tr> <tr><td>水果</td> <td>车厘子</td> <td>40</td> <td>3</td> <td>4</td> <td>0.7500</td> <td>中挡</td></tr> <tr><td>水果</td> <td>榴莲</td> <td>60</td> <td>4</td> <td>4</td> <td>1.0000</td> <td>高挡</td></tr> <tr><td>电脑</td> <td>金士顿16G</td> <td>499</td> <td>1</td> <td>1</td> <td>1.0000</td> <td>高挡</td></tr></tbody></table> <h2 id="分组内top前几"><a href="#分组内top前几" class="header-anchor">#</a> 分组内top前几</h2> <h3 id="解题思路"><a href="#解题思路" class="header-anchor">#</a> 解题思路</h3> <ul><li><p>需求常见词：</p> <ul><li>【每组xxx内按yyy排序的前n个zzz】</li> <li>【每组xxx内按yyy排序的第1个zzz】</li> <li>【每组xxx内按yyy排序的最后1个zzz】</li> <li>特点是yyy和zzz是不同的字段。</li> <li>比如：班内按性别xxx分组，组内按身高yyy排序，每个性别组的前3个学生姓名zzz</li></ul></li> <li><p>公式：row_number() over(partition by 组名 order by yyy) as rn，再筛选 rn&lt;=N 名</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> 
<span class="token keyword">from</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> zzz<span class="token punctuation">,</span>
      row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 组名xxx <span class="token keyword">order</span> <span class="token keyword">by</span> yyy<span class="token punctuation">)</span>  <span class="token keyword">as</span> rn
<span class="token keyword">from</span> <span class="token keyword">table</span><span class="token punctuation">)</span> <span class="token keyword">as</span> t
<span class="token keyword">where</span>  rn<span class="token operator">&lt;=</span>N名
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul> <h3 id="真题-2"><a href="#真题-2" class="header-anchor">#</a> 真题</h3> <h4 id="跨越物流-2"><a href="#跨越物流-2" class="header-anchor">#</a> 跨越物流</h4> <p>员工表结构</p> <p><img src="https://gitee.com/nylg/picture/raw/master/20240202/image-20240202164030814.png" alt="image-20240202164030814"></p> <p>员工表数据</p> <p><img src="https://gitee.com/nylg/picture/raw/master/20240202/image-20240202164143188.png" alt="image-20240202164143188"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>drop table emp;
create table emp(empno varchar(255) ,ename varchar(255),hiredate varchar(255),sal int ,deptno varchar(255));
delete from emp;
insert into emp values
('7521', 'WARD', '1981-2-22', 1250, 30),
('7566', 'JONES', '1981-4-2', 2975, 20),
('7876', 'ADAMS', '1987-7-13', 1100, 20),
('7369', 'SMITH', '1980-12-17', 800, 20),
('7934', 'MILLER', '1982-1-23', 1300, 10),
('7844', 'TURNER', '1981-9-8', 1500, 30),
('7782', 'CLARK', '1981-6-9', 2450, 10),
('7839', 'KING', '1981-11-17', 5000, 10),
('7902', 'FORD', '1981-12-3', 3000, 20),
('7499', 'ALLEN', '1981-2-20', 1600, 30),
('7654', 'MARTIN', '1981-9-28', 1250, 30),
('7900', 'JAMES', '1981-12-3', 950, 30),
('7788', 'SCOTT', '1987-7-13', 3000, 20),
('7698', 'BLAKE', '1981-5-1', 2850, 30);
select * from emp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>题目描述</p> <p>求出每个部门工资最高的前三名员工，并计算这些员工的工资占所属部门总工资的百分比。</p> <p>结果</p> <p><img src="https://gitee.com/nylg/picture/raw/master/20240202/image-20240202164206174.png" alt="image-20240202164206174"></p> <p>分析：分成两步，1-先求出每个部门工资最高的前三名员工，2-计算这些员工的工资占所属部门总工资的百分比</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># --求出每个部门工资最高的前三名员工，并计算这些员工的工资占所属部门总工资的百分比。</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>empno <span class="token keyword">as</span> <span class="token string">'员工编号'</span><span class="token punctuation">,</span>
       a<span class="token punctuation">.</span>sal <span class="token keyword">as</span> <span class="token string">'员工工资'</span><span class="token punctuation">,</span>
       a<span class="token punctuation">.</span>deptno <span class="token keyword">as</span> <span class="token string">'部门编号'</span><span class="token punctuation">,</span>
       a<span class="token punctuation">.</span>rn <span class="token keyword">as</span> <span class="token string">'部门薪资排名'</span><span class="token punctuation">,</span>
       a<span class="token punctuation">.</span>sum_sal <span class="token keyword">as</span> <span class="token string">'部门总薪资'</span><span class="token punctuation">,</span>
       <span class="token function">round</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>sal<span class="token operator">/</span>a<span class="token punctuation">.</span>sum_sal<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'工资占部门比例'</span>
<span class="token keyword">from</span>
    <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
         row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> deptno <span class="token keyword">order</span> <span class="token keyword">by</span> sal <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rn<span class="token punctuation">,</span> <span class="token comment">-- 每个部门工资排名</span>
         <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> deptno <span class="token punctuation">)</span> <span class="token keyword">as</span> sum_sal      <span class="token comment">-- 每个部门的总工资</span>
     <span class="token keyword">from</span> emp<span class="token punctuation">)</span> a
<span class="token keyword">where</span> rn<span class="token operator">&lt;=</span><span class="token number">3</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="小米电商"><a href="#小米电商" class="header-anchor">#</a> 小米电商</h4> <p>订单表，torder.  字段，user_id, order_id,  c_date，city_id，sale_num，sku_id (商品)</p> <p>问题：20201201至今每日订单量top3的城市及其订单量(订单量对order_id去重)(在线写)</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> t_order<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t_order <span class="token punctuation">(</span>user_id string<span class="token punctuation">,</span>
                      order_id string<span class="token punctuation">,</span>
                      c_date string<span class="token punctuation">,</span>
                      city_id string<span class="token punctuation">,</span>
                      sale_num <span class="token keyword">int</span> <span class="token punctuation">,</span>
                      sku_id string<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> t_order <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">'zs'</span><span class="token punctuation">,</span><span class="token string">'001'</span><span class="token punctuation">,</span><span class="token string">'2020-12-01'</span><span class="token punctuation">,</span><span class="token string">'杭州'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'鞋子'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">,</span><span class="token string">'002'</span><span class="token punctuation">,</span><span class="token string">'2020-12-01'</span><span class="token punctuation">,</span><span class="token string">'杭州'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'衣服'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'ww'</span><span class="token punctuation">,</span><span class="token string">'003'</span><span class="token punctuation">,</span><span class="token string">'2020-12-01'</span><span class="token punctuation">,</span><span class="token string">'杭州'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'小米12'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'zl'</span><span class="token punctuation">,</span><span class="token string">'004'</span><span class="token punctuation">,</span><span class="token string">'2020-12-01'</span><span class="token punctuation">,</span><span class="token string">'杭州'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'小米11'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'zs'</span><span class="token punctuation">,</span><span class="token string">'005'</span><span class="token punctuation">,</span><span class="token string">'2020-12-01'</span><span class="token punctuation">,</span><span class="token string">'上海'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'鞋子'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'zs'</span><span class="token punctuation">,</span><span class="token string">'005'</span><span class="token punctuation">,</span><span class="token string">'2020-12-01'</span><span class="token punctuation">,</span><span class="token string">'上海'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'裤子'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">,</span><span class="token string">'006'</span><span class="token punctuation">,</span><span class="token string">'2020-12-01'</span><span class="token punctuation">,</span><span class="token string">'上海'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'衣服'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'ww'</span><span class="token punctuation">,</span><span class="token string">'007'</span><span class="token punctuation">,</span><span class="token string">'2020-12-01'</span><span class="token punctuation">,</span><span class="token string">'上海'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'小米12'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'zs'</span><span class="token punctuation">,</span><span class="token string">'008'</span><span class="token punctuation">,</span><span class="token string">'2020-12-01'</span><span class="token punctuation">,</span><span class="token string">'武汉'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'鞋子'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">,</span><span class="token string">'009'</span><span class="token punctuation">,</span><span class="token string">'2020-12-01'</span><span class="token punctuation">,</span><span class="token string">'武汉'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'衣服'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'zs'</span><span class="token punctuation">,</span><span class="token string">'010'</span><span class="token punctuation">,</span><span class="token string">'2020-12-01'</span><span class="token punctuation">,</span><span class="token string">'长沙'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'鞋子'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token punctuation">(</span><span class="token string">'zs'</span><span class="token punctuation">,</span><span class="token string">'011'</span><span class="token punctuation">,</span><span class="token string">'2020-12-02'</span><span class="token punctuation">,</span><span class="token string">'上海'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'鞋子'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">,</span><span class="token string">'012'</span><span class="token punctuation">,</span><span class="token string">'2020-12-02'</span><span class="token punctuation">,</span><span class="token string">'上海'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'衣服'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'ww'</span><span class="token punctuation">,</span><span class="token string">'013'</span><span class="token punctuation">,</span><span class="token string">'2020-12-02'</span><span class="token punctuation">,</span><span class="token string">'上海'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'小米12'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'zl'</span><span class="token punctuation">,</span><span class="token string">'014'</span><span class="token punctuation">,</span><span class="token string">'2020-12-02'</span><span class="token punctuation">,</span><span class="token string">'上海'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'小米11'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'zs'</span><span class="token punctuation">,</span><span class="token string">'015'</span><span class="token punctuation">,</span><span class="token string">'2020-12-02'</span><span class="token punctuation">,</span><span class="token string">'广州'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'鞋子'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">,</span><span class="token string">'016'</span><span class="token punctuation">,</span><span class="token string">'2020-12-02'</span><span class="token punctuation">,</span><span class="token string">'广州'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'衣服'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'ww'</span><span class="token punctuation">,</span><span class="token string">'017'</span><span class="token punctuation">,</span><span class="token string">'2020-12-02'</span><span class="token punctuation">,</span><span class="token string">'广州'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'小米12'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'zs'</span><span class="token punctuation">,</span><span class="token string">'018'</span><span class="token punctuation">,</span><span class="token string">'2020-12-02'</span><span class="token punctuation">,</span><span class="token string">'武汉'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'鞋子'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">,</span><span class="token string">'019'</span><span class="token punctuation">,</span><span class="token string">'2020-12-02'</span><span class="token punctuation">,</span><span class="token string">'武汉'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'衣服'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> t_order<span class="token punctuation">;</span>

<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> c_date<span class="token punctuation">,</span> city_id<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> order_id<span class="token punctuation">)</span> cnt
            <span class="token keyword">from</span> t_order
            <span class="token keyword">where</span> c_date <span class="token operator">&gt;=</span> <span class="token string">'2020-12-01'</span>
              <span class="token operator">and</span> c_date <span class="token operator">&lt;=</span> <span class="token identifier"><span class="token punctuation">`</span>current_date<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">group</span> <span class="token keyword">by</span> c_date<span class="token punctuation">,</span> city_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
     t2 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> c_date <span class="token keyword">order</span> <span class="token keyword">by</span> cnt <span class="token keyword">desc</span><span class="token punctuation">)</span> rn <span class="token keyword">from</span> t1<span class="token punctuation">)</span>
<span class="token keyword">select</span> c_date<span class="token punctuation">,</span> city_id<span class="token punctuation">,</span> cnt<span class="token punctuation">,</span>rn
<span class="token keyword">from</span> t2
<span class="token keyword">where</span> rn <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h2 id="n日留存率"><a href="#n日留存率" class="header-anchor">#</a> N日留存率</h2> <p>留存率是一个衡量用户参与度的重要指标，用于评估产品或服务的用户满意度和黏性。它表示在一个时间段内持续使用产品或服务的用户所占的比例。留存率越高，用户满意度和黏性越强，产品或服务的质量越好</p> <p>留存率不需要连续登录；</p> <p><strong>留存率的计算公式为</strong>：留存率 = (某时间段继续使用产品的用户数 / 上一个时间段的总用户数) × 100%。其中，某时间段继续使用产品的用户数是指在给定时间段内，曾经使用过产品或服务的用户中，仍然在使用该产品或服务的用户数；上一个时间段的总用户数是指在上一个时间段内，曾经使用过该产品或服务的总用户数。</p> <p><img src="https://gitee.com/nylg/picture/raw/master/20240202/image-20240202132748276.png" alt="image-20240202132748276"></p> <p>举例：写出用户表 tb_cuid_1d的 20200401的次日，次7日留存的具体SQL（一条SQL统计出如下指标（4.1号UV，4.1号在4.2号的留存UV，4.1号在4.8号的留存UV）；</p> <blockquote><p>UV:不同的用户数</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>```
drop table if exists tb_cuid_1d;
create table tb_cuid_1d
(
    cuid         nvarchar(255) comment '用户的唯一标识',
    os           nvarchar(255) comment '平台',
    soft_version nvarchar(255) comment '版本',
    event_day    nvarchar(255) comment '日期',
    visit_time    int comment '用户访问时间戳',
    duration     decimal comment '用户访问时长',
    ext          nvarchar(255) comment '扩展字段'
);
insert into tb_cuid_1d values
(1,'android',1,'2020-04-01',1234567,100, ''),
(1,'android',1,'2020-04-02',1234567,100,''),
(1,'android',1,'2020-04-08',1234567,100,''),
(2,'android',1,'2020-04-01',1234567,100,''),
(3,'android',1,'2020-04-02',1234567,100,'');
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="方案1-性能快-步骤稍微复杂"><a href="#方案1-性能快-步骤稍微复杂" class="header-anchor">#</a> 方案1：性能快，步骤稍微复杂</h3> <ul><li>1.1 分析：</li></ul> <p>4.1号：有1，2两用户，即4.1号UV=2
4.2号：有1.3两用户，即4.1号在4.2号的留存UV=1
4.8号：有1一个用户，即4.1号在4.8号的留存UV=1</p> <ul><li>1.2 先按用户分组，得到每个用户的各相关日期的登录情况</li></ul> <p><img src="https://gitee.com/nylg/picture/raw/master/20240202/image-20240202133945660.png" alt="image-20240202133945660"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>select cuid,
       count(case when event_day='2020-04-01' then 1 else null end) as cnt_4_1,
       count(case when event_day='2020-04-02' then 1 else null end) as cnt_4_2,
       count(case when event_day='2020-04-08' then 1 else null end) as cnt_4_8
from tb_cuid_1d where event_day in ('2020-04-01','2020-04-02','2020-04-08') group by cuid having cnt_4_1&gt;0;
# 加having cnt_4_1：过滤掉4.1号就没登录过的脏数据
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><table><thead><tr><th>cuid</th> <th>cnt_4_1</th> <th>cnt_4_2</th> <th>cnt_4_8</th></tr></thead> <tbody><tr><td>1</td> <td>1</td> <td>1</td> <td>1</td></tr> <tr><td>2</td> <td>1</td> <td>0</td> <td>0</td></tr></tbody></table> <ul><li>1.3 按每日进行统计UV值</li></ul> <p><img src="https://gitee.com/nylg/picture/raw/master/20240202/image-20240202134146740.png" alt="image-20240202134146740"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 子查询的表t 是上一步的SQL查询结果
select count(cuid) as uv_4_1,
       count(case when cnt_4_2&gt;0 then 1 else null end) as uv_4_2,
       count(case when cnt_4_8&gt;0 then 1 else null end) as uv_4_8
from
(select cuid,
       count(case when event_day='2020-04-01' then 1 else null end) as cnt_4_1,
       count(case when event_day='2020-04-02' then 1 else null end) as cnt_4_2,
       count(case when event_day='2020-04-08' then 1 else null end) as cnt_4_8
from tb_cuid_1d where event_day in ('2020-04-01','2020-04-02','2020-04-08') group by cuid having cnt_4_1&gt;0) as t
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><table><thead><tr><th>uv_4_1</th> <th>uv_4_2</th> <th>uv_4_8</th></tr></thead> <tbody><tr><td>2</td> <td>1</td> <td>1</td></tr></tbody></table> <ul><li>1.4 最后再用 UV值 除以【首日总数】，就是【留存率】</li></ul> <h3 id="方案2-性能慢-但是步骤比较简单"><a href="#方案2-性能慢-但是步骤比较简单" class="header-anchor">#</a> 方案2：性能慢，但是步骤比较简单</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>select *
from (select distinct cuid from tb_cuid_1d where event_day='2020-04-01') a
left join (select distinct cuid from tb_cuid_1d where event_day='2020-04-02') b on a.cuid=b.cuid
left join (select distinct cuid from tb_cuid_1d where event_day='2020-04-08') c on a.cuid=c.cuid;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><table><thead><tr><th>cuid</th> <th>cuid</th> <th>cuid</th></tr></thead> <tbody><tr><td>1</td> <td>1</td> <td>1</td></tr> <tr><td>2</td> <td>null</td> <td>null</td></tr></tbody></table> <div class="language- line-numbers-mode"><pre class="language-text"><code>select count(a.cuid) as uv_4_1,
       count(b.cuid) as uv_4_2,
       count(c.cuid) as uv_4_8,
       count(b.cuid)/count(a.cuid) as 'rate_4.2',
       count(c.cuid)/count(a.cuid) as 'rate_4.2'
from (select distinct cuid from tb_cuid_1d where event_day='2020-04-01') a
         left join (select distinct cuid from tb_cuid_1d where event_day='2020-04-02') b on a.cuid=b.cuid
         left join (select distinct cuid from tb_cuid_1d where event_day='2020-04-08') c on a.cuid=c.cuid;
# 每次多一个N日，则需要多一个left join,性能更差。         
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><table><thead><tr><th>uv_4_1</th> <th>uv_4_2</th> <th>uv_4_8</th></tr></thead> <tbody><tr><td>2</td> <td>1</td> <td>1</td></tr></tbody></table> <h3 id="真题-3"><a href="#真题-3" class="header-anchor">#</a> 真题</h3> <p>腾讯视频号游戏直播</p> <p>表：tableA</p> <table><thead><tr><th>ds(日期)</th> <th>device</th> <th>user_id</th> <th>is_active</th></tr></thead> <tbody><tr><td>2020-03-01</td> <td>ios</td> <td>0001</td> <td>0</td></tr> <tr><td>2020-03-01</td> <td>ios</td> <td>0002</td> <td>1</td></tr> <tr><td>2020-03-01</td> <td>android</td> <td>0003</td> <td>1</td></tr> <tr><td>2020-03-02</td> <td>ios</td> <td>0001</td> <td>0</td></tr> <tr><td>2020-03-02</td> <td>ios</td> <td>0002</td> <td>0</td></tr> <tr><td>2020-03-02</td> <td>android</td> <td>0003</td> <td>1</td></tr></tbody></table> <p>20200301的ios设备用户活跃的次日留存率是多少？</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">use</span> test_sql<span class="token punctuation">;</span>
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token punctuation">.</span><span class="token keyword">local</span><span class="token punctuation">.</span>auto<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token comment">--腾讯视频号游戏直播</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> tableA<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> tableA
<span class="token punctuation">(</span>ds string <span class="token keyword">comment</span> <span class="token string">'(日期)'</span>  <span class="token punctuation">,</span>device string<span class="token punctuation">,</span>user_id string<span class="token punctuation">,</span>is_active <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span>  tableA <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">'2020-03-01'</span><span class="token punctuation">,</span><span class="token string">'ios'</span><span class="token punctuation">,</span><span class="token string">'0001'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'2020-03-01'</span><span class="token punctuation">,</span><span class="token string">'ios'</span><span class="token punctuation">,</span><span class="token string">'0002'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'2020-03-01'</span><span class="token punctuation">,</span><span class="token string">'ios'</span><span class="token punctuation">,</span><span class="token string">'0004'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'2020-03-01'</span><span class="token punctuation">,</span><span class="token string">'android'</span><span class="token punctuation">,</span><span class="token string">'0003'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'2020-03-02'</span><span class="token punctuation">,</span><span class="token string">'ios'</span><span class="token punctuation">,</span><span class="token string">'0001'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'2020-03-02'</span><span class="token punctuation">,</span><span class="token string">'ios'</span><span class="token punctuation">,</span><span class="token string">'0002'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'2020-03-02'</span><span class="token punctuation">,</span><span class="token string">'android'</span><span class="token punctuation">,</span><span class="token string">'0003'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'2020-03-02'</span><span class="token punctuation">,</span><span class="token string">'ios'</span><span class="token punctuation">,</span><span class="token string">'0005'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'2020-03-02'</span><span class="token punctuation">,</span><span class="token string">'ios'</span><span class="token punctuation">,</span><span class="token string">'0004'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>



<span class="token comment">--方案1，过程见下面的顺序编号</span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> user_id<span class="token punctuation">,</span>
           <span class="token comment">--3-一个用户如果在'2020-03-01'活跃，则cnt1&gt;0</span>
           <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>ds <span class="token operator">=</span> <span class="token string">'2020-03-01'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cnt1<span class="token punctuation">,</span>
           <span class="token comment">--4-一个用户如果在'2020-03-02'活跃，则cnt2&gt;0</span>
           <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>ds <span class="token operator">=</span> <span class="token string">'2020-03-02'</span> <span class="token operator">and</span> is_active <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cnt2
    <span class="token keyword">from</span> tableA
    <span class="token comment">--1-预先全局过滤</span>
    <span class="token keyword">where</span> device <span class="token operator">=</span> <span class="token string">'ios'</span>
      <span class="token operator">and</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>ds<span class="token operator">=</span><span class="token string">'2020-03-01'</span> <span class="token operator">and</span> is_active <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">or</span> ds<span class="token operator">=</span><span class="token string">'2020-03-02'</span><span class="token punctuation">)</span>
    <span class="token comment">--2-按用户分组</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> user_id
    <span class="token comment">--6-只筛选'2020-03-01'活跃的用户，他在'2020-03-02'是否活跃，看cnt2=0则不活跃，&gt;0则活跃</span>
    <span class="token keyword">having</span> cnt1 <span class="token operator">&gt;</span> <span class="token number">0</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>cnt1<span class="token punctuation">)</span>                               sum1<span class="token punctuation">,</span><span class="token comment">--'2020-03-01'的活跃数</span>
       <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>cnt2 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        sum2<span class="token punctuation">,</span><span class="token comment">----并且在次日依然活跃的用户数</span>
       <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>cnt2 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">count</span><span class="token punctuation">(</span>cnt1<span class="token punctuation">)</span> rate<span class="token comment">--次日留存率</span>
<span class="token keyword">from</span> t1<span class="token punctuation">;</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>百度</p> <p>有1张表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> tb_cuid_1d
<span class="token punctuation">(</span>
    cuid         string <span class="token keyword">comment</span> <span class="token string">'用户的唯一标识'</span><span class="token punctuation">,</span>
    os           string <span class="token keyword">comment</span> <span class="token string">'平台'</span><span class="token punctuation">,</span>
    soft_version string <span class="token keyword">comment</span> <span class="token string">'版本'</span><span class="token punctuation">,</span>
    event_day    string <span class="token keyword">comment</span> <span class="token string">'日期'</span><span class="token punctuation">,</span>
    visit_time    <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'用户访问时间戳'</span><span class="token punctuation">,</span>
    duration     <span class="token keyword">decimal</span> <span class="token keyword">comment</span> <span class="token string">'用户访问时长'</span><span class="token punctuation">,</span>
    ext          array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token keyword">comment</span> <span class="token string">'扩展字段'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> tb_cuid_1d <span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'android'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2020-04-01'</span><span class="token punctuation">,</span><span class="token number">1234567</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>array<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'android'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2020-04-02'</span><span class="token punctuation">,</span><span class="token number">1234567</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>array<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'android'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2020-04-08'</span><span class="token punctuation">,</span><span class="token number">1234567</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>array<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'android'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2020-04-01'</span><span class="token punctuation">,</span><span class="token number">1234567</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>array<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'android'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2020-04-02'</span><span class="token punctuation">,</span><span class="token number">1234567</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>array<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>写出用户表 tb_cuid_1d的 20200401 的次日、次7日留存的具体HQL ：</p> <p>一条sql统计出以下指标 （4.1号uv，4.1号在4.2号的留存uv，4.1号在4.8号的留存uv）;</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">--一个理解简单，但是性能不快的做法</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>cuid<span class="token punctuation">)</span> uv<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>cuid<span class="token punctuation">)</span> uv2<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>cuid<span class="token punctuation">)</span> uv7
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> event_day<span class="token punctuation">,</span> cuid <span class="token keyword">from</span> tb_cuid_1d <span class="token keyword">where</span> event_day<span class="token operator">=</span><span class="token string">'2020-04-01'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> a
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> event_day<span class="token punctuation">,</span> cuid <span class="token keyword">from</span> tb_cuid_1d <span class="token keyword">where</span> event_day<span class="token operator">=</span><span class="token string">'2020-04-02'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> b <span class="token keyword">on</span> a<span class="token punctuation">.</span>cuid<span class="token operator">=</span>b<span class="token punctuation">.</span>cuid
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> event_day<span class="token punctuation">,</span> cuid <span class="token keyword">from</span> tb_cuid_1d <span class="token keyword">where</span> event_day<span class="token operator">=</span><span class="token string">'2020-04-08'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> c <span class="token keyword">on</span> a<span class="token punctuation">.</span>cuid<span class="token operator">=</span>c<span class="token punctuation">.</span>cuid<span class="token punctuation">;</span>
<span class="token comment">--另一个理解稍微复杂，但是性能快的做法</span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> cuid<span class="token punctuation">,</span>
           <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>event_day<span class="token operator">=</span><span class="token string">'2020-04-01'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt1<span class="token punctuation">,</span>
           <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>event_day<span class="token operator">=</span><span class="token string">'2020-04-02'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt2<span class="token punctuation">,</span>
           <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>event_day<span class="token operator">=</span><span class="token string">'2020-04-08'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt8
     <span class="token keyword">from</span> tb_cuid_1d
     <span class="token keyword">where</span> event_day <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'2020-04-01'</span><span class="token punctuation">,</span><span class="token string">'2020-04-02'</span><span class="token punctuation">,</span><span class="token string">'2020-04-08'</span><span class="token punctuation">)</span>
     <span class="token keyword">group</span> <span class="token keyword">by</span> cuid
     <span class="token keyword">having</span> cnt1 <span class="token operator">&gt;</span><span class="token number">0</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
     t2 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>cuid<span class="token punctuation">)</span>                  <span class="token keyword">as</span> uv1<span class="token punctuation">,</span>
                   <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>cnt2 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> uv2<span class="token punctuation">,</span>
                   <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>cnt8 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> uv7
            <span class="token keyword">from</span> t1
            <span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
       uv2 <span class="token operator">/</span> uv1 <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>次日留存率<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
       uv7 <span class="token operator">/</span> uv1 <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>7日留存率<span class="token punctuation">`</span></span>
<span class="token keyword">from</span> t2

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="join系列"><a href="#join系列" class="header-anchor">#</a> join系列</h2> <p>【区分 inner /left / right / full / left semi / left anti join 的特点】</p> <p>有以下银行信息表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> all_users<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> all_users<span class="token punctuation">(</span>
                          id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
                          name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'用户姓名'</span><span class="token punctuation">,</span>
                          sex <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'性别'</span><span class="token punctuation">,</span>
                          age <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'年龄'</span>
<span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'银行用户信息表'</span><span class="token punctuation">;</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> all_users<span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> all_users <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token string">'男'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'李四'</span><span class="token punctuation">,</span><span class="token string">'男'</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'王五'</span><span class="token punctuation">,</span><span class="token string">'男'</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'赵六'</span><span class="token punctuation">,</span><span class="token string">'女'</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'田七'</span><span class="token punctuation">,</span><span class="token string">'女'</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> all_users<span class="token punctuation">;</span>

<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> black_list<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> black_list
<span class="token punctuation">(</span>
    user_id <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'用户编号'</span><span class="token punctuation">,</span>
    <span class="token keyword">type</span>    <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'风控类型'</span>
<span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'银行黑名单信息表'</span><span class="token punctuation">;</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> black_list<span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> black_list <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'诈骗'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'逾期'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'套现'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> black_list<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="left-join"><a href="#left-join" class="header-anchor">#</a> left join</h3> <blockquote><p>左表数据全部显示；</p> <p>右表数据关联上显示，关联不上则不展示；</p></blockquote> <p>使用left join对所有用户，如果也在黑名单中，则标记为YES，否则标记为NO。</p> <table><thead><tr><th style="text-align:left;">id</th> <th style="text-align:left;">name</th> <th style="text-align:left;">sex</th> <th style="text-align:left;">age</th> <th style="text-align:left;">flag</th></tr></thead> <tbody><tr><td style="text-align:left;">1</td> <td style="text-align:left;">张三</td> <td style="text-align:left;">男</td> <td style="text-align:left;">20</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">2</td> <td style="text-align:left;">李四</td> <td style="text-align:left;">男</td> <td style="text-align:left;">29</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">3</td> <td style="text-align:left;">王五</td> <td style="text-align:left;">男</td> <td style="text-align:left;">21</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">4</td> <td style="text-align:left;">赵六</td> <td style="text-align:left;">女</td> <td style="text-align:left;">28</td> <td style="text-align:left;">NO</td></tr> <tr><td style="text-align:left;">5</td> <td style="text-align:left;">田七</td> <td style="text-align:left;">女</td> <td style="text-align:left;">22</td> <td style="text-align:left;">NO</td></tr></tbody></table> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 写法1：</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
       <span class="token keyword">case</span>
           <span class="token keyword">when</span> b<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token string">'YES'</span>
           <span class="token keyword">else</span> <span class="token string">'NO'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> flag
<span class="token keyword">from</span> all_users a <span class="token keyword">left</span> <span class="token keyword">join</span> black_list b <span class="token keyword">on</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>

<span class="token comment"># 写法2</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'YES'</span><span class="token punctuation">,</span> <span class="token string">'NO'</span><span class="token punctuation">)</span> flag
<span class="token keyword">from</span> all_users a
<span class="token keyword">left</span> <span class="token keyword">join</span> black_list b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><table><thead><tr><th style="text-align:center;">id</th> <th style="text-align:center;">name</th> <th style="text-align:center;">sex</th> <th style="text-align:center;">age</th> <th style="text-align:center;">flag</th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td style="text-align:center;">张三</td> <td style="text-align:center;">男</td> <td style="text-align:center;">20</td> <td style="text-align:center;">YES</td></tr> <tr><td style="text-align:center;">2</td> <td style="text-align:center;">李四</td> <td style="text-align:center;">男</td> <td style="text-align:center;">29</td> <td style="text-align:center;">YES</td></tr> <tr><td style="text-align:center;">3</td> <td style="text-align:center;">王五</td> <td style="text-align:center;">男</td> <td style="text-align:center;">21</td> <td style="text-align:center;">YES</td></tr> <tr><td style="text-align:center;">4</td> <td style="text-align:center;">赵六</td> <td style="text-align:center;">女</td> <td style="text-align:center;">28</td> <td style="text-align:center;">NO</td></tr> <tr><td style="text-align:center;">5</td> <td style="text-align:center;">田七</td> <td style="text-align:center;">女</td> <td style="text-align:center;">22</td> <td style="text-align:center;">NO</td></tr></tbody></table> <h3 id="right-join"><a href="#right-join" class="header-anchor">#</a> right join</h3> <p>对上面的问题，使用right join再做一次。</p> <table><thead><tr><th style="text-align:left;">id</th> <th style="text-align:left;">name</th> <th style="text-align:left;">sex</th> <th style="text-align:left;">age</th> <th style="text-align:left;">flag</th></tr></thead> <tbody><tr><td style="text-align:left;">1</td> <td style="text-align:left;">张三</td> <td style="text-align:left;">男</td> <td style="text-align:left;">20</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">2</td> <td style="text-align:left;">李四</td> <td style="text-align:left;">男</td> <td style="text-align:left;">29</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">3</td> <td style="text-align:left;">王五</td> <td style="text-align:left;">男</td> <td style="text-align:left;">21</td> <td style="text-align:left;">YES</td></tr> <tr><td style="text-align:left;">4</td> <td style="text-align:left;">赵六</td> <td style="text-align:left;">女</td> <td style="text-align:left;">28</td> <td style="text-align:left;">NO</td></tr> <tr><td style="text-align:left;">5</td> <td style="text-align:left;">田七</td> <td style="text-align:left;">女</td> <td style="text-align:left;">22</td> <td style="text-align:left;">NO</td></tr></tbody></table> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> b<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'YES'</span><span class="token punctuation">,</span> <span class="token string">'NO'</span><span class="token punctuation">)</span> flag
<span class="token keyword">from</span> black_list a
<span class="token keyword">right</span> <span class="token keyword">join</span> all_users b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="left-semi-join"><a href="#left-semi-join" class="header-anchor">#</a> left semi join</h3> <blockquote><p>left semi join：结果只显示左表字段，不会显示右表字段</p> <p>MySQL不支持，hive，spark等支持；</p></blockquote> <p>使用left semi join对所有用户，如果也在黑名单中，则挑选出来。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">from</span> all_users a
<span class="token keyword">left</span> semi <span class="token keyword">join</span> black_list b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>

<span class="token comment"># 等价于</span>

<span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">from</span> all_users a
    <span class="token keyword">left</span> <span class="token keyword">join</span> black_list b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id
<span class="token keyword">where</span> b<span class="token punctuation">.</span>user_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><table><thead><tr><th style="text-align:left;">id</th> <th style="text-align:left;">name</th> <th style="text-align:left;">sex</th> <th style="text-align:left;">age</th></tr></thead> <tbody><tr><td style="text-align:left;">1</td> <td style="text-align:left;">张三</td> <td style="text-align:left;">男</td> <td style="text-align:left;">20</td></tr> <tr><td style="text-align:left;">2</td> <td style="text-align:left;">李四</td> <td style="text-align:left;">男</td> <td style="text-align:left;">29</td></tr> <tr><td style="text-align:left;">3</td> <td style="text-align:left;">王五</td> <td style="text-align:left;">男</td> <td style="text-align:left;">21</td></tr></tbody></table> <h3 id="left-anti-join"><a href="#left-anti-join" class="header-anchor">#</a> left anti join</h3> <p>使用left anti join对所有用户，如果不在黑名单中，则挑选出来。</p> <table><thead><tr><th style="text-align:left;">id</th> <th style="text-align:left;">name</th> <th style="text-align:left;">sex</th> <th style="text-align:left;">age</th></tr></thead> <tbody><tr><td style="text-align:left;">4</td> <td style="text-align:left;">赵六</td> <td style="text-align:left;">女</td> <td style="text-align:left;">28</td></tr> <tr><td style="text-align:left;">5</td> <td style="text-align:left;">田七</td> <td style="text-align:left;">女</td> <td style="text-align:left;">22</td></tr></tbody></table> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">from</span> all_users a
<span class="token keyword">left</span> anti <span class="token keyword">join</span> black_list b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="full-join"><a href="#full-join" class="header-anchor">#</a> full join</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">--用户的存款金额。</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> deposit<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> deposit <span class="token punctuation">(</span>
    user_id <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    amount <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'存款金额'</span>
<span class="token punctuation">)</span><span class="token keyword">comment</span> <span class="token string">'用户最新银行存款信息表'</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> deposit <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2900</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--用户的负债金额。</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> debt<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> debt <span class="token punctuation">(</span>
    user_id <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
    amount <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'负债金额'</span>
<span class="token punctuation">)</span><span class="token keyword">comment</span> <span class="token string">'用户最新银行负债信息表'</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> debt <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3400</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>使用full join，展示用户的存款金额和负债金额。</p> <table><thead><tr><th style="text-align:left;">user_id</th> <th style="text-align:left;">deposit_amount</th> <th style="text-align:left;">debt_amount</th></tr></thead> <tbody><tr><td style="text-align:left;">1</td> <td style="text-align:left;">2000</td> <td style="text-align:left;">0</td></tr> <tr><td style="text-align:left;">2</td> <td style="text-align:left;">2900</td> <td style="text-align:left;">0</td></tr> <tr><td style="text-align:left;">3</td> <td style="text-align:left;">2100</td> <td style="text-align:left;">3400</td></tr> <tr><td style="text-align:left;">4</td> <td style="text-align:left;">0</td> <td style="text-align:left;">2800</td></tr> <tr><td style="text-align:left;">5</td> <td style="text-align:left;">0</td> <td style="text-align:left;">2200</td></tr></tbody></table> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> b<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> <span class="token keyword">as</span> user_id<span class="token punctuation">,</span>
       <span class="token keyword">coalesce</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>amount<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>          <span class="token keyword">as</span> deposit_amount<span class="token punctuation">,</span>
       <span class="token keyword">coalesce</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>amount<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>          <span class="token keyword">as</span> debt_amount
<span class="token keyword">from</span> deposit a
<span class="token keyword">full</span> <span class="token keyword">join</span> debt b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="真题-4"><a href="#真题-4" class="header-anchor">#</a> 真题</h3> <h4 id="字节跳动"><a href="#字节跳动" class="header-anchor">#</a> 字节跳动</h4> <p>【考察full join】</p> <p>1、某个游戏中的元宝分为，付费元宝和免费元宝。玩家购买商城道具时候，可以使用<strong>付费元宝</strong>也可以使用<strong>免费元宝</strong>。请使用HIve SQL语句计算出2021-01-01至2021-01-07期间各个角色当日消耗元宝的付费免费比例（付费免费比 = 付费元宝消耗量 / 免费元宝消耗量）。</p> <p>现有表结构如下：</p> <p>表dm_paid_buy</p> <table><thead><tr><th>desc</th> <th>dm_paid_buy;</th></tr></thead> <tbody><tr><td>#dm_paid_buy</td> <td>角色使用<strong>付费元宝</strong>购买商城道具时候记录一条</td></tr></tbody></table> <table><thead><tr><th>time</th> <th>bigint</th> <th>#购买的时间戳</th></tr></thead> <tbody><tr><td>server_id</td> <td>string</td> <td>#服务器ID</td></tr> <tr><td>role_id</td> <td>int</td> <td>#角色ID</td></tr> <tr><td>cost</td> <td>int</td> <td>#购买对应道具消耗的付费元宝数量</td></tr> <tr><td>item_id</td> <td>int</td> <td>#购买对应道具的id</td></tr> <tr><td>amount</td> <td>int</td> <td>#购买对应道具的数量</td></tr> <tr><td>p_date</td> <td>string</td> <td>#登录日期,yyyy-MM-dd</td></tr></tbody></table> <div class="language- line-numbers-mode"><pre class="language-text"><code>drop table if exists dm_paid_buy;
create table if not exists dm_paid_buy
(
   `time`    bigint comment '#购买的时间戳',
   server_id varchar(255) comment '#服务器ID',
   role_id   int comment '#角色ID',
   cost      int comment '#购买对应道具消耗的付费元宝数量',
   item_id   int comment '#购买对应道具的id',
   amount    int comment '#购买对应道具的数量',
   p_date    varchar(255) comment '#登录日期, yyyy-MM-dd'
) comment '角色使用付费元宝购买商城道具时候记录一条';
delete from dm_paid_buy;
insert into dm_paid_buy values
(1234567,120,10098,2,3,4,'2021-01-01'),
(1234567,120,10098,4,3,5,'2021-01-01'),
(1234567,123,10098,3,3,2,'2021-01-02'),
(1234567,123,10098,2,3,2,'2021-01-02');
desc dm_paid_buy;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>表dm_free_buy:</p> <table><thead><tr><th>desc</th> <th>dm_free_buy;</th></tr></thead> <tbody><tr><td>#dm_free_buy</td> <td>角色使用<strong>免费元宝</strong>购买商城道具时候记录一条</td></tr></tbody></table> <table><thead><tr><th>time</th> <th>bigint</th> <th>#购买的时间戳</th></tr></thead> <tbody><tr><td>server_id</td> <td>string</td> <td>#服务器ID</td></tr> <tr><td>role_id</td> <td>int</td> <td>#角色ID</td></tr> <tr><td>cost</td> <td>int</td> <td>#购买对应道具消耗的免费元宝数量</td></tr> <tr><td>item_id</td> <td>int</td> <td>#购买对应道具的id</td></tr> <tr><td>amount</td> <td>int</td> <td>#购买对应道具的数量</td></tr> <tr><td>p_date</td> <td>string</td> <td>#登录日期,yyyy-MM-dd</td></tr></tbody></table> <div class="language- line-numbers-mode"><pre class="language-text"><code>drop table if exists dm_free_buy;
create table if not exists dm_free_buy
(
   `time`    bigint comment '#购买的时间戳',
   server_id varchar(255) comment '#服务器ID',
   role_id   int comment '#角色ID',
   cost      int comment '#购买对应道具消耗的免费元宝数量',
   item_id   int comment '#购买对应道具的id',
   amount    int comment '#购买对应道具的数量',
   p_date    varchar(255) comment '#登录日期, yyyy-MM-dd'
) comment '角色使用免费元宝购买商城道具时候记录一条';
insert into dm_free_buy values
(1234567,123,10098,8,3,4,'2021-01-01'),
(1234567,123,10098,5,3,5,'2021-01-01'),
(1234567,120,10098,6,3,4,'2021-01-01'),
(1234567,120,10098,9,3,5,'2021-01-01'),
(1234567,123,10098,18,3,2,'2021-01-02'),
(1234567,123,10098,7,3,2,'2021-01-02');
select * from dm_free_buy;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>示例：结果输出:</p> <table><thead><tr><th>p_date</th> <th>server_id</th> <th>role_id</th> <th>付费免费比</th></tr></thead> <tbody><tr><td>2021-01-01</td> <td>123</td> <td>10098</td> <td>0</td></tr> <tr><td>2021-01-01</td> <td>120</td> <td>10098</td> <td>0.4</td></tr> <tr><td>2021-01-02</td> <td>123</td> <td>10098</td> <td>0.2</td></tr></tbody></table> <p>解答：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>p_date<span class="token punctuation">,</span> b<span class="token punctuation">.</span>p_date<span class="token punctuation">)</span>         p_date<span class="token punctuation">,</span>
       <span class="token keyword">coalesce</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>server_id<span class="token punctuation">,</span> b<span class="token punctuation">.</span>server_id<span class="token punctuation">)</span>   server_id<span class="token punctuation">,</span>
       <span class="token keyword">coalesce</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>role_id<span class="token punctuation">,</span> b<span class="token punctuation">.</span>role_id<span class="token punctuation">)</span>       role_id<span class="token punctuation">,</span>
       <span class="token function">round</span><span class="token punctuation">(</span>nvl<span class="token punctuation">(</span>a<span class="token punctuation">.</span>cost<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> b<span class="token punctuation">.</span>cost<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rate
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> p_date<span class="token punctuation">,</span> server_id<span class="token punctuation">,</span> role_id<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>cost<span class="token punctuation">)</span> cost
      <span class="token keyword">from</span> dm_paid_buy
      <span class="token keyword">where</span> p_date <span class="token operator">&gt;=</span> <span class="token string">'2021-01-01'</span>
        <span class="token operator">and</span> p_date <span class="token operator">&lt;=</span> <span class="token string">'2021-01-07'</span>
      <span class="token keyword">group</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span> server_id<span class="token punctuation">,</span> role_id<span class="token punctuation">)</span> a
<span class="token keyword">full</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> p_date<span class="token punctuation">,</span> server_id<span class="token punctuation">,</span> role_id<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>cost<span class="token punctuation">)</span> cost
      <span class="token keyword">from</span> dm_free_buy
      <span class="token keyword">where</span> p_date <span class="token operator">&gt;=</span> <span class="token string">'2021-01-01'</span>
        <span class="token operator">and</span> p_date <span class="token operator">&lt;=</span> <span class="token string">'2021-01-07'</span>
      <span class="token keyword">group</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span> server_id<span class="token punctuation">,</span> role_id<span class="token punctuation">)</span> b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>p_date<span class="token operator">=</span>b<span class="token punctuation">.</span>p_date <span class="token operator">and</span> a<span class="token punctuation">.</span>server_id<span class="token operator">=</span>b<span class="token punctuation">.</span>server_id <span class="token operator">and</span> a<span class="token punctuation">.</span>role_id<span class="token operator">=</span>b<span class="token punctuation">.</span>role_id<span class="token punctuation">;</span>

<span class="token comment"># 等价于</span>
<span class="token keyword">with</span> a <span class="token keyword">as</span> <span class="token punctuation">(</span> <span class="token keyword">select</span> p_date<span class="token punctuation">,</span> server_id<span class="token punctuation">,</span> role_id<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>cost<span class="token punctuation">)</span> <span class="token keyword">as</span> cost
             <span class="token keyword">from</span> dm_paid_buy
             <span class="token keyword">where</span> p_date <span class="token operator">&gt;=</span> <span class="token string">'2021-01-01'</span>
               <span class="token operator">and</span> p_date <span class="token operator">&lt;=</span> <span class="token string">'2021-01-07'</span>
             <span class="token keyword">group</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span> server_id<span class="token punctuation">,</span> role_id <span class="token punctuation">)</span><span class="token punctuation">,</span>
    b <span class="token keyword">as</span> <span class="token punctuation">(</span> <span class="token keyword">select</span> p_date<span class="token punctuation">,</span> server_id<span class="token punctuation">,</span> role_id<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>cost<span class="token punctuation">)</span> <span class="token keyword">as</span> cost
           <span class="token keyword">from</span> dm_free_buy
           <span class="token keyword">where</span> p_date <span class="token operator">&gt;=</span> <span class="token string">'2021-01-01'</span>
             <span class="token operator">and</span> p_date <span class="token operator">&lt;=</span> <span class="token string">'2021-01-07'</span>
           <span class="token keyword">group</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span> server_id<span class="token punctuation">,</span> role_id <span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>p_date<span class="token punctuation">,</span> b<span class="token punctuation">.</span>p_date<span class="token punctuation">)</span>      <span class="token keyword">as</span>   p_date<span class="token punctuation">,</span>
       <span class="token keyword">coalesce</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>server_id<span class="token punctuation">,</span> b<span class="token punctuation">.</span>server_id<span class="token punctuation">)</span> <span class="token keyword">as</span>  server_id<span class="token punctuation">,</span>
       <span class="token keyword">coalesce</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>role_id<span class="token punctuation">,</span> b<span class="token punctuation">.</span>role_id<span class="token punctuation">)</span>  <span class="token keyword">as</span>     role_id<span class="token punctuation">,</span>
       <span class="token keyword">coalesce</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>cost<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> a_cost<span class="token punctuation">,</span>
       <span class="token keyword">coalesce</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>cost<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> b_cost<span class="token punctuation">,</span>
       <span class="token keyword">coalesce</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>cost<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">coalesce</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>cost<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rate
<span class="token keyword">from</span>  a
<span class="token keyword">full</span> <span class="token keyword">join</span>  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>p_date<span class="token operator">=</span>b<span class="token punctuation">.</span>p_date <span class="token operator">and</span> a<span class="token punctuation">.</span>server_id<span class="token operator">=</span>b<span class="token punctuation">.</span>server_id <span class="token operator">and</span> a<span class="token punctuation">.</span>role_id<span class="token operator">=</span>b<span class="token punctuation">.</span>role_id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="join优化"><a href="#join优化" class="header-anchor">#</a> join优化</h2> <p>通用口诀：先用where或group by减少数据量，再join</p> <p>即：谓语下推</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">--优化前，慢：</span>
<span class="token keyword">select</span> b<span class="token punctuation">.</span>userid<span class="token punctuation">.</span>
       b<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
  	   <span class="token function">sum</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span><span class="token punctuation">,</span>
  	   <span class="token function">count</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span>
<span class="token keyword">from</span> a【比如交易明细事实表】
<span class="token keyword">join</span> b【比如客户维度信息表】
<span class="token keyword">on</span> a<span class="token punctuation">.</span>userid<span class="token operator">=</span>b<span class="token punctuation">.</span>userid
<span class="token keyword">where</span> b<span class="token punctuation">.</span>yy<span class="token operator">&lt;</span>条件
<span class="token keyword">group</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span>userid<span class="token punctuation">.</span>b<span class="token punctuation">.</span>username
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>xx<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">;</span>

<span class="token comment">--优化后，快：</span>
<span class="token keyword">select</span> b<span class="token punctuation">.</span>userid<span class="token punctuation">.</span>
       b<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
  	   s<span class="token punctuation">,</span>
  	   cnt
     <span class="token comment">--【提前对a减少数据量】</span>
<span class="token keyword">from</span> （<span class="token keyword">select</span> userid<span class="token punctuation">,</span>
              <span class="token function">sum</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span> s<span class="token punctuation">,</span>
              <span class="token function">count</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span> cnt
         <span class="token keyword">from</span> a <span class="token keyword">group</span> <span class="token keyword">by</span> userid <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>xx<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token number">10</span>）a
     <span class="token comment">--【提前对b减少数据量】</span>
<span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> b <span class="token keyword">where</span> b<span class="token punctuation">.</span>yy<span class="token operator">&lt;</span>条件<span class="token punctuation">)</span> b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>userid<span class="token operator">=</span>b<span class="token punctuation">.</span>userid
<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="交通银行-2"><a href="#交通银行-2" class="header-anchor">#</a> 交通银行</h3> <p>数据模型如下：</p> <p>表T1的数据结构：</p> <table><thead><tr><th>字段英文名</th> <th>字段中文名</th> <th>类型</th> <th>主键标志</th> <th>注释</th></tr></thead> <tbody><tr><td>Rec_no</td> <td>记录号</td> <td>CHAR(3)</td> <td>Y</td> <td></td></tr> <tr><td>Ci_no</td> <td>客户号</td> <td>CHAR(6)</td> <td>N</td> <td></td></tr> <tr><td>Cust_Type</td> <td>客户类型</td> <td>CHAR(2)</td> <td>N</td> <td></td></tr> <tr><td>Cre_dt</td> <td>开户日期</td> <td>Date</td> <td>N</td> <td></td></tr> <tr><td>Cus_sts</td> <td>客户状态</td> <td>Char(1)</td> <td>N</td> <td>Y-正常 N-无效</td></tr></tbody></table> <p>表T1的数据</p> <table><thead><tr><th>Rec_no</th> <th>ci_no</th> <th>cust_type</th> <th>cre_dt</th> <th>cus_sts</th></tr></thead> <tbody><tr><td>123</td> <td>111111</td> <td>01</td> <td>2010-11-15</td> <td>Y</td></tr> <tr><td>234</td> <td>222222</td> <td>02</td> <td>2011-09-01</td> <td>Y</td></tr> <tr><td>345</td> <td>333333</td> <td>02</td> <td>2012-01-09</td> <td>Y</td></tr> <tr><td>456</td> <td>444444</td> <td>01</td> <td>2012-09-08</td> <td>Y</td></tr></tbody></table> <div class="language- line-numbers-mode"><pre class="language-text"><code>T1表:
drop table if exists T1;
create table T1
(
    rec_no    int,
    ci_no     int,
    cust_type varchar(255),
    cre_dt    varchar(255),
    cus_sts   varchar(255)
);
delete from T1;
insert into T1 values
(123,111111,'01','2010-11-15','Y'),
(234,222222,'02','2011-09-01','N'),
(345,333333,'02','2012-01-09','Y'),
(456,444444,'01','2012-09-08','Y');
select * from T1;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>表T2的数据结构：</p> <table><thead><tr><th>字段英文名</th> <th>字段中文名</th> <th>类型</th> <th>主键标志</th> <th>注释</th></tr></thead> <tbody><tr><td>Ci_no</td> <td>客户号</td> <td>CHAR(6)</td> <td>Y</td> <td></td></tr> <tr><td>AC_no</td> <td>客户账号</td> <td>CHAR(9)</td> <td>Y</td> <td></td></tr> <tr><td>Bal</td> <td>账号余额</td> <td>DECIMAL(15，2)</td> <td>N</td> <td></td></tr></tbody></table> <p>表T2的数据：</p> <table><thead><tr><th>Ci_no char(6)</th> <th>Ac_no char(9)</th> <th>Bal decimal(15,2)</th></tr></thead> <tbody><tr><td>222222</td> <td>123456888</td> <td>1000.28</td></tr> <tr><td>222222</td> <td>123456999</td> <td>886</td></tr> <tr><td>333333</td> <td>123454321</td> <td>5000</td></tr></tbody></table> <div class="language- line-numbers-mode"><pre class="language-text"><code>T2表：
drop table if exists T2;
create table T2
(
    ci_no     int,
    ac_no varchar(255),
    bal    decimal(7,2)
);
delete from T2;
insert into T2 values
(222222,'123456789',1000.28),
(333333,'123454321',5000.00);
select * from T2;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>请编写sql统计在9月份开户且账户余额不为0的有效客户数。（8分）</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code> <span class="token comment">-- 传统的写法。</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> t1<span class="token punctuation">.</span>ci_no<span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
<span class="token keyword">from</span> t1
<span class="token keyword">join</span> t2 <span class="token keyword">on</span> t1<span class="token punctuation">.</span>ci_no<span class="token operator">=</span>t2<span class="token punctuation">.</span>ci_no
<span class="token keyword">where</span> <span class="token keyword">month</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>cre_dt<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">9</span>
<span class="token operator">and</span> t1<span class="token punctuation">.</span>cus_sts<span class="token operator">=</span><span class="token string">'Y'</span>
<span class="token operator">and</span> bal<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">-- 方案2</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>ci_no<span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token keyword">month</span><span class="token punctuation">(</span>cre_dt<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">9</span> <span class="token operator">and</span> cus_sts<span class="token operator">=</span><span class="token string">'Y'</span><span class="token punctuation">)</span> t1
<span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> ci_no <span class="token keyword">from</span> t2 <span class="token keyword">group</span> <span class="token keyword">by</span> ci_no <span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span>bal<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> t2
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>ci_no<span class="token operator">=</span>t2<span class="token punctuation">.</span>ci_no<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="带条件的聚合统计"><a href="#带条件的聚合统计" class="header-anchor">#</a> 带条件的聚合统计</h2> <ul><li>一般的做法是group by xx,yy  再多次的sum(if(......))</li> <li>好处是避免多次加载表，一次性得到多个指标，可以只加载一次表就得到多个指标。</li></ul> <h3 id="小米电商-2"><a href="#小米电商-2" class="header-anchor">#</a> 小米电商</h3> <p>要求：编写SQL能运行，数据正确且符合规范，如遇到自定义函数或不记得的函数可以用XX代替</p> <p>1.已知有如下两个表sale：字段如下</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">Create</span> <span class="token keyword">table</span> sale_order<span class="token punctuation">(</span>
    Order_id <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">'订单ID'</span><span class="token punctuation">,</span>
    User_id <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    Order_status <span class="token keyword">int</span><span class="token punctuation">,</span>
    Create_time string<span class="token punctuation">,</span>
    Last_update_time string<span class="token punctuation">,</span>
    Product_id <span class="token keyword">bigint</span><span class="token punctuation">,</span>
    Product_num <span class="token keyword">bigint</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>用户注册表：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">Create</span> <span class="token keyword">table</span> user_info<span class="token punctuation">(</span>
    user_id <span class="token keyword">bigint</span> <span class="token keyword">comment</span><span class="token string">'用户ID，唯一主键'</span><span class="token punctuation">,</span>
    sex string<span class="token punctuation">.</span>
    age <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>问题：用一条SQL生成完整的用户画像表，包含如下字段：</p> <p>user_id,  sex,  age,  d7order_num,   d14_order_num，后面两个字段分别为近7天订单数量，近14天订单数量。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> sale_order<span class="token punctuation">(</span>
    order_id <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">'订单ID'</span><span class="token punctuation">,</span>
    user_id <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    order_status <span class="token keyword">int</span> <span class="token punctuation">,</span>
    create_time string<span class="token punctuation">,</span>
    last_update_time string<span class="token punctuation">,</span>
    product_id <span class="token keyword">bigint</span><span class="token punctuation">,</span>
    product_num <span class="token keyword">bigint</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> user_info<span class="token punctuation">(</span>
    user_id <span class="token keyword">bigint</span> <span class="token keyword">comment</span> <span class="token string">'用户ID,唯一主键'</span><span class="token punctuation">,</span>
    sex string<span class="token punctuation">,</span>
    age <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> u<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>
       s<span class="token punctuation">.</span>d7order_num<span class="token punctuation">,</span>
       s<span class="token punctuation">.</span>d14order_num
<span class="token keyword">from</span> user_info u
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> user_id<span class="token punctuation">,</span>
                  <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>create_time <span class="token operator">&gt;=</span> <span class="token string">'7天前'</span>  <span class="token operator">and</span> create_time <span class="token operator">&lt;=</span> <span class="token string">'今天'</span><span class="token punctuation">,</span> order_id<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> d7order_num<span class="token punctuation">,</span>
                  <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>create_time <span class="token operator">&gt;=</span> <span class="token string">'14天前'</span> <span class="token operator">and</span> create_time <span class="token operator">&lt;=</span> <span class="token string">'今天'</span><span class="token punctuation">,</span> order_id<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> d14order_num
           <span class="token keyword">from</span> sale_order
           <span class="token keyword">where</span> create_time <span class="token operator">&gt;=</span> <span class="token string">'14天前'</span>
           <span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">)</span> s <span class="token keyword">on</span> u<span class="token punctuation">.</span>user_id <span class="token operator">=</span> s<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="华泰证券"><a href="#华泰证券" class="header-anchor">#</a> 华泰证券</h3> <ul><li><p>查询课程编号“2”的成绩比课程编号“1”低的所有同学的学号、姓名。</p></li> <li><p>【这是行转列的衍生题】</p></li> <li><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> student<span class="token punctuation">(</span>sid <span class="token keyword">int</span><span class="token punctuation">,</span> sname string<span class="token punctuation">,</span> gender string<span class="token punctuation">,</span> class_id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> student
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token string">'女'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'李四'</span><span class="token punctuation">,</span> <span class="token string">'女'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'王五'</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span>  course <span class="token punctuation">(</span>cid <span class="token keyword">int</span><span class="token punctuation">,</span> cname string<span class="token punctuation">,</span> teacher_id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> course
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'生物'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'体育'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'物理'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> course<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> score <span class="token punctuation">(</span>sid <span class="token keyword">int</span><span class="token punctuation">,</span> student_id <span class="token keyword">int</span><span class="token punctuation">,</span> course_id <span class="token keyword">int</span><span class="token punctuation">,</span> number <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> score
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score<span class="token punctuation">;</span>

<span class="token keyword">with</span> t1 <span class="token keyword">as</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span> student_id<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>course_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>number<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pe<span class="token punctuation">,</span> <span class="token comment">--体育</span>
       <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>course_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>number<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> bio <span class="token comment">--生物</span>
<span class="token keyword">from</span> score
<span class="token keyword">group</span> <span class="token keyword">by</span> student_id
<span class="token keyword">having</span> pe<span class="token operator">&lt;</span>bio<span class="token punctuation">)</span>
<span class="token keyword">select</span> sid<span class="token punctuation">,</span> sname
<span class="token keyword">from</span> t1
<span class="token keyword">join</span> student
<span class="token keyword">on</span> t1<span class="token punctuation">.</span>student_id <span class="token operator">=</span> sid
<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div></li></ul> <h2 id="explode爆炸函数"><a href="#explode爆炸函数" class="header-anchor">#</a> explode爆炸函数</h2> <p>公式：用【lateral view】+【explode】将大字段拆解成小字段：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code> <span class="token keyword">select</span>  主表名<span class="token punctuation">.</span>旧字段<span class="token punctuation">,</span>视图名<span class="token punctuation">.</span>新字段 <span class="token keyword">from</span> 主表名 lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>数组字段<span class="token punctuation">)</span> 视图名 <span class="token keyword">as</span> 新字段名
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="腾讯qq-2"><a href="#腾讯qq-2" class="header-anchor">#</a> 腾讯QQ</h3> <p>假设tableA , tableB ,</p> <p>tableB</p> <table><thead><tr><th>qq号（字段名：qq）</th> <th>游戏（字段名：games）</th></tr></thead> <tbody><tr><td>10000</td> <td>a_b_c</td></tr> <tr><td>20000</td> <td>c_d</td></tr></tbody></table> <p>tableA</p> <table><thead><tr><th>qq号（字段名：qq）</th> <th>游戏（字段名：game）</th></tr></thead> <tbody><tr><td>10000</td> <td>a</td></tr> <tr><td>10000</td> <td>b</td></tr> <tr><td>10000</td> <td>c</td></tr> <tr><td>20000</td> <td>c</td></tr> <tr><td>20000</td> <td>d</td></tr></tbody></table> <p>将tableB输出为tableA的格式;</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">use</span> interview_db<span class="token punctuation">;</span>
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token punctuation">.</span><span class="token keyword">local</span><span class="token punctuation">.</span>auto<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> tableA<span class="token punctuation">(</span>qq string<span class="token punctuation">,</span> game string<span class="token punctuation">)</span> 
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> tableA <span class="token keyword">values</span> 
       <span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> tableB<span class="token punctuation">(</span>qq string<span class="token punctuation">,</span> game string<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> tableB <span class="token keyword">values</span> 
<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token string">'a_b_c'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">,</span> <span class="token string">'c_d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> qq<span class="token punctuation">,</span>
       tmp<span class="token punctuation">.</span>game
<span class="token keyword">from</span> tableB lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>game<span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> game<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="vivo"><a href="#vivo" class="header-anchor">#</a> vivo</h3> <p>用户常驻城市信息表addr_info: uid, addr_list</p> <p>数据示例：</p> <p>&quot;001&quot;，【&quot;深圳，东莞，广州&quot;】</p> <p>&quot;002&quot;，【&quot;深圳，佛山，广州&quot;】</p> <p>用户基本信息表user:uid，name，gender，birth ，addr_list</p> <p>问题：常驻人数top10的城市，男女比例的人数分布情况，要求结果如下：</p> <p>城市名称，排名，男性人数，女性人数</p> <p>&quot;北京&quot;，   1，  20008，   25005</p> <p>&quot;深圳&quot;，   2，  23408，  30005</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">use</span> interview_db<span class="token punctuation">;</span>
<span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token punctuation">.</span><span class="token keyword">local</span><span class="token punctuation">.</span>auto<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> user_info<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> user_info<span class="token punctuation">(</span>
    uid string<span class="token punctuation">,</span>
    name string<span class="token punctuation">,</span>
    gender string<span class="token punctuation">,</span>
    birth string<span class="token punctuation">,</span>
    <span class="token comment">----数组array，map，struct都是复杂类型</span>
    addr_list array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> user_info <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">'001'</span><span class="token punctuation">,</span><span class="token string">'zs'</span><span class="token punctuation">,</span><span class="token string">'male'</span><span class="token punctuation">,</span><span class="token string">'1995-01-01'</span><span class="token punctuation">,</span>array<span class="token punctuation">(</span><span class="token string">'深圳'</span><span class="token punctuation">,</span><span class="token string">'东莞'</span><span class="token punctuation">,</span><span class="token string">'广州'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'002'</span><span class="token punctuation">,</span><span class="token string">'ls'</span><span class="token punctuation">,</span><span class="token string">'female'</span><span class="token punctuation">,</span><span class="token string">'1996-01-01'</span><span class="token punctuation">,</span>array<span class="token punctuation">(</span><span class="token string">'深圳'</span><span class="token punctuation">,</span><span class="token string">'佛山'</span><span class="token punctuation">,</span><span class="token string">'广州'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> uid<span class="token punctuation">,</span>gender<span class="token punctuation">,</span>addr <span class="token keyword">from</span> user_info lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>addr_list<span class="token punctuation">)</span> view1 <span class="token keyword">as</span> addr
<span class="token punctuation">)</span>  <span class="token punctuation">,</span>
     t2 <span class="token keyword">as</span> <span class="token punctuation">(</span>
         <span class="token keyword">select</span> t1<span class="token punctuation">.</span>addr<span class="token punctuation">,</span>
                <span class="token comment">--统计每个城市的人数，方便后续排序</span>
                <span class="token function">count</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> cnt<span class="token punctuation">,</span>
                <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>gender<span class="token operator">=</span><span class="token string">'male'</span><span class="token punctuation">,</span>t1<span class="token punctuation">.</span>uid<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cnt_male<span class="token punctuation">,</span> <span class="token comment">--男性人数</span>
                <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>gender<span class="token operator">=</span><span class="token string">'female'</span><span class="token punctuation">,</span>t1<span class="token punctuation">.</span>uid<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cnt_female<span class="token comment">--男性人数</span>
                <span class="token keyword">from</span> t1
         <span class="token keyword">group</span> <span class="token keyword">by</span> t1<span class="token punctuation">.</span>addr

     <span class="token punctuation">)</span>
<span class="token keyword">select</span> addr<span class="token punctuation">,</span>
       row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> cnt <span class="token keyword">desc</span><span class="token punctuation">)</span> rn<span class="token punctuation">,</span>
       cnt_male<span class="token punctuation">,</span>
       cnt_female
<span class="token keyword">from</span> t2 <span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="cte语句-with-as语句"><a href="#cte语句-with-as语句" class="header-anchor">#</a> CTE语句(with as语句)</h2> <p>擅长解决，步骤很多，逻辑非常复杂的需求。</p> <p>语法：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">with</span> 临时表名<span class="token number">1</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>
      <span class="token keyword">select</span> 语句<span class="token number">1</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span> 临时表名<span class="token number">2</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>
      <span class="token keyword">select</span> 语句<span class="token number">2</span>【可以直接用前面的临时表名】
<span class="token punctuation">)</span><span class="token punctuation">,</span>
。。。。。。
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 临时表名n
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="字节跳动-2"><a href="#字节跳动-2" class="header-anchor">#</a> 字节跳动</h3> <p>一款MMORPG游戏有一个每日任务设计，完成不同任务可以获得不同的活跃度奖励。当日活跃度累计超过100，就可以获得一个活跃宝箱（获得宝箱后玩家仍然会继续参加任务获得活跃度，但不会有额外奖励）。活跃度会每日清零，活跃任务也是每日刷新。现有表结构如下</p> <p>表dm_activity_di（当角色每完成一个任务时候，记录一条获取活跃度的日志）:</p> <table><thead><tr><th></th> <th></th> <th></th></tr></thead> <tbody><tr><td>role_id</td> <td>int</td> <td>#角色id</td></tr> <tr><td>task_id</td> <td>int</td> <td>#本次完成的任务id</td></tr> <tr><td>activity_add</td> <td>int</td> <td>#本次角色获取的活跃度</td></tr> <tr><td>p_date</td> <td>string</td> <td>#日志触发的日期, yyyy-MM-dd</td></tr> <tr><td>time</td> <td>bigint</td> <td>#该日志的触发时间戳</td></tr></tbody></table> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">table</span> dm_activity_di<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> dm_activity_di
<span class="token punctuation">(</span>
    role_id      string <span class="token keyword">comment</span> <span class="token string">'#角色id'</span><span class="token punctuation">,</span>
    task_id      <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'#本次完成的任务id'</span><span class="token punctuation">,</span>
    activity_add <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'#本次角色获取的活跃度'</span><span class="token punctuation">,</span>
    p_date       string <span class="token keyword">comment</span> <span class="token string">'#日志触发的日期, yyyy-MM-dd'</span><span class="token punctuation">,</span>
    <span class="token keyword">time</span>         string <span class="token keyword">comment</span> <span class="token string">'#该日志的触发时间戳'</span>
<span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'当角色每完成一个任务时候，记录一条获取活跃度的日志'</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dm_activity_di
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 10:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 11:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span>  <span class="token string">'2021-01-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span>  <span class="token string">'2021-01-01 13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span>  <span class="token string">'2021-01-01 14:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

       <span class="token punctuation">(</span><span class="token string">'小李'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 08:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小李'</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 09:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小李'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token number">40</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 10:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小李'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 11:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小李'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

       <span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 14:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 15:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 16:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 17:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01 18:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>1）统计一下2021-01-01当天，各个服务器的各个角色在完成各个任务时累积已获得的活跃度。</p> <p>示例：</p> <p>一个角色在一天内全部的活跃度获取日志</p> <table><thead><tr><th style="text-align:left;">role_id</th> <th style="text-align:left;">task_id</th> <th style="text-align:left;">activity_add</th> <th style="text-align:left;">p_date</th> <th style="text-align:left;">time</th></tr></thead> <tbody><tr><td style="text-align:left;">小红</td> <td style="text-align:left;">12</td> <td style="text-align:left;">20</td> <td style="text-align:left;">2021-01-01</td> <td style="text-align:left;">2021-01-01 10:00:00</td></tr> <tr><td style="text-align:left;">小红</td> <td style="text-align:left;">13</td> <td style="text-align:left;">30</td> <td style="text-align:left;">2021-01-01</td> <td style="text-align:left;">2021-01-01 11:00:00</td></tr> <tr><td style="text-align:left;">小红</td> <td style="text-align:left;">1</td> <td style="text-align:left;">10</td> <td style="text-align:left;">2021-01-01</td> <td style="text-align:left;">2021-01-01 12:00:00</td></tr> <tr><td style="text-align:left;">小红</td> <td style="text-align:left;">3</td> <td style="text-align:left;">60</td> <td style="text-align:left;">2021-01-01</td> <td style="text-align:left;">2021-01-01 13:00:00</td></tr> <tr><td style="text-align:left;">小红</td> <td style="text-align:left;">6</td> <td style="text-align:left;">30</td> <td style="text-align:left;">2021-01-01</td> <td style="text-align:left;">2021-01-01 14:00:00</td></tr></tbody></table> <p>结果输出</p> <table><thead><tr><th style="text-align:left;">role_id</th> <th style="text-align:left;">task_id</th> <th style="text-align:left;">activity_add</th> <th style="text-align:left;">p_date</th> <th style="text-align:left;">time</th> <th style="text-align:left;">累积获得的活跃度</th></tr></thead> <tbody><tr><td style="text-align:left;">小红</td> <td style="text-align:left;">12</td> <td style="text-align:left;">20</td> <td style="text-align:left;">2021-01-01</td> <td style="text-align:left;">2021-01-01 10:00:00</td> <td style="text-align:left;">20</td></tr> <tr><td style="text-align:left;">小红</td> <td style="text-align:left;">13</td> <td style="text-align:left;">30</td> <td style="text-align:left;">2021-01-01</td> <td style="text-align:left;">2021-01-01 11:00:00</td> <td style="text-align:left;">50</td></tr> <tr><td style="text-align:left;">小红</td> <td style="text-align:left;">1</td> <td style="text-align:left;">10</td> <td style="text-align:left;">2021-01-01</td> <td style="text-align:left;">2021-01-01 12:00:00</td> <td style="text-align:left;">60</td></tr> <tr><td style="text-align:left;">小红</td> <td style="text-align:left;">3</td> <td style="text-align:left;">60</td> <td style="text-align:left;">2021-01-01</td> <td style="text-align:left;">2021-01-01 13:00:00</td> <td style="text-align:left;">120</td></tr> <tr><td style="text-align:left;">小红</td> <td style="text-align:left;">6</td> <td style="text-align:left;">30</td> <td style="text-align:left;">2021-01-01</td> <td style="text-align:left;">2021-01-01 14:00:00</td> <td style="text-align:left;">150</td></tr></tbody></table> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
     <span class="token function">sum</span><span class="token punctuation">(</span>activity_add<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span> role_id <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token identifier"><span class="token punctuation">`</span>time<span class="token punctuation">`</span></span> <span class="token punctuation">)</span> sum1
<span class="token keyword">from</span> dm_activity_di
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>2）统计一下2021-01-01当天，角色获得活跃度宝箱时候所完成的任务数量分布。</p> <p>示例：结果输出</p> <table><thead><tr><th>p_date</th> <th>获得宝箱时候的任务数量</th> <th>角色数</th></tr></thead> <tbody><tr><td>2021-01-01</td> <td>4</td> <td>2</td></tr> <tr><td>2021-01-01</td> <td>5</td> <td>1</td></tr></tbody></table> <p>【活跃度累计超过100】等价于【获得1个宝箱】</p> <p><img src="https://gitee.com/nylg/picture/raw/master/20240202/image-20240203085835685.png" alt="image-20240203085835685"></p> <p><img src="https://gitee.com/nylg/picture/raw/master/20240202/image-20240203085856117.png" alt="image-20240203085856117"></p> <p><img src="https://gitee.com/nylg/picture/raw/master/20240202/image-20240203085912316.png" alt="image-20240203085912316"></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">--步骤清晰法</span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
                   <span class="token function">sum</span><span class="token punctuation">(</span>activity_add<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span> role_id <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token identifier"><span class="token punctuation">`</span>time<span class="token punctuation">`</span></span> <span class="token punctuation">)</span> sum1
            <span class="token keyword">from</span> dm_activity_di<span class="token punctuation">)</span><span class="token punctuation">,</span>
     t2 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
                   row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span>role_id <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token identifier"><span class="token punctuation">`</span>time<span class="token punctuation">`</span></span><span class="token punctuation">)</span> cnt
            <span class="token keyword">from</span> t1<span class="token punctuation">)</span><span class="token punctuation">,</span>
     t3 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> t2 <span class="token keyword">where</span> sum1 <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     t4 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
                   row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span>role_id <span class="token keyword">order</span> <span class="token keyword">by</span> sum1 <span class="token punctuation">)</span> <span class="token keyword">as</span> rn1
            <span class="token keyword">from</span> t3<span class="token punctuation">)</span><span class="token punctuation">,</span>
     t5 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> t4 <span class="token keyword">where</span> rn1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> p_date<span class="token punctuation">,</span>
       cnt<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span>role_id<span class="token punctuation">)</span> <span class="token keyword">as</span> num_roles
<span class="token keyword">from</span> t5
<span class="token keyword">group</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span> cnt<span class="token punctuation">;</span>

<span class="token comment">----简化写法</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>activity_add<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span> role_id <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token identifier"><span class="token punctuation">`</span>time<span class="token punctuation">`</span></span> <span class="token punctuation">)</span> <span class="token identifier"><span class="token punctuation">`</span>累积获得的活跃度<span class="token punctuation">`</span></span>
<span class="token keyword">from</span> dm_activity_di <span class="token keyword">where</span> role_id<span class="token operator">=</span><span class="token string">'小红'</span><span class="token punctuation">;</span>

<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
           <span class="token function">sum</span><span class="token punctuation">(</span>activity_add<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span> role_id <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token identifier"><span class="token punctuation">`</span>time<span class="token punctuation">`</span></span> <span class="token punctuation">)</span> sum1<span class="token punctuation">,</span>
           <span class="token comment">--得到当前活跃度时，闯了几关,</span>
           row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span>role_id <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token identifier"><span class="token punctuation">`</span>time<span class="token punctuation">`</span></span><span class="token punctuation">)</span> cnt
    <span class="token keyword">from</span> dm_activity_di
<span class="token punctuation">)</span>  <span class="token punctuation">,</span>
     t2 <span class="token keyword">as</span> <span class="token punctuation">(</span>
         <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
                row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span>role_id <span class="token keyword">order</span> <span class="token keyword">by</span> sum1 <span class="token punctuation">)</span> <span class="token keyword">as</span> rn1
         <span class="token keyword">from</span> t1 <span class="token keyword">where</span> sum1<span class="token operator">&gt;</span><span class="token number">100</span>
     <span class="token punctuation">)</span>
<span class="token keyword">select</span> p_date<span class="token punctuation">,</span>cnt<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span>role_id<span class="token punctuation">)</span> <span class="token keyword">as</span> num_roles
<span class="token keyword">from</span> t2 <span class="token keyword">where</span> rn1<span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> p_date<span class="token punctuation">,</span>cnt<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h2 id="综合案例"><a href="#综合案例" class="header-anchor">#</a> 综合案例</h2> <h3 id="腾讯互娱"><a href="#腾讯互娱" class="header-anchor">#</a> 腾讯互娱</h3> <ul><li>窗口函数+行转列+CTE语法</li></ul> <p>题目：有一个流水表,用户1在什么时间玩了什么游戏,</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">temporary</span> <span class="token keyword">view</span> user_login<span class="token punctuation">(</span>dtstatdate<span class="token punctuation">,</span> qq<span class="token punctuation">,</span> dteventtime<span class="token punctuation">,</span> game<span class="token punctuation">)</span>
<span class="token keyword">as</span>
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">&quot;20220110&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2022/1/10 0:04'</span><span class="token punctuation">,</span> <span class="token string">&quot;王者荣耀&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">&quot;20220110&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2022/1/10 0:04'</span><span class="token punctuation">,</span> <span class="token string">&quot;王者荣耀&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">&quot;20220110&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2022/1/10 10:14'</span><span class="token punctuation">,</span> <span class="token string">&quot;王者荣耀&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">&quot;20220110&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2022/1/10 11:02'</span><span class="token punctuation">,</span> <span class="token string">&quot;天刀&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">&quot;20220110&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2022/1/10 11:02'</span><span class="token punctuation">,</span> <span class="token string">&quot;天刀&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">&quot;20220110&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2022/1/10 12:14'</span><span class="token punctuation">,</span> <span class="token string">&quot;王者荣耀&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">&quot;20220110&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'2022/1/10 10:13'</span><span class="token punctuation">,</span> <span class="token string">&quot;数码宝贝&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">&quot;20220110&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'2022/1/10 15:58'</span><span class="token punctuation">,</span> <span class="token string">&quot;lol&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">&quot;20220110&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'2022/1/10 17:11'</span><span class="token punctuation">,</span> <span class="token string">&quot;lol&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user_login<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>需求：处理一下某个用户的玩游戏的先后顺序链条,按照时间排序后游戏相同的要合并</p> <p>例子：AABBA需要合并成ABA</p> <p>例子结果：</p> <table><thead><tr><th>dtstatdate</th> <th>qq</th> <th>time_set</th> <th>game_set</th></tr></thead> <tbody><tr><td>20220110</td> <td>1</td> <td>2022/1/10 0:04,2022/1/10 11:02,2022/1/10 12:14</td> <td>王者荣耀,天刀,王者荣耀</td></tr> <tr><td>20220110</td> <td>2</td> <td>2022/1/10 10:13,2022/1/10 15:58</td> <td>数码宝贝,lol</td></tr></tbody></table> <p>代码：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
           <span class="token comment">--1-标记每天每用户，每次游戏的上次游戏是什么。目的是为了借助错位1行，对相同游戏去重复，间接合并相邻的2次游戏。</span>
           lag<span class="token punctuation">(</span>game<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dtstatdate<span class="token punctuation">,</span>qq <span class="token keyword">order</span> <span class="token keyword">by</span> dteventtime<span class="token punctuation">)</span> <span class="token keyword">last</span>
    <span class="token keyword">from</span> user_login
<span class="token punctuation">)</span><span class="token punctuation">,</span>
     t2 <span class="token keyword">as</span> <span class="token punctuation">(</span>
         <span class="token keyword">select</span> dtstatdate<span class="token punctuation">,</span> qq<span class="token punctuation">,</span> dteventtime<span class="token punctuation">,</span> game
         <span class="token keyword">from</span> t1
         <span class="token comment">--2-借助错位1行，对相同游戏去重复，间接合并相邻的2次游戏。</span>
         <span class="token keyword">where</span> game <span class="token operator">!=</span> <span class="token keyword">last</span>
     <span class="token punctuation">)</span><span class="token punctuation">,</span>
     t3 <span class="token keyword">as</span> <span class="token punctuation">(</span>
         <span class="token comment">--3-将时间和游戏，绑在一起合成整体。</span>
         <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span> concat<span class="token punctuation">(</span>dteventtime<span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> game<span class="token punctuation">)</span> time_game
         <span class="token keyword">from</span> t2
     <span class="token punctuation">)</span><span class="token punctuation">,</span>
     t4 <span class="token keyword">as</span> <span class="token punctuation">(</span>
         <span class="token comment">--4-将上一步每个整体，装进一个数组容器中。</span>
         <span class="token keyword">select</span> dtstatdate<span class="token punctuation">,</span> qq<span class="token punctuation">,</span> 
collect_list<span class="token punctuation">(</span>time_game<span class="token punctuation">)</span> time_games 
<span class="token keyword">from</span> t3 <span class="token keyword">group</span> <span class="token keyword">by</span> dtstatdate<span class="token punctuation">,</span> qq
     <span class="token punctuation">)</span><span class="token punctuation">,</span>
     t5 <span class="token keyword">as</span> <span class="token punctuation">(</span>
         <span class="token keyword">select</span> dtstatdate<span class="token punctuation">,</span>
                qq<span class="token punctuation">,</span>
                <span class="token comment">--5-对上一步的数组容器中的每个整体进行排序，</span>
                <span class="token comment">--具体是按照每个整体的前半部分也就是日期排序。</span>
                <span class="token comment">--array_sort函数，用法是对数组容器的每个元素两两之间比较排序，left, right就是每次两两之间比较的意思。</span>
                <span class="token comment">--负1表示左比右小，正1表示左比右大，零表示二者相等。</span>
                array_sort<span class="token punctuation">(</span>time_games<span class="token punctuation">,</span>
                           <span class="token punctuation">(</span><span class="token keyword">left</span><span class="token punctuation">,</span> <span class="token keyword">right</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
                           <span class="token keyword">case</span>
                           <span class="token keyword">when</span> split<span class="token punctuation">(</span><span class="token keyword">left</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> split<span class="token punctuation">(</span><span class="token keyword">right</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token operator">-</span><span class="token number">1</span>
                           <span class="token keyword">when</span> split<span class="token punctuation">(</span><span class="token keyword">left</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> split<span class="token punctuation">(</span><span class="token keyword">right</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token number">1</span>
                           <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span> sorted_games
         <span class="token keyword">from</span> t4
     <span class="token punctuation">)</span><span class="token punctuation">,</span>
     t6 <span class="token keyword">as</span> <span class="token punctuation">(</span>
         <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
                <span class="token comment">--6-上一步排好序的大数组容器中，每个元素是【时间-游戏名】整体，将大数组容器还原拆成2个小数组容器，</span>
                <span class="token comment">-- 第1个数组中都是时间，第2个数组中都是游戏名。</span>
                <span class="token comment">-- transform函数用法是对数组每个元素进行转换。x名字随便取，表示每个元素。</span>
                transform<span class="token punctuation">(</span>sorted_games<span class="token punctuation">,</span> x<span class="token operator">-</span><span class="token operator">&gt;</span>split<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> time_array<span class="token punctuation">,</span>
                transform<span class="token punctuation">(</span>sorted_games<span class="token punctuation">,</span> x<span class="token operator">-</span><span class="token operator">&gt;</span>split<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> games_array
         <span class="token keyword">from</span> t5
     <span class="token punctuation">)</span><span class="token punctuation">,</span>
     t7 <span class="token keyword">as</span> <span class="token punctuation">(</span>
         <span class="token comment">--7-将每个小数组容器的元素用字符串表示</span>
         <span class="token keyword">select</span> dtstatdate<span class="token punctuation">,</span> qq<span class="token punctuation">,</span> 
concat_ws<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span> time_array<span class="token punctuation">)</span> time_set<span class="token punctuation">,</span> 
concat_ws<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span> games_array<span class="token punctuation">)</span> game_set <span class="token keyword">from</span> t6
     <span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t7 <span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><h3 id="巴别时代"><a href="#巴别时代" class="header-anchor">#</a> 巴别时代</h3> <ul><li>考验行转列</li></ul> <p>role_login</p> <table><thead><tr><th>字段名</th> <th>类型</th> <th>含义</th></tr></thead> <tbody><tr><td>server_id</td> <td>int</td> <td>'服务器id',</td></tr> <tr><td>pid</td> <td>int</td> <td>'用户平台id',</td></tr> <tr><td>plosgn</td> <td>int</td> <td>'用户所属平台的id',</td></tr> <tr><td>log_time</td> <td>int</td> <td>'登入时间戳',</td></tr> <tr><td>ds</td> <td>string</td> <td>'日期',</td></tr> <tr><td>gn</td> <td>string</td> <td>'游戏名'</td></tr></tbody></table> <p>role_login</p> <table><thead><tr><th>server_id</th> <th>pid</th> <th>plosgn</th> <th>log_time</th> <th>ds</th> <th>gn</th></tr></thead> <tbody><tr><td>3000001</td> <td>510166</td> <td>1</td> <td>1626565553</td> <td>2021-07-18</td> <td>A</td></tr> <tr><td>3000001</td> <td>510166</td> <td>1</td> <td>1626568224</td> <td>2021-07-18</td> <td>A</td></tr> <tr><td>3000001</td> <td>510166</td> <td>1</td> <td>1626574517</td> <td>2021-07-18</td> <td>B</td></tr> <tr><td>3000001</td> <td>510047</td> <td>8</td> <td>1626585497</td> <td>2021-07-18</td> <td>C</td></tr> <tr><td>3000001</td> <td>510047</td> <td>8</td> <td>1626659972</td> <td>2021-07-19</td> <td>D</td></tr> <tr><td>3000008</td> <td>510013</td> <td>1</td> <td>1626660317</td> <td>2021-07-19</td> <td>D</td></tr> <tr><td>3000008</td> <td>510013</td> <td>1</td> <td>1626662251</td> <td>2021-07-19</td> <td>T</td></tr> <tr><td>3000001</td> <td>782902</td> <td>16</td> <td>1626662577</td> <td>2021-07-19</td> <td>Y</td></tr> <tr><td>3000001</td> <td>782902</td> <td>16</td> <td>1626662895</td> <td>2021-07-19</td> <td>Y</td></tr> <tr><td>3000001</td> <td>782902</td> <td>16</td> <td>1626663542</td> <td>2021-07-19</td> <td>Y</td></tr> <tr><td>3000001</td> <td>510062</td> <td>7</td> <td>1626663914</td> <td>2021-07-19</td> <td>Y</td></tr> <tr><td>3000001</td> <td>510062</td> <td>7</td> <td>1626664080</td> <td>2021-07-19</td> <td>Y</td></tr></tbody></table> <p>列出在2021年5月有过登录，2021年6月没有登录，2021年7月又登录过游戏D的用户信息（需展示的字段为server_id,pid)</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>select server_id, pid
from (select *,
             count(if(substr(ds, 0, 7) = '2021-05', 1, null)) over (partition by pid ) cnt1,
             count(if(substr(ds, 0, 7) = '2021-06', 1, null)) over (partition by pid ) cnt2,
             count(if(substr(ds, 0, 7) = '2021-07', 1, null)) over (partition by pid ) cnt3
      from role_login
      where gn = 'D'
        and substr(ds, 0, 7) in ('2021-05', '2021-06', '2021-07')
     ) t
where cnt1 &gt; 0
  and cnt2 = 0
  and cnt3 &gt; 0;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/02/03, 09:07:11</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/09fdb1/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">CentOS7安装MySQL57</div></a> <a href="/pages/d7857e/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">linux</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/09fdb1/" class="prev">CentOS7安装MySQL57</a></span> <span class="next"><a href="/pages/d7857e/">linux</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/80365f/"><div>
            证券市场基本法律法规
            <!----></div></a> <span class="date">03-13</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/d9e4f4/"><div>
            证券考试规则
            <!----></div></a> <span class="date">03-12</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/cb2c17/"><div>
            金融市场基础知识
            <!----></div></a> <span class="date">03-12</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:cloudjava@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/bigdatajava" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/nylg" title="Gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2014-2024
    <span>wen chao | <a href="https://github.com/bigdatajava/blog-talk/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.b2807c2b.js" defer></script><script src="/assets/js/2.eeaab5de.js" defer></script><script src="/assets/js/36.7c80731a.js" defer></script>
  </body>
</html>

(window.webpackJsonp=window.webpackJsonp||[]).push([[248],{616:function(a,s,t){"use strict";t.r(s);var n=t(5),e=Object(n.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("U2FsdGVkX1/iz6ghuBDuAl1kLf9QWSmwvGOpf/TirTBX1MnunCJEYBhu6o15br8V\njIkLI7YRZUViJz+hAiBhNk16hiqpXcQgJteBq+TQT4KMJenw2g==\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h2",{attrs:{id:"_1-skywalking是什么"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-skywalking是什么"}},[a._v("#")]),a._v(" 1. skywalking是什么")]),a._v(" "),s("p",[a._v("对于一个大型的几十个、几百个微服务构成的微服务架构系统，通常会遇到下面一些问题，比如：")]),a._v(" "),s("ol",[s("li",[a._v("如何串联整个调用链路，快速定位问题？")]),a._v(" "),s("li",[a._v("如何理清各个微服务之间的依赖关系？")]),a._v(" "),s("li",[a._v("如何进行各个微服务接口的性能分折？")]),a._v(" "),s("li",[a._v("如何跟踪整个业务流程的调用处理顺序？")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155004707.png",alt:"image-20220623155004707"}})]),a._v(" "),s("p",[a._v("skywalking是一个国产开源框架，2015年由吴晟开源 ， 2017年加入Apache孵化器。skywalking是分布式系统的应用程序性能监视工具，专为微服务、云原生架构和基于容器（Docker、K8s、Mesos）架构而设计。SkyWalking 是观察性分析平台和应用性能管理系统，提供分布式追踪、服务网格遥测分析、度量聚合和可视化一体化解决方案。")]),a._v(" "),s("p",[a._v("官网：http://skywalking.apache.org/")]),a._v(" "),s("p",[a._v("下载：http://skywalking.apache.org/downloads/")]),a._v(" "),s("p",[a._v("Github：https://github.com/apache/skywalking")]),a._v(" "),s("p",[a._v("文档： "),s("a",{attrs:{href:"https://skywalking.apache.org/docs/main/v8.3.0/readme/",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://skywalking.apache.org/docs/main/v8.4.0/readme/"),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("中文文档： https://skyapm.github.io/document-cn-translation-of-skywalking/")]),a._v(" "),s("p",[a._v("版本： v8.3.0  升级到v8.4.0")]),a._v(" "),s("h3",{attrs:{id:"调用链选型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#调用链选型"}},[a._v("#")]),a._v(" 调用链选型")]),a._v(" "),s("ol",[s("li",[a._v("Zipkin是Twitter开源的调用链分析工具，目前基于springcloud sleuth得到了广泛的使用，特点是轻量，使用部署简单。")]),a._v(" "),s("li",[a._v("Pinpoint是韩国人开源的基于字节码注入的调用链分析，以及应用监控分析工具。特点是支持多种插件，UI功能强大，接入端无代码侵入。")]),a._v(" "),s("li",[a._v("SkyWalking是本土开源的基于字节码注入的调用链分析，以及应用监控分析工具。特点是支持多种插件，UI功能较强，接入端无代码侵入。目前已加入Apache孵化器。")]),a._v(" "),s("li",[a._v("CAT是大众点评开源的基于编码和配置的调用链分析，应用监控分析，日志采集，监控报警等一系列的监控平台工具。")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155020779.png",alt:"image-20220623155020779"}})]),a._v(" "),s("h3",{attrs:{id:"探针性能对比"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#探针性能对比"}},[a._v("#")]),a._v(" 探针性能对比")]),a._v(" "),s("p",[a._v("模拟了三种并发用户：500，750，1000。使用jmeter测试，每个线程发送30个请求，设置思考时间为10ms。使用的采样率为1，即100%，这边与生产可能有差别。pinpoint默认的采样率为20，即50%，通过设置agent的配置文件改为100%。zipkin默认也是1。组合起来，一共有12种。下面看下汇总表：")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155107735.png",alt:"image-20220623155107735"}})]),a._v(" "),s("p",[a._v("从上表可以看出，在三种链路监控组件中，"),s("strong",[a._v("skywalking的探针对吞吐量的影响最小，zipkin的吞吐量居中。pinpoint的探针对吞吐量的影响较为明显")]),a._v("，在500并发用户时，测试服务的吞吐量从1385降低到774，影响很大。然后再看下CPU和memory的影响，在内部服务器进行的压测，对CPU和memory的影响都差不多在10%之内。")]),a._v(" "),s("h3",{attrs:{id:"_1-1-skywalking主要功能特性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-skywalking主要功能特性"}},[a._v("#")]),a._v(" 1.1 Skywalking主要功能特性")]),a._v(" "),s("p",[a._v("1、多种监控手段，可以通过语言探针和service mesh获得监控的数据；")]),a._v(" "),s("p",[a._v("2、支持多种语言自动探针，包括 Java，.NET Core 和 Node.JS；")]),a._v(" "),s("p",[a._v("3、轻量高效，无需大数据平台和大量的服务器资源；")]),a._v(" "),s("p",[a._v("4、模块化，UI、存储、集群管理都有多种机制可选；")]),a._v(" "),s("p",[a._v("5、支持告警；")]),a._v(" "),s("p",[a._v("6、优秀的可视化解决方案；")]),a._v(" "),s("h3",{attrs:{id:"_1-2-skywalking整体架构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-skywalking整体架构"}},[a._v("#")]),a._v(" 1.2 Skywalking整体架构")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155122825.png",alt:"image-20220623155122825"}})]),a._v(" "),s("p",[s("strong",[a._v("整个架构分成四部分：")])]),a._v(" "),s("p",[a._v("1、上部分Agent ：负责从应用中，收集链路信息，发送给 SkyWalking OAP 服务器；")]),a._v(" "),s("p",[a._v("2、下部分 SkyWalking OAP ：负责接收Agent发送的Tracing数据信息，然后进行分析(Analysis Core)，存储到外部存储器(Storage)，最终提供查询(Query)功能；")]),a._v(" "),s("p",[a._v("3、右部分Storage：Tracing数据存储，目前支持ES、MySQL、Sharding Sphere、TiDB、H2多种存储器，目前采用较多的是ES，主要考虑是SkyWalking开发团队自己的生产环境采用ES为主；")]),a._v(" "),s("p",[a._v("4、左部分SkyWalking UI：负责提供控制台，查看链路等等；")]),a._v(" "),s("p",[s("strong",[a._v("SkyWalking支持三种探针：")])]),a._v(" "),s("p",[a._v("●\tAgent – 基于ByteBuddy字节码增强技术实现，通过jvm的agent参数加载，并在程序启动时拦截指定的方法来收集数据。")]),a._v(" "),s("p",[a._v("●\tSDK – 程序中显式调用SkyWalking提供的SDK来收集数据，对应用有侵入。")]),a._v(" "),s("p",[a._v("●\tService Mesh – 通过Service mesh的网络代理来收集数据。")]),a._v(" "),s("h4",{attrs:{id:"后端-backend"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#后端-backend"}},[a._v("#")]),a._v(" 后端（Backend）")]),a._v(" "),s("p",[a._v("接受探针发送过来的数据，进行度量分析，调用链分析和存储。后端主要分为两部分：")]),a._v(" "),s("p",[a._v("●\tOAP（Observability Analysis Platform）- 进行度量分析和调用链分析的后端平台，并支持将数据存储到各种数据库中，如：ElasticSearch，MySQL，InfluxDB等。")]),a._v(" "),s("p",[a._v("●\tOAL（Observability Analysis Language）- 用来进行度量分析的DSL，类似于SQL，用于查询度量分析结果和警报。")]),a._v(" "),s("h4",{attrs:{id:"界面-ui"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#界面-ui"}},[a._v("#")]),a._v(" 界面(UI)")]),a._v(" "),s("p",[a._v("●\tRocketBot UI – SkyWalking 7.0.0 的默认web UI")]),a._v(" "),s("p",[a._v("●\tCLI – 命令行界面")]),a._v(" "),s("p",[a._v("这三个模块的交互流程：")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155138622.png",alt:"image-20220623155138622"}})]),a._v(" "),s("h3",{attrs:{id:"_1-3-skywalking-环境搭建部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-skywalking-环境搭建部署"}},[a._v("#")]),a._v(" 1.3 SkyWalking 环境搭建部署")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155146928.png",alt:"image-20220623155146928"}})]),a._v(" "),s("ul",[s("li",[a._v("skywalking agent和业务系统绑定在一起，负责收集各种监控数据")]),a._v(" "),s("li",[a._v("Skywalking oapservice是负责处理监控数据的，比如接受skywalking agent的监控数据，并存储在数据库中;接受skywalking webapp的前端请求，从数据库查询数据，并返回数据给前端。Skywalking oapservice通常以集群的形式存在。")]),a._v(" "),s("li",[a._v("skywalking webapp，前端界面，用于展示数据。")]),a._v(" "),s("li",[a._v("用于存储监控数据的数据库，比如mysql、elasticsearch等。")])]),a._v(" "),s("h4",{attrs:{id:"_1-3-1-下载-skywalking"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-1-下载-skywalking"}},[a._v("#")]),a._v(" 1.3.1 下载 SkyWalking")]),a._v(" "),s("p",[a._v("下载：http://skywalking.apache.org/downloads/")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155154852.png",alt:"image-20220623155154852"}})]),a._v(" "),s("p",[a._v("目录结构")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155202550.png",alt:"image-20220623155202550"}})]),a._v(" "),s("h4",{attrs:{id:"_1-3-2-搭建skywalking-oap-服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-2-搭建skywalking-oap-服务"}},[a._v("#")]),a._v(" 1.3.2 搭建SkyWalking OAP 服务")]),a._v(" "),s("p",[a._v("先使用默认的H2数据库存储,不用修改配置")]),a._v(" "),s("p",[a._v("config/application.yml")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155229239.png",alt:"image-20220623155229239"}})]),a._v(" "),s("p",[a._v("启动脚本bin/startup.sh")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155243446.png",alt:"image-20220623155243446"}})]),a._v(" "),s("p",[a._v("日志信息存储在logs目录")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155253163.png",alt:"image-20220623155253163"}})]),a._v(" "),s("p",[a._v("启动成功后会启动两个服务，一个是skywalking-oap-server，一个是skywalking-web-ui")]),a._v(" "),s("p",[a._v("skywalking-oap-server服务启动后会暴露11800 和 12800 两个端口，分别为收集监控数据的端口11800和接受前端请求的端口12800，修改端口可以修改config/applicaiton.yml")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155311920.png",alt:"image-20220623155311920"}})]),a._v(" "),s("p",[a._v("skywalking-web-ui服务会占用 8080 端口， 修改端口可以修改webapp/webapp.yml")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155321827.png",alt:"image-20220623155321827"}})]),a._v(" "),s("p",[a._v("server.port：SkyWalking UI服务端口，默认是8080；")]),a._v(" "),s("p",[a._v("collector.ribbon.listOfServers：SkyWalking OAP服务地址数组，SkyWalking UI界面的数据是通过请求SkyWalking OAP服务来获得；")]),a._v(" "),s("p",[a._v("访问："),s("a",{attrs:{href:"http://192.168.3.14:8080/",target:"_blank",rel:"noopener noreferrer"}},[a._v("http://192.168.3.100:8080/"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155332526.png",alt:"image-20220623155332526"}})]),a._v(" "),s("p",[a._v("页面的右下角可以中英文切换，可以切换选择要展示的时间区间的跟踪数据。")]),a._v(" "),s("h3",{attrs:{id:"_1-4-skywalking中三个概念"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-skywalking中三个概念"}},[a._v("#")]),a._v(" 1.4 SkyWalking中三个概念")]),a._v(" "),s("p",[a._v("**服务(Service) ：**表示对请求提供相同行为的一系列或一组工作负载，在使用Agent时，可以定义服务的名字；")]),a._v(" "),s("p",[a._v("**服务实例(Service Instance) ：**上述的一组工作负载中的每一个工作负载称为一个实例， 一个服务实例实际就是操作系统上的一个真实进程；")]),a._v(" "),s("p",[a._v("**端点(Endpoint) ：**对于特定服务所接收的请求路径, 如HTTP的URI路径和gRPC服务的类名 + 方法签名；")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155340340.png",alt:"image-20220623155340340"}})]),a._v(" "),s("h2",{attrs:{id:"_2-skywalking快速开始"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-skywalking快速开始"}},[a._v("#")]),a._v(" 2. SkyWalking快速开始")]),a._v(" "),s("h3",{attrs:{id:"_2-1-skywalking-agent跟踪微服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-skywalking-agent跟踪微服务"}},[a._v("#")]),a._v(" 2.1 SkyWalking Agent跟踪微服务")]),a._v(" "),s("h4",{attrs:{id:"_2-1-1-通过jar包方式接入"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-通过jar包方式接入"}},[a._v("#")]),a._v(" 2.1.1 通过jar包方式接入")]),a._v(" "),s("p",[a._v("准备一个springboot程序，打成可执行jar包，写一个shell脚本，在启动项目的Shell脚本上，通过 -javaagent 参数进行配置SkyWalking Agent来跟踪微服务；")]),a._v(" "),s("p",[a._v("startup.sh脚本：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("#!/bin/sh\n# SkyWalking Agent配置\nexport SW_AGENT_NAME=springboot-skywalking-demo #Agent名字,一般使用`spring.application.name`\nexport SW_AGENT_COLLECTOR_BACKEND_SERVICES=127.0.0.1:11800 #配置 Collector 地址。\nexport SW_AGENT_SPAN_LIMIT=2000 #配置链路的最大Span数量，默认为 300。\nexport JAVA_AGENT=-javaagent:/usr/local/soft/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar\njava $JAVA_AGENT -jar springboot-skywalking-demo-0.0.1-SNAPSHOT.jar #jar启动\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("启动日志")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155350313.png",alt:"image-20220623155350313"}})]),a._v(" "),s("p",[a._v("等同于")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("java -javaagent:/usr/local/soft/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar \n-DSW_AGENT_COLLECTOR_BACKEND_SERVICES=127.0.0.1:11800 \n-DSW_AGENT_NAME=springboot-skywalking-demo -jar springboot-skywalking-demo-0.0.1-SNAPSHOT.jar\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("参数名对应agent/config/agent.config配置文件中的属性。")]),a._v(" "),s("p",[a._v("属性对应的源码：org.apache.skywalking.apm.agent.core.conf.Config.java")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("# The service name in UI\nagent.service_name=${SW_AGENT_NAME:Your_ApplicationName}\n# Backend service addresses.\ncollector.backend_service=${SW_AGENT_COLLECTOR_BACKEND_SERVICES:127.0.0.1:11800}\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("我们也可以使用skywalking.+配置文件中的配置名作为系统配置项来进行覆盖。 javaagent参数配置方式优先级更高")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("-javaagent:D:\\apache\\apache-skywalking-apm-es7-8.4.0\\apache-skywalking-apm-bin-es7\\agent\\skywalking-agent.jar\n-Dskywalking.agent.service_name=springboot-skywalking-demo\n-Dskywalking.collector.backend_service=192.168.3.100:11800\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155359340.png",alt:"image-20220623155359340"}})]),a._v(" "),s("p",[a._v("测试： http://192.168.3.100:8000/user/list")]),a._v(" "),s("p",[a._v("在启动程序前加一个-javaagent 参数即可完成对程序的跟踪")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155408684.png",alt:"image-20220623155408684"}})]),a._v(" "),s("h4",{attrs:{id:"_2-1-2-在idea中使用skywalking"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-2-在idea中使用skywalking"}},[a._v("#")]),a._v(" 2.1.2 在IDEA中使用Skywalking")]),a._v(" "),s("p",[a._v("在运行的程序配置jvm参数，如下图所示：")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155415961.png",alt:"image-20220623155415961"}})]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("# skywalking-agent.jar的本地磁盘的路径\n-javaagent:D:\\apache\\apache-skywalking-apm-es7-8.4.0\\apache-skywalking-apm-bin-es7\\agent\\skywalking-agent.jar\n# 在skywalking上显示的服务名\n-DSW_AGENT_NAME=springboot-skywalking-demo\n# skywalking的collector服务的IP及端口\n-DSW_AGENT_COLLECTOR_BACKEND_SERVICES=192.168.3.100:11800\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("h4",{attrs:{id:"_2-1-3-skywalking跨多个微服务跟踪"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-3-skywalking跨多个微服务跟踪"}},[a._v("#")]),a._v(" 2.1.3 Skywalking跨多个微服务跟踪")]),a._v(" "),s("p",[a._v("Skywalking跨多个微服务跟踪，只需要每个微服务启动时添加javaagent参数即可。")]),a._v(" "),s("p",[a._v("测试：")]),a._v(" "),s("p",[a._v("启动微服务mall-gateway，mall-order，mall-user ，配置skywalking的jvm参数")]),a._v(" "),s("p",[a._v("http://localhost:8888/user/findOrderByUserId/1")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155440166.png",alt:"image-20220623155440166"}})]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155447372.png",alt:"image-20220623155447372"}})]),a._v(" "),s("p",[s("strong",[a._v("注意：此处存在bug，跟踪链路不显示gateway")])]),a._v(" "),s("p",[a._v("拷贝agent/optional-plugins目录下的gateway插件到agent/plugins目录")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155501438.png",alt:"image-20220623155501438"}})]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155511247.png",alt:"image-20220623155511247"}})]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155519560.png",alt:"image-20220623155519560"}})]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155527146.png",alt:"image-20220623155527146"}})]),a._v(" "),s("h3",{attrs:{id:"_2-2-skywalking告警通知"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-skywalking告警通知"}},[a._v("#")]),a._v(" 2.2 Skywalking告警通知")]),a._v(" "),s("p",[a._v("skywalking告警的核心由一组规则驱动，这些规则定义在config/alarm-settings.yml文件中，告警规则的定义分为三部分:")]),a._v(" "),s("p",[a._v("1、告警规则：它们定义了应该如何触发度量警报，应该考虑什么条件；")]),a._v(" "),s("p",[a._v("2、网络钩子(Webhook}：当警告触发时，哪些服务终端需要被通知；")]),a._v(" "),s("p",[a._v("3、gRPC钩子：远程gRPC方法的主机和端口，告警触发后调用；")]),a._v(" "),s("p",[a._v("为了方便，skywalking发行版中提供了默认的alarm-setting.yml文件，包括一些规则，每个规则有英文注释，可以根据注释得知每个规则的作用：")]),a._v(" "),s("ul",[s("li",[a._v("在最近10分钟的3分钟内服务平均响应时间超过1000ms")]),a._v(" "),s("li",[a._v("最近10分钟内，服务成功率在2分钟内低于80%")]),a._v(" "),s("li",[a._v("服务实例的响应时间在过去10分钟的2分钟内超过1000ms")]),a._v(" "),s("li",[a._v("数据库访问{name}的响应时间在过去10分钟的2分钟内超过1000ms")])]),a._v(" "),s("p",[a._v("只要我们的服务请求符合alarm-setting.yml文件中的某一条规则就会触发告警。")]),a._v(" "),s("p",[a._v("比如service_resp_time_rule规则：")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155544877.png",alt:"image-20220623155544877"}})]),a._v(" "),s("p",[a._v("该规则表示服务{name}的响应时间在最近10分钟的3分钟内超过1000ms；")]),a._v(" "),s("p",[a._v("测试：")]),a._v(" "),s("p",[a._v("编写接口，模拟慢查询")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('@RequestMapping("/info/{id}")\npublic User info(@PathVariable("id") Integer id){\n\n    try {\n        Thread.sleep(2000);\n    } catch (InterruptedException e) {\n        e.printStackTrace();\n    }\n\n    return userService.getById(id);\n}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("回调接口")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('@RequestMapping("/notify")\npublic String notify(@RequestBody Object obj){\n    //TODO 告警信息，给技术负责人发短信，钉钉消息，邮件，微信通知等\n    System.err.println(obj.toString());\n    return "notify successfully";\n}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("在config/alarm-settings.yml中配置回调接口，并重启skywalking服务")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155557458.png",alt:"image-20220623155557458"}})]),a._v(" "),s("p",[a._v("测试访问：http://localhost:8000/user/info/1，满足告警规则后，控制台输出告警信息")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155622557.png",alt:"image-20220623155622557"}})]),a._v(" "),s("p",[a._v("SkyWalking UI显示告警信息")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155655085.png",alt:"image-20220623155655085"}})]),a._v(" "),s("p",[a._v("参考： https://github.com/apache/skywalking/blob/master/docs/en/setup/backend/backend-alarm.md")]),a._v(" "),s("p",[a._v("对接钉钉：")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155706848.png",alt:"image-20220623155706848"}})]),a._v(" "),s("h4",{attrs:{id:"webhook回调通知"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#webhook回调通知"}},[a._v("#")]),a._v(" Webhook回调通知")]),a._v(" "),s("p",[a._v("SkyWalking告警Webhook回调要求接收方是一个Web容器（比如tomcat服务），告警的消息会通过HTTP请求进行发送, 请求方法为POST, Content-Type为application/json, JSON格式基于ListAlarmMessage>的集合对象数据, 集合中的每个AlarmMessage包含以下信息：")]),a._v(" "),s("p",[a._v("1、scopeId. 所有可用的Scope，参考：org.apache.skywalking.oap.server.core.source.DefaultScopeDefine；")]),a._v(" "),s("p",[a._v("2、name. 目标 Scope 的实体名称；")]),a._v(" "),s("p",[a._v("3、id0. Scope 实体的 ID；")]),a._v(" "),s("p",[a._v("4、id1. 未使用；")]),a._v(" "),s("p",[a._v("5、ruleName. 在 alarm-settings.yml 中配置的规则名；")]),a._v(" "),s("p",[a._v("6、alarmMessage. 报警消息内容；")]),a._v(" "),s("p",[a._v("7、startTime. 告警时间, 位于当前时间与 UTC 1970/1/1 之间；")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[{\n\tscopeId = 2,\n\tscope = SERVICE_INSTANCE,\n\tname = 98e1839 a6fdf48b0aedb0ecabb8ea5f7 @192 .168 .233 .1 of springboot - skywalking - demo,\n\tid0 = c3ByaW5nYm9vdC1za3l3YWxraW5nLWRlbW8 = .1 _OThlMTgzOWE2ZmRmNDhiMGFlZGIwZWNhYmI4ZWE1ZjdAMTkyLjE2OC4yMzMuMQ == ,\n\tid1 = ,\n\truleName = service_instance_resp_time_rule,\n\talarmMessage = Response time of service instance 98e1839 a6fdf48b0aedb0ecabb8ea5f7 @192 .168 .233 .1 of springboot - skywalking - demo is more than 1000 ms in 2 minutes of last 10 minutes,\n\tstartTime = 1613913565462\n}, {\n\tscopeId = 6,\n\tscope = ENDPOINT_RELATION,\n\tname = User in User to / user / info / {\n\t\tid\n\t} in springboot - skywalking - demo,\n\tid0 = VXNlcg == .0 _VXNlcg == ,\n\tid1 = c3ByaW5nYm9vdC1za3l3YWxraW5nLWRlbW8 = .1 _L3VzZXIvaW5mby97aWR9,\n\truleName = endpoint_relation_resp_time_rule,\n\talarmMessage = Response time of endpoint relation User in User to / user / info / {\n\t\tid\n\t} in springboot - skywalking - demo is more than 1000 ms in 2 minutes of last 10 minutes,\n\tstartTime = 1613913565462\n}]\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br"),s("span",{staticClass:"line-number"},[a._v("23")]),s("br")])]),s("h3",{attrs:{id:"_2-3-skywalking持久化跟踪数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-skywalking持久化跟踪数据"}},[a._v("#")]),a._v(" 2.3 Skywalking持久化跟踪数据")]),a._v(" "),s("h4",{attrs:{id:"_2-3-1-基于mysql持久化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-1-基于mysql持久化"}},[a._v("#")]),a._v(" 2.3.1 基于mysql持久化:")]),a._v(" "),s("p",[a._v("\\1. 修改config目录下的application.yml，使用mysql作为持久化存储的仓库")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155717594.png",alt:"image-20220623155717594"}})]),a._v(" "),s("p",[a._v("\\2. 修改mysql连接配置")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155725510.png",alt:"image-20220623155725510"}})]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('storage:\n  #选择使用mysql   默认使用h2，不会持久化，重启skyWalking之前的数据会丢失\n  selector: ${SW_STORAGE:mysql}\n  #使用mysql作为持久化存储的仓库\n  mysql:\n    properties:\n      #数据库连接地址\n      jdbcUrl: ${SW_JDBC_URL:"jdbc:mysql://1ocalhost:3306/swtest"}\n      #用户名\n      dataSource.user: ${SW_DATA_SOURCE_USER:root}\n      #密码\n      dataSource.password: ${SW_DATA_SOURCE_PASSWORD:root}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br")])]),s("p",[a._v("注意：需要添加mysql数据驱动包，因为在lib目录下是没有mysql数据驱动包的，所以修改完配置启动是会报错，启动失败的。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155734039.png",alt:"image-20220623155734039"}})]),a._v(" "),s("p",[a._v("\\3. 添加mysql数据驱动包到oap-libs目录下")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155742573.png",alt:"image-20220623155742573"}})]),a._v(" "),s("p",[a._v("\\4. 启动Skywalking")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155756176.png",alt:"image-20220623155756176"}})]),a._v(" "),s("p",[a._v("查看swtest数据库，可以看到生成了很多表。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155803175.png",alt:"image-20220623155803175"}})]),a._v(" "),s("p",[a._v("说明启动成功了，打开配置对应的地址"),s("a",{attrs:{href:"http://192.168.3.14:8080/",target:"_blank",rel:"noopener noreferrer"}},[a._v("http://192.168.3.100:8080/"),s("OutboundLink")],1),a._v("，可以看到skywalking的web界面。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155811591.png",alt:"image-20220623155811591"}})]),a._v(" "),s("p",[a._v("测试：重启skywalking，验证跟踪数据会不会丢失")]),a._v(" "),s("p",[s("strong",[a._v("2.3.2 基于elasticsearch持久化")])]),a._v(" "),s("p",[a._v("1.准备好elasticsearch环境")]),a._v(" "),s("p",[a._v("启动elasticsearch服务")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("su - es\ncd /usr/local/soft/elasticsearch-7.6.1/\nbin/elasticsearch -d\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155820087.png",alt:"image-20220623155820087"}})]),a._v(" "),s("p",[a._v("启动elasticsearch-head服务，访问http://192.168.3.100:9100")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("cd /usr/local/soft/elasticsearch-head/node_modules/grunt\nnohup bin/grunt server &\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155830871.png",alt:"image-20220623155830871"}})]),a._v(" "),s("p",[a._v("2.修改config/application.yml配置文件：")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155850420.png",alt:"image-20220623155850420"}})]),a._v(" "),s("p",[a._v("修改elasticsearch7的连接配置")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155910519.png",alt:"image-20220623155910519"}})]),a._v(" "),s("p",[a._v("\\3. 启动Skywalking服务")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155926995.png",alt:"image-20220623155926995"}})]),a._v(" "),s("p",[a._v("启动时会向elasticsearch中创建大量的index索引用于持久化数据，每天会产生一个新的索引文件。")]),a._v(" "),s("p",[a._v("测试：")]),a._v(" "),s("p",[a._v("启动应用程序，查看跟踪数据是否已经持久化到elasticsearch的索引中，然后重启skywalking，验证跟踪数据会不会丢失")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155935321.png",alt:"image-20220623155935321"}})]),a._v(" "),s("h3",{attrs:{id:"_2-4-自定义skywalking链路追踪"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-自定义skywalking链路追踪"}},[a._v("#")]),a._v(" 2.4 自定义SkyWalking链路追踪")]),a._v(" "),s("p",[a._v("如果我们希望对项目中的业务方法，实现链路追踪，方便我们排查问题，可以使用如下的代码")]),a._v(" "),s("p",[a._v("引入依赖")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\x3c!-- SkyWalking 工具类 --\x3e\n<dependency>\n    <groupId>org.apache.skywalking</groupId>\n    <artifactId>apm-toolkit-trace</artifactId>\n    <version>8.4.0</version>\n</dependency>\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("在业务方法中可以TraceContext获取到traceId")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('@RequestMapping("/list")\npublic List<User> list(){\n\n    //TraceContext可以绑定key-value\n    TraceContext.putCorrelation("name", "fox");\n    Optional<String> op = TraceContext.getCorrelation("name");\n    log.info("name = {} ", op.get());\n    //获取跟踪的traceId\n    String traceId = TraceContext.traceId();\n    log.info("traceId = {} ", traceId);\n\n    return userService.list();\n}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br")])]),s("p",[a._v("测试 http://localhost:8000/user/list")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155944539.png",alt:"image-20220623155944539"}})]),a._v(" "),s("p",[a._v("在Skywalking UI中查询tranceId")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623155955781.png",alt:"image-20220623155955781"}})]),a._v(" "),s("h4",{attrs:{id:"_2-4-1-trace将方法加入追踪链路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-1-trace将方法加入追踪链路"}},[a._v("#")]),a._v(" 2.4.1 @Trace将方法加入追踪链路")]),a._v(" "),s("p",[a._v("如果一个业务方法想在ui界面的跟踪链路上显示出来，只需要在业务方法上加上@Trace注解即可")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160003000.png",alt:"image-20220623160003000"}})]),a._v(" "),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("测试：")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160010458.png",alt:"image-20220623160010458"}})]),a._v(" "),s("h4",{attrs:{id:"_2-4-2-加入-tags或-tag"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-2-加入-tags或-tag"}},[a._v("#")]),a._v(" 2.4.2 加入@Tags或@Tag")]),a._v(" "),s("p",[a._v("我们还可以为追踪链路增加其他额外的信息，比如记录参数和返回信息。实现方式：在方法上增加@Tag或者@Tags。")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('@Trace\n@Tag(key = "list", value = "returnedObj")\npublic List<User> list(){\n    return userMapper.list();\n}\n\n@Trace\n@Tags({@Tag(key = "param", value = "arg[0]"),\n        @Tag(key = "user", value = "returnedObj")})\npublic User getById(Integer id){\n    return userMapper.getById(id);\n}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160018723.png",alt:"image-20220623160018723"}})]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160025112.png",alt:"image-20220623160025112"}})]),a._v(" "),s("p",[s("strong",[a._v("2.5 Skywalking集成日志框架")])]),a._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/apache/skywalking/blob/master/docs/en/setup/service-agent/java-agent/Application-toolkit-logback-1.x.md",target:"_blank",rel:"noopener noreferrer"}},[a._v("logback官方配置"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("a",{attrs:{href:"https://skywalking.apache.org/docs/main/v8.4.0/en/setup/service-agent/java-agent/application-toolkit-log4j-1.x/",target:"_blank",rel:"noopener noreferrer"}},[a._v("log4j官方配置"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("a",{attrs:{href:"https://skywalking.apache.org/docs/main/v8.4.0/en/setup/service-agent/java-agent/application-toolkit-log4j-2.x",target:"_blank",rel:"noopener noreferrer"}},[a._v("log4j2j官方配置"),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("引入依赖")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\x3c!-- apm-toolkit-logback-1.x --\x3e\n<dependency>\n    <groupId>org.apache.skywalking</groupId>\n    <artifactId>apm-toolkit-logback-1.x</artifactId>\n    <version>8.4.0</version>\n</dependency>\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br")])]),s("p",[a._v("添加logback-spring.xml文件，并配置 %tid 占位符")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160032365.png",alt:"image-20220623160032365"}})]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160048746.png",alt:"image-20220623160048746"}})]),a._v(" "),s("p",[a._v("测试")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160058779.png",alt:"image-20220623160058779"}})]),a._v(" "),s("h4",{attrs:{id:"skywalking通过grpc上报日志-需要v8-4-0"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#skywalking通过grpc上报日志-需要v8-4-0"}},[a._v("#")]),a._v(" Skywalking通过grpc上报日志 "),s("strong",[a._v("（需要v8.4.0）")])]),a._v(" "),s("p",[a._v("gRPC报告程序可以将收集到的日志转发到SkyWalking OAP服务器上")]),a._v(" "),s("p",[a._v("logback-spring.xml中添加")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('\x3c!-- v8.4.0提供 --\x3e\n <appender name="grpc-log" class="org.apache.skywalking.apm.toolkit.log.logback.v1.x.log.GRPCLogClientAppender"/>\n<root level="info">\n    <appender-ref ref="grpc-log" />\n</root>\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160112913.png",alt:"image-20220623160112913"}})]),a._v(" "),s("p",[a._v("打开agent/config/agent.config配置文件，添加如下配置信息：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("plugin.toolkit.log.grpc.reporter.server_host=${SW_GRPC_LOG_SERVER_HOST:192.168.3.100}\nplugin.toolkit.log.grpc.reporter.server_port=${SW_GRPC_LOG_SERVER_PORT:11800}\nplugin.toolkit.log.grpc.reporter.max_message_size=${SW_GRPC_LOG_MAX_MESSAGE_SIZE:10485760}\nplugin.toolkit.log.grpc.reporter.upstream_timeout=${SW_GRPC_LOG_GRPC_UPSTREAM_TIMEOUT:30}\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("以上配置是默认配置信息,agent与oap在本地的可以不配")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("配置名")]),a._v(" "),s("th",[a._v("解释")]),a._v(" "),s("th",[a._v("默认值")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("plugin.toolkit.log.transmit_formatted")]),a._v(" "),s("td",[a._v("是否以格式化或未格式化的格式传输记录的数据")]),a._v(" "),s("td",[a._v("true")])]),a._v(" "),s("tr",[s("td",[a._v("plugin.toolkit.log.grpc.reporter.server_host")]),a._v(" "),s("td",[a._v("指定要向其报告日志数据的grpc服务器的主机")]),a._v(" "),s("td",[a._v("127.0.0.1")])]),a._v(" "),s("tr",[s("td",[a._v("plugin.toolkit.log.grpc.reporter.server_port")]),a._v(" "),s("td",[a._v("指定要向其报告日志数据的grpc服务器的端口")]),a._v(" "),s("td",[a._v("11800")])]),a._v(" "),s("tr",[s("td",[a._v("plugin.toolkit.log.grpc.reporter.max_message_size")]),a._v(" "),s("td",[a._v("指定grpc客户端要报告的日志数据的最大大小")]),a._v(" "),s("td",[a._v("10485760")])]),a._v(" "),s("tr",[s("td",[a._v("plugin.toolkit.log.grpc.reporter.upstream_timeout")]),a._v(" "),s("td",[a._v("客户端向上游发送数据时将超时多长时间。单位是秒")]),a._v(" "),s("td",[a._v("30")])])])]),a._v(" "),s("p",[s("a",{attrs:{href:"https://skywalking.apache.org/docs/main/v8.4.0/en/setup/service-agent/java-agent/readme/#table-of-agent-configuration-properties",target:"_blank",rel:"noopener noreferrer"}},[a._v("agent配置信息大全"),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("Skywalking UI效果")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160137019.png",alt:"image-20220623160137019"}})]),a._v(" "),s("p",[a._v("此处日期格式存在问题")]),a._v(" "),s("p",[a._v("https://github.com/apache/skywalking-rocketbot-ui/pull/428")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160145213.png",alt:"image-20220623160145213"}})]),a._v(" "),s("p",[s("strong",[a._v("2.6 Skywalking集群部署")])]),a._v(" "),s("p",[a._v("Skywalking集群是将skywalking oap作为一个服务注册到nacos上，只要skywalking oap服务没有全部宕机，保证有一个skywalking oap在运行，就能进行跟踪。")]),a._v(" "),s("p",[a._v("搭建一个skywalking oap集群需要：")]),a._v(" "),s("p",[a._v("（1）至少一个Nacos（也可以是nacos集群）")]),a._v(" "),s("p",[a._v("（2）至少一个ElasticSearch（也可以是es集群）")]),a._v(" "),s("p",[a._v("（3）至少2个skywalking oap服务；")]),a._v(" "),s("p",[a._v("（4）至少1个UI（UI也可以集群多个，用Nginx代理统一入口）")]),a._v(" "),s("p",[a._v("1.修改config/application.yml文件")]),a._v(" "),s("p",[a._v("使用nacos作为注册中心")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160153467.png",alt:"image-20220623160153467"}})]),a._v(" "),s("p",[a._v("修改nacos配置")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160203263.png",alt:"image-20220623160203263"}})]),a._v(" "),s("p",[a._v("可以选择性修改监听端口")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160211723.png",alt:"image-20220623160211723"}})]),a._v(" "),s("p",[a._v("修改存储策略，使用elasticsearch7作为storage")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160223328.png",alt:"image-20220623160223328"}})]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160231245.png",alt:"image-20220623160231245"}})]),a._v(" "),s("p",[a._v("\\2. 配置ui服务webapp.yml文件的listOfServers，写两个地址")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623160239833.png",alt:"image-20220623160239833"}})]),a._v(" "),s("p",[a._v("3.启动服务测试")]),a._v(" "),s("p",[a._v("启动Skywalking服务，指定springboot应用的jvm参数")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("-DSW_AGENT_COLLECTOR_BACKEND_SERVICES=192.168.3.10:11800,192.168.3.12:11800\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h2",{attrs:{id:"图片附录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#图片附录"}},[a._v("#")]),a._v(" 图片附录")]),a._v(" "),s("h3",{attrs:{id:"skywalking启动流程源码分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#skywalking启动流程源码分析"}},[a._v("#")]),a._v(" Skywalking启动流程源码分析")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/Skywalking%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.jpg",alt:"Skywalking启动流程源码分析"}})])])}),[],!1,null,null,null);s.default=e.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{420:function(s,e,a){"use strict";a.r(e);var t=a(5),n=Object(t.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("在了解Zookeeper之前，需要对分布式相关知识有一定了解，什么是分布式系统呢？通常情况下，单个物理节点很容易达到性能，计算或者容量的瓶颈，所以这个时候就需要多个物理节点来共同完成某项任务，一个分布式系统的本质是分布在不同网络或计算机上的程序组件，彼此通过信息传递来协同工作的系统，而Zookeeper正是一个分布式应用协调框架，在分布式系统架构中有广泛的应用场景。")]),s._v(" "),e("h2",{attrs:{id:"什么是zookeeper"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#什么是zookeeper"}},[s._v("#")]),s._v(" 什么是Zookeeper？")]),s._v(" "),e("p",[s._v("官方文档上这么解释zookeeper，它是一个分布式协调框架，是Apache Hadoop 的一个子项目，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项的管理等。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/1.png",alt:""}})]),s._v(" "),e("h2",{attrs:{id:"zookeeper-核心概念"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zookeeper-核心概念"}},[s._v("#")]),s._v(" Zookeeper 核心概念")]),s._v(" "),e("p",[s._v("暂时可以理解为 Zookeeper 是一个用于存储少量数据的基于内存的数据库，主要有如下两个核心的概念："),e("strong",[s._v("文件系统数据结构+监听通知机制")]),s._v("。")]),s._v(" "),e("h3",{attrs:{id:"文件系统数据结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#文件系统数据结构"}},[s._v("#")]),s._v(" 文件系统数据结构")]),s._v(" "),e("p",[s._v("Zookeeper维护一个类似文件系统的数据结构：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/2.png",alt:""}})]),s._v(" "),e("p",[s._v("每个子目录项都被称作为 "),e("strong",[s._v("znode(目录节点)")]),s._v("，和文件系统类似，我们能够自由的增加、删除znode，在一个znode下增加、删除子znode。")]),s._v(" "),e("p",[s._v("有四种类型的znode：")]),s._v(" "),e("ol",[e("li",[s._v("PERSISTENT-持久化目录节点")])]),s._v(" "),e("p",[s._v("客户端与zookeeper断开连接后，该节点依旧存在，只要不手动删除该节点，他将永远存在")]),s._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[s._v("PERSISTENT_SEQUENTIAL-持久化顺序编号目录节点")])]),s._v(" "),e("p",[s._v("客户端与zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号")]),s._v(" "),e("ol",{attrs:{start:"3"}},[e("li",[s._v("EPHEMERAL-临时目录节点")])]),s._v(" "),e("p",[s._v("客户端与zookeeper断开连接后，该节点被删除。临时节点和sessionId绑定")]),s._v(" "),e("blockquote",[e("p",[s._v("临时节点下不能创建子节点")])]),s._v(" "),e("p",[s._v("临时目录节点原理图示")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/image-20210831142551438.png",alt:"image-20210831142551438"}})]),s._v(" "),e("ol",{attrs:{start:"4"}},[e("li",[s._v("EPHEMERAL_SEQUENTIAL-临时顺序编号目录节点")])]),s._v(" "),e("p",[s._v("客户端与zookeeper断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号")]),s._v(" "),e("ol",{attrs:{start:"5"}},[e("li",[s._v("Container 节点")])]),s._v(" "),e("p",[s._v("3.5.3 版本新增，如果Container节点下面没有子节点，则Container节点在未来会被Zookeeper自动清除,定时任务默认60s 检查一次")]),s._v(" "),e("ol",{attrs:{start:"6"}},[e("li",[s._v("TTL 节点")])]),s._v(" "),e("p",[s._v("默认禁用，只能通过系统配置 "),e("em",[s._v("zookeeper.extendedTypesEnabled=true")]),s._v(" 开启，不稳定")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/3.png",alt:""}})]),s._v(" "),e("h3",{attrs:{id:"监听通知机制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#监听通知机制"}},[s._v("#")]),s._v(" 监听通知机制")]),s._v(" "),e("p",[s._v("客户端注册监听它关心的任意节点，或者目录节点及递归子目录节点")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("如果注册的是对某个节点的监听，则当这个节点被删除，或者被修改时，对应的客户端将被通知")])]),s._v(" "),e("li",[e("p",[s._v("如果注册的是对某个目录的监听，则当这个目录有子节点被创建，或者有子节点被删除，对应的客户端将被通知")])]),s._v(" "),e("li",[e("p",[s._v("如果注册的是对某个目录的递归子节点进行监听，则当这个目录下面的任意子节点有目录结构的变化（有子节点被创建，或被删除）或者根节点有数据变化时，对应的客户端将被通知。")])])]),s._v(" "),e("p",[s._v("注意：所有的通知都是一次性的，及无论是对节点还是对目录进行的监听，一旦触发，对应的监听即被移除。递归子节点，监听是对所有子节点的，所以，每个子节点下面的事件同样只会被触发一次。")]),s._v(" "),e("h2",{attrs:{id:"zookeeper安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zookeeper安装"}},[s._v("#")]),s._v(" zookeeper安装")]),s._v(" "),e("p",[s._v("**Step1：**配置JAVA环境，检验环境：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" java -version     \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("Step2: 下载解压 zookeeper")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" wget https://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.5.8/apache-zookeeper-3.5.8-bin.tar.gz \n tar -zxvf apache-zookeeper-3.5.8-bin.tar.gz \n cd  apache-zookeeper-3.5.8-bin   \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[e("strong",[s._v("Step3: 重命名配置文件  zoo_sample.cfg")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" cp zoo_sample.cfg  zoo.cfg   \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("Step4: 启动zookeeper")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 可以通过 bin/zkServer.sh  来查看都支持哪些参数  bin/zkServer.sh start conf/zoo.cfg\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("Step5: 检测是否启动成功")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" echo stat | nc 192.168.109.200 // 前提是配置文件中中讲 stat 四字命令设置了了白名单  \n 如：4lw.commands.whitelist=stat     \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("strong",[s._v("Step6: 连接服务器")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("bin/zkCli.sh -server ip:port   \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"zookeeper命令-文件系统数据结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zookeeper命令-文件系统数据结构"}},[s._v("#")]),s._v(" zookeeper命令-文件系统数据结构")]),s._v(" "),e("h3",{attrs:{id:"help"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#help"}},[s._v("#")]),s._v(" help")]),s._v(" "),e("p",[s._v("help 查看zookeeper所支持的所有命令：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[zk: localhost:2181(CONNECTED) 80] help\nZooKeeper -server host:port cmd args\n\taddauth scheme auth\n\tclose \n\tconfig [-c] [-w] [-s]\n\tconnect host:port\n\tcreate [-s] [-e] [-c] [-t ttl] path [data] [acl]\n\tdelete [-v version] path\n\tdeleteall path\n\tdelquota [-n|-b] path\n\tget [-s] [-w] path\n\tgetAcl [-s] path\n\thistory \n\tlistquota path\n\tls [-s] [-w] [-R] path\n\tls2 path [watch]\n\tprintwatches on|off\n\tquit \n\treconfig [-s] [-v version] [[-file path] | [-members serverID=host:port1:port2;port3[,...]*]] | [-add serverId=host:port1:port2;port3[,...]]* [-remove serverId[,...]*]\n\tredo cmdno\n\tremovewatches path [-c|-d|-a] [-l]\n\trmr path\n\tset [-s] [-v version] path data\n\tsetAcl [-s] [-v version] [-R] path acl\n\tsetquota -n|-b val path\n\tstat [-w] path\n\tsync path\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br")])]),e("h3",{attrs:{id:"创建节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建节点"}},[s._v("#")]),s._v(" 创建节点")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" create [-s] [-e] [-c] [-t ttl] path [data] [acl] \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("中括号为可选项，没有则默认创建持久化节点")]),s._v(" "),e("blockquote",[e("p",[s._v("-s: 顺序节点\n-e: 临时节点\n-c: 容器节点\n-t:  可以给节点添加过期时间，默认禁用，需要通过系统参数启用")])]),s._v(" "),e("p",[s._v("（-D"),e("em",[s._v("zookeeper.extendedTypesEnabled=true")]),s._v(",  "),e("em",[s._v("znode.container.checkIntervalMs")]),s._v(" : (Java system property only) "),e("strong",[s._v("New in 3.5.1:")]),s._v(' The time interval in milliseconds for each check of candidate container and ttl nodes. Default is "60000".)')]),s._v(" "),e("p",[s._v("创建节点：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("create /test-node some-data   \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("如上，没有加任何可选参数，创建的就是持久化节点")]),s._v(" "),e("h3",{attrs:{id:"创建临时节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建临时节点"}},[s._v("#")]),s._v(" 创建临时节点")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("create -e /ephemeral data \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("create 后跟一个 -e 创建临时节点 ， 临时节点不能创建子节点\n"),e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/15.png",alt:""}})]),s._v(" "),e("h3",{attrs:{id:"创建序号节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建序号节点"}},[s._v("#")]),s._v(" 创建序号节点")]),s._v(" "),e("p",[s._v("加参数 -s")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("create /seq-parent  data // 创建父目录，单纯为了分类，非必须\ncreate -s /seq-parent/  data // 创建顺序节点。顺序节点将再seq-parent 目录下面，顺序递增\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("为了容纳子节点，先创建个父目录 /seq-parent\n"),e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/16.png",alt:""}}),s._v("\n也可以再序号节点前面带一个前缀\t\n"),e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/17.png",alt:""}})]),s._v(" "),e("h3",{attrs:{id:"创建临时顺序节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建临时顺序节点"}},[s._v("#")]),s._v(" 创建临时顺序节点")]),s._v(" "),e("p",[s._v("创建临时顺序节点,其它增删查改和其他节点无异，不再贴图")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("create -s -e  /ephemeral-node/前缀-\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"创建容器节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建容器节点"}},[s._v("#")]),s._v(" 创建容器节点")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("create -c /container   \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("容器节点主要用来容纳字节点，如果没有给其创建子节点，容器节点表现和持久化节点一样，如果给容器节点创建了子节点，后续又把子节点清空，容器节点也会被zookeeper删除。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/4.png",alt:""}})]),s._v(" "),e("h3",{attrs:{id:"查看节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#查看节点"}},[s._v("#")]),s._v(" 查看节点")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("get /test-node   \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/5.png",alt:""}})]),s._v(" "),e("h3",{attrs:{id:"修改节点数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改节点数据"}},[s._v("#")]),s._v(" 修改节点数据")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("set /test-node some-data-changed   \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/6.png",alt:""}})]),s._v(" "),e("h3",{attrs:{id:"查看节点状态信息"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#查看节点状态信息"}},[s._v("#")]),s._v(" 查看节点状态信息")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("stat /test-node   \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/7.png",alt:""}})]),s._v(" "),e("blockquote",[e("p",[s._v("cZxid：创建znode的事务ID（Zxid的值）。\nmZxid：最后修改znode的事务ID。\npZxid：最后添加或删除子节点的事务ID（子节点列表发生变化才会发生改变）。\nctime：znode创建时间。\nmtime：znode最近修改时间。\ndataVersion：znode的当前数据版本。\ncversion：znode的子节点结果集版本（一个节点的子节点增加、删除都会影响这个版本）。\naclVersion：表示对此znode的acl版本。\nephemeralOwner：znode是临时znode时，表示znode所有者的 session ID。 如果znode不是临时znode，则该字段设置为零。\ndataLength：znode数据字段的长度。\nnumChildren：znode的子znode的数量。")])]),s._v(" "),e("h3",{attrs:{id:"查看节点状态信息同时查看数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#查看节点状态信息同时查看数据"}},[s._v("#")]),s._v(" 查看节点状态信息同时查看数据")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/8.png",alt:""}}),s._v("\n根据状态数据中的版本号有并发修改数据实现乐观锁的功能")]),s._v(" "),e("p",[s._v("比如： 客户端首先获取版本信息， get -s /node-test\n"),e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/9.png",alt:""}}),s._v("\n/test-node 当前的数据版本是 1 ， 这时客户端 用 set 命令修改数据的时候可以把版本号带上\n"),e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/10.png",alt:""}}),s._v("\n如果在执行上面 set命令前， 有人修改了数据，zookeeper 会递增版本号， 这个时候，如果再用以前的版本号去修改，将会导致修改失败，报如下错误\n"),e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/11.png",alt:""}}),s._v("\n创建子节点， 这里要注意，zookeeper是以节点组织数据的，没有相对路径这么一说，所以，所有的节点一定是以 / 开头。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("create /test-node/test-sub-node   \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/12.png",alt:""}})]),s._v(" "),e("h3",{attrs:{id:"查看子节点信息"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#查看子节点信息"}},[s._v("#")]),s._v(" 查看子节点信息")]),s._v(" "),e("p",[s._v("比如根节点下面的所有子节点， 加一个大写 R  可以查看递归子节点列表")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("ls /\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/13.png",alt:""}}),s._v("\n查看 /test-node 下面所有的子节点\n"),e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/14.png",alt:""}})]),s._v(" "),e("h2",{attrs:{id:"zookeeper命令-事件监听通知机制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zookeeper命令-事件监听通知机制"}},[s._v("#")]),s._v(" zookeeper命令-事件监听通知机制")]),s._v(" "),e("h3",{attrs:{id:"zookeeper事件类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zookeeper事件类型"}},[s._v("#")]),s._v(" Zookeeper事件类型")]),s._v(" "),e("ul",[e("li",[s._v("None: 连接建立事件")]),s._v(" "),e("li",[s._v("NodeCreated： 节点创建")]),s._v(" "),e("li",[s._v("NodeDeleted： 节点删除")]),s._v(" "),e("li",[s._v("NodeDataChanged：节点数据变化")]),s._v(" "),e("li",[s._v("NodeChildrenChanged：子节点列表变化")]),s._v(" "),e("li",[s._v("DataWatchRemoved：节点监听被移除")]),s._v(" "),e("li",[s._v("ChildWatchRemoved：子节点监听被移除")])]),s._v(" "),e("h3",{attrs:{id:"针对节点的监听"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#针对节点的监听"}},[s._v("#")]),s._v(" 针对节点的监听")]),s._v(" "),e("p",[s._v("针对节点的监听：一定事件触发，对应的注册立刻被移除，所以事件监听是一次性的")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("get  -w  /path   // 注册监听的同时获取数据 stat -w /path   // 对节点进行监听，且获取元数据信息\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/18.png",alt:""}})]),s._v(" "),e("h3",{attrs:{id:"针对目录的监听"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#针对目录的监听"}},[s._v("#")]),s._v(" 针对目录的监听")]),s._v(" "),e("p",[s._v("针对目录的监听，如下图，目录的变化，会触发事件，且一旦触发，对应的监听也会被移除，后续对节点的创建没有触发监听事件")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" ls -w /path   \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/19.png",alt:""}})]),s._v(" "),e("h3",{attrs:{id:"针对递归子目录的监听"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#针对递归子目录的监听"}},[s._v("#")]),s._v(" 针对递归子目录的监听")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("   ls -R -w /path ： -R 区分大小写，一定用大写\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("如下对/test 节点进行递归监听，但是每个目录下的目录监听也是一次性的，如第一次在/test 目录下创建节点时，触发监听事件，第二次则没有，同样，因为时递归的目录监听，所以在/test/sub0下进行节点创建时，触发事件，但是再次创建/test/sub0/subsub1节点时，没有触发事件。\n"),e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/20.png",alt:""}})]),s._v(" "),e("h2",{attrs:{id:"zookeeper-的-acl-权限控制-access-control-list"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zookeeper-的-acl-权限控制-access-control-list"}},[s._v("#")]),s._v(" Zookeeper 的 ACL 权限控制( Access Control   List )")]),s._v(" "),e("p",[s._v("Zookeeper 的ACL 权限控制,可以控制节点的读写操作,保证数据的安全性，Zookeeper ACL 权限设置分为 3 部分组成，分别是："),e("strong",[s._v("权限模式")]),s._v("（Scheme）、"),e("strong",[s._v("授权对象")]),s._v("（ID）、"),e("strong",[s._v("权限信息")]),s._v("（Permission）。最终组成一条例如“scheme:id : permission”格式的 ACL 请求信息。下面我们具体看一下这 3 部分代表什么意思：")]),s._v(" "),e("p",[e("strong",[s._v("Scheme（权限模式）")]),s._v("：用来设置 ZooKeeper 服务器进行权限验证的方式。ZooKeeper 的权限验证方式大体分为两种类型：")]),s._v(" "),e("p",[s._v("一种是"),e("strong",[s._v("范围验证")]),s._v("。所谓的范围验证就是说 ZooKeeper 可以针对一个 IP 或者一段 IP 地址授予某种权限。比如我们可以让一个 IP 地址为“ip：192.168.0.110”的机器对服务器上的某个数据节点具有写入的权限。或者也可以通过“ip:192.168.0.1/24”给一段 IP 地址的机器赋权。")]),s._v(" "),e("p",[s._v("另一种权限模式就是"),e("strong",[s._v("口令验证")]),s._v("，也可以理解为用户名密码的方式。在 ZooKeeper 中这种验证方式是 Digest 认证，而 Digest 这种认证方式首先在客户端传送“username:password”这种形式的权限表示符后，ZooKeeper 服务端会对密码 部分使用 SHA-1 和 BASE64 算法进行加密，以保证安全性。")]),s._v(" "),e("p",[s._v("还有一种Super权限模式,  Super可以认为是一种特殊的 Digest 认证。具有 Super 权限的客户端可以对 ZooKeeper 上的任意数据节点进行任意操作。")]),s._v(" "),e("p",[e("strong",[s._v("授权对象（ID）")])]),s._v(" "),e("p",[s._v("授权对象就是说我们要把权限赋予谁，而对应于 4 种不同的权限模式来说，如果我们选择采用 IP 方式，使用的授权对象可以是一个 IP 地址或 IP 地址段；而如果使用 Digest 或 Super 方式，则对应于一个用户名。如果是 World 模式，是授权系统中所有的用户。")]),s._v(" "),e("p",[e("strong",[s._v("权限信息（Permission）")])]),s._v(" "),e("p",[s._v("权限就是指我们可以在数据节点上执行的操作种类，如下所示：在 ZooKeeper 中已经定义好的权限有 5 种：")]),s._v(" "),e("p",[s._v("数据节点（c: create）创建权限，授予权限的对象可以在数据节点下创建子节点；\n数据节点（w: wirte）更新权限，授予权限的对象可以更新该数据节点；\n数据节点（r: read）读取权限，授予权限的对象可以读取该节点的内容以及子节点的列表信息；\n数据节点（d: delete）删除权限，授予权限的对象可以删除该数据节点的子节点；\n数据节点（a: admin）管理者权限，授予权限的对象可以对该数据节点体进行 ACL 权限设置。")]),s._v(" "),e("p",[e("strong",[s._v("命令")]),s._v("：")]),s._v(" "),e("p",[s._v("getAcl：获取某个节点的acl权限信息\nsetAcl：设置某个节点的acl权限信息\naddauth: 输入认证授权信息，相当于注册用户信息，注册时输入明文密码，zk将以密文的形式存储")]),s._v(" "),e("p",[s._v("可以通过系统参数zookeeper.skipACL=yes进行配置，默认是no,可以配置为true, 则配置过的ACL将不再进行权限检测")]),s._v(" "),e("p",[s._v("生成授权ID的两种方式:")]),s._v(" "),e("p",[s._v("a.代码生成ID:")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Test\npublic void generateSuperDigest() throws NoSuchAlgorithmException {\n String sId = DigestAuthenticationProvider.generateDigest("gj:test");\n    System.out.println(sId);//  gj:X/NSthOB0fD/OT6iilJ55WJVado=\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("b.在xshell 中生成")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("echo -n <user>:<password> | openssl dgst -binary -sha1 | openssl base64\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("设置ACL有两种方式")]),s._v(" "),e("p",[s._v("节点创建的同时设置ACL")]),s._v(" "),e("p",[s._v("create [-s] [-e] [-c]   path [data] ["),e("strong",[s._v("acl")]),s._v("]")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("create /zk-node datatest digest:gj:X/NSthOB0fD/OT6iilJ55WJVado=:cdrwa\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("或者用setAcl 设置")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("setAcl /zk-node  digest:gj:X/NSthOB0fD/OT6iilJ55WJVado=:cdrwa\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("添加授权信息后，不能直接访问，直接访问将报如下异常")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("get /zk-node\n异常信息:\norg.apache.zookeeper.KeeperException$NoAuthException: KeeperErrorCode = NoAuth for /zk-node  \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("访问前需要添加授权信息")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("addauth digest gj:test\nget /zk-node\ndatatest\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("另一种授权模式： auth 明文授权")]),s._v(" "),e("p",[s._v("使用之前需要先")]),s._v(" "),e("p",[s._v("addauth  digest username:password  注册用户信息，后续可以直接用明文授权")]),s._v(" "),e("p",[s._v("如：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("addauth digest u100:p100\ncreate /node-1 node1data auth:u100:p100:cdwra\n这是u100用户授权信息会被zk保存，可以认为当前的授权用户为u100\nget /node-1\nnode1data\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("IP授权模式：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("setAcl /node-ip ip:192.168.109.128:cdwra\ncreate /node-ip  data  ip:192.168.109.128:cdwra\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("多个指定IP可以通过逗号分隔， 如")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" setAcl /node-ip  ip:IP1:rw,ip:IP2:a\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("Super 超级管理员模式")]),s._v(" "),e("p",[s._v("这是一种特殊的Digest模式， 在Super模式下超级管理员用户可以对Zookeeper上的节点进行任何的操作。")]),s._v(" "),e("p",[s._v("需要在启动了上通过JVM 系统参数开启：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("DigestAuthenticationProvider中定义\n-Dzookeeper.DigestAuthenticationProvider.superDigest=super:<base64encoded(SHA1(password))\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("strong",[s._v("5. ZooKeeper 内存数据和持久化")])]),s._v(" "),e("p",[s._v("Zookeeper数据的组织形式为一个类似文件系统的数据结构，而这些数据都是存储在内存中的，所以我们可以认为，Zookeeper是一个基于内存的小型数据库")]),s._v(" "),e("p",[e("strong",[s._v("内存中的数据")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("public class DataTree {\n  private final ConcurrentHashMap<String, DataNode> nodes =\n        new ConcurrentHashMap<String, DataNode>();\n        \n        \n    private final WatchManager dataWatches = new WatchManager();\n    private final WatchManager childWatches = new WatchManager();\n  \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("DataNode 是Zookeeper存储节点数据的最小单位")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("public class DataNode implements Record {\n    byte data[];\n    Long acl;\n    public StatPersisted stat;\n    private Set<String> children = null;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[e("strong",[s._v("事务日志")])]),s._v(" "),e("p",[s._v("针对每一次客户端的事务操作，Zookeeper都会将他们记录到事务日志中，当然，Zookeeper也会将数据变更应用到内存数据库中。我们可以在zookeeper的主配置文件zoo.cfg 中配置内存中的数据持久化目录，也就是事务日志的存储路径 dataLogDir. 如果没有配置dataLogDir（非必填）, 事务日志将存储到dataDir （必填项）目录，")]),s._v(" "),e("p",[s._v("zookeeper提供了格式化工具可以进行数据查看事务日志数据")]),s._v(" "),e("p",[s._v("org.apache.zookeeper.server.LogFormatter")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("java -classpath .:slf4j-api-1.7.25.jar:zookeeper-3.5.8.jar:zookeeper-jute-3.5.8.jar org.apache.zookeeper.server.LogFormatter /usr/local/zookeeper/apache-zookeeper-3.5.8-bin/data/version-2/log.1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("如下是我本地的日志文件格式化效果")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/21.png",alt:""}})]),s._v(" "),e("p",[s._v("从左到右分别记录了操作时间，客户端会话ID，CXID,ZXID,操作类型，节点路径，节点数据（用#+ascii 码表示），节点版本。")]),s._v(" "),e("p",[s._v("Zookeeper进行事务日志文件操作的时候会频繁进行磁盘IO操作，事务日志的不断追加写操作会触发底层磁盘IO为文件开辟新的磁盘块，即磁盘Seek。因此，为了提升磁盘IO的效率，Zookeeper在创建事务日志文件的时候就进行文件空间的预分配- 即在创建文件的时候，就向操作系统申请一块大一点的磁盘块。这个预分配的磁盘大小可以通过系统参数 zookeeper.preAllocSize 进行配置。")]),s._v(" "),e("p",[s._v("事务日志文件名为： log.<当时最大事务ID>，应为日志文件时顺序写入的，所以这个最大事务ID也将是整个事务日志文件中，最小的事务ID，日志满了即进行下一次事务日志文件的创建")]),s._v(" "),e("p",[e("strong",[s._v("数据快照")])]),s._v(" "),e("p",[s._v("数据快照用于记录Zookeeper服务器上某一时刻的全量数据，并将其写入到指定的磁盘文件中。")]),s._v(" "),e("p",[s._v("可以通过配置snapCount配置每间隔事务请求个数，生成快照，数据存储在dataDir 指定的目录中，")]),s._v(" "),e("p",[s._v("可以通过如下方式进行查看快照数据（ 为了避免集群中所有机器在同一时间进行快照，实际的快照生成时机为事务数达到 [snapCount/2   + 随机数(随机数范围为1 ~ snapCount/2 )] 个数时开始快照）")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("java -classpath .:slf4j-api-1.7.25.jar:zookeeper-3.5.8.jar:zookeeper-jute-3.5.8.jar org.apache.zookeeper.server.SnapshotFormatter /usr/local/zookeeper/apache-zookeeper-3.5.8-bin/data-dir/version-2/snapshot.0\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/30.png",alt:""}})]),s._v(" "),e("p",[s._v("快照事务日志文件名为： snapshot.<当时最大事务ID>，日志满了即进行下一次事务日志文件的创建")]),s._v(" "),e("p",[s._v("有了事务日志，为啥还要快照数据。")]),s._v(" "),e("p",[s._v("快照数据主要时为了快速恢复，事务日志文件是每次事务请求都会进行追加的操作，而快照是达到某种设定条件下的内存全量数据。所以通常快照数据是反应当时内存数据的状态。事务日志是更全面的数据，所以恢复数据的时候，可以先恢复快照数据，再通过增量恢复事务日志中的数据即可。")]),s._v(" "),e("h2",{attrs:{id:"zkui-zookeeper图像化界面工具"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zkui-zookeeper图像化界面工具"}},[s._v("#")]),s._v(" zkui-zookeeper图像化界面工具")]),s._v(" "),e("p",[e("strong",[s._v("官方教程")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("https://github.com/DeemOpen/zkui\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("github上的开发者文档说明很nice，看官网教程基本上都能会的")]),s._v(" "),e("p",[e("strong",[s._v("clone project,打包成jar")])]),s._v(" "),e("p",[s._v("zkui本质上是一个java写的客户端web工具")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("1. git clone https://github.com/DeemOpen/zkui.git\n\n2. 编译zkui，生成jar\n\tcd zkui\n\tmvn clean install\t\n(生成两个jar包：\nzkui-2.0-SNAPSHOT.jar（用不到）和zkui-2.0-SNAPSHOT-jar-with-dependencies.jar，用的是第二个)\n\n3. 将第一步下载的zkui文件夹根目录下的config.cfg复制到，与zkui-2.0-SNAPSHOT-jar-with-dependencies.jar同级目录下\n\n修改配置文件config.cfg：\nscmRepo=192.168.3.10:2181,192.168.3.12:2181,192.168.3.13:2181\n# 若报KeeperErrorCode = ConnectionLoss for / 错误，增大zkSessionTimeout\nzkSessionTimeout=20\n\n4. 启动zkui\njava -jar target/zkui-2.0-SNAPSHOT-jar-with-dependencies.jar\n\n5. 浏览器上查看web界面\nhttp://127.0.0.1:9090 \n账号-admin\n密码-manager\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("blockquote",[e("p",[s._v("关于zkui端口等详细配置，都在config.cfg里面配置")])]),s._v(" "),e("h2",{attrs:{id:"zookeeper集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#zookeeper集群"}},[s._v("#")]),s._v(" zookeeper集群")]),s._v(" "),e("p",[e("img",{attrs:{src:"C:%5CUsers%5CNO%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210901153502552.png",alt:"image-20210901153502552"}})]),s._v(" "),e("p",[s._v("Leader：负责处理数据，读数据")]),s._v(" "),e("p",[s._v("Follower：负责读数据，如果Leader失败，Follower可以参与选举，有可能成为新的Leader")]),s._v(" "),e("p",[s._v("Observer：负责读数据，减轻服务端写数据压力")]),s._v(" "),e("p",[e("strong",[s._v("Zookeeper 集群模式")]),s._v("：")]),s._v(" "),e("p",[s._v("Zookeeper 集群模式一共有三种类型的角色")]),s._v(" "),e("p",[e("strong",[s._v("Leader")]),s._v(":   处理所有的事务请求（写请求），可以处理读请求，集群中只能有一个Leader")]),s._v(" "),e("p",[e("strong",[s._v("Follower")]),s._v("：只能处理读请求，同时作为 Leader的候选节点，即如果Leader宕机，Follower节点要参与到新的Leader选举中，有可能成为新的Leader节点。")]),s._v(" "),e("p",[e("strong",[s._v("Observer")]),s._v("：只能处理读请求。不能参与选举")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/31.png",alt:""}})]),s._v(" "),e("p",[e("strong",[s._v("Zookeeper集群模式安装")])]),s._v(" "),e("p",[s._v("本例搭建的是伪集群模式，即一台机器上启动四个zookeeper实例组成集群，真正的集群模式无非就是实例IP地址不同，搭建方法没有区别")]),s._v(" "),e("p",[s._v("**Step1：**配置JAVA环境，检验环境：保证是jdk7 及以上即可")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("java -version\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("**Step2：**下载并解压zookeeper")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("wget https://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.5.8/apache-zookeeper-3.5.8-bin.tar.gz\ntar -zxvf apache-zookeeper-3.5.8-bin.tar.gz\ncd  apache-zookeeper-3.5.8-bin\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("**Step3：**重命名 zoo_sample.cfg文件")]),s._v(" "),e("p",[s._v("​")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" cp conf/zoo_sample.cfg conf/zoo-1.cfg   \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("​")]),s._v(" "),e("p",[s._v("**Step4：**修改配置文件zoo-1.cfg，原配置文件里有的，修改成下面的值，没有的则加上")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# vim conf/zoo-1.cfg\ndataDir=/usr/local/data/zookeeper-1\nclientPort=2181\nserver.1=127.0.0.1:2001:3001:participant// participant 可以不用写，默认就是participant\nserver.2=127.0.0.1:2002:3002:participant\nserver.3=127.0.0.1:2003:3003:participant\nserver.4=127.0.0.1:2004:3004:observer\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("​")]),s._v(" "),e("p",[e("strong",[s._v("配置说明")])]),s._v(" "),e("ul",[e("li",[s._v("tickTime：用于配置Zookeeper中最小时间单位的长度，很多运行时的时间间隔都是使用tickTime的倍数来表示的。")]),s._v(" "),e("li",[s._v("initLimit：该参数用于配置Leader服务器等待Follower启动，并完成数据同步的时间。Follower服务器再启动过程中，会与Leader建立连接并完成数据的同步，从而确定自己对外提供服务的起始状态。Leader服务器允许Follower再initLimit 时间内完成这个工作。")]),s._v(" "),e("li",[s._v("syncLimit：Leader 与Follower心跳检测的最大延时时间")]),s._v(" "),e("li",[s._v("dataDir：顾名思义就是 Zookeeper 保存数据的目录，默认情况下，Zookeeper 将写数据的日志文件也保存在这个目录里。")]),s._v(" "),e("li",[s._v("clientPort：这个端口就是客户端连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求。")]),s._v(" "),e("li",[s._v("server.A=B：C：D：E 其中 A 是一个数字，表示这个是第几号服务器；B 是这个服务器的 ip 地址；C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信端口号不能一样，所以要给它们分配不同的端口号。如果需要通过添加不参与集群选举以及事务请求的过半机制的 Observer节点，可以在E的位置，添加observer标识。")])]),s._v(" "),e("p",[s._v("**Step4：**再从zoo-1.cfg复制三个配置文件zoo-2.cfg，zoo-3.cfg和zoo-4.cfg，只需修改dataDir和clientPort不同即可")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("cp conf/zoo1.cfg conf/zoo2.cfg\ncp conf/zoo1.cfg conf/zoo3.cfg\ncp conf/zoo1.cfg conf/zoo4.cfg\n\nvim conf/zoo2.cfg\ndataDir=/usr/local/data/zookeeper2\nclientPort=2182\nvim conf/zoo3.cfg\ndataDir=/usr/local/data/zookeeper3\nclientPort=2183\nvim conf/zoo4.cfg\ndataDir=/usr/local/data/zookeeper4\nclientPort=2184\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("​")]),s._v(" "),e("p",[s._v("**Step5：**标识Server ID")]),s._v(" "),e("p",[s._v("创建四个文件夹/usr/local/data/zookeeper-1，/usr/local/data/zookeeper-2，/usr/local/data/zookeeper-3，/usr/local/data/zookeeper-4，在每个目录中创建文件myid 文件，写入当前实例的server id，即1，2，3，4")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" cd /usr/local/data/zookeeper-1\n vim myid\n 1 \n cd /usr/local/data/zookeeper-2\n vim myid\n 2 \n cd /usr/local/data/zookeeper-3\n vim myid\n 3 \ncd /usr/local/data/zookeeper-4\nvim myid\n4\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("**Step6：**启动三个zookeeper实例")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("bin/zkServer.sh start conf/zoo1.cfg\nbin/zkServer.sh start conf/zoo2.cfg\nbin/zkServer.sh start conf/zoo3.cfg\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("​")]),s._v(" "),e("p",[s._v("**Step7：**检测集群状态，也可以直接用命令 zkServer.sh   status conf/zoo1.cfg  进行每台服务的状态查询")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/32.png",alt:""}})]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("bin/zkCli.sh -server ip1:port1,ip2:port2,ip3:port3 \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("可以通过 查看/zookeeper/config  节点数据来查看集群配置")]),s._v(" "),e("p",[e("strong",[s._v("Zookeeper 3.5.0 新特性： 集群动态配置")])]),s._v(" "),e("p",[s._v("Zookeeper 3.5.0 以前，Zookeeper集群角色要发生改变的话，只能通过停掉所有的Zookeeper服务，修改集群配置，重启服务来完成，这样集群服务将有一段不可用的状态，为了应对高可用需求，Zookeeper 3.5.0 提供了支持动态扩容/缩容的 新特性。但是通过客户端API可以变更服务端集群状态是件很危险的事情，所以在zookeeper "),e("strong",[s._v("3.5.3")]),s._v(" 版本要用动态配置，需要开启超级管理员身份验证模式 "),e("strong",[s._v("ACLs")]),s._v("。如果是在一个安全的环境也可以通过配置 系统参数 "),e("strong",[s._v("-Dzookeeper.skipACL=yes")]),s._v(" 来避免配置维护acl 权限配置。")]),s._v(" "),e("p",[e("strong",[s._v("第一步")]),s._v("，按照上节课的方式，先配置一个超级管理员（如果不配管理员，也可以设置系统参数 -Dzookeeper.skipACL=yes）：如：")]),s._v(" "),e("p",[s._v("在zookeeper启动脚本中添加 超级管理员授权模式：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("echo -n gj:123 | openssl dgst -binary -sha1 | openssl base64 \n// RRCKWv2U2e99M6UmsFaJiQ2xStw=\n\n-Dzookeeper.DigestAuthenticationProvider.superDigest=gj:RRCKWv2U2e99M6UmsFaJiQ2xStw=\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/35.png",alt:""}})]),s._v(" "),e("p",[e("strong",[s._v("配置动态文件")])]),s._v(" "),e("p",[s._v("修改配置 zoo1.cfg")]),s._v(" "),e("p",[s._v("注意这里去除了端口号，添加了")]),s._v(" "),e("p",[e("strong",[s._v("reconfigEnabled  :  设置为true 开启动态配置")])]),s._v(" "),e("p",[e("strong",[s._v("dynamicConfigFile   : 指定动态配置文件的路径")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/zookeeper/36.png",alt:""}})]),s._v(" "),e("p",[e("strong",[s._v("创建文件 zoo_replicated1.cfg.dynamic")])]),s._v(" "),e("p",[s._v("动态配置文件,加入集群信息")]),s._v(" "),e("p",[s._v("server.A=B.C.D.E;F")]),s._v(" "),e("p",[s._v("A: 服务的唯一标识")]),s._v(" "),e("p",[s._v("B: 服务对应的IP地址，")]),s._v(" "),e("p",[s._v("C: 集群通信端口")]),s._v(" "),e("p",[s._v("D: 集群选举端口")]),s._v(" "),e("p",[s._v("E: 角色， 默认是 participant,即参与过半机制的角色，选举，事务请求过半提交，还有一个是observer, 观察者，不参与选举以及过半机制。")]),s._v(" "),e("p",[s._v("之后是一个分号，一定是分号,")]),s._v(" "),e("p",[s._v("F:服务IP:端口")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server.1=192.168.109.200:2001:3001:participant;192.168.109.200:2181\nserver.2=192.168.109.200:2002:3002:participant;192.168.109.200:2182\nserver.3=192.168.109.200:2003:3003:participant;192.168.109.200:2183\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("依次配置其他服务 zoo2.cfg ,zoo3.cfg注意数据文件的路径")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("依次启动所有服务\n如： ./bin/zkServer.sh  start   conf/zoo1.cfg  \n查看集群状态:\n     ./bin/zkServer.sh  status  conf/zoo1.cfg    \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("连上任意一台服务器：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" 查看集群配置\n config  // 将会把动态配置打印出来\n 也可以直接查看目录\n /zookeeper/config \n 该节点存储了集群信息\n\n 如果要修改集群状态，需要授权登录\n addauth digest gj:123  \n\n reconfig -remove 3  // 移除serverId为 3 的机器\n // 把对应的机器加进来\n reconfig -add server.3=192.168.109.200:2003:3003:participant;192.168.109.200:2183\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("如果要变更/或者添加新的服务需要将服务加到配置文件 zoo_replicated1.cfg.dynamic 中，启动服务")]),s._v(" "),e("p",[s._v("然后通过reconfig 命令进行添加或者变更服务角色，但是需要保证服务列表中 participant 角色能够形成集群（过半机制）。")]),s._v(" "),e("p",[s._v("客户端可以通过监听 /zookeeper/confg 节点，来感知集群的变化。从而实现集群的动态变更.")]),s._v(" "),e("p",[s._v("Zookeeper 类提供了对应的API 用来更新服务列表 ： updateServerList")]),s._v(" "),e("p",[s._v("（完整的工程代码，在课程对应的资料包中）")]),s._v(" "),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Watcher")]),s._v(" watcher "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Watcher")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("process")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("WatchedEvent")]),s._v(" event"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                 "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("event"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("getType")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Event"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("EventType"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("None")]),s._v("\n                         "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" event"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("getState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Event"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("KeeperState"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SyncConnected")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                           countDownLatch"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("countDown")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                           log"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('" 连接建立"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                           "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// start to watch config")]),s._v("\n                     "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                         log"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('" 开始监听：{}"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ZooDefs")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CONFIG_NODE")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                         zookeeper"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("getConfig")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("KeeperException")]),s._v(" e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                         e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("printStackTrace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                         e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("printStackTrace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" event"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("getPath")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("  event"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("getPath")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("equals")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ZooDefs")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CONFIG_NODE")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                     "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                         "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("byte")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" config "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" zookeeper"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("getConfig")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                         "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" clientConfigStr "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ConfigUtils")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("getClientConfigStr")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("config"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                         log"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('" 配置发生变更: {}"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("clientConfigStr"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                         zookeeper"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("updateServerList")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("clientConfigStr"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("split")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('" "')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("KeeperException")]),s._v(" e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                         e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("printStackTrace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                         e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("printStackTrace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOException")]),s._v(" e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                         e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("printStackTrace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n                 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br")])]),e("p",[s._v("Curator 也自带了动态配置的监听，不需要额外的配置和代码实现监听更新；")])])}),[],!1,null,null,null);e.default=n.exports}}]);
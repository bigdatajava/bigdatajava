(window.webpackJsonp=window.webpackJsonp||[]).push([[241],{583:function(s,n,e){"use strict";e.r(n);var a=e(1),t=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("U2FsdGVkX1/IpIf1vvgzOGEtFebHzRY0BjFo7yMChDmORwDiyM1xuH3RQnXJJfJw\nH54vCKf5wOuAKgtKT4bxR+Jv6PrZaN9GL7ExfYJvzP+4abKI/A==\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[n("strong",[s._v("1. Sentinel****规则推送模式")])]),s._v(" "),n("p",[s._v("Sentinel规则的推送有下面三种模式:")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("推送模式")]),s._v(" "),n("th",[s._v("说明")]),s._v(" "),n("th",[s._v("优点")]),s._v(" "),n("th",[s._v("缺点")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("原始模式")]),s._v(" "),n("td",[s._v("API 将规则推送至客户端并直接更新到内存中，扩展写数据源（WritableDataSource）")]),s._v(" "),n("td",[s._v("简单，无任何依赖")]),s._v(" "),n("td",[s._v("不保证一致性；规则保存在内存中，重启即消失。严重不建议用于生产环境")])]),s._v(" "),n("tr",[n("td",[s._v("Pull 模式")]),s._v(" "),n("td",[s._v("扩展写数据源（WritableDataSource）， 客户端主动向某个规则管理中心定期轮询拉取规则，这个规则中心可以是 RDBMS、文件 等")]),s._v(" "),n("td",[s._v("简单，无任何依赖；规则持久化")]),s._v(" "),n("td",[s._v("不保证一致性；实时性不保证，拉取过于频繁也可能会有性能问题。")])]),s._v(" "),n("tr",[n("td",[s._v("Push 模式")]),s._v(" "),n("td",[s._v("扩展读数据源（ReadableDataSource），规则中心统一推送，客户端通过注册监听器的方式时刻监听变化，比如使用 Nacos、Zookeeper 等配置中心。这种方式有更好的实时性和一致性保证。生产环境下一般采用 push 模式的数据源。")]),s._v(" "),n("td",[s._v("规则持久化；一致性；快速")]),s._v(" "),n("td",[s._v("引入第三方依赖")])])])]),s._v(" "),n("p",[n("strong",[s._v("1.1 原始模式")])]),s._v(" "),n("p",[s._v("如果不做任何修改，Dashboard 的推送规则方式是通过 API 将规则推送至客户端并直接更新到内存中：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622094839149.png",alt:"image-20220622094839149"}})]),s._v(" "),n("p",[s._v("这种做法的好处是简单，无依赖；坏处是应用重启规则就会消失，仅用于简单测试，不能用于生产环境。")]),s._v(" "),n("p",[n("strong",[s._v("1.2 拉模式")])]),s._v(" "),n("p",[s._v("pull 模式的数据源（如本地文件、RDBMS 等）一般是可写入的。使用时需要在客户端注册数据源：将对应的读数据源注册至对应的 RuleManager，将写数据源注册至 transport 的 WritableDataSourceRegistry 中。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622095136938.png",alt:"image-20220622095136938"}})]),s._v(" "),n("p",[s._v("首先 Sentinel 控制台通过 API 将规则推送至客户端并更新到内存中，接着注册的写数据源会将新的规则保存到本地的文件中。使用 pull 模式的数据源时一般不需要对 Sentinel 控制台进行改造。这种实现方法好处是简单，坏处是无法保证监控数据的一致性。")]),s._v(" "),n("p",[s._v("官方demo:   sentinel-demo/sentinel-demo-dynamic-file-rule")]),s._v(" "),n("p",[s._v("引入依赖")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<dependency>\n    <groupId>com.alibaba.csp</groupId>\n    <artifactId>sentinel-datasource-extension</artifactId>\n    <version>1.8.0</version>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("核心代码：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// FileRefreshableDataSource 会周期性的读取文件以获取规则，当文件有更新时会及时发现，并将规则更新到内存中。 \nReadableDataSource<String, List<FlowRule>> ds = new FileRefreshableDataSource<>(\n            flowRulePath, source -> JSON.parseObject(source, new TypeReference<List<FlowRule>>() {})\n        );\n// 将可读数据源注册至 FlowRuleManager.\nFlowRuleManager.register2Property(ds.getProperty());\n\nWritableDataSource<List<FlowRule>> wds = new FileWritableDataSource<>(flowRulePath, this::encodeJson);\n// 将可写数据源注册至 transport 模块的 WritableDataSourceRegistry 中.\n// 这样收到控制台推送的规则时，Sentinel 会先更新到内存，然后将规则写入到文件中.\nWritableDataSourceRegistry.registerFlowDataSource(wds);\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[n("strong",[s._v("拉模式改造")])]),s._v(" "),n("p",[s._v("实现InitFunc接口，在init中处理DataSource初始化逻辑，并利用spi机制实现加载。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622105627761.png",alt:"image-20220622105627761"}})]),s._v(" "),n("p",[s._v("其中部分核心代码")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public class FileDataSourceInit implements InitFunc {\n\n    @Override\n    public void init() throws Exception {\n        //创建文件存储目录\n        RuleFileUtils.mkdirIfNotExits(PersistenceRuleConstant.storePath);\n\n        //创建规则文件\n        RuleFileUtils.createFileIfNotExits(PersistenceRuleConstant.rulesMap);\n\n        //处理流控规则逻辑\n        dealFlowRules();\n        // 处理降级规则\n        dealDegradeRules();\n        // 处理系统规则\n        dealSystemRules();\n        // 处理热点参数规则\n        dealParamFlowRules();\n        // 处理授权规则\n        dealAuthRules();\n    }\n\n\n    private void dealFlowRules() throws FileNotFoundException {\n        String ruleFilePath = PersistenceRuleConstant.rulesMap.get(PersistenceRuleConstant.FLOW_RULE_PATH).toString();\n\n        //创建流控规则的可读数据源\n        ReadableDataSource<String, List<FlowRule>> flowRuleRDS = new FileRefreshableDataSource(\n                ruleFilePath, RuleListConverterUtils.flowRuleListParser\n        );\n\n        // 将可读数据源注册至FlowRuleManager 这样当规则文件发生变化时，就会更新规则到内存\n        FlowRuleManager.register2Property(flowRuleRDS.getProperty());\n\n\n        WritableDataSource<List<FlowRule>> flowRuleWDS = new FileWritableDataSource<List<FlowRule>>(\n                ruleFilePath, RuleListConverterUtils.flowFuleEnCoding\n        );\n\n        // 将可写数据源注册至 transport 模块的 WritableDataSourceRegistry 中.\n        // 这样收到控制台推送的规则时，Sentinel 会先更新到内存，然后将规则写入到文件中.\n        WritableDataSourceRegistry.registerFlowDataSource(flowRuleWDS);\n    }\n\n    private void dealDegradeRules() throws FileNotFoundException {\n        //讲解规则文件路径\n        String degradeRuleFilePath = PersistenceRuleConstant.rulesMap.get(PersistenceRuleConstant.DEGRAGE_RULE_PATH).toString();\n\n        //创建流控规则的可读数据源\n        ReadableDataSource<String, List<DegradeRule>> degradeRuleRDS = new FileRefreshableDataSource(\n                degradeRuleFilePath, RuleListConverterUtils.degradeRuleListParse\n        );\n\n        // 将可读数据源注册至FlowRuleManager 这样当规则文件发生变化时，就会更新规则到内存\n        DegradeRuleManager.register2Property(degradeRuleRDS.getProperty());\n\n\n        WritableDataSource<List<DegradeRule>> degradeRuleWDS = new FileWritableDataSource<>(\n                degradeRuleFilePath, RuleListConverterUtils.degradeRuleEnCoding\n        );\n\n        // 将可写数据源注册至 transport 模块的 WritableDataSourceRegistry 中.\n        // 这样收到控制台推送的规则时，Sentinel 会先更新到内存，然后将规则写入到文件中.\n        WritableDataSourceRegistry.registerDegradeDataSource(degradeRuleWDS);\n    }\n\n    private void dealSystemRules() throws FileNotFoundException {\n        //讲解规则文件路径\n        String systemRuleFilePath = PersistenceRuleConstant.rulesMap.get(PersistenceRuleConstant.SYSTEM_RULE_PATH).toString();\n\n        //创建流控规则的可读数据源\n        ReadableDataSource<String, List<SystemRule>> systemRuleRDS = new FileRefreshableDataSource(\n                systemRuleFilePath, RuleListConverterUtils.sysRuleListParse\n        );\n\n        // 将可读数据源注册至FlowRuleManager 这样当规则文件发生变化时，就会更新规则到内存\n        SystemRuleManager.register2Property(systemRuleRDS.getProperty());\n\n\n        WritableDataSource<List<SystemRule>> systemRuleWDS = new FileWritableDataSource<>(\n                systemRuleFilePath, RuleListConverterUtils.sysRuleEnCoding\n        );\n\n        // 将可写数据源注册至 transport 模块的 WritableDataSourceRegistry 中.\n        // 这样收到控制台推送的规则时，Sentinel 会先更新到内存，然后将规则写入到文件中.\n        WritableDataSourceRegistry.registerSystemDataSource(systemRuleWDS);\n    }\n\n\n    private void dealParamFlowRules() throws FileNotFoundException {\n        //讲解规则文件路径\n        String paramFlowRuleFilePath = PersistenceRuleConstant.rulesMap.get(PersistenceRuleConstant.HOT_PARAM_RULE).toString();\n\n        //创建流控规则的可读数据源\n        ReadableDataSource<String, List<ParamFlowRule>> paramFlowRuleRDS = new FileRefreshableDataSource(\n                paramFlowRuleFilePath, RuleListConverterUtils.paramFlowRuleListParse\n        );\n\n        // 将可读数据源注册至FlowRuleManager 这样当规则文件发生变化时，就会更新规则到内存\n        ParamFlowRuleManager.register2Property(paramFlowRuleRDS.getProperty());\n\n\n        WritableDataSource<List<ParamFlowRule>> paramFlowRuleWDS = new FileWritableDataSource<>(\n                paramFlowRuleFilePath, RuleListConverterUtils.paramRuleEnCoding\n        );\n\n        // 将可写数据源注册至 transport 模块的 WritableDataSourceRegistry 中.\n        // 这样收到控制台推送的规则时，Sentinel 会先更新到内存，然后将规则写入到文件中.\n        ModifyParamFlowRulesCommandHandler.setWritableDataSource(paramFlowRuleWDS);\n    }\n\n    private void dealAuthRules() throws FileNotFoundException {\n        //讲解规则文件路径\n        String authFilePath = PersistenceRuleConstant.rulesMap.get(PersistenceRuleConstant.AUTH_RULE_PATH).toString();\n\n        //创建流控规则的可读数据源\n        ReadableDataSource<String, List<AuthorityRule>> authRuleRDS = new FileRefreshableDataSource(\n                authFilePath, RuleListConverterUtils.authorityRuleParse\n        );\n\n        // 将可读数据源注册至FlowRuleManager 这样当规则文件发生变化时，就会更新规则到内存\n        AuthorityRuleManager.register2Property(authRuleRDS.getProperty());\n\n\n        WritableDataSource<List<AuthorityRule>> authRuleWDS = new FileWritableDataSource<>(\n                authFilePath, RuleListConverterUtils.authorityEncoding\n        );\n\n        // 将可写数据源注册至 transport 模块的 WritableDataSourceRegistry 中.\n        // 这样收到控制台推送的规则时，Sentinel 会先更新到内存，然后将规则写入到文件中.\n        WritableDataSourceRegistry.registerAuthorityDataSource(authRuleWDS);\n    }\n\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br"),n("span",{staticClass:"line-number"},[s._v("106")]),n("br"),n("span",{staticClass:"line-number"},[s._v("107")]),n("br"),n("span",{staticClass:"line-number"},[s._v("108")]),n("br"),n("span",{staticClass:"line-number"},[s._v("109")]),n("br"),n("span",{staticClass:"line-number"},[s._v("110")]),n("br"),n("span",{staticClass:"line-number"},[s._v("111")]),n("br"),n("span",{staticClass:"line-number"},[s._v("112")]),n("br"),n("span",{staticClass:"line-number"},[s._v("113")]),n("br"),n("span",{staticClass:"line-number"},[s._v("114")]),n("br"),n("span",{staticClass:"line-number"},[s._v("115")]),n("br"),n("span",{staticClass:"line-number"},[s._v("116")]),n("br"),n("span",{staticClass:"line-number"},[s._v("117")]),n("br"),n("span",{staticClass:"line-number"},[s._v("118")]),n("br"),n("span",{staticClass:"line-number"},[s._v("119")]),n("br"),n("span",{staticClass:"line-number"},[s._v("120")]),n("br"),n("span",{staticClass:"line-number"},[s._v("121")]),n("br"),n("span",{staticClass:"line-number"},[s._v("122")]),n("br"),n("span",{staticClass:"line-number"},[s._v("123")]),n("br"),n("span",{staticClass:"line-number"},[s._v("124")]),n("br"),n("span",{staticClass:"line-number"},[s._v("125")]),n("br"),n("span",{staticClass:"line-number"},[s._v("126")]),n("br"),n("span",{staticClass:"line-number"},[s._v("127")]),n("br"),n("span",{staticClass:"line-number"},[s._v("128")]),n("br"),n("span",{staticClass:"line-number"},[s._v("129")]),n("br"),n("span",{staticClass:"line-number"},[s._v("130")]),n("br"),n("span",{staticClass:"line-number"},[s._v("131")]),n("br"),n("span",{staticClass:"line-number"},[s._v("132")]),n("br"),n("span",{staticClass:"line-number"},[s._v("133")]),n("br"),n("span",{staticClass:"line-number"},[s._v("134")]),n("br")])]),n("p",[n("strong",[s._v("1.3 推模式")])]),s._v(" "),n("p",[s._v("生产环境下一般更常用的是 push 模式的数据源。对于 push 模式的数据源,如远程配置中心（ZooKeeper, Nacos, Apollo等等），推送的操作不应由 Sentinel 客户端进行，而应该经控制台统一进行管理，直接进行推送，数据源仅负责获取配置中心推送的配置并更新到本地。因此推送规则正确做法应该是 "),n("strong",[s._v("配置中心控制台/Sentinel 控制台 → 配置中心 → Sentinel 数据源 → Sentinel")]),s._v("，而不是经 Sentinel 数据源推送至配置中心。这样的流程就非常清晰了：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622105715955.png",alt:"image-20220622105715955"}})]),s._v(" "),n("p",[s._v("​")]),s._v(" "),n("p",[n("strong",[s._v("1.3.1 基于Nacos配置中心控制台实现推送")])]),s._v(" "),n("p",[s._v("官方demo:  sentinel-demo-nacos-datasource")]),s._v(" "),n("p",[s._v("引入依赖")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<dependency>\n    <groupId>com.alibaba.csp</groupId>\n    <artifactId>sentinel-datasource-nacos</artifactId>\n    <version>1.8.0</version>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("核心代码")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('// nacos server ip\nprivate static final String remoteAddress = "localhost:8848";\n// nacos group\nprivate static final String groupId = "Sentinel:Demo";\n// nacos dataId\nprivate static final String dataId = "com.alibaba.csp.sentinel.demo.flow.rule";\nReadableDataSource<String, List<FlowRule>> flowRuleDataSource = new NacosDataSource<>(remoteAddress, groupId, dataId,source -> JSON.parseObject(source, new TypeReference<List<FlowRule>>() {}));\nFlowRuleManager.register2Property(flowRuleDataSource.getProperty());\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("nacos配置中心中配置流控规则")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[\n  {\n    "resource": "TestResource",\n    "controlBehavior": 0,\n    "count": 10.0,\n    "grade": 1,\n    "limitApp": "default",\n    "strategy": 0\n  }\n]\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622105804981.png",alt:"image-20220622105804981"}})]),s._v(" "),n("p",[n("strong",[s._v("微服务中通过yml配置实现")])]),s._v(" "),n("p",[s._v("SentinelProperties 内部提供了 TreeMap 类型的 datasource 属性用于配置数据源信息")]),s._v(" "),n("p",[s._v("1）引入依赖")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\x3c!--sentinel持久化 采用 Nacos 作为规则配置数据源--\x3e\n<dependency>\n    <groupId>com.alibaba.csp</groupId>\n    <artifactId>sentinel-datasource-nacos</artifactId>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("2）yml中配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n  application:\n    name: mall-user-sentinel-demo\n  cloud:\n    nacos:\n      discovery:\n        server-addr: 127.0.0.1:8848\n\n    sentinel:\n      transport:\n        # 添加sentinel的控制台地址\n        dashboard: 127.0.0.1:8080\n        # 指定应用与Sentinel控制台交互的端口，应用本地会起一个该端口占用的HttpServer\n        port: 8719\n      datasource:\n        ds1:\n          nacos:\n            server-addr: 127.0.0.1:8848\n            dataId: ${spring.application.name}\n            groupId: DEFAULT_GROUP\n            data-type: json\n            rule-type: flow\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[s._v("源码参考com.alibaba.cloud.sentinel.datasource.config.AbstractDataSourceProperties#postRegister")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622105910603.png",alt:"image-20220622105910603"}})]),s._v(" "),n("p",[s._v("3）nacos配置中心中添加")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[\n    {\n        "resource": "userinfo",\n        "limitApp": "default",\n        "grade": 1,\n        "count": 1,\n        "strategy": 0,\n        "controlBehavior": 0,\n        "clusterMode": false\n    }\n]\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622105956204.png",alt:"image-20220622105956204"}})]),s._v(" "),n("p",[s._v("缺点：直接在Sentinel Dashboard中修改规则配置，配置中心的配置不会发生变化")]),s._v(" "),n("p",[s._v("思考： 如何实现将通过sentinel控制台设置的规则直接持久化到nacos配置中心？")]),s._v(" "),n("p",[s._v("扩展改造的思路：")]),s._v(" "),n("p",[s._v("Sentinel Dashboard监听Nacos配置的变化，如发生变化就更新本地缓存。在Sentinel Dashboard端新增或修改规则配置在保存到内存的同时，直接发布配置到nacos配置中心；Sentinel Dashboard直接从nacos拉取所有的规则配置。")]),s._v(" "),n("p",[s._v("sentinel Dashboard和sentinel client 不直接通信，而是通过nacos配置中心获取到配置的变更。")]),s._v(" "),n("p",[n("strong",[s._v("1.3.2 基于Sentinel控制台实现推送")])]),s._v(" "),n("p",[s._v("从 Sentinel 1.4.0 开始，Sentinel 控制台提供 DynamicRulePublisher 和 DynamicRuleProvider 接口用于实现应用维度的规则推送和拉取：")]),s._v(" "),n("ul",[n("li",[s._v("DynamicRuleProvider: 拉取规则")]),s._v(" "),n("li",[s._v("DynamicRulePublisher: 推送规则")])]),s._v(" "),n("p",[n("strong",[s._v("Sentinel Dashboard改造")])]),s._v(" "),n("p",[s._v("第1步：在com.alibaba.csp.sentinel.dashboard.rule包下创建nacos包，然后把各种场景的配置规则拉取和推送的实现类写到此包下")]),s._v(" "),n("p",[s._v("可以参考Sentinel Dashboard test包下的流控规则拉取和推送的实现逻辑：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622112059170.png",alt:"image-20220622112059170"}})]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622112108664.png",alt:"image-20220622112108664"}})]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622112141481.png",alt:"image-20220622112141481"}})]),s._v(" "),n("p",[s._v("注意：微服务接入Sentinel client，yml配置需要匹配对应的规则后缀")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622112229792.png",alt:"image-20220622112229792"}})]),s._v(" "),n("p",[s._v("第2步：进入com.alibaba.csp.sentinel.dashboard.controller包下修改对应的规则controller实现类")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622112248621.png",alt:"image-20220622112248621"}})]),s._v(" "),n("p",[s._v("以流控规则为例，从Nacos配置中心获取所有的流控规则")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@GetMapping("/rules")\n    @AuthAction(PrivilegeType.READ_RULE)\n    public Result<List<FlowRuleEntity>> apiQueryMachineRules(@RequestParam String app,\n                                                             @RequestParam String ip,\n                                                             @RequestParam Integer port) {\n\n        if (StringUtil.isEmpty(app)) {\n            return Result.ofFail(-1, "app can\'t be null or empty");\n        }\n        if (StringUtil.isEmpty(ip)) {\n            return Result.ofFail(-1, "ip can\'t be null or empty");\n        }\n        if (port == null) {\n            return Result.ofFail(-1, "port can\'t be null");\n        }\n        try {\n           // List<FlowRuleEntity> rules = sentinelApiClient.fetchFlowRuleOfMachine(app, ip, port);\n            //从配置中心获取规则配置\n            List<FlowRuleEntity> rules = ruleProvider.getRules(app, ip, port);\n            rules = repository.saveAll(rules);\n            return Result.ofSuccess(rules);\n        } catch (Throwable throwable) {\n            logger.error("Error when querying flow rules", throwable);\n            return Result.ofThrowable(-1, throwable);\n        }\n    }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("p",[s._v("新增流控规则，会推送到nacos配置中心")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@PostMapping("/rule")\n    @AuthAction(PrivilegeType.WRITE_RULE)\n    public Result<FlowRuleEntity> apiAddFlowRule(@RequestBody FlowRuleEntity entity) {\n        Result<FlowRuleEntity> checkResult = checkEntityInternal(entity);\n        if (checkResult != null) {\n            return checkResult;\n        }\n        entity.setId(null);\n        Date date = new Date();\n        entity.setGmtCreate(date);\n        entity.setGmtModified(date);\n        entity.setLimitApp(entity.getLimitApp().trim());\n        entity.setResource(entity.getResource().trim());\n        try {\n            entity = repository.save(entity);\n\n            //publishRules(entity.getApp(), entity.getIp(), entity.getPort()).get(5000, TimeUnit.MILLISECONDS);\n            //发布规则到配置中心\n            publishRules(entity.getApp());\n            return Result.ofSuccess(entity);\n        } catch (Throwable t) {\n            Throwable e = t instanceof ExecutionException ? t.getCause() : t;\n            logger.error("Failed to add new flow rule, app={}, ip={}", entity.getApp(), entity.getIp(), e);\n            return Result.ofFail(-1, e.getMessage());\n        }\n    }\n\n/**\n     * 发布到配置中心\n     * @param app\n     * @throws Exception\n     */\n    private void publishRules(/*@NonNull*/ String app) throws Exception {\n        List<FlowRuleEntity> rules = repository.findAllByApp(app);\n        rulePublisher.publish(app, rules);\n    }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br")])]),n("p",[s._v("测试："),n("strong",[s._v("微服务接入改造后的Sentinel Dashboard")])]),s._v(" "),n("p",[s._v("引入依赖")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\x3c!--sentinel持久化 采用 Nacos 作为规则配置数据源--\x3e\n<dependency>\n    <groupId>com.alibaba.csp</groupId>\n    <artifactId>sentinel-datasource-nacos</artifactId>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("增加yml配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server:\n  port: 8806\n\nspring:\n  application:\n    name: mall-user-sentinel-rule-push-demo  #微服务名称\n\n  #配置nacos注册中心地址\n  cloud:\n    nacos:\n      discovery:\n        server-addr: 127.0.0.1:8848\n\n    sentinel:\n      transport:\n        # 添加sentinel的控制台地址\n        dashboard: 127.0.0.1:8080\n        # 指定应用与Sentinel控制台交互的端口，应用本地会起一个该端口占用的HttpServer\n        #port: 8719\n      datasource:\n#        ds1:   #名称自定义，唯一\n#          nacos:\n#            server-addr: 127.0.0.1:8848\n#            dataId: ${spring.application.name}\n#            groupId: DEFAULT_GROUP\n#            data-type: json\n#            rule-type: flow\n        flow-rules:\n          nacos:\n            server-addr: 127.0.0.1:8848\n            dataId: ${spring.application.name}-flow-rules\n            groupId: SENTINEL_GROUP   # 注意groupId对应Sentinel Dashboard中的定义\n            data-type: json\n            rule-type: flow\n        degrade-rules:\n          nacos:\n            server-addr: 127.0.0.1:8848\n            dataId: ${spring.application.name}-degrade-rules\n            groupId: SENTINEL_GROUP\n            data-type: json\n            rule-type: degrade\n        param-flow-rules:\n          nacos:\n            server-addr: 127.0.0.1:8848\n            dataId: ${spring.application.name}-param-flow-rules\n            groupId: SENTINEL_GROUP\n            data-type: json\n            rule-type: param-flow\n        authority-rules:\n          nacos:\n            server-addr: 127.0.0.1:8848\n            dataId: ${spring.application.name}-authority-rules\n            groupId: SENTINEL_GROUP\n            data-type: json\n            rule-type: authority\n        system-rules:\n          nacos:\n            server-addr: 127.0.0.1:8848\n            dataId: ${spring.application.name}-system-rules\n            groupId: SENTINEL_GROUP\n            data-type: json\n            rule-type: system\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("以流控规则测试，当在sentinel dashboard配置了流控规则，会在nacos配置中心生成对应的配置。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622112346455.png",alt:"image-20220622112346455"}})]),s._v(" "),n("p",[n("strong",[s._v("热点参数规则失效和解决思路")])]),s._v(" "),n("p",[s._v("注意：控制台改造后有可能出现规则不生效的情况，比如热点参数规则因为Converter解析json错误的原因会导致不生效。")]),s._v(" "),n("p",[s._v("参见源码：com.alibaba.csp.sentinel.datasource.AbstractDataSource#loadConfig(S) 会解析配置规则。")]),s._v(" "),n("p",[s._v("原因是：改造dashboard，提交到nacos配置中心的数据是ParamFlowRuleEntity类型，微服务拉取配置要解析的是ParamFlowRule类型，会导致规则解析丢失数据，造成热点规则不生效。 其他的规则原理也是一样，存在失效的风险。")]),s._v(" "),n("p",[s._v("nacos配置中心保存的数据格式：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('[{\n\t"app": "mall-user-sentinel-rule-push-demo",\n\t"gmtCreate": 1616136838785,\n\t"gmtModified": 1616136838785,\n\t"id": 1,\n\t"ip": "192.168.3.1",\n\t"port": 8719,\n\t"rule": {\n\t\t"burstCount": 0,\n\t\t"clusterConfig": {\n\t\t\t"fallbackToLocalWhenFail": true,\n\t\t\t"sampleCount": 10,\n\t\t\t"thresholdType": 0,\n\t\t\t"windowIntervalMs": 1000\n\t\t},\n\t\t"clusterMode": false,\n\t\t"controlBehavior": 0,\n\t\t"count": 1.0,\n\t\t"durationInSec": 1,\n\t\t"grade": 1,\n\t\t"limitApp": "default",\n\t\t"maxQueueingTimeMs": 0,\n\t\t"paramFlowItemList": [],\n\t\t"paramIdx": 1,\n\t\t"resource": "hot"\n\t}\n}, {\n\t"app": "mall-user-sentinel-rule-push-demo",\n\t"gmtCreate": 1616137178470,\n\t"gmtModified": 1616658923519,\n\t"id": 2,\n\t"ip": "192.168.3.1",\n\t"port": 8719,\n\t"rule": {\n\t\t"burstCount": 0,\n\t\t"clusterConfig": {\n\t\t\t"fallbackToLocalWhenFail": true,\n\t\t\t"sampleCount": 10,\n\t\t\t"thresholdType": 0,\n\t\t\t"windowIntervalMs": 1000\n\t\t},\n\t\t"clusterMode": false,\n\t\t"controlBehavior": 0,\n\t\t"count": 3.0,\n\t\t"durationInSec": 1,\n\t\t"grade": 1,\n\t\t"limitApp": "default",\n\t\t"maxQueueingTimeMs": 0,\n\t\t"paramFlowItemList": [{\n\t\t\t"classType": "int",\n\t\t\t"count": 1,\n\t\t\t"object": "4"\n\t\t}],\n\t\t"paramIdx": 0,\n\t\t"resource": "findOrderByUserId"\n\t}\n}]\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br")])]),n("p",[s._v("我提供两种解决思路：")]),s._v(" "),n("ol",[n("li",[s._v('自定义一个解析热点规则配置的解析器FlowParamJsonConverter，继承JsonConverter，重写convert方法。然后利用后置处理器替换beanName为"param-flow-rules-sentinel-nacos-datasource"的converter属性，注入FlowParamJsonConverter。')])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Configuration\npublic class ConverterConfig {\n\n    @Bean("sentinel-json-param-flow-converter2")\n    @Primary\n    public JsonConverter jsonParamFlowConverter() {\n        return new FlowParamJsonConverter(new ObjectMapper(), ParamFlowRule.class);\n    }\n}\n\n@Component\npublic class FlowParamConverterBeanPostProcessor implements BeanPostProcessor {\n\n    @Autowired\n    private JsonConverter jsonParamFlowConverter;\n\n    @Override\n    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {\n        if (beanName.equals("param-flow-rules-sentinel-nacos-datasource")) {\n            NacosDataSourceFactoryBean nacosDataSourceFactoryBean = (NacosDataSourceFactoryBean) bean;\n            nacosDataSourceFactoryBean.setConverter(jsonParamFlowConverter);\n            return bean;\n        }\n        return bean;\n    }\n}\n\npublic class FlowParamJsonConverter extends JsonConverter {\n    Class ruleClass;\n\n    public FlowParamJsonConverter(ObjectMapper objectMapper, Class ruleClass) {\n        super(objectMapper, ruleClass);\n        this.ruleClass = ruleClass;\n    }\n\n    @Override\n    public Collection<Object> convert(String source) {\n        List<Object> list = new ArrayList<>();\n        JSONArray jsonArray = JSON.parseArray(source);\n        for (int i = 0; i < jsonArray.size(); i++) {\n            //解析rule属性\n            JSONObject jsonObject = (JSONObject) jsonArray.getJSONObject(i).get("rule");\n            Object object = JSON.toJavaObject(jsonObject, ruleClass);\n            list.add(object);\n        }\n        return list;\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br")])]),n("p",[s._v("\\2. 改造Sentinel Dashboard控制台，发布配置时将ParamFlowRuleEntity转成ParamFlowRule类型，再发布到Nacos配置中心。从配置中心拉取配置后将ParamFlowRule转成ParamFlowRuleEntity。")]),s._v(" "),n("p",[s._v("从配置中心拉取配置到控制台时，FlowRule转换为FlowRuleEntity")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622112715410.png",alt:"image-20220622112715410"}})]),s._v(" "),n("p",[s._v("从控制台发布配置到配置中心时，FlowRuleEntity转换为FlowRule")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220622112744742.png",alt:"image-20220622112744742"}})]),s._v(" "),n("h2",{attrs:{id:"图片附录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#图片附录"}},[s._v("#")]),s._v(" 图片附录")]),s._v(" "),n("h3",{attrs:{id:"sentinel规则持久化部分源码分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#sentinel规则持久化部分源码分析"}},[s._v("#")]),s._v(" sentinel规则持久化部分源码分析")]),s._v(" "),n("p",[s._v("https://www.processon.com/view/link/607fef267d9c08283ddc2f8d")])])}),[],!1,null,null,null);n.default=t.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{394:function(s,a,e){"use strict";e.r(a);var n=e(1),t=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("MongoDB聚合框架是一个计算框架作用在一个或几个集合对集合中的数据进行一系列运算")]),s._v(" "),a("p",[s._v("将这些数据转化为期望的形式")]),s._v(" "),a("p",[s._v("如： 现在有一组数据")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.orders.insertMany(\n[\n{\n zip:"000001",\n phone:"13101010101",\n name:"LiuBei",\n status:"created",\n shippingFee:10,\n orderLines:[\n \t{product:"Huawei Meta30 Pro",sku:"2002",qty:100,price:6000,cost:5599},\n \t{product:"Huawei Meta40 Pro",sku:"2003",qty:10,price:7000,cost:6599},\n \t{product:"Huawei Meta40 5G",sku:"2004",qty:80,price:4000,cost:3700}\n ]\n},\n\n{\n zip:"000001",\n phone:"13101010101",\n name:"LiuBei",\n status:"created",\n shippingFee:10,\n orderLines:[\n \t{product:"Huawei Meta30 Pro",sku:"2002",qty:100,price:6000,cost:5599},\n \t{product:"Huawei Meta40 Pro",sku:"2003",qty:10,price:7000,cost:6599},\n \t{product:"Huawei Meta40 5G",sku:"2004",qty:80,price:4000,cost:3700}\n ]\n},\n\n{\n zip:"000001",\n phone:"13101010101",\n name:"LiuBei",\n status:"created",\n shippingFee:10,\n orderLines:[\n \t{product:"Huawei Meta30 Pro",sku:"2002",qty:100,price:6000,cost:5599},\n \t{product:"Huawei Meta40 Pro",sku:"2003",qty:10,price:7000,cost:6599},\n \t{product:"Huawei Meta40 5G",sku:"2004",qty:80,price:4000,cost:3700}\n ]\n}]\n);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br")])]),a("p",[s._v("原价总额，订单总额")]),s._v(" "),a("p",[s._v("添加两个字段，值为每个订单的原价总价和 订单总额")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.orders.aggregate([{$addFields: {\n  totalPrice:{  $sum: "$orderLines.price"},\n  totalCost: {  $sum: "$orderLines.cost"},\n}}]);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("​    "),a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/mongodb/20.png",alt:""}})]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('按 totalPrice 进行排序\n[{\n    $addFields: {\n        totalPrice: {\n            $sum: "$orderLines.price"\n        },\n        totalCost: {\n            $sum: "$orderLines.cost"\n        },\n    }\n}\n,   // stage 1 \n \n {\n    $sort: {\n        totalPrice: -1\n    }\n}     // stage 2 \n]   \n\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("第一个阶段：")]),s._v(" "),a("p",[s._v("针对整个集合添加两个字段：")]),s._v(" "),a("p",[s._v("totalPrice: 订单原价总额")]),s._v(" "),a("p",[s._v("totalCost：订单实际总额")]),s._v(" "),a("p",[s._v("并将结果传到第二个阶段")]),s._v(" "),a("p",[s._v("第二个阶段：")]),s._v(" "),a("p",[s._v("按订单总价进行排序")]),s._v(" "),a("p",[a("strong",[s._v("聚合表达式")])]),s._v(" "),a("p",[s._v("获取字段信息")]),s._v(" "),a("p",[s._v("$  ： 用 $ 指示字段路径")]),s._v(" "),a("p",[s._v("$.  ： 使用 $  和 .  来指示内嵌文档的路径")]),s._v(" "),a("p",[s._v("常量表达式")]),s._v(" "),a("p",[s._v("$literal : ： 指示常量")]),s._v(" "),a("p",[s._v("系统变量表达式")]),s._v(" "),a("p",[s._v("$$  使用 $$ 指示系统变量")]),s._v(" "),a("p",[s._v("$$CURRENT  指示管道中当前操作的文档")]),s._v(" "),a("p",[a("strong",[s._v("聚合管道阶段")])]),s._v(" "),a("p",[s._v("$project  对输入文档进行再次投影")]),s._v(" "),a("p",[s._v("$match 对输入文档进行筛选")]),s._v(" "),a("p",[s._v("$limit 筛选出管道内前 N 篇文档")]),s._v(" "),a("p",[s._v("$skip 跳过管道内前N篇文档")]),s._v(" "),a("p",[s._v("$unwind 展开输入文档中的数组字段")]),s._v(" "),a("p",[s._v("$sort 对输入文档进行排序")]),s._v(" "),a("p",[s._v("$lookup 对输入文档进行查询操作")]),s._v(" "),a("p",[s._v("$group 对输入文档进行分组")]),s._v(" "),a("p",[s._v("$out 对管道中的文档输出")]),s._v(" "),a("p",[s._v("准备数据")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.userInfo.insertMany(\n [\n  {nickName:"zhangsan",age:18},\n  {nickName:"lisi",age:20}]\n );\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("聚合管道操作")]),s._v(" "),a("p",[s._v("$project ： 投影操作， 将原始字段投影成指定名称， 如将 集合中的 nickName 投影成 name")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.userInfo.aggregate({$project:{ name:"$nickName"}});\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("$project 可以灵活控制输出文档的格式，也可以剔除不需要的字段")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.userInfo.aggregate({$project:{ name:"$nickName",_id:0,age:1}});\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("$match")]),s._v(" "),a("p",[s._v("$match 进行文档筛选")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.userInfo.aggregate({$match:{ nickName:"lisi"}});\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("筛选管道操作和其他管道操作配合时候时，尽量放到开始阶段，这样可以减少后续管道操作符要操作的文档数，提升效率")]),s._v(" "),a("p",[s._v("将筛选 和 投影结合使用")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('\n db.userInfo.aggregate(\n [ \n   { $match:   { nickName: "lisi"}},\n   { $project:  { _id:0, name: "$nickName", age:1}}\n]\n);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.userInfo.aggregate(\n[\n {   $match:   \n           {  $and:  \n                [   { age:   { $gte:20}},\n                    { nickName:{ $eq:"lisi"}}\n                ]   \n            }\n },\n {   \n     $project:   { _id:0, name: "$nickName", age:1}\n}\n]\n);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("$limit")]),s._v(" "),a("p",[s._v("$skip")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.userInfo.aggregate({$limit:1});\ndb.userInfo.aggregate({$skip:1}); \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("$unwind")]),s._v(" "),a("p",[s._v("将数组打平")]),s._v(" "),a("p",[s._v("构造数据")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.userInfo.insertOne(\n{ "nickName" : "xixi", \n  "age" : 35, \n  "tags" : ["80","IT","BeiJing"]\n}\n);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.userInfo.aggregate(\n{  $unwind:{path:"$tags"}}\n);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("includeArrayIndex:  加上数组元素的索引值， 赋值给后面指定的字段")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.userInfo.aggregate(\n  {$unwind: {path: "$tags",includeArrayIndex:"arrIndex"}}\n);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("preserveNullAndEmptyArrays:true")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(' db.userInfo.aggregate(\n  { $unwind: \n          {\n           path: "$tags",\n           includeArrayIndex:"arrIndex",\n           preserveNullAndEmptyArrays:true}\n    }\n);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("展开时保留空数组，或者不存在数组字段的文档")]),s._v(" "),a("p",[s._v("$sort  对文档进行排序： 1 正序， -1 倒序")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.userInfo.aggregate({$sort:{age:-1}});\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("$lookup")]),s._v(" "),a("p",[s._v("使用单一字段值进行查询")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$lookup:{\nfrom: 需要关联的文档,\nlocalField: 本地字段，\nforeignField: 外部文档关联字段，\nas  作为新的字段，添加到文档中\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.account.insertMany(\n [\n {_id:1,name:"zhangsan",age:19},\n {_id:2,name:"lisi",age:20}\n]\n);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.accountDetail.insertMany(\n[\n{aid:1,address:["address1","address2"]}\n]\n);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.accountDetail.aggregate(\n{  \n  $lookup:  \n         {  \n           from:"account",\n           localField:"aid",\n           foreignField:"_id",\n           as: "field1"\n        }\n   }\n);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("$group")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$group:{\n _id:  对哪个字段进行分组，\nfield1:{  accumulator1: expression1   }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("group 聚合操作默认不会对输出结果进行排序")]),s._v(" "),a("p",[s._v("对于group ，聚合操作主要有以下几种")]),s._v(" "),a("p",[s._v("$addToSet ：将分组中的元素添加到一个数组中，并且自动去重")]),s._v(" "),a("p",[s._v("$avg   返回分组中的平均值， 非数值直接忽略")]),s._v(" "),a("p",[s._v("$first   返回分组中的第一个元素")]),s._v(" "),a("p",[s._v("$last    返回分组中的最后一个元素")]),s._v(" "),a("p",[s._v("$max  返回分组中的最大元素")]),s._v(" "),a("p",[s._v("$min  回分组中的最小元素")]),s._v(" "),a("p",[s._v("$push   创建新的数组，将值添加进去")]),s._v(" "),a("p",[s._v("$sum    求分组数值元素和")]),s._v(" "),a("p",[s._v("构造一组数据")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.sales.insertMany(\n[\n{ "_id" : 1, "item" : "abc", "price" : 10, "quantity" : 2, "date" : ISODate("2014-01-01T08:00:00Z") },\n{ "_id" : 2, "item" : "jkl", "price" : 20, "quantity" : 1, "date" : ISODate("2014-02-03T09:00:00Z") },\n{ "_id" : 3, "item" : "xyz", "price" : 5, "quantity" : 5, "date" : ISODate("2014-02-03T09:05:00Z") },\n{ "_id" : 4, "item" : "abc", "price" : 10, "quantity" : 10, "date" : ISODate("2014-02-15T08:00:00Z") },\n{ "_id" : 5, "item" : "xyz", "price" : 5, "quantity" : 10, "date" : ISODate("2014-02-15T09:12:00Z") },\n{ "_id" : 6, "item" : "xyz", "price" : 5, "quantity" : 10, "date" : ISODate("2014-02-15T09:12:00Z") }\n]\n);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("$addToSet")]),s._v(" "),a("p",[s._v("查看每天，卖出哪几种商品项目")]),s._v(" "),a("p",[s._v("按每天分组， 将商品加入到去重数组中")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.sales.aggregate(\n   [\n     {\n       $group:\n         {\n           _id: { day: { $dayOfYear: "$date"}, year: { $year: "$date" } },\n           itemsSold: { $addToSet: "$item" }\n         }\n     }\n   ]\n)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("$avg:  求数值的平均值")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.sales.aggregate(\n   [\n     {\n       $group:\n         {\n           _id: "$item",\n           avgAmount: { $avg: { $multiply: [ "$price", "$quantity" ] } },\n           avgQuantity: { $avg: "$quantity" }\n         }\n     }\n   ]\n)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("$push")]),s._v(" "),a("p",[s._v("创建新的数组，存储，每个分组中元素的信息")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.sales.aggregate(\n   [\n     {\n       $group:\n         {\n           _id: { day: { $dayOfYear: "$date"}, year: { $year: "$date" } },\n           itemsSold: { $push:  { item: "$item", quantity: "$quantity" } }\n         }\n     }\n   ]\n)\n\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("group 阶段有 100m内存的使用限制， 默认情况下，如果超过这个限制会直接返回 error，")]),s._v(" "),a("p",[s._v("可以通过设置  allowDiskUse 为 true 来避免异常， allowDiskUse 为 true 将利用临时文件来辅助实现group操作。")]),s._v(" "),a("p",[s._v("$out")]),s._v(" "),a("p",[s._v("将聚合结果写入另一个文档")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.sales.aggregate(\n   [\n     {\n       $group:\n         {\n           _id: { day: { $dayOfYear: "$date"}, year: { $year: "$date" } },\n           itemsSold: { $push:  { item: "$item", quantity: "$quantity" } }\n         }\n     },\n    {  $out:"output"}\n   ]\n)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("更多聚合操作参考： https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/")]),s._v(" "),a("p",[a("strong",[s._v("管道优化")])]),s._v(" "),a("ol",[a("li",[s._v("投影优化")])]),s._v(" "),a("p",[s._v("聚合管道可以确定它是否仅需要文档中的字段的子集来获得结果。如果是这样，管道将只使用那些必需的字段，减少通过管道的数据量。")]),s._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[s._v("管道符号执行顺序优化")])]),s._v(" "),a("p",[s._v("对于包含投影阶段($project或$unset或$addFields或$set)后跟$match阶段的聚合管道，MongoDB 将$match阶段中不需要在投影阶段计算的值的任何过滤器移动到投影前的新$match阶段")]),s._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[s._v("$sort +  $match")])]),s._v(" "),a("p",[s._v("如果序列中带有$sort后跟$match，则$match会移动到$sort之前，以最大程度的减少要排序的对象的数量")]),s._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[s._v("$project/ $unset + $skip序列优化")])]),s._v(" "),a("p",[s._v("当有一个$project或$unset之后跟有$skip序列时，$skip 会移至$project之前。")]),s._v(" "),a("p",[s._v("5.$limit+ $limit合并")]),s._v(" "),a("p",[s._v("当$limit紧接着另一个时 $limit，两个阶段可以合并为一个阶段 $limit，其中限制量为两个初始限制量中的较小者。")]),s._v(" "),a("ol",{attrs:{start:"6"}},[a("li",[s._v("skip+ $skip 合并")])]),s._v(" "),a("p",[s._v("当$skip紧跟另一个$skip，这两个阶段可合并成一个单一的$skip，其中跳过量为总和的两个初始跳过量。")]),s._v(" "),a("ol",{attrs:{start:"7"}},[a("li",[s._v("$match+ $match合并")])]),s._v(" "),a("p",[s._v("当一个$match紧随另一个紧随其后时 $match，这两个阶段可以合并为一个单独 $match的条件 $and")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('{ $match: { year: 2014 } },\n{ $match: { status: "A" } }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("优化后")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('{ $match: { $and: [ { "year" : 2014 }, { "status" : "A" } ] } }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("索引")])]),s._v(" "),a("p",[a("strong",[s._v("什么是索引？")])]),s._v(" "),a("p",[s._v("索引是特殊的数据结构，它以一种易于遍历的形式存储集合数据集的一小部分。索引存储一个或一组特定字段的值，按字段的值排序。索引项的排序支持有效的"),a("strong",[s._v("相等匹配")]),s._v("和基于"),a("strong",[s._v("范围的查询")]),s._v("操作。此外，MongoDB可以通过使用索引中的排序返回"),a("strong",[s._v("排序后")]),s._v("的结果。")]),s._v(" "),a("p",[s._v("WiredTiger: B+")]),s._v(" "),a("p",[s._v("比如基于 "),a("strong",[s._v("B+ tree")]),s._v(" 的索引数据结构图示如下：")]),s._v(" "),a("p",[s._v("单键索引")]),s._v(" "),a("p",[s._v("如基于主键ID 进行的B+ tree 数据结构")]),s._v(" "),a("p",[s._v("​    "),a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/mongodb/21.png",alt:""}})]),s._v(" "),a("p",[s._v("复合索引（复合索引只能支持前缀子查询）")]),s._v(" "),a("p",[s._v("(A,B,C)")]),s._v(" "),a("p",[s._v("基于name， age， position 建立的复合索引")]),s._v(" "),a("p",[s._v("name")]),s._v(" "),a("p",[s._v("name  age")]),s._v(" "),a("p",[s._v("name age postion")]),s._v(" "),a("p",[s._v("age :")]),s._v(" "),a("p",[s._v("position")]),s._v(" "),a("p",[s._v("age+ position")]),s._v(" "),a("p",[s._v("​    "),a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/mongodb/22.png",alt:""}})]),s._v(" "),a("p",[a("strong",[s._v("索引的特点？")])]),s._v(" "),a("p",[s._v("索引支持更快的查询")]),s._v(" "),a("p",[s._v("更快的排序")]),s._v(" "),a("p",[a("strong",[s._v("默认id索引")])]),s._v(" "),a("p",[s._v("在创建集合期间，MongoDB 在_id字段上创建唯一索引。该索引可防止客户端插入两个具有相同值的文档。你不能将_id字段上的index删除。")]),s._v(" "),a("p",[a("strong",[s._v("创建索引：")])]),s._v(" "),a("p",[s._v("db.collection.createIndex(, )")]),s._v(" "),a("p",[s._v("指定了创建索引的字段")]),s._v(" "),a("p",[s._v("构造一组数据")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.members.insertMany(\n[\n  {name:"zhangsan",age:19,tags:["00","It","SH"]},\n  {name:"lisi",age:35,tags:["80","It","BJ"]},     \n  {name:"wangwu",age:31,tags:["90","It","SZ"]}\n]\n);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[a("strong",[s._v("创建一个单键索引")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.members.createIndex({name:1});\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("索引的默认名称是索引键和索引中每个键的方向(即1或-1)的连接，使用下划线作为分隔符， 也可以通过指定 name 来自定义索引名称；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.members.createIndex({name:1}，{ name: "whatever u like."});\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("对于单字段索引和排序操作，索引键的排序顺序(升序或降序)并不重要，因为MongoDB可以从任何方向遍历索引。")]),s._v(" "),a("p",[s._v("​    "),a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/mongodb/23.png",alt:""}})]),s._v(" "),a("p",[s._v("查询集合中已经存在的索引")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.members.getIndexes();\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("创建一个复合索引")])]),s._v(" "),a("p",[s._v("MongoDB支持在多个字段上创建用户定义索引，即 复合索引。")]),s._v(" "),a("p",[s._v("复合索引中列出的字段的顺序具有重要意义。如果一个复合索引由 {name: 1, age: -1} 组成，索引首先按name 升序排序，然后在每个name值内按 age 降序 排序。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.members.createIndex({ name:1,age:-1});\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("对于复合索引和排序操作，索引键的排序顺序(升序或降序)可以决定索引是否支持排序操作。")]),s._v(" "),a("p",[a("strong",[s._v("创建多键索引")])]),s._v(" "),a("p",[s._v("MongoDB使用多键索引来索引存储在数组中的内容。如果索引包含数组值的字段，MongoDB为数组的每个元素创建单独的索引项。数组字段中的每一个元素，都会在多键索引中创建一个键")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.members.createIndex( { tags:1});\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("索引的效果解析")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.collection.explain().method(?)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("可以使用 explain 进行分析的操作包含 aggregate, count, distinct, find ,group, remove, update")]),s._v(" "),a("p",[s._v("winningPlan： stage 的值含义")]),s._v(" "),a("p",[s._v("COLLSCAN:  整个集合扫描")]),s._v(" "),a("p",[s._v("IXScan: 索引扫描")]),s._v(" "),a("p",[s._v("FETCH:  根据索引指向的文档的地址进行查询")]),s._v(" "),a("p",[s._v("SORT: 需要再内存中排序，效率不高")]),s._v(" "),a("p",[a("strong",[s._v("覆盖查询")])]),s._v(" "),a("p",[s._v("当查询条件和查询的<投影>只包含索引字段时，MongoDB直接从索引返回结果，而不扫描任何文档或将文档带入内存。这些覆盖的查询可能非常高效。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.members.explain().find({ name:"zhangsan"},{_id:0, name:1});\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("这时不需要 fetch, 可以直接从索引中获取数据。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.members.explain().find().sort( {name:1 ,age:-1}) ;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("使用已创建索引的字段进行排序，能利用索引的顺序，不需要重新排序，效率高")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(" db.members.explain().find().sort( {name:1 ,age: 1}) ;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("使用未创建索引的字段进行排序， 因为和创建索引时的顺序不一致，所以需要重新排序，效率低")]),s._v(" "),a("p",[s._v("如果需要更改某些字段上已经创建的索引，必须首先删除原有索引，再重新创建新索引，否则，新索引不会包含原有文档")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.collection.dropIndex()\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("使用索引名称删除索引")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.collection.dropIndex("name_1");\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("使用索引定义删除索引")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.collection.dropIndex({name:1,age:-1});\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(" db.collection.createIndex(<keys>, <options>)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("定义了创建索引时可以使用的一些参数，也可以指定索引的特性")]),s._v(" "),a("p",[a("strong",[s._v("索引的唯一性")])]),s._v(" "),a("p",[s._v("索引的unique属性使MongoDB拒绝索引字段的重复值。除了唯一性约束，唯一索引和MongoDB其他索引功能上是一致的")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.members.createIndex({age:1},{unique:true});\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("如果文档中的字段已经出现了重复值，则不可以创建该字段的唯一性索引")]),s._v(" "),a("p",[s._v("如果新增的文档不具备加了唯一索引的字段，则只有第一个缺失该字段的文档可以被添加，索引中该键值被置为null。")]),s._v(" "),a("p",[s._v("复合键索引也可以具有唯一性，这种情况下，不同的文档之间，其所包含的复合键字段值的组合不可以重复。")]),s._v(" "),a("p",[a("strong",[s._v("索引的稀疏性")])]),s._v(" "),a("p",[s._v("索引的稀疏属性可确保索引仅包含具有索引字段的文档的条目。索引会跳过没有索引字段的文档。")]),s._v(" "),a("p",[s._v("可以将稀疏索引与唯一索引结合使用，"),a("strong",[s._v("以防止插入索引字段值重复的文档")]),s._v("，并跳过索引缺少索引字段的文档。")]),s._v(" "),a("p",[s._v("准备数据：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.sparsedemo.insertMany([{name:"xxx",age:19},{name:"zs",age:20}]);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("创建 唯一键，稀疏索引")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.sparsedemo.createIndex({name:1},{unique:true ,sparse:true});\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("如果同一个索引既具有唯一性，又具有稀疏性，就可以保存多篇缺失索引键值的文档了")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.sparsedemo.insertOne({name:"zs2w",age:20});\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.sparsedemo.insertOne({name:"zs2w2",age:20});\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("说明：如果只单纯的 唯一键索引，则 缺失索引键的字段，只能有一个")]),s._v(" "),a("p",[s._v("复合键索引也可以具有稀疏性，在这种情况下，只有在缺失复合键所包含的所有字段的情况下，文档才不会被加入到索引中。")]),s._v(" "),a("p",[a("strong",[s._v("索引的生存时间")])]),s._v(" "),a("p",[s._v("针对日期字段，或者包含了日期元素的数组字段，可以使用设定了生存时间的索引，来自动删除字段值超过生存时间的文档。")]),s._v(" "),a("p",[s._v("构造数据：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('db.members.insertMany( [ \n\n    {\n     name:"zhangsanss",\n     age:19,tags:["00","It","SH"],\n     create_time:new Date()}\n    ] );\n \n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("db.members.createIndex({ create_time: 1},{expireAfterSeconds:30 });\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在create_time字段上面创建了一个生存时间是30s的索引")]),s._v(" "),a("p",[a("strong",[s._v("复合键索引不具备生存时间的特性")])]),s._v(" "),a("p",[s._v("当索引键是包含日期元素的数组字段时，数组中最小的日期将被用来计算文档是否已经过期")]),s._v(" "),a("p",[s._v("数据库使用一个后台线程来监测和删除过期的文档，删除操作可能会有一定的延迟")]),s._v(" "),a("p",[s._v("https://docs.mongodb.com/manual/core/index-compound/#index-ascending-and-descending")]),s._v(" "),a("p",[s._v("https://docs.mongodb.com/manual/reference/operator/aggregation/addFields/#pipe._S_addFields")]),s._v(" "),a("p",[s._v("文档：VIP-02 MongoDB聚合操作，索引.note")])])}),[],!1,null,null,null);a.default=t.exports}}]);
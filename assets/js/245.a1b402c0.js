(window.webpackJsonp=window.webpackJsonp||[]).push([[245],{588:function(s,a,n){"use strict";n.r(a);var e=n(1),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("U2FsdGVkX19gHOQMy3Zvi69XE1/9J2jXeTRlllpcI4a5gXwOdu6zeDuVvyAgELte\nyeJTuZaUSDcY8/+XG+wIo2ITUNqHblxgbaCfzrAhyAz3gqWDnA==\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"_1-启动seata-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-启动seata-server"}},[s._v("#")]),s._v(" 1.  启动Seata Server")]),s._v(" "),a("h3",{attrs:{id:"_1-1-环境准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-环境准备"}},[s._v("#")]),s._v(" 1.1 环境准备")]),s._v(" "),a("h4",{attrs:{id:"_1-指定nacos作为配置中心和注册中心"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-指定nacos作为配置中心和注册中心"}},[s._v("#")]),s._v(" 1）指定nacos作为配置中心和注册中心")]),s._v(" "),a("p",[s._v("修改registry.conf文件")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623143115507.png",alt:"image-20220623143115507"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623143124289.png",alt:"image-20220623143124289"}})]),s._v(" "),a("p",[s._v('注意：客户端配置registry.conf使用nacos时也要注意group要和seata server中的group一致，默认group是"DEFAULT_GROUP"')]),s._v(" "),a("h4",{attrs:{id:"_2-同步seata-server的配置到nacos"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-同步seata-server的配置到nacos"}},[s._v("#")]),s._v(" 2）同步seata server的配置到nacos")]),s._v(" "),a("p",[s._v("获取/seata/script/config-center/config.txt，修改配置信息")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623143144036.png",alt:"image-20220623143144036"}})]),s._v(" "),a("p",[s._v("配置事务分组， 要与客户端配置的事务分组一致")]),s._v(" "),a("p",[s._v("（客户端properties配置：spring.cloud.alibaba.seata.tx‐service‐group=my_test_tx_group）")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623143230295.png",alt:"image-20220623143230295"}})]),s._v(" "),a("p",[s._v("配置参数同步到Nacos")]),s._v(" "),a("p",[s._v("shell:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sh ${SEATAPATH}/script/config-center/nacos/nacos-config.sh -h localhost -p 8848 -g SEATA_GROUP -t 5a3c7d6c-f497-4d68-a71a-2e5e3340b3ca\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("​")]),s._v(" "),a("p",[s._v("参数说明：")]),s._v(" "),a("p",[s._v("-h: host，默认值 localhost")]),s._v(" "),a("p",[s._v("-p: port，默认值 8848")]),s._v(" "),a("p",[s._v("-g: 配置分组，默认值为 'SEATA_GROUP'")]),s._v(" "),a("p",[s._v("-t: 租户信息，对应 Nacos 的命名空间ID字段, 默认值为空 ''")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623143249571.png",alt:"image-20220623143249571"}})]),s._v(" "),a("h4",{attrs:{id:"_3-启动seata-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-启动seata-server"}},[s._v("#")]),s._v(" 3） 启动Seata Server")]),s._v(" "),a("p",[s._v("启动Seata Server命令")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("bin/seata-server.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("启动成功，默认端口8091")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623143258659.png",alt:"image-20220623143258659"}})]),s._v(" "),a("p",[s._v("在注册中心中可以查看到seata-server注册成功")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623143307714.png",alt:"image-20220623143307714"}})]),s._v(" "),a("h2",{attrs:{id:"_2-seata如何整合到spring-cloud微服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-seata如何整合到spring-cloud微服务"}},[s._v("#")]),s._v(" 2.  Seata如何整合到Spring Cloud微服务")]),s._v(" "),a("p",[a("strong",[s._v("业务场景：")])]),s._v(" "),a("p",[s._v("用户下单，整个业务逻辑由三个微服务构成：")]),s._v(" "),a("ul",[a("li",[s._v("仓储服务：对给定的商品扣除库存数量。")]),s._v(" "),a("li",[s._v("订单服务：根据采购需求创建订单。")]),s._v(" "),a("li",[s._v("帐户服务：从用户帐户中扣除余额。")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623143315736.png",alt:"image-20220623143315736"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623143323147.png",alt:"image-20220623143323147"}})]),s._v(" "),a("p",[s._v("环境准备：")]),s._v(" "),a("p",[s._v("seata： v1.4.0")]),s._v(" "),a("p",[s._v("spring cloud&spring cloud alibaba:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("<spring-cloud.version>Greenwich.SR3</spring-cloud.version>\n<spring-cloud-alibaba.version>2.1.1.RELEASE</spring-cloud-alibaba.version>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("​")]),s._v(" "),a("p",[s._v("注意版本选择问题：")]),s._v(" "),a("p",[s._v("spring cloud alibaba 2.1.2 及其以上版本使用seata1.4.0会出现如下异常 （支持seata 1.3.0）")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623143330741.png",alt:"image-20220623143330741"}})]),s._v(" "),a("h3",{attrs:{id:"_2-1-导入依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-导入依赖"}},[s._v("#")]),s._v(" 2.1  导入依赖")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("\x3c!-- seata--\x3e\n<dependency>\n    <groupId>com.alibaba.cloud</groupId>\n    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>\n    <exclusions>\n        <exclusion>\n            <groupId>io.seata</groupId>\n            <artifactId>seata-all</artifactId>\n        </exclusion>\n    </exclusions>\n</dependency>\n<dependency>\n    <groupId>io.seata</groupId>\n    <artifactId>seata-all</artifactId>\n    <version>1.4.0</version>\n</dependency>\n\n\x3c!--nacos 注册中心--\x3e\n<dependency>\n    <groupId>com.alibaba.cloud</groupId>\n    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\n</dependency>\n\n<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-openfeign</artifactId>\n</dependency>\n\n<dependency>\n    <groupId>com.alibaba</groupId>\n    <artifactId>druid-spring-boot-starter</artifactId>\n    <version>1.1.21</version>\n</dependency>\n\n<dependency>\n    <groupId>mysql</groupId>\n    <artifactId>mysql-connector-java</artifactId>\n    <scope>runtime</scope>\n    <version>8.0.16</version>\n</dependency>\n\n<dependency>\n    <groupId>org.mybatis.spring.boot</groupId>\n    <artifactId>mybatis-spring-boot-starter</artifactId>\n    <version>2.1.1</version>\n</dependency>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br")])]),a("p",[s._v("​")]),s._v(" "),a("h3",{attrs:{id:"_2-2-微服务对应数据库中添加undo-log表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-微服务对应数据库中添加undo-log表"}},[s._v("#")]),s._v(" 2.2   微服务对应数据库中添加undo_log表")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("CREATE TABLE `undo_log` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `branch_id` bigint(20) NOT NULL,\n  `xid` varchar(100) NOT NULL,\n  `context` varchar(128) NOT NULL,\n  `rollback_info` longblob NOT NULL,\n  `log_status` int(11) NOT NULL,\n  `log_created` datetime NOT NULL,\n  `log_modified` datetime NOT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)\n) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h3",{attrs:{id:"_2-3-微服务需要使用seata-datasourceproxy代理自己的数据源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-微服务需要使用seata-datasourceproxy代理自己的数据源"}},[s._v("#")]),s._v(" 2.3  微服务需要使用seata DataSourceProxy代理自己的数据源")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('/**\n * @author Fox\n *\n * 需要用到分布式事务的微服务都需要使用seata DataSourceProxy代理自己的数据源\n */\n@Configuration\n@MapperScan("com.tuling.datasource.mapper")\npublic class MybatisConfig {\n    \n    /**\n     * 从配置文件获取属性构造datasource，注意前缀，这里用的是druid，根据自己情况配置,\n     * 原生datasource前缀取"spring.datasource"\n     *\n     * @return\n     */\n    @Bean\n    @ConfigurationProperties(prefix = "spring.datasource")\n    public DataSource druidDataSource() {\n        DruidDataSource druidDataSource = new DruidDataSource();\n        return druidDataSource;\n    }\n    \n    /**\n     * 构造datasource代理对象，替换原来的datasource\n     * @param druidDataSource\n     * @return\n     */\n    @Primary\n    @Bean("dataSource")\n    public DataSourceProxy dataSourceProxy(DataSource druidDataSource) {\n        return new DataSourceProxy(druidDataSource);\n    }\n    \n    \n    @Bean(name = "sqlSessionFactory")\n    public SqlSessionFactory sqlSessionFactoryBean(DataSourceProxy dataSourceProxy) throws Exception {\n        SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();\n        //设置代理数据源\n        factoryBean.setDataSource(dataSourceProxy);\n        ResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();\n        factoryBean.setMapperLocations(resolver.getResources("classpath*:mybatis/**/*-mapper.xml"));\n        \n        org.apache.ibatis.session.Configuration configuration=new org.apache.ibatis.session.Configuration();\n        //使用jdbc的getGeneratedKeys获取数据库自增主键值\n        configuration.setUseGeneratedKeys(true);\n        //使用列别名替换列名\n        configuration.setUseColumnLabel(true);\n        //自动使用驼峰命名属性映射字段，如userId ---\x3e user_id\n        configuration.setMapUnderscoreToCamelCase(true);\n        factoryBean.setConfiguration(configuration);\n        \n        return factoryBean.getObject();\n    }\n    \n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br")])]),a("p",[s._v("注意： 启动类上需要排除DataSourceAutoConfiguration，否则会出现循环依赖的问题")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623143340880.png",alt:"image-20220623143340880"}})]),s._v(" "),a("h4",{attrs:{id:"启动类排除datasourceautoconfiguration-class"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动类排除datasourceautoconfiguration-class"}},[s._v("#")]),s._v(" 启动类排除DataSourceAutoConfiguration.class")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('@SpringBootApplication(scanBasePackages = "com.tuling",exclude = DataSourceAutoConfiguration.class)\npublic class AccountServiceApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(AccountServiceApplication.class, args);\n    }\n\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h3",{attrs:{id:"_2-4-添加seata的配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-添加seata的配置"}},[s._v("#")]),s._v(" 2.4. 添加seata的配置")]),s._v(" "),a("h4",{attrs:{id:"_1-将registry-conf文件拷贝到resources目录下-指定注册中心和配置中心都是nacos"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-将registry-conf文件拷贝到resources目录下-指定注册中心和配置中心都是nacos"}},[s._v("#")]),s._v(" 1）将registry.conf文件拷贝到resources目录下，指定注册中心和配置中心都是nacos")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('registry {\n  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa\n  type = "nacos"\n\n  nacos {\n    serverAddr = "192.168.65.232:8848"\n    namespace = ""\n    cluster = "default"\n    group = "SEATA_GROUP"\n  }\n}\n\nconfig {\n  # file、nacos 、apollo、zk、consul、etcd3、springCloudConfig\n  type = "nacos"\n\n  nacos {\n    serverAddr = "192.168.65.232:8848"\n    namespace = "29ccf18e-e559-4a01-b5d4-61bad4a89ffd"\n    group = "SEATA_GROUP"\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("blockquote",[a("p",[s._v("在 *"),a("code",[s._v("org.springframework.cloud:spring-cloud-starter-alibaba-seata")]),a("em",[s._v("的")]),a("code",[s._v("org.springframework.cloud.alibaba.seata.GlobalTransactionAutoConfiguration")]),s._v("*类中，默认会使用 *"),a("code",[s._v("${spring.application.name}-seata-service-group")]),s._v("*作为服务名注册到 Seata Server上，如果和service.vgroup_mapping配置不一致，会提示 *"),a("code",[s._v("no available server to connect")]),s._v("*错误")]),s._v(" "),a("p",[s._v("也可以通过配置 *"),a("code",[s._v("spring.cloud.alibaba.seata.tx-service-group")]),a("em",[s._v("修改后缀，但是必须和")]),a("code",[s._v("file.conf")]),s._v("*中的配置保持一致")])]),s._v(" "),a("h4",{attrs:{id:"_2-在yml中指定事务分组-和配置中心的service-vgroup-mapping-配置一一对应"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-在yml中指定事务分组-和配置中心的service-vgroup-mapping-配置一一对应"}},[s._v("#")]),s._v(" 2）在yml中指定事务分组（和配置中心的service.vgroup_mapping 配置一一对应）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("spring:\n  application:\n    name: account-service\n  cloud:\n    nacos:\n      discovery:\n        server-addr: 127.0.0.1:8848\n    alibaba:\n      seata:\n        tx-service-group:\n          my_test_tx_group  # seata 服务事务分组\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("​")]),s._v(" "),a("blockquote",[a("p",[s._v("参考源码：")]),s._v(" "),a("p",[s._v("io.seata.core.rpc.netty.NettyClientChannelManager#getAvailServerList")]),s._v(" "),a("p",[s._v("》NacosRegistryServiceImpl#lookup")]),s._v(" "),a("p",[s._v("》String clusterName = getServiceGroup(key);  #获取seata server集群名称")]),s._v(" "),a("p",[s._v("》List firstAllInstances = getNamingInstance().getAllInstances(getServiceName(), getServiceGroup(), clusters)")])]),s._v(" "),a("p",[s._v("spring cloud alibaba 2.1.4 之后支持yml中配置seata属性，可以用来替换registry.conf文件")]),s._v(" "),a("p",[s._v("配置支持实现在seata-spring-boot-starter.jar中，也可以引入依赖")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("<dependency>\n    <groupId>io.seata</groupId>\n    <artifactId>seata-spring-boot-starter</artifactId>\n    <version>1.4.0</version>\n</dependency>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("在yml中配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('seata:\n  # seata 服务分组，要与服务端nacos-config.txt中service.vgroup_mapping的后缀对应\n  tx-service-group: my_test_tx_group\n  registry:\n    # 指定nacos作为注册中心\n    type: nacos\n    nacos:\n      server-addr: 127.0.0.1:8848\n      namespace: ""\n      group: SEATA_GROUP  \n    \n  config:\n    # 指定nacos作为配置中心\n    type: nacos\n    nacos:\n      server-addr: 127.0.0.1:8848\n      namespace: "54433b62-df64-40f1-9527-c907219fc17f"\n      group: SEATA_GROUP\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("​")]),s._v(" "),a("h4",{attrs:{id:"_3-在事务发起者中添加-globaltransactional注解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-在事务发起者中添加-globaltransactional注解"}},[s._v("#")]),s._v(" 3） 在事务发起者中添加@GlobalTransactional注解")]),s._v(" "),a("p",[s._v("核心代码")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('@Override\n//@Transactional\n@GlobalTransactional(name="createOrder")\npublic Order saveOrder(OrderVo orderVo){\n    log.info("=============用户下单=================");\n    log.info("当前 XID: {}", RootContext.getXID());\n    \n    // 保存订单\n    Order order = new Order();\n    order.setUserId(orderVo.getUserId());\n    order.setCommodityCode(orderVo.getCommodityCode());\n    order.setCount(orderVo.getCount());\n    order.setMoney(orderVo.getMoney());\n    order.setStatus(OrderStatus.INIT.getValue());\n\n    Integer saveOrderRecord = orderMapper.insert(order);\n    log.info("保存订单{}", saveOrderRecord > 0 ? "成功" : "失败");\n    \n    //扣减库存\n    storageFeignService.deduct(orderVo.getCommodityCode(),orderVo.getCount());\n    \n    //扣减余额\n    accountFeignService.debit(orderVo.getUserId(),orderVo.getMoney());\n\n    //更新订单\n    Integer updateOrderRecord = orderMapper.updateOrderStatus(order.getId(),OrderStatus.SUCCESS.getValue());\n    log.info("更新订单id:{} {}", order.getId(), updateOrderRecord > 0 ? "成功" : "失败");\n    \n    return order;\n    \n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("h4",{attrs:{id:"_4-测试分布式事务是否生效"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-测试分布式事务是否生效"}},[s._v("#")]),s._v(" 4）测试分布式事务是否生效")]),s._v(" "),a("p",[s._v("用户下单账户余额不足，库存是否回滚")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623143409240.png",alt:"image-20220623143409240"}})])])}),[],!1,null,null,null);a.default=r.exports}}]);
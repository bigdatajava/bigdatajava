(window.webpackJsonp=window.webpackJsonp||[]).push([[243],{586:function(a,s,e){"use strict";e.r(s);var n=e(1),t=Object(n.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("U2FsdGVkX1+IInyjmw8SLEtEW7lcPWnmCpoL18EE1q0UoopwxFeb5/X7L3zRKXY9\nLwIbbqpLiWChyykSZoIIE2REZ9qthWppqIbOuhnnAyBoRhAOog==\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h2",{attrs:{id:"_1-seata-是什么"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-seata-是什么"}},[a._v("#")]),a._v(" 1.Seata 是什么")]),a._v(" "),s("p",[a._v("Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。AT模式是阿里首推的模式，阿里云上有商用版本的GTS（Global Transaction Service 全局事务服务）")]),a._v(" "),s("p",[a._v("官网：https://seata.io/zh-cn/index.html")]),a._v(" "),s("p",[a._v("源码: https://github.com/seata/seata")]),a._v(" "),s("p",[a._v("官方Demo: https://github.com/seata/seata-samples")]),a._v(" "),s("p",[a._v("seata版本：v1.4.0")]),a._v(" "),s("h2",{attrs:{id:"_1-1-seata的三大角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-seata的三大角色"}},[a._v("#")]),a._v(" 1.1 Seata的三大角色")]),a._v(" "),s("p",[a._v("在 Seata 的架构中，一共有三个角色：")]),a._v(" "),s("p",[s("strong",[a._v("TC (Transaction Coordinator) - 事务协调者")])]),a._v(" "),s("p",[a._v("维护全局和分支事务的状态，驱动全局事务提交或回滚。")]),a._v(" "),s("p",[s("strong",[a._v("TM (Transaction Manager) - 事务管理器")])]),a._v(" "),s("p",[a._v("定义全局事务的范围：开始全局事务、提交或回滚全局事务。")]),a._v(" "),s("p",[s("strong",[a._v("RM (Resource Manager) - 资源管理器")])]),a._v(" "),s("p",[a._v("管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。")]),a._v(" "),s("p",[a._v("其中，TC 为单独部署的 Server 服务端，TM 和 RM 为嵌入到应用中的 Client 客户端。")]),a._v(" "),s("p",[a._v("在 Seata 中，一个分布式事务的生命周期如下：")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140312692.png",alt:"image-20220623140312692"}})]),a._v(" "),s("p",[a._v("1.TM 请求 TC 开启一个全局事务。TC 会生成一个 XID 作为该全局事务的编号。XID，会在微服务的调用链路中传播，保证将多个微服务的子事务关联在一起。")]),a._v(" "),s("p",[a._v("2.RM 请求 TC 将本地事务注册为全局事务的分支事务，通过全局事务的 XID 进行关联。")]),a._v(" "),s("p",[a._v("3.TM 请求 TC 告诉 XID 对应的全局事务是进行提交还是回滚。")]),a._v(" "),s("p",[a._v("4.TC 驱动 RM 们将 XID 对应的自己的本地事务进行提交还是回滚。")]),a._v(" "),s("h2",{attrs:{id:"_1-2-设计思路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-设计思路"}},[a._v("#")]),a._v(" 1.2 设计思路")]),a._v(" "),s("p",[a._v("AT模式的核心是对业务无侵入，是一种改进后的两阶段提交，其设计思路如图")]),a._v(" "),s("h3",{attrs:{id:"第一阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第一阶段"}},[a._v("#")]),a._v(" 第一阶段")]),a._v(" "),s("p",[a._v("业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。核心在于对业务sql进行解析，转换成undolog，并同时入库，这是怎么做的呢？先抛出一个概念DataSourceProxy代理数据源，通过名字大家大概也能基本猜到是什么个操作，后面做具体分析")]),a._v(" "),s("p",[a._v("参考官方文档： https://seata.io/zh-cn/docs/dev/mode/at-mode.html")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140326483.png",alt:"image-20220623140326483"}})]),a._v(" "),s("h3",{attrs:{id:"第二阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第二阶段"}},[a._v("#")]),a._v(" 第二阶段")]),a._v(" "),s("p",[a._v("分布式事务操作成功，则TC通知RM异步删除undolog")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140351123.png",alt:"image-20220623140351123"}})]),a._v(" "),s("p",[a._v("分布式事务操作失败，TM向TC发送回滚请求，RM 收到协调器TC发来的回滚请求，通过 XID 和 Branch ID 找到相应的回滚日志记录，通过回滚记录生成反向的更新 SQL 并执行，以完成分支的回滚。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140405972.png",alt:"image-20220623140405972"}})]),a._v(" "),s("h3",{attrs:{id:"整体执行流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#整体执行流程"}},[a._v("#")]),a._v(" 整体执行流程")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140429687.png",alt:"image-20220623140429687"}})]),a._v(" "),s("h2",{attrs:{id:"_1-3-设计亮点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-设计亮点"}},[a._v("#")]),a._v(" 1.3 设计亮点")]),a._v(" "),s("p",[a._v("相比与其它分布式事务框架，Seata架构的亮点主要有几个:")]),a._v(" "),s("ol",[s("li",[a._v("应用层基于SQL解析实现了自动补偿，从而最大程度的降低业务侵入性；")]),a._v(" "),s("li",[a._v("将分布式事务中TC（事务协调者）独立部署，负责事务的注册、回滚；")]),a._v(" "),s("li",[a._v("通过全局锁实现了写隔离与读隔离。")])]),a._v(" "),s("h2",{attrs:{id:"_1-4-存在的问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-存在的问题"}},[a._v("#")]),a._v(" 1.4 存在的问题")]),a._v(" "),s("h3",{attrs:{id:"性能损耗"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#性能损耗"}},[a._v("#")]),a._v(" 性能损耗")]),a._v(" "),s("p",[a._v("一条Update的SQL，则需要全局事务xid获取（与TC通讯）、before image（解析SQL，查询一次数据库）、after image（查询一次数据库）、insert undo log（写一次数据库）、before commit（与TC通讯，判断锁冲突），这些操作都需要一次远程通讯RPC，而且是同步的。另外undo log写入时blob字段的插入性能也是不高的。每条写SQL都会增加这么多开销,粗略估计会增加5倍响应时间。")]),a._v(" "),s("h3",{attrs:{id:"性价比"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#性价比"}},[a._v("#")]),a._v(" 性价比")]),a._v(" "),s("p",[a._v("为了进行自动补偿，需要对所有交易生成前后镜像并持久化，可是在实际业务场景下，这个是成功率有多高，或者说分布式事务失败需要回滚的有多少比率？按照二八原则预估，为了20%的交易回滚，需要将80%的成功交易的响应时间增加5倍，这样的代价相比于让应用开发一个补偿交易是否是值得？")]),a._v(" "),s("h3",{attrs:{id:"全局锁"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全局锁"}},[a._v("#")]),a._v(" 全局锁")]),a._v(" "),s("p",[s("strong",[a._v("热点数据")])]),a._v(" "),s("p",[a._v("相比XA，Seata 虽然在一阶段成功后会释放数据库锁，但一阶段在commit前全局锁的判定也拉长了对数据锁的占有时间，这个开销比XA的prepare低多少需要根据实际业务场景进行测试。全局锁的引入实现了隔离性，但带来的问题就是阻塞，降低并发性，尤其是热点数据，这个问题会更加严重。")]),a._v(" "),s("p",[s("strong",[a._v("回滚锁释放时间")])]),a._v(" "),s("p",[a._v("Seata在回滚时，需要先删除各节点的undo log，然后才能释放TC内存中的锁，所以如果第二阶段是回滚，释放锁的时间会更长。")]),a._v(" "),s("p",[s("strong",[a._v("死锁问题")])]),a._v(" "),s("p",[a._v("Seata的引入全局锁会额外增加死锁的风险，但如果出现死锁，会不断进行重试，最后靠等待全局锁超时，这种方式并不优雅，也延长了对数据库锁的占有时间。")]),a._v(" "),s("h2",{attrs:{id:"_2-seata快速开始"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-seata快速开始"}},[a._v("#")]),a._v(" 2. Seata快速开始")]),a._v(" "),s("h3",{attrs:{id:"_2-1-seata-server-tc-环境搭建"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-seata-server-tc-环境搭建"}},[a._v("#")]),a._v(" 2.1 Seata Server（TC）环境搭建")]),a._v(" "),s("p",[s("a",{attrs:{href:"https://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html",target:"_blank",rel:"noopener noreferrer"}},[s("strong",[a._v("https://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html")]),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("Server端存储模式（store.mode）支持三种：")]),a._v(" "),s("ul",[s("li",[a._v("file：单机模式，全局事务会话信息内存中读写并持久化本地文件root.data，性能较高")]),a._v(" "),s("li",[a._v("db：高可用模式，全局事务会话信息通过db共享，相应性能差些")]),a._v(" "),s("li",[a._v("redis：Seata-Server 1.3及以上版本支持,性能较高,存在事务信息丢失风险,请提前配置适合当前场景的redis持久化配置")])]),a._v(" "),s("p",[a._v("资源目录：https://github.com/seata/seata/tree/1.4.0/script")]),a._v(" "),s("ul",[s("li",[a._v("client")])]),a._v(" "),s("p",[a._v("存放client端sql脚本，参数配置")]),a._v(" "),s("ul",[s("li",[a._v("config-center")])]),a._v(" "),s("p",[a._v("各个配置中心参数导入脚本，config.txt(包含server和client，原名nacos-config.txt)为通用参数文件")]),a._v(" "),s("ul",[s("li",[a._v("server")])]),a._v(" "),s("p",[a._v("server端数据库脚本及各个容器配置")]),a._v(" "),s("h4",{attrs:{id:"db存储模式-nacos-注册-配置中心-部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#db存储模式-nacos-注册-配置中心-部署"}},[a._v("#")]),a._v(" db存储模式+Nacos(注册&配置中心)部署")]),a._v(" "),s("p",[s("strong",[a._v("步骤一：下载安装包")])]),a._v(" "),s("p",[a._v("https://github.com/seata/seata/releases")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140444206.png",alt:"image-20220623140444206"}})]),a._v(" "),s("p",[s("strong",[a._v("步骤二：建表(仅db模式)")])]),a._v(" "),s("p",[a._v("全局事务会话信息由3块内容构成，全局事务--\x3e分支事务--\x3e全局锁，对应表global_table、branch_table、lock_table")]),a._v(" "),s("p",[a._v("创建数据库seata，执行sql脚本，文件在script/server/db/mysql.sql（seata源码）中")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140453446.png",alt:"image-20220623140453446"}})]),a._v(" "),s("p",[a._v("​")]),a._v(" "),s("p",[s("strong",[a._v("步骤三：修改store.mode")])]),a._v(" "),s("p",[a._v('启动包: seata--\x3econf--\x3efile.conf，修改store.mode="db"')]),a._v(" "),s("p",[a._v('源码: 根目录--\x3eseata-server--\x3eresources--\x3efile.conf，修改store.mode="db"')]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140521239.png",alt:"image-20220623140521239"}})]),a._v(" "),s("p",[a._v("​")]),a._v(" "),s("p",[s("strong",[a._v("步骤四：修改数据库连接")])]),a._v(" "),s("p",[a._v("启动包: seata--\x3econf--\x3efile.conf，修改store.db相关属性。")]),a._v(" "),s("p",[a._v("源码: 根目录--\x3eseata-server--\x3eresources--\x3efile.conf，修改store.db相关属性。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140530984.png",alt:"image-20220623140530984"}})]),a._v(" "),s("p",[a._v("此时可以调到步骤七：直接启动Seata Server，注册中心和配置中心都是file")]),a._v(" "),s("p",[s("strong",[a._v("步骤五：配置Nacos注册中心")])]),a._v(" "),s("p",[a._v("将Seata Server注册到Nacos，修改conf目录下的registry.conf配置")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140542451.png",alt:"image-20220623140542451"}})]),a._v(" "),s("p",[a._v("然后启动注册中心Nacos Server")]),a._v(" "),s("p",[a._v("​                #进入Nacos安装目录，linux单机启动 bin/startup.sh -m standalone # windows单机启动 bin/startup.bat")]),a._v(" "),s("p",[s("strong",[a._v("步骤六：配置Nacos配置中心")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140559768.png",alt:"image-20220623140559768"}})]),a._v(" "),s("p",[a._v('注意：如果配置了seata server使用nacos作为配置中心，则配置信息会从nacos读取，file.conf可以不用配置。 客户端配置registry.conf使用nacos时也要注意group要和seata server中的group一致，默认group是"DEFAULT_GROUP"')]),a._v(" "),s("p",[a._v("获取/seata/script/config-center/config.txt，修改配置信息")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140610997.png",alt:"image-20220623140610997"}})]),a._v(" "),s("p",[a._v("配置事务分组， 要与客户端配置的事务分组一致")]),a._v(" "),s("p",[a._v("（客户端properties配置：spring.cloud.alibaba.seata.tx‐service‐group=my_test_tx_group）")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140629883.png",alt:"image-20220623140629883"}})]),a._v(" "),s("p",[a._v("配置参数同步到Nacos")]),a._v(" "),s("p",[a._v("shell:")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("sh ${SEATAPATH}/script/config-center/nacos/nacos-config.sh -h localhost -p 8848 -g SEATA_GROUP -t 5a3c7d6c-f497-4d68-a71a-2e5e3340b3ca\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("参数说明：")]),a._v(" "),s("p",[a._v("-h: host，默认值 localhost")]),a._v(" "),s("p",[a._v("-p: port，默认值 8848")]),a._v(" "),s("p",[a._v("-g: 配置分组，默认值为 'SEATA_GROUP'")]),a._v(" "),s("p",[a._v("-t: 租户信息，对应 Nacos 的命名空间ID字段, 默认值为空 ''")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140639418.png",alt:"image-20220623140639418"}})]),a._v(" "),s("p",[a._v("精简配置")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("service.vgroupMapping.my_test_tx_group=default\nservice.default.grouplist=127.0.0.1:8091\nservice.enableDegrade=false\nservice.disableGlobalTransaction=false\nstore.mode=db\nstore.db.datasource=druid\nstore.db.dbType=mysql\nstore.db.driverClassName=com.mysql.jdbc.Driver\nstore.db.url=jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true\nstore.db.user=root\nstore.db.password=root\nstore.db.minConn=5\nstore.db.maxConn=30\nstore.db.globalTable=global_table\nstore.db.branchTable=branch_table\nstore.db.queryLimit=100\nstore.db.lockTable=lock_table\nstore.db.maxWait=5000\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[s("strong",[a._v("步骤七：启动Seata Server")])]),a._v(" "),s("ul",[s("li",[a._v("源码启动: 执行server模块下io.seata.server.Server.java的main方法")]),a._v(" "),s("li",[a._v("命令启动: bin/seata-server.sh -h 127.0.0.1 -p 8091 -m db -n 1 -e test")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140649345.png",alt:"image-20220623140649345"}})]),a._v(" "),s("p",[a._v("启动Seata Server")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("bin/seata-server.sh\nbin/seata-server.sh -p 80        \n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("启动成功，默认端口8091")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140658392.png",alt:"image-20220623140658392"}})]),a._v(" "),s("p",[a._v("在注册中心中可以查看到seata-server注册成功")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140707634.png",alt:"image-20220623140707634"}})]),a._v(" "),s("h3",{attrs:{id:"_2-2-seata-client快速开始"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-seata-client快速开始"}},[a._v("#")]),a._v(" 2.2 Seata Client快速开始")]),a._v(" "),s("h4",{attrs:{id:"编程式事务实现-globaltransaction-api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编程式事务实现-globaltransaction-api"}},[a._v("#")]),a._v(" 编程式事务实现（GlobalTransaction API）")]),a._v(" "),s("p",[a._v("Demo：seata-samples/api")]),a._v(" "),s("p",[a._v("客户端环境配置")]),a._v(" "),s("p",[a._v("\\1. 修改jdbc.properties配置")]),a._v(" "),s("p",[a._v('\\2. registry.conf中指定registry.type="file" , config.type="file"')]),a._v(" "),s("p",[a._v("基于GlobalTransaction API的实现")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('public static void main(String[] args) throws SQLException, TransactionException, InterruptedException {\n\n    String userId = "U100001";\n    String commodityCode = "C00321";\n    int commodityCount = 100;\n    int money = 999;\n    AccountService accountService = new AccountServiceImpl();\n    StorageService storageService = new StorageServiceImpl();\n    OrderService orderService = new OrderServiceImpl();\n    orderService.setAccountService(accountService);\n\n    //reset data  重置数据\n    accountService.reset(userId, String.valueOf(money));\n    storageService.reset(commodityCode, String.valueOf(commodityCount));\n    orderService.reset(null, null);\n\n    //init seata; only once\n    String applicationId = "api";\n    String txServiceGroup = "my_test_tx_group";\n    TMClient.init(applicationId, txServiceGroup);\n    RMClient.init(applicationId, txServiceGroup);\n\n    //trx  开启全局事务\n    GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();\n    try {\n        tx.begin(60000, "testBiz");\n        System.out.println("begin trx, xid is " + tx.getXid());\n\n        //biz operate 3 dataSources\n        //set >=5 will be rollback(200*5>999) else will be commit\n        int opCount = 5;\n        // 扣减库存\n        storageService.deduct(commodityCode, opCount);\n        // 创建订单 ，扣款 money = opCount * 200\n        orderService.create(userId, commodityCode, opCount);\n\n        //check data if negative\n        boolean needCommit = ((StorageServiceImpl)storageService).validNegativeCheck("count", commodityCode)\n            && ((AccountServiceImpl)accountService).validNegativeCheck("money", userId);\n\n        //if data negative rollback else commit\n        if (needCommit) {\n            tx.commit();\n        } else {\n            System.out.println("rollback trx, cause: data negative, xid is " + tx.getXid());\n            tx.rollback();\n        }\n    } catch (Exception exx) {\n        System.out.println("rollback trx, cause: " + exx.getMessage() + " , xid is " + tx.getXid());\n        tx.rollback();\n        throw exx;\n    }\n    TimeUnit.SECONDS.sleep(10);\n\n}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br"),s("span",{staticClass:"line-number"},[a._v("23")]),s("br"),s("span",{staticClass:"line-number"},[a._v("24")]),s("br"),s("span",{staticClass:"line-number"},[a._v("25")]),s("br"),s("span",{staticClass:"line-number"},[a._v("26")]),s("br"),s("span",{staticClass:"line-number"},[a._v("27")]),s("br"),s("span",{staticClass:"line-number"},[a._v("28")]),s("br"),s("span",{staticClass:"line-number"},[a._v("29")]),s("br"),s("span",{staticClass:"line-number"},[a._v("30")]),s("br"),s("span",{staticClass:"line-number"},[a._v("31")]),s("br"),s("span",{staticClass:"line-number"},[a._v("32")]),s("br"),s("span",{staticClass:"line-number"},[a._v("33")]),s("br"),s("span",{staticClass:"line-number"},[a._v("34")]),s("br"),s("span",{staticClass:"line-number"},[a._v("35")]),s("br"),s("span",{staticClass:"line-number"},[a._v("36")]),s("br"),s("span",{staticClass:"line-number"},[a._v("37")]),s("br"),s("span",{staticClass:"line-number"},[a._v("38")]),s("br"),s("span",{staticClass:"line-number"},[a._v("39")]),s("br"),s("span",{staticClass:"line-number"},[a._v("40")]),s("br"),s("span",{staticClass:"line-number"},[a._v("41")]),s("br"),s("span",{staticClass:"line-number"},[a._v("42")]),s("br"),s("span",{staticClass:"line-number"},[a._v("43")]),s("br"),s("span",{staticClass:"line-number"},[a._v("44")]),s("br"),s("span",{staticClass:"line-number"},[a._v("45")]),s("br"),s("span",{staticClass:"line-number"},[a._v("46")]),s("br"),s("span",{staticClass:"line-number"},[a._v("47")]),s("br"),s("span",{staticClass:"line-number"},[a._v("48")]),s("br"),s("span",{staticClass:"line-number"},[a._v("49")]),s("br"),s("span",{staticClass:"line-number"},[a._v("50")]),s("br"),s("span",{staticClass:"line-number"},[a._v("51")]),s("br"),s("span",{staticClass:"line-number"},[a._v("52")]),s("br"),s("span",{staticClass:"line-number"},[a._v("53")]),s("br"),s("span",{staticClass:"line-number"},[a._v("54")]),s("br"),s("span",{staticClass:"line-number"},[a._v("55")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("h4",{attrs:{id:"声明式事务实现-globaltransactional"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#声明式事务实现-globaltransactional"}},[a._v("#")]),a._v(" 声明式事务实现（@GlobalTransactional）")]),a._v(" "),s("p",[a._v("业务场景：")]),a._v(" "),s("p",[a._v("用户下单，整个业务逻辑由三个服务构成：")]),a._v(" "),s("ul",[s("li",[a._v("仓储服务：对给定的商品扣除库存数量。")]),a._v(" "),s("li",[a._v("订单服务：根据采购需求创建订单。")]),a._v(" "),s("li",[a._v("帐户服务：从用户帐户中扣除余额。")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140716809.png",alt:"image-20220623140716809"}})]),a._v(" "),s("p",[s("strong",[a._v("多数据源场景")])]),a._v(" "),s("p",[a._v('\\1. 启动seata server服务，指定registry.type="file" , config.type="file"')]),a._v(" "),s("p",[a._v("\\2. 客户端应用接入seata配置")]),a._v(" "),s("p",[a._v("1）配置多数据源")]),a._v(" "),s("p",[a._v("客户端支持多数据源，yml中添加多数据源jdbc配置")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("# Order\nspring.datasource.order.url=jdbc:mysql://localhost:3306/seata_order?useUnicode=true&characterEncoding=utf8&allowMultiQueries=true&useSSL=false&serverTimezone=UTC\nspring.datasource.order.username=root\nspring.datasource.order.password=root\nspring.datasource.order.driver-class-name=com.mysql.cj.jdbc.Driver\n# Storage\nspring.datasource.storage.url=jdbc:mysql://localhost:3306/seata_storage?useUnicode=true&characterEncoding=utf8&allowMultiQueries=true&useSSL=false&serverTimezone=UTC\nspring.datasource.storage.username=root\nspring.datasource.storage.password=root\nspring.datasource.storage.driver-class-name=com.mysql.cj.jdbc.Driver\n# Account\nspring.datasource.account.url=jdbc:mysql://localhost:3306/seata_account?useUnicode=true&characterEncoding=utf8&allowMultiQueries=true&useSSL=false&serverTimezone=UTC\nspring.datasource.account.username=root\nspring.datasource.account.password=root\nspring.datasource.account.driver-class-name=com.mysql.cj.jdbc.Driver\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br")])]),s("p",[a._v("2）配置多数据源代理，并支持动态切换数据源")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('@Configuration\n@MapperScan("com.tuling.mutiple.datasource.mapper")\npublic class DataSourceProxyConfig {\n\n    @Bean("originOrder")\n    @ConfigurationProperties(prefix = "spring.datasource.order")\n    public DataSource dataSourceMaster() {\n        return new DruidDataSource();\n    }\n\n    @Bean("originStorage")\n    @ConfigurationProperties(prefix = "spring.datasource.storage")\n    public DataSource dataSourceStorage() {\n        return new DruidDataSource();\n    }\n\n    @Bean("originAccount")\n    @ConfigurationProperties(prefix = "spring.datasource.account")\n    public DataSource dataSourceAccount() {\n        return new DruidDataSource();\n    }\n\n    @Bean(name = "order")\n    public DataSourceProxy masterDataSourceProxy(@Qualifier("originOrder") DataSource dataSource) {\n        return new DataSourceProxy(dataSource);\n    }\n\n    @Bean(name = "storage")\n    public DataSourceProxy storageDataSourceProxy(@Qualifier("originStorage") DataSource dataSource) {\n        return new DataSourceProxy(dataSource);\n    }\n\n    @Bean(name = "account")\n    public DataSourceProxy payDataSourceProxy(@Qualifier("originAccount") DataSource dataSource) {\n        return new DataSourceProxy(dataSource);\n    }\n\n    @Bean("dynamicDataSource")\n    public DataSource dynamicDataSource(@Qualifier("order") DataSource dataSourceOrder,\n                                        @Qualifier("storage") DataSource dataSourceStorage,\n                                        @Qualifier("account") DataSource dataSourcePay) {\n\n        DynamicRoutingDataSource dynamicRoutingDataSource = new DynamicRoutingDataSource();\n\n        // 数据源的集合\n        Map<Object, Object> dataSourceMap = new HashMap<>(3);\n        dataSourceMap.put(DataSourceKey.ORDER.name(), dataSourceOrder);\n        dataSourceMap.put(DataSourceKey.STORAGE.name(), dataSourceStorage);\n        dataSourceMap.put(DataSourceKey.ACCOUNT.name(), dataSourcePay);\n\n        dynamicRoutingDataSource.setDefaultTargetDataSource(dataSourceOrder);\n        dynamicRoutingDataSource.setTargetDataSources(dataSourceMap);\n\n        DynamicDataSourceContextHolder.getDataSourceKeys().addAll(dataSourceMap.keySet());\n\n        return dynamicRoutingDataSource;\n    }\n\n    @Bean\n    @ConfigurationProperties(prefix = "mybatis")\n    public SqlSessionFactoryBean sqlSessionFactoryBean(@Qualifier("dynamicDataSource") DataSource dataSource) {\n        SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean();\n        sqlSessionFactoryBean.setDataSource(dataSource);\n        return sqlSessionFactoryBean;\n    }\n\n}\n\n@Slf4j\npublic class DynamicRoutingDataSource extends AbstractRoutingDataSource {\n\n    @Override\n    protected Object determineCurrentLookupKey() {\n        log.info("当前数据源 [{}]", DynamicDataSourceContextHolder.getDataSourceKey());\n        return DynamicDataSourceContextHolder.getDataSourceKey();\n    }\n}\n\npublic class DynamicDataSourceContextHolder {\n\n    private static final ThreadLocal<String> CONTEXT_HOLDER = ThreadLocal.withInitial(DataSourceKey.ORDER::name);\n\n    private static List<Object> dataSourceKeys = new ArrayList<>();\n\n    public static void setDataSourceKey(DataSourceKey key) {\n        CONTEXT_HOLDER.set(key.name());\n    }\n\n    public static String getDataSourceKey() {\n        return CONTEXT_HOLDER.get();\n    }\n\n    public static void clearDataSourceKey() {\n        CONTEXT_HOLDER.remove();\n    }\n\n    public static List<Object> getDataSourceKeys() {\n        return dataSourceKeys;\n    }\n}\n\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br"),s("span",{staticClass:"line-number"},[a._v("23")]),s("br"),s("span",{staticClass:"line-number"},[a._v("24")]),s("br"),s("span",{staticClass:"line-number"},[a._v("25")]),s("br"),s("span",{staticClass:"line-number"},[a._v("26")]),s("br"),s("span",{staticClass:"line-number"},[a._v("27")]),s("br"),s("span",{staticClass:"line-number"},[a._v("28")]),s("br"),s("span",{staticClass:"line-number"},[a._v("29")]),s("br"),s("span",{staticClass:"line-number"},[a._v("30")]),s("br"),s("span",{staticClass:"line-number"},[a._v("31")]),s("br"),s("span",{staticClass:"line-number"},[a._v("32")]),s("br"),s("span",{staticClass:"line-number"},[a._v("33")]),s("br"),s("span",{staticClass:"line-number"},[a._v("34")]),s("br"),s("span",{staticClass:"line-number"},[a._v("35")]),s("br"),s("span",{staticClass:"line-number"},[a._v("36")]),s("br"),s("span",{staticClass:"line-number"},[a._v("37")]),s("br"),s("span",{staticClass:"line-number"},[a._v("38")]),s("br"),s("span",{staticClass:"line-number"},[a._v("39")]),s("br"),s("span",{staticClass:"line-number"},[a._v("40")]),s("br"),s("span",{staticClass:"line-number"},[a._v("41")]),s("br"),s("span",{staticClass:"line-number"},[a._v("42")]),s("br"),s("span",{staticClass:"line-number"},[a._v("43")]),s("br"),s("span",{staticClass:"line-number"},[a._v("44")]),s("br"),s("span",{staticClass:"line-number"},[a._v("45")]),s("br"),s("span",{staticClass:"line-number"},[a._v("46")]),s("br"),s("span",{staticClass:"line-number"},[a._v("47")]),s("br"),s("span",{staticClass:"line-number"},[a._v("48")]),s("br"),s("span",{staticClass:"line-number"},[a._v("49")]),s("br"),s("span",{staticClass:"line-number"},[a._v("50")]),s("br"),s("span",{staticClass:"line-number"},[a._v("51")]),s("br"),s("span",{staticClass:"line-number"},[a._v("52")]),s("br"),s("span",{staticClass:"line-number"},[a._v("53")]),s("br"),s("span",{staticClass:"line-number"},[a._v("54")]),s("br"),s("span",{staticClass:"line-number"},[a._v("55")]),s("br"),s("span",{staticClass:"line-number"},[a._v("56")]),s("br"),s("span",{staticClass:"line-number"},[a._v("57")]),s("br"),s("span",{staticClass:"line-number"},[a._v("58")]),s("br"),s("span",{staticClass:"line-number"},[a._v("59")]),s("br"),s("span",{staticClass:"line-number"},[a._v("60")]),s("br"),s("span",{staticClass:"line-number"},[a._v("61")]),s("br"),s("span",{staticClass:"line-number"},[a._v("62")]),s("br"),s("span",{staticClass:"line-number"},[a._v("63")]),s("br"),s("span",{staticClass:"line-number"},[a._v("64")]),s("br"),s("span",{staticClass:"line-number"},[a._v("65")]),s("br"),s("span",{staticClass:"line-number"},[a._v("66")]),s("br"),s("span",{staticClass:"line-number"},[a._v("67")]),s("br"),s("span",{staticClass:"line-number"},[a._v("68")]),s("br"),s("span",{staticClass:"line-number"},[a._v("69")]),s("br"),s("span",{staticClass:"line-number"},[a._v("70")]),s("br"),s("span",{staticClass:"line-number"},[a._v("71")]),s("br"),s("span",{staticClass:"line-number"},[a._v("72")]),s("br"),s("span",{staticClass:"line-number"},[a._v("73")]),s("br"),s("span",{staticClass:"line-number"},[a._v("74")]),s("br"),s("span",{staticClass:"line-number"},[a._v("75")]),s("br"),s("span",{staticClass:"line-number"},[a._v("76")]),s("br"),s("span",{staticClass:"line-number"},[a._v("77")]),s("br"),s("span",{staticClass:"line-number"},[a._v("78")]),s("br"),s("span",{staticClass:"line-number"},[a._v("79")]),s("br"),s("span",{staticClass:"line-number"},[a._v("80")]),s("br"),s("span",{staticClass:"line-number"},[a._v("81")]),s("br"),s("span",{staticClass:"line-number"},[a._v("82")]),s("br"),s("span",{staticClass:"line-number"},[a._v("83")]),s("br"),s("span",{staticClass:"line-number"},[a._v("84")]),s("br"),s("span",{staticClass:"line-number"},[a._v("85")]),s("br"),s("span",{staticClass:"line-number"},[a._v("86")]),s("br"),s("span",{staticClass:"line-number"},[a._v("87")]),s("br"),s("span",{staticClass:"line-number"},[a._v("88")]),s("br"),s("span",{staticClass:"line-number"},[a._v("89")]),s("br"),s("span",{staticClass:"line-number"},[a._v("90")]),s("br"),s("span",{staticClass:"line-number"},[a._v("91")]),s("br"),s("span",{staticClass:"line-number"},[a._v("92")]),s("br"),s("span",{staticClass:"line-number"},[a._v("93")]),s("br"),s("span",{staticClass:"line-number"},[a._v("94")]),s("br"),s("span",{staticClass:"line-number"},[a._v("95")]),s("br"),s("span",{staticClass:"line-number"},[a._v("96")]),s("br"),s("span",{staticClass:"line-number"},[a._v("97")]),s("br"),s("span",{staticClass:"line-number"},[a._v("98")]),s("br"),s("span",{staticClass:"line-number"},[a._v("99")]),s("br"),s("span",{staticClass:"line-number"},[a._v("100")]),s("br"),s("span",{staticClass:"line-number"},[a._v("101")]),s("br")])]),s("p",[a._v("3）接入seata配置")]),a._v(" "),s("p",[a._v('registry.conf中指定registry.type="file" , config.type="file" ,对应seata-server的registry.conf配置相同')]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('registry {\n  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa\n  type = "file"\n\n  file {\n    name = "file.conf"\n  }\n}\n\nconfig {\n  # file、nacos 、apollo、zk、consul、etcd3、springCloudConfig\n  type = "file"\n\n  file {\n    name = "file.conf"\n  }\n}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("4）指定seata事务分组，用于获取seata server服务实例")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("# Seata事务分组  从file.conf获取service.vgroupMapping.my_test_tx_group的集群名称default，用于确定seata server的服务实例\nspring.cloud.alibaba.seata.tx-service-group=my_test_tx_group\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("5）OrderServiceImpl作为发起者配置@GlobalTransactional注解")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('@Override\n//@Transactional\n@GlobalTransactional(name="createOrder")\npublic Order saveOrder(OrderVo orderVo){\n    log.info("=============用户下单=================");\n    //切换数据源\n    DynamicDataSourceContextHolder.setDataSourceKey(DataSourceKey.ORDER);\n    log.info("当前 XID: {}", RootContext.getXID());\n    \n    // 保存订单\n    Order order = new Order();\n    order.setUserId(orderVo.getUserId());\n    order.setCommodityCode(orderVo.getCommodityCode());\n    order.setCount(orderVo.getCount());\n    order.setMoney(orderVo.getMoney());\n    order.setStatus(OrderStatus.INIT.getValue());\n\n    Integer saveOrderRecord = orderMapper.insert(order);\n    log.info("保存订单{}", saveOrderRecord > 0 ? "成功" : "失败");\n    \n    //扣减库存\n    storageService.deduct(orderVo.getCommodityCode(),orderVo.getCount());\n    \n    //扣减余额\n    accountService.debit(orderVo.getUserId(),orderVo.getMoney());\n\n    log.info("=============更新订单状态=================");\n    //切换数据源\n    DynamicDataSourceContextHolder.setDataSourceKey(DataSourceKey.ORDER);\n    //更新订单\n    Integer updateOrderRecord = orderMapper.updateOrderStatus(order.getId(),OrderStatus.SUCCESS.getValue());\n    log.info("更新订单id:{} {}", order.getId(), updateOrderRecord > 0 ? "成功" : "失败");\n    \n    return order;\n    \n}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br"),s("span",{staticClass:"line-number"},[a._v("23")]),s("br"),s("span",{staticClass:"line-number"},[a._v("24")]),s("br"),s("span",{staticClass:"line-number"},[a._v("25")]),s("br"),s("span",{staticClass:"line-number"},[a._v("26")]),s("br"),s("span",{staticClass:"line-number"},[a._v("27")]),s("br"),s("span",{staticClass:"line-number"},[a._v("28")]),s("br"),s("span",{staticClass:"line-number"},[a._v("29")]),s("br"),s("span",{staticClass:"line-number"},[a._v("30")]),s("br"),s("span",{staticClass:"line-number"},[a._v("31")]),s("br"),s("span",{staticClass:"line-number"},[a._v("32")]),s("br"),s("span",{staticClass:"line-number"},[a._v("33")]),s("br"),s("span",{staticClass:"line-number"},[a._v("34")]),s("br"),s("span",{staticClass:"line-number"},[a._v("35")]),s("br"),s("span",{staticClass:"line-number"},[a._v("36")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("测试成功场景")]),a._v(" "),s("p",[a._v("调用 /order/createOrder 接口，将 money 设置为 10，此时余额为 20，可以下单成功")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140729049.png",alt:"image-20220623140729049"}})]),a._v(" "),s("p",[a._v("测试失败场景")]),a._v(" "),s("p",[a._v("设置 money 为 100，此时余额不足，会下单失败，account-service会抛出异常，事务会回滚")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140754228.png",alt:"image-20220623140754228"}})]),a._v(" "),s("p",[s("strong",[a._v("接入微服务应用")])]),a._v(" "),s("p",[a._v("业务场景：")]),a._v(" "),s("p",[a._v("用户下单，整个业务逻辑由三个微服务构成：")]),a._v(" "),s("ul",[s("li",[a._v("仓储服务：对给定的商品扣除库存数量。")]),a._v(" "),s("li",[a._v("订单服务：根据采购需求创建订单。")]),a._v(" "),s("li",[a._v("帐户服务：从用户帐户中扣除余额。")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140804838.png",alt:"image-20220623140804838"}})]),a._v(" "),s("p",[s("strong",[a._v("1）启动Seata server端，Seata server使用nacos作为配置中心和注册中心")])]),a._v(" "),s("p",[s("strong",[a._v("2）配置微服务整合seata")])]),a._v(" "),s("p",[s("strong",[a._v("第一步：添加pom依赖")])]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\x3c!-- seata--\x3e\n<dependency>\n    <groupId>com.alibaba.cloud</groupId>\n    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>\n    <exclusions>\n        <exclusion>\n            <groupId>io.seata</groupId>\n            <artifactId>seata-all</artifactId>\n        </exclusion>\n    </exclusions>\n</dependency>\n<dependency>\n    <groupId>io.seata</groupId>\n    <artifactId>seata-all</artifactId>\n    <version>1.4.0</version>\n</dependency>\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[s("strong",[a._v("第二步： 微服务对应数据库中添加undo_log表")])]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("CREATE TABLE `undo_log` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `branch_id` bigint(20) NOT NULL,\n  `xid` varchar(100) NOT NULL,\n  `context` varchar(128) NOT NULL,\n  `rollback_info` longblob NOT NULL,\n  `log_status` int(11) NOT NULL,\n  `log_created` datetime NOT NULL,\n  `log_modified` datetime NOT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)\n) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br")])]),s("p",[s("strong",[a._v("第三步：添加代理数据源配置，配置DataSourceProxy")])]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('/**\n * @author Fox\n *\n * 需要用到分布式事务的微服务都需要使用seata DataSourceProxy代理自己的数据源\n */\n@Configuration\n@MapperScan("com.tuling.datasource.mapper")\npublic class MybatisConfig {\n    \n    /**\n     * 从配置文件获取属性构造datasource，注意前缀，这里用的是druid，根据自己情况配置,\n     * 原生datasource前缀取"spring.datasource"\n     *\n     * @return\n     */\n    @Bean\n    @ConfigurationProperties(prefix = "spring.datasource.druid")\n    public DataSource druidDataSource() {\n        DruidDataSource druidDataSource = new DruidDataSource();\n        return druidDataSource;\n    }\n    \n    /**\n     * 构造datasource代理对象，替换原来的datasource\n     * @param druidDataSource\n     * @return\n     */\n    @Primary\n    @Bean("dataSource")\n    public DataSourceProxy dataSourceProxy(DataSource druidDataSource) {\n        return new DataSourceProxy(druidDataSource);\n    }\n    \n    \n    @Bean(name = "sqlSessionFactory")\n    public SqlSessionFactory sqlSessionFactoryBean(DataSourceProxy dataSourceProxy) throws Exception {\n        SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();\n        //设置代理数据源\n        factoryBean.setDataSource(dataSourceProxy);\n        ResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();\n        factoryBean.setMapperLocations(resolver.getResources("classpath*:mybatis/**/*-mapper.xml"));\n        \n        org.apache.ibatis.session.Configuration configuration=new org.apache.ibatis.session.Configuration();\n        //使用jdbc的getGeneratedKeys获取数据库自增主键值\n        configuration.setUseGeneratedKeys(true);\n        //使用列别名替换列名\n        configuration.setUseColumnLabel(true);\n        //自动使用驼峰命名属性映射字段，如userId ---\x3e user_id\n        configuration.setMapUnderscoreToCamelCase(true);\n        factoryBean.setConfiguration(configuration);\n        \n        return factoryBean.getObject();\n    }\n    \n}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br"),s("span",{staticClass:"line-number"},[a._v("23")]),s("br"),s("span",{staticClass:"line-number"},[a._v("24")]),s("br"),s("span",{staticClass:"line-number"},[a._v("25")]),s("br"),s("span",{staticClass:"line-number"},[a._v("26")]),s("br"),s("span",{staticClass:"line-number"},[a._v("27")]),s("br"),s("span",{staticClass:"line-number"},[a._v("28")]),s("br"),s("span",{staticClass:"line-number"},[a._v("29")]),s("br"),s("span",{staticClass:"line-number"},[a._v("30")]),s("br"),s("span",{staticClass:"line-number"},[a._v("31")]),s("br"),s("span",{staticClass:"line-number"},[a._v("32")]),s("br"),s("span",{staticClass:"line-number"},[a._v("33")]),s("br"),s("span",{staticClass:"line-number"},[a._v("34")]),s("br"),s("span",{staticClass:"line-number"},[a._v("35")]),s("br"),s("span",{staticClass:"line-number"},[a._v("36")]),s("br"),s("span",{staticClass:"line-number"},[a._v("37")]),s("br"),s("span",{staticClass:"line-number"},[a._v("38")]),s("br"),s("span",{staticClass:"line-number"},[a._v("39")]),s("br"),s("span",{staticClass:"line-number"},[a._v("40")]),s("br"),s("span",{staticClass:"line-number"},[a._v("41")]),s("br"),s("span",{staticClass:"line-number"},[a._v("42")]),s("br"),s("span",{staticClass:"line-number"},[a._v("43")]),s("br"),s("span",{staticClass:"line-number"},[a._v("44")]),s("br"),s("span",{staticClass:"line-number"},[a._v("45")]),s("br"),s("span",{staticClass:"line-number"},[a._v("46")]),s("br"),s("span",{staticClass:"line-number"},[a._v("47")]),s("br"),s("span",{staticClass:"line-number"},[a._v("48")]),s("br"),s("span",{staticClass:"line-number"},[a._v("49")]),s("br"),s("span",{staticClass:"line-number"},[a._v("50")]),s("br"),s("span",{staticClass:"line-number"},[a._v("51")]),s("br"),s("span",{staticClass:"line-number"},[a._v("52")]),s("br"),s("span",{staticClass:"line-number"},[a._v("53")]),s("br"),s("span",{staticClass:"line-number"},[a._v("54")]),s("br"),s("span",{staticClass:"line-number"},[a._v("55")]),s("br")])]),s("p",[s("strong",[a._v("第四步：启动类上剔除"),s("strong",[s("strong",[a._v("DataSourceAutoConfiguration")])]),a._v("，用于解决数据源的循环依赖问题")])]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('@SpringBootApplication(scanBasePackages = "com.tuling",exclude = DataSourceAutoConfiguration.class)\n@EnableFeignClients\npublic class OrderServiceApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(OrderServiceApplication.class, args);\n    }\n\n}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[s("strong",[a._v("第五步：修改register.conf,配置nacos作为registry.type&config.type，对应seata server也使用nacos")])]),a._v(" "),s("p",[a._v('注意：需要指定group = "SEATA_GROUP"，因为Seata Server端指定了group = "SEATA_GROUP" ，必须保证一致')]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('registry {\n  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa\n  type = "nacos"\n  \n  nacos {\n      serverAddr = "localhost"\n      namespace = ""\n      cluster = "default"\n      group = "SEATA_GROUP"\n  }\n}\nconfig {\n  # file、nacos 、apollo、zk、consul、etcd3、springCloudConfig\n  type = "nacos"\n\n  nacos {\n    serverAddr = "localhost"\n    namespace = ""\n    group = "SEATA_GROUP"\n  }\n}\n\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[a._v("如果出现这种问题：")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140815854.png",alt:"image-20220623140815854"}})]),a._v(" "),s("p",[a._v("一般大多数情况下都是因为配置不匹配导致的：")]),a._v(" "),s("p",[a._v("1.检查现在使用的seata服务和项目maven中seata的版本是否一致")]),a._v(" "),s("p",[a._v("2.检查tx-service-group，nacos.cluster，nacos.group参数是否和Seata Server中的配置一致")]),a._v(" "),s("p",[a._v("跟踪源码：seata/discover包下实现了RegistryService#lookup，用来获取服务列表")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("NacosRegistryServiceImpl#lookup\n》String clusterName = getServiceGroup(key);  #获取seata server集群名称\n》List<Instance> firstAllInstances = getNamingInstance().getAllInstances(getServiceName(), getServiceGroup(), clusters)\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[s("strong",[a._v("第六步：修改application.yml配置")])]),a._v(" "),s("p",[a._v("配置seata 服务事务分组，要与服务端nacos配置中心中service.vgroup_mapping的后缀对应")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("server:\n  port: 8020\n\nspring:\n  application:\n    name: order-service\n  cloud:\n    nacos:\n      discovery:\n        server-addr: 127.0.0.1:8848\n    alibaba:\n      seata:\n        tx-service-group:\n          my_test_tx_group # seata 服务事务分组\n\n  datasource:\n    type: com.alibaba.druid.pool.DruidDataSource\n    druid:\n      driver-class-name: com.mysql.cj.jdbc.Driver\n      url: jdbc:mysql://localhost:3306/seata_order?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai\n      username: root\n      password: root\n      initial-size: 10\n      max-active: 100\n      min-idle: 10\n      max-wait: 60000\n      pool-prepared-statements: true\n      max-pool-prepared-statement-per-connection-size: 20\n      time-between-eviction-runs-millis: 60000\n      min-evictable-idle-time-millis: 300000\n      test-while-idle: true\n      test-on-borrow: false\n      test-on-return: false\n      stat-view-servlet:\n        enabled: true\n        url-pattern: /druid/*\n      filter:\n        stat:\n          log-slow-sql: true\n          slow-sql-millis: 1000\n          merge-sql: false\n        wall:\n          config:\n            multi-statement-allow: true\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br"),s("span",{staticClass:"line-number"},[a._v("23")]),s("br"),s("span",{staticClass:"line-number"},[a._v("24")]),s("br"),s("span",{staticClass:"line-number"},[a._v("25")]),s("br"),s("span",{staticClass:"line-number"},[a._v("26")]),s("br"),s("span",{staticClass:"line-number"},[a._v("27")]),s("br"),s("span",{staticClass:"line-number"},[a._v("28")]),s("br"),s("span",{staticClass:"line-number"},[a._v("29")]),s("br"),s("span",{staticClass:"line-number"},[a._v("30")]),s("br"),s("span",{staticClass:"line-number"},[a._v("31")]),s("br"),s("span",{staticClass:"line-number"},[a._v("32")]),s("br"),s("span",{staticClass:"line-number"},[a._v("33")]),s("br"),s("span",{staticClass:"line-number"},[a._v("34")]),s("br"),s("span",{staticClass:"line-number"},[a._v("35")]),s("br"),s("span",{staticClass:"line-number"},[a._v("36")]),s("br"),s("span",{staticClass:"line-number"},[a._v("37")]),s("br"),s("span",{staticClass:"line-number"},[a._v("38")]),s("br"),s("span",{staticClass:"line-number"},[a._v("39")]),s("br"),s("span",{staticClass:"line-number"},[a._v("40")]),s("br"),s("span",{staticClass:"line-number"},[a._v("41")]),s("br"),s("span",{staticClass:"line-number"},[a._v("42")]),s("br"),s("span",{staticClass:"line-number"},[a._v("43")]),s("br"),s("span",{staticClass:"line-number"},[a._v("44")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[s("strong",[a._v("第七步：微服务发起者（TM 方）需要添加@GlobalTransactional注解")])]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('@Override\n//@Transactional\n@GlobalTransactional(name="createOrder")\npublic Order saveOrder(OrderVo orderVo){\n    log.info("=============用户下单=================");\n    log.info("当前 XID: {}", RootContext.getXID());\n    \n    // 保存订单\n    Order order = new Order();\n    order.setUserId(orderVo.getUserId());\n    order.setCommodityCode(orderVo.getCommodityCode());\n    order.setCount(orderVo.getCount());\n    order.setMoney(orderVo.getMoney());\n    order.setStatus(OrderStatus.INIT.getValue());\n\n    Integer saveOrderRecord = orderMapper.insert(order);\n    log.info("保存订单{}", saveOrderRecord > 0 ? "成功" : "失败");\n    \n    //扣减库存\n    storageFeignService.deduct(orderVo.getCommodityCode(),orderVo.getCount());\n    \n    //扣减余额\n    accountFeignService.debit(orderVo.getUserId(),orderVo.getMoney());\n\n    //更新订单\n    Integer updateOrderRecord = orderMapper.updateOrderStatus(order.getId(),OrderStatus.SUCCESS.getValue());\n    log.info("更新订单id:{} {}", order.getId(), updateOrderRecord > 0 ? "成功" : "失败");\n    \n    return order;\n    \n}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br"),s("span",{staticClass:"line-number"},[a._v("23")]),s("br"),s("span",{staticClass:"line-number"},[a._v("24")]),s("br"),s("span",{staticClass:"line-number"},[a._v("25")]),s("br"),s("span",{staticClass:"line-number"},[a._v("26")]),s("br"),s("span",{staticClass:"line-number"},[a._v("27")]),s("br"),s("span",{staticClass:"line-number"},[a._v("28")]),s("br"),s("span",{staticClass:"line-number"},[a._v("29")]),s("br"),s("span",{staticClass:"line-number"},[a._v("30")]),s("br"),s("span",{staticClass:"line-number"},[a._v("31")]),s("br")])]),s("p",[a._v("​")]),a._v(" "),s("p",[s("strong",[a._v("测试")])]),a._v(" "),s("p",[a._v("分布式事务成功，模拟正常下单、扣库存，扣余额")]),a._v(" "),s("p",[a._v("分布式事务失败，模拟下单扣库存成功、扣余额失败，事务是否回滚")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623140843428.png",alt:"image-20220623140843428"}})]),a._v(" "),s("h2",{attrs:{id:"图片附录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#图片附录"}},[a._v("#")]),a._v(" 图片附录")]),a._v(" "),s("h3",{attrs:{id:"seata-工作原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#seata-工作原理"}},[a._v("#")]),a._v(" Seata 工作原理")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/Seata%20%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.jpg",alt:"Seata 工作原理"}})]),a._v(" "),s("h3",{attrs:{id:"seata源码分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#seata源码分析"}},[a._v("#")]),a._v(" Seata源码分析")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/Seata%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.jpg",alt:"Seata源码分析"}})])])}),[],!1,null,null,null);s.default=t.exports}}]);
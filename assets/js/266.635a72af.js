(window.webpackJsonp=window.webpackJsonp||[]).push([[266],{609:function(s,n,e){"use strict";e.r(n);var a=e(1),t=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("U2FsdGVkX1+ZHv7L1HoxcXtRUbQqpS6cpzCDEns0IFAIhdfQAgpWenTAQpvEDbLR\nWiLxWSDCbpy2lw9+ymjh19BATLtesK8rzi3sg1XwcuvrIg==\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("学习本课程基础：")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("熟悉gateway网关使用。")])]),s._v(" "),n("li",[n("strong",[s._v("熟悉nginx使用。")])]),s._v(" "),n("li",[n("strong",[s._v("熟悉sentinel的应用，会涉及网关规则持久化改造。")])])]),s._v(" "),n("p",[s._v("这节课实战部分跟不上的同学可以补一下之前的微服务gateway网关和Sentinel的课程")]),s._v(" "),n("p",[s._v("运行阶段系统稳定性")]),s._v(" "),n("p",[n("strong",[s._v("1. 秒杀场景介绍")])]),s._v(" "),n("p",[n("strong",[s._v("1.1 秒杀场景的特点")])]),s._v(" "),n("p",[s._v("1）"),n("strong",[s._v("秒杀具有瞬时高并发的特点")]),s._v("，秒杀请求在时间上高度集中于某一特定的时间点（秒杀开始那一秒），这样一来，就会导致一个特别高的流量峰值，它对资源的消耗是瞬时的。")]),s._v(" "),n("p",[s._v("2）但是对秒杀这个场景来说，最终能够抢到商品的人数是固定的，也就是说 100 人和 10000 人发起请求的结果都是一样的，"),n("strong",[s._v("并发度越高，无效请求也越多")]),s._v("。")]),s._v(" "),n("p",[s._v("3）但是"),n("strong",[s._v("从业务上来说，秒杀活动是希望更多的人来参与的")]),s._v("，也就是开始之前希望有更多的人来刷页面，但是真正开始下单时，秒杀请求并不是越多越好。")]),s._v(" "),n("p",[n("strong",[s._v("1.2 流量消峰")])]),s._v(" "),n("p",[s._v("服务器的处理资源是恒定的，你用或者不用它的处理能力都是一样的，所以出现峰值的话，很容易导致忙到处理不过来，闲的时候却又没有什么要处理。流量削峰，一是可以让服务端处理变得更加平稳，二是可以节省服务器的资源成本。针对秒杀这一场景，削峰从本质上来说就是更多地延缓用户请求的发出，以便减少和过滤掉一些无效请求，它遵从“请求数要尽量少”的原则。流量削峰的比较常见的思路：排队、答题、分层过滤。")]),s._v(" "),n("p",[n("strong",[s._v("1.3 兜底方案")])]),s._v(" "),n("p",[s._v("对于很多秒杀系统而言，在诸如双十一这样的大流量的迅猛冲击下，都曾经或多或少发生过宕机的情况。当一个系统面临持续的大流量时，它其实很难单靠自身调整来恢复状态，你必须等待流量自然下降或者人为地把流量切走才行，这无疑会严重影响用户的购物体验。")]),s._v(" "),n("p",[s._v("我们可以在系统达到不可用状态之前就做好流量限制，防止最坏情况的发生。针对秒杀系统，在遇到大流量时，更多考虑的是运行阶段如何保障系统的稳定运行，常用的手段：限流，降级，拒绝服务。")]),s._v(" "),n("p",[n("strong",[s._v("2. 限流实战")])]),s._v(" "),n("p",[s._v("限流相对降级是一种更极端的保存措施，限流就是当系统容量达到瓶颈时，我们需要通过限制一部分流量来保护系统，并做到既可以人工执行开关，也支持自动化保护的措施。")]),s._v(" "),n("p",[s._v("限流既可以是在客户端限流，也可以是在服务端限流。限流的实现方式既要支持 URL 以及方法级别的限流，也要支持基于 QPS 和线程的限流。")]),s._v(" "),n("p",[n("strong",[s._v("客户端限流")])]),s._v(" "),n("p",[s._v("好处：可以限制请求的发出，通过减少发出无用请求从而减少对系统的消耗。")]),s._v(" "),n("p",[s._v("缺点：当客户端比较分散时，没法设置合理的限流阈值：如果阈值设的太小，会导致服务端没有达到瓶颈时客户端已经被限制；而如果设的太大，则起不到限制的作用。")]),s._v(" "),n("p",[n("strong",[s._v("服务端限流")])]),s._v(" "),n("p",[s._v("好处：可以根据服务端的性能设置合理的阈值")]),s._v(" "),n("p",[s._v("缺点：被限制的请求都是无效的请求，处理这些无效的请求本身也会消耗服务器资源。")]),s._v(" "),n("p",[s._v("在限流的实现手段上来讲，基于 QPS 和线程数的限流应用最多，最大 QPS 很容易通过压测提前获取，例如我们的系统最高支持 1w QPS 时，可以设置 8000 来进行限流保护。线程数限流在客户端比较有效，例如在远程调用时我们设置连接池的线程数，超出这个并发线程请求，就将线程进行排队或者直接超时丢弃。")]),s._v(" "),n("p",[s._v("限流必然会导致一部分用户请求失败，因此在系统处理这种异常时一定要设置超时时间，防止因被限流的请求不能 fast fail（快速失败）而拖垮系统。")]),s._v(" "),n("p",[n("strong",[s._v("限流的方案")])]),s._v(" "),n("ul",[n("li",[s._v("前端限流")]),s._v(" "),n("li",[s._v("接入层nginx限流")]),s._v(" "),n("li",[s._v("网关限流")]),s._v(" "),n("li",[s._v("应用层限流")])]),s._v(" "),n("p",[n("strong",[s._v("2.1 nginx限流")])]),s._v(" "),n("p",[s._v("https://nginx.org/en/docs/")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203046145.png",alt:"image-20220623203046145"}})]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# window下nginx强制关闭命令\ntaskkill /fi "imagename eq nginx.EXE" /f\n# 启动nginx\nstart nginx.exe\n# 重新加载配置\nnginx.exe -s reload\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[n("strong",[s._v("limit_conn_zone&limit_conn")])]),s._v(" "),n("p",[s._v("ngx_http_limit_conn_module 可以对于一些服务器流量异常、负载过大，甚至是大流量的恶意攻击访问等，进行并发数的限制；该模块可以根据定义的键来限制每个键值的连接数，只有那些正在被处理的请求（这些请求的头信息已被完全读入）所在的连接才会被计数。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 限制连接数\nlimit_conn_zone $binary_remote_addr zone=addr:10m;\n\nserver {\n    location /download/ {\n        # 指定每个给定键值的最大同时连接数，同一IP同一时间只允许有1个连接\n        limit_conn addr 1;\n    }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("blockquote",[n("p",[s._v("客户端的IP地址作为键。")]),s._v(" "),n("p",[s._v("binary_remote_addr变量的长度是固定的4字节，存储状态在32位平台中占用32字节或64字节，在64位平台中占用64字节。")]),s._v(" "),n("p",[s._v("1M共享空间可以保存3.2万个32位的状态，1.6万个64位的状态。")]),s._v(" "),n("p",[s._v("如果共享内存空间被耗尽，服务器将会对后续所有的请求返回 503 (Service Temporarily Unavailable) 错误。")])]),s._v(" "),n("p",[s._v("缺陷： 前端做LVS或反向代理，会出现大量的503错误，需要设置白名单（对某些ip不做限制）")]),s._v(" "),n("p",[s._v("测试： http://localhost/pms/productInfo/29")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203055751.png",alt:"image-20220623203055751"}})]),s._v(" "),n("p",[n("strong",[s._v("limit_req_zone&limit_req")])]),s._v(" "),n("p",[s._v("通过ngx_http_limit_req_module 模块可以通过定义的键值来限制请求处理的频率。特别的，可以限制来自单个IP地址的请求处理频率。 限制的方法如同漏斗，每秒固定处理请求数，推迟过多请求。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("http {\n    # 限制请求数，大小为10m, 平均处理的频率不能超过每秒1次\n    limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;\n\n    ...\n\n    server {\n\n        ...\n\n        location /search/ {\n            # 允许超出频率限制的请求数为5，默认会被延迟处理，如果不希望延迟处理，可以使用nodelay参数\n            limit_req zone=one burst=5 nodelay;\n        }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("区域名称为one，大小为10m，平均处理的请求频率不能超过每秒一次。键值是客户端IP。")]),s._v(" "),n("p",[s._v("使用$binary_remote_addr变量，可以将每条状态记录的大小减少到64个字节，这样1M的内存可以保存大约1万6千个64字节的记录")]),s._v(" "),n("p",[s._v("如果限制域的存储空间耗尽了，对于后续所有请求，服务器都会返回503（Service Temporarily Unavailable）错误")]),s._v(" "),n("p",[s._v("速度可以设置为每秒处理请求数和每分钟处理请求数，其值必须是整数，所以如果你需要每秒处理少于1个的请求，2秒处理一个请求，可以使用30r/m")]),s._v(" "),n("p",[s._v("测试：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203105082.png",alt:"image-20220623203105082"}})]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203112252.png",alt:"image-20220623203112252"}})]),s._v(" "),n("p",[n("strong",[s._v("利用Lua限流")])]),s._v(" "),n("p",[s._v("https://github.com/openresty/lua-resty-limit-traffic")]),s._v(" "),n("p",[n("strong",[s._v("2.2 网关限流")])]),s._v(" "),n("p",[s._v("自己实现： GlobalFilter")]),s._v(" "),n("p",[s._v("spring cloud gateway接入Sentinel实现限流的原理：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203120972.png",alt:"image-20220623203120972"}})]),s._v(" "),n("p",[n("strong",[s._v("2.2.1 网关接入sentinel控制台")])]),s._v(" "),n("p",[s._v("建议sentinel 控制台和微服务sentinel版本一一对应，否则可能出现兼容性问题导致规则配置失效")]),s._v(" "),n("p",[s._v("引入依赖")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\x3c!--添加Sentinel的依赖--\x3e\n<dependency>\n    <groupId>com.alibaba.cloud</groupId>\n    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>\n</dependency>\n\n\x3c!-- gateway接入sentinel  --\x3e\n<dependency>\n    <groupId>com.alibaba.cloud</groupId>\n    <artifactId>spring-cloud-alibaba-sentinel-gateway</artifactId>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("接入sentinel控制台，修改application.yml配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n  application:\n    name: tulingmall-gateway\n  main:\n    allow-bean-definition-overriding: true\n  cloud:\n    sentinel:\n      transport:\n        dashboard: 127.0.0.1:8000\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("启动sentinel控制台")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("java  -Dserver.port=8000 -Dsentinel.nacos.config.serverAddr=tl.nacos.com:8848 -jar sentinel-dashboard-1.7.1.jar\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("网关接入控制台后界面展示：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203130679.png",alt:"image-20220623203130679"}})]),s._v(" "),n("p",[n("strong",[s._v("Sentinel1.7.1版本，gateway网关规则不生效的问题")])]),s._v(" "),n("p",[s._v("根本原因： SlotChain中没有添加GatewayFlowSlot ，默认生效的是HotParamSlotChainBuilder")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203139240.png",alt:"image-20220623203139240"}})]),s._v(" "),n("p",[s._v("解决思路： 使用GatewaySlotChainBuilder，将GatewayFlowSlot加入到SlotChain")]),s._v(" "),n("p",[s._v("可以利用SPI实现：在当前微服务添加GatewaySlotChainBuilder的spi文件")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203147369.png",alt:"image-20220623203147369"}})]),s._v(" "),n("p",[s._v("Sentinel1.8.0 中SlotChain处理策略，统一在DefaultSlotChainBuilder中处理了")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203155819.png",alt:"image-20220623203155819"}})]),s._v(" "),n("p",[n("strong",[s._v("2.2.2 Sentinel规则持久化配置")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203204133.png",alt:"image-20220623203204133"}})]),s._v(" "),n("p",[s._v("引入依赖")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<dependency>\n    <groupId>com.alibaba.csp</groupId>\n    <artifactId>sentinel-datasource-nacos</artifactId>\n</dependency>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("application.yml添加datasource配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("spring:\n  cloud:\n    sentinel:\n      transport:\n        # 添加sentinel的控制台地址\n        dashboard: 127.0.0.1:8000\n      datasource:     \n        gateway-flow-rules:\n          nacos:\n            server-addr: 127.0.0.1:8848\n            dataId: ${spring.application.name}-gateway-flow-rules\n            groupId: SENTINEL_GROUP\n            data-type: json\n            rule-type: gw-flow\n        gateway-api-rules:\n          nacos:\n            server-addr: 127.0.0.1:8848\n            dataId: ${spring.application.name}-gateway-api-rules\n            groupId: SENTINEL_GROUP\n            data-type: json\n            rule-type: gw-api-group\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[s._v("启动持久化改造后的sentinel dashboard")]),s._v(" "),n("p",[s._v("指定端口和nacos配置中心地址")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("java  -Dserver.port=8000 -Dsentinel.nacos.config.serverAddr=tl.nacos.com:8848 -jar tuling-sentinel-dashboard.jar\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[n("strong",[s._v("注意：网关规则改造的坑")])]),s._v(" "),n("p",[n("strong",[s._v("1. 网关规则实体转换")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("RuleEntity---》Rule  利用RuleEntity#toRule\n#网关规则实体\nApiDefinitionEntity---》ApiDefinition   利用ApiDefinitionEntity#toApiDefinition\nGatewayFlowRuleEntity-----\x3eGatewayFlowRule   利用GatewayFlowRuleEntity#toGatewayFlowRule\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[n("strong",[s._v("2. json解析丢失数据")])]),s._v(" "),n("p",[s._v("json解析ApiDefinition类型出现数据丢失的现象    天坑")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203215861.png",alt:"image-20220623203215861"}})]),s._v(" "),n("p",[s._v("排查原因：  "),n("em",[s._v("ApiDefinition"),n("strong",[s._v("的属性")]),s._v("Set predicateItems**中元素 是接口类型，"),n("strong",[s._v("JSON")]),s._v("解析丢失数据")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203224276.png",alt:"image-20220623203224276"}})]),s._v(" "),n("p",[s._v("解决方案：重写实体类ApiDefinition2,再转换为ApiDefinition")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("//GatewayApiRuleNacosProvider.java\n\n@Override\npublic List<ApiDefinitionEntity> getRules(String appName,String ip,Integer port) throws Exception {\n    String rules = configService.getConfig(appName + NacosConfigUtil.GATEWAY_API_DATA_ID_POSTFIX,\n            NacosConfigUtil.GROUP_ID, NacosConfigUtil.READ_TIMEOUT);\n    if (StringUtil.isEmpty(rules)) {\n        return new ArrayList<>();\n    }\n    \n    // 注意 ApiDefinition的属性Set<ApiPredicateItem> predicateItems中元素 是接口类型，JSON解析丢失数据\n    // 重写实体类ApiDefinition2,再转换为ApiDefinition\n    List<ApiDefinition2> list = JSON.parseArray(rules, ApiDefinition2.class);\n    \n    return list.stream().map(rule ->\n            ApiDefinitionEntity.fromApiDefinition(appName, ip, port, rule.toApiDefinition()))\n            .collect(Collectors.toList());\n}\n\n\npublic class ApiDefinition2 {\n    private String apiName;\n    private Set<ApiPathPredicateItem> predicateItems;\n    \n    public ApiDefinition2() {\n    }\n    \n    public String getApiName() {\n        return apiName;\n    }\n    \n    public void setApiName(String apiName) {\n        this.apiName = apiName;\n    }\n    \n    public Set<ApiPathPredicateItem> getPredicateItems() {\n        return predicateItems;\n    }\n    \n    public void setPredicateItems(Set<ApiPathPredicateItem> predicateItems) {\n        this.predicateItems = predicateItems;\n    }\n    \n    @Override\n    public String toString() {\n        return \"ApiDefinition2{\" + \"apiName='\" + apiName + '\\'' + \", predicateItems=\" + predicateItems + '}';\n    }\n    \n    \n    public ApiDefinition toApiDefinition() {\n        ApiDefinition apiDefinition = new ApiDefinition();\n        apiDefinition.setApiName(apiName);\n        \n        Set<ApiPredicateItem> apiPredicateItems = new LinkedHashSet<>();\n        apiDefinition.setPredicateItems(apiPredicateItems);\n        \n        if (predicateItems != null) {\n            for (ApiPathPredicateItem predicateItem : predicateItems) {\n                apiPredicateItems.add(predicateItem);\n            }\n        }\n        \n        return apiDefinition;\n    }\n    \n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br")])]),n("p",[s._v("从 1.6.0 版本开始，Sentinel 提供了 Spring Cloud Gateway 的适配模块，可以提供两种资源维度的限流：")]),s._v(" "),n("ul",[n("li",[s._v("route 维度：即在 Spring 配置文件中配置的路由条目，资源名为对应的 routeId")]),s._v(" "),n("li",[s._v("自定义 API 维度：用户可以利用 Sentinel 提供的 API 来自定义一些 API 分组")])]),s._v(" "),n("p",[n("strong",[s._v("route维度限流")])]),s._v(" "),n("p",[s._v("配置流控规则")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203234895.png",alt:"image-20220623203234895"}})]),s._v(" "),n("p",[s._v("测试：  http://localhost:8888/pms/productInfo/29")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203243026.png",alt:"image-20220623203243026"}})]),s._v(" "),n("p",[s._v("配置流控规则")]),s._v(" "),n("p",[n("strong",[s._v("API维度限流")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203251141.png",alt:"image-20220623203251141"}})]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203305762.png",alt:"image-20220623203305762"}})]),s._v(" "),n("p",[n("strong",[s._v("2.3 应用层限流")])]),s._v(" "),n("p",[n("strong",[s._v("场景： 商品详情接口")])]),s._v(" "),n("p",[s._v("系统第一次上线启动，或者系统在 redis 故障的情况下重新启动，这时在高并发的场景下就会出现所有的流量 都会打到mysql（原始数据库） 上去，导致 mysql 崩溃。因此需要通过缓存预热的方案，提前给 redis 灌入部分数据后再提供服务。")]),s._v(" "),n("p",[s._v("jemeter测试： 模拟2秒内查询商品id为1-5000的商品信息")]),s._v(" "),n("p",[s._v("/pms/productInfo/${__counter(,)}")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203316343.png",alt:"image-20220623203316343"}})]),s._v(" "),n("p",[s._v("压测直接访问DB的接口： 吞吐量： 20-60")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public PmsProductParam getProductInfo1(Long id){\n    PmsProductParam productInfo = portalProductDao.getProductInfo(id);\n    if(null == productInfo){\n        return null;\n    }\n    checkFlash(id, productInfo);\n    return productInfo;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203325467.png",alt:"image-20220623203325467"}})]),s._v(" "),n("p",[n("strong",[s._v("压测访问缓存的接口：")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("public PmsProductParam getProductInfo2(Long id) {\n    PmsProductParam productInfo = null;\n    // 查询本地缓存\n    productInfo = cache.get(RedisKeyPrefixConst.PRODUCT_DETAIL_CACHE + id);\n    if (null != productInfo) {\n        return productInfo;\n    }\n    // 查询redis缓存\n    productInfo = redisOpsUtil.get(RedisKeyPrefixConst.PRODUCT_DETAIL_CACHE + id, PmsProductParam.class);\n    if (productInfo != null) {\n        //设置本地缓存\n        cache.setLocalCache(RedisKeyPrefixConst.PRODUCT_DETAIL_CACHE + id, productInfo);\n        return productInfo;\n    }\n    // 查询DB\n    productInfo = portalProductDao.getProductInfo(id);\n    if (null == productInfo) {\n        return null;\n    }\n    checkFlash(id, productInfo);\n    // 设置redis缓存\n    redisOpsUtil.set(RedisKeyPrefixConst.PRODUCT_DETAIL_CACHE + id, productInfo, 3600, TimeUnit.SECONDS);\n    // 设置本地缓存\n    cache.setLocalCache(RedisKeyPrefixConst.PRODUCT_DETAIL_CACHE + id, productInfo);\n    return productInfo;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("第一次访问缓存击穿的吞吐量： 20-60")]),s._v(" "),n("p",[n("strong",[s._v("之后吞吐量： 1000-2800")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203334304.png",alt:"image-20220623203334304"}})]),s._v(" "),n("p",[s._v("思考： 在没有事先进行缓存预热的情况下，如何避免更多的请求直接访问到数据库？")]),s._v(" "),n("p",[s._v("当对数据库访问达到阈值，可以对商品详情请求限流")]),s._v(" "),n("p",[s._v("配置流控规则")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203342396.png",alt:"image-20220623203342396"}})]),s._v(" "),n("p",[s._v("思考：排队等待可以应用于什么场景？")]),s._v(" "),n("p",[s._v("匀速排队（"),n("code",[s._v("RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER")]),s._v("）方式会严格控制请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法。")]),s._v(" "),n("p",[s._v("该方式的作用如下图所示：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203353350.png",alt:"image-20220623203353350"}})]),s._v(" "),n("p",[s._v("这种方式主要用于处理间隔性突发的流量，例如消息队列。想象一下这样的场景，在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。")]),s._v(" "),n("p",[s._v("注意：匀速排队模式暂时不支持 QPS > 1000 的场景。")]),s._v(" "),n("p",[n("strong",[s._v("场景： 对秒杀接口进行流控")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203401714.png",alt:"image-20220623203401714"}})]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203409467.png",alt:"image-20220623203409467"}})]),s._v(" "),n("p",[n("strong",[s._v("热点参数限流")])]),s._v(" "),n("p",[s._v("何为热点？热点即经常访问的数据。商家不定期做一些“商品秒杀”、“商品推广”活动，导致“营销活动”、“商品详情”、“交易下单”等链路应用出现 "),n("strong",[s._v("缓存热点访问")]),s._v(" 的情况：")]),s._v(" "),n("ul",[n("li",[s._v("活动时间、活动类型、活动商品之类的信息不可预期，导致 "),n("strong",[s._v("缓存热点访问")]),s._v(" 情况不可提前预知；")]),s._v(" "),n("li",[n("strong",[s._v("缓存热点访问")]),s._v(" 出现期间，应用层少数 "),n("strong",[s._v("热点访问 key")]),s._v(" 产生大量缓存访问请求，冲击分布式缓存系统，大量占据内网带宽，最终影响应用层系统稳定性；")])]),s._v(" "),n("p",[s._v("很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：")]),s._v(" "),n("ul",[n("li",[s._v("商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制")]),s._v(" "),n("li",[s._v("用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制")])]),s._v(" "),n("p",[s._v("热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。 热点key")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203423102.png",alt:"image-20220623203423102"}})]),s._v(" "),n("p",[s._v("注意：")]),s._v(" "),n("ol",[n("li",[s._v('热点规则需要使用@SentinelResource("resourceName")注解，否则不生效')]),s._v(" "),n("li",[s._v("参数必须是7种基本数据类型才会生效")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203432805.png",alt:"image-20220623203432805"}})]),s._v(" "),n("p",[s._v("配置热点参数限流规则")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203441717.png",alt:"image-20220623203441717"}})]),s._v(" "),n("p",[s._v("测试： http://localhost:8866/pms/productInfo/26")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203450097.png",alt:"image-20220623203450097"}})]),s._v(" "),n("p",[n("strong",[s._v("思考：")]),s._v(" "),n("strong",[s._v("如何快速且准确的发现热点访问key ？   不可预测的热点key     热点探测（网关层）")])]),s._v(" "),n("p",[n("strong",[s._v("热点探测功能设计思路")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203457813.png",alt:"image-20220623203457813"}})]),s._v(" "),n("p",[n("strong",[s._v("3. 降级实战")])]),s._v(" "),n("p",[s._v("降级就是当系统的容量达到一定程度时，限制或者关闭系统的某些非核心功能，从而把有限的资源保留给更核心的业务。")]),s._v(" "),n("p",[s._v("比如降级方案可以这样设计：当秒杀流量达到 5w/s 时，把成交记录的获取从展示 20 条降级到只展示 5 条。“从 20 改到 5”这个操作由一个开关来实现，也就是设置一个能够从开关系统动态获取的系统参数。")]),s._v(" "),n("p",[s._v("降级的核心目标是牺牲次要的功能和用户体验来保证核心业务流程的稳定，是一个不得已而为之的举措。例如在双 11 零点时，如果优惠券系统扛不住，可能会临时降级商品详情的优惠信息展示，把有限的系统资源用在保障交易系统正确展示优惠信息上，即保障用户真正下单时的价格是正确的。")]),s._v(" "),n("p",[n("strong",[s._v("3.1 服务降级的策略")])]),s._v(" "),n("p",[s._v("https://www.processon.com/view/link/60dc6e485653bb2a8d08850d")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203507398.png",alt:"image-20220623203507398"}})]),s._v(" "),n("p",[n("strong",[s._v("3.2 应用层降级实战")])]),s._v(" "),n("p",[s._v("**场景： 秒杀下单   /order/**"),n("strong",[s._v("miaosha/generateOrder")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203516996.png",alt:"image-20220623203516996"}})]),s._v(" "),n("p",[s._v("如果会员服务出现问题，会影响整个下单链路。")]),s._v(" "),n("p",[s._v("模拟查询会员地址信息出现网络问题和业务异常")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@ApiOperation("显示收货地址详情")\n@RequestMapping(value = "/{id}", method = RequestMethod.GET)\n@ResponseBody\npublic CommonResult<UmsMemberReceiveAddress> getItem(@PathVariable Long id,@RequestHeader("memberId") long memberId) {\n    if(memberId==3){\n        try {\n            //模拟网络问题\n            Thread.sleep(2000);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n    }\n    if(memberId==4){\n        //模拟业务异常\n        throw new IllegalArgumentException("非法参数异常");\n    }\n    UmsMemberReceiveAddress address = memberReceiveAddressService.getItem(id,memberId);\n    return CommonResult.success(address);\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("测试： memberId为3的用户压测")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203525605.png",alt:"image-20220623203525605"}})]),s._v(" "),n("p",[n("strong",[s._v("Sentinel熔断降级")])]),s._v(" "),n("p",[n("strong",[s._v("OpenFeign整合Sentinel")])]),s._v(" "),n("p",[s._v("配置文件打开 Sentinel 对 Feign 的支持：feign.sentinel.enabled=true")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("feign:\n  sentinel:\n    enabled: true\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("feign接口配置fallbackFactory")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@FeignClient(name = "tulingmall-member",path = "/member",\n        fallbackFactory = UmsMemberFeginFallbackFactory.class)\npublic interface UmsMemberFeignApi {\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("UmsMemberFeginFallbackFactory中编写降级逻辑")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Component\npublic class UmsMemberFeginFallbackFactory implements FallbackFactory<UmsMemberFeignApi> {\n    \n    @Override\n    public UmsMemberFeignApi create(Throwable throwable) {\n        \n        return new UmsMemberFeignApi() {\n            @Override\n            public CommonResult<UmsMemberReceiveAddress> getItem(Long id) {\n                //TODO 业务降级\n                UmsMemberReceiveAddress defaultAddress = new UmsMemberReceiveAddress();\n                defaultAddress.setName("默认地址");\n                defaultAddress.setId(-1L);\n                defaultAddress.setDefaultStatus(0);\n                defaultAddress.setPostCode("-1");\n                defaultAddress.setProvince("默认省份");\n                defaultAddress.setCity("默认city");\n                defaultAddress.setRegion("默认region");\n                defaultAddress.setDetailAddress("默认详情地址");\n                defaultAddress.setMemberId(-1L);\n                defaultAddress.setPhoneNumber("199xxxxxx");\n                return CommonResult.success(defaultAddress);\n            }\n            \n            @Override\n            public CommonResult<String> updateUmsMember(UmsMember umsMember) {\n                return null;\n            }\n            \n            @Override\n            public CommonResult<PortalMemberInfo> getMemberById() {\n                return null;\n            }\n            \n            @Override\n            public CommonResult<List<UmsMemberReceiveAddress>> list() {\n                return null;\n            }\n        };\n    }\n    \n    \n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br")])]),n("p",[s._v("会员收货地址接口配置基于响应时间的降级规则")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203534299.png",alt:"image-20220623203534299"}})]),s._v(" "),n("p",[s._v("测试：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203542107.png",alt:"image-20220623203542107"}})]),s._v(" "),n("p",[s._v("会员收货地址接口配置基于异常数的降级规则")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203550386.png",alt:"image-20220623203550386"}})]),s._v(" "),n("p",[s._v("测试")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203600806.png",alt:"image-20220623203600806"}})]),s._v(" "),n("p",[n("strong",[s._v("4. 拒绝服务")])]),s._v(" "),n("p",[s._v("拒绝服务可以说是一种不得已的兜底方案，用以防止最坏情况发生，防止因把服务器压跨而长时间彻底无法提供服务。当系统负载达到一定阈值时，例如 CPU 使用率达到 90% 或者系统 load 值达到 2*CPU 核数时，系统直接拒绝所有请求，这种方式是最暴力但也最有效的系统保护方式。")]),s._v(" "),n("p",[s._v("例如秒杀系统，我们可以在以下环节设计过载保护：")]),s._v(" "),n("ul",[n("li",[s._v("在最前端的 Nginx 上设置过载保护，当机器负载达到某个值时直接拒绝 HTTP 请求并返回 503 错误码。")])]),s._v(" "),n("p",[s._v("阿里针对nginx开发的过载保护扩展插件"),n("a",{attrs:{href:"https://github.com/alibaba/nginx-http-sysguard",target:"_blank",rel:"noopener noreferrer"}},[s._v("sysguard： https://github.com/alibaba/nginx-http-sysguard"),n("OutboundLink")],1)]),s._v(" "),n("ul",[n("li",[s._v("在 Java 层同样也可以设计过载保护。 比如Sentinel提供了系统规则限流")])]),s._v(" "),n("p",[n("strong",[s._v("Sentinel系统规则限流")])]),s._v(" "),n("p",[s._v("Sentinel 系统自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("Load 自适应")]),s._v("（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 maxQps * minRt 估算得出。设定参考值一般是 CPU cores * 2.5。")]),s._v(" "),n("li",[n("strong",[s._v("CPU usage")]),s._v("（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。")]),s._v(" "),n("li",[n("strong",[s._v("平均 RT")]),s._v("：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。")]),s._v(" "),n("li",[n("strong",[s._v("并发线程数")]),s._v("：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。")]),s._v(" "),n("li",[n("strong",[s._v("入口 QPS")]),s._v("：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。")])]),s._v(" "),n("p",[s._v("系统规则持久化yml配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("system-rules:\n  nacos:\n    server-addr: tl.nacos.com:8848\n    dataId: ${spring.application.name}-system-rules\n    groupId: SENTINEL_GROUP\n    data-type: json\n    rule-type: system\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203610406.png",alt:"image-20220623203610406"}})]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623203617750.png",alt:"image-20220623203617750"}})])])}),[],!1,null,null,null);n.default=t.exports}}]);
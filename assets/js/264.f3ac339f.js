(window.webpackJsonp=window.webpackJsonp||[]).push([[264],{605:function(e,s,n){"use strict";n.r(s);var t=n(1),r=Object(t.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("U2FsdGVkX18Q1J6fIJ9hRkhKNh+r3FtjKA5zHF2dlnSfSpxux7SCaR2w8e1ZF7Va\ntuKiShTm3XNFKi5TE4pwhEKSowMWCrix5+EAKjbFl5DCmskcZxbLEeMD1ld68uum\nuw==\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[s("strong",[e._v("售罄状态同步方案：")])]),e._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623201358546.png",alt:"image-20220623201358546"}})]),e._v(" "),s("p",[e._v("1、zookeeper")]),e._v(" "),s("p",[e._v("利用zk的watcher机制实现")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623201413205.png",alt:"image-20220623201413205"}})]),e._v(" "),s("p",[s("strong",[e._v("2、redis")])]),e._v(" "),s("p",[e._v("利用redis的channel机制实现。")]),e._v(" "),s("p",[e._v("一个客户端订阅主题：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623201422959.png",alt:"image-20220623201422959"}})]),e._v(" "),s("p",[s("strong",[e._v("命令：subscribe monkey")])]),e._v(" "),s("p",[e._v("一个客户端向订阅的主题（channel）发送消息：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623201431542.png",alt:"image-20220623201431542"}})]),e._v(" "),s("p",[s("strong",[e._v("命令：publish monkey hello")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('//通知服务群,清除本地售罄标记缓存\nif (shouldPublishCleanMsg(productId)) {\n    redisOpsUtil.publish("cleanNoStockCache", productId);\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[s("strong",[e._v("监听类：")])]),e._v(" "),s("p",[e._v("com.tuling.tulingmall.component.RedisChannelListener")]),e._v(" "),s("p",[s("strong",[e._v("3、mq...其他方式")])]),e._v(" "),s("p",[e._v("这就不都说了")]),e._v(" "),s("p",[e._v("那zk和redis哪种方案更好了？同学们")]),e._v(" "),s("p",[e._v("redis这种发布与订阅是没有ack的，发出去了不会管有没有收到。这是它的不足，那优点是什么了")]),e._v(" "),s("p",[e._v("优点就是其缺点，吞吐量相当来说就会提高，因为减少了通讯，那处理数据的能力就就会上升")]),e._v(" "),s("p",[s("strong",[e._v("秒杀商品的预热【product】：")])]),e._v(" "),s("p",[e._v("在启动的时候就把秒杀商品的库存放到redis中。")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("com.tuling.tulingmall.config.RedisConifg\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("​")]),e._v(" "),s("p",[s("strong",[e._v("全量刷秒杀库存：")])]),e._v(" "),s("p",[e._v("com.tuling.tulingmall.config.RedisConifg#afterPropertiesSet")]),e._v(" "),s("p",[s("strong",[e._v("异步下单：")])]),e._v(" "),s("p",[e._v("之前方案不足： 数据库insert 很多表 数据库优化")]),e._v(" "),s("p",[e._v("1、颠覆性 》mysql oracle")]),e._v(" "),s("p",[e._v("2、改进型》索引、分库分表、读写分离")]),e._v(" "),s("p",[s("strong",[e._v("处理未支付的订单（20分钟）：")])]),e._v(" "),s("p",[e._v("Topic：order-status-check")]),e._v(" "),s("p",[e._v("生产端：")]),e._v(" "),s("p",[e._v("com.tuling.tulingmall.component.rocketmq.OrderMessageSender#sendTimeOutOrderMessage")]),e._v(" "),s("p",[e._v("消费端：")]),e._v(" "),s("p",[e._v("com.tuling.tulingmall.component.rocketmq.RocketMqCancelOrderReciever")]),e._v(" "),s("p",[s("strong",[e._v("Canal同步topic：")])]),e._v(" "),s("p",[e._v("Topic：productDetailChange")]),e._v(" "),s("p",[e._v("生产端：canal")]),e._v(" "),s("p",[e._v("消费端：com.tuling.tulingmall.mq.RefreshCacheListener")]),e._v(" "),s("p",[s("strong",[e._v("async-order异步下单topic：")])]),e._v(" "),s("p",[e._v("**实际生产订单：**SecKillOrderServiceImpl#asyncCreateOrder")]),e._v(" "),s("p",[e._v("处理订单：com.tuling.tulingmall.component.rocketmq.AscynCreateOrderReciever")]),e._v(" "),s("p",[e._v("com.tuling.tulingmall.service.impl.SecKillOrderServiceImpl#asyncCreateOrder //TODO 分布事务、分布式消息")]),e._v(" "),s("p",[e._v("部署不能这么玩：拆分")]),e._v(" "),s("p",[s("strong",[e._v("异步订单查询接口：")])]),e._v(" "),s("p",[e._v("com.tuling.tulingmall.controller.OmsPortalOrderController#miaoShaResult")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@ApiOperation("根据购物车信息生成订单")\n@GetMapping("/miaosha/result")\n@ResponseBody\npublic CommonResult miaoShaResult(@RequestParam("productId") Long productId,@RequestHeader("memberId") Long memberId){\n    String status = redisOpsUtil.get(RedisKeyPrefixConst.MIAOSHA_ASYNC_WAITING_PREFIX + memberId\n            + ":" + productId);\n\n    if(ObjectUtils.isEmpty(status)){\n        return CommonResult.success(null,"无正在秒杀中的订单！");\n    }\n\n    if(status.equals("-1")){\n        return CommonResult.success(status,"秒杀失败！");\n    }\n\n    if(status.equals("1")){\n        return CommonResult.success(status,"正在排队中,请耐心等待！");\n    }\n    //如果Status>1，则秒杀成功,返回订单编号\n    return CommonResult.success(status);\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br")])]),s("p",[e._v("​")]),e._v(" "),s("p",[s("strong",[e._v("总结：")])]),e._v(" "),s("p",[e._v("1、异步下单可以分流、让服务器处理的压力变小、数据库压力减少")]),e._v(" "),s("p",[e._v("2、解耦的话，业务更加清晰。")]),e._v(" "),s("p",[e._v("3、天然的排队处理能力。")]),e._v(" "),s("p",[e._v("4、消息中间件有很多特性可以利用，比如订单取消。")]),e._v(" "),s("p",[s("strong",[e._v("订单取消：")])]),e._v(" "),s("p",[s("strong",[e._v("订单超时取消，回滚库存：")])]),e._v(" "),s("p",[e._v("com.tuling.tulingmall.component.rocketmq.RocketMqCancelOrderReciever")]),e._v(" "),s("p",[s("strong",[e._v("定时任务的问题：")])]),e._v(" "),s("p",[e._v("1、11点启动定时任务，毎半个小时扫码数据库一次，我们发现在11:01分下的单并不能30分钟之后失效，而是要到12点也就是定时任务第三次扫码数据库才能让订单失效。")]),e._v(" "),s("p",[e._v("2、定时扫数据库的话消耗性能也很大，自然效率也会很低。对数据库压力太大。")]),e._v(" "),s("p",[e._v("3、定时任务的话，集群还需要保证处理的幂等性和分布式问题。这也给系统带来了很多的负担。")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623201443439.png",alt:"image-20220623201443439"}})]),e._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623201451842.png",alt:"image-20220623201451842"}})]),e._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/springboot/image-20220623201523508.png",alt:"image-20220623201523508"}})]),e._v(" "),s("p",[s("strong",[e._v("异步取消订单：")])]),e._v(" "),s("p",[e._v("com.tuling.tulingmall.component.rocketmq.RocketMqCancelOrderReciever")]),e._v(" "),s("p",[s("strong",[e._v("创建订单、发送延迟20分钟消息：")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('com.tuling.tulingmall.service.impl.SecKillOrderServiceImpl#asyncCreateOrder\n >com.tuling.tulingmall.component.rocketmq.OrderMessageSender#sendTimeOutOrderMessage\n/*\n * 如果订单创建成功,需要发送定时消息,20min后如果没有支付,则取消当前订单,释放库存\n */\ntry {\n    boolean sendStatus = orderMessageSender.sendTimeOutOrderMessage(order.getId() + ":" + flashPromotionRelationId + ":" + orderItem.getProductId());\n    if (!sendStatus) {\n        throw new RuntimeException("订单超时取消消息发送失败！");\n    }\n} catch (Exception e) {\n    throw new RuntimeException("订单超时取消消息发送失败！");\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br")])]),s("p",[e._v("​")]),e._v(" "),s("p",[s("strong",[e._v("预减库存preDecrRedisStock方法：")])]),e._v(" "),s("p",[e._v("通过redis的decr函数扣减库存。")]),e._v(" "),s("p",[e._v("如果没有库存了，stock小于0时 发消息给rocketmq同步库存 redis设置为0")]),e._v(" "),s("p",[e._v("redis与db同步订单：")]),e._v(" "),s("p",[e._v("com.tuling.tulingmall.component.rocketmq.OrderMessageSender#sendStockSyncMessage")]),e._v(" "),s("p",[e._v("利用rocketmq延迟消息的一个特性来解决“定时任务”来取消订单操作。")]),e._v(" "),s("p",[s("strong",[e._v("RocketMQ消息零丢失：")])]),e._v(" "),s("p",[e._v("生产端：同步发送消息、重试机制、事务消息、状态")]),e._v(" "),s("p",[e._v("服务端：刷盘存储、主从同步、 状态返回")]),e._v(" "),s("p",[e._v("消费端：pull broker offset 消费端并且返回成功 偏移值，如果消费失败那条数据")]),e._v(" "),s("p",[s("strong",[e._v("Rocket****MQ消息不被重复消费：")])]),e._v(" "),s("p",[e._v("重复问题、幂等性问题。redis incr 数据库唯一主键")]),e._v(" "),s("p",[e._v("orderid：20210630 》key 1")]),e._v(" "),s("p",[s("strong",[e._v("数据同步Canal：")])]),e._v(" "),s("p",[e._v("场景模拟：在秒杀后台把价格修改之后，如何同步到缓存中，比如redis如何")]),e._v(" "),s("p",[e._v("canal闪亮登场")]),e._v(" "),s("p",[e._v("#参考另外一份文档 《canal安装与使用》")]),e._v(" "),s("p",[e._v("项目中对product和秒杀表修改做同步操作：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("com.tuling.tulingmall.mq.RefreshCacheListener#onMessage\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])])])}),[],!1,null,null,null);s.default=r.exports}}]);
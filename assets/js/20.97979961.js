(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{362:function(a,s,e){"use strict";e.r(s);var t=e(1),n=Object(t.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h2",{attrs:{id:"一、简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、简介"}},[a._v("#")]),a._v(" 一、简介")]),a._v(" "),s("p",[a._v("MHA（Master HA）是一款开源的 MySQL 的高可用程序，它为 MySQL 主从")]),a._v(" "),s("p",[a._v("复制架构提供了 automating master failover 功能。MHA 在监控到 master 节点")]),a._v(" "),s("p",[a._v("故障时，会提升其中拥有最新数据的 slave 节点成为新的master 节点，在此期间， MHA 会通过于其它从节点获取额外信息来避免一致性方面的问题。MHA 还提供了 master 节点的在线切换功能，即按需切换 master/slave 节点。")]),a._v(" "),s("p",[a._v("MHA 是由日本人 yoshinorim（原就职于DeNA现就职于FaceBook）开发的比较成熟的 MySQL 高可用方案。MHA 能够在30秒内实现故障切换，并能在故障切换中，最大可能的保证数据一致性。目前淘宝也正在开发相似产品 TMHA， 目前已支持一主一从。")]),a._v(" "),s("h2",{attrs:{id:"二、mha-服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、mha-服务"}},[a._v("#")]),a._v(" 二、MHA 服务")]),a._v(" "),s("h3",{attrs:{id:"_2-1-服务角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-服务角色"}},[a._v("#")]),a._v(" 2.1 服务角色")]),a._v(" "),s("p",[a._v("MHA 服务有两种角色， MHA Manager(管理节点)和 MHA Node(数据节点)：")]),a._v(" "),s("p",[s("strong",[a._v("MHA Manager：")])]),a._v(" "),s("p",[a._v("通常单独部署在一台独立机器上管理多个 master/slave 集群(组)，每个 master/slave 集群称作一个 "),s("strong",[a._v("application")]),a._v("，用来管理统筹整个集群。")]),a._v(" "),s("p",[s("strong",[a._v("MHA node：")])]),a._v(" "),s("p",[a._v("运行在每台 MySQL 服务器上(master/slave/manager)，它"),s("strong",[a._v("通过监控具备解析和清理 logs 功能的脚本来加快故障转移。")])]),a._v(" "),s("p",[a._v("主要是接收管理节点所发出指令的代理，代理需要运行在每一个 mysql 节点")]),a._v(" "),s("p",[a._v("上。简单讲 node 就是用来收集从节点服务器上所生成的 bin-log 。对比打算提升为新的主节点之上的从节点的是否拥有并完成操作，如果没有发给新主节点在本地应用后提升为主节点。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/db/clip_image002.gif",alt:"img"}})]),a._v(" "),s("p",[a._v("由上图我们可以看出，每个复制组内部和 Manager 之间都需要ssh实现无密码互连，只有这样，在 Master 出故障时， Manager 才能顺利的连接进去，实现主从切换功能。")]),a._v(" "),s("h3",{attrs:{id:"_2-2提供的工具"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2提供的工具"}},[a._v("#")]),a._v(" 2.2提供的工具")]),a._v(" "),s("p",[a._v("MHA会提供诸多工具程序， 其常见的如下所示：")]),a._v(" "),s("p",[s("strong",[a._v("Manager节点：")])]),a._v(" "),s("p",[a._v("masterha_check_ssh：MHA 依赖的 ssh 环境监测工具；")]),a._v(" "),s("p",[a._v("masterha_check_repl：MYSQL 复制环境检测工具；")]),a._v(" "),s("p",[a._v("masterga_manager：MHA 服务主程序；")]),a._v(" "),s("p",[a._v("masterha_check_status：MHA 运行状态探测工具；")]),a._v(" "),s("p",[a._v("masterha_master_monitor：MYSQL master 节点可用性监测工具；")]),a._v(" "),s("p",[a._v("masterha_master_swith:master：节点切换工具；　　masterha_conf_host：添加或删除配置的节点；　　masterha_stop：关闭 MHA 服务的工具。")]),a._v(" "),s("p",[s("strong",[a._v("Node节点：（这些工具通常由MHA Manager的脚本触发，无需人为操作）")])]),a._v(" "),s("p",[a._v("save_binary_logs：保存和复制 master 的二进制日志；")]),a._v(" "),s("p",[a._v("apply_diff_relay_logs：识别差异的中继日志事件并应用于其他 slave；")]),a._v(" "),s("p",[a._v("purge_relay_logs：清除中继日志（不会阻塞 SQL 线程）；")]),a._v(" "),s("p",[s("strong",[a._v("自定义扩展：")])]),a._v(" "),s("p",[a._v("secondary_check_script：通过多条网络路由检测master的可用性；")]),a._v(" "),s("p",[a._v("master_ip_failover_script：更新application使用的masterip；")]),a._v(" "),s("p",[a._v("report_script：发送报告;")]),a._v(" "),s("p",[a._v("init_conf_load_script：加载初始配置参数；")]),a._v(" "),s("p",[a._v("master_ip_online_change_script;更新master节点ip地址。")]),a._v(" "),s("h3",{attrs:{id:"_2-3工作原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3工作原理"}},[a._v("#")]),a._v(" 2.3工作原理")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/db/clip_image005.gif",alt:"img"}})]),a._v(" "),s("p",[a._v("MHA工作原理总结为以下几条：")]),a._v(" "),s("p",[a._v("（1） 从宕机崩溃的 master 保存二进制日志事件（binlog events）；")]),a._v(" "),s("p",[a._v("（2） 识别含有最新更新的 slave ；")]),a._v(" "),s("p",[a._v("（3） 应用差异的中继日志(relay log) 到其他 slave ；")]),a._v(" "),s("p",[a._v("（4） 应用从 master 保存的二进制日志事件(binlog events)；")]),a._v(" "),s("p",[a._v("（5） 提升一个 slave 为新 master ；")]),a._v(" "),s("p",[a._v("（6） 使用其他的 slave 连接新的 master 进行复制。")]),a._v(" "),s("h2",{attrs:{id:"三、实现过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、实现过程"}},[a._v("#")]),a._v(" 三、实现过程")]),a._v(" "),s("h3",{attrs:{id:"_3-1-准备实验-mysql-的-replication-环境"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-准备实验-mysql-的-replication-环境"}},[a._v("#")]),a._v(" 3.1 准备实验 Mysql 的 Replication 环境")]),a._v(" "),s("h4",{attrs:{id:"_3-1-1-相关配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-1-相关配置"}},[a._v("#")]),a._v(" 3.1.1 相关配置")]),a._v(" "),s("p",[a._v("MHA 对 MYSQL 复制环境有特殊要求，例如各节点都要开启二进制日志及中继日志，各从节点必须显示启用其read-only属性，并关闭relay_log_purge功能等，这里对配置做事先说明。")]),a._v(" "),s("p",[a._v("本实验环境共有四个节点， 其角色分配如下（实验机器均为centos 7.3）：")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/db/clip_image008.gif",alt:"img"}})]),a._v(" "),s("p",[a._v("为了方便我们后期的操作，我们在各节点的/etc/hosts文件配置内容中添加如下内容：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("192.168.37.111 node1.keer.com node1\n192.168.37.122 node2.keer.com node2\n192.168.37.133 node3.keer.com node3\n192.168.37.144 node4.keer.com node4\n\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/db/clip_image011.gif",alt:"img"}})]),a._v(" "),s("p",[a._v("这样的话，我们就可以通过 host 解析节点来打通私钥访问，会方便很多。")]),a._v(" "),s("p",[a._v("本步骤完成。")]),a._v(" "),s("p"),a._v(" "),s("h4",{attrs:{id:"_3-1-2-初始主节点-master-的配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-2-初始主节点-master-的配置"}},[a._v("#")]),a._v(" 3.1.2 初始主节点 master 的配置")]),a._v(" "),s("p",[a._v("我们需要修改 master 的数据库配置文件来对其进行初始化配置：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@master ~]# vim /etc/my.cnf\n[mysqld]\nserver-id = 1 //复制集群中的各节点的id均必须唯一\nlog-bin = master-log //开启二进制日志\nrelay-log = relay-log //开启中继日志\nskip_name_resolve //关闭名称解析（非必须）\n[root@master ~]# systemctl restart mariadb\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/db/clip_image014.gif",alt:"img"}})]),a._v(" "),s("h4",{attrs:{id:"_3-1-3-所有-slave-节点依赖的配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-3-所有-slave-节点依赖的配置"}},[a._v("#")]),a._v(" 3.1.3 所有 slave 节点依赖的配置")]),a._v(" "),s("p",[a._v("我们修改两个 slave 的数据库配置文件，两台机器都做如下操作：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@slave1 ~]# vim /etc/my.cnf\n[mysqld]\nserver-id = 2 //复制集群中的各节点的id均必须唯一；\nrelay-log = relay-log //开启中继日志\nlog-bin = master-log //开启二进制日志\nread_only = ON //启用只读属性\nrelay_log_purge = 0 //是否自动清空不再需要中继日志\nskip_name_resolve //关闭名称解析（非必须）\nlog_slave_updates = 1 //使得更新的数据写进二进制日志中\n[root@slave1 ~]# systemctl restart mariadb\n[root@slave2 ~]# vim /etc/my.cnf\n[mysqld]\nserver-id = 3 //复制集群中的各节点的id均必须唯一；\nrelay-log = relay-log //开启中继日志\nlog-bin = master-log //开启二进制日志\nread_only = ON //启用只读属性\nrelay_log_purge = 0 //是否自动清空不再需要中继日志\nskip_name_resolve //关闭名称解析（非必须）\nlog_slave_updates = 1 //使得更新的数据写进二进制日志中\n[root@slave2 ~]# systemctl restart mariadb\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br")])]),s("p"),a._v(" "),s("p",[a._v("本步骤完成。")]),a._v(" "),s("p"),a._v(" "),s("h4",{attrs:{id:"_3-1-4-配置一主多从复制架构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-4-配置一主多从复制架构"}},[a._v("#")]),a._v(" 3.1.4 配置一主多从复制架构")]),a._v(" "),s("p",[a._v("下面只会给出命令，具体的知识及过程详解就不再多说了。")]),a._v(" "),s("p",[a._v("master 节点上：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("MariaDB [(none)]>grant replication slave,replication client on *.* to\n'slave'@'192.168.%.%' identified by 'keer';\nMariaDB [(none)]> show master status;\n\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("p",[a._v("slave 节点上：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("MariaDB [(none)]> change master to master_host='192.168.37.122',\n-> master_user='slave',\n-> master_password='keer',\n-> master_log_file='mysql-bin.000001',\n-> master_log_pos=415;\nMariaDB [(none)]> start slave;\nMariaDB [(none)]> show slave status\\G;\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br")])]),s("p",[a._v("本步骤完成。")]),a._v(" "),s("h3",{attrs:{id:"_3-2-安装配置mha"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-安装配置mha"}},[a._v("#")]),a._v(" 3.2 安装配置MHA")]),a._v(" "),s("h4",{attrs:{id:"_3-2-1-在-master-上进行授权"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-在-master-上进行授权"}},[a._v("#")]),a._v(" 3.2.1 在 master 上进行授权")]),a._v(" "),s("p",[a._v("在所有 Mysql 节点授权拥有管理权限的用户可在本地网络中有其他节点上远程访问。 当然， 此时仅需要且只能在 master 节点运行类似如下 SQL 语句即可。")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("MariaDB [(none)]> grant all on *.* to 'mhaadmin'@'192.168.%.%' identified by\n'mhapass';\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("本步骤完成。")]),a._v(" "),s("p"),a._v(" "),s("h4",{attrs:{id:"_3-2-2-准备-ssh-互通环境"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-准备-ssh-互通环境"}},[a._v("#")]),a._v(" 3.2.2 准备 ssh 互通环境")]),a._v(" "),s("p",[a._v("MHA集群中的各节点彼此之间均需要基于ssh互信通信，以实现远程控制及数据管理功能。简单起见，可在Manager节点生成密钥对儿，并设置其可远程连接本")]),a._v(" "),s("p",[a._v("地主机后， 将私钥文件及authorized_keys文件复制给余下的所有节点即可。")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# ssh-keygen -t rsa\n[root@manager ~]# ssh-copy-id -i .ssh/id_rsa.pub root@node1\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("下面操作在所有节点上操作：")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/db/clip_image020.gif",alt:"img"}})]),a._v(" "),s("p",[a._v("当四台机器都进行了上述操作以后，我们可以在 manager 机器上看到如下文件：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# cd .ssh/\n[root@manager .ssh]# ls\nauthorized_keys id_rsa id_rsa.pub known_hosts\n[root@manager .ssh]# cat authorized_keys\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/db/clip_image023.gif",alt:"img"}})]),a._v(" "),s("p",[a._v("四台机器的公钥都已经在authorized_keys这个文件中了，接着，我们只需要把这个文件发送至另外三台机器，这四台机器就可以实现 ssh 无密码互通了：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager .ssh]# scp authorized_keys root@node2:~/.ssh/\n[root@manager .ssh]# scp authorized_keys root@node3:~/.ssh/\n[root@manager .ssh]# scp authorized_keys root@node4:~/.ssh/\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("当然，我们也可以在机器上实验一下，看看 ssh 是否还需要输入密码。")]),a._v(" "),s("p",[a._v("本步骤完成。")]),a._v(" "),s("h4",{attrs:{id:"_3-2-3-安装-mha-包"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-安装-mha-包"}},[a._v("#")]),a._v(" 3.2.3 安装 MHA 包")]),a._v(" "),s("p",[a._v("在本步骤中， Manager节点需要另外多安装一个包。具体需要安装的内容如下：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("四个节点都需安装：mha4mysql-node-0.56-0.el6.norch.rpm\nManager 节点另需要安装：mha4mysql-manager-0.56-\n0.el6.noarch.rpm\n\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("p",[a._v("我们使用rz命令分别上传，然后使用yum安装即可。")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# rz\n[root@manager ~]# ls\nanaconda-ks.cfg initial-setup-ks.cfg Pictures\nDesktop mha4mysql-manager-0.56-0.el6.noarch.rpm Public\nDocuments mha4mysql-node-0.56-0.el6.noarch.rpm Templates\nDownloads Music Videos\n[root@manager ~]# yum install -y mha4mysql-node-0.56-0.el6.noarch.rpm\n[root@manager ~]# yum install -y mha4mysql-manager-0.56-0.el6.noarch.rpm\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br")])]),s("p",[a._v("其余机器也分别进行安装，就不一一举例了。")]),a._v(" "),s("p",[a._v("本步骤完成。")]),a._v(" "),s("p"),a._v(" "),s("h4",{attrs:{id:"_3-2-4-初始化-mha-进行配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-4-初始化-mha-进行配置"}},[a._v("#")]),a._v(" 3.2.4 初始化 MHA ，进行配置")]),a._v(" "),s("p",[a._v("Manager 节点需要为每个监控的 master/slave 集群提供一个专用的配置文件，而所有的 master/slave 集群也可"),s("strong",[a._v("共享全局配置")]),a._v("。全局配置文件"),s("strong",[a._v("默认为")]),a._v("/etc/masterha_default.cnf，其为"),s("strong",[a._v("可选配置")]),a._v("。如果仅监控一组")]),a._v(" "),s("p",[a._v("master/slave 集群，也可直接通过 application 的配置来提供各服务器的默认配置信息。而每个 application 的配置文件路径为自定义。具体操作见下一步骤。")]),a._v(" "),s("h4",{attrs:{id:"_3-2-5-定义-mha-管理配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-5-定义-mha-管理配置文件"}},[a._v("#")]),a._v(" 3.2.5 定义 MHA 管理配置文件")]),a._v(" "),s("p",[a._v("为MHA专门创建一个管理用户， 方便以后使用， 在mysql的主节点上， 三个节点自动同步：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("mkdir /etc/mha_master\nvim /etc/mha_master/mha.cnf\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("配置文件内容如下；")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[server default] //适用于server1,2,3个server的配置\nuser=mhaadmin //mha管理用户\npassword=mhapass //mha管理密码\nmanager_workdir=/etc/mha_master/app1 //mha_master自己的工作路径\nmanager_log=/etc/mha_master/manager.log // mha_master自己的日志文件\nremote_workdir=/mydata/mha_master/app1 //每个远程主机的工作目录在何处\nssh_user=root // 基于ssh的密钥认证\nrepl_user=slave //数据库用户名\nrepl_password=magedu //数据库密码\nping_interval=1 //ping间隔时长\n[server1] //节点2\nhostname=192.168.37.133 //节点2主机地址\nssh_port=22 //节点2的ssh端口\ncandidate_master=1 //将来可不可以成为master候选节点/主节点\n[server2]\nhostname=192.168.37.133\nssh_port=22\ncandidate_master=1\n[server3]\nhostname=192.168.37.144\nssh_port=22\ncandidate_master=1\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br")])]),s("p",[a._v("本步骤完成。")]),a._v(" "),s("h4",{attrs:{id:"_3-2-6-对四个节点进行检测"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-6-对四个节点进行检测"}},[a._v("#")]),a._v(" 3.2.6 对四个节点进行检测")]),a._v(" "),s("p",[a._v("1）检测各节点间 ssh 互信通信配置是否 ok")]),a._v(" "),s("p",[a._v("我们在 Manager 机器上输入下述命令来检测：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# masterha_check_ssh -conf=/etc/mha_master/mha.cnf\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("如果最后一行显示为[info]All SSH connection tests passed successfully.则表示成功。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/db/clip_image030.gif",alt:"img"}})]),a._v(" "),s("p",[a._v("2）检查管理的MySQL复制集群的连接配置参数是否OK")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# masterha_check_repl -conf=/etc/mha_master/mha.cnf\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/db/clip_image033.gif",alt:"img"}})]),a._v(" "),s("p",[a._v("我们发现检测失败，这可能是因为从节点上没有账号，因为这个架构，任何一个从节点， 将有可能成为主节点， 所以也需要创建账号。")]),a._v(" "),s("p",[a._v("因此，我们需要在master节点上再次执行以下操作：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("MariaDB [(none)]> grant replication slave,replication client on *.* to\n'slave'@'192.168.%.%' identified by 'keer';\nMariaDB [(none)]> flush privileges;\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("执行完这段操作之后，我们再次运行检测命令：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# masterha_check_repl -conf=/etc/mha_master/mha.cnf\nThu Nov 23 09:07:08 2017 - [warning] Global configuration file\n/etc/masterha_default.cnf not found. Skipping.\nThu Nov 23 09:07:08 2017 - [info] Reading application default configuration\nfrom /etc/mha_master/mha.cnf..\nThu Nov 23 09:07:08 2017 - [info] Reading server configuration from\n/etc/mha_master/mha.cnf..\n……\nMySQL Replication Health is OK.\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br")])]),s("p",[a._v("可以看出，我们的检测已经ok了。")]),a._v(" "),s("p",[a._v("此步骤完成。")]),a._v(" "),s("h3",{attrs:{id:"_3-3-启动-mha"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-启动-mha"}},[a._v("#")]),a._v(" 3.3 启动 MHA")]),a._v(" "),s("p",[a._v("我们在 manager 节点上执行以下命令来启动 MHA：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# nohup masterha_manager -conf=/etc/mha_master/mha.cnf &>\n/etc/mha_master/manager.log &\n[1] 7598\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("启动成功以后，我们来查看一下 master 节点的状态：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# masterha_check_status -conf=/etc/mha_master/mha.cnf\nmha (pid:7598) is running(0:PING_OK), master:192.168.37.122\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("上面的信息中“mha (pid:7598) is running(0:PING_OK)”表示MHA服务运行")]),a._v(" "),s("p",[a._v("OK，否则， 则会显示为类似“mha is stopped(1:NOT_RUNNING).” 　　如果，我们想要停止 MHA ，则需要使用 stop 命令：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# masterha_stop -conf=/etc/mha_master/mha.cnf\n\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h3",{attrs:{id:"_3-4-测试-mha-故障转移"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-测试-mha-故障转移"}},[a._v("#")]),a._v(" 3.4 测试 MHA 故障转移")]),a._v(" "),s("h4",{attrs:{id:"_3-4-1-在-master-节点关闭-mariadb-服务-模拟主节点数据崩溃"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-1-在-master-节点关闭-mariadb-服务-模拟主节点数据崩溃"}},[a._v("#")]),a._v(" 3.4.1 在 master 节点关闭 mariadb 服务,模拟主节点数据崩溃")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@master ~]# killall -9 mysqld mysqld_safe\n[root@master ~]# rm -rf /var/lib/mysql/*\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h4",{attrs:{id:"_3-4-2-在-manger-节点查看日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-2-在-manger-节点查看日志"}},[a._v("#")]),a._v(" 3.4.2 在 manger 节点查看日志")]),a._v(" "),s("p",[a._v("我们来查看日志：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# tail -200 /etc/mha_master/manager.log\n……\nThu Nov 23 09:17:19 2017 - [info] Master failover to\n192.168.37.133(192.168.37.133:3306) completed successfully.\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("p",[a._v("表示 manager 检测到192.168.37.122节点故障， 而后自动执行故障转移， 将")]),a._v(" "),s("p",[a._v("192.168.37.133提升为主节点。")]),a._v(" "),s("p",[a._v("注意，"),s("strong",[a._v("故障转移完成后， manager将会自动停止")]),a._v("， 此时使用 masterha_check_status 命令检测将会遇到错误提示， 如下所示：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# masterha_check_status -conf=/etc/mha_master/mha.cnf\nmha is stopped(2:NOT_RUNNING).\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h3",{attrs:{id:"_3-5-提供新的从节点以修复复制集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-提供新的从节点以修复复制集群"}},[a._v("#")]),a._v(" 3.5 提供新的从节点以修复复制集群")]),a._v(" "),s("p",[a._v("原有 master 节点故障后，需要重新准备好一个新的 MySQL 节点。基于来自于master 节点的备份恢复数据后，将其配置为新的 master 的从节点即可。注意，新加入的节点如果为新增节点，其 IP 地址要配置为原来 master 节点的 IP，否则，还需要修改 mha.cnf 中相应的 ip 地址。随后再次启动 manager ，并再次检测其状态。")]),a._v(" "),s("p",[a._v("我们就以刚刚关闭的那台主作为新添加的机器，来进行数据库的恢复：")]),a._v(" "),s("p",[a._v("原本的 slave1 已经成为了新的主机器，所以，我们对其进行完全备份，而后把备份的数据发送到我们新添加的机器上：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@slave1 ~]# mkdir /backup\n[root@slave1 ~]# mysqldump --all-database > /backup/mysql-backup-`date +%F-\n%T`-all.sql\n[root@slave1 ~]# scp /backup/mysql-backup-2017-11-23-09\\:57\\:09-all.sql\nroot@node2:~\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("p",[a._v("然后在 node2 节点上进行数据恢复：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@master ~]# mysql < mysql-backup-2017-11-23-09\\:57\\:09-all.sql\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("接下来就是配置主从。照例查看一下现在的主的二进制日志和位置，然后就进行如下设置：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("MariaDB [(none)]> change master to master_host='192.168.37.133',\nmaster_user='slave', master_password='keer', master_log_file='mysqlbin.000006', master_log_pos=925;\nMariaDB [(none)]> start slave;\nMariaDB [(none)]> show slave status\\G;\n\t\t\t\tSlave_IO_State: Waiting for master to send event\n\t\t\t\t\tMaster_Host: 192.168.37.133\n\t\t\t\t\tMaster_User: slave\n\t\t\t\t\tMaster_Port: 3306\n\t\t\t\t\tConnect_Retry: 60\n\t\t\t\t\tMaster_Log_File: mysql-bin.000006\n\t\t\t\tRead_Master_Log_Pos: 925\n\t\t\t\tRelay_Log_File: mysql-relay-bin.000002\n\t\t\t\tRelay_Log_Pos: 529\n\t\t\t\tRelay_Master_Log_File: mysql-bin.000006\n\t\t\t\t\tSlave_IO_Running: Yes\n\t\t\t\t\tSlave_SQL_Running: Yes\n……\n\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br")])]),s("p",[a._v("可以看出，我们的主从已经配置好了。")]),a._v(" "),s("p",[a._v("本步骤完成。")]),a._v(" "),s("h3",{attrs:{id:"_3-6-新节点提供后再次执行检查操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-新节点提供后再次执行检查操作"}},[a._v("#")]),a._v(" 3.6 新节点提供后再次执行检查操作")]),a._v(" "),s("p",[a._v("我们来再次检测状态：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# masterha_check_repl -conf=/etc/mha_master/mha.cnf\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("如果报错，则再次授权。若没有问题，则启动 manager，注意，这次启动要"),s("strong",[a._v("记录日志")]),a._v("：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# masterha_manager -conf=/etc/mha_master/mha.cnf >\n/etc/mha_master/manager.log 2>&1 &\n[1] 10012\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("启动成功以后，我们来查看一下 master 节点的状态：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# masterha_check_status -conf=/etc/mha_master/mha.cnf\nmha (pid:9561) is running(0:PING_OK), master:192.168.37.133\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("我们的服务已经成功继续了。")]),a._v(" "),s("p",[a._v("本步骤结束。")]),a._v(" "),s("h3",{attrs:{id:"_3-7新节点上线-故障转换恢复注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-7新节点上线-故障转换恢复注意事项"}},[a._v("#")]),a._v(" 3.7新节点上线， 故障转换恢复注意事项")]),a._v(" "),s("p",[a._v("1）在生产环境中， 当你的主节点挂了后， 一定要在从节点上做一个备份， 拿着备份文件把主节点手动提升为从节点， 并指明从哪一个日志文件的位置开始复制　　2）每一次自动完成转换后， 每一次的(replication health )检测不ok始终都是启动不了必须手动修复主节点， 除非你改配置文件")]),a._v(" "),s("p",[a._v("3）手动修复主节点提升为从节点后， 再次运行检测命令")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# masterha_check_status -conf=/etc/mha_master/mha.cnf\nmha (pid:9561) is running(0:PING_OK), master:192.168.37.133\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("4）再次运行起来就恢复成功了")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("[root@manager ~]# masterha_manager --conf=/etc/mha_master/mha.cnf\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("以上。我们的实验已经圆满完成。")])])}),[],!1,null,null,null);s.default=n.exports}}]);
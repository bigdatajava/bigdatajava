(window.webpackJsonp=window.webpackJsonp||[]).push([[112],{478:function(s,n,e){"use strict";e.r(n);var a=e(5),t=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"版本"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#版本"}},[s._v("#")]),s._v(" 版本")]),s._v(" "),n("p",[s._v("logback-core-1.2.11.jar")]),s._v(" "),n("h2",{attrs:{id:"问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),n("p",[s._v('logback归档文件名，只能到“小时”，不支持 带"时分"格式；')]),s._v(" "),n("p",[s._v("举例：")]),s._v(" "),n("blockquote",[n("p",[s._v("xx_yyyyMMdd_HH_%i.log.gz (√ )")]),s._v(" "),n("p",[s._v("xx_yyyyMMdd_HH_%i.log.gz (×)")])]),s._v(" "),n("h2",{attrs:{id:"解决"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解决"}},[s._v("#")]),s._v(" 解决")]),s._v(" "),n("p",[s._v("logback支持自定义 归档策略，故基于、、"),n("code",[s._v("SizeAndTimeBasedRollingPolicy")]),s._v("策略重写，进行支持；")]),s._v(" "),n("h3",{attrs:{id:"_1-自定义归档策略-hmsrollingpolicy"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-自定义归档策略-hmsrollingpolicy"}},[s._v("#")]),s._v(" 1.自定义归档策略 HMSRollingPolicy")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('package com.stock.framework.logger;\n\nimport ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP;\nimport ch.qos.logback.core.rolling.TimeBasedRollingPolicy;\nimport ch.qos.logback.core.util.FileSize;\nimport com.stock.framework.util.UnConfusableInterface;\n\nimport java.io.File;\nimport java.time.Instant;\nimport java.time.LocalDateTime;\nimport java.time.LocalTime;\nimport java.time.ZoneId;\nimport java.util.regex.Pattern;\n\n\n/**\n * 类介绍：满足logback.xml中 fileSizePerCategory 配置的大小后，压缩文件名中添加当前【时/分/秒】进行存档（通过fileNamePattern配置精度到为时/分/秒）\n *\n * 类使用：logback.xml配置示例如下：\n * <appender name="demo_appender" class="ch.qos.logback.core.rolling.RollingFileAppender">\n * \t\t<file>${baseDir}/message/mq_api_all.log</file> \x3c!--修改点：实际日志文件名--\x3e\n * \t\t<encoder>\n * \t\t\t<pattern>${globalPatternLayout}</pattern>\n * \t\t</encoder>\n * \t\t<rollingPolicy class="com.croot.HMSRollingPolicy">  \x3c!--修改点：使用自定义滚动策略--\x3e\n * \t\t\t\x3c!-- 每天日志归档路径以及格式 --\x3e\n * \t\t\t<fileNamePattern>${baseDir}/message/%d{yyyy,aux}/mq_api_all-%d{yyyyMMdd_HHmmss}-%i.log.gz</fileNamePattern> \x3c!--修改点：如果不需要压缩，直接去掉压缩方式即可--\x3e\n * \t\t\t<maxFileSize>${fileSizePerCategory}</maxFileSize>  \x3c!--修改点：必填项--\x3e\n * \t\t\t\x3c!--日志文件保留天数--\x3e\n * \t\t\t<maxHistory>${maxHistory}</maxHistory> \x3c!--修改点：单位：天；如果不配置-则日志文件一直保存--\x3e\n * \t\t\t\x3c!--启动时清理日志文件  此项置灰清理超过保留天数的  也会清理超过总大小的--\x3e\n * \t\t\t<cleanHistoryOnStart>false</cleanHistoryOnStart>\n * \t\t</rollingPolicy>\n * \t</appender>\n *\n * 类关系：\n * 源码：SizeAndTimeBasedRollingPolicy(extend TimeBasedRollingPolicy) 使用 SizeAndTimeBasedFNATP(extend TimeBasedFileNamingAndTriggeringPolicyBase)\n * 改造：HMSRollingPolicy(extend TimeBasedRollingPolicy) 使用 HMSTriggeringPolicy(extend SizeAndTimeBasedFNATP)\n *\n * @param <E>\n */\npublic class HMSRollingPolicy<E> extends TimeBasedRollingPolicy<E> implements UnConfusableInterface {\n\n\n    FileSize maxFileSize;//logback.xml中配置的 <maxFileSize>\n    private static Pattern hourFormatPattern = Pattern.compile(".*\\\\{.*HH.*\\\\}.*");\n    private static Pattern minuteFormatPattern = Pattern.compile(".*\\\\{.*mm.*\\\\}.*");\n    private static Pattern secondFormatPattern = Pattern.compile(".*\\\\{.*ss.*\\\\}.*");\n\n    @Override\n    public void start() {\n        HMSTriggeringPolicy<E> sizeAndTimeBasedFNATP = new HMSTriggeringPolicy<E>();\n        if(maxFileSize == null) {\n            addError("maxFileSize property is mandatory.");\n            return;\n        } else {\n            addInfo("Archive files will be limited to ["+maxFileSize+"] each.");\n        }\n\n        sizeAndTimeBasedFNATP.setMaxFileSize(maxFileSize);\n        super.setTimeBasedFileNamingAndTriggeringPolicy(sizeAndTimeBasedFNATP);\n        /*\n        日志最大保存时间（logback.xml配置项maxHistory单位为：天；）\n        此处需要根据logback.xml中<FileNamePattern>配置的时间单位，转为对应的时/分/秒\n         */\n        if (super.getMaxHistory() != 0) {\n            if (secondFormatPattern.matcher(super.getFileNamePattern()).find()) {\n                super.setMaxHistory(super.getMaxHistory()*24*60*60);\n            } else if (minuteFormatPattern.matcher(super.getFileNamePattern()).find()) {\n                super.setMaxHistory(super.getMaxHistory()*24*60);\n            } else if (hourFormatPattern.matcher(super.getFileNamePattern()).find()) {\n                super.setMaxHistory(super.getMaxHistory()*24);\n            }\n        }//super.getMaxHistory()==0时，则日志文件永久保留；\n\n        if(!isUnboundedTotalSizeCap() && totalSizeCap.getSize() < maxFileSize.getSize()) {\n            addError("totalSizeCap of ["+totalSizeCap+"] is smaller than maxFileSize ["+maxFileSize+"] which is non-sensical");\n            return;\n        }\n        // most work is done by the parent\n        super.start();\n    }\n\n    //logback启动，初始化时用到\n    public void setMaxFileSize(FileSize aMaxFileSize) {\n        this.maxFileSize = aMaxFileSize;\n    }\n\n    @Override\n    public String toString() {\n        return "c.q.l.core.rolling.HMSRollingPolicy@"+this.hashCode();\n    }\n\n}\n\n/**\n * 类介绍：触发归档，触发策略；\n * 核心方法isTriggeringEvent：先判断大小是否满足logback.xml配置的参数 fileSizePerCategory\n * @param <E>\n */\nclass HMSTriggeringPolicy<E> extends SizeAndTimeBasedFNATP<E> implements UnConfusableInterface{\n    FileSize maxFileSize;\n\n    private long nextDayStartTimestamp;\n\n    @Override\n    public void start() {\n        super.setMaxFileSize(maxFileSize);\n        super.start();\n    }\n\n    public boolean isTriggeringEvent(File activeFile, final E event) {\n\n        //跨天需要创建新日志\n        long currentTimestamp = getCurrentTime();\n        if (currentTimestamp >= nextDayStartTimestamp) {\n            refreshNextDayStartTimestamp(currentTimestamp);\n            return super.isTriggeringEvent(activeFile, event);\n        }\n\n        if (activeFile.length() >= maxFileSize.getSize()) {\n            return super.isTriggeringEvent(activeFile, event);\n        }\n        return false;\n    }\n\n    public void setMaxFileSize(FileSize maxFileSize) {\n        this.maxFileSize = maxFileSize;\n    }\n\n    private void refreshNextDayStartTimestamp(long currentTimestamp) {\n        Instant instant = Instant.ofEpochMilli(currentTimestamp);\n\n        LocalDateTime localDateTime = LocalDateTime.ofInstant(instant, ZoneId.systemDefault());\n\n        LocalDateTime nextDayStart = localDateTime.plusDays(1).with(LocalTime.MIN);\n\n        nextDayStartTimestamp =\n                nextDayStart.atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();\n    }\n\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br"),n("span",{staticClass:"line-number"},[s._v("106")]),n("br"),n("span",{staticClass:"line-number"},[s._v("107")]),n("br"),n("span",{staticClass:"line-number"},[s._v("108")]),n("br"),n("span",{staticClass:"line-number"},[s._v("109")]),n("br"),n("span",{staticClass:"line-number"},[s._v("110")]),n("br"),n("span",{staticClass:"line-number"},[s._v("111")]),n("br"),n("span",{staticClass:"line-number"},[s._v("112")]),n("br"),n("span",{staticClass:"line-number"},[s._v("113")]),n("br"),n("span",{staticClass:"line-number"},[s._v("114")]),n("br"),n("span",{staticClass:"line-number"},[s._v("115")]),n("br"),n("span",{staticClass:"line-number"},[s._v("116")]),n("br"),n("span",{staticClass:"line-number"},[s._v("117")]),n("br"),n("span",{staticClass:"line-number"},[s._v("118")]),n("br"),n("span",{staticClass:"line-number"},[s._v("119")]),n("br"),n("span",{staticClass:"line-number"},[s._v("120")]),n("br"),n("span",{staticClass:"line-number"},[s._v("121")]),n("br"),n("span",{staticClass:"line-number"},[s._v("122")]),n("br"),n("span",{staticClass:"line-number"},[s._v("123")]),n("br"),n("span",{staticClass:"line-number"},[s._v("124")]),n("br"),n("span",{staticClass:"line-number"},[s._v("125")]),n("br"),n("span",{staticClass:"line-number"},[s._v("126")]),n("br"),n("span",{staticClass:"line-number"},[s._v("127")]),n("br"),n("span",{staticClass:"line-number"},[s._v("128")]),n("br"),n("span",{staticClass:"line-number"},[s._v("129")]),n("br"),n("span",{staticClass:"line-number"},[s._v("130")]),n("br"),n("span",{staticClass:"line-number"},[s._v("131")]),n("br"),n("span",{staticClass:"line-number"},[s._v("132")]),n("br"),n("span",{staticClass:"line-number"},[s._v("133")]),n("br"),n("span",{staticClass:"line-number"},[s._v("134")]),n("br"),n("span",{staticClass:"line-number"},[s._v("135")]),n("br"),n("span",{staticClass:"line-number"},[s._v("136")]),n("br"),n("span",{staticClass:"line-number"},[s._v("137")]),n("br"),n("span",{staticClass:"line-number"},[s._v("138")]),n("br"),n("span",{staticClass:"line-number"},[s._v("139")]),n("br"),n("span",{staticClass:"line-number"},[s._v("140")]),n("br"),n("span",{staticClass:"line-number"},[s._v("141")]),n("br"),n("span",{staticClass:"line-number"},[s._v("142")]),n("br")])]),n("h3",{attrs:{id:"_2-logback-xml中使用自定义策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-logback-xml中使用自定义策略"}},[s._v("#")]),s._v(" 2. logback.xml中使用自定义策略")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('\t<appender name="TEST_APPENDER" class="ch.qos.logback.core.rolling.RollingFileAppender">\n\t\t<file>${baseDir}/test/test.log</file>\n\t\t<encoder>\n\t\t\t<pattern>[%p][%d{yyyy-MM-dd HH:mm:ss.SSS}][%t] %m%n%rEx</pattern>\n\t\t</encoder>\n\t\t<rollingPolicy class="com.stock.framework.logger.HMSRollingPolicy">\n\t\t\t\x3c!-- 每天日志归档路径以及格式 --\x3e\n\t\t\t<fileNamePattern>${baseDir}/test/%d{yyyy-MM-dd,aux}/test_%d{yyyyMMdd_HHmm}_%i.log.gz</fileNamePattern>\n\t\t\t<maxFileSize>${fileSizePerCategory}</maxFileSize>\n\t\t\t\x3c!--启动时清理日志文件  此项置灰清理超过保留天数的  也会清理超过总大小的--\x3e\n\t\t\t<cleanHistoryOnStart>false</cleanHistoryOnStart>\n\t\t</rollingPolicy>\n\t\t<filter class="ch.qos.logback.classic.filter.ThresholdFilter">\n\t\t\t<level>debug</level>\n\t\t</filter>\n\t</appender>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("至此项目中，使用"),n("code",[s._v("TEST_APPENDER")]),s._v("就能生成归档压缩文件，带时分的日志了")])])}),[],!1,null,null,null);n.default=t.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[108],{474:function(s,a,n){"use strict";n.r(a);var e=n(5),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"nginx-之-location-rewrite-反向代理及负载均衡"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-之-location-rewrite-反向代理及负载均衡"}},[s._v("#")]),s._v(" nginx 之 location,rewrite,反向代理及负载均衡")]),s._v(" "),a("h2",{attrs:{id:"一、location-的语法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、location-的语法"}},[s._v("#")]),s._v(" 一、location 的语法")]),s._v(" "),a("p",[s._v("locltion可以把不同方式的请求，定位到不同的处理方式上（个人感觉有点像java中的filter）")]),s._v(" "),a("h3",{attrs:{id:"_1-1-location分类及用法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-location分类及用法"}},[s._v("#")]),s._v(" 1.1 location分类及用法")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("location大致分为三类：\n\nlocation = patt {} [精准匹配]\n\nlocation patt{} [一般匹配]\n\nlocation ~ patt{} [正则匹配]\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("location / {//定位，个人理解就是java中的filter。\n            root   html;   //符合条件请求转发路径\n            index  index.html index.htm;      //索引\n        }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("如果访问的页面为xxx.com\n首先因为访问的是/会进入该location然后给出的索引为index.html\n接下来回去访问/index.html继续命中该location\n然后到html路径下去寻找index.html\nroot为资源存放的目录，该例子是放在html（nginx安装根目录下的html文件夹的相对路径），可以使用/开头表示绝对路径\nindex为索引\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h3",{attrs:{id:"_1-2-location执行流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-location执行流程"}},[s._v("#")]),s._v(" 1.2 location执行流程")]),s._v(" "),a("p",[s._v("[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Xo9KoPxn-1578729094199)(https://github.com/bigdatajava/blogspot/raw/master/img/tuchuang/nginx.jpg)]")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("1、首先查看精准匹配是否匹配成功，如果成功则返回结果并停止解析过程\n\n2、查看普通匹配是否匹配成功，如果匹配成功，把匹配成功最长的记录下来\n\n3、依次寻找正则匹配，如果有一个匹配，立马返回结果并停止解析过程\n\n4、如果正则都不匹配则返回普通匹配中记录的最长匹配\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h2",{attrs:{id:"二、rewrite重写"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、rewrite重写"}},[s._v("#")]),s._v(" 二、rewrite重写")]),s._v(" "),a("h3",{attrs:{id:"_2-1-重写中用到的指令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-重写中用到的指令"}},[s._v("#")]),s._v(" 2.1 重写中用到的指令")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("if (条件) {} 设定条件,再进行重写\n\nset #设置变量\n\nreturn #返回状态码\n\nbreak #跳出rewrite\n\nrewrite #重写\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h2",{attrs:{id:"_2-2-语法格式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-语法格式"}},[s._v("#")]),s._v(" 2.2 语法格式")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("If 语法格式:\nIf 空格 (条件) {\n\t重写模式\n}\n\n条件又怎么写?\n答:3种写法\n\n1: “=”来判断相等, 用于字符串比较\n2: “~” 用正则来匹配(此处的正则区分大小写) \n\t~* 不区分大小写的正则\n3: -f -d -e来判断是否为文件,为目录,是否存在.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("例子:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("if ($remote_addr = 192.168.1.100) {\nreturn 403;\n}\nif ($http_user_agent ~ MSIE) {\nrewrite ^.*$ /ie.htm;\nbreak; #(不break会循环重定向)\n}\nif (!-e $document_root$fastcgi_script_name) {\nrewrite ^.*$ /404.html break;\n} \nif ($http_user_agent ~* msie) {\nset $isie 1;\n}\nif ($fastcgi_script_name = ie.html) {\nset $isie 0;\n}\nif ($isie 1) {\nrewrite ^.*$ ie.html;\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h2",{attrs:{id:"三、反向代理及负载均衡"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、反向代理及负载均衡"}},[s._v("#")]),s._v(" 三、反向代理及负载均衡")]),s._v(" "),a("h3",{attrs:{id:"_3-1-反向代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-反向代理"}},[s._v("#")]),s._v(" 3.1 反向代理")]),s._v(" "),a("h4",{attrs:{id:"_1-主要使用proxy-pass方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-主要使用proxy-pass方法"}},[s._v("#")]),s._v(" 1) 主要使用proxy_pass方法")]),s._v(" "),a("p",[s._v("例如：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("location ~ .*\\.(jpg|png|gif|bmp)$ {\n\tproxy_pass http://imagesever;\n}\n\nupstream imagesever {\nserver 127.0.0.1:8080 weight=1 max_fails=2 fail_timeout=30s;\nserver 127.0.0.1:8081 weight=1 max_fails=2 fail_timeout=30s;\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h4",{attrs:{id:"_2-upstream每个设备的状态说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-upstream每个设备的状态说明"}},[s._v("#")]),s._v(" 2) upstream每个设备的状态说明")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("1.down 表示单前的server暂时不参与负载\n\n2.weight 默认为1.weight越大，负载的权重就越大。\n\n3.max_fails ：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误\n\n4.fail_timeout:max_fails次失败后，暂停的时间。\n\n5.backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h4",{attrs:{id:"_3-upstream负载均衡方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-upstream负载均衡方式"}},[s._v("#")]),s._v(" 3) upstream负载均衡方式")]),s._v(" "),a("p",[s._v("nginx的upstream目前支持5种方式的分配")]),s._v(" "),a("p",[s._v("1、轮询（默认）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("2、weight")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("例如：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("upstream bakend {\n    server 192.168.0.14 weight=10;\n    server 192.168.0.15 weight=10;\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("3、ip_hash")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("例如：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("upstream bakend {\n\tip_hash;\n    server 192.168.0.14:88;\n    server 192.168.0.15:80;\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("4、fair（第三方）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("按后端服务器的响应时间来分配请求，响应时间短的优先分配。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("upstream backend {\n    server server1;\n    server server2;\n    fair;\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("5、url_hash（第三方）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("例：在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("upstream backend {\n    server squid1:3128;\n    server squid2:3128;\n    hash $request_uri;\n    hash_method crc32;\n}\ntips:\nupstream bakend{\t#定义负载均衡设备的Ip及设备状态\n    ip_hash;\n    server 127.0.0.1:9090 down;\n    server 127.0.0.1:8080 weight=2;\n    server 127.0.0.1:6060;\n    server 127.0.0.1:7070 backup;\n}\n\n在需要使用负载均衡的server中增加\nproxy_pass http://bakend/;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("hr")])}),[],!1,null,null,null);a.default=t.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[253],{619:function(s,n,a){"use strict";a.r(n);var t=a(5),e=Object(t.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("U2FsdGVkX1/8daTOofFkGZUtxS9fHBKtQr7awWXRlXQMpIl0z62rNOA9Ow2yv7+A\nrLD9pnty6PlQzflMUg2Y2Fyzdg2YgAmMe33/191bIFg0Af+BXY0BN11P0olHb5/R\njw==\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[n("strong",[s._v("一、采集Tomcat服务器日志信息")])]),s._v(" "),n("p",[n("strong",[s._v("1、需求")])]),s._v(" "),n("p",[s._v("Tomcat服务器运行过程中产生很多日志信息，通过LogStash采集并存储日志信息至ElasticSearch中")]),s._v(" "),n("p",[s._v("打开这个文件，如下图所示。我们发现，是一个纯文本格式的日志。如下图所示：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623173241517.png",alt:"image-20220623173241517"}})]),s._v(" "),n("p",[s._v("这个日志其实由一个个的字段拼接而成，参考以下表格。")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("字段名")]),s._v(" "),n("th",[s._v("说明")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("client IP")]),s._v(" "),n("td",[s._v("浏览器端IP")])]),s._v(" "),n("tr",[n("td",[s._v("timestamp")]),s._v(" "),n("td",[s._v("请求的时间戳")])]),s._v(" "),n("tr",[n("td",[s._v("method")]),s._v(" "),n("td",[s._v("请求方式（GET/POST）")])]),s._v(" "),n("tr",[n("td",[s._v("uri")]),s._v(" "),n("td",[s._v("请求的链接地址")])]),s._v(" "),n("tr",[n("td",[s._v("status")]),s._v(" "),n("td",[s._v("服务器端响应状态")])]),s._v(" "),n("tr",[n("td",[s._v("length")]),s._v(" "),n("td",[s._v("响应的数据长度")])]),s._v(" "),n("tr",[n("td",[s._v("reference")]),s._v(" "),n("td",[s._v("从哪个URL跳转而来")])]),s._v(" "),n("tr",[n("td",[s._v("browser")]),s._v(" "),n("td",[s._v("浏览器")])])])]),s._v(" "),n("p",[s._v("为了便于后期数据分析，需要将该日志信息解析成指定字段的filed的值并存储，便于后期分析")]),s._v(" "),n("p",[n("strong",[s._v("2、准备日志数据")])]),s._v(" "),n("p",[s._v("将Tomcat日志文件上传到指定的目录")]),s._v(" "),n("p",[n("strong",[s._v("3、使用FileBeats将日志发送到Logstash")])]),s._v(" "),n("p",[s._v("之前，我们使用的FileBeat是通过FileBeat的Harvester组件监控日志文件，然后将日志以一定的格式保存到Elasticsearch中，而现在我们需要配置FileBeats将数据发送到Logstash再将数据发送至ElasticSearch")]),s._v(" "),n("p",[s._v("FileBeat相关信息按照如下格式配置即可：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('#----------------------------- Logstash output ---------------------------------\n#output.logstash:\n  # Boolean flag to enable or disable the output module.\n  #enabled: true\n\n  # The Logstash hosts\n  #hosts: ["localhost:5044"]\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("hosts配置的是Logstash监听的IP地址/机器名以及端口号")]),s._v(" "),n("p",[n("strong",[s._v("进入fileBeat安装路径并准备FileBeat配置文件")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("cd /usr/local/es/filebeat-7.6.1-linux-x86_64\ntouch filebeat-logstash.yml\nvim filebeat-logstash.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("因为Tomcat的web log日志都是以IP地址开头的，所以我们需要修改下匹配字段。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("filebeat.inputs:\n- type: log\n  enabled: true\n  paths:\n    - /var/tomcat/log/access*.*\n  multiline.pattern: '^\\\\d+\\\\.\\\\d+\\\\.\\\\d+\\\\.\\\\d+ '\n  multiline.negate: true\n  multiline.match: after\n\noutput.logstash:\n   enabled: true\n   hosts: [\"192.168.21.133:5044\"]\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("注意该配置：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("multiline.pattern: '^\\\\d+\\\\.\\\\d+\\\\.\\\\d+\\\\.\\\\d+ '\n  multiline.negate: false\n  multiline.match: after\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("表示以ip地址开头的行追加到上一行")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("multiline:\n    pattern: '^[0-2][0-9]:[0-5][0-9]:[0-5][0-9]'\n    negate: true\n    match: after\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("上面配置的意思是：不以时间格式开头的行都合并到上一行的末尾（正则写的不好，忽略忽略）")]),s._v(" "),n("p",[s._v("pattern：正则表达式")]),s._v(" "),n("p",[s._v("negate：true 或 false；默认是false，匹配pattern的行合并到上一行；true，不匹配pattern的行合并到上一行")]),s._v(" "),n("p",[s._v("match：after 或 before，合并到上一行的末尾或开头")]),s._v(" "),n("p",[n("strong",[s._v("启动FileBeat，并指定使用指定的配置文件")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("./filebeat -e -c filebeat-logstash.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("FileBeat将尝试建立与Logstash监听的IP和端口号进行连接。但此时，我们并没有开启并配置Logstash，所以FileBeat是无法连接到Logstash的。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("2021-06-01T11:28:47.585+0800    ERROR   pipeline/output.go:100  Failed to connect to backoff(async(tcp://节点IP:5044)): dial tcp 192.168.21.130:5044: connect: connection refused\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[n("strong",[s._v("4、配置Logstash接收FileBeat收集的数据并打印")])]),s._v(" "),n("p",[s._v("Logstash的配置文件和FileBeat类似，它也需要有一个input、和output。")]),s._v(" "),n("p",[s._v("基本格式如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# #号表示添加注释\n# input表示要接收的数据\ninput {\n}\n\n# file表示对接收到的数据进行过滤处理\nfilter {\n\n}\n\n# output表示将数据输出到其他位置\noutput {\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[n("strong",[s._v("配置从FileBeat接收数据")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("cd /usr/local/es/logstash-7.6.1\nvim config/filebeat-console.conf\ninput {\n    beats {\n      port => 5044\n    }\n}\n\noutput {\n    stdout {\n      codec => rubydebug\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("注意：上述文字复制粘贴会存在格式问题，可以复制粘贴到记事本去除特殊格式")]),s._v(" "),n("p",[n("strong",[s._v("测试logstash配置是否正确")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("bin/logstash -f config/filebeat-console.conf --config.test_and_exit\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("启动失败")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623173312786.png",alt:"image-20220623173312786"}})]),s._v(" "),n("p",[s._v("启动成功")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[2021-06-01T11:46:33,940][INFO ][logstash.runner] Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[n("strong",[s._v("启动logstash")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("bin/logstash -f config/filebeat-console.conf --config.reload.automatic\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("reload.automatic：修改配置文件时自动重新加载")]),s._v(" "),n("p",[n("strong",[s._v("测试")])]),s._v(" "),n("p",[s._v("在/var/tomcat/log创建一个test文件，并写入以下内容")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('cd /var/tomcat/log\nvim test\n192.168.21.132 - - [8/May/2021:00:27:20 +0819] "POST /tuling.com/index1.html HTTP/1.1" 200 900 "www.jd.com" "Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.104 Safari/537.36 Core/1.53.4549.400 QQBrowser/9.7.12900"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("往文本中加入新的数据进行测试")]),s._v(" "),n("p",[s._v("启动Logstash之后，查看Logstash接收到fileBeat传输过来的数据")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n           "log" => {\n          "file" => {\n            "path" => "/var/tomcat/log/access.log.test"\n        },\n        "offset" => 825\n    },\n         "input" => {\n        "type" => "log"\n    },\n         "agent" => {\n        "ephemeral_id" => "d4c3b652-4533-4ebf-81f9-a0b78c0d4b05",\n             "version" => "7.6.1",\n                "type" => "filebeat",\n                  "id" => "b4c5c4dc-03c3-4ba4-9400-dc6afcb36d64",\n            "hostname" => "节点IP"\n    },\n    "@timestamp" => 2021-06-01T09:07:55.236Z,\n           "ecs" => {\n        "version" => "1.4.0"\n    },\n          "host" => {\n        "name" => "节点IP"\n    },\n          "tags" => [\n        [0] "beats_input_codec_plain_applied"\n    ],\n       "message" => "192.168.21.132 - - [15/Apr/2015:00:27:19 +0849] \\"POST /tuling.com/bigdata.html 200 45 \\"www.baidu.com\\" \\"Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.104 Safari/537.36 Core/1.53.4549.400 QQBrowser/9.7.12900 144.180.122.249",\n      "@version" => "1"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])]),n("p",[n("strong",[s._v("5、Logstash输出数据到Elasticsearch")])]),s._v(" "),n("p",[s._v("如果我们需要将数据输出值ES而不是控制台的话，我们修改Logstash的output配置。")]),s._v(" "),n("p",[s._v("例如：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('output {\n    elasticsearch {\n       hosts => [ "localhost:9200" ]\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("操作步骤：")]),s._v(" "),n("p",[s._v("1）重新拷贝一份配置文件")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("cd /usr/local/es/logstash-7.6.1\ntouch config/filebeat-elasticSearch.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("2）将output修改为Elasticsearch")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('vim config/filebeat-elasticSearch.conf\ninput {\n    beats {\n      port => 5044\n    }\n}\n\noutput {\n    elasticsearch {\n    hosts => [ "192.168.21.130:9200","192.168.21.131:9200","192.168.21.132:9200"]\n}\nstdout {\n    codec => rubydebug\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("3）重新启动Logstash")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("bin/logstash -f config/filebeat-elasticSearch.conf --config.reload.automatic\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("4）追加一条日志到监控的文件中，并查看Elasticsearch中的索引、文档")]),s._v(" "),n("p",[s._v("5）查看索引数据是否创建成功")]),s._v(" "),n("p",[s._v("GET /_cat/indices?v")]),s._v(" "),n("p",[s._v("我们在Elasticsearch中发现一个以logstash开头的索引。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n        "health": "green",\n        "status": "open",\n        "index": "logstash-2021.06.01-000001",\n        "uuid": "147Uwl1LRb-HMFERUyNEBw",\n        "pri": "1",\n        "rep": "1",\n        "docs.count": "2",\n        "docs.deleted": "0",\n        "store.size": "44.8kb",\n        "pri.store.size": "22.4kb"\n    }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("// 查看索引库的数据")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /logstash-2021.06.01-000001/_search?format=txt\n{\n    "from": 0,\n    "size": 1\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("我们可以获取到以下数据：")]),s._v(" "),n("p",[s._v("从输出返回结果，我们可以看到，日志确实已经保存到了Elasticsearch中，而且我们看到消息数据是封装在名为"),n("strong",[s._v("message")]),s._v("中的，其他的数据也封装在一个个的字段中。我们其实更想要把消息解析成一个个的字段。例如：IP字段、时间、请求方式、请求URL、响应结果，这样。")]),s._v(" "),n("p",[n("strong",[s._v("6、Logstash过滤器")])]),s._v(" "),n("p",[s._v("从日志文件中收集到的数据包含了很多有效信息，比如IP、时间等，")]),s._v(" "),n("p",[s._v("在Logstash中可以配置过滤器Filter对采集到的数据进行过滤处理，在Logstash中，有大量的插件供我们使用。")]),s._v(" "),n("p",[s._v("参考官网：")]),s._v(" "),n("p",[s._v("https://www.elastic.co/guide/en/logstash/7.6/filter-plugins.html")]),s._v(" "),n("p",[s._v("6.1、"),n("strong",[s._v("查看Logstash已经安装的插件")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("cd /usr/local/es/logstash-7.6.1/\nbin/logstash-plugin list\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("此处，我们重点来讲解Grok插件")]),s._v(" "),n("p",[s._v("6.2、"),n("strong",[s._v("Grok插件")])]),s._v(" "),n("p",[s._v("Grok是一种将非结构化日志解析为结构化的插件。这个工具非常适合用来解析系统日志、Web服务器日志、MySQL或者是任意其他的日志格式。")]),s._v(" "),n("p",[s._v("Grok官网：https://www.elastic.co/guide/en/logstash/7.6/plugins-filters-grok.html")]),s._v(" "),n("p",[s._v("6.3、"),n("strong",[s._v("Grok语法")])]),s._v(" "),n("p",[s._v("Grok是通过模式匹配的方式来识别日志中的数据,可以把Grok插件简单理解为升级版本的正则表达式。它拥有更多的模式，默认，Logstash拥有120个模式。如果这些模式不满足我们解析日志的需求，我们可以直接使用正则表达式来进行匹配。")]),s._v(" "),n("p",[s._v("官网：https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns")]),s._v(" "),n("p",[s._v("grok模式的语法是：%{SYNTAX:SEMANTIC}")]),s._v(" "),n("p",[s._v("SYNTAX指的是Grok模式名称，SEMANTIC是给模式匹配到的文本字段名。例如：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("%{NUMBER:duration} %{IP:client}\nduration表示：匹配一个数字，client表示匹配一个IP地址。\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("默认在Grok中，所有匹配到的的数据类型都是字符串，如果要转换成int类型（目前只支持int和float），可以这样：%{NUMBER:duration:int} %{IP:client}")]),s._v(" "),n("p",[s._v("以下是常用的Grok模式：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("NUMBER")]),s._v(" "),n("th",[s._v("匹配数字（包含：小数）")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("INT")]),s._v(" "),n("td",[s._v("匹配整形数字")])]),s._v(" "),n("tr",[n("td",[s._v("POSINT")]),s._v(" "),n("td",[s._v("匹配正整数")])]),s._v(" "),n("tr",[n("td",[s._v("WORD")]),s._v(" "),n("td",[s._v("匹配单词")])]),s._v(" "),n("tr",[n("td",[s._v("DATA")]),s._v(" "),n("td",[s._v("匹配所有字符")])]),s._v(" "),n("tr",[n("td",[s._v("IP")]),s._v(" "),n("td",[s._v("匹配IP地址")])]),s._v(" "),n("tr",[n("td",[s._v("PATH")]),s._v(" "),n("td",[s._v("匹配路径")])])])]),s._v(" "),n("p",[s._v("1）"),n("strong",[s._v("用法")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623173352584.png",alt:"image-20220623173352584"}})]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('filter {\n    grok {\n      match => { "message" => "%{IP:client} %{WORD:method} %{URIPATHPARAM:request} %{NUMBER:bytes} %{NUMBER:duration}" }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[n("strong",[s._v("匹配日志中的IP、日期并打印")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('90.224.57.84 - - [15/Apr/2021:00:27:19 +0800] "POST /report HTTP/1.1" 404 21 "www.baidu.com" "Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.104 Safari/537.36 Core/1.53.4549.400 QQBrowser/9.7.12900"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("%{IP:ip} - - \\[%{HTTPDATE:date}\\]\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[n("strong",[s._v("配置Grok过滤插件")])]),s._v(" "),n("p",[s._v("1、配置Logstash")]),s._v(" "),n("p",[s._v("vim config/filebeat-filter-console.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('input {\n    beats {\n        port => 5044\n    }\n}\n\nfilter {\n    grok {\n        match => { \n            "message" => "%{IP:ip} - - \\[%{HTTPDATE:date}\\]" \n        }\n    }   \n}\n\noutput {\n    stdout {\n        codec => rubydebug\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("2、启动Logstash")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("bin/logstash -f config/filebeat-filter-console.conf --config.reload.automatic\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n           "log" => {\n        "offset" => 1861,\n          "file" => {\n            "path" => "/var/tomcat/log/access.log.test"\n        }\n    },\n         "input" => {\n        "type" => "log"\n    },\n          "tags" => [\n        [0] "beats_input_codec_plain_applied"\n    ],\n          "date" => "15/Apr/2015:00:27:19 +0849",\n           "ecs" => {\n        "version" => "1.4.0"\n    },\n   "@timestamp" => 2021-06-01T11:02:05.809Z,\n       "message" => "192.168.21.133 - - [15/Apr/2015:00:27:19 +0849] \\"POST /tuling.com/bigdata.html 200 45 \\"www.baidu.com\\" \\"Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.104 Safari/537.36 Core/1.53.4549.400 QQBrowser/9.7.12900 144.180.122.249",\n          "host" => {\n        "name" => "tuling.com"\n    },\n            "ip" => "192.168.21.133",\n         "agent" => {\n            "hostname" => "tuling.com",\n             "version" => "7.6.1",\n        "ephemeral_id" => "d4c3b652-4533-4ebf-81f9-a0b78c0d4b05",\n                  "id" => "b4c5c4dc-03c3-4ba4-9400-dc6afcb36d64",\n                "type" => "filebeat"\n    },\n      "@version" => "1"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])]),n("p",[s._v("我们看到，经过Grok过滤器插件处理之后，我们已经获取到了ip和date两个字段。接下来，我们就可以继续解析其他的字段。")]),s._v(" "),n("p",[n("strong",[s._v("3、解析所有字段")])]),s._v(" "),n("p",[s._v("将日志解析成以下字段：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("字段名")]),s._v(" "),n("th",[s._v("说明")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("client IP")]),s._v(" "),n("td",[s._v("浏览器端IP")])]),s._v(" "),n("tr",[n("td",[s._v("timestamp")]),s._v(" "),n("td",[s._v("请求的时间戳")])]),s._v(" "),n("tr",[n("td",[s._v("method")]),s._v(" "),n("td",[s._v("请求方式（GET/POST）")])]),s._v(" "),n("tr",[n("td",[s._v("uri")]),s._v(" "),n("td",[s._v("请求的链接地址")])]),s._v(" "),n("tr",[n("td",[s._v("status")]),s._v(" "),n("td",[s._v("服务器端响应状态")])]),s._v(" "),n("tr",[n("td",[s._v("length")]),s._v(" "),n("td",[s._v("响应的数据长度")])]),s._v(" "),n("tr",[n("td",[s._v("reference")]),s._v(" "),n("td",[s._v("从哪个URL跳转而来")])]),s._v(" "),n("tr",[n("td",[s._v("browser")]),s._v(" "),n("td",[s._v("浏览器")])])])]),s._v(" "),n("p",[s._v("为了方便进行Grok开发，此处使用Kibana来进行调试：")]),s._v(" "),n("p",[s._v("我们使用IP就可以把前面的IP字段匹配出来，使用HTTPDATE可以将后面的日期匹配出来。")]),s._v(" "),n("p",[s._v("为了方便测试，我们可以使用Kibana来进行Grok开发：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623173405343.png",alt:"image-20220623173405343"}})]),s._v(" "),n("p",[n("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623173413955.png",alt:"image-20220623173413955"}})]),s._v(" "),n("p",[s._v("可以在Kibana中先把Grok的表达式写好，然后再放入到Logstash的配置文件中，这样可以大大提升调试的效率。")]),s._v(" "),n("p",[s._v("\\1. 修改Logstash配置文件")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('input {\n    beats {\n        port => 5044\n    }\n}\n\nfilter {\n    grok {\n        match => { \n            "message" => "%{IP:ip} - - \\[%{HTTPDATE:date}\\] \\"%{WORD:method} %{PATH:uri} %{DATA}\\" %{INT:status} %{INT:length} \\"%{DATA:reference}\\" \\"%{DATA:browser}\\"" \n        }\n    }   \n}\n\noutput {\n    stdout {\n        codec => rubydebug\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("\\2. 测试并启动Logstash")]),s._v(" "),n("p",[s._v("我们可以看到，8个字段都已经成功解析。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n     "reference" => "www.baidu.com",\n      "@version" => "1",\n           "ecs" => {\n        "version" => "1.4.0"\n    },\n    "@timestamp" => 2021-06-02T03:30:10.048Z,\n            "ip" => "235.9.200.241",\n        "method" => "POST",\n           "uri" => "/tuling.com/bigdata.html",\n         "agent" => {\n                  "id" => "b4c5c4dc-03c3-4ba4-9400-dc6afcb36d64",\n        "ephemeral_id" => "734ae9d8-bcdc-4be6-8f97-34387fcde972",\n             "version" => "7.6.1",\n            "hostname" => "节点ip",\n                "type" => "filebeat"\n    },\n        "length" => "45",\n        "status" => "200",\n           "log" => {\n          "file" => {\n            "path" => "/var/tomcat/log/access.log"\n        },\n        "offset" => 1\n    },\n         "input" => {\n        "type" => "log"\n    },\n          "host" => {\n        "name" => "节点ip"\n    },\n          "tags" => [\n        [0] "beats_input_codec_plain_applied"\n    ],\n       "browser" => "Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.104 Safari/537.36 Core/1.53.4549.400 QQBrowser/9.7.12900",\n          "date" => "15/Apr/2015:00:27:19 +0849",\n       "message" => "235.9.200.241 - - [15/Apr/2015:00:27:19 +0849] \\"POST /tuling.com/bigdata.html HTTP/1.1\\" 200 45 \\"www.baidu.com\\" \\"Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.104 Safari/537.36 Core/1.53.4549.400 QQBrowser/9.7.12900\\""\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br")])]),n("p",[n("strong",[s._v("3、将数据输出到Elasticsearch")])]),s._v(" "),n("p",[s._v("到目前为止，我们已经通过了Grok Filter可以将日志消息解析成一个一个的字段，那现在我们需要将这些字段保存到Elasticsearch中。我们看到了Logstash的输出中，有大量的字段，但如果我们只需要保存我们需要的8个，该如何处理呢？而且，如果我们需要将日期的格式进行转换，我们又该如何处理呢？")]),s._v(" "),n("p",[s._v("3.1、"),n("strong",[s._v("过滤出来需要的字段")])]),s._v(" "),n("p",[s._v("要过滤出来我们需要的字段。我们需要使用mutate插件。mutate插件主要是作用在字段上，例如：它可以对字段进行重命名、删除、替换或者修改结构。")]),s._v(" "),n("p",[s._v("mutate用法")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623173423514.png",alt:"image-20220623173423514"}})]),s._v(" "),n("p",[s._v("官方文档：https://www.elastic.co/guide/en/logstash/7.6/plugins-filters-mutate.html")]),s._v(" "),n("p",[s._v("例如，mutate插件可以支持以下常用操作")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623173431224.png",alt:"image-20220623173431224"}})]),s._v(" "),n("p",[s._v("配置：")]),s._v(" "),n("p",[s._v("注意：此处为了方便进行类型的处理，将status、length指定为int类型。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('input {\n    beats {\n    port => 5044\n    }\n}\n\nfilter {\n    grok {\n    match => { \n    "message" => "%{IP:ip} - - \\[%{HTTPDATE:date}\\] \\"%{WORD:method} %{PATH:uri} %{DATA}\\" %{INT:status:int} %{INT:length:int} \\"%{DATA:reference}\\" \\"%{DATA:browser}\\"" \n    }\n}\nmutate {\n    enable_metric => "false"\n    remove_field => ["message", "log", "tags", "@timestamp", "input", "agent", "host", "ecs", "@version"]\n    }\n}\n\noutput {\n    stdout {\n    codec => rubydebug\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])]),n("p",[s._v("3.2、"),n("strong",[s._v("转换日期格式")])]),s._v(" "),n("p",[s._v("要将日期格式进行转换，我们可以使用Date插件来实现。该插件专门用来解析字段中的日期，官方说明文档：https://www.elastic.co/guide/en/logstash/7.6/plugins-filters-date.html")]),s._v(" "),n("p",[s._v("用法如下：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://404500.oss-cn-beijing.aliyuncs.com/picture/springboot/image-20220623173440347.png",alt:"image-20220623173440347"}})]),s._v(" "),n("p",[s._v("将date字段转换为「年月日 时分秒」格式。默认字段经过date插件处理后，会输出到@timestamp字段，所以，我们可以通过修改target属性来重新定义输出字段。")]),s._v(" "),n("p",[s._v("准备配置文件 filebeat-filter-print.conf")]),s._v(" "),n("p",[s._v("Logstash配置修改为如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('input {\n    beats {\n    port => 5044\n    }\n}\n\nfilter {\n    grok {\n    match => { \n    "message" => "%{IP:ip} - - \\[%{HTTPDATE:date}\\] \\"%{WORD:method} %{PATH:uri} %{DATA}\\" %{INT:status:int} %{INT:length:int} \\"%{DATA:reference}\\" \\"%{DATA:browser}\\"" \n    }\n}\nmutate {\n    enable_metric => "false"\n    remove_field => ["message", "log", "tags", "@timestamp", "input", "agent", "host", "ecs", "@version"]\n}\ndate {\n    match => ["date","dd/MMM/yyyy:HH:mm:ss Z","yyyy-MM-dd HH:mm:ss"]\n    target => "date"\n    }\n}\n\noutput {\n    stdout {\n    codec => rubydebug\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("p",[s._v("启动Logstash：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("bin/logstash -f config/filebeat-filter-print.conf --config.reload.automatic\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n       "status" => "200",\n    "reference" => "www.baidu.com",\n       "method" => "POST",\n      "browser" => "Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.104 Safari/537.36 Core/1.53.4549.400 QQBrowser/9.7.12900",\n           "ip" => "235.9.200.241",\n       "length" => "45",\n          "uri" => "/tuling.com/bigdata.html",\n         "date" => 2015-04-14T15:38:19.000Z\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("3.3、"),n("strong",[s._v("输出到Elasticsearch指定索引")])]),s._v(" "),n("p",[s._v("我们可以通过")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('elasticsearch {\n    hosts => ["192.168.21.130:9200" ,"192.168.21.131:9200" ,"192.168.21.132:9200"]\n    index => "xxx"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("index来指定索引名称，默认输出的index名称为：logstash-%{+yyyy.MM.dd}。但注意，要在index中使用时间格式化，filter的输出必须包含 @timestamp字段，否则将无法解析日期。")]),s._v(" "),n("p",[s._v("vim config/filebeat-filter-es.conf")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('input {\n    beats {\n    port => 5044\n    }\n}\n\nfilter {\n    grok {\n    match => { \n    "message" => "%{IP:ip} - - \\[%{HTTPDATE:date}\\] \\"%{WORD:method} %{PATH:uri} %{DATA}\\" %{INT:status:int} %{INT:length:int} \\"%{DATA:reference}\\" \\"%{DATA:browser}\\"" \n    }\n}\nmutate {\n    enable_metric => "false"\n    remove_field => ["message", "log", "tags", "input", "agent", "host", "ecs", "@version"]\n}\ndate {\n    match => ["date","dd/MMM/yyyy:HH:mm:ss Z","yyyy-MM-dd HH:mm:ss"]\n    target => "date"\n    }\n}\n\noutput {\n    stdout {\n    codec => rubydebug\n}\nelasticsearch {\n    hosts => ["192.168.21.130:9200" ,"192.168.21.131:9200" ,"192.168.21.132:9200"]\n    index => "tomcat_web_log_%{+YYYY-MM}"\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("启动Logstash")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("bin/logstash -f config/filebeat-tomcat-weblog.conf --config.test_and_exit\nbin/logstash -f config/filebeat-tomcat-weblog.conf --config.reload.automatic\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("​")]),s._v(" "),n("p",[s._v("注意：index名称中，不能出现大写字符")])])}),[],!1,null,null,null);n.default=e.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[72],{415:function(e,n,a){"use strict";a.r(n);var s=a(1),i=Object(s.a)({},(function(){var e=this,n=e._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h2",{attrs:{id:"课程内容"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#课程内容"}},[e._v("#")]),e._v(" 课程内容")]),e._v(" "),n("ol",[n("li",[n("p",[e._v("Dubbo中propertie文件解析以及处理原理")])]),e._v(" "),n("li",[n("p",[e._v("Dubbo中@Service注解解析以及处理原理")])]),e._v(" "),n("li",[n("p",[e._v("Dubbo中@Reference注解解析以及处理原理")])])]),e._v(" "),n("h2",{attrs:{id:"笔记更新地址"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#笔记更新地址"}},[e._v("#")]),e._v(" 笔记更新地址：")]),e._v(" "),n("p",[n("a",{attrs:{href:"https://www.yuque.com/books/share/f2394ae6-381b-4f44-819e-c231b39c1497?#",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://www.yuque.com/books/share/f2394ae6-381b-4f44-819e-c231b39c1497"),n("OutboundLink")],1),e._v("（密码：kyys） 《Dubbo笔记》")]),e._v(" "),n("h2",{attrs:{id:"整体架构和流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#整体架构和流程"}},[e._v("#")]),e._v(" 整体架构和流程")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/dubbo/30.png",alt:""}})]),e._v(" "),n("p",[e._v("应用启动类与配置")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('public class Application {\n    public static void main(String[] args) throws Exception {\n        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(ProviderConfiguration.class);\n        context.start();\n        System.in.read();\n    }\n\n    @Configuration\n    @EnableDubbo(scanBasePackages = "org.apache.dubbo.demo.provider")\n    @PropertySource("classpath:/spring/dubbo-provider.properties")\n    static class ProviderConfiguration {\n       \n    }\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br")])]),n("p",[e._v("应用配置类为ProviderConfiguration, 在配置上有两个比较重要的注解")]),e._v(" "),n("ol",[n("li",[e._v("@PropertySource表示将dubbo-provider.properties中的配置项添加到Spring容器中，可以通过@Value的方式获取到配置项中的值")]),e._v(" "),n("li",[e._v('@EnableDubbo(scanBasePackages = "org.apache.dubbo.demo.provider")表示对指定包下的类进行扫描，扫描@Service与@Reference注解，并且进行处理')])]),e._v(" "),n("h3",{attrs:{id:""}},[n("a",{staticClass:"header-anchor",attrs:{href:"#"}},[e._v("#")])]),e._v(" "),n("h2",{attrs:{id:"enabledubbo"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#enabledubbo"}},[e._v("#")]),e._v(" @EnableDubbo")]),e._v(" "),n("p",[e._v("在EnableDubbo注解上，有另外两个注解，也是研究Dubbo最重要的两个注解")]),e._v(" "),n("ol",[n("li",[e._v("@EnableDubboConfig")]),e._v(" "),n("li",[e._v("@DubboComponentScan")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("@Target({ElementType.TYPE})\n@Retention(RetentionPolicy.RUNTIME)\n@Inherited\n@Documented\n@Import(DubboConfigConfigurationRegistrar.class)\npublic @interface EnableDubboConfig {\n    boolean multiple() default true;\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Import(DubboComponentScanRegistrar.class)\npublic @interface DubboComponentScan {\n    String[] value() default {};\n\n    String[] basePackages() default {};\n\n    Class<?>[] basePackageClasses() default {};\n\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br")])]),n("p",[e._v("注意两个注解中对应的@Import注解所导入的类：")]),e._v(" "),n("ol",[n("li",[e._v("DubboConfigConfigurationRegistrar")]),e._v(" "),n("li",[e._v("DubboComponentScanRegistrar")])]),e._v(" "),n("p",[e._v("Spring在启动时会解析这两个注解，并且执行对应的Registrar类中的registerBeanDefinitions方法（这是Spring中提供的扩展功能。）")]),e._v(" "),n("h2",{attrs:{id:"dubboconfigconfigurationregistrar"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dubboconfigconfigurationregistrar"}},[e._v("#")]),e._v(" DubboConfigConfigurationRegistrar")]),e._v(" "),n("h3",{attrs:{id:"流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#流程"}},[e._v("#")]),e._v(" 流程")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/dubbo/31.png",alt:""}})]),e._v(" "),n("p",[e._v("Spring启动时，会调用DubboConfigConfigurationRegistrar的registerBeanDefinitions方法，该方法是利用Spring中的AnnotatedBeanDefinitionReader来读取：")]),e._v(" "),n("ol",[n("li",[e._v("DubboConfigConfiguration.Single."),n("strong",[e._v("class")])]),e._v(" "),n("li",[e._v("DubboConfigConfiguration.Multiple."),n("strong",[e._v("class")])])]),e._v(" "),n("p",[e._v("这两个类上的注解。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('@EnableDubboConfigBindings({\n    @EnableDubboConfigBinding(prefix = "dubbo.application", type = ApplicationConfig.class),\n    @EnableDubboConfigBinding(prefix = "dubbo.module", type = ModuleConfig.class),\n    @EnableDubboConfigBinding(prefix = "dubbo.registry", type = RegistryConfig.class),\n    @EnableDubboConfigBinding(prefix = "dubbo.protocol", type = ProtocolConfig.class),\n    @EnableDubboConfigBinding(prefix = "dubbo.monitor", type = MonitorConfig.class),\n    @EnableDubboConfigBinding(prefix = "dubbo.provider", type = ProviderConfig.class),\n    @EnableDubboConfigBinding(prefix = "dubbo.consumer", type = ConsumerConfig.class),\n    @EnableDubboConfigBinding(prefix = "dubbo.config-center", type = ConfigCenterBean.class),\n    @EnableDubboConfigBinding(prefix = "dubbo.metadata-report", type = MetadataReportConfig.class),\n    @EnableDubboConfigBinding(prefix = "dubbo.metrics", type = MetricsConfig.class)\n})\npublic static class Single {\n\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('@EnableDubboConfigBindings({\n\t@EnableDubboConfigBinding(prefix = "dubbo.applications", type = ApplicationConfig.class, multiple = true),\n\t@EnableDubboConfigBinding(prefix = "dubbo.modules", type = ModuleConfig.class, multiple = true),\n\t@EnableDubboConfigBinding(prefix = "dubbo.registries", type = RegistryConfig.class, multiple = true),\n\t@EnableDubboConfigBinding(prefix = "dubbo.protocols", type = ProtocolConfig.class, multiple = true),\n\t@EnableDubboConfigBinding(prefix = "dubbo.monitors", type = MonitorConfig.class, multiple = true),\n\t@EnableDubboConfigBinding(prefix = "dubbo.providers", type = ProviderConfig.class, multiple = true),\n\t@EnableDubboConfigBinding(prefix = "dubbo.consumers", type = ConsumerConfig.class, multiple = true),\n\t@EnableDubboConfigBinding(prefix = "dubbo.config-centers", type = ConfigCenterBean.class, multiple = true),\n\t@EnableDubboConfigBinding(prefix = "dubbo.metadata-reports", type = MetadataReportConfig.class, multiple = true),\n\t@EnableDubboConfigBinding(prefix = "dubbo.metricses", type = MetricsConfig.class, multiple = true)\n})\npublic static class Multiple {\n\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br")])]),n("p",[e._v("这两个类主要用到的就是@EnableDubboConfigBindings注解：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("@Target({ElementType.TYPE})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Import(DubboConfigBindingsRegistrar.class)\npublic @interface EnableDubboConfigBindings {\n\n    /**\n     * The value of {@link EnableDubboConfigBindings}\n     *\n     * @return non-null\n     */\n    EnableDubboConfigBinding[] value();\n\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br")])]),n("p",[e._v("@EnableDubboConfigBindings注解上也有一个@Import注解，导入的是DubboConfigBindingsRegistrar."),n("strong",[e._v("class")]),e._v("。该类会获取@EnableDubboConfigBindings注解中的value，也就是多个@EnableDubboConfigBinding注解，然后利用DubboConfigBindingRegistrar去处理这些@EnableDubboConfigBinding注解。")]),e._v(" "),n("h3",{attrs:{id:"dubboconfigbindingregistrar"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dubboconfigbindingregistrar"}},[e._v("#")]),e._v(" DubboConfigBindingRegistrar")]),e._v(" "),n("p",[e._v("此类中的主要方法是registerDubboConfigBeans()方法，主要功能就是获取用户所设置的properties文件中的内容，对Properties文件进行解析，根据Properties文件的每个配置项的前缀、参数名、参数值生成对应的BeanDefinition。")]),e._v(" "),n("p",[e._v("比如：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("dubbo.application.name=dubbo-demo-provider1-application\ndubbo.application.logger=log4j\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("p",[e._v('前缀为"dubbo.application"的配置项，会生成一个ApplicationConfig类型的BeanDefinition，并且name和logger属性为对应的值。')]),e._v(" "),n("p",[e._v("再比如：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("dubbo.protocols.p1.name=dubbo\ndubbo.protocols.p1.port=20880\ndubbo.protocols.p1.host=0.0.0.0\n\ndubbo.protocols.p2.name=dubbo\ndubbo.protocols.p2.port=20881\ndubbo.protocols.p2.host=0.0.0.0\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("p",[e._v('比如前缀为"dubbo.protocols"的配置项，会生成'),n("strong",[e._v("两")]),e._v("个ProtocolConfig类型的BeanDefinition，两个BeanDefinition的beanName分别为p1和p2。")]),e._v(" "),n("p",[e._v("并且还会针对生成的每个BeanDefinition生成一个和它一对一绑定的BeanPostProcessor，类型为DubboConfigBindingBeanPostProcessor."),n("strong",[e._v("class")]),e._v("。")]),e._v(" "),n("h3",{attrs:{id:"dubboconfigbindingbeanpostprocessor"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dubboconfigbindingbeanpostprocessor"}},[e._v("#")]),e._v(" DubboConfigBindingBeanPostProcessor")]),e._v(" "),n("p",[e._v("DubboConfigBindingBeanPostProcessor是一个BeanPostProcessor，在Spring启动过程中，会针对所有的Bean对象进行后置加工，但是在DubboConfigBindingBeanPostProcessor中有如下判断：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("if (this.beanName.equals(beanName) && bean instanceof AbstractConfig)\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("所以DubboConfigBindingBeanPostProcessor并不会处理Spring容器中的所有Bean，它只会处理上文由Dubbo所生成的Bean对象。")]),e._v(" "),n("p",[e._v("并且，在afterPropertiesSet()方法中，会先创建一个DefaultDubboConfigBinder。")]),e._v(" "),n("h3",{attrs:{id:"defaultdubboconfigbinder"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#defaultdubboconfigbinder"}},[e._v("#")]),e._v(" DefaultDubboConfigBinder")]),e._v(" "),n("p",[e._v("当某个AbstractConfig类型的Bean，在经过DubboConfigBindingBeanPostProcessor处理时，此时Bean对象中的属性是没有值的，会利用DefaultDubboConfigBinder进行赋值。底层就是利用Spring中的DataBinder技术，结合properties文件对对应的属性进行赋值。")]),e._v(" "),n("p",[e._v("对应一个AbstractConfig类型（针对的其实是子类，比如ApplicationConfig、RegistryConfig）的Bean，每个类都有一些属性，而properties文件是一个key-value对，所以实际上DataBinder就是将属性名和properties文件中的key进行匹配，如果匹配成功，则把value赋值给属性。具体DataBinder技术是如何工作的，请自行学习（不难）。")]),e._v(" "),n("p",[e._v("举个例子：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("dubbo.application.name=dubbo-demo-provider1-application\ndubbo.application.logger=log4j\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("p",[e._v("对于此配置，它对应ApplicationConfig对象（beanName是自动生成的），所以最终ApplicationConfig对象的name属性的值为“dubbo-demo-provider1-application”，logger属性的值为“log4j”。")]),e._v(" "),n("p",[e._v("对于")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("dubbo.protocols.p1.name=dubbo\ndubbo.protocols.p1.port=20880\ndubbo.protocols.p1.host=0.0.0.0\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br")])]),n("p",[e._v("它对应ProtocolConfig对象（beanName为p1）,所以最终ProtocolConfig对象的name属性的值为“dubbo”，port属性的值为20880，host属性的值为“0.0.0.0”。")]),e._v(" "),n("p",[e._v("这样就完成了对properties文件的解析。")]),e._v(" "),n("h3",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),n("p",[e._v("DubboConfigConfigurationRegistrar的主要作用就是对propties文件进行解析并根据不同的配置项项生成对应类型的Bean对象。")]),e._v(" "),n("h2",{attrs:{id:"dubbocomponentscanregistrar"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dubbocomponentscanregistrar"}},[e._v("#")]),e._v(" DubboComponentScanRegistrar")]),e._v(" "),n("p",[e._v("DubboConfigConfigurationRegistrar的作用是向Spring容器中注册两个Bean:")]),e._v(" "),n("ol",[n("li",[e._v("ServiceAnnotationBeanPostProcessor")]),e._v(" "),n("li",[e._v("ReferenceAnnotationBeanPostProcessor")])]),e._v(" "),n("h3",{attrs:{id:"serviceannotationbeanpostprocessor"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#serviceannotationbeanpostprocessor"}},[e._v("#")]),e._v(" ServiceAnnotationBeanPostProcessor")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/dubbo/32.png",alt:""}})]),e._v(" "),n("p",[e._v("ServiceAnnotationBeanPostProcessor是一个BeanDefinitionRegistryPostProcessor，是用来注册BeanDefinition的。")]),e._v(" "),n("p",[e._v("它的主要作用是扫描Dubbo的@Service注解，一旦扫描到某个@Service注解就把它以及被它注解的类当做一个Dubbo服务，进行"),n("strong",[e._v("服务导出")]),e._v("。")]),e._v(" "),n("h4",{attrs:{id:"dubboclasspathbeandefinitionscanner"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dubboclasspathbeandefinitionscanner"}},[e._v("#")]),e._v(" DubboClassPathBeanDefinitionScanner")]),e._v(" "),n("p",[e._v("DubboClassPathBeanDefinitionScanner是所Dubbo自定义的扫描器，继承了Spring中的ClassPathBeanDefinitionScanner了。")]),e._v(" "),n("p",[e._v("DubboClassPathBeanDefinitionScanner相对于ClassPathBeanDefinitionScanner并没有做太多的改变，只是把useDefaultFilters设置为了false，主要是因为Dubbo中的@Service注解是Dubbo自定义的，在这个注解上并没有用@Component注解（因为Dubbo不是一定要结合Spring才能用），所以为了能利用Spring的扫描逻辑，需要把useDefaultFilters设置为false。")]),e._v(" "),n("p",[e._v("没扫描到一个@Service注解，就会得到一个BeanDefinition，这个BeanDefinition的beanClass属性就是具体的服务实现类。")]),e._v(" "),n("p",[e._v("但，如果仅仅只是这样，这只是得到了一个Spring中的Bean，对于Dubbo来说此时得到的Bean是一个"),n("strong",[e._v("服务")]),e._v("，并且，还需要解析@Service注解的配置信息，因为这些都是服务的参数信息，所以在扫描完了之后，会针对所得到的每个BeanDefinition，都会"),n("strong",[e._v("额外")]),e._v("的再生成一个"),n("strong",[e._v("ServiceBean")]),e._v("类型的Bean对象。")]),e._v(" "),n("h4",{attrs:{id:"servicebean"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#servicebean"}},[e._v("#")]),e._v(" ServiceBean")]),e._v(" "),n("p",[e._v("ServiceBean表示一个Dubbo服务，它有一些参数，比如：")]),e._v(" "),n("ol",[n("li",[n("p",[n("strong",[e._v("ref，表示服务的具体实现类")])])]),e._v(" "),n("li",[n("p",[n("strong",[e._v("interface，表示服务的接口")])])]),e._v(" "),n("li",[n("p",[n("strong",[e._v("parameters，表示服务的参数（@Service注解中所配置的信息）")])])]),e._v(" "),n("li",[n("p",[n("strong",[e._v("application，表示服务所属的应用")])])]),e._v(" "),n("li",[n("p",[n("strong",[e._v("protocols，表示服务所使用的协议")])])]),e._v(" "),n("li",[n("p",[n("strong",[e._v("registries，表示服务所要注册的注册中心")])])])]),e._v(" "),n("p",[n("strong",[e._v("所以在扫描到一个@Service注解后，其实会得到两个Bean:")])]),e._v(" "),n("ol",[n("li",[e._v("一个就是服务实现类本身一个Bean对象")]),e._v(" "),n("li",[e._v("一个就是对应的ServiceBean类型的一个Bean对象")])]),e._v(" "),n("p",[e._v("并且需要注意的是，ServiceBean实现了ApplicationListener接口，所以当Spring启动完成后会触发onApplicationEvent()方法的调用，而在这个方法内会调用"),n("strong",[e._v("export()")]),e._v("，这个方法就是"),n("strong",[e._v("服务导出的入口方法")]),e._v("。")]),e._v(" "),n("p",[e._v("关于RuntimeBeanReference参考https://www.yuque.com/renyong-jmovm/ufz328/gbwvk7。")]),e._v(" "),n("h3",{attrs:{id:"referenceannotationbeanpostprocessor"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#referenceannotationbeanpostprocessor"}},[e._v("#")]),e._v(" ReferenceAnnotationBeanPostProcessor")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/nylg/picture/raw/master/dubbo/33.png",alt:""}})]),e._v(" "),n("p",[e._v("ReferenceAnnotationBeanPostProcessor是处理@Reference注解的。")]),e._v(" "),n("p",[e._v("ReferenceAnnotationBeanPostProcessor的父类是AnnotationInjectedBeanPostProcessor，是一个InstantiationAwareBeanPostProcessorAdapter，是一个BeanPostProcessor。")]),e._v(" "),n("p",[e._v("Spring在对Bean进行依赖注入时会调用AnnotationInjectedBeanPostProcessor的postProcessPropertyValues()方法来给某个Bean按照ReferenceAnnotationBeanPostProcessor的逻辑进行依赖注入。")]),e._v(" "),n("p",[e._v("在注入之前会查找注入点，被@Reference注解的属性或方法都是注入点。")]),e._v(" "),n("p",[e._v("针对某个Bean找到所有注入点之后，就会进行注入了，注入就是给属性或给set方法赋值，但是在赋值之前得先得到一个值，此时就会调用ReferenceAnnotationBeanPostProcessor的"),n("strong",[e._v("doGetInjectedBean()"),n("strong",[e._v("方法来得到一个对象，而这个对象的构造就比较复杂了，因为对于Dubbo来说，注入给某个属性的应该是当前这个")]),e._v("属性所对应的服务接口的代理对象")]),e._v("。")]),e._v(" "),n("p",[e._v("但是在生成这个代理对象之前，还要考虑问题：")]),e._v(" "),n("ol",[n("li",[e._v("当前所需要引入的这个服务，是不是在本地就存在？不存在则要把按Dubbo的逻辑生成一个代理对象")]),e._v(" "),n("li",[e._v("当前所需要引入的这个服务，是不是已经被引入过了（是不是已经生成过代理对象了），如果是应该是不用再重复去生成了。")])]),e._v(" "),n("p",[n("strong",[e._v("首先如何判断当前所引入的服务是本地的一个服务（就是当前应用自己所提供的服务）。")])]),e._v(" "),n("p",[e._v("我们前面提到，Dubbo通过@Service来提供一个服务，并且会生成两个Bean：")]),e._v(" "),n("ol",[n("li",[e._v("一个服务实现类本身Bean")]),e._v(" "),n("li",[e._v("一个ServiceBean类型的Bean，这个Bean的名字是这么生成的：")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('private String generateServiceBeanName(AnnotationAttributes serviceAnnotationAttributes, Class<?> interfaceClass) {\n\tServiceBeanNameBuilder builder = create(interfaceClass, environment)\n                .group(serviceAnnotationAttributes.getString("group"))\n                .version(serviceAnnotationAttributes.getString("version"));\n\treturn builder.build();\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br")])]),n("p",[e._v("是通过接口类型+group+version来作为ServiceBean类型Bean的名字的。")]),e._v(" "),n("p",[e._v("所以现在对于服务引入，也应该提前根据@Reference注解中的信息和属性接口类型去判断一下当前Spring容器中是否存在对应的ServiceBean对象，如果存在则直接取出ServiceBean对象的ref属性所对应的对象，作为要注入的结果。")]),e._v(" "),n("p",[n("strong",[e._v("然后如何判断当前所引入的这个服务是否已经被引入过了")]),e._v("**（是不是已经生成过代理对象了）。**")]),e._v(" "),n("p",[e._v("这就需要在第一次引入某个服务后（生成代理对象后）进行缓存（记录一下）。Dubbo中是这么做的:")]),e._v(" "),n("ol",[n("li",[n("p",[e._v("首先根据@Reference注解的所有信息+属性接口类型生成一个"),n("strong",[e._v("字符串")])])]),e._v(" "),n("li",[n("p",[e._v("然后@Reference注解的所有信息+属性接口类型生成一个ReferenceBean对象（"),n("strong",[e._v("ReferenceBean对象中的get方法可以得到一个Dubbo生成的代理对象，可以理解为服务引入的入口方法")]),e._v("）")])]),e._v(" "),n("li",[n("p",[e._v("把字符串作为beanName，ReferenceBean对象作为bean注册到Spring容器中，同时也会放入"),n("strong",[e._v("referenceBeanCache")]),e._v("中。")])])]),e._v(" "),n("p",[e._v("有了这些逻辑，@Reference注解服务引入的过程是这样的：")]),e._v(" "),n("ol",[n("li",[n("p",[e._v("得到当前所引入服务对应的ServiceBean的beanName（源码中叫referencedBeanName）")])]),e._v(" "),n("li",[n("p",[e._v("根据@Reference注解的所有信息+属性接口类型得到一个referenceBeanName")])]),e._v(" "),n("li",[n("p",[e._v("根据referenceBeanName从"),n("strong",[e._v("referenceBeanCach")]),e._v("e获取对应的ReferenceBean，如果没有则创建一个ReferenceBean")])]),e._v(" "),n("li",[n("p",[e._v("根据referencedBeanName（ServiceBean的beanName）判断Spring容器中是否存在该bean，如果存在则给ref属性所对应的bean取一个别名，别名为referenceBeanName。")])]),e._v(" "),n("li",[n("ol",[n("li",[e._v("如果Spring容器中不存在referencedBeanName对应的bean，则判断容器中是否存在referenceBeanName所对应的Bean，如果不存在则将创建出来的ReferenceBean注册到Spring容器中（**此处这么做就支持了可以通过@Autowired注解也可以使用服务了，**"),n("strong",[e._v("ReferenceBean是一个FactoryBean")]),e._v("）")])])]),e._v(" "),n("li",[n("p",[e._v("如果referencedBeanName存在对应的Bean，则额外生成一个代理对象，代理对象的InvocationHandler会缓存在"),n("strong",[e._v("localReferenceBeanInvocationHandlerCache中，这样如果引入的是同一个服务，并且这个服务在本地，")])])]),e._v(" "),n("li",[n("p",[e._v("如果referencedBeanName不存在对应的Bean，则直接调用ReferenceBean的get()方法得到一个代理对象")])])])])}),[],!1,null,null,null);n.default=i.exports}}]);